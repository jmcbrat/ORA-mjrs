CREATE OR REPLACE
package DemoPkg is

   procedure Sleep
   (
     pTime integer
   );
   
end DemoPkg;
/

CREATE OR REPLACE
package body DemoPkg is

   procedure Sleep
   (
     pTime integer
   )
   is
   begin
   
      --dbms_lock.sleep(pTime);
      JobsPkg.SignalCompletion('DemoPkg.Sleep(' || to_char(pTime) || ')');
   
   end Sleep;
   
end DemoPkg;
/

CREATE OR REPLACE
package desc_table 
  authid current_user
as

  table_does_not_exist exception;
  pragma exception_init(table_does_not_exist, -20010);

  type check_t        is table of long;

  type col_t          is record (name varchar2(30), nullable boolean, datatype varchar2(106), checks check_t);
  type cols_t         is table   of col_t;

  type col_comment_t  is record (pos number, comment user_tab_comments.comments%type);
  type col_comments_t is table   of col_comment_t;

  type table_t        is record (own varchar2(30), nam varchar2(30));
  type tables_t       is table   of table_t;

  type char_to_number is table   of number(2) index by varchar2(30);

  type description    is record (tab           table_t,
                                 tab_type      user_tab_comments.table_type%type, -- 'TABLE', 'VIEW' ..?
                                 tab_comment   user_tab_comments.comments%type,
                                 cols          cols_t,
                                 col_comments  col_comments_t,
                                 pks           char_to_number, -- Position of primary keys
                                 parents       tables_t,
                                 children      tables_t);

  -- table_name: 61 chars maximum: 30 chars schema (optional), 1 char dot (optional), 30 chars username 
  function describe(table_name in varchar2) return description;

  function describe(tab        in table_t ) return description;

end desc_table;
/

CREATE OR REPLACE
package body desc_table as 

  function describe(table_name in varchar2) return description is 
    -- used for dbms_utility.name_resolve:
    util_context       number := 2;
    util_schema        varchar2(30);
    util_part1         varchar2(30);
    util_part2         varchar2(30);
    util_dblink        varchar2(128);
    util_part1_type    number;
    util_object_number number;

    tab                table_t;
  begin
    dbms_utility.name_resolve(table_name, util_context, util_schema, util_part1, util_part2, util_dblink, util_part1_type, util_object_number);

    tab.own := util_schema;
    tab.nam := util_part1;

    return describe(tab);

  exception
    when others then 
      case 
        when sqlcode = -6564 then 
        raise table_does_not_exist;
      else
        dbms_output.put_line('exception: ' || sqlerrm || '(' || sqlcode || ')' ); 
    end case;

  end describe;

  function describe(tab in table_t) return description is
    col_r         col_t;
    ret           description;
    v_table_name  varchar2(30);
    v_table_owner varchar2(30);
    col_pos            number;

  begin

    ret.tab          := tab;

    ret.cols         := cols_t        ();
    ret.col_comments := col_comments_t();
    ret.parents      := tables_t      ();
    ret.children     := tables_t      ();

    select comments,table_type into ret.tab_comment, ret.tab_type from all_tab_comments 
     where table_name = tab.nam and owner = tab.own;

    col_pos := 1;

    for r in (
      select
        t.column_name, t.data_type, t.data_length, t.data_precision, t.data_scale, t.nullable, c.comments
      from
        all_tab_cols t join all_col_comments c on 
          t.table_name  = c.table_name  and 
          t.column_name = c.column_name and
          t.owner       = c.owner
      where
        t.table_name = tab.nam and t.owner = tab.own
      order by
        column_id) loop

      col_r.name       := r.column_name;
      col_r.nullable   := case when r.nullable = 'Y' then true else false end;
      col_r.datatype   := r.data_type;
      col_r.checks     := check_t();

      if r.data_length is not null and r.data_precision is null then
        if r.data_type <> 'DATE' then
          col_r.datatype := col_r.datatype || '(' || r.data_length || ')';
        end if;
      end if;

      if r.data_precision is not null then
        col_r.datatype := col_r.datatype || '(' || r.data_precision;

        if r.data_scale is not null and r.data_scale > 0 then
          col_r.datatype := col_r.datatype || ',' || r.data_scale;
        end if;

        col_r.datatype := col_r.datatype || ')';
      end if;

      ret.cols.extend;
      ret.cols(ret.cols.count) := col_r;

      if r.comments is not null then
        ret.col_comments.extend;
        ret.col_comments(ret.col_comments.count).pos     := col_pos; 
        ret.col_comments(ret.col_comments.count).comment := r.comments;
      end if;
      
      col_pos := col_pos+1;
    end loop;

    -- finding constraints
    for r in (
      select
        r_owner, constraint_name, r_constraint_name, constraint_type, search_condition
      from
        all_constraints
      where
        table_name = tab.nam and owner = tab.own) loop

        if r.constraint_type = 'P' then
          for c in (
            select column_name, table_name, position
              from all_cons_columns
             where constraint_name = r.constraint_name) loop

            ret.pks(c.column_name) := c.position;
          end loop;

          select distinct /* distinct in case a table has two foreign keys to table */
            owner, table_name bulk collect into ret.children
          from
            all_constraints
          where
            r_constraint_name = r.constraint_name and
            owner             = tab.own;

        elsif r.constraint_type = 'R' then -- foreign key

          select owner, table_name into v_table_owner, v_table_name 
            from all_constraints 
           where constraint_name = r.r_constraint_name and owner = r.r_owner;

          ret.parents.extend;
          ret.parents(ret.parents.count).own := v_table_owner;
          ret.parents(ret.parents.count).nam := v_table_name;
        end if;

      end loop;

    return ret;

  end describe;

end;
/

CREATE OR REPLACE
FUNCTION        ef_location_name_audit (
	p_location_id		IN		EPICAUDIT.epic_locations.location_id%type,
	p_case				IN		EPIC.epic_col_types.varchar_255%type,
	p_date				IN		date)
	
/*
Purpose: Returns the location name for the given location id (modified version of EPIC.ef_location_name) to
		return data from the EPICAUDIT tables

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/26/06			Created
*/
	
RETURN EPICAUDIT.epic_locations.location_name%type
IS
v_location_name					EPICAUDIT.epic_locations.location_name%type;
	
	
CURSOR cur_location IS
	SELECT	e.location_name
	FROM  	EPICAUDIT.epic_locations e
	WHERE 	e.location_id = p_location_id
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
  			and not exists
				(select e2.location_id
				from EPICAUDIT.epic_locations e2
				where e2.location_id = e.location_id
				and EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) < p_date);
BEGIN
	OPEN cur_location;
		FETCH cur_location INTO v_location_name;
			IF cur_location%notfound THEN
			v_location_name := ' ';
			END IF;
	CLOSE cur_location;
	
	IF upper(p_case) = 'UC' THEN
		v_location_name := upper(v_location_name);
	ELSIF upper(p_case) = 'LC' THEN
		v_location_name := lower(v_location_name);
	ELSIF upper(p_case) = 'IC' THEN
		v_location_name := EPIC.ef_initcap(v_location_name);
	END IF;
	
	RETURN v_location_name;
	
EXCEPTION
	WHEN OTHERS THEN
		RETURN ' ';
END;
/

CREATE OR REPLACE
FUNCTION        ef_location_path_name_audit (
	p_location_id	IN		EPICAUDIT.epic_locations.location_id%type,
	p_case			IN		EPIC.epic_col_types.varchar_255%type,
	p_level			IN		EPICAUDIT.epic_locations.location_level%type,
	p_date			IN		date)
	

/*
Purpose: Returns the location path name for the given location id (modified version of EPIC.ef_location_path_name) to
		return data from the EPICAUDIT tables

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/26/06			Created
*/

RETURN	EPIC.epic_col_types.varchar_255%type
IS

	c_delimiter				constant char(2) := ', ';
	v_ancestors				varchar2(2000);
	v_ancestor_name			EPICAUDIT.epic_locations.location_name%type;
	v_level					EPICAUDIT.epic_locations.location_level%type;
	v_this_level			EPICAUDIT.epic_locations.location_level%type;
	v_target_level			EPICAUDIT.epic_locations.location_level%type;
	v_case					EPIC.epic_col_types.varchar_255%type;
	
-- Cursor to get location ancestors
	CURSOR cur_ancestor IS
		SELECT	l.location_name,
				l.location_level
				
		FROM	EPICAUDIT.epic_locations l,
				EPIC.epic_location_child lc
				
		WHERE	lc.child_location_id = p_location_id
		  		and lc.location_level >= v_target_level
		  		and lc.location_id = l.location_id
		  		and EPIC.ef_epic_date_to_date(l.action_time) <= p_date
  				and not exists
					(select l2.location_id
					from EPICAUDIT.epic_locations l2
					where l2.location_id = lc.location_id
					and EPIC.ef_epic_date_to_date(l2.action_time) > EPIC.ef_epic_date_to_date(l.action_time)
					and EPIC.ef_epic_date_to_date(l2.action_time) < p_date)
		ORDER BY l.location_level;
		
-- Cursor to get location level
	CURSOR cur_level IS
		SELECT	location_level
		
		FROM EPICAUDIT.epic_locations
		
		WHERE location_id = p_location_id;

BEGIN
	v_ancestors := null;
	v_case := upper(p_case);

	OPEN cur_level;
		FETCH cur_level INTO v_this_level;
	CLOSE cur_level;

	IF p_level > 0 THEN
		v_target_level := p_level;
	ELSIF p_level < 0 THEN
		v_target_level := v_this_level + p_level;
	ELSE 
		v_target_level := v_this_level;
	END IF;

	OPEN cur_ancestor;
		FETCH cur_ancestor INTO v_ancestor_name, v_level;

	WHILE NOT cur_ancestor%notfound
	LOOP
		IF length(v_ancestors) > 0 THEN
			v_ancestors := v_ancestors || c_delimiter;
		END IF;

		IF v_case = 'UC' THEN
			v_ancestor_name := upper(v_ancestor_name);
		ELSIF v_case = 'LC' THEN
			v_ancestor_name := lower(v_ancestor_name);
		ELSIF v_case = 'IC' THEN
			v_ancestor_name := EPIC.ef_initcap(v_ancestor_name);
		END IF;

		v_ancestors := v_ancestors || v_ancestor_name;

		FETCH cur_ancestor INTO v_ancestor_name, v_level;
	END LOOP;

	CLOSE cur_ancestor;

	-- append name of input location (assuming it meets the absolute level requirement)
	IF v_target_level <= v_this_level THEN
		IF length(v_ancestors) > 0 THEN
			v_ancestors := v_ancestors || c_delimiter;
		END IF;

		v_ancestor_name := MACOMB.ef_location_name_audit(p_location_id, v_case, p_date);
		v_ancestors := v_ancestors || v_ancestor_name;
	END IF;

	RETURN substr(v_ancestors, 1, 255);

EXCEPTION
	WHEN OTHERS THEN
		RETURN ' ';
END;
/

CREATE OR REPLACE
package JobsPkg as
 
   /*
    * Types
    */
   subtype tString   is varchar2(30);
   subtype tJob      is varchar2(64);
   subtype tDBString is varchar2(255);
   
   type tArrayJob is table of tJob
   index by pls_integer;
   
   type tArraySeqByJob is table of number
   index by tJob;
   
   
   /*
    * Execute
    *
    * Executes single job by submiting it to the job queue.
    */
   procedure Execute
   (
      pJob    in tJob,
      pCommit in boolean := true
   );
   
   
   /*
    * Execute
    *
    * Executes array of jobs by submiting it to the job queue.
    */
   procedure Execute
   (
      pJobs   in tArrayJob,
      pCommit in boolean := true
   );
   
   /*
    * SignalCompletion
    *
    * Send an alert to signal job completion.
    */
   procedure SignalCompletion
   (
      pJob     in tJob,
      pMessage in tDBString := null
   );
     
 
   /*
    * WaitForCompletion
    *
    * Waits for completion of all parallel jobs
    * from the array pJobs passed as a parameter.
    */
   procedure WaitForCompletion
   (
      pJobs tArrayJob
   );

end JobsPkg;
/

CREATE OR REPLACE
package body JobsPkg as

    /*
     * Private Section.
     */    
    
    /*
     * BuildAlertName
     */
    function BuildAlertName
    (
       pJob in tJob
    )
       return tString
    is
    
       vAlert tString;
    
    begin    
       if length(pJob) <= 30
       then
          vAlert := upper(pJob);
       else
          if instr(pJob, '.') > 0
          then
             vAlert := upper(substr(pJob, instr(pJob, '.') + 1));
          else
             vAlert := upper(substr(pJob, 1, 30));
          end if;
       end if;
       
       return vAlert;    
    end BuildAlertName;
    
    
    
   /*
    * Public Section.
    */
     
   /*
    * Execute
    *
    * Executes single job by submiting it to the job queue.
    */
   procedure Execute
   (
      pJob    in tJob,
      pCommit in boolean := true
   )
   is
   
      vJob     tJob := ltrim(rtrim(pJob));
      vJobNum  binary_integer;
   
   begin
      
      if substr(vJob, -1) != ';'
      then
         vJob := vJob || ';';
      end if;
      dbms_job.submit(vJobNum, vJob);
      
      --DebugPkg.Log(to_char(vJobNum) || ': ' || vJob);
      
      if pCommit
      then
         commit;
      end if;
   
   end Execute;
   
   
   /*
    * Execute
    *
    * Executes set of jobs by submiting it to the job queue.
    */
   procedure Execute
   (
      pJobs   in tArrayJob,
      pCommit in boolean := true
   )
   is
   
      vJobNum  binary_integer;
   
   begin
   
      if pJobs.count > 0
      then
         for nIndex in pJobs.first..pJobs.last
         loop
             Execute(pJobs(nIndex), (not pCommit));  
         end loop;
         
         if pCommit
         then
            commit;
         end if;
      end if;
   
   end Execute;
   
   
   /*
    * SignalCompletion
    *
    * Send an alert to signal job completion.
    */
   procedure SignalCompletion
   (
      pJob     in tJob,
      pMessage in tDBString := null
   )
   is      
   begin
      
      dbms_alert.signal(BuildAlertName(pJob), nvl(pMessage, pJob || ' completed.'));
      commit;
      
   end SignalCompletion;
    
 
   /*
    * WaitForCompletion
    *
    * Waits for completion of all parallel jobs
    * from the array pJobs passed as a parameter.
    */
   procedure WaitForCompletion
   (
      pJobs tArrayJob
   )
   is
   
      vAlerts   tArraySeqByJob;
      vAlert    tJob;
      vName     tJob;
      vMessage  tDBString;
      vStatus   pls_integer;
      vTimeOut  pls_integer := 3600;
           
   begin   
      
      if pJobs.count > 0
      then
         /*
          * Step 1.
          * Build array of alerts.
          */
          for nIndex in pJobs.first..pJobs.last
          loop
             vAlerts(BuildAlertName(pJobs(nIndex))) := nIndex;
          end loop;          
          
         /*
          * Step 2.
          * Register for alerts.
          */
          vAlert := vAlerts.first;
          while (vAlert is not null)
          loop
             dbms_alert.register(vAlert);
             vAlert := vAlerts.next(vAlert);
          end loop;          

          /*
           * Step 3.
           * Waiting until all of the alerts are received.
           */
          while (vAlerts.count > 0)
          loop             
             dbms_alert.waitany(vName, vMessage, vStatus, vTimeOut);
             if vStatus = 0
             then   
                dbms_alert.remove(vName);
                vAlerts.delete(vName);
                dbms_output.put_line('Received alert: ' || vName ||
                                     ' with message: '  || vMessage);
             end if;
          end loop;
     end if;       
   
   end WaitForCompletion;

end JobsPkg;
/

CREATE OR REPLACE
procedure mcmb_chk_amount_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'AMOUNT:';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_court_date

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curPayment is

		select bk.entity_id, cc.case_id

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_bail_condition_charge bcc,

		     EPIC.eh_case_charge cc,

		     EPIC.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		and bc.bail_condition_id = bcc.bail_condition_id

		and bcc.charge_id = cc.charge_id

		UNION

		select bk.entity_id, cc.case_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_case_charge cc,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id

		and   ch.charge_id = cc.charge_id;



	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, 
		EPIC.eh_trust_account ta, 
		EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curCourt is

		select payee 
		from EPIC.eh_trust_account_trans

		where trust_account_trans_id = p_trans_id;



	v_now				varchar2(20);

	v_court_id			EPIC.eh_entity_organization.entity_id%type;

	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_case_id			EPIC.eh_case_charge.case_id%type;



	cursor curAppearance is

		select to_char(EPIC.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YY HH:MI AM')

		from EPIC.eh_court_appearance ca,

		     EPIC.eh_booking bk

		where ca.owner_id = v_case_id

		and ca.court_name = v_court_id

		and (EPIC.ef_epic_date_to_date(ca.appearance_date) > v_now)

		and not exists

		(select 1 from EPIC.eh_court_appearance ca2

		where ca2.owner_id = v_case_id

		and ca2.court_name = v_court_id

		and ca2.appearance_date < EPIC.ef_epic_date_to_date(ca.appearance_date));



	v_temp				number;

	v_return			varchar2(255);



begin



	v_now := EPIC.epicdatenow();



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id, v_case_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		-- now get the court for this check.

		open curCourt;

		fetch curCourt into v_court_id;

		if curCourt%found then



			-- get the next court appearance for this inmate

			-- for this court

			open curAppearance;

			fetch curAppearance into p_return;

			if curAppearance%notfound then

				p_return := '<No Future Court Date>';

			end if;

			close curAppearance;

		else

			p_return := '<No Future Court Date>';

		end if;



		close curCourt;



	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_court_l1

	(p_trans_id			in				EPIC.Eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curName is

	select eo.organization_name

	from EPIC.eh_trust_account_trans tat,

		 EPIC.eh_entity_organization eo

	where tat.trust_account_trans_id = p_trans_id

	and tat.payee = eo.entity_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_court_l2

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curCourt is

	select trim(ad.street_number || ' ' || ad.street_name)

	from EPIC.eh_trust_account_trans tat,

		 EPIC.eh_address ad

	where tat.trust_account_trans_id = p_trans_id

	and ad.entity_id = tat.payee

	and ad.primary_flag = 'Y';



begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure      mcmb_chk_court_l3
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
	
	cursor curCourt is
	select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)
	from EPIC.eh_trust_account_trans tat,
		 EPIC.eh_address ad
	where tat.trust_account_trans_id = p_trans_id
	and ad.entity_id = tat.payee
	and ad.primary_flag = 'Y';
	
begin                          
                                 
	open curCourt;
	fetch curCourt into p_return;
	if curCourt%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curCourt;

	return;
	
end;
/

CREATE OR REPLACE
procedure mcmb_chk_court_telephone

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curCourt is

	select trim(t.area_code || '-' || t.base_number )

	from EPIC.eh_trust_account_trans tat,

		 EPIC.eh_telephone_records t

	where tat.trust_account_trans_id = p_trans_id

	and t.entity_id = tat.payee

	and t.primary_flag = 'Y';



begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<No Telephone # on Record>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_date

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := to_char(sysdate, 'MM/DD/YY');

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_dept_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'DEPT:';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_descriptor_cap

	(p_trans_id			in			EPIC. eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'DESCRIPTOR #:';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_dkt_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'DKT#';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_docket_number

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curPayment is

		select ca.case_number

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_bail_condition_charge bcc,

		     EPIC.eh_case_charge cc,

		     EPIC.eh_case ca

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id  = bcc.bail_condition_id

		and bcc.charge_id = cc.charge_id

		and cc.case_id = ca.case_id

		UNION

		select ca.case_number

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_case_charge cc,

			 EPIC.eh_case ca

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.charge_id = cc.charge_id

		and   cc.case_id = ca.case_id;



	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_return;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_return;

		if curPayment%notfound then

			v_return := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_return <> 'NOT FOUND' then

		p_return := v_return;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_fee_amt

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curName is

	select decode(trim(tat.comments),

				  null, 'PROCESSING FEES:  $0.00',

				  '', 'PROCESSING FEES:   $0.00',

				  UPPER(tat.comments))

	from EPIC.eh_trust_account_trans tat

	where tat.trust_account_trans_id = p_trans_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	else

		-- go ahead and strip off the 'PROCESSING' so that it looks

		-- just like the Macomb check.

		if instr(p_return, 'PROCESSING') > 0 then

			p_return := trim(substr(p_return,12, 255));

			if instr(p_return, 'FEES:') > 0 then

				p_return := trim(substr(p_return, 1, 5) || '     ' || substr(p_return, 6, 255));

			end if;

		end if;

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_inmate_name

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is

	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		select bk.entity_id

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		UNION

		select bk.entity_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;



	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curName is

		select pi.name_family || ', ' || pi.name_first

		from EPIC.eh_person_identity pi,

		     EPIC.eh_entity_person ep

		where ep.entity_id = v_entity_id

		and ep.primary_identity_id = ep.primary_identity_id;





begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(EPIC.ef_get_personororgname(v_entity_id));

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_inmate_number

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curPayment is

		select bk.entity_id

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		UNION

		select bk.entity_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;



	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := EPIC.ef_offender_id(v_entity_id);

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_on_docket_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'ON DOCKET #';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_owning_agency
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is

	cursor curPayment is
		select substr(EPIC.ef_get_personororgname(ca.agency_id), 1,255)
		from EPIC.eh_court_payment cp,
		     EPIC.eh_bail_condition bc,
		     EPIC.eh_bail_condition_charge bcc,
		     EPIC.eh_charge_agency ca
		where
			cp.court_payment_trans_id = p_trans_id
		and cp.item_id = bc.bail_condition_id
		and bc.bail_condition_id  = bcc.bail_condition_id
		and bcc.charge_id = ca.charge_id
		UNION
		select substr(EPIC.ef_get_personororgname(ca.agency_id), 1,255)
		from EPIC.eh_court_payment cp,
			 EPIC.eh_fine_payment fp,
			 EPIC.eh_charge ch,
			 EPIC.eh_charge_agency ca
		where cp.court_payment_trans_id = p_trans_id
		and   cp.item_id = fp.payment_id
		and   fp.sentence_id = ch.sentence_id
		and   ch.charge_id = ca.charge_id;

	cursor curIsInmate is
		select ep.entity_id 
		from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat
		where tat.trust_account_trans_id = p_trans_id
		and tat.trust_account_id = ta.trust_account_id
		and ta.entity_id = ep.entity_id;

	v_entity_id			EPIC.eh_booking.entity_id%type;
	v_temp				number;
	v_return			varchar2(255);

begin

	v_return := ' ';

	open curIsInmate;
	fetch curIsInmate into v_return;
	if curIsInmate%notfound then

		open curPayment;
		fetch curPayment into v_return;
		if curPayment%notfound then
			v_return := 'NOT FOUND';
		end if;
		close curPayment;
	end if;
	close curIsInmate;

	if v_return <> 'NOT FOUND' then
		p_return := v_return;
	end if;

	return;

end;
/

CREATE OR REPLACE
procedure mcmb_chk_payor_l1

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is

	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curAddr is

		select trim(ad.street_number || ' ' || ad.street_name)

		from EPIC.eh_address ad

		where ad.entity_id = v_entity_id

		and ad.primary_flag = 'Y';







begin



	v_return := '';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		open curAddr;

		fetch curAddr into p_return;

		if curAddr%notfound then

			p_return := '<No Address on Record>';

		end if;

		close curAddr;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_payor_l2

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is

	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id 
		from EPIC.eh_entity_person ep, 
		     EPIC.eh_trust_account ta, 
		     EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curAddr is

		select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)

		from EPIC.eh_address ad

		where ad.entity_id = v_entity_id

		and ad.primary_flag = 'Y';


begin

	v_return := ' ';


	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		open curAddr;

		fetch curAddr into p_return;

		if curAddr%notfound then

			p_return := '<No Address On Record>';

		end if;

		close curAddr;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_receipt_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'RECEIPT #';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_remitted_by

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from EPIC.eh_court_payment cp,

		     EPIC.eh_bail_condition bc,

		     EPIC.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from EPIC.eh_court_payment cp,

			 EPIC.eh_fine_payment fp,

			 EPIC.eh_charge ch,

			 EPIC.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id from EPIC.eh_entity_person ep, EPIC.eh_trust_account ta, EPIC.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(EPIC.ef_get_personororgname(v_entity_id));

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_remitted_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'REMITTED BY:';

	return;



end;
/

CREATE OR REPLACE
procedure mcmb_chk_user_name

	(p_trans_id			in			EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is







begin



	p_return := EPIC.epp_user_info.get_name('13', 'UC');

	return;



end;
/

CREATE OR REPLACE
procedure      mcmb_chk_voucher_reason
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
	
	cursor curName is
	select decode(tat.description,
				  'BAIL PAYMENT', 'BOND POSTED',
				  'FINE PAYMENT', 'FINE PAYMENT',
				  'UNKNOWN')
	from EPIC.eh_trust_account_trans tat
	where tat.trust_account_trans_id = p_trans_id;
	
begin                          
                                 
	open curName;
	fetch curName into p_return;
	if curName%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curName;

	return;
	
end;
/

CREATE OR REPLACE
procedure        mcmb_clear_restitution_attr
	(p_booking_id in epic.eh_booking.booking_id%type)
is	
vsent_id 		 epic.eh_sentence.sentence_ID%type;
voffender_ID	epic.eh_offender_ids.offender_id%type;
vsuccess 				varchar2(5);	 

 	    
		--vsent_id := 
--epic.EP_LOG_INFO('mcmb_CLEAR_RESTITUTION_ATTR', 'I',-1, 'SENT id ' || VSENT_ID);
		--voffender_ID := macomb.MCMB_FNT_offenderidfromBK(p_booking_ID);
--EP_LOG_INFO('mcmb_CLEAR_RESTITUTION_ATTR', 'I',-1, 'Offender id ' || voffender_ID);
		--macomb.mcmb_ep_set_generic_attribute(voffender_ID, vsent_ID, 'RESTITUTION JUDGEMENT AMOUNT', 0,-57, VSUCCESS); 
        cursor curSent is
        	Select
        		macomb.mcmb_fnt_get_SentenceID(p_booking_id)
        	From dual;
	BEGIN
		vsuccess := null;
		voffender_ID := macomb.MCMB_FNT_offenderidfromBK(p_booking_ID);
		for recSent in curSent
			loop
				macomb.mcmb_ep_set_generic_attribute(voffender_ID, vsent_ID, 'RESTITUTION JUDGEMENT AMOUNT', 0,-57, VSUCCESS);
			end loop; 		
--Exception when vsuccess is null
	if vsuccess is null then
		raise_application_error(-20001, 'MCMB_ep_set_generic_attribute failed.');
		return;
	end if;

END mcmb_clear_restitution_attr;
/

CREATE OR REPLACE
procedure mcmb_ep_set_booking_fee (
	-- jmcbratnie 12/06/2005
	-- Testing of booking fees
	--     
	sentity_ID		 in 	 EPIC.eh_offender_ids.entity_id%type          DEFAULT 'UNKNOWN',
	ssucess             out  EPIC.eh_offender_ids.offender_id%type             
)
As
	------ V A R I A B L E S ---------------------------
	c_debug		constant boolean := false;

    v_server_action_time       varchar2(20);
    v_trust_account_id         EPIC.eh_trust_account.trust_account_id%type;
    v_trust_account_trans_id   EPIC.eh_trust_account_trans.trust_account_trans_id%type;
	p_check_amount			   EPIC.eh_trust_account_trans.amount%type;
	p_result                   EPIC.epic_col_types.number_9%type;
	p_result_msg               EPIC.epic_col_types.varchar_255%type;
	
    
	----------------------------------------------------

begin
	v_server_action_time        := EPIC.epicdatenow;
	v_trust_account_id          := MACOMB.MCMB_FNT_get_trust_account_id(sentity_ID);

    p_check_amount := 0.00;
    p_result	   := 123;
    p_result_msg   := 'Booking Fee';
    
	begin --county fee
		v_trust_account_trans_id    := EPIC.EPIC_IDS.new_epic_id();
		-- note ep_trust_account_trans resets the p_result_msg.  

		EPIC.ep_trust_account_trans (v_trust_account_trans_id,	v_trust_account_id,	'CREDIT', v_server_action_time,
			null, p_result_msg, -10.00, null, null, 'CASH', null, null, 202,
			'Auto-generated', null, null, null, null, null, 
			EPIC.ef_generate_autoid('TRUST ACCOUNTING TRANSACTION NUMBER',v_trust_account_id,'TRUST TRANSACTION'), 
			502, 10.00, 202, -10.00, 'N', -25, 	p_check_amount, 	p_result, p_result_msg );
			
		-- Insert into the audit table.  This was noted in the ep_trust_account_trans function
		insert into epicaudit.eh_trust_account_trans
			select *
			From EPIC.eh_trust_account_trans
			Where
				trust_account_trans_id = v_trust_account_trans_id;

    exception
		when others then
	   		ssucess :='NO';
	End;
	begin --state fee
		v_trust_account_trans_id    := EPIC.EPIC_IDS.new_epic_id();
	    p_result_msg   := 'Booking Fee';  		-- note ep_trust_account_trans resets the p_result_msg.  
	    
		EPIC.ep_trust_account_trans (v_trust_account_trans_id,	v_trust_account_id,	'CREDIT', v_server_action_time,
			null, p_result_msg, -2.00, null, null, 'CASH', null, null, 203,
			'Auto-generated', null, null, null, null, null, 
			EPIC.ef_generate_autoid('TRUST ACCOUNTING TRANSACTION NUMBER',v_trust_account_id,'TRUST TRANSACTION'), 
			503, 2.00, 203, -2.00, 'N', -25, 	p_check_amount, 	p_result, p_result_msg );

		-- Insert into the audit table.  This was noted in the ep_trust_account_trans function
		insert into epicaudit.eh_trust_account_trans
			select *
			From EPIC.eh_trust_account_trans
			Where
				trust_account_trans_id = v_trust_account_trans_id;

    exception
		when others then
	   		ssucess :='NO';
	End;

End mcmb_ep_set_booking_fee;
/

CREATE OR REPLACE
procedure mcmb_ep_set_generic_attribute (
	-- jmcbratnie 12/02/2005
	-- Update or insert into generic_attribute
	-- Commit on the calling side!
	sOffenderID		 in 	 EPIC.eh_offender_ids.offender_id%type          DEFAULT 'UNKNOWN',
	sitem_id         in      EPIC.eh_generic_attribute.item_id%type         DEFAULT 'UNKNOWN',
	sAttribute_name  in      EPIC.eh_generic_attribute.Attribute_name%type  DEFAULT 'UNKNOWN',
	sattribute_value in      EPIC.eh_generic_attribute.attribute_value%type DEFAULT 'UNKNOWN',
	saction_by       in      EPIC.eh_generic_attribute.action_by%type       DEFAULT -1,
	ssucess          in OUT  EPIC.eh_generic_attribute.attribute_id%type
)
As
	------ V A R I A B L E S ---------------------------
	c_debug		constant boolean := false;

    v_server_action_time       varchar2(20);
    v_attrib_id                EPIC.eh_generic_attribute.attribute_id%type;
	----------------------------------------------------

begin
	v_server_action_time := EPIC.epicdatenow;
	v_attrib_id          := MACOMB.mcmb_fnt_get_attrID(sOffenderID, sAttribute_name);
	
	if v_attrib_id is null then
	    Begin
		    v_attrib_id := EPIC.EPIC_IDS.new_epic_id();
			insert into EPIC.eh_generic_attribute(
		    	attribute_id, 
				item_id,
				attribute_name,
				attribute_value,
				action_type,
				action_time,
				action_by)
			values (
				v_attrib_id,
				sitem_id, 
				sAttribute_name,
				sattribute_value,
				'I',
				v_server_action_time,
	    	    saction_by);
			ssucess :='YES';
	   Exception
	   	when others then
	   		ssucess :='NO';
	   End;
	else
		Begin
		    update EPIC.eh_generic_attribute
		      set --attribute_id = vATTRIB_ID, (PK)
			  attribute_name =  sAttribute_name,
			  attribute_value =  sattribute_value,
			  action_type = 'U',
			  action_time = v_server_action_time,
		      action_by = saction_by
		    where 	attribute_name = sAttribute_name and
		    attribute_id = v_attrib_id and 
  		    item_id      = sitem_id;
			ssucess :='YES';

		Exception
			when Others then
				ssucess :='NO';
		End;
    end if;                                               
    
	Begin
	    -- add the updates and inserts to the epicaudit table.
		insert into epicaudit.eh_generic_attribute
			select *
			From EPIC.eh_generic_attribute
			Where attribute_id = v_attrib_id;
	Exception
	   	when others then
	   		ssucess :='NO';
	End;
    
-- The code block below was kept in this procedure because of the concept of:
-- update and if the update fails the exception is to insert instead.  
-- Time did not allow for me to test this concept future yet!  I did not
-- want to lose the concept and will attempt to add this in on the next one 
-- and then update this procedure with the more efficient code

/*exception
	when no_data_found then
	Begin 
		insert into eh_generic_attribute(
		    attribute_id, 
			item_id,
			attribute_name,
			attribute_value,
			action_type,
			action_time,
			action_by)
		values (
			EPIC_IDS.new_epic_id(),
			(select trust_account_id from eh_trust_account ta, eh_offender_ids i where ta.entity_id = i.entity_id and i.offender_id = sOffenderID),
			sAttribute_name,
			sattribute_value,
			'I',
			v_server_action_time,
	        -24);
		return;
	exception
	  when others then
	    raise;
	End;
	*/
End mcmb_ep_set_generic_attribute;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_505_560_trans_amt
	(p_transid_input	in	   EPIC.eh_trust_account_trans.trust_account_trans_id%type,
     p_start_date       in     EPIC.eh_trust_account_trans.trans_date%type,
     p_end_date         in     EPIC.eh_trust_account_trans.trans_date%type)
     
--Returns any transactions (payments by inmate) against acct 505 Legal Judgement Reimbursement
-- or account 560 Cash Settlement
RETURN VARCHAR2 AS

v_Trans		varchar2(128);

	CURSOR cur_Trans IS
		select
			trans.amount
		from
         	EPIC.eh_trust_account_trans trans,
         	EPIC.eh_trust_account trust
         where
     trans.trust_account_trans_id = p_transid_input and
      trans.trust_account_id = trust.trust_account_id and
     -- The next line finds transactions between midnight and 23:59 on the input date range, use previous run date
     (EPIC.ef_epic_date_to_date(trans.trans_date) > (EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_start_date)))
     and EPIC.ef_epic_date_to_date(trans.trans_date) <= (EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_end_date))))
     and trans.code_source_of_funds in ('505','560') and
     trans.reverse_flag is null;  
           
BEGIN
	OPEN cur_Trans;
		FETCH cur_Trans INTO v_Trans;
	CLOSE cur_Trans;
			
RETURN v_Trans;

END;
 --MAZ (modified Kelly's mcmb_fnt_505_trans_amt)
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_505_trans_amt
	(p_input	in		EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_last_run in      EPIC.eh_interface_request.date_submitted%type)

--Returns any transactions (payments by inmate) against acct 505 Legal Judgement Reimbursement
-- or account 560 Cash Settlement that were completed after the input date
RETURN VARCHAR2 AS

v_Trans		varchar2(128);

	CURSOR cur_Trans IS
		select
			trans.amount
		from
         	EPIC.eh_trust_account_trans trans,
         	EPIC.eh_trust_account trust
         where
     trans.trust_account_trans_id = p_input and
     trans.trust_account_id = trust.trust_account_id and
     -- The next line finds transactions completed after the p_last_run date
     trans.trans_date > p_last_run and  
     trans.code_source_of_funds in ('505','560') and
     trans.reverse_flag is null;

BEGIN
	OPEN cur_Trans;
		FETCH cur_Trans INTO v_Trans;
		IF cur_Trans%notfound THEN
			 v_trans := 0;
		END IF;
	CLOSE cur_Trans;

RETURN v_Trans;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_activealerts_full
	(p_entity_id		in			EPIC.eh_housing_assignments.entity_id%type)  
	
--Returns the full text of all of an inmate's active alerts

RETURN EPIC.epic_col_types.varchar_255%type
IS
	
	CURSOR curAlerts IS
		SELECT 	l.text_full
	
		FROM 	EPIC.eh_entity_alerts a,
				EPIC.epic_lookups l
				
		WHERE	a.entity_id = p_entity_id 
				and a.alert_active = 'Y'
				and l.lookup_code = a.alert_type
				and l.lookup_class = 'IOMS ALERT TYPE' 
				
		ORDER BY a.action_time;
	
vAllAlerts  EPIC.epic_col_types.varchar_255%type;
	
BEGIN
    vAllAlerts := null;
    
	FOR a IN curAlerts
	LOOP
		vAllAlerts := vAllAlerts || a.text_full || ' ';
	END LOOP;

RETURN vAllAlerts;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_activealerts_trunc
	(p_entity_id		in			EPIC.eh_housing_assignments.entity_id%type)
	
/*
Purpose: Returns the three character text of all of an inmate's active alerts

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/


RETURN EPIC.epic_col_types.varchar_255%type
IS
	
	CURSOR curAlerts IS
		SELECT	substr(l.text_full,1,3) as text_full
	
		FROM	EPIC.eh_entity_alerts a,
				EPIC.epic_lookups l
				
		WHERE 	a.entity_id = p_entity_id 
			  	and a.alert_active = 'Y'
			  	and l.lookup_code = a.alert_type
			  	and l.lookup_class = 'IOMS ALERT TYPE'
	
		ORDER BY a.action_time;  
	
vAllAlerts  EPIC.epic_col_types.varchar_255%type;
	
BEGIN
    vAllAlerts := null;
    
	FOR a IN curAlerts
	LOOP
		vAllAlerts := vAllAlerts || a.text_full || ' ';
	END LOOP;

RETURN vAllAlerts;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_address
	(p_entity_id	in		EPIC.eh_address.entity_id%type)


/*
Purpose: Returns the city of an inmate's most current address 
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M. Zak		3/8/06			Made changes to order by primary and date_from
											NOTE:Used in mcmb_rpt_Probviol_cc only same as mcmb_fnt_address_city -- need to replace  
				R. Stuve	4/10/06			Replaced function in procedure as per notes above. This no longer used.
*/
	
RETURN VARCHAR2 AS

v_address		EPIC.eh_address.city_town_locale%type;

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;	
		--ORDER BY decode(a.primary_flag,'Y', 1,2), a.action_time desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_address_city
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	
/*
Purpose: Returns the city of an inmate's most current address 
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve	    4/7/06		Verified MACOMB/EPIC schema
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.city_town_locale%type;

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
		
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		           
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_address_numstr
	(p_entity_id	in		EPIC.eh_address.entity_id%type)

/*
Purpose: Returns the numbers and street of an inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema 
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/
	
RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.street_number || ' ' || a.street_name
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
					
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		  
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_address_postal
	(p_entity_id	in		EPIC.eh_address.entity_id%type)   

/*
Purpose: Returns the zip code of the inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema 
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/	

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.postal_code%type;

	CURSOR cur_Address IS
		SELECT
			a.postal_code
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_address_state
	(p_entity_id	in		EPIC.eh_address.entity_id%type)

/*
Purpose: Returns the state of the inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/		

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.state_province_region%type;

	CURSOR cur_Address IS
		SELECT
			a.state_province_region
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;

  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_alias
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)    

/*
Purpose: Returns all of an inmate's alias names (one line, seperated by a '\')

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema 
				R. Stuve	09/22/06		Modified to include cases with multiple master names
*/	
	
RETURN  EPIC.epic_col_types.VARCHAR_2000%type
IS   
	CURSOR curAlias IS
		SELECT
			pi.name_family || ', ' || pi.name_first || ' ' || pi.name_other  as Alias
		FROM
		 	EPIC.eh_person_identity pi,	
			EPIC.eh_entity_person ep
		WHERE 
			ep.entity_id = pi.entity_id   
			AND pi.entity_id =  p_entity_id
			AND decode(pi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A';
		
vAllAlias EPIC.epic_col_types.VARCHAR_2000%type;
  
BEGIN
	vAllAlias := null;
		FOR a IN curAlias
			LOOP vAllAlias := vAllAlias || a.alias || ' \ ';
			END LOOP;
		RETURN vAllAlias;
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_AliasFlag
	 (p_entity_id 	IN 	EPIC.eh_active_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate has any Alias Names

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 

	 
RETURN VARCHAR2 AS
  CURSOR curAlias IS 
  	SELECT '*'

	FROM 	EPIC.eh_person_identity pi

	WHERE   pi.code_name_type != 'MAS'
			and pi.entity_id = p_entity_id;
     
     
v_Alias varchar2(1);


BEGIN
	-- Look for any alias for this inmate:  
  	OPEN curAlias;
  		FETCH curAlias INTO v_Alias;
  	CLOSE curAlias;
	
-- If we found an alias, 'v_Alias' will be set to '*', if not it will return a null
RETURN NVL (v_Alias, NULL);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_alias_sepline
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)   
	
--Returns an inmate's alias names (each on a seperate line)
	
RETURN  EPIC.epic_col_types.varchar_2000%type
IS   
	CURSOR curAlias IS
		SELECT
			pi.name_family || ', ' || pi.name_first || ' ' || pi.name_other
		FROM
		 	EPIC.eh_person_identity pi	
		WHERE    
			pi.entity_id =  p_entity_id
			AND pi.code_name_type != 'MAS';
		
vAlias EPIC.epic_col_types.varchar_2000%type;
  
BEGIN	
	OPEN curAlias;
		FETCH curAlias into vAlias;
	RETURN vAlias;
	CLOSE curAlias;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_AlienNum
	(p_entity_id	in	EPIC.eh_person_identity.entity_id%type)

/*
Purpose: Returns an inmates alien number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
		
RETURN VARCHAR2
IS  v_Alien			EPIC.eh_offender_ids.fbi_id%type;

	CURSOR curAlien IS
	SELECT	o.fbi_id
	
	FROM	EPIC.eh_offender_ids o
	
	WHERE	o.entity_id = p_entity_id;			


BEGIN	

	OPEN curAlien;
		FETCH curAlien into v_Alien;
	CLOSE curAlien;
		
	RETURN v_Alien;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_alphabin
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE) 
	
--This was for testing purposes only and is not correct/valid

RETURN EPIC.otk_property_bin.bin_number%TYPE
IS

	CURSOR curBin IS
		SELECT DISTINCT b.bin_number
		
 		FROM 	EPIC.otk_property_bin b,
				EPIC.eh_property_item i,
				EPIC.eh_offender_property p
				
		WHERE	p.entity_id = p_entity_id
	  			AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id;
	   
vBin	EPIC.otk_property_bin.bin_number%TYPE;
	
BEGIN

	OPEN curBin;
	FETCH curBin INTO vBin;
	if curbin%found then
	    close curbin;
	    return vbin;
	end if;    
	CLOSE curBin;
	--not found in either, return 'no unit'
return '-No Bin-';  --11-10-04 dlk added to return No Bin rather than blank in report like -No Cell- or -No Housing-.
--RETURN vBin;
	
END;
	
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_alphabin_current
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE)

/*
Purpose: Returns an inmates most current property bin number

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN EPIC.otk_property_bin.bin_number%TYPE
IS

	CURSOR curBin IS
		SELECT  DISTINCT b.bin_number
		
 		FROM 	EPIC.otk_property_bin b,
				EPIC.eh_property_item i,
				EPIC.eh_offender_property p
				
		WHERE	p.entity_id = p_entity_id
	  			AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id
	  			AND i.action_time = ((SELECT DISTINCT max (i.action_time)
 						FROM 	EPIC.otk_property_bin b,
								EPIC.eh_property_item i,
								EPIC.eh_offender_property p
    					WHERE	p.entity_id = p_entity_id
	  					AND i.item_id = p.item_id
	  					AND b.bin_id = i.bin_id));
	   
vBin	EPIC.otk_property_bin.bin_number%TYPE;
	
BEGIN

	OPEN curBin;
	FETCH curBin INTO vBin;
	if curbin%found then
	    close curbin;
	    return vbin;
	end if;    
	CLOSE curBin;
	--not found in either, return 'no unit'
return '-No Bin-';  --11-10-04 dlk added to return No Bin rather than blank in report like -No Cell- or -No Housing-.
--RETURN vBin;
	
END;
	
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_alphacharge
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns an inmate's most serious, most current charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	


RETURN EPIC.epic_statutes.statute_description%type
IS

	CURSOR curCharge IS
		SELECT 	es.statute_description,
 		   		decode(es.code_statute_class,'FEL',1,2) as Idx

		FROM	EPIC.epic_statutes es,
				EPIC.eh_charge ec
	
		WHERE 	ec.booking_id = p_booking_id
			  and ec.charge_state <> 6
			  and es.statute_id = ec.statute_id
		ORDER BY Idx;  
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_description%type;
	
BEGIN
	OPEN curCharge;
	FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
	vchgscrpt := vChargeRec.statute_description;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_area_code
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	

--Returns the area code of an inmate's most current telephone number

RETURN VARCHAR2 AS

v_code		EPIC.eh_telephone_records.area_code%type;

	CURSOR cur_code IS
		SELECT
			t.area_code
		FROM
		 	EPIC.eh_telephone_records t,
		 	EPIC.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_code;
		FETCH cur_code INTO v_code;
	CLOSE cur_code;
			
RETURN v_code;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_area_code_primary
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	

--Returns the area code of an inmate's most current telephone number
--Cloned area_code to include condition 'Primary_flag = 'Y' or ' ' KJH
RETURN VARCHAR2 AS

v_code		EPIC.eh_telephone_records.area_code%type;

	CURSOR cur_code IS
		SELECT
			t.area_code
		FROM
		 	EPIC.eh_telephone_records t,
		 	EPIC.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			and (t.primary_flag = 'Y' or t.primary_flag = ' ')
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_code;
		FETCH cur_code INTO v_code;
	CLOSE cur_code;
			
RETURN v_code;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_arresttype
 (p_charge_id		in		EPIC.eh_charge.charge_id%type)

/*
Purpose: Returns the arrest type for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
 
RETURN VARCHAR2 AS

	CURSOR cur_arrest IS
		SELECT	
			substr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),1,1) || substr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),instr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),' ')+1,1)
		FROM
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id;
	                                      
vArrest  VARCHAR2(2);

BEGIN
    OPEN cur_arrest;
		FETCH cur_arrest INTO vArrest;
	CLOSE cur_arrest;
	
RETURN vArrest;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Bailable
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE)  
	 
--Returns a Y/N flag based on the bail condition of the charge
	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT	b.is_bailable

	FROM	EPIC.eh_bail_condition b,
			EPIC.eh_charge c
	
	WHERE	c.booking_id = b.booking_id
			and c.charge_id = p_charge_id;	
     
vBail 	EPIC.eh_bail_condition.is_bailable%TYPE;

BEGIN
  	OPEN curBail;
  		FETCH curBail INTO vBail;
  	CLOSE curBail;

RETURN vBail; 
	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_BailAmount
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the bail amount

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 01/23/06		Created 
					J. McBratnie 02/08/06       Updated function to remove the ref to the 
					                            eh_charge table it serves no use.
					DLK          03/09/06       ADDED THE EPIC NOTATION 
					R. Stuve	 04/06/06		Verified MACOMB/EPIC schema
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT 	b.cash_only_bail_amount 
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc--,
			--eh_charge c
			
	WHERE	p_charge_id /*c.charge_id*/ = bc.charge_id
			and bc.bail_condition_id = b.bail_condition_id
			and bc.charge_id = p_charge_id;
     
     
vBail	 EPIC.eh_bail_condition.cash_only_bail_amount%TYPE;


BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_BailPaid
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if the bail has been paid; a 'N' flag if the bail has not been paid
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT 	b.is_satisfied
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
	WHERE	c.charge_id = bc.charge_id
			and bc.bail_condition_id = b.bail_condition_id
			and bc.charge_id = p_charge_id;
     
     
vBail	 EPIC.eh_bail_condition.is_satisfied%TYPE;


BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN vBail;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Bail_10Percent_Amount
	 (p_BAIL_CONDITION_ID 	in 	EPIC.EH_BAIL_CONDITION_CHARGE.BAIL_CONDITION_ID%TYPE) 
/*	
	System: 		WEB
	Purpose:		Return other attribute "10 percent bond" based on bail_condition_id 

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/10/06       Created function 
					DLK          03/09/06       ADDED THE EPIC NOTATION
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBailReduced IS 
  	SELECT 	EPIC.EF_GET_ATTRIBUTE_VALUE('10 PERCENT BOND',bail_condition_id) 
  	
	FROM 	--eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc--,
			--eh_charge c
			
	WHERE	p_BAIL_CONDITION_ID /*c.charge_id*/ = bc.BAIL_CONDITION_ID;
			--and bc.bail_condition_id = b.bail_condition_id
			--and bc.charge_id = p_charge_id;
     
     
vBailReducable	 varchar2(16);


BEGIN
  	OPEN curBailReduced;
  	FETCH curBailReduced INTO vBailReducable;
  	CLOSE curBailReduced;

  	RETURN NVL (vBailReducable, 'NO');
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Bail_Total_Amount
	 (p_booking_id 	in 	EPIC.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total bail amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/08/06       created
					DLK          03/09/06       ADDED THE EPIC NOTATION 
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBail IS   	
  SELECT 	b.booking_id, sum(b.cash_only_bail_amount)
	FROM 	EPIC.eh_bail_condition b
   WHERE	p_booking_id = b.BOOKING_ID
group by    booking_id;

vBail	 EPIC.eh_bail_condition.cash_only_bail_amount%TYPE;
vbook    EPIC.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vbook, vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_birthcity 
	(p_entity_id		in		EPIC.eh_person_identity.entity_id%type) 

/*
Purpose: Returns the city of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2
IS

v_city		EPIC.eh_person_identity.code_birthplace_city%type;

	CURSOR cur_city IS
		SELECT
			i.code_birthplace_city
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_city;
		FETCH cur_city INTO v_city; 
			IF (cur_city%notfound or v_city = '_NOSP' or v_city is null) THEN
				v_city := 'UNKNOWN';
			END IF;	
	CLOSE cur_city;
			
RETURN v_city;

END; 
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_birthcountry 
	(p_entity_id				in		EPIC.eh_person_identity.entity_id%type)
	
/*
Purpose: Returns the country of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2
IS

v_country		EPIC.eh_person_identity.birth_country%type;

	CURSOR cur_country IS
		SELECT
			i.birth_country
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_country;
		FETCH cur_country INTO v_country; 
	CLOSE cur_country;
			
RETURN EPIC.ef_lookup_text('COUNTRY', v_country, 'UC');

END; 
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_birthstate 
	(p_entity_id		in		EPIC.eh_person_identity.entity_id%type)
	
/*
Purpose: Returns the state of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
RETURN VARCHAR2
IS

v_state		EPIC.eh_person_identity.birth_state%type;

	CURSOR cur_state IS
		SELECT
			i.birth_state
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_state;
		FETCH cur_state INTO v_state; 
	CLOSE cur_state;
			
RETURN NVL (v_state, 'UNKN');

END; 
--RAS
/

CREATE OR REPLACE
function MCMB_FNT_booking_id_frm_sent (
	p_sentence_id           in      EPIC.EH_sentence.sentence_id%type)
return EPIC.eh_charge.charge_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value
--
	v_id					EPIC.eh_charge.charge_id%type;
	cursor cur_id is
		select c.booking_id
		from EPIC.eh_charge c
		where c.sentence_id = p_sentence_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_booking_id_frm_sent ;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_book_date
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
 

RETURN VARCHAR2 AS

v_book_id			EPIC.eh_booking.booking_id%type;

	CURSOR cur_booking IS
		select
			bk.booking_id 
			from epicaudit.eh_booking bk
			where bk.entity_id = p_entity_id
			and bk.sentence_start_date >= (EPIC.ef_epic_date_to_date(EPIC.ef_min_date('2005061100:00:00-240')))
  			and bk.end_date > (EPIC.ef_epic_date_to_date(EPIC.ef_max_date('2005080300:00:00-240')))
  			and bk.end_date < (EPIC.ef_epic_date_to_date(EPIC.ef_min_date('2005080900:00:00-240')));
BEGIN
	OPEN cur_booking;
		FETCH cur_booking INTO v_book_id;
	 	CLOSE cur_booking;	
			
RETURN v_book_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_book_id
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file

RETURN VARCHAR2 AS

v_booking_id				EPIC.eh_booking.booking_id%type;

	CURSOR cur_id IS
		select
			bk.booking_id  
			from EPIC.eh_booking bk
			where bk.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_id;
		FETCH cur_id INTO v_booking_id;
	 	CLOSE cur_id;	
			
RETURN v_booking_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CaseNumber
	 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the case number of the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curCaseNumber IS 
  	SELECT  c.case_number
  	
	FROM 	EPIC.eh_case c, 
			EPIC.eh_case_charge cc,
			EPIC.eh_charge ch
			
	WHERE	ch.charge_id = cc.charge_id
			and cc.case_id = c.case_id
			and ch.charge_id = p_charge_id;
	     
     
vCaseNumber	 EPIC.eh_case.case_number%TYPE;


BEGIN
  	OPEN curCaseNumber;
  		FETCH curCaseNumber INTO vCaseNumber;
  	CLOSE curCaseNumber;

  	RETURN vCaseNumber;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_chargedesc
 (p_statute_id			in		EPIC.eh_charge.statute_id%type)

/*
Purpose: Returns the statute text for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
 
RETURN EPIC.epic_statutes.statute_description%type
IS

	CURSOR cur_result IS
		SELECT	
			distinct es.statute_description
		FROM
			EPIC.epic_statutes es, 
			EPIC.epic_codes ec
		WHERE
			es.statute_id = p_statute_id
			and ec.code_id = es.code_id;
	                                      
vStatute EPIC.epic_statutes.statute_description%type;

BEGIN
    OPEN cur_result;
		FETCH cur_result INTO vStatute;
	CLOSE cur_result;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
function MCMB_FNT_chargeidfrom_Bail (
	p_BAIL_CONDITION_ID			in		EPIC.EH_BAIL_CONDITION.BAIL_CONDITION_ID%type)
return EPIC.EH_BAIL_CONDITION_CHARGE.CHARGE_ID%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value from BAIL_CONDITION_ID
--
	v_id					EPIC.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select bcc.charge_id
		from   EPIC.EH_BAIL_CONDITION_CHARGE bcc
		where  bcc.BAIL_CONDITION_ID = p_BAIL_CONDITION_ID;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MCMB_FNT_chargeidfrom_caseid (
	p_case_id				in		EPIC.eh_case_court.case_id%type)
return EPIC.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value from case_id
--
	v_id					EPIC.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select cc.charge_id
		from   EPIC.EH_CASE_CHARGE cc
		where  cc.case_id = p_case_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_ChargeStatusCode
	(p_charge_id		in	EPIC.eh_charge.charge_id%type,
	 p_StartDate		in	EPIC.eh_charge.action_time%type) 

/*
Purpose: Returns the charge status at the selected time  

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/11/06			Verified MACOMB/EPIC schema
*/
	 
RETURN VARCHAR2 AS                                 

	v_max_date		varchar2(20);

	CURSOR curCode IS
		SELECT	ga.attribute_value
		
		FROM 	EPICAUDIT.eh_generic_attribute ga
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				and ga.item_id = p_charge_id
				and EPIC.ef_epic_date_to_date(ga.action_time) <= v_max_date
				and not exists
					(select 1 
					from EPICAUDIT.eh_generic_attribute ga2
					where ga2.item_id = ga.item_id
					and EPIC.ef_epic_date_to_date(ga2.action_time) < v_max_date
					and EPIC.ef_epic_date_to_date(ga2.action_time) > EPIC.ef_epic_date_to_date(ga.action_time))
UNION ALL

		SELECT 	ga.attribute_value
		
		FROM 	EPICAUDIT.eh_generic_attribute ga
		
		WHERE 	ga.item_id = p_charge_id  
				and EPIC.ef_epic_date_to_date(ga.action_time) <= v_max_date
				and not exists
					(select 1
					 from EPICAUDIT.eh_generic_attribute ga2
					 where ga2.item_id = ga.item_id
					 and EPIC.ef_epic_date_to_date(ga2.action_time) < v_max_date);

				
vCode	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN                

	v_max_date := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_StartDate));
	OPEN curCode;
		FETCH curCode INTO vCode;
	CLOSE curCode;
	
RETURN vCode;
	
END;
--RAS
/

CREATE OR REPLACE
function mcmb_fnt_charge_end_date(
		p_charge_id				EPIC.eh_charge.charge_id%type
		)
return EPIC.eh_charge.action_time%type

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

is

	cursor cur_charge_date is
		select
			c.action_time
		from
			EPICAUDIT.eh_charge c
		where
			charge_id = p_charge_id
			and charge_state = '6'
		order by
			action_time;
	v_date		EPIC.eh_charge.action_time%type;

begin
	open cur_charge_date;
	fetch cur_charge_date into v_date;
	close cur_charge_date;
	return v_date;
end;
/

CREATE OR REPLACE
function MCMB_FNT_charge_id_frm_sent (
	p_sentence_id           in      EPIC.EH_sentence.sentence_id%type)
return EPIC.eh_charge.charge_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value
--
	v_id					EPIC.eh_charge.charge_id%type;
	cursor cur_id is
		select c.charge_id
		from EPIC.eh_charge c
		where c.sentence_id = p_sentence_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_charge_id_frm_sent ;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_charge_sent_released
	 (p_booking_id IN EPIC.eh_charge.booking_id%TYPE)  
--Returns the charge_id if booking_entity_status has been '02 - Sentenced' and '01- Released'	 

RETURN VARCHAR2 AS
v_Sent		EPIC.eh_charge.charge_id%type;
  CURSOR cur_Sent IS 

SELECT 	MAX(chg.charge_id) 
  	 FROM 	EPIC.eh_charge chg
  	 		
	WHERE	p_booking_id = chg.booking_id and				       
			chg.charge_state = '6' and
			chg.disposition_reason = '001' and
			chg.booking_id in
			(select chg.booking_id
				from EPIC.eh_booking_entity_status bk JOIN EPIC.eh_booking_entity_status bk2					 
				on (bk.booking_id = bk2.booking_id),
				EPIC.eh_charge chg	
				where
				chg.booking_id = bk.booking_id and 
				(bk.code_entity_status = '01' AND bk2.code_entity_status = '02'));
BEGIN
	OPEN cur_Sent;
		FETCH cur_Sent INTO v_Sent;
	 	CLOSE cur_Sent;	
			
RETURN v_Sent;
END;
--KJH							
/

CREATE OR REPLACE
function mcmb_fnt_charge_start_date(
		p_charge_id				EPIC.eh_charge.charge_id%type
		)
return EPIC.eh_charge.action_time%type

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

is

	cursor cur_charge_date is
		select
			c.action_time
		from
			EPICAUDIT.eh_charge c
		where
			charge_id = p_charge_id
			and charge_state <> '6'
		order by
			action_time;
	v_date		EPIC.eh_charge.action_time%type;

begin
	open cur_charge_date;
	fetch cur_charge_date into v_date;
	close cur_charge_date;
	return v_date;
end;
--maz 
-- per bob closes way to get date - time stamp for charges use epicaudit (initial record)
-- another way would be to use an attribute
-- another way is use booking start date - no because the charge is added later...(mz)
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CheckInmate
	(p_trans		in		EPIC.eh_trust_account_trans.trust_account_trans_id%type)
	
--For testing only: returns the inmate's name belonging to the trust account transaction/id (not currently used)
 
RETURN EPIC.epic_col_types.varchar_255%type
IS
	CURSOR curInmate IS
		SELECT
			EPIC.ef_get_personororgname(ta.entity_id)
		FROM
			EPIC.eh_trust_account ta,
			EPIC.eh_trust_account_trans tat
		WHERE
			tat.trust_account_id = ta.trust_account_id
			and tat.trust_account_trans_id = p_trans;
	                                      
	vInmate EPIC.epic_col_types.varchar_255%type;

BEGIN
    OPEN curInmate;
		FETCH curInmate INTO vInmate;
	CLOSE curInmate;
	
RETURN vInmate;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_citizenship
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
--Returns an inmate's citizenship

RETURN VARCHAR2
IS

v_citizen	EPIC.eh_citizenship.country_code%type;

	CURSOR cur_citizenship IS
		SELECT
			c.country_code
		FROM
		 	EPIC.eh_citizenship c	
		WHERE    
			c.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_citizenship;
		FETCH cur_citizenship INTO v_citizen;
	CLOSE cur_citizenship;
			
RETURN EPIC.ef_lookup_text('COUNTRY', v_citizen, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_ClassLevel
	(p_location_id		in	EPIC.eh_housing_assignments.location_id%type,
	 p_StartDate		in	EPIC.eh_housing_assignments.action_time%type,
	 p_level			in	char)

/*
Purpose: Returns the classification level of the selected cell at the selected time.  
		Uses inputs of either 'L' for the low classification or 'H' for the high classification

	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS 
	CURSOR curLoc IS
		SELECT	decode (p_level,'L', loc.classification_low,'H',loc.classification_high)
		
		FROM	epicaudit.epic_locations loc
		
		WHERE  	EPIC.ef_epic_date_to_date(loc.action_time) <= EPIC.ef_epic_date_to_date(p_StartDate)
				and not exists (
					select 	1
					from 	epicaudit.epic_locations loc2
					where 	loc2.location_id = loc.location_id
							and EPIC.ef_epic_date_to_date(loc2.action_time) < EPIC.ef_epic_date_to_date(p_StartDate)
							and EPIC.ef_epic_date_to_date(loc2.action_time) > EPIC.ef_epic_date_to_date(loc.action_time)
								)
				and loc.location_id = p_location_id;
				
vLoc	EPIC.epic_locations.classification_low%type;

BEGIN
	OPEN curLoc;
		FETCH curLoc INTO vLoc;
	CLOSE curLoc;
	
RETURN vLoc;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_ClassYN
	 (p_booking_id IN EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'YES' flag if the inmate has an active classification

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curClass IS   	
  	SELECT 	'YES'

    FROM 	EPIC.eh_booking b,
			EPIC.eh_security_classification s

	WHERE	b.booking_id = s.booking_id
			and b.booking_id = p_booking_id;	
     
    
v_class	EPIC.eh_security_classification.classification%type;


BEGIN
	-- Look for an active classification for the inmate (per the above criteria/query):  
  	OPEN curClass;
  		FETCH curClass INTO v_class;
  	CLOSE curClass;
	-- If we found an active classification, 'v_class' will be set to 'CLD', if not return a null
  	RETURN NVL (v_class, NULL);
  		
END;

--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CntAgy
	 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE)  

/*
Purpose: Returns the controlling agency for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT 	ca.agency_id 
  	
	FROM 	EPIC.eh_charge_agency ca,
			EPIC.eh_charge c,
			EPIC.eh_booking b
			
	WHERE	ca.charge_id = c.charge_id
			and c.booking_id = b.booking_id
			and b.booking_id = p_booking_id;
     
     vAgy	 EPIC.eh_charge_agency.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN EPIC.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_complexion
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the inmate's complexion
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2 AS

v_comp		EPIC.eh_person_snapshot.code_complexion%type;

	CURSOR cur_comp IS
		SELECT
			s.code_complexion
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_comp;
		FETCH cur_comp INTO v_comp;
		CLOSE cur_comp;
			
RETURN EPIC.ef_lookup_text('COMPLEXION', v_comp, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_ControlAgy
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the controlling agency for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT  c.agency_id
  	
	FROM 	EPIC.eh_charge_agency c
			
	WHERE	c.charge_id = p_charge_id;
     
     
vAgy	 EPIC.eh_charge_agency.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN EPIC.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CountHolds
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE) 
	 
--Returns a count of the number of active holds an inmate has (not currently used in any reports)
	 
RETURN VARCHAR2 AS
  CURSOR curCount IS   	
  	SELECT 	count(h.hold_id)

    FROM 	EPIC.eh_booking b,
			EPIC.eh_booking_holds h

	WHERE	b.booking_id = h.booking_id
			and ((EPIC.ef_epic_date_to_date(h.hold_removed_date) is null)
					or (EPIC.ef_epic_date_to_date(h.hold_removed_date) > EPIC.ef_epic_date_to_date(sysdate)))
			and b.entity_id = p_entity_id
			
	GROUP BY	b.booking_id;		
     
     
v_count number(3);


BEGIN
	OPEN curCount;
		FETCH curCount into v_count;
	CLOSE curCount;
	
RETURN v_count;
   	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CourtDate
		 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns an inmate's next court date for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	ca.appearance_date
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = p_charge_id;
     
     
vCourtDate	 EPIC.eh_court_appearance.appearance_date%TYPE;


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

  	RETURN vCourtDate;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_CourtName
	 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE)

/*
Purpose: Returns the court name for the next court appearance for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 	 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtName IS 
  	SELECT 	ca.court_name
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = p_charge_id;
     
     
vCourtName	 EPIC.eh_court_appearance.court_name%TYPE;


BEGIN
  	OPEN curCourtName;
  		FETCH curCourtName INTO vCourtName;
  	CLOSE curCourtName;

  	RETURN EPIC.ef_lookup_text('COURT NAME', vCourtName, 'UC');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_audit
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)
	
--Returns an inmate's custody status (eh_booking_custody_status.code_custody_status)
--for a certain booking in the proper time frame
--then converts it to a MACIS tran code, using the epicaudit tables after
--the inmate has been released.
RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		SELECT
			 bkstat.code_custody_status
		FROM
			 epicaudit.eh_booking_custody_status bkstat
		WHERE
			p_booking_id = bkstat.booking_id and
			EPIC.ef_epic_date_to_date(bkstat.date_end) is null;
					 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202'
			when '10' then '4202'
			when '4' then '4229'
			when '5' then '4201'
			else ''
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_change
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)
	
--Returns an inmate's custody status using booking_id(eh_booking_custody_status.code_custody_status)
-- when it has changed since the last run.
--for a certain booking in the proper time frame then converts it to a MACIS tran code.
RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		SELECT
			 bkstat.code_custody_status
		FROM
			 EPIC.eh_booking_custody_status bkstat
		WHERE
			p_booking_id = bkstat.booking_id
			and EPIC.ef_epic_date_to_date(bkstat.date_start) > EPIC.ef_epic_date_to_date(EPIC.ef_min_date('20050820400:00:00-000')); --last run date
								 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202' --regular
			when '10' then '4202' --booger
			when '4' then '4229' --weekender
			when '5' then '4201'--work release
			else ''
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_code
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the latest inmate's custody status code (eh_booking_custody_status.code_custody_status)
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

	CURSOR cur_Code IS
		select
	       code_custody_status
	from EPIC.eh_booking_custody_status
	where
	 EPIC.ef_epic_date_to_date(date_start) in
		(select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id);
					 
v_Code		varchar2(128);
  
BEGIN
	
	OPEN cur_Code;
		FETCH cur_Code INTO v_Code;
	CLOSE cur_Code;
			
RETURN v_Code;

END;
 --MAZ
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_codet
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)
	
-- Updated the table this is looking at. - J. McBratnie 12/15/2005
-- Returns the latest inmate's custody status code (eh_booking_custody_status.code_custody_status)

RETURN VARCHAR2 AS

	CURSOR cur_Code IS
select code_entity_status /*, 
       ef_lookup_text('OFFENDER STATUS',code_entity_status,'UC') */
from EPIC.eh_entity_status es , 
     EPIC.eh_active_booking ab 
where es.entity_id = ab.entity_id and
      ab.booking_id = p_booking_id;



/* COMMENTED OUT BY JOE
		select
	       code_custody_status
	from eh_booking_custody_status
	where
	 date_start in
		(select max(date_start)
		from eh_booking_custody_status
		where booking_id = p_booking_id); 
*/		
      
v_Code		varchar2(128);
  
BEGIN
	
	OPEN cur_Code;
		FETCH cur_Code INTO v_Code;
	CLOSE cur_Code;
			
RETURN v_Code;

END;
 --MAZ
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_desc
	(p_lookup_code	in		EPIC.epic_lookups.lookup_code%type)

/*
Purpose: Receives look up code returns description (custody status code description per given code)
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS 
	CURSOR CurCode IS
    	select	el.text_full
    	
		from 	EPIC.epic_lookups el
		
     	where   lookup_class   ='ADMIN STATUS'
				AND el.lookup_code = p_lookup_code;

vDesc	EPIC.epic_lookups.text_full%type;

BEGIN
	OPEN CurCode;
		FETCH CurCode INTO vDesc;
	CLOSE CurCode;

RETURN NVL (vDesc, 'NO DESC');
	
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_gvt
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)
	
--Returns an inmate's custody status using booking_id(eh_booking_custody_status.code_custody_status)
--for a certain booking in the proper time frame then converts it to a MACIS tran code.
RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		select
	       code_custody_status
	from EPIC.eh_booking_custody_status
	where
	 EPIC.ef_epic_date_to_date(date_start) in
		(select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id);
								 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202' --regular
			--when '10' then '4202' --booger (this option eliminated on 1/6/06 per Lori Dunlop, Green Trusty's are no longer charged.)
			when '4' then '4229' --weekender
			when '5' then '4201'--work release
			else ''
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_report
	(p_booking_id	in		EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns an inmate's custody status (eh_booking_custody_status.code_custody_status)for a certain booking in the proper time frame.
		 This is just for Loris temp report

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				K. Heinz					Created
				R. Stuve	4/12/06			Verified EPIC/MACOMB schema
*/	

RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		select
	       code_custody_status
	from EPIC.eh_booking_custody_status
	where
	 EPIC.ef_epic_date_to_date(date_start) in
		(select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id);
					 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then 'Regular'          --4202
			--when '10' then 'Green Trustee'   --4202 discontinued 1/6/06, per Lori Dunlop
			when '4' then 'Weekender'        --4229
			when '5' then 'Work Release'     --4201
			else 'Other'
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_custody_status_trans
	(p_entity_id	in		EPIC.eh_person_identity.entity_id%type)
	
--Returns an inmate's entity status using entity_id(eh_entity_status.code_custody_status)
--then converts it to a MACIS tran code..for inmates already released during conversion period
RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		SELECT
			 bkstat.code_custody_status
		FROM
			EPIC.eh_entity_status bkstat
			 		 	
		WHERE    
			p_entity_id = bkstat.entity_id (+); 
			 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202'
			--when '10' then '4202' (option eliminated 1/06/06 per Lori Dunlop, Green Trusty's are no longer charged Room & Board)
			when '4' then '4229'
			when '5' then '4201'
			else '4202'
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_datereleased_gvt
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns an inmate's release date i 

RETURN VARCHAR2 AS

v_rel_date				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_rel_date IS
		select
			EPIC.ef_epic_date_to_date(bk.end_date)  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_rel_date;
		FETCH cur_rel_date INTO v_rel_date;
	 	CLOSE cur_rel_date;	
			
RETURN EPIC.ef_epic_date_to_date(v_rel_date);
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_datesent_gvt
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns an inmate's sentence date  

RETURN VARCHAR2 AS

v_sent_date				EPIC.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			EPIC.ef_epic_date_to_date(bk.sentence_start_date)  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_DispoDate
		(p_charge_id	in		EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the date the selected charge was disposed
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema  
				R. Stuve	10/17/06		Added c.charge_state to account for charges that have been disposed, re-opened
*/		

RETURN		epicaudit.eh_charge.action_time%type
IS

	CURSOR curDate IS
		SELECT 	EPIC.ef_epic_date_to_date(ea.action_time)

		FROM 	EPICAUDIT.eh_charge ea,
				EPIC.eh_charge c

		WHERE  	ea.charge_id = c.charge_id
				and ea.charge_state = '6'   --finds most recent dispo date
				and c.charge_state = '6'  --limits to charges that are currently disposed
				and c.charge_id = p_charge_id

		ORDER BY EPIC.ef_epic_date_to_date(ea.action_time) desc;
	
	
	vDate	EPICAUDIT.eh_charge.action_time%type;
	
	
BEGIN
	OPEN curDate;
		FETCH curDate INTO vDate;
	CLOSE curDate;
	
RETURN vDate;
	
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_dispodate_gvt
	 (p_booking_id IN EPIC.eh_charge.booking_id%TYPE)  
	 
--Returns max action_time if a charge has been sentenced & disposed; otherwise, returns a 'U'
-- Per Sgt. Roberts, the chg.disposition_reasons all include being sentenced  12/09/05 KJH	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	MAX(EPIC.ef_epic_date_to_date(chg.action_time)) 
  	
    FROM 	EPIC.eh_charge chg
            
	WHERE	p_booking_id = chg.booking_id and
	        
			chg.charge_state = '6' and
			chg.disposition_reason in
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV');      
     
v_status EPIC.eh_charge.action_time%type;


BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
RETURN NVL (v_status,'U');
  		
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_dispodate_gvt_fix
	 (p_booking_id IN EPIC.eh_charge.booking_id%TYPE)  
-- To be used in the fix extract of Dispo 001's that were missed from June12, 05 thru Nov. 27, 05 	 
--Returns max action_time if a charge has been sentenced & disposed; otherwise, returns a 'U'
-- Per Sgt. Roberts, the chg.disposition_reasons all include being sentenced  12/09/05 KJH	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	MAX(EPIC.ef_epic_date_to_date(chg.action_time)) 
  	
    FROM 	EPIC.eh_charge chg
            
	WHERE	p_booking_id = chg.booking_id and
	        
			chg.charge_state = '6' and
			(chg.disposition_reason = '001' and
			chg.disposition_reason not in 
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV'));
			
     
v_status EPIC.eh_charge.action_time%type;


BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
RETURN NVL (v_status,'U');
  		
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_disporeason_gvt_fix
	 (p_booking_id IN EPIC.eh_booking.booking_id%TYPE)  

--Cloned from fnt_SentOneChg to find disposition reasons that include 'sentenced'	 
--Returns 'S' if a disposed charge has been sentenced and released; otherwise, returns a 'U'
-- Used to fix the GVt import data 12/14/05 kjh	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_booking book,
			EPIC.eh_charge chg
  	 		
	WHERE	p_booking_id = chg.booking_id and				       
			chg.charge_state = '6' and
			(chg.disposition_reason = '001' and
			chg.disposition_reason not in 
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV')) and
			chg.booking_id in
			(select chg.booking_id
				from EPIC.eh_booking_entity_status bk JOIN EPIC.eh_booking_entity_status bk2					 
				on (bk.booking_id = bk2.booking_id),
				EPIC.eh_charge chg	
				where
				chg.booking_id = bk.booking_id and 
				(bk.code_entity_status = '01' AND bk2.code_entity_status = '02'));
v_status EPIC.eh_charge.disposition_reason%type;

BEGIN
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_disporeason_sent
	 (p_booking_id IN EPIC.eh_charge.booking_id%TYPE)  
	 
--Returns 'S' if a charge has been disposed with a reason that includes being sentenced
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_charge chg JOIN EPIC.eh_charge chg2
    		on (chg.booking_id = chg2.booking_id)
			     		
	WHERE	p_booking_id = chg.booking_id
			and chg2.booking_id = chg.booking_id
			and chg.charge_state = '6' and 
			chg2.disposition_reason in ('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV');     
            --above list of dispo reasons modified 12/09/05 per Sgt. Ken Roberts-- documentation in file kjh
v_status EPIC.eh_charge.charge_state%type;

BEGIN
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_disporeason_sent2
	 (p_booking_id IN EPIC.eh_booking.booking_id%TYPE)  

--Cloned from fnt_SentOneChg to find disposition reasons that include 'sentenced'	 
--Returns 'S' if a disposed charge has been sentenced and released; otherwise, returns a 'U'
-- Used to fix the GVt import data 12/14/05 kjh	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_booking book,
			EPIC.eh_charge chg
  	 		
	WHERE	p_booking_id = chg.booking_id and				       
			chg.charge_state = '6' and
			chg.disposition_reason = '001' and
			chg.booking_id in
			(select chg.booking_id
				from EPIC.eh_booking_entity_status bk JOIN EPIC.eh_booking_entity_status bk2					 
				on (bk.booking_id = bk2.booking_id),
				EPIC.eh_charge chg	
				where
				chg.booking_id = bk.booking_id and 
				(bk.code_entity_status = '01' AND bk2.code_entity_status = '02'));
v_status   EPIC.eh_charge.disposition_reason%type;

BEGIN
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_disporeason_test
	 (p_booking_id IN EPIC.eh_charge.booking_id%TYPE)  
	 
--Returns 'S' if a charge has been sentenced & disposed; otherwise, returns a 'U'
-- Uses booking_id to verify that a charge associated with this booking has been sentenced & disposed/ KJH	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_charge chg 
			     		
	WHERE	p_booking_id = chg.booking_id
			and (chg.charge_state = '6' and 
			chg.disposition_reason in ('005','1012','1014','1021','1022','1031','1035','1037','1038','1051','CTS', 'PS325'));     
     
v_status EPIC.eh_charge.charge_state%type;


BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_disposedate_max
	(	p_charge_id		in	EPIC.eh_charge_change.charge_id%type ) 
	
	
--Returns the max date the selected charge was disposed


RETURN		epicaudit.eh_charge_change.change_date%type
IS  
	CURSOR curDate IS
	
	select max(EPIC.ef_epic_date_to_date(cc.change_date)) 
	from EPIC.eh_charge_change cc
    where cc.charge_id = p_charge_id and cc.charge_event = '8'
   	group by EPIC.ef_epic_date_to_date(cc.change_date);    


vDate	epicaudit.eh_charge_change.change_date%type; 

BEGIN
	OPEN curDate;
		FETCH curDate INTO vDate;
	CLOSE curDate;
		

RETURN vDate;
	
END;
--MAZ
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_dispotype
	(p_charge_id				in		EPIC.eh_entity_person.entity_id%type) 
	
--Returns the reason for charge disposition
	
RETURN VARCHAR2
IS		v_dispo			EPIC.eh_charge.disposition_reason%type;

	CURSOR cur_dispo IS
		SELECT	c.disposition_reason	
		
		FROM	EPIC.eh_charge c
		
		WHERE 	c.charge_id = p_charge_id;
  
BEGIN
	OPEN cur_dispo;
		FETCH cur_dispo INTO v_dispo;
	CLOSE cur_dispo;
			
	RETURN EPIC.ef_lookup_text('DISPOSITION REASONS', v_dispo, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_DOB
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns an inmate's Date of Birth

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M. Zak		11/14/05		Modified in OTMAIN
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_DOB				EPIC.eh_person_identity.date_of_birth%type;

	CURSOR cur_DOB IS
		SELECT
			p.date_of_birth
		FROM
		 	EPIC.eh_person_identity p,
		 	EPIC.eh_entity_person ep  -- 8-19-05 MZak  added to resolve dob problem of multiple 'Master' inmate entries
		WHERE    
			p.entity_id =  p_entity_id
			and p.code_name_type = 'MAS'    --8-19-05 MZak
			and p.entity_id = ep.entity_id  --8-19-05 MZak
			and p.identity_id = ep.primary_identity_id;  --8-19-05 MZak
  
BEGIN
	OPEN cur_DOB;
		FETCH cur_DOB INTO v_DOB;
	 	CLOSE cur_DOB;	
			
RETURN EPIC.ef_epic_date_to_date(v_DOB);
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_DOB_gvt_format
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   
	
--Returns an inmate's Date of Birth in the MM/DD/YYYY format for the GVT file

RETURN VARCHAR2 AS

v_DOB				EPIC.eh_person_identity.date_of_birth%type;

	CURSOR cur_DOB IS
		SELECT
			p.date_of_birth
		FROM
		 	EPIC.eh_person_identity p
		WHERE    
			p.entity_id =  p_entity_id
			and p.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_DOB;
		FETCH cur_DOB INTO v_DOB;
	 	CLOSE cur_DOB;	
			
RETURN to_char(EPIC.ef_epic_date_to_date(v_DOB),'MM/DD/YYYY');
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_DrvChg
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)
		
--Returns the statute description for the Driving Charge (The charge with the most current outdate, then the highest bond amount,
--and then the charge entered into the system first)

RETURN		EPIC.epic_statutes.statute_description%type
IS

	CURSOR curDrvChg IS
		SELECT	mcmb_fnt_chargedesc(ch.statute_id),
				EPIC.ef_epic_date_to_date(od.unpaid_out_date) as ODate,
				MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as Bond,
				cha.action_time as ActionTime
				
		FROM	EPIC.eh_booking bk,
				EPIC.eh_charge ch,
				EPIC.eh_sentence_out_dates od,
				epicaudit.eh_charge cha
				
		WHERE	bk.entity_id = p_entity_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = od.sentence_id (+)
				and ch.charge_id = cha.charge_id
				and ch.charge_state <> '6'
				and not exists
					(select 1 from epicaudit.eh_charge cha2
					where cha.charge_id = cha2.charge_id
					and cha2.action_time < cha2.action_time)				  
					
		ORDER BY EPIC.ef_epic_date_to_date(ODate) desc, Bond desc, ActionTime asc;
	
	
	vChg	EPIC.epic_statutes.statute_description%type;
	vDate	EPIC.eh_sentence_out_dates.unpaid_out_date%type;
	vBond	EPIC.eh_bail_condition.cash_only_bail_amount%type;
	vTime	epicaudit.eh_charge.action_time%type;
	
	
BEGIN
	OPEN curDrvChg;
		FETCH curDrvChg INTO vChg, vDate, vBond, vTime;
	CLOSE curDrvChg;     	
RETURN vChg;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_DrvChgID
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)    

/*
Purpose: Returns the statute number for the Driving Charge (The charge with the most current outdate, 
		 then the highest bond amount, and then the charge entered into the system first)  

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	 		

RETURN		EPIC.eh_charge.charge_id%type
IS

	CURSOR curDrvChg IS
		SELECT	EPIC.ef_epic_date_to_date(od.unpaid_out_date) as ODate,
				MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as Bond,
				cha.action_time as ActionTime,
				ch.charge_id as ChargeID
				
		FROM	EPIC.eh_booking bk,
				EPIC.eh_charge ch,
				EPIC.eh_sentence_out_dates od,
				epicaudit.eh_charge cha
				
		WHERE	bk.entity_id = p_entity_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = od.sentence_id (+)
				and ch.charge_id = cha.charge_id 
				and ch.charge_state <> '6'
				and not exists
					(select 1 from epicaudit.eh_charge cha2
					where cha.charge_id = cha2.charge_id
					and EPIC.ef_epic_date_to_date(cha.action_time) < EPIC.ef_epic_date_to_date(cha2.action_time))			-- changed to chs vs. cha2	  
					
		ORDER BY ODate desc, Bond desc, ActionTime asc;
	
	
	vDate	EPIC.eh_sentence_out_dates.unpaid_out_date%type;
	vBond	EPIC.eh_bail_condition.cash_only_bail_amount%type;
	vTime	epicaudit.eh_charge.action_time%type; 
	vID		EPIC.eh_charge.charge_id%type;
	
	
BEGIN
	OPEN curDrvChg;
		FETCH curDrvChg INTO vDate, vBond, vTime, vID;
	CLOSE curDrvChg;
	
RETURN vID;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_drvlicense
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns an inmate's driver's license number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2 AS

v_lic		EPIC.eh_operators_license.drivers_license_number%type;

	CURSOR cur_lic IS
		SELECT
			l.drivers_license_number
		FROM
		 	EPIC.eh_operators_license l	
		WHERE    
			l.entity_id =  p_entity_id; 
  
BEGIN
	OPEN cur_lic;
		FETCH cur_lic INTO v_lic;
		CLOSE cur_lic;
			
RETURN v_lic;

END;
--RAS 
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_drvlicense_primary
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
--Returns an inmate's driver's license number
-- KJH Cloned drvlicense to add condition 'Primary_dl' 
	
RETURN VARCHAR2 AS

v_lic		EPIC.eh_operators_license.drivers_license_number%type;

	CURSOR cur_lic IS
		SELECT
			l.drivers_license_number
		FROM
		 	EPIC.eh_operators_license l	
		WHERE    
			l.entity_id =  p_entity_id; 
  
BEGIN
	OPEN cur_lic;
		FETCH cur_lic INTO v_lic;
		CLOSE cur_lic;
			
RETURN v_lic;

END;
--RAS 
/

CREATE OR REPLACE
function      mcmb_fnt_ef_location_count (	-- 1997-2003 Motorola
	p_location_id			in		EPIC.epic_locations.location_id%type,
	p_code_gender			in		EPIC.eh_entity_gender.code_gender%type)
return EPIC.epic_col_types.number_9%type
is 
-- THIS FUNCTION IS USED BY THE VACANT BED REPORT MAINFRAME 357 IT IS RENAMED	
-- AND SAVED HERE TO PREVENT MOTOROLA FROM CHANGING OR DELETING IT	
-- A. ZDYBEL 7/30/2004  
--
--	29 Dec 2003, K Crosser
--		Treat levels 2-4 specially for performance
--			If facility, count using EH_MUSTER directly.
--			If above, count by recursions to facilities under that level
--			If below facility, count using housing links
--
-- 	Cousar 5/24/01
-- 		1. Link to eh_entity_gender rather than use ep_entity_person.code_gender. (Why is the data duplicated ?)
--		2. Added the 3rd and 4th union clauses to account for inmates on count with no housing assignment.
-- 		(This situation should never happen under normal circumstances, but...)
-- 		3. Created a unique index on eh_housing_assignments entity_id, location_id and muster_display_flag to prevent table scan.
-- 		4. Created a unique index on eh_muster entity_id and code_gender to prevent table scan.
-- 		5. Rewrote the function to do 'select count where gender = parameter', rather than 'select all on count, then loop through
--		resultset and count all of a particular gender'.
--	26 Jan 2000, K Crosser
--		Return count of specified gender at the specified unit
--		If gender record not found, or 'U'nknown, add to Male count
--		If "p_code_gender" is null, returns total count for unit, regardless of gender
--	12 Sept 2000, D Mitchell
--		Change eh_unit_assignments to eh_housing_Assignments,
--		re-name to ef_man_count_Housing
--	12 Sept 2000, K Crosser
--		Return "count" of all offenders of specified gender at or below the specified
--		location
--	Used by RPT_PopCount_Proc
--
	cs_mod					constant varchar2(255) := 'ef_location_count';
	cbDebug					constant boolean := false;
	v_count					EPIC.epic_col_types.number_9%type;
	v_level					EPIC.epic_locations.location_level%type;
	v_parent_facility		EPIC.eh_muster.facility_id%type;
	v_gender				EPIC.eh_entity_gender.code_gender%type := null;
	--
	--	cursor to get level of passed in location
	--
	cursor cur_level is
		select location_level
		from EPIC.epic_locations
		where location_id = p_location_id;
	--
	--	cursor to get all level-4 locations (facilities)
	--		under the passed in location
	--
	cursor cur_child_facilities is
		select elc.child_location_id
		from EPIC.epic_location_child elc
		where elc.location_id = p_location_id
			and elc.child_location_level = 4;
	--
	--	cursor to get the parent facility of a location
	--
	cursor cur_parent_facility is
		select elc.location_id
		from EPIC.epic_location_child elc
		where elc.child_location_id = p_location_id
			and elc.location_level = 4;
	--
	--	cursor to count all persons of the specified gender at a facility
	--
	cursor cur_count_gender_facility (p_gender in EPIC.eh_entity_gender.code_gender%type) is
		select nvl(eg.code_gender, 'x') as theGender
		from
			EPIC.eh_muster em,
			EPIC.eh_entity_gender eg
		where
			em.facility_id = p_location_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = em.entity_id;
	--
	--	cursor to count all persons at a facility
	--
	cursor cur_count_all_facility is
		select count(*) as thecount
		from
			EPIC.eh_muster em
		where
			em.facility_id = p_location_id
			and em.in_muster_flag = 'Y';
	--
	--	cursor to count all persons of a specified gender at a location below a facility
	--
	cursor cur_count_gender_below (p_gender in EPIC.eh_entity_gender.code_gender%type) is
		--	count people housed at this location
		select nvl(eg.code_gender, 'x') as theGender
		from
			EPIC.eh_housing_assignments ha,
			EPIC.eh_muster em,
			EPIC.eh_entity_gender eg
		where
			em.facility_id = v_parent_facility
			and ha.location_id = p_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = ha.entity_id
		union all
		--	count people housed below this location
		select nvl(eg.code_gender, 'x') as theGender
		from
			EPIC.eh_housing_assignments ha,
			EPIC.epic_location_child elc,
			EPIC.eh_muster em,
			EPIC.eh_entity_gender eg
		where
			em.facility_id = v_parent_facility
			and elc.location_id = p_location_id
			and ha.location_id = elc.child_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = ha.entity_id;
	--
	--	cursor to count all persons at a location below a facility
	--
	cursor cur_count_all_below is
		--	count people housed at this location
		select count(*) as thecount
		from
			EPIC.eh_housing_assignments ha,
			EPIC.eh_muster em
		where
			em.facility_id = v_parent_facility
			and ha.location_id = p_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
		union all
		--	count people housed below this location
		select count(*) as thecount
		from
			EPIC.eh_housing_assignments ha,
			EPIC.epic_location_child elc,
			EPIC.eh_muster em
		where
			em.facility_id = v_parent_facility
			and elc.location_id = p_location_id
			and ha.location_id = elc.child_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y';
	--
	--	function to increment counter if this is the correct gender
	--
	procedure AddIfGender (
		p_result_gender		in	EPIC.eh_entity_gender.code_gender%type)
	is
	begin
		if v_gender = 'F' then
			--	if F, then must match
			if p_result_gender = v_gender then
				v_count := v_count + 1;
			end if;
		else
			--	if M, then anything other than F
			if p_result_gender <> 'F' then
				v_count := v_count + 1;
			end if;
		end if;
	end;
	--
	procedure logit(
		p_what			in		varchar2)
	is
	begin
		if cbDebug then
			dbms_output.put_line(p_what);
		end if;
	end;
begin
	v_count := 0;
	--
	--	determine level of location passed in
	--
	open cur_level;
	fetch cur_level into v_level;
	if cur_level%notfound then
		close cur_level;
		raise_application_error(-20001, 'Invalid location id [' || p_location_id || '] in ' || cs_mod);
	end if;
	close cur_level;
	--
	--	determine gender code
	--
	if upper(substr(p_code_gender,1,1)) = 'M' then
		v_gender := 'M';
	elsif upper(substr(p_code_gender,1,1)) = 'F' then
		v_gender := 'F';
	else
		v_gender := null;
	end if;
	--
	--
	if v_level = 4 then
		--	facility, use muster table directly
		if v_gender is null then
			open cur_count_all_facility;
			fetch cur_count_all_facility into v_count;
			if cur_count_all_facility%notfound then
				v_count := 0;
			end if;
			close cur_count_all_facility;
			logit(v_count || ' count all facility - ' || p_location_id);
		else
			for cur in cur_count_gender_facility(v_gender)
			loop
				AddIfGender(cur.theGender);
			end loop;
			logit(v_count || ' count gender facility - ' || p_location_id || ' - ' || v_gender);
		end if;
	elsif v_level < 4 then
		--	above facility, recursively call with the facilities to get the counts
		for cur in cur_child_facilities
		loop
			v_count := v_count + EPIC.ef_location_count(cur.child_location_id, p_code_gender);
		end loop;
		logit(v_count || ' count above facility - ' || p_location_id || ' - ' || p_code_gender);
	else
		--	below facility, use housing assignments
		open cur_parent_facility;
		fetch cur_parent_facility into v_parent_facility;
		if cur_parent_facility%notfound then
			close cur_parent_facility;
			raise_application_error(-20001, 'No parent facility for ' || p_location_id);
		end if;
		close cur_parent_facility;
		if v_gender is null then
			--		note - must loop this cursor, as 2 rows will be returned!
			for cur in cur_count_all_below
			loop
				v_count := v_count + cur.thecount;
			end loop;
			logit(v_count || ' count all below - ' || p_location_id);
		else
			for cur in cur_count_gender_below(v_gender)
			loop
				AddIfGender(cur.theGender);
			end loop;
			logit(v_count || ' count gender below - ' || p_location_id || ' - ' || v_gender);
		end if;
	end if;
	--
	--	done, return count
	--
	return v_count;
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_enddate_gvt
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   


	
RETURN VARCHAR2 AS

v_end_date				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_end_date IS
		select
			EPIC.ef_epic_date_to_date(bk.end_date)  
			from EPIC.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
		
  
BEGIN
	OPEN cur_end_date;
		FETCH cur_end_date INTO v_end_date;
	 	CLOSE cur_end_date;	
			
RETURN v_end_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_EntityStatus
	(p_entity_id		in		EPIC.eh_entity_status.entity_id%type) 

/*
Purpose: Returns the entity status of an inmate

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2 AS

v_Status	EPIC.eh_entity_status.code_entity_status%type;

	CURSOR cur_Status IS
		SELECT
			s.code_entity_status
		FROM
		 	EPIC.eh_entity_status s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_Status;
		FETCH cur_Status INTO v_Status;
	CLOSE cur_Status;
			
RETURN EPIC.ef_lookup_text('OFFENDER STATUS', v_Status, 'UC');

END; 
--RAS
/

CREATE OR REPLACE
function MCMB_FNT_entity_id (
	p_offender_id           in      EPIC.EH_OFFENDER_IDS.offender_id%type)
return EPIC.eh_entity_person.entity_id%type
is
--
--	15 Oct 1999, K Crosser
--		Function to return the offender's offender_id value
--
	v_id					EPIC.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select entity_id
		from EPIC.eh_offender_ids
		where offender_id = p_offender_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_entity_id ;
/

CREATE OR REPLACE
function MCMB_FNT_entity_id_frm_charge (
	p_charge_id           in      EPIC.EH_charge.charge_id%type)
return EPIC.eh_entity_person.entity_id%type
is
--
--	1/29/2006 J McBratnie
--		Function to return the offender's offender_id value
--
	v_id					EPIC.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select b.entity_id
		from EPIC.eh_charge c,
		     EPIC.eh_booking b
		where c.charge_id = p_charge_id
		  and c.booking_id = b.booking_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_entity_id_frm_charge ;
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_epic_DateDiff_Years 
		(in_dob 	in 	EPIC.eh_person_identity.date_of_birth%TYPE,
  		 in_date	in 	EPIC.eh_person_identity.date_of_birth%TYPE)
                         
/*
Purpose: Originally created with DOB in mind, but can be used for any two dates

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M. Zak		11/14/05		Created
				R. Stuve	4/12/06			Verified MACOMB/EPIC schema
*/

RETURN	 EPIC.epic_col_types.number_4%TYPE
IS
	out_age 	EPIC.epic_col_types.number_4%TYPE;
	work_indate	date;
	work_today	date;
	work_months	EPIC.epic_col_types.number_14%type;

BEGIN
	IF ltrim(in_dob) = ' ' OR in_dob IS NULL then
		out_age := 0;
	ELSE
		work_indate := to_date(substr(EPIC.date_extract(EPIC.epicdate(in_dob),' '),1,8),'yyyymmdd');
 		work_today  := to_date(substr(EPIC.date_extract(EPIC.epicdate(in_date),' '),1,8),'yyyymmdd');
		work_months := months_between(work_today,work_indate);
		out_age := floor(work_months / 12);
	END IF;
	
	
RETURN out_age;
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_eyecolorleft
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns an inmate's left eye color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_leye					EPIC.eh_entity_person.code_eye_color_left%type;

	CURSOR cur_leye IS
		SELECT
			p.code_eye_color_left
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_leye;
		FETCH cur_leye INTO v_leye;
			IF (cur_leye%notfound or v_leye = '_NOSP' or v_leye is null)THEN
				v_leye := 'XXX';
			END IF;	
	 CLOSE cur_leye;	
			
RETURN EPIC.ef_lookup_text('EYE COLOUR', v_leye, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_eyecolorright
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)    
	
/*
Purpose: Returns an inmate's right eye color code
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M Zak    	7-21-06			copy of mcmb_fnt_eyecolorleft but return code
*/

RETURN VARCHAR2 AS

v_reye					EPIC.eh_entity_person.code_eye_color_right%type;

	CURSOR cur_reye IS
		SELECT
			p.code_eye_color_right
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_reye;
		FETCH cur_reye INTO v_reye;
			IF (cur_reye%notfound or v_reye = '_NOSP' or v_reye is null) THEN
				v_reye := 'XXX';
			END IF;	
	 CLOSE cur_reye;	
			
RETURN v_reye;
END;

/

CREATE OR REPLACE
FUNCTION mcmb_fnt_FeePmtType
	 (p_acct_id 	in 		EPIC.eh_trans_distribution.trust_account_trans_id%TYPE) 
	 
--Returns a 'C' for County Booking Fees; returns an 'S' for State Booking fees for the seleted transaction
	 
RETURN VARCHAR2 AS
  CURSOR curAcct IS 
  	SELECT 	decode(d.gl_account_number,'502','C','503','S',to_char(d.gl_account_number)) as Fee -- added account number on fail JDM
  	
    FROM 	EPIC.eh_trans_distribution d
			     		
	WHERE	d.trust_account_trans_id = p_acct_id
	    and gl_account_number in ('502','503');  --Added line JDM
     
     
--v_Acct	eh_charge.charge_state%type;
v_Acct varchar2(3);  -- changed the datatype and size JDM

BEGIN

  	OPEN curAcct;
  		FETCH curAcct INTO v_Acct;
  	CLOSE curAcct;
	
  	RETURN v_Acct;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_FeePmtType_jdm
	 (p_acct_id 	in 		EPIC.eh_trans_distribution.trust_account_trans_id%TYPE) 
	 
--Returns a 'C' for County Booking Fees; returns an 'S' for State Booking fees for the seleted transaction
	 
RETURN VARCHAR2 AS
  CURSOR curAcct IS 
  	SELECT 	decode(d.gl_account_number,'502','C','503','S',to_char(d.gl_account_number)) as Fee -- added account number on fail JDM
  	
    FROM 	EPIC.eh_trans_distribution d
			     		
	WHERE	d.trust_account_trans_id = p_acct_id
	    and gl_account_number in ('502','503');  --Added line JDM
     
     
--v_Acct	eh_charge.charge_state%type;
v_Acct varchar2(3);  -- changed the datatype and size JDM

BEGIN

  	OPEN curAcct;
  		FETCH curAcct INTO v_Acct;
  	CLOSE curAcct;
	
  	RETURN v_Acct;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_FelMisd
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*	
Purpose:		Returns a 'F' flag if the selected charge is a felony; a 'M' flag if the selected charge is a misdemeanor
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 	 
	 
RETURN  EPIC.epic_col_types.varchar_255%type AS

VFM		EPIC.epic_col_types.varchar_255%type;

  CURSOR curFM IS 
  	SELECT 	decode(es.code_statute_class,'FEL','F','MIS','M')
  	
	FROM 	EPIC.epic_statutes es,
			EPIC.eh_charge c
	
	WHERE	es. statute_id = c.statute_id
			and c.charge_id = p_charge_id;


BEGIN
  	OPEN curFM;
  		FETCH curFM INTO vFM;
  	CLOSE curFM;

RETURN vFM;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_FelMisdBk
	 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'F' flag if the selected charge is a felony; a 'M' flag if the selected charge is a misdemeanor

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN EPIC.epic_col_types.varchar_255%type AS
vFM					EPIC.epic_col_types.varchar_255%type;

  CURSOR curFM IS 
  	SELECT 	decode(es.code_statute_class,'FEL','F','MIS','M')
  	
	FROM 	EPIC.epic_statutes es,
			EPIC.eh_charge c,
			EPIC.eh_booking b
	
	WHERE	es. statute_id = c.statute_id
			and c.booking_id = b.booking_id
			and b.booking_id = p_booking_id;


BEGIN
  	OPEN curFM;
  		FETCH curFM INTO vFM;
  	CLOSE curFM;

RETURN vFM;
  	 	
END;
--RAS
/

CREATE OR REPLACE
function mcmb_fnt_file_date (
 epic_date EPIC.eh_entity_person.action_time%type
)

return string
is
begin
  return to_number(substr(epic_date,1,8),'YYYYMMDDHH24:MI:SS') + to_number(substr(epic_date,17,20))/1440;
exception
 when others then
  return to_date('18000101','YYYYMMDD');
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_FineAmount
	 (p_sentence_id 	in 	EPIC.eh_sentence.sentence_id%TYPE) 

/*
Purpose: Returns the fine amount attached to the selected sentence

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curFine IS 
  	SELECT 	f.fine_amount
  	
	FROM 	EPIC.eh_sentence_fine f
			
	WHERE	f.sentence_id = p_sentence_id;
     
     
vFine	 EPIC.eh_sentence_fine.fine_amount%TYPE;


BEGIN
  	OPEN curFine;
  		FETCH curFine INTO vFine;
  	CLOSE curFine;

RETURN NVL (vFine, 0);
  	 	
END; 
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_gendershort 
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns the first character of an inmate's gender

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_gender					EPIC.eh_entity_gender.code_gender%type;

	CURSOR cur_gender IS
		SELECT
			g.code_gender
		FROM
		 	EPIC.eh_entity_gender g	
		WHERE    
			g.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_gender;
		FETCH cur_gender INTO v_gender;
			IF cur_gender%notfound THEN
				v_gender :='U';
			END IF;	
	 CLOSE cur_gender;	
			
RETURN v_gender;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_get_attrID
	(p_offender_id		in		EPIC.eh_offender_ids.offender_id%type,
	 p_attribute_name   in      EPIC.eh_generic_attribute.attribute_name%type)

--Returns the attribute ID from the eh_generic_attribute table.
--Added attribute name into the IN list

RETURN VARCHAR2 AS

v_attrID		EPIC.eh_generic_attribute.attribute_id%type;

	CURSOR cur_attrID IS
		SELECT
			ga.attribute_id
		FROM
		 	EPIC.eh_generic_attribute ga,
		 	EPIC.eh_offender_ids oi,
		 	EPIC.eh_trust_account ta

		WHERE
			p_offender_id = oi.offender_id and
			ta.entity_id = oi.entity_id and
			ga.item_id = ta.trust_account_id and 
			ga.attribute_name = p_attribute_name;

BEGIN
	OPEN cur_attrID;
		FETCH cur_attrID INTO v_attrID;
		CLOSE cur_attrID;

RETURN v_attrID;

END;

/

CREATE OR REPLACE
function MCMB_FNT_get_EntityId_frm_Trst (
	p_trust_account_id		in		EPIC.EH_Chart_of_Accounts.trust_account_id%type
)
return EPIC.EH_TRUST_ACCOUNT.entity_id%type
is
          --<JDM note the mutating error you were getting was related to the fact that you were 
          --     changing the same data that was queued to be updates hence calling the tristter
          --     a second, third, fourth time.  I updated this to pull back the entity_id as we
          --     talked about.

	cursor curTrust is
		select ENTITY_ID
		from EPIC.EH_TRUST_ACCOUNT
		where trust_account_id = p_trust_account_id;

v_entity_Id	              EPIC.EH_TRUST_ACCOUNT.entity_id%type;

begin

	open curTrust;
	fetch curtrust into v_entity_id;
	close curTrust;

	return v_entity_id;
end;
/

CREATE OR REPLACE
function MCMB_FNT_get_entity_id (
	p_offender_id		in		EPIC.EH_OFFENDER_IDS.offender_id%type
)
return EPIC.EH_OFFENDER_IDS.entity_id%type
is


	cursor curOffenderID is
		select i.entity_id
		from EPIC.EH_OFFENDER_IDS i
		where i.offender_id = p_offender_id;

		v_entity_id	    EPIC.EH_OFFENDER_IDS.entity_id%type;

begin

	open curOffenderID;
	fetch curOffenderID into v_entity_id;
	close curOffenderID;

	return v_entity_id;
end;
/

CREATE OR REPLACE
function MCMB_fnt_Get_PersonName
      (in_entity_id_s    in	EPIC.EH_ENTITY.ENTITY_ID%type)
       return	EPIC.epic_col_types.varchar_255%type
is
--
-- given an entity_id, determines if it belongs to a person or organization
-- and returns the entity's name
--
	p_name			EPIC.epic_col_types.varchar_255%type;
	p_entity_id		EPIC.eh_entity.entity_id%type;
	p_last			EPIC.eh_person_identity.name_family%type;
	p_first			EPIC.eh_person_identity.name_first%type;
	p_middle		EPIC.eh_person_identity.name_other%type;
	p_suffix		EPIC.eh_person_identity.name_suffix%type;
cursor cur_person_name is
	 select	name_family, name_first
	 from	EPIC.eh_person_identity pi, EPIC.eh_entity_person ep
	 where	ep.entity_id = p_entity_id
	 and	pi.identity_id = ep.primary_identity_id;
	p_person_name	cur_person_name%rowtype;
begin
	p_entity_id := in_entity_id_s;
		open cur_person_name;
		fetch cur_person_name into p_person_name;
		if cur_person_name%notfound then
			close cur_person_name;
			return	null;
		end if;
		p_last := rtrim(p_person_name.name_family);
		if length(p_last) > 0 then
			p_name := p_last || ', ';
		end if;
		p_first 	:= rtrim(p_person_name.name_first);
		p_name := p_name || p_first;
		close cur_person_name;
   return p_name;
end;
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_get_SentenceID
	(p_book_id	 in		epic.eh_booking.booking_id%type)   
 --Returns the sentence_ID 
                                                                         
RETURN VARCHAR2 AS

v_sentID				epic.eh_sentence.sentence_ID%type;

	CURSOR cur_sentID IS
		select
			chg.sentence_id  
			from 
			epic.eh_charge chg
			where chg.booking_id = p_book_id;
  
BEGIN
	OPEN cur_sentID;
		FETCH cur_sentID INTO v_sentID;
	 	CLOSE cur_sentID;	
			
RETURN v_sentID;
END;
--KJH
/

CREATE OR REPLACE
function MCMB_FNT_get_trust_account_id (
	p_entity_id           in      EPIC.eh_offender_ids.entity_id%type)
return EPIC.eh_entity_person.entity_id%type
is
--
--	12/7/2005 J Mcbratnie
--		Function to return the offender's trust account
--
	v_id					EPIC.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select trust_account_id
		from EPIC.eh_trust_account
		where entity_id =  p_entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_get_trust_account_id ;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_gvt_days
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)   
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH
-- Select MAX eh_charge.action_time to get latest disposed charge, with proper disposition reason
-- Modification made on 12/12/05 as instructed by Sgt. Roberts and Capt. Roberts kjh

RETURN VARCHAR2 AS
v_days		EPIC.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT  
			ABS(EPIC.ef_epic_date_diff(book.start_date,MAX(chg.action_time)))+ 1-- Plus 1 per Lori
		FROM
		 	EPIC.eh_booking book,
		 	EPIC.eh_charge chg
		WHERE
			p_booking_id = book.booking_id
			and book.booking_id = chg.booking_id
			and book.booking_state = '3'
			and chg.charge_state = '6'  
			and chg.disposition_reason in  
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV')
			GROUP by EPIC.ef_epic_date_to_date(BOOK.START_DATE);      
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_gvt_days_fix
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)
-- To create the GVt Fix file for missing 001 Dispo's to be charged room and board   
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH
-- Select MAX eh_charge.action_time to get latest disposed charge, with proper disposition reason
-- Modification made on 12/12/05 as instructed by Sgt. Roberts and Capt. Roberts kjh

RETURN VARCHAR2 AS
v_days		EPIC.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT  
			ABS(EPIC.ef_epic_date_diff(book.start_date,max(chg.action_time)))+ 1-- Plus 1 per Lori
		FROM
		 	EPIC.eh_booking book,
		 	EPIC.eh_charge chg
		WHERE
			p_booking_id = book.booking_id
			and book.booking_id = chg.booking_id
			and book.booking_state = '3'
			and chg.charge_state = '6'  
			and (chg.disposition_reason = '001' and
			chg.disposition_reason not in 
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV'))
			group by EPIC.ef_epic_date_to_date(book.start_date);      
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_gvt_days_original
	(p_booking_id	in		epic.eh_booking.booking_id%type)   
	
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH

RETURN VARCHAR2 AS
v_days		epic.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT
			ABS((EPIC.ef_epic_date_diff(book.start_date, book.end_date))+ 1)-- Plus 1 per Lori
		FROM
		 	EPIC.eh_booking book
		 	
		WHERE
			book.booking_id =  p_booking_id
			and book.booking_state = '3';
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_haircolor 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)  
	
/*
Purpose: Returns an inmate's hair color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2 AS

v_hair		EPIC.eh_person_snapshot.code_hair_color%type;

	CURSOR cur_hair IS
		SELECT
			s.code_hair_color
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_hair;
		FETCH cur_hair INTO v_hair;
	CLOSE cur_hair;
			
RETURN EPIC.ef_lookup_text('HAIR COLOUR', v_hair, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_height 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 
	
--Returns an inmate's height	
	
RETURN VARCHAR2 AS

v_height 	EPIC.eh_entity_height.height%type;

	CURSOR cur_height IS
		SELECT
			h.height
		FROM
		 	EPIC.eh_entity_height h
		WHERE    
			h.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_height;
		FETCH cur_height INTO v_height;
	CLOSE cur_height;
			
RETURN v_height;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_HoldAgy
	 (p_booking_id 	in 	EPIC.eh_booking.booking_id%TYPE) 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT 	h.agency_id 
  	
	FROM 	EPIC.eh_booking_holds h
			
	WHERE	h.booking_id = p_booking_id;
     
     
vAgy	 EPIC.eh_booking_holds.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  	FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN EPIC.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Holds
	 (p_entity_id 	IN 	EPIC.eh_active_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate has any active holds

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curHold IS 
  	SELECT 	'Y' 
  	
	FROM 	EPIC.eh_booking_holds h,
			EPIC.eh_active_booking ab
			
	WHERE	h.booking_id = ab.booking_id
			and (EPIC.ef_epic_date_to_date(h.hold_removed_date)  is null
				or EPIC.ef_epic_date_to_date(h.hold_removed_date) > sysdate)
			and ab.entity_id = p_entity_id;
     
     
v_hold EPIC.    eh_charge.charge_state%type;


BEGIN
	-- Look for any hold for this inmate that is current:  
  	OPEN curHold;
  		FETCH curHold INTO v_hold;
  	CLOSE curHold;
	
-- If we found a hold, 'v_hold' will be set to 'Y', if not return 'N'
RETURN NVL (v_hold,'N');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_hold_amt
	(	p_HoldID	in	EPIC.eh_booking_holds.hold_id%TYPE)

/*	
	Purpose:		Returns the value of the 'HOLD AMOUNT' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
		    EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD AMOUNT'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_hold_Total_Amount
	 (p_booking_id 	in 	EPIC.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total hold amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/12/06       created
					DLK          03/08/06       ADDED THE EPIC NOTATION
*/  	 
RETURN VARCHAR2
IS  
	CURSOR cur_Hold IS
	SELECT h.booking_id, sum(to_number(g.attribute_value))
	FROM   EPIC.eh_generic_attribute g,
		   EPIC.eh_booking_holds h	
	WHERE  g.attribute_name = 'HOLD AMOUNT'
	  and  g.item_id = h.hold_id
	  and  h.booking_id = p_booking_id
 group by  h.booking_id;

vhold	   number;
vbook      EPIC.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN	
	OPEN cur_Hold;
		FETCH cur_Hold into vbook, vhold;
	CLOSE cur_Hold;

RETURN vhold;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_hold_warrant
	(p_hold_id	in	EPIC.eh_booking_holds.hold_id%type)
	
/*
Purpose: Returns the hold warrant number for the selected hold
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2
IS  v_holdamt			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_Hold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD WARRANT NUMBER'
			and g.item_id = h.hold_id
			and h.hold_id = p_hold_id;

BEGIN	
	OPEN cur_Hold;
		FETCH cur_Hold into v_holdamt;
	CLOSE cur_Hold;

RETURN v_holdamt;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_inmatefunds
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE) 
	
/*
Purpose: Returns the current balance of an inmate's trust account

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN EPIC.eh_chart_of_accounts.total_debits%TYPE

IS
vBalance	EPIC.eh_chart_of_accounts.total_debits%TYPE; 
vCommit		EPIC.eh_chart_of_accounts.total_debits%TYPE;

	CURSOR curFunds IS
 select
     decode(ca1.total_debits,null,0,ca1.total_debits) - decode(ca1.total_credits,null,0,ca1.total_credits) curbal,
     (decode(ca3.total_debits,null,0,ca3.total_debits) + decode(ca4.total_debits,null,0,ca4.total_debits)) -
     (decode(ca3.total_credits, null,0,ca3.total_credits) + decode(ca4.total_credits, null,0,ca4.total_credits)) curCommit
 from
     EPIC.eh_trust_account ta,
     EPIC.eh_chart_of_accounts ca1,
     EPIC.eh_chart_of_accounts ca3,
     EPIC.eh_chart_of_accounts ca4
 where
     ta.entity_id = p_entity_id
     and ta.code_status <> 'CLOSED'
     and ca1.trust_account_id (+) = ta.trust_account_id
         and (ca1.gl_account_number (+) = '110')
     and ca3.trust_account_id (+) = ta.trust_account_id
         and (ca3.gl_account_number (+) = '210')
     and ca4.trust_account_id (+) = ta.trust_account_id
         and (ca4.gl_account_number (+) = '220');


	
BEGIN

	OPEN curFunds;
		FETCH curFunds INTO vBalance, vCommit;
	CLOSE curFunds;
	
RETURN NVL ((vBalance + vCommit), 0);
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_inmatestatus
	(	p_charge_id		in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the Inmate Status based on the selected charge (queries against the 'Custody Status' 
		 or the 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				AND p_charge_id = g.item_id;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_inmatestatusb
	(	p_booking_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on the selected booking id (queries against the 'Custody Status' 
		 or the 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
				EPIC.eh_charge c 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				AND c.charge_id = g.item_id
				and c.booking_id = p_booking_id
	
		ORDER BY c.index_number;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_inmatestatus_sent
	(	p_charge_id		in	EPIC.eh_charge.charge_id%type)   
	
--For testing purposes (not currently used)

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g 
		
		WHERE 	g.attribute_name = 'CHARGE STATUS'
				AND p_charge_id = g.item_id
				AND g.attribute_value = '7';

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
PROCEDURE mcmb_fnt_inmate_his_alert  (
          vCur OUT EPIC.epp_generic_ref_cursor.ref_cursor
			)
	is
	

	BEGIN

	OPEN vCur FOR
 	  SELECT  
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
		' ' as ActiveAlert
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
		EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		substr(epi.social_security_number, 4, 2) || '-'
		|| substr(epi.social_security_number, 6, 4) as SSN,
	    ea.alert_type as ActiveAlert

	    FROM
                EPIC.eh_housing_assignments ha,
				EPIC.eh_active_booking ab,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				-- added for alerts
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				--added for Active Alerts
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
				
 	  
            ;
                
    END mcmb_fnt_inmate_his_alert;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_InmChrgStat
	(	p_Entity_id		in	EPIC.eh_active_booking.entity_id%type,
	    p_ChargeStatus  in  EPIC.eh_generic_attribute.attribute_value%type) 

/*
Purpose: Returns the 'Y' if Inmate is found with given charge status

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
		
RETURN VARCHAR2 AS
  CURSOR curStat IS 
  	SELECT 	'Y' 
  	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c 
			
	WHERE	 ab.entity_id = p_Entity_id  --'0IHULDPEG0XD3MIG'
		         and ab.booking_id = c.booking_id
		         and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = p_ChargeStatus  --'PRE-ARRAIGNMENT DISTRICT'		
		         and c.charge_state != 6;    --don't show disposed charges
    
v_stat EPIC.eh_charge.charge_state%type;

BEGIN
  	OPEN curStat;
  		FETCH curStat INTO v_stat;
  	CLOSE curStat;
	
-- If we found an active inmate with the given charge status then return Y  else null
RETURN NVL (v_stat, null);

  	 	
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_interface_lastrun
	(p_name	in		EPIC.eh_interface_request.interface_name%type)   
	
--Returns the last date_submitted from the eh_interface_request table using the interface_name input param
RETURN VARCHAR2 AS

v_last_date				EPIC.eh_interface_request.date_submitted%type;

	CURSOR cur_last_date IS
		select
			max(EPIC.ef_epic_date_to_date(req.date_submitted))  
			from EPIC.eh_interface_request req
			where req.interface_name = p_name
            AND req.code_request_status = 'COMPLETED';
BEGIN
	OPEN cur_last_date;
		FETCH cur_last_date INTO v_last_date;
	CLOSE cur_last_date;	
			
RETURN v_last_date;
END;
--KJH
  
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Interview
	 (p_booking_id	IN 	EPIC.eh_active_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate still needs to have a classification interview;
		 returns a null if the interview has been completed

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curInt IS 
  	SELECT 	'I' 
  	
  	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_security_classification sc,
			EPIC.eh_generic_attribute g
	
	WHERE	ab.booking_id = sc.booking_id
			AND sc.classification <> '00' --not classified
			AND ab.booking_id = g.item_id
			AND g.attribute_name = 'NEEDS CLASSIFICATION INTERVIEW'
			AND g.attribute_value = 'Y'
			and ab.booking_id = p_booking_id;
     
     
v_int 	EPIC.eh_charge.charge_state%type;


BEGIN
	OPEN curInt;
  		FETCH curInt INTO v_int;
  	CLOSE curInt;
	
-- If classification interview value = YES, 'v_int' will be set to 'Y', if not return a null value
RETURN NVL (v_int, '');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_JudgeName
	 (p_booking_id 	in 	EPIC.eh_booking.booking_id%TYPE)  
	 
--This was for testing and is not valid
	 
RETURN VARCHAR2 AS
  CURSOR curJudge IS 
  	SELECT 	ca.judge_name
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c
			
	WHERE	ca.owner_id = c.case_id
			and c.booking_id = p_booking_id;
     
     
vJudge	 EPIC.eh_court_appearance.judge_name%TYPE;


BEGIN
  	OPEN curJudge;
  		FETCH curJudge INTO vJudge;
  	CLOSE curJudge;

RETURN vJudge;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_JudgeName_ChargeID
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the Judge's name related to the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 

	 
RETURN VARCHAR2 AS
  CURSOR curJudge IS 
  	SELECT 	ca.judge_name
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc,
			EPIC.eh_charge ch
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = ch.charge_id
			and ch.charge_id = p_charge_id;
     
     
vJudge	 EPIC.eh_court_appearance.judge_name%TYPE;


BEGIN
  	OPEN curJudge;
  		FETCH curJudge INTO vJudge;
  	CLOSE curJudge;

RETURN vJudge;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_JuvFlag
	 (p_entity_id	 IN EPIC.eh_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if the inmate has the juvenile flag; returns a 'N' flag otherwise 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curJuv IS   	
  	SELECT 	decode(ep.juvenile_flag, null, 'N', ep.juvenile_flag)

    FROM 	EPIC.eh_entity_person ep

	WHERE	ep.entity_id = p_entity_id;	
     
    
v_Juv	EPIC.eh_entity_person.juvenile_flag%type;


BEGIN
	OPEN curJuv;
  		FETCH curJuv INTO v_Juv;
  	CLOSE curJuv;
  	
  	RETURN  v_juv;
  		
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_KeepSep
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)  

/*
Purpose: Returns the name and cell of the Keep Seperate inmates from the selected inmate

	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		

RETURN		varchar2
IS

	CURSOR curKeepSep IS
	SELECT	EPIC.ef_offender_id(ks.origin_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as IName,
			EPIC.ef_offender_cell(ks.origin_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
	    	and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.origin_entity_id = p_entity_id

UNION ALL
 	SELECT	EPIC.ef_offender_id(ks.separate_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.separate_entity_id) as IName,
			EPIC.ef_offender_cell(ks.separate_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
			and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.separate_entity_id = p_entity_id;
	
vName EPIC.epic_col_types.VARCHAR_2000%type;

BEGIN
	vName := null;
		FOR a IN curKeepSep
			LOOP vName := vName || a.IName || ' (' || a.ICell || ')' || ' / ';
			END LOOP;
		RETURN vName;
END;  
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_legal_jdgmt_flg
	(p_entity_id		in		EPIC.eh_trust_account.entity_id%type)
	
/*
Purpose: Returns the (ATTRIBUTE_NAME) from EH_GENERIC_ATTRIBUTE table when the 'LEGAL JUDGEMENT FLAG' attribute is the True flag = y
		 Adds the legal judgement flag to the Alpha Primary report for Lori's use (01/06/06 dlk)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS

v_attrName					EPIC.eh_generic_attribute.attribute_name%type;

	CURSOR cur_attrName IS
		SELECT
			ga.attribute_name
			
		FROM
		 	EPIC.eh_generic_attribute ga,
		 	EPIC.eh_trust_account ta
		 	
		WHERE
			p_entity_id = ta.entity_id 
			and ga.item_id = ta.trust_account_id				
		    and (ga.attribute_name = 'LEGAL JUDGEMENT FLAG' 
		    and ga.attribute_value = 'Y');
  
BEGIN
	OPEN cur_attrName;
		FETCH cur_attrName INTO v_attrName;
		CLOSE cur_attrName;
			
RETURN v_attrName;

END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_MDOC
	 (p_entity_id 	IN 	EPIC.eh_person_identity.entity_id%TYPE)  

/*
Purpose: Returns the MDOC number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curID IS 
  	SELECT	o.state_id
	
	FROM	EPIC.eh_offender_ids o
	
	WHERE	o.entity_id = p_entity_id;	
     
v_ID EPIC.eh_offender_ids.state_id%TYPE;

BEGIN
  	OPEN curID;
  		FETCH curID INTO v_ID;
  	CLOSE curID;

RETURN v_ID; 
	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_MultipleCharges
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE)  

/*	
Purpose:		Returns a 'Y' flag if an inmate has multiple charges

Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/  	 

RETURN VARCHAR2 AS
  CURSOR curCharge IS   	
  	SELECT 	decode(count(c.charge_id), 1, NULL, 'Y')

    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
			and c.charge_state <> '6'
			--includes all charges that aren't disposed (including unitialized charges)
			and b.entity_id = p_entity_id
			
	GROUP BY	b.booking_id;		
     
     
v_count         EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for all active charges for an inmate (per the criteria above):
  	OPEN curCharge;
  		FETCH curCharge INTO v_count;
  	CLOSE curCharge;
	
-- If we found more than one active charge, 'v_count' will be set to 'Y', if not returns a Null
RETURN v_count;
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_NameFirstLast
	 (p_entity_id 	in 	EPIC.eh_person_identity.identity_id%TYPE)  
	 
RETURN VARCHAR2 AS
  CURSOR curName IS 
  	SELECT 	pi.name_first || ' ' || pi.name_family
  	
	FROM 	EPIC.eh_person_identity pi
			
	WHERE	pi.entity_id = p_entity_id;
     
     
vName	 EPIC.epic_col_types.varchar_255%type;


BEGIN
  	OPEN curName;
  		FETCH curName INTO vName;
  	CLOSE curName;

RETURN vName;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Name_Delimited_gvt
      (in_entity_id_s    in	     EPIC.eh_entity.entity_id%type)


RETURN	EPIC.epic_col_types.varchar_255%type
IS

/*
Purpose: Returns the entity's name based on an entity_id

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	4/11/06			Verified MACOMB/EPIC schema
*/

	p_name			EPIC.epic_col_types.varchar_255%type;
	p_entity_id		EPIC.eh_entity.entity_id%type;
	p_last			EPIC.eh_person_identity.name_family%type;
	p_first			EPIC.eh_person_identity.name_first%type;
	p_middle		EPIC.eh_person_identity.name_other%type;
	
cursor cur_person_name is
	 select	name_family, name_first, name_other
	 from	EPIC.eh_person_identity pi, EPIC.eh_entity_person ep
	 where	ep.entity_id = p_entity_id
	 and	pi.identity_id = ep.primary_identity_id;
	 --following line removed 12/9/05 per Sgt.Roberts as data was not getting updated properly, primary_identity more important than master name.
	 --and    pi.code_name_type = 'MAS';
 p_person_name	cur_person_name%rowtype;

begin
	p_entity_id := in_entity_id_s;
	
		open cur_person_name;
		fetch cur_person_name into p_person_name;
		if cur_person_name%notfound then
			close cur_person_name;
			return	null;
		end if;
		p_last := rtrim(p_person_name.name_family);
		if length(p_last) > 0 then
			p_name := p_last || '",';
		end if;
		p_first 	:= rtrim(p_person_name.name_first);
		p_middle	:= rtrim(p_person_name.name_other);
		p_name :=  p_name || '"' || p_first || '","' || p_middle ;
		close cur_person_name;
	        			
   return p_name;
end;
/

CREATE OR REPLACE
function MCMB_FNT_offenderidfromBK (
	p_booking_id				in		EPIC.eh_booking.booking_id%type)
return EPIC.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's offender_id value from Booking_ID
--
	v_id					EPIC.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select i.offender_id
		from   EPIC.eh_offender_ids i,
		       EPIC.eh_booking b
		where  b.booking_id = p_booking_id
		  and  b.entity_id = i.entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MCMB_FNT_offenderidfromCG (
	p_charge_id				in		EPIC.eh_charge.charge_id%type)
return EPIC.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's offender_id value from Charge_ID
--
	v_id					EPIC.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select i.offender_id
		from   EPIC.eh_offender_ids i,
		       EPIC.eh_booking b,
		       EPIC.eh_charge c
		where  c.charge_id = p_charge_id
		  and  b.booking_id = c.booking_id
		  and  b.entity_id = i.entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MCMB_FNT_OffenderidFromVeh (
	p_entity_id				in		EPIC.eh_vehicle.entity_id%type)
return EPIC.eh_offender_ids.offender_id%type
is
--
--	<JDM  1-28-2006
--		Function to return the offender's offender_id value from the vehicle entity_id
--                  NOTE the vehicle entity_id is the booding incident entity_id
--
	v_id					EPIC.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select id.offender_id
		from   EPIC.EH_ENTITY_ARREST_INCIDENT a,
			   EPIC.eh_booking b,
			   EPIC.EH_OFFENDER_IDS id
        where  a.incident_id = p_entity_id
          and  id.entity_id = b.entity_id
          and  b.booking_id = a.booking_id;
          
begin
	open cur_id;
	fetch cur_id into v_id;
--	if cur_id%notfound then
--		v_id := ' ';
--	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MCMB_FNT_Offender_Gender 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 

/*
Purpose: Returns the full text (Male, Female, Unknown) of an inmate's gender
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

return EPIC.epic_col_types.varchar_255%type
is

	v_gender					EPIC.epic_col_types.varchar_255%type;
	
	cursor cur_gender is
		select
			rtrim(EPIC.ef_lookup_text('SEX', eg.code_gender, ''))
		from EPIC.EH_ENTITY_GENDER eg
		where entity_id = p_entity_id;
begin
	open cur_gender;
	fetch cur_gender into v_gender;
	if cur_gender%notfound then
		v_gender :='UNKNOWN '; 
	end if;
	close cur_gender;
	return v_gender;
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_percentbail
	(p_charge_id	in	EPIC.eh_charge.charge_id%type)

/*
Purpose: Returns a Y/N flag if an inmate's bond qualifies/doesn't qualify for the 10% attribute
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2
IS  v_bail			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_bail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = '10 PERCENT BOND'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_charge_id;
			
		
			
		

BEGIN	
	OPEN cur_bail;
		FETCH cur_bail into v_bail;
	CLOSE cur_bail;

RETURN NVL (v_bail, 'N');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_perdispo --backup
	(	p_case_id	in	EPIC.eh_case.case_id%type) 
	
--Written for testing purposes (not currently used)
		
RETURN VARCHAR2
IS  v_Dispo			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR curDispo IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case c
			
		WHERE 
			g.attribute_name = 'PER DISPO'
			and g.item_id = ca.court_appearance_id
			and ca.owner_id = c.case_id
			and c.case_id = p_case_id ;

BEGIN	

	OPEN curDispo;
		FETCH curDispo into v_Dispo;
	CLOSE curDispo;
		
	RETURN v_Dispo;

	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_phone_base_primary
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	

--Returns the base numbers of an inmate's most current telephone number
-- KJH, cloned telelphone_base to add 'Primary' condition
RETURN VARCHAR2 AS

v_phone		EPIC.eh_telephone_records.base_number%type;

	CURSOR cur_phone IS
		SELECT
			t.base_number
		FROM
		 	EPIC.eh_telephone_records t,
		 	EPIC.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			and (t.primary_flag = 'Y' or t.primary_flag = ' ')
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_phone;
		FETCH cur_phone INTO v_phone;
	CLOSE cur_phone;
			
RETURN v_phone;

END;
 --KJH
/

CREATE OR REPLACE
function mcmb_fnt_phone_per_address (
	p_entity_id				in		EPIC.eh_entity_person.entity_id%type,
	p_address_id			in		EPIC.eh_address.address_id%type)
return EPIC.epic_col_types.varchar_255%type
is
--
--		17 Feb 2003, K Crosser
--			Return a formatted phone number for a person
--			If address is specified, may be used as well...
--		If the person has a primary phone, return that
--			else if the address has a primary phone, return that
--			else return most recent active phone for person
--			else return most recent active phone for address
--
	v_result						EPIC.epic_col_types.varchar_255%type := null;
	vNow							EPIC.eh_telephone_records.date_from%type;
	cursor cur_person_phone is
		select
			primary_flag, code_country, area_code, base_number, extension
		from
			EPIC.eh_telephone_records etr
		where
			etr.entity_id = p_entity_id
			and (etr.date_to is null or etr.date_to > vNow)
		order by
			decode(primary_flag, 'Y', 1, 2),
			nvl(etr.date_to, '2999') desc;
	--
	v_person_phone_rec				cur_person_phone%rowtype;
	--
	cursor cur_address_phone is
		select
			primary_flag, code_country, area_code, base_number, extension
		from
			EPIC.eh_address_phone_number eapn,
			EPIC.eh_telephone_records etr
		where
			eapn.address_id = p_address_id
			and etr.telephone_record_id = eapn.telephone_record_id
			and (etr.date_to is null or etr.date_to > vNow)
		order by
			decode(primary_flag, 'Y', 1, 2),
			nvl(etr.date_to, '2999') desc;
	--
	v_address_phone_rec				cur_address_phone%rowtype;
	--
	function NicePhone (
		p_country			in		EPIC.eh_telephone_records.code_country%type,
		p_area				in		EPIC.eh_telephone_records.area_code%type,
		p_base				in		EPIC.eh_telephone_records.base_number%type,
		p_ext				in		EPIC.eh_telephone_records.extension%type)
	return varchar2
	is
		vNumber						varchar2(255) := null;
		vUS							boolean := true;
	begin
		begin
			--	ignore country code errors...
			if p_country is not null then
				if to_number(p_country) <> 1 then
					vUS := false;
					vNumber := '+' || to_number(p_country) || ' ';
				end if;
			end if;
		exception
			when others then
				null;
		end;
		if p_area is not null then
			vNumber := vNumber || '(' || p_area || ') ';
		end if;
		if vUS then
			vNumber := vNumber || substr(p_base, 1, 3) || '-' || substr(p_base, 4, 255);
		else
			vNumber := vNumber || p_base;
		end if;
		if p_ext is not null then
			vNumber := vNumber || ' x' || p_ext;
		end if;
		return vNumber;
	end;
begin
	vNow := EPIC.epicdatenow;
	--	get person's primary (and others)
	open cur_person_phone;
	fetch cur_person_phone into v_person_phone_rec;
	if cur_person_phone%found then
		if v_person_phone_rec.primary_flag = 'Y' then
			v_result := NicePhone(v_person_phone_rec.code_country, v_person_phone_rec.area_code,
				v_person_phone_rec.base_number, v_person_phone_rec.extension);
		end if;
	end if;
	close cur_person_phone;
	--	get address phone (and others)
	if v_result is null then
		open cur_address_phone;
		fetch cur_address_phone into v_address_phone_rec;
		if cur_address_phone%found then
			if v_address_phone_rec.primary_flag = 'Y' then
				v_result := NicePhone(v_address_phone_rec.code_country, v_address_phone_rec.area_code,
					v_address_phone_rec.base_number, v_address_phone_rec.extension);
			end if;
		end if;
		close cur_address_phone;
	end if;
	--	if no primary, use person
	if v_result is null then
		if v_person_phone_rec.base_number is not null then
			v_result := NicePhone(v_person_phone_rec.code_country, v_person_phone_rec.area_code,
				v_person_phone_rec.base_number, v_person_phone_rec.extension);
		elsif v_address_phone_rec.base_number is not null then
			v_result := NicePhone(v_address_phone_rec.code_country, v_address_phone_rec.area_code,
				v_address_phone_rec.base_number, v_address_phone_rec.extension);
		end if;
	end if;
	return v_result;
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_PickupAgy
	 (p_charge_id 	in 	 EPIC.eh_charge.charge_id%TYPE) 
	
/*
Purpose: Returns the agency that is picking up the inmate after his/her release from the MCJ

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			g.attribute_value
		FROM
		 	EPIC.eh_generic_attribute g,
		    EPIC.eh_charge c
		WHERE
			g.attribute_name = 'HELD FOR'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;

          
vAgy	 EPIC.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_primarycharge
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the statute text of the Primary Charge (the Primary Charge is defined as the first charge entered on
		 an inmate's booking--thus having an index of '1') for the given booking 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN EPIC.epic_statutes.statute_description%type AS

	CURSOR curCharge IS
		SELECT 	s.statute_description
	 		   
		FROM 	EPIC.epic_statutes s,
				EPIC.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	 			and s.statute_id = c.statute_id
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_description%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vchgscrpt := vChargeRec.statute_description;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_primarychargeID
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)
	
--Returns the Charge_ID  
--an inmate's booking--thus having an index of '1') for the given booking 

RETURN EPIC.eh_charge.CHARGE_ID%type AS

	CURSOR curCharge IS
		SELECT 	CHARGE_ID
	 		   
		FROM 	EPIC.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	 			--and CHARGE_STATE <> '6' (RAS 3/10/06: commented line so as to allow return of charges that have been dismissed)
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vChargeID	EPIC.eh_charge.CHARGE_ID%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vChargeID := vChargeRec.CHARGE_ID;

RETURN vChargeID;
	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_primarychargenumber
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the statute number of the Primary Charge (the Primary Charge is defined as the first charge entered on
		 an inmate's booking--thus having an index of '1') for the given booking 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN EPIC.epic_statutes.statute_number%type AS

	CURSOR curCharge IS
		SELECT 	s.statute_number
	 		   
		FROM 	EPIC.epic_statutes s,
				EPIC.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	  			and s.statute_id = c.statute_id
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_number%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vchgscrpt := vChargeRec.statute_number;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_race
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
/*
Purpose: Returns an inmate's race
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2 AS
v_race		EPIC.eh_entity_race.code_race%type;

	CURSOR cur_race IS
		SELECT
			r.code_race
		FROM
		 	EPIC.eh_entity_race r	
		WHERE    
			r.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_race;
		FETCH cur_race INTO v_race;
			IF cur_race%notfound THEN
				v_race :='U';
			END IF;	
	 	CLOSE cur_race;	
			
RETURN v_race; 

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_RDCCapacity_Cell
	 (p_location 	IN 	MACOMB.mt_jcs_rdc.cellname%TYPE)  

/*
Purpose: Returns the sum of the RDC (Rated Design Capacity) for the input cell/cell group.  This function pulls data
		from a custom Macomb-written table to hold the RDC numbers

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema  
											Changed target table from EPIC to MACOMB table
*/	
	 
RETURN VARCHAR2 AS
  CURSOR curLocation IS 
  	SELECT 	sum(r.capacity)

	FROM	MACOMB.mt_jcs_rdc r

	WHERE	r.cellname like p_location;
     
     
v_location	number;

BEGIN
  	OPEN curLocation;
  		FETCH curLocation INTO v_location;
  	CLOSE curLocation;
	

RETURN v_location;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_RDCCapacity_Location
	 (p_location 	IN 	MACOMB.mt_jcs_rdc.location%TYPE)  

/*
Purpose: Returns the sum of the RDC (Rated Design Capacity) for the input location.  This function pulls data
		from a custom Macomb-written table to hold the RDC numbers

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema  
											Changed target table from EPIC to MACOMB table
*/	
	 
	 
RETURN VARCHAR2 AS
  CURSOR curLocation IS 
  	SELECT 	sum(r.capacity)

	FROM	MACOMB.mt_jcs_rdc r

	WHERE	r.location like p_location;
     
     
v_location	number;

BEGIN
  	OPEN curLocation;
  		FETCH curLocation INTO v_location;
  	CLOSE curLocation;
	

RETURN v_location;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_releasenotes
	(p_booking_id		in		EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns note text associated with a release (from the release tab in Offendertrak)


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2
IS   
	CURSOR curRNotes IS
		SELECT 	n.note_text_1 || ' ' || n.note_text_2 || ' ' || n.note_text_3 || ' '|| n.note_text_4 ||	' ' || n.note_text_5 as Notes

		FROM	EPIC.epic_notes n,
				EPIC.eh_release r,
				EPIC.epic_note_book nb

		WHERE	n.note_ref = nb.note_id
				and nb.epic_id = r.release_id
				and r.booking_id = p_booking_id;
		
vRNotes         EPIC.epic_col_types.VARCHAR_2000%type;
  
BEGIN
	OPEN curRNotes;
		FETCH curRNotes into vRNotes;
	CLOSE curRNotes;
		
RETURN vRNotes;
END;

--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_releasetype
	(p_booking_id		in		EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the reason for release for the given booking


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2
IS		v_release		EPIC.eh_release.release_type%type;

	CURSOR cur_release IS
		SELECT	r.release_type	
		
		FROM	EPIC.eh_release r,
				EPIC.eh_booking b
		
		WHERE 	b.booking_id = r.booking_id
				and b.booking_id = p_booking_id;
  
BEGIN
	OPEN cur_release;
		FETCH cur_release INTO v_release;
	CLOSE cur_release;
			
	RETURN EPIC.ef_lookup_text('RELEASE TYPE', v_release, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_rel_date
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file

RETURN VARCHAR2 AS

v_rel_date				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_rel_date IS
		select
			bk.final_release_date  
			from EPIC.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_rel_date;
		FETCH cur_rel_date INTO v_rel_date;
	 	CLOSE cur_rel_date;	
			
RETURN v_rel_date;
END;
--KJH
/

CREATE OR REPLACE
function mcmb_fnt_restrict (
	p_entity_id				in		EPIC.eh_entity_person.entity_id%type)
return EPIC.epic_col_types.varchar_255%type
is

	cursor cur_restrict is
		select
			r.code_restriction_type,
			r.begin_date
		from
			EPIC.eh_entity_restriction r
		where
			r.entity_id = p_entity_id
			and EPIC.ef_epic_date_to_date(r.end_date) > sysdate or EPIC.ef_epic_date_to_date(r.end_date) is null
		order by EPIC.ef_epic_date_to_date(r.begin_date) desc;
v_cur_restrict 	cur_restrict%rowtype;
begin
	open cur_restrict;
	fetch cur_restrict into v_cur_restrict;
	if cur_restrict%found then
		close cur_restrict;
		return v_cur_restrict.code_restriction_type;
	end if;
	close cur_restrict;
	return '';
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Reversal
	 (p_acct_id 	in	EPIC.eh_trans_distribution.trust_account_id%TYPE)  
	 
--Testing: this function is not valid/correct, nor used
	 
RETURN VARCHAR2 AS
  CURSOR curRev IS 
  	SELECT 	tat.reverse_flag

	FROM	EPIC.eh_trust_account_trans tat
	
	WHERE	tat.trust_account_id = p_acct_id;     
     

vRev	EPIC.eh_trust_account_trans.reverse_flag%type;


BEGIN 
  	OPEN curRev;
  		FETCH curRev INTO vRev;
  	CLOSE curRev;
  	
RETURN vRev;
  	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_ReviewDate
	 (p_entity_id	in 	EPIC.eh_booking.entity_id%TYPE) 

/*
Purpose: Returns the most current/last review date an inmate had during the current active booking
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	 
RETURN VARCHAR2 AS
  CURSOR curReviewDate IS 
		select
			EPIC.ef_epic_date_to_date(sc.review_date)
		from
			EPIC.eh_security_classification sc,
			EPIC.eh_active_booking ab
		where
			ab.entity_id = p_entity_id
			and sc.booking_id = ab.booking_id
		order by EPIC.ef_epic_date_to_date(sc.review_date) desc;
     
     
vReviewDate	 EPIC.eh_security_classification.review_date%TYPE;


BEGIN
  	OPEN curReviewDate;
  		FETCH curReviewDate INTO vReviewDate;
  	CLOSE curReviewDate;

  	RETURN vReviewDate;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_SentAllChgs
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE) 

/*
Purpose: Returns 'S' if an inmate has been sentenced on all active charges; otherwise, returns 'U'	

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'U' 
  	
    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state != '4' --sentenced
			and c.charge_state != '6' --disposed
			and b.entity_id = p_entity_id;
     
     
v_status     EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is not '4' (Sentenced) or '6' (Disposed):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found an un-sentenced charge, 'v_status' will be set to 'U', if not return 'S'
RETURN NVL (v_status,'S');
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_sentdate_gvt
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   

/*
Purpose: Returns the booking sentence_start_date which is used to calculate room and board charges
		 after the inmate has been released

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/11/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS

v_sent_date				EPIC.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			EPIC.ef_epic_date_to_date(bk.sentence_start_date) 
			from EPIC.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_SentOneChg
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE)  

/*	
Purpose:		Returns 'S' if an inmate has been sentenced on at least one charge; otherwise, returns a 'U'
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 	 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state = '4'
			and b.entity_id = p_entity_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is '4' (Sentenced):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_SenttoPrison
			 (p_booking_id 	in	 EPIC.eh_charge.booking_id%TYPE) 

/*	
Purpose:		Returns 'P' if an inmate has been sentenced to prison; returns 'NP' if an inmate has not been sentenced to prison
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/  			 
	 
RETURN VARCHAR2 AS
  CURSOR curPrison IS 
  	SELECT 	'P' 
  	
    FROM 	EPIC.eh_charge c,
    		EPIC.eh_generic_attribute g
			     		
	WHERE	c.charge_id = g.item_id
			and (EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON AWAITING PAPERS'
					 or EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON PAPERS HERE')
			and c.booking_id = p_booking_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is Sentenced to Prison
  	OPEN curPrison;
  	FETCH curPrison INTO v_status;
  	CLOSE curPrison;
	-- If we found a 'Prison' charge, 'v_status' will be set to 'P', if not return 'NP'
  	RETURN NVL (v_status,'NP');
  	
  	
END;

--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_SenttoPrison_Chrg
			 (p_charge_id 	in	 EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns 'P' if an inmate has been sentenced to prison on this charge; 
		 Returns 'NP' if an inmate has not been sentenced to prison on this charge
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/			 
	 
RETURN VARCHAR2 AS
  CURSOR curPrison IS 
  	SELECT 	'P' 
  	
    FROM 	EPIC.eh_charge c,
    		EPIC.eh_generic_attribute g
			     		
	WHERE	c.charge_id = g.item_id
			and (EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON AWAITING PAPERS'
					 or EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON PAPERS HERE')
			and c.charge_id = p_charge_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look to see if this charge for this inmate is Sentenced to Prison
  	OPEN curPrison;
  	FETCH curPrison INTO v_status;
  	CLOSE curPrison;
	-- If we found a 'Prison' charge, 'v_status' will be set to 'P', if not return 'NP'
  	RETURN NVL (v_status,'NP');
  	
  	
END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_sent_date
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	


RETURN VARCHAR2 AS

v_sent_date				epic.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			bk.sentence_start_date  
			from epic.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_sent_enddate
	(p_book_id	 in		epic.eh_booking.booking_id%type)   
 --Returns the sentence_end_date from eh_booking	
                                                                         
RETURN VARCHAR2 AS

v_sent_end				epic.eh_booking.sentence_end_date%type;

	CURSOR cur_sent_end IS
		select
			bk.sentence_end_date  
			from epic.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_sent_end;
		FETCH cur_sent_end INTO v_sent_end;
	 	CLOSE cur_sent_end;	
			
RETURN v_sent_end;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Sent_Restitution
	
	(p_entity_id		in		    epic.eh_booking.entity_id%type)
		
--Returns the attribute_value for sentence attribute "Restitution Judgement Amount" 
-- Active inmates only
	
RETURN VARCHAR2 AS

v_attrValue	    			epic.eh_chart_of_accounts.total_credits%type;

	CURSOR cur_attrValue IS
		SELECT
			ga.attribute_value
		FROM
		 	epic.eh_generic_attribute ga,
		 	epic.eh_booking book,
		 	epic.eh_charge chg,
		 	epic.eh_sentence sent		 	
		 	
		WHERE p_entity_id = book.entity_id 
		and book.booking_id = chg.booking_id
		and chg.sentence_id = sent.sentence_id
		and sent.sentence_id = ga.item_id	 
        and   ga.attribute_name =  'RESTITUTION JUDGEMENT AMOUNT'             
 		and book.booking_id in
 			(Select ab.booking_id
 				from epic.eh_active_booking ab);
                                   
BEGIN
	OPEN cur_attrValue;
		FETCH cur_attrValue INTO v_attrValue;
		CLOSE cur_attrValue;
			
RETURN v_attrValue;

END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_sent_Total_Amount
	 (p_booking_id 	in 	EPIC.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total sentence amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/12/06       created
					DLK          03/10/06       ADDED THE EPIC NOTATION
*/  	 
RETURN VARCHAR2
IS  
	CURSOR cur_sent IS   
  	SELECT 	c.booking_id, sum(f.fine_amount)
  	
	FROM 	EPIC.eh_sentence_fine f,
			EPIC.eh_charge c
	WHERE	p_booking_id = c.booking_id 
	  and   c.sentence_id = f.sentence_id	
 group by   c.booking_id;

vsent	   EPIC.eh_sentence_fine.fine_amount%TYPE;
vbook      EPIC.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN	
	OPEN cur_sent;
		FETCH cur_sent into vbook, vsent;
	CLOSE cur_sent;

RETURN vsent;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_socsec
	(p_entity_id	in		EPIC.eh_person_identity.entity_id%type)

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS

v_SocSec		varchar2(128);

	CURSOR cur_SocSec IS
		SELECT
			substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN
		FROM
		 	EPIC.eh_person_identity epi
		WHERE    
			epi.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_SocSec;
		FETCH cur_SocSec INTO v_SocSec;
	CLOSE cur_SocSec;
			
RETURN v_SocSec;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_socsec_numeric
	(p_entity_id	in		EPIC.eh_person_identity.entity_id%type)

/*	
	Purpose:		Return an inmate's social security number without any dashes
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
                     R. Stuve	  07/27/06		Created
	
*/	

RETURN VARCHAR2 AS

v_SocSec		varchar2(128);

	CURSOR cur_SocSec IS
		SELECT
			 epi.social_security_number 
		FROM
		 	EPIC.eh_person_identity epi
		WHERE    
			epi.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_SocSec;
		FETCH cur_SocSec INTO v_SocSec;
	CLOSE cur_SocSec;
			
RETURN v_SocSec;

END;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_startdate_audit
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns the booking_start_date which is used to calculate room and board charges
-- after the inmate has been released.

RETURN VARCHAR2 AS

v_start_date				EPIC.eh_booking.sentence_start_date%type;

	CURSOR cur_start_date IS
		select
			EPIC.ef_epic_date_to_date(bk.start_date)  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_startdate_gvt
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns the booking_start_date which is used to calculate room and board charges
-- after the inmate has been released.

RETURN VARCHAR2 AS

v_start_date				EPIC.eh_booking.sentence_start_date%type;

	CURSOR cur_start_date IS
		select
			EPIC.ef_epic_date_to_date(bk.start_date)  
			from EPIC.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_status_enddate
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns an dates of custody status changes for room & board billing purposes

RETURN VARCHAR2 AS

v_end_date				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_end_date IS
		select
			EPIC.ef_epic_date_to_date(bkstat.date_end)  
			from EPIC.eh_booking_custody_status bkstat
			where bkstat.booking_id = p_book_id;
  
BEGIN
	OPEN cur_end_date;
		FETCH cur_end_date INTO v_end_date;
	 	CLOSE cur_end_date;	
			
RETURN v_end_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_status_epicaudit
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

	
RETURN VARCHAR2 AS

v_stat		EPIC.eh_booking.entity_id%type;

	CURSOR cur_stat IS
		SELECT
			stat.code_custody_status
		FROM
			epicaudit.eh_entity_status stat,
		 	epicaudit.eh_booking book	
		WHERE    
			p_entity_id = book.entity_id
			and stat.entity_id = book.entity_id
			and stat.code_custody_status in ('1','4','10')
			and book.sentence_start_date > '2005061104:00:00-240'
			and book.final_release_date < '2005072704:00:00-240'; 
			  
  
BEGIN
	OPEN cur_stat;
		FETCH cur_stat INTO v_stat;
		CLOSE cur_stat;
			
RETURN v_stat;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_status_from_BookID
	(	p_book_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on a booking_id (queries against the 
		  'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	       Change Made
				----------	-------------	------------------------------------------
				K. Heinz		09/07/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
	
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
		            EPIC.eh_booking book,
		            epic.eh_charge chg 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
		and         p_book_id = chg.booking_id
				AND chg.charge_id = g.item_id;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--kjh
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_status_startdate
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)   
	
--Returns dates of custody status changes for room & board billing purposes

RETURN VARCHAR2 AS

v_start_date				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_start_date IS
		select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id;
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_status_WorkRelease
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns 'Y' if inmate booking has any custody status of  '5' - Work Release 

RETURN VARCHAR2 AS
  CURSOR curSent IS 
  
        	Select distinct 'Y'   
        		
        	From epic.eh_booking_custody_status bc
        	Where bc.booking_id = p_booking_id
        	and bc.code_custody_status = '5';
        	
v_Status		varchar2(128);      
BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a Work Release status, 'v_status' will be set to 'Y', if not return 'N'
RETURN NVL (v_status,'N');
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_StatuteCategory
 (p_charge_id		in		EPIC.eh_charge.charge_id%type)
 
/*	
Purpose:		Returns 'PA325' if the given charge is classified as assaultive or resides under the PA325 category
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 
 
RETURN EPIC.eh_statute_category.category_name%type
AS

	CURSOR curStat IS
		SELECT	
			sc.category_name
        FROM
			EPIC.epic_statutes es,
			EPIC.eh_category_statute ec,
			EPIC.eh_statute_category sc,
			EPIC.eh_charge c
         WHERE
			c.statute_id = es.statute_id
			and es.statute_id = ec.statute_id
			and ec.statute_category_id = sc.statute_category_id
			and sc.category_name = 'PA325'
			and c.charge_id = p_charge_id;
	                                      
	vStatute    EPIC.eh_statute_category.category_name%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_statutenumber
 (p_charge_id		in		EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the statute number for the given charge


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	 
 
RETURN EPIC.epic_statutes.statute_number%type AS

	CURSOR curStat IS
		SELECT
			es.statute_number
		FROM
			EPIC.epic_statutes es,
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id
			and c.statute_id = es.statute_id;
	                                      
	vStatute     EPIC.epic_statutes.statute_number%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_statutetext
 (p_charge_id			in		EPIC.eh_charge.charge_id%type) 
 
/*
Purpose: Returns the statute description/text for the given charge


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
 
RETURN EPIC.epic_statutes.statute_description%type AS

	CURSOR curStat IS
		SELECT
			es.statute_description
		FROM
			EPIC.epic_statutes es,
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id
			and c.statute_id = es.statute_id;
	                                      
	vStatute     EPIC.epic_statutes.statute_description%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_statute_no_desc
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)
	
--This function is just for testing purposes: it is not used	

RETURN EPIC.epp_generic_ref_cursor.ref_cursor AS
 
curChargeNoDesc EPIC.epp_generic_ref_cursor.ref_cursor;
v_test     EPIC.epic_statutes.statute_number%type;
v_test2    EPIC.epic_statutes.statute_description%type;  

BEGIN
 	OPEN curChargeNoDesc FOR
		SELECT 	es.statute_number as "Charge_Number",  
	       		es.statute_description as "Charge_Desc",
 		   		decode(es.code_statute_class,'FEL',1,2) as Idx 
 		   		
		FROM	EPIC.epic_statutes es,
				EPIC.eh_charge ec  
				
		WHERE	ec.booking_id = p_booking_id
	  			and ec.charge_state <> 6
	  			and es.statute_id = ec.statute_id
		ORDER BY Idx;
	
RETURN curChargeNoDesc;
	
END;
--RAS
/

CREATE OR REPLACE
function mcmb_fnt_statute_no_desc2
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

return EPIC.epp_generic_ref_cursor.ref_cursor is 
       curChargeNoDesc EPIC.epp_generic_ref_cursor.ref_cursor;
       v_test     EPIC.epic_statutes.statute_number%type;
       v_test2    EPIC.epic_statutes.statute_description%type;  

begin
    v_test := null;
    v_test2 := null;
	open curChargeNoDesc for
	select es.statute_number as "Charge_Number",  
	       es.statute_description as "Charge_Desc",
 		   decode(es.code_statute_class,'FEL',1,2) as Idx
	from 	
			EPIC.epic_statutes es,
			EPIC.eh_charge ec
	where ec.booking_id = p_booking_id
	  and ec.charge_state <> 6
	  and es.statute_id = ec.statute_id
	order by Idx;
	

 return curChargeNoDesc;
	
end;
/

CREATE OR REPLACE
function mcmb_fnt_statute_no_desc3
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

return EPIC.epp_generic_ref_cursor.ref_cursor is 
curChargeNoDesc EPIC.epp_generic_ref_cursor.ref_cursor;
       
begin
    
    open curChargeNoDesc for 
    select es.statute_number as "Charge_Number",  
	       es.statute_description as "Charge_Desc",
 		   decode(es.code_statute_class,'FEL',1,2) as Idx
	from 	
			EPIC.epic_statutes es,
			EPIC.eh_charge ec
	where ec.booking_id = p_booking_id
	  and ec.charge_state <> 6
	  and es.statute_id = ec.statute_id
	order by Idx;
	

 return curChargeNoDesc;
	
end;
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_telephone_base
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	

--Returns the base numbers of an inmate's most current telephone number

RETURN VARCHAR2 AS

v_phone		EPIC.eh_telephone_records.base_number%type;

	CURSOR cur_phone IS
		SELECT
			t.base_number
		FROM
		 	EPIC.eh_telephone_records t,
		 	EPIC.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_phone;
		FETCH cur_phone INTO v_phone;
	CLOSE cur_phone;
			
RETURN v_phone;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_temp_book_fix
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file

RETURN VARCHAR2 AS

v_book_id				EPIC.eh_booking.final_release_date%type;

	CURSOR cur_book_id IS
		select
			bk.booking_id 
			from EPIC.eh_booking bk
			where bk.entity_id = p_entity_id
			and bk.booking_state = '3'
			and (EPIC.ef_epic_date_to_date(bk.end_date) > EPIC.ef_epic_date_to_date(EPIC.ef_min_date('2005080300:00:00-240')));
  
BEGIN
	OPEN cur_book_id;
		FETCH cur_book_id INTO v_book_id;
	 	CLOSE cur_book_id;	
			
RETURN v_book_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_TransType
	 (p_trans_id 	in 	EPIC.eh_trust_account_trans.trust_account_trans_id%TYPE) 

/*
Purpose: Returns the transaction type (Withdrawl, Deposit, Liability) for the given transaction

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curTrans IS 
  	SELECT 	m.description 
  	
	FROM 	EPIC.eh_chart_of_accts_master m,
			EPIC.eh_trust_account_trans t
			
	WHERE	t.code_source_of_funds = m.gl_account_number
			and t.trust_account_trans_id = p_trans_id;
     
     
vTrans	    EPIC.eh_chart_of_accts_master.description%TYPE;


BEGIN
  	OPEN curTrans;
  	FETCH curTrans INTO vTrans;
  	CLOSE curTrans;

  	RETURN vTrans;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_trust_id 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 

--Returns the inmate's trust account id for the given entity id	
	
RETURN VARCHAR2 AS

v_acctID 	EPIC.eh_trust_account.trust_account_id%type;

	CURSOR cur_acctID IS
		SELECT
			ta.trust_account_id
		FROM
		 	EPIC.eh_trust_account ta
		WHERE    
			ta.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_acctID;
		FETCH cur_acctID INTO v_acctID;
	CLOSE cur_acctID;
			
RETURN v_acctID;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Unpaid
	 (p_sentence_id 	in	EPIC.eh_sentence.sentence_id%TYPE) 

/*
Purpose: Returns a 'UP' flag if an inmate has an unpaid sentence (pay-or-stay) for the given sentence id	

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/			 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'UP' 

	FROM	EPIC.eh_sentence s,
	        EPIC.eh_sentence_out_dates sod
	
	WHERE	s.sentence_id = sod.sentence_id
			and EPIC.ef_epic_date_to_date(s.sentence_end_date) = EPIC.ef_epic_date_to_date(sod.unpaid_out_date)
			and EPIC.ef_epic_date_to_date(sod.paid_out_date) <> EPIC.ef_epic_date_to_date(sod.unpaid_out_date)
			and s.sentence_id = p_sentence_id;     
     
v_status varchar2(20);


BEGIN
	-- Look for any sentence that is upaid:  
  	OPEN curSent;
  	FETCH curSent INTO v_status;
  	CLOSE curSent;
	-- If we found an unpaid sentence, 'v_status' will be set to 'UP', if not return a null
  	RETURN NVL (v_status, null);
  	
  	
END;

--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_user
	(p_action_by		in		EPIC.epic_user_names.action_by%type)   

/*
Purpose: Returns the user name associated with the action_by number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN    EPIC.epic_col_types.varchar_2000%type
IS   
	CURSOR curUser IS
		SELECT
			un.user_name_last || ', ' || un.user_name_first || ' ' || un.user_name_middle
		FROM
		 	EPIC.epic_user_names un	
		WHERE    
			un.user_int_id = p_action_by;
		
vUser       EPIC.epic_col_types.varchar_2000%type;
  
BEGIN	
	OPEN curUser;
		FETCH curUser into vUser;
	RETURN vUser;
	CLOSE curUser;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Vist_app_date
	 (p_entity_id	in 	EPIC.EH_ENTITY_RELATIONSHIP.ENTITY_RELATED_TO%TYPE) 
	 
--Returns an application date for the selected inmate entity_id
	 
RETURN VARCHAR2 AS
  CURSOR curEntity IS 
	select va.application_date
    from EPIC.EH_VISIT_AUTHORIZATION va
    where va.visitor_id = p_entity_id;
    
vApplDate	 EPIC.EH_VISIT_AUTHORIZATION.application_date%TYPE;


BEGIN
  	OPEN curEntity;
  		FETCH curentity INTO vApplDate;
  	CLOSE curEntity;

  	RETURN vApplDate;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_Vist_expir_date
	 (p_entity_id	in 	EPIC.EH_ENTITY_RELATIONSHIP.ENTITY_RELATED_TO%TYPE) 
	 
--Returns an expiration date for the selected inmate entity_id
	 
RETURN VARCHAR2 AS
  CURSOR curEntity IS 
	select va.expiration_date 
	from EPIC.EH_VISIT_AUTHORIZATION va 
	where va.visitor_id = p_entity_id;
    
vexpirDate	 EPIC.EH_VISIT_AUTHORIZATION.expiration_date%TYPE;


BEGIN
  	OPEN curEntity;
  		FETCH curentity INTO vexpirDate;
  	CLOSE curEntity;

  	RETURN vexpirDate;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION        mcmb_fnt_weekend_status
	(	p_book_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on a booking_id (queries against the 
		  'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	       Change Made
				----------	-------------	------------------------------------------
				K. Heinz		09/07/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
	
		SELECT	DISTINCT 'Y' --EPIC.ef_lookup_text('CHARGE STATUS', 'SENTENCED WEEKENDER', 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
		            --EPIC.eh_booking book,
		            epic.eh_charge chg 
		
		--attribute_name = 'CHARGE STATUS'
			WHERE        p_book_id = chg.booking_id
		AND 			chg.charge_id = g.item_id;
		--and 			attribute_value = 'SENTENCED WEEKENDER';

vStat		varchar2(128);

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'N');
	
END;
--kjh
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_weight 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 

--Returns an inmate's weight
	
RETURN VARCHAR2
IS
v_weight	EPIC.eh_entity_weight.weight%type;

	CURSOR cur_weight IS
		SELECT
			w.weight
		FROM
		 	EPIC.eh_entity_weight w	
		WHERE    
			w.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_weight;
		FETCH cur_weight INTO v_weight; 
	CLOSE cur_weight;
			
RETURN v_weight;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION mcmb_fnt_wrlstime 
	(p_entity_id		IN		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the release time for weekender/work-release inmates

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2
IS
v_time			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_time IS
		SELECT
			g.attribute_value
		FROM
		 	EPIC.eh_generic_attribute g,
		 	EPIC.eh_sentence s,
		 	EPIC.eh_charge c,
		 	EPIC.eh_booking b
		 		
		WHERE    
			g.attribute_name = 'WEEKENDER RELEASE TIME'
			and g.item_id = s.sentence_id
			and s.sentence_id = c.sentence_id 
			and c.charge_state <> 6    -- added 3-1-06 MZ (not needed if in the procedure)
			and c.booking_id = b.booking_id
			and b.entity_id =  p_entity_id
		ORDER by g.action_time desc;    -- added desc 3-1-06;
  
BEGIN
	OPEN cur_time;
		FETCH cur_time INTO v_time;
	CLOSE cur_time;
			
RETURN v_time;

END;
--RAS
/

CREATE OR REPLACE
package mcmb_generic_ref_cursor is
--
--	Feb 1, 2006 , J McBratnie
--		Generic reference cursor definition for functions returning record sets
--

	type ref_cursor is ref cursor;

end mcmb_generic_ref_cursor;
/

CREATE OR REPLACE
procedure mcmb_get_rmbsmt_trans
	(p_last_run_date in EPIC.eh_address.action_time%type,
	vEntID IN OUT EPIC.epp_generic_ref_cursor.ref_cursor)
is	
-- 	 
BEGIN

OPEN vEntID FOR

	select trust.entity_id,
		trans.trust_account_id,
		trans.description,
		trans.amount,
		EPIC.EF_EPIC_DATE_TO_DATE(trans.trans_date),
		stat.code_custody_status,
		oi.offender_id


        from
         EPIC.eh_trust_account_trans trans,
         EPIC.eh_trust_account trust,
         EPIC.eh_offender_ids oi,
         EPIC.eh_entity_status stat,
         EPIC.eh_entity_person ep,
         EPIC.eh_person_identity pi

   where
   
     trust.entity_id = oi.entity_id and
     ep.primary_identity_id = pi.identity_id and
     trust.entity_id = stat.entity_id and
     trans.trust_account_id = trust.trust_account_id and
     EPIC.EF_EPIC_DATE_TO_DATE(trans.trans_date) > p_last_run_date and
    trans.code_source_of_funds = '505' and
    trans.reverse_flag is null;

END mcmb_get_rmbsmt_trans;

/

CREATE OR REPLACE
package        mcmb_gvt_interface 
is
	--
	--  08/2005
	--	process GVT interface requests             
	--  KJH w/ assistance from Kevin Strike
	procedure process_request (
		p_request_id			in			epic.eh_interface_request.request_id%type,
		p_new_status			in out 		epic.eh_interface_request.code_request_status%type
		);

end mcmb_gvt_interface;
/

CREATE OR REPLACE
package body        mcmb_gvt_interface is  ---09/12/06 Try changing the process so "Weekenders" with no Custody Status don't get skipped
                                                          --Add "IF" statement before Status loop,  and exit if prev_stat_start_date is equal to current
	gv_file_path	varchar2(255);
	gv_file_name	varchar2(255);
	gv_file_initialized  boolean;
	gv_interface_name    epic.eh_interface.interface_name%type;
	v_last_extract         VARCHAR2(128); 
 
 function AddLine
	(p_inmate_number in   epic.eh_offender_ids.offender_id%type,
	p_fullname in             epic.epic_col_types.varchar_255%type,
	p_ssn 	in			epic.eh_person_identity.social_security_number%type,
	p_dob	in			epic.eh_person_identity.date_of_birth%type,
	p_address  in        epic.epic_col_types.varchar_255%type,
	p_street in			epic.epic_col_types.varchar_255%type,
	p_city	in			epic.eh_address.city_town_locale%type,
	p_state	 in			epic.eh_address.state_province_region%type,
	p_zip   in            epic.eh_address.postal_code%type,
	p_area_code	 in		epic.eh_telephone_records.area_code%type,
	p_phone	 in			epic.eh_telephone_records.base_number%type,
	p_oln		in			epic.eh_operators_license.drivers_license_number%type,
	p_sex   in            epic.eh_entity_gender.code_gender%type,
	p_end_date	in		epic.eh_booking.end_date%type, --Dispo date
	p_start_date  in      epic.eh_booking.start_date%type,  --Book date
	p_nbr_days	 in		epic.eh_sentence_duration.days%type,
	p_custody_status in	epic.eh_entity_status.code_custody_status%type,
	p_stat_start  in      epic.eh_booking.start_date%type,	
	p_stat_end  in      epic.eh_booking.start_date%type
	 ) return boolean
is

	v_buffer		varchar2(255);
	v_file_num			sys.utl_file.file_type;

begin
    v_buffer := ' ';
    v_buffer := '"' || p_inmate_number || '"' || ',';     
    v_buffer := v_buffer || '"' || p_fullname || '"' || ',';
    if (length(p_ssn) > 0) then
        v_buffer := v_buffer || '"' || p_ssn || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44); 
    end if;   
    if (length(p_dob) > 0) then
    	v_buffer := v_buffer || '"' || p_dob || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_address) > 0) then
    	v_buffer := v_buffer || '"' || p_address || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_street) > 0) then
    	v_buffer := v_buffer || '"' || p_street || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_city) > 0) then
    	v_buffer := v_buffer || '"' || p_city || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_state) > 0) then
    	v_buffer := v_buffer || '"' || p_state || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_zip) > 0) then
    	v_buffer := v_buffer || '"' || p_zip || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_area_code) > 0) then
    	v_buffer := v_buffer || '"' || p_area_code || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_phone) > 0) then
    	v_buffer := v_buffer || '"' || p_phone || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if; 
    if (length(p_oln) > 0) then
    	v_buffer := v_buffer || '"' || p_oln || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_sex) > 0) then
    	v_buffer := v_buffer || '"' || p_sex || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_end_date) > 0) then
    	v_buffer := v_buffer || '"' || rtrim(p_end_date) || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_start_date) > 0) then
    	v_buffer := v_buffer || '"' || rtrim(p_start_date) || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if p_nbr_days > 0 then
    	v_buffer := v_buffer || '"' || TO_CHAR(p_nbr_days) || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
    if (length(p_custody_status) > 0) then
    	v_buffer := v_buffer || '"' || p_custody_status || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
       	v_buffer := v_buffer || '""' || chr(44); --need a field defined for trans amt, which we are no longer sending, but GVT still expects   4/4/06 kjh 
   --Adding 2 new fields for Status Start and End 09/15/06 kjh    	
    if (length(p_stat_start) > 0) then
    	v_buffer := v_buffer || '"' || rtrim(p_stat_start) || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;  
    if (length(p_stat_end) > 0) then
    	v_buffer := v_buffer || '"' || rtrim(p_stat_end) || '"' || chr(44);
    else
    	v_buffer := v_buffer || '""' || chr(44);
    end if;
  
    If gv_file_initialized = false then
        v_file_num := sys.utl_file.fopen(gv_file_path, gv_file_name, 'w'); 
        sys.utl_file.fclose(v_file_num);
        gv_file_initialized := true;
    end if; 
    v_file_num := sys.utl_file.fopen(gv_file_path, gv_file_name, 'a');  
	sys.utl_file.put_line(v_file_num, v_buffer); 
	sys.utl_file.fclose(v_file_num);
	return true;
	
	exception
		when sys.utl_file.invalid_path then
			raise_application_error(-20001, 'Invalid file path in write_file [' || gv_file_path || '], ' || sqlerrm ||
				', op = "put_line"');
			return false;
		when sys.utl_file.invalid_operation then
			raise_application_error(-20001, 'Invalid file operation in write_file [' || gv_file_path || '/' ||
			gv_file_name || '], ' || sqlerrm || ', op = "put_line"'); 
			return false;
		when sys.utl_file.invalid_mode then
			raise_application_error(-20001, 'Invalid file mode in write_file [' || gv_file_path || '/' ||
			gv_file_name || '], ' || sqlerrm || ', op = "put_line"');
			return false;
		when others then
			if sqlcode <> -20001 then
				raise_application_error(-20001, '(' || sqlcode || ') ' || sqlerrm || ' - write_file' || ', op = "put_line"');
				return false;
			else
				raise_application_error(-20001, sqlerrm || ' - write_file' || ', op = "put_line"');
				return false;
			end if;
end;
	
procedure process_request
	(p_request_id			in		epic.eh_interface_request.request_id%type,
	 p_new_status			in out	epic.eh_interface_request.code_request_status%type
	 )
is
    v_result   epic.epic_col_types.number_9%type;
    v_result_msg        epic.epic_col_types.varchar_255%type;
    
	cursor curInterface is
	select * from epic.eh_interface_request req  
	where req.request_id = p_request_id;
	curInterface_rec    curInterface%rowtype; 
 	
	cursor curMain is

select
    booking_id  as book_id,
	entity_id as entity_id,
    epic.ef_offender_id(bk.entity_id) as inmate_number,  
	macomb.mcmb_fnt_Name_Delimited_gvt(bk.entity_id) as fullname,  
	macomb.mcmb_fnt_socsec_numeric(bk.entity_id) as ssn,  
	macomb.mcmb_fnt_DOB_gvt_format(bk.entity_id) as dob,  
	substr(macomb.mcmb_fnt_address_numstr(bk.entity_id),1,instr(macomb.mcmb_fnt_address_numstr(bk.entity_id),' ')-1) as address,  
	substr(macomb.mcmb_fnt_address_numstr(bk.entity_id),instr(macomb.mcmb_fnt_address_numstr(bk.entity_id),' ',+1)+1) as street,  
	macomb.mcmb_fnt_address_city(bk.entity_id) as city,  
	macomb.mcmb_fnt_address_state(bk.entity_id) as state, 
	macomb.mcmb_fnt_address_postal(bk.entity_id) as zip,  
	macomb.mcmb_fnt_area_code_primary(bk.entity_id) as area_code,  
	macomb.mcmb_fnt_phone_base_primary(bk.entity_id)as phone, 
	macomb.mcmb_fnt_drvlicense_primary(bk.entity_id) as oln,  
	macomb.mcmb_fnt_gendershort(bk.entity_id) as sex,  
	macomb.mcmb_fnt_dispodate_gvt(bk.booking_id) as dispo_date, 
	macomb.mcmb_fnt_startdate_gvt(bk.booking_id) as start_date,
	macomb.mcmb_fnt_enddate_gvt(bk.booking_id) as end_date
from
    epic.eh_booking bk
where
	 bk.booking_state = '3'
	--and epic.ef_epic_date_to_date(macomb.mcmb_fnt_enddate_gvt(bk.booking_id)) >  epic.ef_epic_date_to_date(v_last_extract) 
	and epic.ef_epic_date_to_date(macomb.mcmb_fnt_enddate_gvt(bk.booking_id)) >  epic.ef_epic_date_to_date('2006091516:58:48-240')
	and epic.ef_epic_date_to_date(macomb.mcmb_fnt_enddate_gvt(bk.booking_id)) < = epic.ef_epic_date_to_date('2006091812:15:18-240')
	and macomb.mcmb_fnt_disporeason_sent(bk.booking_id) = 'S' 
 order by 3;   -- Changed from "order by 1" 6/27/06 kjh
--*****************************************************************************
 cursor curStatus(v_book_id in epic.EH_BOOKING.BOOKING_ID%TYPE)  is    
         	Select
				stat.code_custody_status as statcode,
				stat.date_start,
				stat.date_end, 
				stat.booking_id
								
			From
				epic.Eh_booking_custody_status stat
			where stat.booking_id = v_book_id 
			order by date_start desc;
			 
-- Declare variables
    loopcounter  number;	
	v_status			varchar2(255);
	v_operation			varchar2(255);
	v_previous_entity			epic.eh_person_identity.entity_id%type;
	v_current_entity		epic.eh_person_identity.entity_id%type; 
	v_book_id				epic.eh_booking.booking_id%type;
	v_inmate_number		epic.eh_offender_ids.offender_id%type;
	v_fullname              epic.epic_col_types.varchar_255%type;
	v_ssn 				epic.eh_person_identity.social_security_number%type;
	v_dob				epic.eh_person_identity.date_of_birth%type;
	v_address           varchar2(128);
	v_street			varchar2(128);
	v_city				epic.eh_address.city_town_locale%type;
	v_state				epic.eh_address.state_province_region%type;
	v_zip               epic.eh_address.postal_code%type;
	v_area_code			epic.eh_telephone_records.area_code%type;
	v_phone				epic.eh_telephone_records.base_number%type;
	v_oln				epic.eh_operators_license.drivers_license_number%type;
	v_sex               epic.eh_entity_gender.code_gender%type;
	v_stat_code	epic.eh_entity_status.code_custody_status%type;
	v_start_date        epic.eh_booking.start_date%type; 
	v_end_date          epic.eh_booking.end_date%type;
	v_dispo_date			epic.eh_booking.end_date%type;
	v_nbr_days			epic.eh_sentence_duration.days%type;
	v_prev_stat_start   epic.eh_booking_custody_status.date_start%type;
    v_stat_start           epic.eh_booking_custody_status.date_start%type;
    v_stat_end            epic.eh_booking_custody_status.date_end%type;
	v_work_release		VARCHAR2(1);
	v_weekender         VARCHAR2(1); 
	v_prev_bookID		epic.eh_booking.booking_id%type;
	repeat_status			VARCHAR2(1);
	v_prev_status        epic.eh_entity_status.code_custody_status%type;
    v_more_status       VARCHAR2(1); 
    
begin
gv_file_initialized := false;
--Initialize variables   
	v_status := 'COMPLETED';
    gv_file_path := ' ';
	gv_file_name := 'TestGVT' || to_char(sysdate, 'MMDDYY') || '.txt';
	v_previous_entity := ' ';
	v_current_entity := ' '; 
	v_book_id := ' ';
	v_inmate_number := ' ';
	v_fullname := ' ';
	v_ssn := ' ';
	v_dob := ' ';
	v_address := ' ';
	v_street := ' ';
	v_city := ' ';
	v_state := ' ';
	v_zip := ' ';
	v_area_code := ' ';
	v_phone := ' ';
	v_oln := ' ';
	v_sex := ' ';
	v_start_date := ' '; 
	v_end_date := ' ';
	v_dispo_date := ' ';
	v_nbr_days := 0;
	v_stat_code 	 := ' ';	
	v_prev_stat_start := null;		 
    v_stat_start  := ' ';          
    v_stat_end   := ' ';       
	v_prev_bookID := ' ';
	v_prev_status  := null;
	repeat_status := ' ';
	v_work_release := ' ';  
	v_weekender := ' ';
	v_last_extract := macomb.mcmb_fnt_interface_lastrun('GVT EXPORT');
	
	
	select property_value 
    into gv_file_path 
    from epic.eh_interface_property 
    where interface_name = 'GVT EXPORT' 
    and property_name = 'FILE DIRECTORY';	
    
	if gv_file_path is null then
		raise_application_error(-20001, 'Missing file path specification');
	end if;
	v_operation := 'open';	
	open curInterface;
	fetch curInterface into curInterface_rec;
	if curInterface%notfound then
	    gv_interface_name := null;
    else
        gv_interface_name := curInterface_rec.Interface_Name;
    end if;
    close curInterface;
    
    if gv_interface_name is null then
           raise_application_error(-20001, 'GVT request is not associated with a valid interface');
    end if;
       
    for recMain in curMain   --"for"statement does the open and fetch without explicitly declaring them
    loop --Find all inmates that have been released with the proper criteria
	
        v_current_entity := recMain.entity_id; 
          if (v_current_entity <> v_previous_entity) then
            v_prev_stat_start := null;
    	    v_prev_status := null;
            v_more_status := 'Y';
        	repeat_status :=  'N';
        	v_book_id := recMain.book_id; 
        	v_previous_entity := v_current_entity;
        	v_inmate_number := recMain.inmate_number;
        	v_fullname := recMain.fullname;
        	v_ssn := recMain.ssn;
			v_dob := recMain.dob;
			v_address := recMain.address;
			v_street := recMain.street;
			v_city := recMain.city;
			v_state := recMain.state;
			v_zip := recMain.zip;
			v_area_code := recMain.area_code;
			v_phone := recMain.phone;
			v_oln := recMain.oln;
			v_sex := recMain.sex;  
			v_dispo_date := recMain.dispo_date; 
			v_start_date := recMain.start_date;
			v_stat_code := ' ';
         	v_work_release := macomb.mcmb_fnt_status_WorkRelease(v_book_id);
        	v_weekender :=   macomb.mcmb_fnt_weekend_status(v_book_id);
   ----------------------------------------------------------------------------------------------------------------------------------  
   If v_weekender = 'Y' then --If Charge Status = 'SENTENCED WEEKENDER', no need to check Custody Status as it is usually null anyway
 		v_stat_code := '4229';   
        v_stat_start := recMain.start_date;
        v_stat_end := recMain.end_date;
        v_nbr_days := epic.ef_epic_date_to_date(epic.ef_max_date(v_stat_end)) - epic.ef_epic_date_to_date(epic.ef_min_date(v_stat_start));
        v_start_date :=    to_char(epic.ef_epic_date_to_date(recMain.start_date), 'MM/DD/YYYY');
        v_dispo_date :=   to_char(epic.ef_epic_date_to_date(recMain.dispo_date), 'MM/DD/YYYY');
        	if (AddLine(v_inmate_number, v_fullname, v_ssn, v_dob, v_address, v_street, v_city, v_state, v_zip, v_area_code, v_phone, v_oln, v_sex, v_dispo_date, v_start_date, v_nbr_days, v_stat_code, v_stat_start, v_stat_end) <> true) then
					v_status := 'ERROR';
					exit;
			end if; 
   Else    --If not a Weekender, check all Custody Statuses for this booking 
		for recStatus in curStatus(v_book_id)     	
    			loop  -----Find all statuses for each inmate booking
    			If (to_char(epic.ef_epic_date_to_date(recStatus.date_Start), 'MM/DD/YYYY') =  to_char(epic.ef_epic_date_to_date(v_prev_stat_start), 'MM/DD/YYYY')) then
    				exit;    --If the start date of the previous status is the same day as the next status, then skip this one, we can't charge inmate twice for one day.
    			Else
    			v_nbr_days := 0;
    			v_stat_code :=
			     Case --recStatus.statcode
			     	When  recStatus.statcode = '1' then '4202'  --Regular
			     	When  recStatus.statcode = '5' then '4201'	 --Work Release	
		  			When  recStatus.statcode = '4' then '4229' --Weekender
		  			When  recStatus.statcode = '7' then '4229' --Alternate Weekender
				Else ' '
			 	END;-- Case;			     
 -----------------------------------------------------------------------------------------------------
            Case
            When v_stat_code in ('4201','4202', ' ') then
         		v_stat_start := recStatus.date_start;
         		If recStatus.date_end is null then
         			If v_prev_stat_start is null then
         				v_stat_end := recMain.dispo_date;
         			Else
         				v_stat_end := v_prev_stat_start;
         			End if; 
              	Else
         				v_stat_end := recStatus.date_end;
         		End if;  
          	When v_stat_code = '4229'  then
               	v_stat_start := recMain.start_date;
         		v_stat_end := recMain.end_date;
  			End case;  
--Do I need an "Else" here for v_stat_code = ' ' ????? 
           If v_stat_code  in  ('4202', '4229', '4201') then
						v_nbr_days := 
						Case 
							when v_work_release = 'Y' then 0
							else  epic.ef_epic_date_to_date(epic.ef_max_date(v_stat_end)) - epic.ef_epic_date_to_date(epic.ef_min_date(v_stat_start))    -- Plus 1 per Lori 
						end; --Case
				v_start_date :=    to_char(epic.ef_epic_date_to_date(recMain.start_date), 'MM/DD/YYYY');
                v_dispo_date :=   to_char(epic.ef_epic_date_to_date(recMain.dispo_date), 'MM/DD/YYYY');
                v_stat_start :=   to_char(epic.ef_epic_date_to_date(v_stat_start), 'MM/DD/YYYY');
                v_stat_end :=   to_char(epic.ef_epic_date_to_date(v_stat_end), 'MM/DD/YYYY');
      			if (AddLine(v_inmate_number, v_fullname, v_ssn, v_dob, v_address, v_street, v_city, v_state, v_zip, v_area_code, v_phone, v_oln, v_sex, v_dispo_date, v_start_date, v_nbr_days, v_stat_code, v_stat_start, v_stat_end) <> true) then
					v_status := 'ERROR';
					exit;
				end if; 
			end if; 
	        end if;
	        v_prev_stat_start := recStatus.date_start; 
   			v_prev_bookID := recStatus.booking_id;
   			v_prev_status := v_stat_code; 
         
	end loop;  --status loop 
	end if; 
      		------------------------------------------------------------------------------------------------------------------       
	end if;           
   end loop;  -- release loop  				
   
 p_new_status := 'COMPLETED';	
insert into epic.eh_request_response
	(request_id, response_id, response_sequence, response_value, action_type, action_time, action_by)
values
	(p_request_id, epic.epic_ids.new_epic_id(), 1, 'THIS IS MY RESPONSE TEXT!', 'U', epic.epicdatenow(), -1);

	COMMIT WORK;
	return;
end;
end mcmb_gvt_interface;

/

CREATE OR REPLACE
procedure mcmb_hold_chk_agency
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_hold_id          in              EPIC.eh_booking_holds.hold_id%type,
	 p_return			in out			varchar2)
is

	cursor curAgency is
		select substr(EPIC.ef_get_personororgname (book.entity_id), 1,255)
		from EPIC.eh_trust_account_trans tran,
			EPIC.eh_booking_holds hold,
			EPIC.eh_booking book,
			EPIC.eh_generic_attribute ga

where tran.bank_id = ga.attribute_value
and ga.item_id = hold.hold_id
and ga.attribute_value = 'HEINZ57'
and hold.booking_id = book.booking_id;

begin
    
		open curAgency;
		fetch curAgency into p_return;
		if curAgency%notfound then
			p_return := 'NOT FOUND';
		end if;
		close curAgency;
	 
	return;

end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_court_line2

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curCourt is

	select trim(ad.street_number || ' ' || ad.street_name)

	from EPIC.eh_trust_account_trans tat,

		 EPIC.eh_address ad

	where tat.trust_account_trans_id = p_trans_id

	and ad.entity_id = tat.payee

	and ad.primary_flag = 'Y';


begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure      mcmb_hold_chk_court_line3
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
	
	cursor curCourt is
	select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)
	from EPIC.eh_trust_account_trans tat,
		 EPIC.eh_address ad
	where tat.trust_account_trans_id = p_trans_id
	and ad.entity_id = tat.payee
	and ad.primary_flag = 'Y';
	
	
begin                          
                                 
	open curCourt;
	fetch curCourt into p_return;
	if curCourt%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curCourt;

	return;
	
end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_court_name

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curName is

	select eo.organization_name

	from EPIC.eh_trust_account_trans trans,
	
		 EPIC.eh_entity_organization eo

	where trans.trust_account_trans_id = p_trans_id

	and trans.payee = eo.entity_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_inmate_name

	(p_inmate_nbr		in				EPIC.eh_offender_ids.offender_id%type,

	 p_return			in out			varchar2)

is

	v_entity_id			EPIC.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curInmate is

		select EPIC.ef_get_personororgname(pi.entity_id)

		from EPIC.eh_trust_account_trans tran,

		     EPIC.eh_trust_account ta,
		     
		     EPIC.eh_offender_ids oi,

		     EPIC.eh_person_identity pi

		where  	tran.description = p_inmate_nbr
		and     tran.trust_account_id = ta.trust_account_id
		and 	ta.entity_id = oi.entity_id
		and 	oi.entity_id = pi.entity_id;
                                   
begin
     
		open curInmate;

		fetch curInmate into v_entity_id;

		if curInmate%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curInmate;
      
	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(EPIC.ef_get_personororgname(v_entity_id));

	end if;

	return;

end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_inmate_number

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
   
	cursor curNumber is

 select DESCRIPTION
 from EPIC.eh_trust_account_trans tran
 where tran.trust_account_trans_id = p_trans_id;
         
    
	
begin                          
                                 
	open curNumber;
	fetch curNumber into p_return;
	if curNumber%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curNumber;

	return;
	
end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_on_docket_cap

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := 'On Warrant #';

	return;



end;
/

CREATE OR REPLACE
procedure      mcmb_hold_chk_remitted_by
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
	
	cursor curPayor is
select PAYEE_OR
from EPIC.EH_TRUST_ACCOUNT_TRANS tran
where tran.trust_account_trans_id = p_trans_id;
--where code_source_of_funds = '475'
begin                          
                                 
	open curPayor;
	fetch curPayor into p_return;
	if curPayor%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curPayor;

	return;
	
end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_user_name

	(p_trans_id			in			EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is


begin



	p_return := EPIC.epp_user_info.get_name('13', 'UC');

	return;



end;
/

CREATE OR REPLACE
procedure      mcmb_hold_chk_voucher_reason
	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
		cursor curReason is
	   
    select EPIC.EF_LOOKUP_TEXT('HOLD REMOVE REASON', '999', 'UC')as remove_reason
	from EPIC.eh_generic_attribute ga,
	     EPIC.eh_trust_account_trans tran,
	     EPIC.eh_booking_holds hold
where ga.attribute_name = 'HOLD WARRANT NUMBER'
AND tran.bank_id = ga.attribute_value
and ga.item_id = hold.hold_id
and ga.attribute_value = 'HEINZ57';
  
begin                          
                                 
	open curReason;
	fetch curReason into p_return;
	if curReason%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curReason;

	return;
	
end;
/

CREATE OR REPLACE
procedure mcmb_hold_chk_warrant_number

	(p_trans_id			in				EPIC.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
   	cursor curWarrant is

		select --ef_lookup_text('HOLD WARRANT NUMBER', ga.attribute_value, 'UC')
		trans.invoice_reference
		
		from EPIC.eh_trust_account_trans trans
		     --eh_trust_account tacct,
		     --eh_generic_attribute ga,
		     --eh_booking book,
		    -- eh_booking_holds hold
           		     
		where
		trans.trust_account_trans_id = p_trans_id;
		--AND trans.trust_account_id =  tacct.trust_account_id
		--and tacct.entity_id = book.entity_id
		--and book.booking_id = hold.booking_id
		--and ga.item_id = hold.booking_id
		--and ga.attribute_name = 'HOLD WARRANT NUMBER';
   begin
             
		open curWarrant;

		fetch curWarrant into p_return;

		if curWarrant%notfound then

			p_return := 'NOT FOUND';

		end if;

		close curWarrant;
    	
	return;



end;
/

CREATE OR REPLACE
FUNCTION mcmb_last_custody_status(
	p_booking_id 		in EPIC.eh_booking.booking_ID%type,
	p_status           out EPIC.eh_booking_custody_status.code_custody_status%type
 	)
RETURN VARCHAR2 AS
    
   	cursor curStat is
	select
	       code_custody_status
	from   EPIC.eh_booking_custody_status
	where
	 date_start in
		(select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id);
		
v_status_code   EPIC.eh_booking_custody_status.code_custody_status%type;

BEGIN
    open curStat;
	fetch curStat into v_status_code;
	if curStat%found then
		--if v_status_id is not null then
			p_status := v_status_code;
		--end if;
	end if;
	close curStat;

	return v_status_code;
END;
/

CREATE OR REPLACE
PROCEDURE        mcmb_macomb_WEB_visitation
		(	curRest			OUT		mcmb_generic_ref_cursor.ref_cursor,
		    p_entity_id     in      WEB_INMATE.entity_id%type)

IS
 
 /*	
	WEB: 		    GIU grid
	Purpose:		Lists basic visitation information regarding inmate location and other key 
					data.

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/01/06		Created   
					J. McBratnie 02/15/06		Added restrictionuntil field
					
*/
    v_data	varchar2(255);
	
 BEGIN
 
	OPEN curRest FOR
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MCMB_VIEW_INMATE I,
    		MACOMB.WEB_VISITATION_CELL VC,
		    MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND I.CELL = VC.CELL
		  AND I.GENDER = VC.GENDER
		  AND VC.INMATETYPE <> 'J'
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID
		UNION
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MACOMB.WEB_INMATE I,
		     MACOMB.WEB_VISITATION_CELL VC,
		     MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND vc.CELL is null
		  AND I.GENDER = VC.GENDER
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.INMATETYPE IN ('O','K','G')
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID
		UNION
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MACOMB.WEB_INMATE I,
		     MACOMB.WEB_VISITATION_CELL VC,
		     MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND vc.CELL is null
		  AND I.GENDER = VC.GENDER
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.INMATETYPE = 'J'
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID;
		  
	END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AlphaBooking
		(	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.
	Crystal: 		.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility: primary/alias names,
					charges, and other formatting changes used for court slip/booking processing

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/05		Created 
					R. Stuve	06/13/05		Compiled on OTMAIN
					
*/

 BEGIN
 
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Booking)' as RptTitle,
				'' as InmateNum,
				'' as NameFlag,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Bin,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
				'' as Charge

		FROM	dual

		UNION ALL

		--the below query pulls back the actual report data
(
SELECT		2 as Flag,
			'Alpha List (Booking)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			'' as NameFlag,
			epi.name_family || ', ' || epi.name_first || ' ' || epi.name_other as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--ef_epic_date_to_date(epi.date_of_birth)as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
    		MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type != 'MAS'

UNION

	SELECT 	2 as Flag,
			'Alpha List (Booking)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_AliasFlag(ab.entity_id) as NameFlag,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--ef_epic_date_to_date(epi.date_of_birth) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
    		MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type = 'MAS'
)

ORDER BY Flag, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AlphaPri
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ01 (Primary)
	Crystal: 		alphapri.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility. Lists the primary name only

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	  10/14/04		Created 
					R. Stuve	  12/10/04		Added header information via union query
					DLK			  12/13/04		Added Report to tree - test	ss 
					R. Stuve	  01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	  04/28/05		Added temporary_location_flag in where clause to prevent
	                							duplicate inmate entries when housed temporarily  
					R. Stuve	  06/11/05		Used ef_offender_cell function instead of linking through
												eh_housing_assignments
					R. Stuve	  06/11/05		Recompiled on OTMAIN 
					D. KUYKENDALL 01/06/06		Added mcmb_fnt_attrib_name to return the 'LEGAL JUDGEMENT 
					                            FLAG' and if true add Y to the returning data set 
					                            For Lori's use (Trust Accounting)
	
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				--'' as InmateType,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
		        '' AS LegalJgmtFlag
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
				MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
				--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"
                --mcmb_fnt_attrib_name(ep.entity_id) as flag2, --for test of attrib_name function
                decode(MACOMB.mcmb_fnt_legal_jdgmt_flg(ep.entity_id),'LEGAL JUDGEMENT FLAG', 'L', Null) as LegalJgmtFlag
                
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep



		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY FLAG, InmateName;

	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AlphaPriAli
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ02 (Primary and Alias)
	Crystal: 		alphapriali.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility. Lists the primary and alias names

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created 
					R. Stuve	12/10/04		Added header information via union query 
					DLK			12/15/04		Added to report tree test	
					R. Stuve	12/16/04		Added Alias field--same line
					R. Stuve	12/20/04		Broke out alias: each record has sep. line
					DLK			12/27/04		Added report total line removed 'active' from hdr
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
	                R. Stuve	04/28/05		Added temporary_location_flag in where clause to prevent
	                							duplicate inmate entries when housed temporarily
	                R. Stuve	06/11/05		Pulled Alias name directly instead of using function (mcmb_fnt_alias_sepline) 
	                R. Stuve	06/11/05		Compiled on OTMAIN
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary and Alias Names)' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts

		FROM	dual

		UNION ALL

		--the below query pulls back the actual report data
(
SELECT		2 as Flag,
			'Alpha List (Primary and Alias Names)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			epi.name_family || ', ' || epi.name_first || ' ' || epi.name_other as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(epi.date_of_birth)as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    		--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type != 'MAS'

UNION

	SELECT 	2 as Flag,
			'Alpha List (Primary and Alias Names)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    		--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type = 'MAS'
)

ORDER BY Flag, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AlphaPri_CRE
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRE Alpha List Primary Name (Email only - special version of mcmb_rpt_AlphaPri - no funds column - w/ dob
                     							 also Security w/ primary charge)
	Crystal: 		alphapri_CRE_EML.rpt
	Purpose:		Email Daily to Sgt Roberts and Chris.wallace@dhs.gov (pdf) Immigration and Customs Enforcement 
	                per Sgt Roberts, Lt Moore/ Jail Admin
	                Current Inmates -  Basic information
	                
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M Zak          5-8-06       Created mcmb_rpt_AlphaPri_CRE based on  mcmb_rpt_AlphaPri
					M ZAk          5-12-06      Removed Security, added Primary Charge, removed Legal Judgement too
*/
    
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as PrimaryCharge,
				--'' as SecurityClass,
				--0 as Funds,
				'' as ActiveAlerts
		        --'' AS LegalJgmtFlag
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
				MACOMB.mcmb_fnt_primarycharge(ab.booking_id),
				--EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
				--MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
                --decode(MACOMB.mcmb_fnt_legal_jdgmt_flg(ep.entity_id),'LEGAL JUDGEMENT FLAG', 'L', Null) as LegalJgmtFlag
                
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep



		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY FLAG, InmateName;

	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AntReimRel
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,
		p_EndDate		in			EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX40
	Crystal: 		ReimbAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/15/05		Created 
	                M.Zak       07/18/05        Linked to otmain 
	                M.Zak       10/4/05         Modified added release = null (eh_release)  
	                M.Zak       8-3-06          Added overlap column (True/False) mf_sent_overlap function
	*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,
				'' as Overlap
								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| MACOMB.mcmb_fnt_address_city(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_state(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				--MACOMB.mf_sent_overlap(b.booking_id) as Overlap
				MACOMB.mf_sent_overlap(b.booking_id,c.charge_id, s.sentence_start_date,s.sentence_end_date) as Overlap
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s,
                EPIC.eh_release r
            
		WHERE	b.booking_id = c.booking_id
		        and b.booking_id = r.booking_id (+)
				and c.sentence_id = s.sentence_id
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date   -- inmates not release except for weekenders (sent end date = release date)
                and r.actual_release is null 

  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AntWkEdReimRl_CRE_EML
 	(	vCur 			out		    EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	Crystal Enterprise
	Crystal: 		ReimbWkEndAntRelease_CRE_EML.rpt
	Purpose:		Used by the Reimbursement Office to list Week Ender inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement  (report is ran for the previous saturday to pickup weekender
					bookings )

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
				    M.Zak       10/3/05          Created
				    M.ZAk       5-17-06          Modified to run on CRE - predefined prev Fiday to cur Monday for Date Range
				    							 --  Emailed to Lori every Monday
				    
*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 3))); --Friday (min time) 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate))); -- Monday (max time )
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 3)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate)), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
                v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,
				'' as WeekEnderDesc
								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| MACOMB.mcmb_fnt_address_city(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_state(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				c.arrest_number as WeekEnderDesc  -- Incident/Warrant # on Booking Mgt Dialog 
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s
            
		WHERE	b.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id  
				and (MACOMB.mf_date_between(s.sentence_end_date, v_min_date,v_max_date))= 'TRUE'
				--and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date 
				--and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date
                and (MACOMB.mcmb_fnt_custody_status_code(b.booking_id) in ('4','7') or MACOMB.mcmb_fnt_inmatestatus(c.charge_id)= 'SENTENCED WEEKENDER')
   
  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
--MAZ
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AntWkEndReimRel
 	(	vCur 			out		    EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,
		p_EndDate		in			EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX41
	Crystal: 		ReimbWkEndAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list Week Ender inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement  (report is ran for the previous saturday to pickup weekender
					bookings )

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
				    M.Zak       10/3/05          Created
				    
*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,
				'' as WeekEnderDesc
								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| mcmb_fnt_address_city(b.entity_id) ||', '||mcmb_fnt_address_state(b.entity_id) ||', '||mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				c.arrest_number as WeekEnderDesc  -- Incident/Warrant # on Booking Mgt Dialog 
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s
            
		WHERE	b.booking_id = c.booking_id
		     
				and c.sentence_id = s.sentence_id
				and s.sentence_end_date >= v_min_date
				and s.sentence_end_date <= v_max_date   --  weekenders (sent end date = release date)
                and (MACOMB.mcmb_fnt_custody_status_code(b.booking_id) in ('4','7') or MACOMB.mcmb_fnt_inmatestatus(c.charge_id)= 'SENTENCED WEEKENDER')
                

  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
--MAZ
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_AwaitingPickup
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ55
	Crystal: 		awaitingpickup.rpt
	Purpose:		Used by the Jail Office to track which inmates are ready to be picked
					up by another department when his/her served time at MCJ is complete

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/28/04		Created 
					DLK			010705			ADDED TO THE TREE TEST 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/18/05		Changed HoldAgy function to PickupAgy function to
												pull correct pickup department 
					R. Stuve	04/28/05		Added decode to truncase hospital name in cell column
					R. Stuve	05/24/05		Compiled on OTMAIN
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Awaiting Pickup by Another Department)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0 as Funds,
				'' as HoldAgy,
				'' as Charge
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Awaiting Pickup by Another Department)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(EPIC.ef_offender_cell(ab.entity_id),
					'MC GENERAL', 'MCGH',
					'ST JOSEPHS WEST', 'SJWH',
					'STJOHNS SOUTH MACOMB', 'SJSM',
					'BI COUNTY', 'BICO',
					'ROYAL OAK BEAUMONT', 'ROBH',
					'TROY BEAUMONT', 'TRBH',
					'DETROIT RECEIVING', 'DRHO',
					'OTHER MEDICAL HOSPITAL', 'HOSX',
					'PSYCHIATRIC HOSPITAL', 'PSYC', EPIC.ef_offender_cell(ab.entity_id)) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_PickupAgy(c.charge_id) as Agy,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge
	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs
	
	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'AWAITING PICK UP BY ANOTHER DEPARTMENT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Bonds7Days
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_booking.start_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY03
	Crystal: 		bonds7days.rpt
	Purpose:		Used by Community Corrections to determine good candidates for petition 
					to judge(s) for early release/lowering bonds to avoid jail overcrowding
					and housing expenditures 

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/29/04		Created
					dlk			01/07/05		ADDED TO TREE TO TEST
					DLK			01/07/05		added the v_date TO SELECT 2 HEADER LINES to get the date to repeat on each page
					R. Stuve	01/31/05	    Changed 'Union' to 'Union All' and added active_booking link 
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/09/05		Changed Judge Name function to run off charge id (not booking id) 
					R. Stuve	06/22/05		Changed bonds to return from 1 to 1000 (to avoid returning $0 bonds)
					R. Stuve	06/23/05		Added statement in where clause to not return sentenced charges w/o fines 
					R. Stuve	07/05/05		Changed fees to return from 1 to 1000
*/

v_date_null 	date;
v_min_date		EPIC.eh_booking.start_date%type;
v_date_from		EPIC.eh_booking.start_date%type;
			
BEGIN  
	
v_date_null := null;
v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Over 7 Days Report' as RptTitle, 
				v_date_from as RptStart,
				'' as Judge,
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				0 as Bond,
				0 as Fine,
				v_date_null as BookingDate,
				'' as DocketNum,
				v_date_null as CourtDate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Over 7 Days Report' as RptTitle,
			v_date_from as RptStart,
		 	MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,
			EPIC.ef_offender_id(bk.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as Charge,
			to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id))as Bond,
			0 as Fine,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as DocketNum,
			EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(ch.charge_id)) as CourtDate

	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s
	
	WHERE 	ab.booking_id = bk.booking_id
			and ab.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and to_number(MACOMB.mcmb_fnt_bailamount(ch.charge_id)) between 1 and 1000
			and ch.charge_state != '6'
			and ch.charge_state != '4'
			and EPIC.ef_epic_date_to_date(bk.start_date) <= v_min_date

UNION ALL

	SELECT	2 as Flag,
		 	'Over 7 Days Report' as RptTitle,
			v_date_from as RptStart,
       		MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,
			EPIC.ef_offender_id(bk.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as Charge,
			0 as Bond,
			to_number(MACOMB.mcmb_fnt_fineamount(s.sentence_id)) as Fine,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as DocketNum,
			EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(ch.charge_id)) as CourtDate
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s
	
	WHERE 	ab.booking_id = bk.booking_id
			and ab.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and ch.charge_state = '4'
			and to_number(MACOMB.mcmb_fnt_fineamount(s.sentence_id)) between 1 and 1000
			and EPIC.ef_epic_date_to_date(bk.start_date) <= v_min_date

	ORDER BY Flag, Judge, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CaseStatus
(vCaseStatus in                EPIC.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out        EPIC.epp_generic_ref_cursor.ref_cursor)
IS
/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		CASE STATUS REPORTS COMBINED
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter
			 		Mzak        7-27-05           Addes fields to try and combine SenttoPrison(new) with Pre Arnm Cir Ct
			 		Mzak        12-21-05          Added fields needed for other Case Status reports
			 		Mzak        1-3-06            Testing query against 8 existing reports
*/

  
   	 v_date_null date;
   	 sql_stmt varchar(4000);

BEGIN  

	v_date_null := null; 
	  sql_stmt := '	SELECT	2 as Flag,
	        ''Case Status (Pre Arraignment Circuit Court)'' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,  
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			decode(EPIC.ef_offender_cell(ab.entity_id),
					'' MC GENERAL'',''MCGH'',
					''ST JOSEPHS WEST'', ''SJWH'',
					''STJOHNS SOUTH MACOMB'', ''SJSM'',
					''BI COUNTY'', ''BICO'',
					''ROYAL OAK BEAUMONT'', ''ROBH'',
					''TROY BEAUMONT'', ''TRBH'',
					''DETROIT RECEIVING'', ''DRHO'',
					''OTHER MEDICAL HOSPITAL'', ''HOSX'',
					'' PSYCHIATRIC HOSPITAL'',''PSYC'', EPIC.ef_offender_cell(ab.entity_id)) as AWPupCell,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as DocketNum,
			--cs.case_number as DocketNum,   -- replaced 1-3-06
			--decode(ca.judge_name,null,'' NO JUDGE ENTERED'',ca.judge_name) as Judge,  -- replaced 1-3-06
			decode(MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id),null,'' NO JUDGE ENTERED'',MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id)) as Judge,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
  			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,   		--MZ Pre Ar Dist Ct  
  			decode(trim(MACOMB.mcmb_fnt_inmatestatus(c.charge_id)),''PRE-ARRAIGNMENT DISTRICT'',MACOMB.mcmb_fnt_ControlAgy(c.charge_id),null) as ControlAgy, 
			--mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,     	--MZ Pre Ar Dist Ct   -- Fed Pris(old) - now US Border,ICE,Marshall
			to_number(mcmb_fnt_BailAmount(c.charge_id)) as Bond,   --MZ Pre Ar Dist Ct
			decode(trim(MACOMB.mcmb_fnt_inmatestatus(c.charge_id)),''PRE-ARRAIGNMENT DISTRICT'',MACOMB.mcmb_fnt_Holds(ab.entity_id),null) as Holds, 
			--mcmb_fnt_Holds(ab.entity_id) as Holds,                 --MZ Pre Ar Dist Ct
			c.arrest_number as WarrantNum,                        --MZ Pre Ar Dist Ct
			MACOMB.mcmb_fnt_arresttype(c.charge_id) as ArrestReason,	  --MZ Pre Ar Dist Ct
			decode(trim(MACOMB.mcmb_fnt_inmatestatus(c.charge_id)),''AWAITING PICK UP BY ANOTHER DEPARTMENT'',trim(MACOMB.mcmb_fnt_PickupAgy(c.charge_id)),null) as PupAgency, 
			--trim(MACOMB.mcmb_fnt_PickupAgy(c.charge_id)) as PupAgency,   --MZ Await p/up by another Dept  -- sub rpt to existing
		    EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,     -- Fed Pris(old) - now US Border,ICE,Marshall
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date,12,5))) as BookingTime,     -- Fed Pris(old) - now US Border,ICE,Marshall
            MACOMB.mcmb_fnt_DOB(b.entity_id) as DOB,                        -- Fed Pris(old) - now US Border,ICE,Marshall
            MACOMB.mcmb_fnt_mdoc(ab.entity_id) as MDOC,                     --Parole Violators
            MACOMB..mcmb_fnt_AlienNum(b.entity_id) as FederalID,              --Fed Pris(old) - now US Border,ICE,Marshall
            MACOMB.MCMB_fnt_wrlstime(ab.entity_id) as WRTime,                --Weekenders 12-28-05
			EPIC.ef_epic_date_to_date(b.sentence_end_date) as RlsDate,      --Weekenders 12-28-05
			MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as USControlAgy         -- added 1-03-06 needed for US reports Agency (not sorted by ControlAgy)
            
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			--eh_case_charge a,        -- removed 1-3-06
			--eh_court_appearance ca,  --removed 1-3-06
			--eh_case cs,              --removed 1-3-06
			EPIC.eh_booking b,
			EPIC.eh_entity_status e  -- ADDED LINE 12-28-05

	WHERE	b.booking_id = ab.booking_id
	        and ab.booking_id = c.booking_id
			--and c.charge_id = a.charge_id
			--and a.case_id = ca.owner_id (+)
			--and cs.case_id (+) = a.case_id 
		    --and ((MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = ''SENTENCED WEEKENDER'' or e.code_custody_status = ''4''))
		    and (MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = :1 or (MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = ''SENTENCED WEEKENDER'' or e.code_custody_status = ''4'')) 
			and c.charge_state != 6
			and b.entity_id = e.entity_id (+) ';    -- ADDED LINE 12-28-05 
			
 
If vCaseStatus =     'PRE-ARRAIGNMENT DISTRICT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, ControlAgy, Judge, Holds, InmateName ';
elsif vCaseStatus =  'POST-ARRAIGNMENT DISTRICT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, Judge, InmateName '; 	
elsif vCaseStatus =  'AWAITING PICK UP BY ANOTHER DEPARTMENT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, PupAgency, InmateName ';
elsif vCaseStatus =  'SENTENCED WEEKENDER' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, RlsDate, WRTime, InmateName ';  -- ADDED LINE 12-28-05 
else sql_stmt :=  sql_stmt || 'ORDER BY Flag,InmateName ';
end if;
	
			

 OPEN vCur FOR sql_stmt using vCaseStatus;	
 EXECUTE IMMEDIATE sql_stmt using vCaseStatus; 
  
 END; 
 
 
  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CaseStatus_sort
	(vCaseStatus in            EPIC.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.
	Crystal: 		****.rpt
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter
			 		Mzak        7-27-05           Addes fields to try and combine SenttoPrison(new) with Pre Arnm Cir Ct
			 		Mzak        12-21-05          Added fields needed for other Case Status reports
*/
v_exec_tx VARCHAR2(2000); 


   	 v_date_null date;
BEGIN 
	v_date_null := null;

 v_exec_tx := 'SELECT	2 as Flag,
			char(39)Case Status (Pre Arraignment Circuit Court)cahr(39) as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,  
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
		    MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
  			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,   		--MZ Pre Ar Dist Ct
			MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,     	--MZ Pre Ar Dist Ct   -- Fed Pris(old) - now US Border,ICE,Marshall
			to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bond,   --MZ Pre Ar Dist Ct
			MACOMB.mcmb_fnt_Holds(ab.entity_id) as Holds,                 --MZ Pre Ar Dist Ct
			c.arrest_number as WarrantNum,                        --MZ Pre Ar Dist Ct
			MACOMB.mcmb_fnt_arresttype(c.charge_id) as ArrestReason,	  --MZ Pre Ar Dist Ct
			--MACOMB.mcmb_fnt_PickupAgy(c.charge_id) as PupAgency          --MZ Await p/up by another Dept  -- sub rpt to existing
		    EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,     -- Fed Pris(old) - now US Border,ICE,Marshall
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date,12,5))) as BookingTime,     -- Fed Pris(old) - now US Border,ICE,Marshall
            MACOMB.mcmb_fnt_DOB(b.entity_id) as DOB,                        -- Fed Pris(old) - now US Border,ICE,Marshall
            MACOMB.mcmb_fnt_mdoc(ab.entity_id) as MDOC                     --Parole Violators
            
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs,
			EPIC.eh_booking b

	WHERE	b.booking_id = ab.booking_id
	        and ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = vCaseStatus 
			and c.charge_state != 6   ';    -- removed ;  
			
	--char(39)PRE-ARRAIGNMENT CIRCUIT COURTchar(39)		
			
--  v_exec_tx := 'begin p_auto_'||ci.doc_state_id||'('||cdi.doc_id||'); end;';
			

     --ORDER BY Flag, InmateName; --v_sort_order;

  
  begin
    if vCaseStatus =  'PRE-ARRAIGNMENT DISTRICT' then
      v_exec_tx :=  v_exec_tx || 'ORDER BY Flag, ControlAgy, Judge, InmateName; ';
	else
	v_exec_tx :=  v_exec_tx || 'ORDER BY Flag, InmateName; ';
 	end if;
 	 EXECUTE IMMEDIATE (v_exec_tx);
end;
  
  
  


  
 END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CCBooking
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor)  
	 	
IS

/*	Form Usage: 	CRSTL.XX20
	Crystal: 		CirCrtBooking.rpt
	Purpose:		Used by the Circuit Court Administrator to list all inmates physically at MCJ
					with unsentenced charges pending in the Circuit Court. Run monthly to submit to 
					the State of Michigan for Speedy Trial report

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/14/05		Created 
	                M. Zak      07/18/05        Linked to otmain 
*/
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Circuit Court Booking' as RptTitle,
				'' as InmateName,
				'' as CaseNumber,
				'' as JudgeName,
				v_date_null as BookingDate
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Circuit Court Booking' as RptTitle,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNumber,
				EPIC.ef_lookup_text('JUDGE NAME',MACOMB.mcmb_fnt_JudgeName_chargeid(c.charge_id),'UC') as JudgeName,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate

		FROM	EPIC.eh_booking b,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge c,
				EPIC.eh_muster m
		
		WHERE	ab.booking_id = b.booking_id
				and b.booking_id = c.booking_id
				and b.entity_id = m.entity_id
				and m.in_muster_flag = 'Y'
				and c.charge_state <> '4' --not sentenced
				and c.charge_state <> '6' --not disposed
				and (
			 			MACOMB.mcmb_fnt_CourtName(c.charge_id) = '16TH CIRCUIT COURT' or
			  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = 'MACOMB COUNTY FRIEND OF THE COURT'
			  		)


ORDER BY Flag, JudgeName, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CCUtilization
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_charge.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX53
	Crystal: 		JailUtilCrctCt.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/04/05		Created  
					M. Zak      04/26/05        Crystal Report completed
					R. Stuve	05/03/05		Added FOC in where clause
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/15/05		Commented Charge field to increase query speed (this field is not needed)
												but inserted 'dummy' field to prevent Crystal re-work
                   	M.Zak       09-26-05        Modified   Added 31, 32, 33 'US - BORDER PATROL','US - MARSHALL SERVICE'
					                            'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                             Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)   							
												
*/

        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by Circuit Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by Circuit Court' as RptTitle,
			v_date_from as RptStart,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,  
			'DUMMY' as Charge,
			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		MACOMB.mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(MACOMB.mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',  -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	EPIC.eh_booking b,
	        EPIC.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and MACOMB.mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and c.offense_date <= v_min_date
	  		and (b.end_date is null
	  				or b.end_date > v_min_date)
	  		and (
	  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = '16TH CIRCUIT COURT' or
	  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = 'MACOMB COUNTY FRIEND OF THE COURT'
	  			)

ORDER BY Flag, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CCUtilization_CRE
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor) 
 	
IS


/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		JailUtilCrctCt_CRE.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-12-05        Created - Report ran through CRE (JailUtilCrctCt_CRE.rpt)
	                DLK         03-16-06        ADDED EPIC AND MACOMB NOTATION
*/

        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate))); -- Sysdate for CRE report 
        v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate)), EPIC.ef_date_format),1,100);
		
		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by Circuit Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by Circuit Court' as RptTitle,
			v_date_from as RptStart,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,  
			'DUMMY' as Charge,
			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		MACOMB.mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(MACOMB.mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',  -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	EPIC.eh_booking b,
	        EPIC.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and MACOMB.mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and EPIC.ef_epic_date_to_date(c.offense_date) <= v_min_date
	  		and (EPIC.ef_epic_date_to_date(b.end_date) is null
	  				or EPIC.ef_epic_date_to_date(b.end_date) > v_min_date)
	  		and (
	  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = '16TH CIRCUIT COURT' or
	  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = 'MACOMB COUNTY FRIEND OF THE COURT'
	  			)

ORDER BY Flag, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CellList
(	vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ14
	Crystal: 		celllist.rpt
	Purpose:		Lists basic demographics for all inmates housed in MCJ.  Sorted by floor/cell location.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/06/04		Created 
					R. Stuve	12/13/04		Added header information via union query
					DLK			12/13/04		Added to the report tree - test	
	                R.Stuve		12/13/04		Changed ActiveAlert function from 'full' to 'trunc'
	                R.Stuve		12/28/04		Changed DOB from string type to date type
	                R.Stuve		01/19/05		Added Charge to query
	                DLK			01/19/05		Added Report Title to 2nd Union so title would generate to all pages
	                R. Stuve	01/31/05		Changed 'Union' to 'Union All'
	                R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting 
	                R. Stuve	05/24/05		Compiled on OTMAIN  
	               R. Stuve		07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance
					DLK         03/16/05        ADDED MACOMB AND EPIC SCHEMA							
*/             

v_date_null date;
	
BEGIN

v_date_null := null;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Cell List' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Charge,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT
        	2 as Flag,
        	'Cell List' as RptTitle,
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName, 
			MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
        	  	--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
	
	ORDER BY Flag, Floor, Sort, Cell;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_CellListTrustees
 	(	vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ15
	Crystal: 		CellListTrusteesOnly.rpt
	Purpose:		Lists basic demographics for all trustees housed in MCJ.  Sorted by floor/cell location.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/22/05		Created  
					DLK			05/01/05		Begin devl Crstl - for test 
												upload to tree for staff test
					R. Stuve	05/13/05		Deleted Bin field & added Category field
					R. Stuve	05/24/05		Compiled on OTMAIN
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance
					DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	04/06/06		Commented DOB as not used on report
					R. Stuve	12/27/06		Added custody status 65 (Pre-Kitchen Trustee) to WHERE clause (per SRF 11943)
	
*/

v_date_null date;
	
BEGIN

v_date_null := null;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Cell List (Trustees Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Charge,
				'' as Floor,
				'' as Sort,
				'' as Cell,
			--	v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
				'' as Category
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT
        	2 as Flag,
        	'Cell List (Trustees Only)' as RptTitle,
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName, 
			MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
        	  	--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			--MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin, --not needed on this report 05/13/05 RAS
		 --	EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
				--the below line displays the Trustee status (Kitchen, Garage, Special)
			decode(e.code_custody_status,'6','K',
										 '9','G',
										 '10','S',
										 '65','P') as Category 
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab,
			EPIC.eh_entity_status e
			
	WHERE 	ha.entity_id (+) = ab.entity_id
			AND e.entity_id = ab.entity_id
			AND e.code_custody_status in ('6','9','10','65')
		
	
	ORDER BY Flag, Floor, Sort, Cell;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Charge999
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor)  
	 	
IS

/*	Form Usage: 	CRSTL.ZZ56
	Crystal: 		charge999.rpt
	Purpose:		Used by the Jail Office to list which inmates have been booked with 
					a 'generic' charge (999.xxx)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/26/05		Created 
					dlk			01/26/05		devl begins
	                R. Stuve	01/31/05		Changed 'Union' to 'Union All'
	                dlk			02/02/05		added to tree for test
	                R. Stuve	05/28/05		Compiled on OTMAIN
	                DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA
*/
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'CHARGE(S) 999 CODE' as RptTitle,
				'' as InmateName,
				'' as InmateNum,
				v_date_null as BookingDate,
				'' as ChargeNum,
				'' as ChargeDesc
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'CHARGE(S) 999 CODE' as RptTitle,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
        		MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeDesc

		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.epic_statutes s

		WHERE	b.booking_id = c.booking_id
				and c.statute_id = s.statute_id
				and c.charge_state <> '6'
				and s.statute_number like '999%'

ORDER BY Flag, InmateName, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ChargedBookFees
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.trans_date%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.trans_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY55
	Crystal: 		chrgdbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were charged during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					dlk			01/28/05		report devl to test 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					dlk			02/02/05		added to tree for test (inp)
								02/07/05		finalized req Crystal on tree 
					R. Stuve	02/28/05		Added Reversal field to indicate transaction reversals
					R. Stuve	05/28/05		Compiled on OTMAIN
	                DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA NOTATIONS
	
*/
        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_max_date		EPIC.eh_trans_distribution.trans_date%type;  
     	v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		v_date_to		EPIC.eh_trans_distribution.trans_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Charged Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency,
				'' as Reversal
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Charged Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				decode(tat.code_source_of_funds,'502','C','503','S') as Agency,
				tat.reverse_flag as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat


		WHERE	t.trust_account_id = tat.trust_account_id
				and (code_source_of_funds = '502'
					or code_source_of_funds = '503')
				and EPIC.ef_epic_date_to_date(tat.trans_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(tat.trans_date) < v_max_date

ORDER BY Flag, Agency, InmateNum, TDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Class5P
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRSTL.XX07
	Crystal: 		class5p.rpt
	Purpose:		Used by Classification: An inmate appears on this report once he/she
					is sentenced on all charges and his/her classification is 'Medium Present'.
					This report is used to help determine inmate location moves

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/17/05		Created
					DLK			02/23/05		Added to report tree test
					R. Stuve	05/06/05		Modified where clause to discount disposed charges
					R. Stuve	05/28/05		Compiled on OTMAIN
					DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA INFO
					
*/
		v_date_null	date;									
			
BEGIN  
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Sentenced 5p on All Charges' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				v_date_null as ReleaseDate					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data														
	SELECT	distinct 2 as Flag,
			'Sentenced 5p on All Charges' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
	       	EPIC.ef_offender_cell(ab.entity_id) as Cell,
	       	EPIC.ef_epic_date_to_date(bk.final_release_date) as ReleaseDate 
	       		--date the inmate physically gets out of jail
	
	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_booking bk,
			EPIC.eh_charge c

	WHERE	ab.booking_id = bk.booking_id
			and ab.booking_id = c.booking_id
			and c.charge_state != '6'
			and EPIC.ef_get_Security_Class(ab.entity_id) = '04'
			and MACOMB.mcmb_fnt_SentAllChgs(ab.entity_id) = 'S'
			and MACOMB.mcmb_fnt_SenttoPrison(ab.booking_id) <> 'P'
				--exclude anyone who has been sentenced to prison

ORDER BY Flag, InmateName;

END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyIncar
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.****
	Crystal: 		*****.rpt
	Purpose:		THIS PROCEDURE IS NO LONGER USED.  THE PROCEDURES USED FOR THIS REPORT ARE
					MCMB_RPT_DAILYINCAR1 AND MCMB_RPT_DAILYINCAR2

	Author:			Rachel Stuve     
	                 DLK         03/16/06          ADDED MACOMB AND EPIC SCEMA INFO
				
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				v_date_null as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		EPIC.ef_epic_date_to_date(pi.date_of_birth) as DOB,
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			ep.juvenile_flag as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd,
  			decode(to_char(substr((EPIC.ef_epic_date_to_date(b.start_date)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

	FROM  	EPIC.eh_booking  b,
  			EPIC.eh_person_identity pi,
  			EPIC.eh_entity_person ep

	WHERE  	pi.entity_id = b.entity_id
			and pi.entity_id = ep.entity_id
  			AND DECODE(pi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyIncar1
 (	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_main.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				v_date_null as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,           
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(b.entity_id)) as DOB,
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd
  			
	FROM  	EPIC.eh_booking  b

	WHERE  	EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyIncar1_CRE_EML
 (	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 

	 	
IS

/*	           
	Form Usage:		Crystal Enterprise    
	Crystal:        DailyInc_Main_CRE_EML.RPT
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					MAZ	        5-17-06         Modified report to run previous day on CRE
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  
		
		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_null := null;  
				
		--set value for variables used in query		
		

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				v_date_null as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,           
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(b.entity_id)) as DOB,
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd
  			
	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyIncar2
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
	    p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_sub.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyIncar2_CRE_EML
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 
	 	
IS

/*	           
	Form Usage:		Crystal Enterprise    
	Crystal:        DailyInc_sub_CRE_EML.RPT
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA
					MAZ	        5-17-06         Modified report to run previous day on CRE
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
      		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyRelease
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_charge.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY21
	Crystal: 		dailyrelease.rpt
	Purpose:		Used by the Jail Office to list which inmates have already been physically 
					released on the selected date (Actual Release Date = <input date>)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/18/05		Created 
					M. Zak		04/21/05		Linked Crystal Report to Tree
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/16/05		Added the Classified field   
					R. Stuve	06/24/05		Added Join to charge table to include releases with no associated charges 
					DLK         03/17/06        ADDED EPIC AND MACOMB SCHEMA NOTATION
	
*/
        v_min_date		EPIC.eh_charge.action_time%type;   
     	v_date_from		EPIC.eh_charge.action_time%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Daily Release(s)' as RptTitle,
				v_date_from as RptStart,
		        v_date_null as BookingDate,
				'' as BookingTime,
				'' as InmateNum,
				'' as Classified,
				'' as InmateName,
				'' as Cell,
				'' as Gender,
				v_date_null as ReleaseDate,
				'' as ReleaseTime,
				'' as ReleaseNotes,
				'' as ReleaseType,
				'' as StatuteNumber,
				'' as StatuteText
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Daily Release(s)' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				substr(EPIC.ef_epic_date_to_date(b.start_date),12,5) as BookingTime,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				MACOMB.mcmb_fnt_ClassYN(b.booking_id) as Classified,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_offender_cell(b.entity_id) as Cell,
				MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
					--above line only for testing: doesn't need to be displayed
				substr(EPIC.ef_epic_date_to_date(r.actual_release),12,5) as ReleaseTime,
				MACOMB.mcmb_fnt_ReleaseNotes(r.booking_id) as ReleaseNotes,
					--from the Release Screen: text associated with the Release Notes button
		        MACOMB.mcmb_fnt_releasetype(b.booking_id) as ReleaseType,
       		 	MACOMB.mcmb_fnt_statutenumber(c.charge_id) as StatuteNumber,
        		MACOMB.mcmb_fnt_statutetext(c.charge_id) as StatuteText


		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_release r
		
		WHERE	c.booking_id (+) = b.booking_id
				and b.booking_id = r.booking_id
				and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(r.actual_release)) = v_min_date


ORDER BY Flag, ReleaseDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DailyRelease2
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type)
		
IS

/*	           
	Form Usage: 	CRSTL.YY21
	Crystal: 		dailyrelease_sub.rpt
	Purpose:		Used by the Jail Office to list which inmates have already been physically 
					released on the selected date (Actual Release Date = <input date>)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak 	    10-5-05		    Created
                    M.Zak       10-18-05        Corrected Summary - was pulling back counts per charges not bodies    
                    DLK         03/17/06        ADDED THE MACOMB AND EPIC SCHEMA NOTATION
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count
  
  		FROM	EPIC.eh_booking b,
				-- 10-18-05 MAZ removed eh_charge c,
				EPIC.eh_release r
		
		    	-- 10-18-05 MAZ removed c.booking_id (+) = b.booking_id
		WHERE   b.booking_id = r.booking_id
				and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(r.actual_release)) =  v_min_date
    
group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DCUtilization
 (	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_charge.action_time%type)

IS

/*	Form Usage: 	CRSTL.XX54
	Crystal: 		JailUtilDistCt.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered
					into the system first

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/04/05		Created
					M. Zak      04/26/05        Crystal Report completed
					R. Stuve	05/03/05		Added FOC in where clause
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/15/05		Commented Charge field to increase query speed (this field is not needed)
												but inserted 'dummy' field to prevent Crystal re-work
                   	M.Zak       09-26-05        Modified   Added 31, 32, 33 'US - BORDER PATROL','US - MARSHALL SERVICE'
					                            'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                             Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)
					DLK         03/17/06         ADDED EPIC AND MACOMB SCHEMA NOTATION

*/

        v_min_date		EPIC.eh_trans_distribution.trans_date%type;
		v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail

BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);

	OPEN vCur FOR
        --the below query pulls back the header information
		SELECT	1 as Flag,
				'Jail Utilization by District Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status

		FROM	dual

	UNION ALL
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by District Court' as RptTitle,
			v_date_from as RptStart,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,
			'DUMMY' as Charge,
			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		MACOMB.mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(MACOMB.mcmb_fnt_ChargeStatusCode(c.charge_id, EPIC.epicdate(v_min_date)), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',   -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
			and MACOMB.mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and EPIC.ef_epic_date_to_date(c.offense_date) <= v_min_date
	  		and (EPIC.ef_epic_date_to_date(b.end_date) is null
	  				or EPIC.ef_epic_date_to_date(b.end_date) > v_min_date)
	  		and MACOMB.mcmb_fnt_CourtName(c.charge_id) not like '%CIRCUIT%'
  			and MACOMB.mcmb_fnt_CourtName(c.charge_id) != 'MI DEPT OF CORR'
  			and MACOMB.mcmb_fnt_CourtName(c.charge_id) != 'MACOMB COUNTY FRIEND OF THE COURT'

ORDER BY Flag, Court, Judge, Status;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DCUtilization_CRE
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor)

IS


/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		JailUtilDistCt_CRE.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-12-05        Created - Report ran through CRE (JailUtilCrctCt_CRE.rpt)
					DLK         03/17/06        ADDED THE MACOMB AND EPIC SCHEMA NOATION
	
*/

        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate))); --sysdate vs prompt date
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate)), EPIC.ef_date_format),1,100);

		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by District Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by District Court' as RptTitle,
			v_date_from as RptStart,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			--MACOMB.mcmb_fnt_DrvChg(b.entity_id) as Charge,
			'DUMMY' as Charge,
			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		MACOMB.mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(MACOMB.mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',   -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	EPIC.eh_booking b,
	        EPIC.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and MACOMB.mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and EPIC.ef_epic_date_to_date(c.offense_date) <=  v_min_date
	  		and (EPIC.ef_epic_date_to_date(b.end_date) is null
	  				or  EPIC.ef_epic_date_to_date(b.end_date) >  v_min_date)
	  		and MACOMB.mcmb_fnt_CourtName(c.charge_id) not like '%CIRCUIT%'
  			and MACOMB.mcmb_fnt_CourtName(c.charge_id) != 'MI DEPT OF CORR'
  			and MACOMB.mcmb_fnt_CourtName(c.charge_id) != 'MACOMB COUNTY FRIEND OF THE COURT'

ORDER BY Flag, Court, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_DoubleBin
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ83
	Crystal: 		DoubleBin.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have MORE then 1 property bin or
					inmates that have been released and still have a property bin listed

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created   
					DLK			05/31/05		Crystal rpt created/uploaded to test 
					R. Stuve	06/06/05		Compiled on OTMAIN   
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Double/Released Property Bins' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Ibin,
				'' as Icell,
				'' as CurrentBin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Exception: Double/Released Property Bins' as RptTitle,
				EPIC.ef_offender_id(op.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(op.entity_id) as InmateName,
			  	pb.bin_number as Ibin,
			  	EPIC.ef_Offender_Cell(op.entity_id) as Icell,
			  	MACOMB.mcmb_fnt_alphabin_current(op.entity_id) as CurrentBin

		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op

		WHERE	pb.bin_id = pi.bin_id
 				and op.item_id = pi.item_id
 				and (MACOMB.mcmb_fnt_alphabin_current(op.entity_id) <> pb.bin_number or EPIC.ef_Offender_Cell(op.entity_id) = '-No Cell-')

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ExceedMaxPop
 (vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY22
	Crystal: 		ExceedMaxPop.rpt
	Purpose:		Used by the Administration/Judges to list all inmates with at least one sentenced
					charge for purposes of sentence reduction to reduce jail overcrowding

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/05		Created  
					R. Stuve	05/28/05		Compiled on OTMAIN 
					R. Stuve	07/08/05		Added lookup on Judge field to return entire name
					M. Zak      09/02/05        Added Pay/or Stay sentence information - removed weeks (not needed per Glenn)   
					DLK         03/17/06
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exceed Max Population' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as FM,
				'' as PA325,
				'' as ChargeNum,
				'' as ChargeText,
				'' as Judge,
				'' as CaseNum,
				0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentStart,
				v_date_null as SentEnd, 
				0 as Bail,
		        '' as FineAmt,
		        '' as BailPaid,
		        '' as PercentBail,
		        '' as Status,  
		        v_date_null as PdOutDate, 
		        v_date_null as UnPdOutDate
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
				'Exceed Max Population' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
				MACOMB.mcmb_fnt_FelMisd(c.charge_id) as FM,
				MACOMB.mcmb_fnt_StatuteCategory(c.charge_id) as PA325,
				MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
				MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeText,
				EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(c.charge_id),'UC') as Judge,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNum,
    		    sd.years as SentYears,
	    	   	sd.months as SentMonths,
		     	--sd.weeks as SentWeeks,  -- not needed per Glenn
		    	sd.days as SentDays,				-- MAZ added below PSentYears, Mnths, Days 9-2-05
		    	(select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id      
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        --(select sd.weeks from eh_sentence_fine sf,eh_sentence_duration sd
		        --  		where s.sentence_id = sf.sentence_id
			    --     		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			    			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentEnd,
				to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bail,
		        MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,           -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_BailPaid(c.charge_id) as BailPaid,              -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_percentbail(c.charge_id) as PercentBail,        -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as Status,            -- MAZ added 9-2-05
		        EPIC.ef_epic_date_to_date(so.paid_out_date) as PdOutDate,     -- MAZ added 9-2-05
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as UnPdOutDate  -- MAZ added 9-2-05
				
		FROM    EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_charge c,
				EPIC.eh_active_booking ab,
				EPIC.eh_sentence_out_dates so -- MAZ added 9-2-05
		
		WHERE  	ab.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  -- MAZ added 9-2-05
				and s.duration_id = sd.sentence_duration_id (+)
				and c.charge_state <> '6'
				and MACOMB.mcmb_fnt_SentOneChg(ab.entity_id) = 'S'

ORDER BY Flag, Judge, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE        mcmb_rpt_FaceSheetBook
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		InmateFaceSheetBK_sub.rpt (Sub Report: Part 2 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created 
					R. Stuve	07/12/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field 
					M.Zak       8/10/05         Added Paid Outdate, Unpaid Outdate
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	03/23/06		Modified per commments
					R. Stuve	11/31/06		Added Next Court Date (per SRF 12791)
					
					
*/
    v_date_null	date;
				
BEGIN 

v_date_null := null;

	OPEN vCur FOR
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mf_NextCourtDate_Charge(ch.charge_id) as NextCourtDate, 
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	sd.years as SentYears,
		   	sd.months as SentMths,
		   	sd.weeks as SentWeeks,
		   	sd.days as SentDays,
		   	(select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    MACOMB.mf_SntEdcRl(s.sentence_id) as SntEdcRls,	--RAS: added 3/23/06
		    MACOMB.mf_SntFine(s.sentence_id) as SntFine,  --RAS: added 3/23/06
		    MACOMB.mf_SntMiscInfo(s.sentence_id) as SntMiscInfo,  --RAS: added 3/23/06
		    MACOMB.mf_WknRlsTm(s.sentence_id) as SntWorkRlsTime,   --RAS: added 3/23/06
		    MACOMB.mf_SntWrkSk(s.sentence_id) as SntWorkSeek,    --RAS: added 3/23/06		    
		    MACOMB.mf_SntWrkRlsG (s.sentence_id) as WorkRlsGrnt,    --RAS: added 3/23/06
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    MACOMB.mf_bailcrtdsp(ch.charge_id) as BailCourtDispo,  --RAS: added 3/23/06  
		    MACOMB.mf_BailMayBeRls(ch.charge_id) as BailMayRls,	   --RAS: added 3/23/06
		    MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status, 
		    bk.entity_id as EntityId, 
		    EPIC.ef_epic_date_to_date(so.paid_out_date) as PdOutDate,   -- MAZ testing
		    EPIC.ef_epic_date_to_date(so.unpaid_out_date) as UnPdOutDate  -- MAZ testing
            
	
	FROM   	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd, 
			EPIC.eh_sentence_out_dates so, -- MAZ testing
			EPIC.eh_release r
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.sentence_id = so.sentence_id (+)  -- MAZ testing
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and ch.charge_state <> '6'
			and bk.entity_id = p_InmateID
		
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc;
END;
/

CREATE OR REPLACE
PROCEDURE        mcmb_rpt_FaceSheetDemo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		InmateFaceSheet_Main.rpt (Main Report: Part 1 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created  
					R. Stuve	07/05/05		Changed where clause to link on primary_identity_id
												instead of entity_id to avoid duplicate record returns 
					R. Stuve	07/11/05		Added Funds field for inmate's current available funds        
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION  
					R. Stuve	03/24/06		Modified Keep Separate logic (per comments)
					
*/
    v_date_null	date;
				
BEGIN 

v_date_null := null;

	OPEN vCur FOR
			SELECT 	EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_inmatefunds(ep.entity_id) as Funds,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			to_date(MACOMB.mcmb_fnt_ReviewDate(ep.entity_id)) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.primary_identity_id = epi.identity_id
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			0  as Funds,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			v_date_null as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id 
			and (ks.end_date is null or EPIC.ef_epic_date_to_date(ks.end_date) > sysdate)  --RAS: added 3/24/06 to filter only active keep seperates
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			0  as Funds,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			v_date_null as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and (ks.end_date is null or EPIC.ef_epic_date_to_date(ks.end_date) > sysdate)  --RAS: added 3/24/06 to filter only active keep seperates
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE        mcmb_rpt_FaceSheetHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		InmateFaceSheetHd_sub.rpt (Sub Report: Part 3 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	03/23/06		Misc edits per SRF 11966
					
*/
				
BEGIN 

	OPEN vCur FOR
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--bh.code_charge_severity as Severity, --not needed 3/23/06 per K.Roberts
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber, 
			MACOMB.mf_HoldCourt(bh.hold_id) as HoldCourt,   --added 3/23
			MACOMB.mf_HoldInfo(bh.hold_id) as HoldInfo		--added 3/23

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk

	WHERE	bk.booking_id = bh.booking_id
			and (bh.hold_removed_date is null
					or EPIC.ef_epic_date_to_date(bh.hold_removed_date) < EPIC.ef_epic_date_to_date(sysdate))
			and bk.entity_id = p_InmateID;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_FedPris
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ49
	Crystal: 		FederalPrisoners.rpt
	Purpose:		Used by the Jail Office to report statistics to the state/fed regarding the
					number of Federal inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/28/05		Created    
					R. Stuve	05/13/05		Added DOB and FederalID placeholder for future
												federal requirements 
					R. Stuve	05/24/05		Compiled on OTMAIN
					R. Stuve	06/09/05		Changed Controlling Agency to pull from charge id (not booking id) 
					M Zak       09-20-05        Remove Status check with Booking Id, Add - 3 Fed charge status;
					                            'US - BORDER PATROL','IMMIGRATION/NATURALIZATION SERVICE','US - MARSHALL SERVICE'
					                            (Eventually FEDERAL PRISONER will be end dated - per Sgt Roberts)
                   	M.Zak       09-26-05        Modified   Added 'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                                       Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)   
					M.Zak       03-06-06        Removed Booking Date and Time per Sgt Roberts
												Removed eh_Booking table 
												Change AGY to bring back GA attribute value 
				    DLK         03/17/06        ADDED THE MACOMB AND EPIC SCHEMA NOTATION                                    			
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Case Status (Federal Prisoners)' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Agy,
				'' as Cell,
				'' as Bin,
				'' as DOB,
				'' as FederalID,
		        v_date_null as OffDate  -- offense date
		        
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Case Status (Federal Prisoners)' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
--				mcmb_fnt_ControlAgy(c.charge_id) as Agy,
                MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as Agy,   -- Per Sgt Roberts bring attrib value vs Agy
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				MACOMB.mcmb_fnt_DOB(ab.entity_id) as DOB,  
				MACOMB.mcmb_fnt_AlienNum(ab.entity_id) as FederalID,  
				EPIC.ef_epic_date_to_date(c.offense_date) as offdate  --offense date  -- used instead of booking per Sgt Roberts 3-1-06
				
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c
		
		WHERE	ab.booking_id = c.booking_id
				and c.charge_state != 6
				and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) in ('FEDERAL PRISONER','IMMIGRATION/NATURALIZATION SERVICE','US - BORDER PATROL','US - MARSHALL SERVICE','US - IMMIGRATION & CUSTOM ENFORCEMENT')
		        		
		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_FedPrisoners_fin
 (	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY73
	Crystal: 		FedPrisoners_Fin.rpt
	Purpose:		Used by Finance to list FEDERAL PRISONERS total days (total days * daily rate)
	                within a specfied month period  (* This report was desgined to track  
	                federal inmates that do not use the charges; US - BORDER PATROL (added code 8-24-05), 
	                US - MARSHALL SERVICE(added code 8-24-05), and IMMIGRATION/NATURALIZATION SERVICE. 
	                
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-31-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay)  
					DLK         03/17/06        ADDED THE MACOMB AND EPIC NOTATION 
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC. eh_booking.start_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - Federal Prisoners' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate,
				'' as ControlAgy
				--'' as Charge
				
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 
SELECT	2 as Flag,
			'Finance - Federal Prisoners' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate,
       		MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy  -- added 9-14-05 
            --MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge   -- added 9-14-05 not sure if needed mzak
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'FEDERAL PRISONER'  
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheet
	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		EPIC.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ11 (production)/ ZZ30 (test)
	Crystal: 		floorsheet.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query
					R.Stuve		12/14/04		Added Floor prompt ($LocID$) via v_floor variable
					dlk			01/19/05		Added to report tree to test added rpt title and floor info
												to union 2 
					R. Stuve  	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting 
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION							
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := EPIC.ef_location_path_name(p_Floor, 'UC', 5);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				--v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,   --RAS (3/29/06): not used on report 
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheettest
	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		EPIC.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ11
	Crystal: 		***.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query
					R.Stuve		12/14/04		Added Floor prompt ($LocID$) via v_floor variable
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := EPIC.ef_location_path_name(p_Floor, 'UC', 5);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ep.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(bk.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_full(bk.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		AND ep.entity_id = ab.entity_id
			AND  bk.booking_id = ab.booking_id
			AND epi.entity_id = ab.entity_id
			AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			AND substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheet_class
 	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		EPIC.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ16
	Crystal: 		floorsheetclass.rpt
	Purpose:		Used by Classification to list all inmates in the MCJ. Some additional fields
					from the 'regular' floor sheet that pertain only to Classification

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/10/05		Created 
					R. Stuve	05/10/05		Crystal report created and linked to tree
					R. Stuve	05/24/05		Compiled on OTMAIN 
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION 							
	
*/  

		v_floor		varchar2(64);	   

BEGIN

		v_floor := EPIC.ef_location_path_name(p_Floor, 'UC', 5);

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet (Classification)' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as Interview,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet (Classification)' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
        	MACOMB.mcmb_fnt_Interview(ab.booking_id) as Interview,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort, 
				--don't need to display on report: for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    
    FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab

	WHERE 	ha.entity_id (+) = ab.entity_id
			AND substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheet_CRE_stn2
	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		floorsheet_CRE_stn2.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-11-05        Created - Report ran through CRE (floorsheet_CRE.rpt)   
					DLK         03/17/06        ADDED EPIC AND MACOMB NOTATION
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := 'STATION 2'; 
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheet_CRE_stn3
	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		floorsheet_CRE_stn3.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-11-05        Created - Report ran through CRE (floorsheet_CRE.rpt) 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := 'STATION 3'; 
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_floor_sheet_trustees
	(	vCur		out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		EPIC.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ13
	Crystal: 		floortrustee.rpt
	Purpose:		Used by Inmate Funds to list all inmates with Trustee status only housed on the specified floor(s)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/14/04		Created 
					dlk			01/11/05		Added to tree added title and floor info for header   
					DLK			01/18/05		Cont. dev. in CRYSTAL  to test 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting  
					R. Stuve	04/23/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
					R. Stuve	04/06/06		Commented DOB as not needed on report
					R. Stuve	12/15/06		Added custody status 65 (Pre-Kitchen Trustee) to WHERE clause (per SRF 11943)
			
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := EPIC.ef_location_path_name(p_Floor, 'UC', 5);    
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet Trustees'  as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
			 --	v_date_null as DOB,
				'' as SecurityClass,
				0  as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet Trustees' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(case	when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort, 
        		--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab,
			EPIC.eh_entity_status e
			
	WHERE 	ha.entity_id (+) = ab.entity_id 
    		AND e.entity_id = ab.entity_id
			AND substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
			AND e.code_custody_status in ('6','9','10', '65')
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ForeignBorn
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY33
	Crystal: 		foreignborn.rpt
	Purpose:		Used by the Administration (for grant/funding purposes) to return all 
					inmates booked during the time period with a birth country other than
					USA (regardless of current citizenship)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/21/04		Created  
					dlk			12/27/04		added to tree test 
					dlk         01/07/05		Added the v_date to get the date to repeat in the select 2 lines on each page
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION
					
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Foreign Born Inmates' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InnmateNum,
				'' as BirthCountry,
				'' as Cell
			
		FROM	dual
		
	UNION ALL		
		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Foreign Born Inmates' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
     		EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_birthcountry(b.entity_id) as BirthCountry,
			EPIC.ef_offender_cell (b.entity_id) as Cell

FROM 	EPIC.eh_booking b,
		EPIC.eh_housing_assignments ha,
		EPIC.eh_person_identity p

WHERE	ha.entity_id (+) = b.entity_id
		and p.entity_id = b.entity_id
		and EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
		and p.birth_country != 'US'
		and p.code_name_type =  'MAS'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ForeignBorn_CRE
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		foreignborn_CRE.rpt
	Purpose:		Used by the Administration (for grant/funding purposes) to return all 
					inmates booked during the time period with a birth country other than
					USA (regardless of current citizenship)


	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-12-05        Created - Report ran through CRE (JailUtilCrctCt_CRE.rpt) 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION
	
*/
					
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Foreign Born Inmates' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InnmateNum,
				'' as BirthCountry,
				'' as Cell
			
		FROM	dual
		
	UNION ALL		
		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Foreign Born Inmates' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
     		EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_birthcountry(b.entity_id) as BirthCountry,
			EPIC.ef_offender_cell (b.entity_id) as Cell

FROM 	EPIC.eh_booking b,
		EPIC.eh_housing_assignments ha,
		EPIC.eh_person_identity p

WHERE	ha.entity_id (+) = b.entity_id
		and p.entity_id = b.entity_id
		and EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
		and p.birth_country != 'US'
		and p.code_name_type =  'MAS'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ForenExOrd
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		ForenExOrd.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report     
					DLK           03/17/06       ADDED MACOMB AND EPIC NOTATION
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Forensic Exam Ordered)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Forensic Exam Ordered)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'FORENSIC EXAM ORDERED'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_FundsDailyAct
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_trust_account_trans.trans_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY20
	Crystal: 		fundsdailyact.rpt
	Purpose:		Used by the Inmate Funds/Accounting to list all inmate financial
					transactions completed for the selected date/date range. 
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/19/05		Created  
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'    
					DLK			02/23/05		beg devl
					DLK			03/03/05		Added subreport fundsdailyactsub.rpt 
					DLK			03/07/05		Calls sub-report fundsdailyactsub.rpt
												To generate summary on second page.
					R. Stuve	04/23/05		Compiled on OTMAIN 
					R. Stuve	07/15/05		Added 'Action By' field 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION

*/
 		v_min_date		EPIC.eh_trust_account_trans.trans_date%type; 
 		v_date_from	  	EPIC.eh_trust_account_trans.trans_date%type; 
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Funds Transactions' as RptTitle, 
				  v_date_from as RptStart,
				'' as TransTime,
				'' as TransDesc,
				'' as TransNum,
				0 as Amount,
				'' as InmateName,
				'' as InmateNum,
				v_date_null as TransDate,
				'' as Reversal,
				'' as TType,
				'' as ActionBy
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Daily Funds Transactions' as RptTitle,
				v_date_from as RptStart,
				substr(EPIC.ef_epic_date_to_date(tat.action_time),12,8) as TransTime,
				concat(concat(to_char(tat.code_source_of_funds), ' - '),MACOMB.mcmb_fnt_TransType(tat.trust_account_trans_id)) as TransDesc,
				tat.transaction_number as TransNum,
				tat.amount as Amount,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TransDate,
				tat.reverse_flag as Reversal,
				decode(substr(to_char(tat.code_source_of_funds),1,1),
					'2','Liability',
					'4','Deposit',
					'5','Withdrawal',
					'8','Withdrawal') as TType,
				MACOMB.mcmb_fnt_user(tat.action_by) as ActionBy

		FROM	EPIC.eh_trust_account_trans tat,
				EPIC.eh_trust_account t

		WHERE	tat.trust_account_id = t.trust_account_id
				and EPIC.ef_epic_date_to_date(tat.trans_date) = v_min_date

ORDER BY Flag, TType, TransDesc, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_futurerelease
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_sentence.final_release_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.ZZ34
	Crystal: 		futurereleases.rpt
	Purpose:		Used by the Jail Office to list all inmates eligible for release during
					the specified time period. If an inmate is a 'Weekender', shows the time
					of release.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/10/05		Added to tree and report title/dates in second query
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/18/05		Changed some items in where clause to include pay-or-stay
												functionality; added UnpaidFlag, only input = StartDate
					R. Stuve	03/28/05		Per Bob M, changed final_release_date to sentence_end_date
					dlk			04/10/05		uploaded to tree  for additional testing
					R. Stuve	04/23/05		Compiled on OTMAIN   
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
	
*/
        v_min_date		EPIC.eh_sentence.final_release_date%type;  
     	v_date_from		EPIC.eh_sentence.final_release_date%type;
 		v_date_null		date; 
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));    
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Future Release(s)' as RptTitle,
				v_date_from as RptStart,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0  as Funds,
				v_date_null as ChargeDisp,
				'' as IType,
				'' as WRTime,
				'' as UnpaidFlag
		
		FROM	dual
		
	UNION ALL			              
		
		--the below query pulls back the actual report data
		SELECT  2 as Flag,
				'Future Release(s)' as RptTitle, 
			    v_date_from as RptStart, 
				EPIC.ef_offender_id(bk.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
				EPIC.ef_offender_cell(bk.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
				MACOMB.mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
					--date the single charge can be disposed (expected end-date on Sentences tab)
				decode(e.code_custody_status, 4, 'W') as IType,
					--above specifies Weekenders: don't need to display on report
				MACOMB.mcmb_fnt_wrlstime(bk.entity_id) as WRTime,
					--the above is the 'non-standard' release time for Weekender Release (if specified)
				MACOMB.mcmb_fnt_Unpaid(s.sentence_id) as UnpaidFlag
					--don't need to display on report
		
		
		FROM	EPIC.eh_booking bk,
				EPIC.eh_sentence s,
				EPIC.eh_charge c,
				EPIC.eh_entity_status e,
				EPIC.eh_sentence_out_dates sod
		
		WHERE	bk.entity_id = e.entity_id
				AND s.sentence_id = c.sentence_id
				AND c.booking_id = bk.booking_id
				AND s.sentence_id = sod.sentence_id
				AND c.charge_state <> 6
				AND (EPIC.ef_epic_date_to_date(EPIC.ef_min_date(s.sentence_end_date)) = v_min_date or EPIC.ef_epic_date_to_date(EPIC.ef_min_date(sod.paid_out_date)) = v_min_date)

	ORDER BY Flag, IType desc, UnpaidFlag desc, InmateName;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_futurerelease_org
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_sentence.final_release_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.ZZ34
	Crystal: 		futurereleases.rpt
	Purpose:		Used by the Jail Office to list all inmates eligible for release during
					the specified time period. If an inmate is a 'Weekender', shows the time
					of release.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/10/05		Added to tree and report title/dates in second query
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/18/05		Changed some items in where clause to include pay-or-stay
												functionality; added UnpaidFlag, only input = StartDate
					R. Stuve	03/28/05		Per Bob M, changed final_release_date to sentence_end_date
					dlk			04/10/05		uploaded to tree  for additional testing
					R. Stuve	04/23/05		Compiled on OTMAIN    
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
*/
        v_min_date		EPIC.eh_sentence.final_release_date%type;  
     	v_date_from		EPIC.eh_sentence.final_release_date%type;
 		v_date_null		date; 
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));    
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Future Release(s)' as RptTitle,
				v_date_from as RptStart,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0  as Funds,
				v_date_null as ChargeDisp,
				'' as IType,
				'' as WRTime,
				'' as UnpaidFlag
		
		FROM	dual
		
	UNION ALL			              
		
		--the below query pulls back the actual report data
		SELECT  2 as Flag,
				'Future Release(s)' as RptTitle, 
			    v_date_from as RptStart, 
				EPIC.ef_offender_id(bk.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
				EPIC.ef_offender_cell(bk.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
				MACOMB.mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
					--date the single charge can be disposed (expected end-date on Sentences tab)
				decode(e.code_custody_status, 4, 'W') as IType,
					--above specifies Weekenders: don't need to display on report
				MACOMB.mcmb_fnt_wrlstime(bk.entity_id) as WRTime,
					--the above is the 'non-standard' release time for Weekender Release (if specified)
				MACOMB.mcmb_fnt_Unpaid(s.sentence_id) as UnpaidFlag
					--don't need to display on report
		
		
		FROM	EPIC.eh_booking bk,
				EPIC.eh_sentence s,
				EPIC.eh_charge c,
				EPIC.eh_entity_status e,
				EPIC.eh_sentence_out_dates sod
		
		WHERE	bk.entity_id = e.entity_id
				AND s.sentence_id = c.sentence_id
				AND c.booking_id = bk.booking_id
				AND s.sentence_id = sod.sentence_id
				AND c.charge_state <> 6
				AND (EPIC.ef_epic_date_to_date(EPIC.ef_min_date(s.sentence_end_date)) = v_min_date or 
				     EPIC.ef_epic_date_to_date(EPIC.ef_min_date(sod.paid_out_date)) = v_min_date)

	ORDER BY Flag, IType desc, UnpaidFlag desc, InmateName;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_GreaterthanYear
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY34
	Crystal: 		greaterthanayear.rpt
	Purpose:		Used by the Medical staff to determine which inmates have been incarcerated
					for more than one year so that law-mandated reviews may be conducted
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/17/05		Created   
					DLK			02/23/05		Added to the Report Tree for test
					R. Stuve	05/28/05		Compiled on OTMAIN
					dlk         03/17/06        ADDED MACOMB AND EPIC NOTIONS
	
*/
	
v_date_null		date;
			
BEGIN 

v_date_null := null; 
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Inmates In Jail OVER 1 Year' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				v_date_null as BookingDate,
				v_date_null as Outdate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 	distinct 2 as Flag,
			'Inmates in Jail OVER 1 Year' as RptTitle, 
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			EPIC.ef_epic_date_to_date(bk.final_release_date) as Outdate
				--the day the inmate physically gets out of jail

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_booking bk,
			EPIC.eh_charge ch
	
	WHERE	ab.entity_id = bk.entity_id
			and ab.booking_id = ch.booking_id
			and ch.charge_state != '6'
			and EPIC.ef_epic_date_to_date(bk.end_date) is null
			and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) <= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(add_months(sysdate,-12))))

ORDER BY Flag, BookingDate, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistAllBook
 (	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListBk_sub.rpt (Sub Report: Part 2 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Charge Disposal Date
					R. Stuve	06/02/05		Added charged index number as a sorting field  
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field   
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS	
					R. Stuve	10/02/06		Reformatted Dispo Date to correct; added DispoReason; added 12 GA fields						
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    to_char(to_date(MACOMB.mcmb_fnt_DispoDate(ch.charge_id)), 'MM/DD/YYYY') as DispoDate,
		    EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate,
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    MACOMB.mf_GA_Charge(ch.charge_id, 'HELD FOR') as HeldFor,
			MACOMB.mf_GA_Charge(ch.charge_id, 'BONDING AGENCY') as BondingAgency,
			MACOMB.mf_GA_Charge(ch.charge_id, 'PACC CODE') as PACCCode,
			MACOMB.mf_GA_Charge(ch.charge_id, 'DIST VENUE') as DistVenue,
			MACOMB.mf_GA_Charge(ch.charge_id, 'CONVICTION SET ASIDE NON PUBLIC') as Conviction,
			MACOMB.mf_GA_Bail(ch.charge_id, 'COURT DISPOSITION') as CourtDispo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'EDUCATIONAL RELEASE') as EducRls,
			MACOMB.mf_GA_Sent(s.sentence_id, 'MISC SENTENCE INFO') as MiscSentInfo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'RESTITUTION JUDGEMENT AMOUNT') as RestJudAmt,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WEEKENDER RELEASE TIME') as WeekenderRlsTime,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK RELEASE GRANTED') as WorkRlsGranted,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK SEEK') as WorkSeek

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID

	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistAllDemo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompList_Main.rpt (Main Report: Part 1 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created  
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records 
					R. Stuve	06/07/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS 
					R. Stuve	10/02/06		Reformatted Reviewed Date to correct
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			to_char(to_date(MACOMB.mcmb_fnt_ReviewDate(ep.entity_id)),'MM/DD/YYYY') as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate,
			ep.entity_id as EntityId

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
			'' as EntityId
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
		    '' as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID; 
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistAllHolds
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListHd_sub.rpt (Sub Report: Part 4 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--EPIC.ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistAllNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListNt_sub.rpt(Sub Report: Part 3 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created  
					R. Stuve	06/07/05		Compiled on OTMAIN  
					R. Stuve	07/13/05		Added joins on IN/DP notes section (commented in code)
												so to display incidents/restrictions without notes 
					M. Zak      08-11-05        Added PB 'Property Bin' Note Section 
					M. Zak      08-15-05        Chgd Note Date and Time from pb to pi
					                            Changed PB Note to pull Data in Note Title only (1 line vs 2 in CR Report)
					                            vs. Note Title & Note Desc
					M. Zak		08-16-05		Added Release Date/Time to PB Note Section 
					                            
*/

v_date_null date;
			
BEGIN

v_date_null := null; 

	OPEN vCur FOR
		--the below pulls all historical notes for the inmate
			--DEMOGRAPHICS NOTES
	SELECT	distinct 'DN' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_address a,
			EPIC.eh_booking bk
	
	WHERE	bk.entity_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

----------
UNION ALL
----------
			--FOOD REFUSAL NOTES
	SELECT 	'FR' as NoteType,
			EPIC.ef_epic_date_to_date(sd.delivery_date_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sd.delivery_date_time),12,5) as NoteTime,
	        sd.code_service_type as NoteTitle,
	        sd.code_item || ': ' || sd.comments as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_service_delivery sd
	
	WHERE	bk.booking_id = sd.booking_id
			and sd.refused = 'Y'
			and sd.code_service_type = 'FOOD REFUSED'
			and bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--CHARGE NOTES
	SELECT  'CH' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_charge c,
			EPIC.eh_booking bk
	
	WHERE  	bk.booking_id = c.booking_id
			and c.charge_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--SENTENCING NOTES
	SELECT  'SE' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_sentence s,
			EPIC.eh_charge c,
			EPIC.eh_booking bk

	WHERE   bk.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id
			and s.sentence_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

-------
UNION ALL
------
			--CLASSIFICATION NOTES
	SELECT	'SC' as NoteType,
		    EPIC.ef_epic_date_to_date(sc.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sc.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText,
		    EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
	        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
	       	sc.override_reason as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.eh_booking bk,
			epicaudit.eh_security_classification sc
	
	WHERE   bk.booking_id = sc.booking_id
			and bk.entity_id = p_InmateID
			
--------
UNION ALL
--------
			--INCIDENT NOTES
	SELECT 'IN' as NoteType,
			EPIC.ef_epic_date_to_date(i.incident_date) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(i.incident_date),12,5) as NoteTime,
		    i.incident_number || ': ' || EPIC.ef_lookup_text('INCIDENT TYPE', i.code_incident_type, 'UC') as NoteTitle,
			'LOCATION: ' ||EPIC.ef_location_name(i.location_id, 'UC')||chr(13)|| (select 'MECHANICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where i.mechanical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id)||chr(13)||(select 'CHEMICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where  i.chemical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) as NoteText,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        io.entity_id as EntityId
	        
	
	FROM	EPIC.eh_incident_offender io,
			EPIC.eh_incident i,
			EPIC.eh_incident_description id
	
	WHERE 	io.incident_id = i.incident_id
			and i.incident_id = id.incident_id  (+)      --added join on 7/13 RAS
			and io.entity_id = p_InmateID

------
UNION ALL
------
			--RESTRICTION NOTES
	SELECT	'DP' as NoteType,
		    EPIC.ef_epic_date_to_date(er.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(er.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        er.incident_id as DPIncidentId,
	        EPIC.ef_epic_date_to_date(er.begin_date) as DPResBegDate,
	        EPIC.ef_epic_date_to_date(er.end_date) as DPResEndDate,
	        EPIC.ef_lookup_TEXT('RESTRICTION TYPE',er.code_restriction_type,'UC') || ': ' ||EPIC.ef_lookup_TEXT('RESTRICTION REASON',er.code_restriction_reason,'UC') as DPResReason,
	        er.comments as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        er.entity_id as EntityId
	        
	
	FROM	EPIC.eh_entity_restriction er,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   er.entity_restriction_id = nb.epic_id (+)          --added join on 7/13 RAS
			and nb.note_id = n.note_ref (+)                    --added join on 7/13 RAS
			and er.entity_id = p_InmateID

--------
UNION ALL
--------
			--LOG NOTES
	SELECT	'LG' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        el.log_type as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	         '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05    
	        el.epic_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_entity_log el
	
	WHERE  	el.note_id = n.note_ref
			and el.epic_id = p_InmateID

-------
UNION ALL
-------
			--HOUSING ALLOCATION/MOVES NOTES
	SELECT  'CL' as NoteType,
			EPIC.ef_epic_date_to_date(ha.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ha.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLStartDate,
			EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLEndDate,
	       	EPIC.ef_location_name(ha.location_id,'UC')as CLCellName,
	       	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'L') as CellClassLo,
		  	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'H') as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        ha.entity_id as EntityId
	
	FROM 	epicaudit.eh_housing_assignments ha,
			EPIC.epic_locations loc
	
	WHERE 	loc.location_id = ha.location_id
			and ha.action_type = 'U'
			and ha.entity_id = p_InmateID

-----
UNION ALL
------
			--HOLD NOTES
	SELECT	'HO' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	         '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05   
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bh.booking_id
			and bh.hold_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BOOKING NOTES FROM OTHER ATTRIBUTES
	SELECT	'IB' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),12,5) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
            v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			epicaudit.eh_generic_attribute ga
	
	WHERE	bk.booking_id = ga.item_id
			and bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--BOOKING NOTES FROM NOTEBOOK
	SELECT 	'IB' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time)as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
		    v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
		    EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE 	bk.booking_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BAIL CONDITION NOTES FROM OTHER ATTRIBUTES
	SELECT	'BC' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),11,6) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPICAUDIT.eh_generic_attribute ga
	
	WHERE	bk.booking_id = bc.booking_id
			and bc.bail_condition_id = ga.item_id
			and bk.entity_id = p_InmateID

-------
UNION ALL
--------
			--BAIL CONDITION NOTES FROM NOTEBOOK
	SELECT 	'BC' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
			n.note_name as NoteTitle,
			n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	       	bk.booking_number as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bc.booking_id
			and bc.bail_condition_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--KEEP SEPARATE NOTES
	SELECT 	distinct 'KS' as NoteType,
			EPIC.ef_epic_date_to_date(ks.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ks.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    ks.comments as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        EPIC.ef_offender_id(ks.origin_entity_id) as OriginKSNo,
		    EPIC.ef_get_personororgname(ks.origin_entity_id) as OriginKSName,
		    EPIC.ef_offender_id(ks.separate_entity_id) as SeparateKSNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_booking bk

	WHERE	(bk.entity_id = ks.separate_entity_id
				or
			bk.entity_id = ks.origin_entity_id)
			and bk.entity_id = p_InmateID 
-------
UNION ALL
--------			
			--RELEASE NOTES
	SELECT 	'BR' as NoteType,
			EPIC.ef_epic_date_to_date(r.actual_release) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(r.actual_release),11,6) as NoteTime,
			EPIC.ef_lookup_text('RELEASE TYPE', r.release_type, 'UC') as NoteTitle,
			'' as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	       	v_date_null as CLStartDate,
	      	v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	       	v_date_null as NoteBkStart,
	       	v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	       	v_date_null as DPResBegDate,
	       	v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
            
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_release r

	WHERE	bk.booking_id = r.booking_id
			and bk.entity_id = p_InmateID  
 -------
UNION ALL
--------				
						
	SELECT	distinct 'PB' as NoteType,  -- M.Zak 8-11-05 added section
   	        EPIC.ef_epic_date_to_date(pi.action_time) as NoteDate,                    -- M.Zak 8-15-05 chgd pb. to pi.
   	        substr(EPIC.ef_epic_date_to_date(pi.action_time),12,5) as NoteTime,      -- M.Zak 8-15-05 chgd pb. to pi.
   	        'PROPERTY BIN    '|| '           BIN #: '||pb.bin_number as NoteTitle,
   	        '' as NoteText,   -- 8-15-05   to save space - created note with just note title (1 line)
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,     
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        EPIC.ef_epic_date_to_date(psoi.action_time ) as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        op.entity_id as EntityId
	        

	  FROM  EPICAUDIT.otk_property_bin pb,
            EPICAUDIT.eh_property_item pi,
            EPICAUDIT.eh_offender_property op,
            EPICAUDIT.eh_property_sent_out_item psoi,   -- added M.Zak 8-16-05
            EPIC.epic_lookups el

      WHERE	pb.bin_id = pi.bin_id
   			AND pi.item_id = op.item_id
   			AND op.item_id = psoi.item_id(+)   -- added M.Zak 8-16-05 
   			AND el.lookup_class = 'PROPERTY TYPE'
   			AND pi.item_name = el.lookup_code
   			AND op.entity_id = p_InmateID			

ORDER BY NoteDate desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistBin
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in	    EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.
	Crystal: 		***.rpt 
	Purpose:		Used by Jail Investigation, Classification to list inmate's property bins
	
						
	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		8-1-05			Created
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION			
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls property bins for the inmate
SELECT  op.entity_id as EntityId,
        -- ef_offender_id(op.entity_id) as Inumber,
		EPIC.ef_get_personororgname(op.entity_id) as Iname,
       	pb.bin_number as Ibin,
       	el.text_full as Item,
       	EPIC.ef_epic_date_to_date(pi.ACTION_TIME)AS PIdate

FROM 	EPICAUDIT.otk_property_bin pb,
	 	EPICAUDIT.eh_property_item pi,
	 	EPICAUDIT.eh_offender_property op,
		 EPIC.EPIC_LOOKUPS el


	WHERE  	pb.bin_id = pi.bin_id
 			AND op.item_id = pi.item_id
	 		AND el.lookup_class = 'PROPERTY TYPE'
 			AND pi.item_name = el.lookup_code
    	    AND op.entity_id = p_InmateID  --SELECTED INMATE    ef_offender_id(op.entity_id) = '144976' 
    	    
ORDER BY PIdate;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistCurrentBook
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Sub Report: Part 2 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Disposal Date 
					R. Stuve	06/02/05		Added charged index number as a sorting field 
					R. Stuve	06/07/05		Compiled on OTMAIN
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field     
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION							
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls current bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No, 
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate, 
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber
	
	FROM   	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and ch.charge_state <> '6'
			and bk.entity_id = p_InmateID
		
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistCurrentDemo
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Main Report: Part 1 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records  
					R. Stuve	06/07/05		Compiled on OTMAIN    
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION
*/                  

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id 
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistCurrentHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Sub Report: Part 4 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN  
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls active holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			EPIC.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bh.hold_removed_date is null
			and bk.entity_id = p_InmateID
			
	ORDER BY HoldStart;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistCurrentNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		HistCurChgNtNt_sub.rpt(Sub Report: Part 3 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	07/13/05		Added joins on IN/DP notes section (commented in code)
												so to display incidents/restrictions without notes
					M.Zak       08/08/05        Copied otmain procedure to ottest & compiled
												Added code; --- and ha.action_type = 'U'  --- test 8-8-05 MAZ
												to CL note type	--HOUSING ALLOCATION/MOVES NOTES where section	
     				M. Zak		10-26-05		Added Release Date/Time to PB Note Section 		
     				DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION			
*/                                              

v_date_null date;
			
BEGIN

v_date_null := null; 

	OPEN vCur FOR
		--the below pulls all current notes for the inmate
			--DEMOGRAPHICS NOTES
	SELECT 	'DN' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        b.entity_id as EntityId
	
	FROM 	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_booking b,
			EPIC.eh_active_booking ab
	
	WHERE	ab.booking_id = b.booking_id
			and b.entity_id = nb.epic_id
			and nb.note_id = n.note_ref
			and ab.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(b.start_date)

---------
UNION ALL
---------

			--FOOD REFUSAL NOTES
	SELECT 	'FR' as NoteType,
			EPIC.ef_epic_date_to_date(sd.delivery_date_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sd.delivery_date_time),12,5) as NoteTime,
	        sd.code_service_type as NoteTitle,
	        sd.code_item || ': ' || sd.comments as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_service_delivery sd
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = sd.booking_id
			and sd.refused = 'Y'
			and sd.code_service_type = 'FOOD REFUSED'
			and EPIC.ef_epic_date_to_date(sd.delivery_date_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
		
---------
UNION ALL
---------

			--CHARGE NOTES
	SELECT  'CH' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_charge c,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE  	ab.booking_id = bk.booking_id
			and bk.booking_id = c.booking_id
			and c.charge_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--SENTENCING NOTES 
	SELECT  'SE' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_sentence s,
			EPIC.eh_charge c,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id
			and s.sentence_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
---------
UNION ALL
---------

			--CLASSIFICATION NOTES
	SELECT	'SC' as NoteType,
		    EPIC.ef_epic_date_to_date(sc.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sc.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText,
		    EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
	        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
	       	sc.override_reason as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId        
	
	FROM	EPIC.eh_booking bk,
			epicaudit.eh_security_classification sc,
			EPIC.eh_active_booking ab
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = sc.booking_id
			and EPIC.ef_epic_date_to_date(sc.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--INCIDENT NOTES 
	SELECT 'IN' as NoteType,
	        EPIC.ef_epic_date_to_date(i.incident_date) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(i.incident_date),12,5) as NoteTime,
		    i.incident_number || ': ' || EPIC.ef_lookup_text('INCIDENT TYPE', i.code_incident_type, 'UC') as NoteTitle,
			'LOCATION: ' ||EPIC.ef_location_name(i.location_id, 'UC')||chr(13)|| (select 'MECHANICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where i.mechanical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id)||chr(13)||(select 'CHEMICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where  i.chemical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) as NoteText,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_incident_offender io,
			EPIC.eh_incident i,
			EPIC.eh_incident_description id,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk

	WHERE 	ab.booking_id = bk.booking_id
			and bk.entity_id = io.entity_id
			and io.incident_id = i.incident_id
			and i.incident_id = id.incident_id (+)   --added join on 7/13 RAS
			and EPIC.ef_epic_date_to_date(id.report_date) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and io.entity_id = p_InmateID

---------
UNION ALL
---------

			--RESTRICTION NOTES
	SELECT	'DP' as NoteType,
		    EPIC.ef_epic_date_to_date(er.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(er.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
		    er.incident_id as DPIncidentId,
	        EPIC.ef_epic_date_to_date(er.begin_date) as DPResBegDate,
	        EPIC.ef_epic_date_to_date(er.end_date) as DPResEndDate,
	        EPIC.ef_lookup_TEXT('RESTRICTION TYPE',er.code_restriction_type,'UC') || ': ' ||EPIC.ef_lookup_TEXT('RESTRICTION REASON',er.code_restriction_reason,'UC') as DPResReason,
	        er.comments as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId        
	
	FROM	EPIC.eh_entity_restriction er,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk
	
	WHERE   ab.booking_id = bk.booking_id
	        and bk.entity_id = er.entity_id
			and er.entity_restriction_id = nb.epic_id (+)      --added join on 7/13 RAS
			and nb.note_id = n.note_ref (+)                    --added join on 7/13 RAS
			and EPIC.ef_epic_date_to_date(er.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and er.entity_id = p_InmateID

---------
UNION ALL
---------

			--LOG NOTES
	SELECT	'LG' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        el.log_type as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	FROM	EPIC.epic_notes n,
			EPIC.epic_entity_log el,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk
	
	WHERE  	ab.booking_id = bk.booking_id
			and bk.entity_id = el.epic_id
			and el.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) > = EPIC.ef_epic_date_to_date(bk.start_date)
			and el.epic_id = p_InmateID

---------
UNION ALL
---------

			--HOUSING ALLOCATION/MOVES NOTES
	SELECT  'CL' as NoteType,
			EPIC.ef_epic_date_to_date(ha.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ha.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLStartDate,
			EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLEndDate,
	       	EPIC.ef_location_name(ha.location_id,'UC')as CLCellName,
	       	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'L') as CellClassLo,
		  	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'H') as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM 	epicaudit.eh_housing_assignments ha,
			EPIC.epic_locations loc,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.entity_id = ha.entity_id
			and loc.location_id = ha.location_id 
			and ha.action_type = 'U'  -- test 8-8-05 MAZ
			and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and ha.entity_id = p_InmateID

---------
UNION ALL
---------

			--HOLD NOTES
	SELECT	'HO' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = bh.booking_id
			and bh.hold_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BOOKING NOTES FROM OTHER ATTRIBUTES
	SELECT	'IB' as NoteType,
	        EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),12,5) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			epicaudit.eh_generic_attribute ga
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = ga.item_id
			and EPIC.ef_epic_date_to_date(ga.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
---------
UNION ALL
---------

			--BOOKING NOTES FROM NOTEBOOK
	SELECT 	'IB' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time)as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
		    EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_active_booking ab
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BAIL CONDITION NOTES FROM OTHER ATTRIBUTES
	SELECT	'BC' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),11,6) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_bail_condition bc,
			epicaudit.eh_generic_attribute ga
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = bc.booking_id
			and bc.bail_condition_id = ga.item_id
			and EPIC.ef_epic_date_to_date(ga.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BAIL CONDITION NOTES FROM NOTEBOOK 
	SELECT 	'BC' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
			n.note_name as NoteTitle,
			n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as NoteText,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_bail_condition bc,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = bc.booking_id
			and bc.bail_condition_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------
	
			--KEEP SEPARATE NOTES
	SELECT 	'KS' as NoteType,
			EPIC.ef_epic_date_to_date(ks.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ks.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    ks.comments as NoteText,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        EPIC.ef_offender_id(ks.origin_entity_id) as OriginKSNo,
		    EPIC.ef_get_personororgname(ks.origin_entity_id) as OriginKSName,
		    EPIC.ef_offender_id(ks.separate_entity_id) as SeparateKSNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
		    
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE	ab.booking_id = bk.booking_id
			and(bk.entity_id = ks.separate_entity_id
				or
			bk.entity_id = ks.origin_entity_id)
			and EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
 -------
UNION ALL
--------				
						
	SELECT	distinct 'PB' as NoteType,  -- M.Zak 8-11-05 added section
   	        EPIC.ef_epic_date_to_date(pi.action_time) as NoteDate,                    -- M.Zak 8-15-05 chgd pb. to pi.
   	        substr(EPIC.ef_epic_date_to_date(pi.action_time),12,5) as NoteTime,      -- M.Zak 8-15-05 chgd pb. to pi.
   	        'PROPERTY BIN    '|| '           BIN #: '||pb.bin_number as NoteTitle,
   	        '' as NoteText,   -- 8-15-05   to save space - created note with just note title (1 line)
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,     
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        EPIC.ef_epic_date_to_date (psoi.action_time ) as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        op.entity_id as EntityId
	        

	  FROM  EPICAUDIT.otk_property_bin pb,
            EPICAUDIT.eh_property_item pi,
            EPICAUDIT.eh_offender_property op,
            EPICAUDIT.eh_property_sent_out_item psoi,   -- added M.Zak 8-16-05
            EPIC.EPIC_LOOKUPS el,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab

      WHERE	ab.booking_id = bk.booking_id
   			AND bk.entity_id = op.entity_id	
   			AND op.entity_id = p_InmateID
            AND EPIC.ef_epic_date_to_date(pi.ACTION_TIME) >= EPIC.ef_epic_date_to_date(bk.start_date) -- current
            AND pb.bin_id = pi.bin_id
   			AND pi.item_id = op.item_id
   			AND op.item_id = psoi.item_id(+)   -- added M.Zak 8-16-05 
   			AND el.lookup_class = 'PROPERTY TYPE'
   			AND pi.item_name = el.lookup_code 
   			
   			
   			
ORDER BY NoteDate desc;   
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistNoBook
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChgBk_sub.rpt (Sub Report: Part 2 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Charge Disposal Date
					R. Stuve	06/02/05		Added charged index number as a sorting field
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field      
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION
					R. Stuve	10/02/06		Reformatted Dispo Date to correct; added DispoReason; added 12 GA fields							
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No, 
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		   	to_char(to_date(MACOMB.mcmb_fnt_DispoDate(ch.charge_id)), 'MM/DD/YYYY') as DispoDate,
		   	EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate, 
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    MACOMB.mf_GA_Charge(ch.charge_id, 'HELD FOR') as HeldFor,
			MACOMB.mf_GA_Charge(ch.charge_id, 'BONDING AGENCY') as BondingAgency,
			MACOMB.mf_GA_Charge(ch.charge_id, 'PACC CODE') as PACCCode,
			MACOMB.mf_GA_Charge(ch.charge_id, 'DIST VENUE') as DistVenue,
			MACOMB.mf_GA_Charge(ch.charge_id, 'CONVICTION SET ASIDE NON PUBLIC') as Conviction,
			MACOMB.mf_GA_Bail(ch.charge_id, 'COURT DISPOSITION') as CourtDispo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'EDUCATIONAL RELEASE') as EducRls,
			MACOMB.mf_GA_Sent(s.sentence_id, 'MISC SENTENCE INFO') as MiscSentInfo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'RESTITUTION JUDGEMENT AMOUNT') as RestJudAmt,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WEEKENDER RELEASE TIME') as WeekenderRlsTime,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK RELEASE GRANTED') as WorkRlsGranted,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK SEEK') as WorkSeek

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID
			
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistNoDemo
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChg_Main.rpt (Main Report: Part 1 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records
					R. Stuve	06/07/05		Compiled on OTMAIN    
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION 
					R. Stuve	10/02/06		Reformatted Reviewed Date to correct
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		   	MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			to_char(to_date(MACOMB.mcmb_fnt_ReviewDate(ep.entity_id)),'MM/DD/YYYY') as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
			
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistNoHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChgHd_sub.rpt (Sub Report: Part 3 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN   
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemovedDate,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber
			
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID 
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
			
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_History30DaysNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ32
	Crystal: 		****.rpt
	Purpose:		Used by Jail Office and other MCSO departments to list inmate's
					history (current charges and the last 30 days of notes)
					
					Title: Inmate History with Current Charges & 30 Days of Notes

	Author:			Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					A. Zdybel	02/04/05		Created 
					R. Stuve	02/08/05		Added Inmate ID prompt ($SelectedPerson$) and
												notes date filter  
					DLK         03/20/06        ADD MACOMB AND EPIC NOTATION
*/
			
BEGIN

		
	OPEN vCur FOR 
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
   
	  
	 FROM DUAL 
	 UNION ALL
	  
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.ef_get_personororgname(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert
	  
            
	    FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       union
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
         
	    
		FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

        union
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
      
	   
		 FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                 from EPIC.eh_person_snapshot ps where
                 ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
       
	    
		 FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
     
	    
		 FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --address
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
    
       
		FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --drivers license
				AND ep.entity_id = ol.entity_id  
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert


	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	   EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert       

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 

			    
		  	UNION
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(bk.start_date, bk.end_date) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert
	    
      
	    
	        FROM    EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id

                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information

               AND bk.booking_id = r.booking_id (+)
               
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0

		  UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
        
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id;
                
    END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistoryCurrentNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ32
	Crystal: 		***.rpt
	Purpose:		Used by Jail Office and other MCSO departments to list inmate's
					history (charges and notes)
                                                   
						Title: CURRENT charges and all notes created/updated during current stay.
						
	Author:			Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					A. Zdybel	02/04/05		Created 
					R. Stuve	02/11/05		Added Inmate ID prompt ($SelectedPerson$) and
												modified for current charges only and modified
												for current (filter on booking_date) notes and 
												deleted Property Bin history notes (per MCSO
												request) from this report	
					DLK          03/20/06       ADDED MACOMB AND EPIC NOTATIONS 							
*/
			
BEGIN
	
	OPEN vCur FOR 
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	  
	 FROM DUAL 
	 UNION ALL
	  
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.ef_get_personororgname(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
            
	    FROM
		  		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       UNION ALL
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    
		FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

       UNION ALL
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = 
               	    (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                      from EPIC.eh_person_snapshot ps 
                      where ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType    
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ol.entity_id  
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     


	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
  
-- it is here

		  	UNION 
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(EPIC.ef_epic_date_to_date(bk.start_date), EPIC.ef_epic_date_to_date(bk.end_date)) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
	    
	        FROM    EPIC.eh_booking bk,
	        		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id
                AND	ch.charge_state <> '6' --RAS: added to pull only current charges
                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information
               AND bk.booking_id = r.booking_id (+)
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION ALL	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
        
        FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk, 
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id 
				AND EPIC.ef_epic_date_to_date(sd.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
     UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
        
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
                                
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
			 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref 
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION  ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      	-- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				AND EPIC.ef_epic_date_to_date(sc.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id 
		 	 	AND EPIC.ef_epic_date_to_date(id.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking   
		 	 	
    				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	                      
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = er.entity_id
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(er.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    			
    	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	                                          
        FROM
		   		EPIC.eh_booking bk,     
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = el.epic_id
		 	 	AND el.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(el.event_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND ab.booking_id = bk.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 	 	
      UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,  
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
   UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as HONote,
        'HO' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType 
        	                                          
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
	
	     UNION	ALL  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,    
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				     

             UNION	ALL  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM
		        EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND bk.entity_id = ks.origin_entity_id 
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
                
	     UNION ALL
	     SELECT DISTINCT     -- Housing Allocation / Moves in date order
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ha.location_id as CLCellID,
		decode(EPIC.ef_location_path_name(ha.location_id,'UC',5),null, EPIC.ef_location_name(ha.location_id,'UC'),
			EPIC.ef_location_path_name(ha.location_id,'UC',5))as CLCellName,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLStartDate,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLEndDate,
	  	loc.gender_physical as CellGender,
	  	loc.classification_low as CellClassLo,
	  	loc.classification_high as CellClassHi,
	  	'CL' as CLType

	    FROM epicaudit.eh_housing_assignments ha,
		EPIC.eh_booking book, 
		EPIC.eh_active_booking ab,
		--added for gender/class of cell
		EPIC.epic_locations loc

	where
		ha.entity_id =	p_InmateID
		and ha.action_type = 'U'
		and ha.entity_id = book.entity_id
		and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)
		and ab.booking_id = book.booking_id
		and (ha.action_time <= book.end_date or book.end_date is null)
		and loc.location_id = ha.location_id
		AND EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)  --RAS: Added to pull notes only attached to current booking
             	
		  UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id;
                
    END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_HistoryNoNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ30
	Crystal: 		****.rpt
	Purpose:		Used by Jail Office and other MCSO departments to list inmate's
					history (charges and no notes)

	Author:			Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					A. Zdybel	02/04/05		Created 
					R. Stuve	02/07/05		Added Inmate ID prompt ($SelectedPerson$)
												and deleted notes sections	
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

		
	OPEN vCur FOR 
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
   
	  
	 FROM DUAL 
	 UNION ALL
	  
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.ef_get_personororgname(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert
	  
            
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       union
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
         
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

        union
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
      
	   
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                 from EPIC.eh_person_snapshot ps where
                 ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
       
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
     
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --address
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
    
       
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --drivers license
				AND ep.entity_id = ol.entity_id  
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert


	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert       

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 

			    
		  	UNION
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(bk.start_date, bk.end_date) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert
	    
      
	    
	        FROM    EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id

                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information

               AND bk.booking_id = r.booking_id (+)
               
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0

		  UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
        
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id;
                
    END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Housing1
	(curHouse		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
/*	Form Usage: 	CRSTL.YY40
	Crystal: 		housing1.rpt
	Purpose:		Top of Housing report: Summary counts of sentenced/unsentenced inmates by 
					gender and housing type (Holding and General). Bottom of report listed
					as Housing2 includes further detail of inmate type.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/14/05		Add to query2 so title template will display 
					dlk			01/26/05		Add to report tree to test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	04/23/05		Compiled in OTMAIN
	    			DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/
 
BEGIN 
	OPEN curHouse FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Housing' as RptTitle,
				'' as Sex,
				'' as Juvenile,
				'' as Status,
				'' as House,
				'' as ID,
				'' as OverallStatus
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data
		SELECT	DISTINCT  2 as Flag,
				'Housing' as RptTitle,
				decode(p.code_gender, '_NOSP','U', code_gender) as Sex,
				p.juvenile_flag as Juvenile,
				decode(e.code_custody_status,'1','R',
  									'2','F',
  									'3','P',
  									'4','W',
           							'5','WR',
                  					'6', 'KT',
                       				'7', 'AW',
                           			'9', 'GT',
                              		'10', 'ST',
                                	'11', 'JS',
                                 	'12', 'WW',
                                  	'13', 'T',
                                   	'14', 'SCC',
                                    '15', 'LC',
                                    '16', 'OC')  as Status,
           		decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') as House,
           		EPIC.ef_offender_id(b.entity_id) as ID,
           		--decode(c.charge_state, '4', 'S', 'U') as ChgStatus,
           		MACOMB.mcmb_fnt_sentallchgs(b.entity_id) as OverallStatus

		FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b

		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6'
				and m.in_muster_flag = 'Y'
					--above denotes 'on count' status

		ORDER BY Flag, ID;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_housing2
	(curHouse2		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY40
	Crystal: 		housing2.sub.rpt
	Purpose:		Bottom of Housing report: Details inmate demographics for types of Federal,
					Parole, Weekender, and WorkRelease.  Top of report listed as Housing1 and
					includes summary count of sentenced/unsentenced inmates by gender and
					housing type.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created
					R. Stuve	12/13/04		Added header information via union query
					R. Stuve	01/24/05		Added in_muster_flag to 'where' clause 
					DLK			01/26/05		Added as part of housing1 to report tree to test
					R. Stuve	04/23/05		Compiled in OTMAIN
                    DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/

 BEGIN

	OPEN curHouse2 FOR
		SELECT 	DISTINCT EPIC.ef_offender_id(b.entity_id) as ID,
				decode(p.code_gender, '_NOSP','U', code_gender) as Sex,
				EPIC.ef_location_name(h.location_id, 'UC') as Cell,
        		EPIC.ef_get_personororgname(b.entity_id) as Name,
        		p.juvenile_flag as Juvenile,
				decode(e.code_custody_status, '2','F',
  											'3','P',
  											'4','W',
           									'5','WR') as Status


		FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b


		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6' 
				and m.in_muster_flag = 'Y'
					--the above denotes 'on count' status
				and (e.code_custody_status in ('2','3','4','5') or p.juvenile_flag = 'Y')

		ORDER BY Status, ID;

END;

--RAS
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_IncomSentence
 (	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
 
/*	Form Usage: 	CRSTL.YY37
	Crystal: 		incomesentenc.rpt
	Purpose:		To list all inmates with unfilled sentence data and/or charges with a status of 
					'sentenced', but not matching charge state

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/05/05		Created 
					R. Stuve	05/13/05		Added second query to pull back unmatched charges
					R. Stuve	05/24/05		Compiled on OTMAIN
					DLK         03/21/06        ADDED MACOMB AND EPIC NOTATION
*/
 		
		v_date_null		date;               
		--must be same datatype as declarations above so WHERE clause doesn't fail
 			
BEGIN
         
		v_date_null	:= 	null;            
		--set value for variables used in query

	OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Incomplete Sentences' as RptTitle,
				' ' as Inmate#,
				' ' as InmateName,
				' ' as CaseNumber,
				' ' as Charge,
				v_date_null as SentenceStart,
				'' as Title
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data
		(SELECT 2 as Flag,
				'Incomplete Sentences' as RptTitle,
				EPIC.ef_offender_id(b.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
				MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Charge,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				'Incomplete Sentences' as Title
		
		FROM    EPIC.eh_booking b,
				EPIC.eh_sentence s,
				EPIC.eh_charge ch
		
		WHERE	b.booking_id = ch.booking_id
				and s.sentence_id = ch.sentence_id
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) is null
				and ch.charge_state != '6'
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) not like '%PRISON%'

		UNION ALL
				--Charge status of sentenced, but does not have matching charge state
		SELECT 	2 as Flag,
				'Incomplete Sentences' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
				MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Charge,
				v_date_null as SentenceStart,
				'Unmatched Charge Status' as Title
		
		FROM    EPIC.eh_active_booking ab,
				EPIC.eh_charge ch
				
		WHERE	ab.booking_id = ch.booking_id 
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) like '%SENTENCED%'
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) not like '%PRISON%'
				and ch.charge_state != '4'
				and ch.charge_state != '6')

ORDER BY Flag, Title, InmateName;

END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_IncorrSent
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ81
	Crystal: 		IncorrSent.rpt
	Purpose:		Used by the Administration/Booking to find incorrectly entered sentence information
					where staff checked boxes we do not use

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created    
					DLK			05/31/05		Begin Crystal devlp to test 
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/21/06        ADDED MACOMB AND EPIC NOTATION
*/

BEGIN  

  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Incorrect Sentence Info' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as IndSFlg,
				'' as WkEFlg,
				'' as NGTimeFlg,
				'' as MinDFlg,
				'' as LfSnt,
				'' as SntHrs,
				'' as SntWks
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: Incorrect Sentence Info' as RptTitle,
			 	 EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				 EPIC.ef_get_personname_by_bookid(ch.booking_id) as InmateName,
                DECODE(se.indeterminate_flag, 'Y','YES','N', '  ') as IndSFlg,
				DECODE(se.weekender_sentence, 'Y','YES','N', '  ') as WkEFlg,
				DECODE(se.apply_good_time_credit, 'Y','  ','N', 'YES') as NGTimeFlg,
	            DECODE(se.minimum_duration_id,  Null,'  ','YES') as MinDFlg ,
				DECODE(sd.life_sentence,  'N','  ','Y', 'YES') AS	LfSnt ,
				DECODE(sd.hours,  Null,'  ','YES') as SntHrs,
				DECODE(sd.weeks,  Null,'  ','YES') as SntWks

		FROM 	 EPIC.eh_sentence se,
				 EPIC.eh_charge ch,
				 EPIC.eh_active_booking ab,
				 EPIC.eh_sentence_duration sd

		WHERE 	ch.charge_state <> 6
				and ch.sentence_id = se.sentence_id
				and ab.booking_id = ch.booking_id
            	and sd.sentence_duration_id =  se.duration_id
       	 		and (se.indeterminate_flag = 'Y' or se.weekender_sentence = 'Y' or se.apply_good_time_credit = 'N' or sd.life_sentence ='Y' or se.minimum_duration_id is not NULL or sd.weeks is not null or sd.hours is not null)

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InitClass
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor,
	p_StartDate		in			EPIC.eh_booking.start_date%type)

IS

/*	Form Usage: 	CRSTL.ZZ82
	Crystal: 		InitClass.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have more not
					had the Initial Classification form filled out

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created  
					DLK			05/31/05		Crystal devl started for test 
					DLK			06/01/05		Loaded to Report Tree for test
					R. Stuve	06/06/05		Compiled on OTMAIN 
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATIONS
*/

		v_min_date		EPIC.eh_sentence.final_release_date%type;  
     	v_date_from		EPIC.eh_sentence.final_release_date%type;
 		v_date_null		date; 

BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));    
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;

	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as BookingDate
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
       			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate

		FROM  EPIC.eh_booking bk

		WHERE  EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) = v_min_date

			MINUS

		SELECT 	UNIQUE 2 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_offender_id(efi.entity_id) as InmateNum,
  				EPIC.ef_get_personororgname(efi.entity_id) as InmateName,
      			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate

		FROM	EPIC.epic_form_instance  efi,
	 			EPIC.eh_booking bk

  		WHERE		efi.entity_id = bk.entity_id
   					and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) = v_min_date
   					and EPIC.ef_epic_date_to_date(bk.start_date) <= EPIC.ef_epic_date_to_date(efi.action_time)
   					and efi.form_id = '0EDDMC0100EPI175'

		ORDER BY Flag, BookingDate;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmateCstdyStBookng
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_BookingID		in		EPIC.eh_booking.booking_id%type)
IS
/*	Form Usage: 	CRSTL.XX42
	Crystal: 		InmateCustodyStat_sub.rpt (Sub Report for: Daily Inmate Status Changes)
	Purpose:		Used by Reimbursement - Lori 
                    Pulls back OT Custody Status grid table per booking id
						
	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak	    9-23-05		     Created 
					DLK         03/21/06         ADDED MACOMB AND EPIC NOTATION
					R. Stuve	4/18/06			No longer needed per Sgt. Roberts: expired from OT report tree
 */					
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN 

		v_date_null := null;
		--set value for variables used in query
					
 	OPEN vCur FOR
		
	   SELECT	1 as Flag,
				'' as InmateNbr,
				'' as InmateName,
				v_date_null as CS_start_date,
				'' as Custody_Status,			
				v_date_null as CS_end_date
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
    	EPIC.ef_offender_id(bk.entity_id) as InmateNbr,
		MACOMB.mcmb_fnt_Name_Delimited_gvt(bk.entity_id) as InmateName,
		EPIC.ef_epic_date_to_date(bcs.date_start) as CS_start_date,
		MACOMB.mcmb_fnt_custody_status_desc(bcs.code_custody_status) as Custody_Status,
		EPIC.ef_epic_date_to_date(bcs.date_end) as CS_end_date

	FROM
    	EPIC.eh_booking bk,
    	EPIC.eh_booking_custody_status bcs
	
	WHERE
  		bk.booking_id = p_BookingID   --'0II4RIO000USJ0UB'
  		and bk.booking_id = bcs.booking_id

	ORDER BY cs_start_date; 
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmateFunds
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY11/CRSTL.YY12 (broken down into +- transactions: Used by Finance)
	Crystal: 		inmatefunds.rpt/inmatefunds_bal_main.rpt
	Purpose:		Used by Aramark/Commissary to list the last transaction for each inmate
					and his/her current available balance (may need to be edited upon Go-Live
					to include non-active inmates)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve/	01/25/05		Created  
                    A. Zdbel
                    dlk			01/26/05		Devl and On tree for Test
                    R. Stuve	01/31/05		Changed 'Union' to 'Union All'
                    R. Stuve	04/23/05		Compiled on OTMAIN 
                    R. Stuve	06/20/05		Added Sort column to sort per Aramark/Commissary's request  
                    DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/                 

v_date_null		date;
			
BEGIN  

v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Inmate Funds' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				0 as CurBal,
				v_date_null as LastTransDate,
				'' as LastTransTime,
				'' as TransType,
				0 as TransAmt,
				0 as Sort
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Inmate Funds' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as CurBal,
				EPIC.ef_epic_date_to_date(tat.action_time) as LastTransDate,
				substr(EPIC.ef_epic_date_to_date(tat.action_time),9,8) as LastTransTime,
				tat.description as TransType,
				tat.amount as TransAmt,
		(case	when EPIC.ef_offender_cell(ab.entity_id) like 'DC%' then 1
				when EPIC.ef_offender_cell(ab.entity_id) like 'HC%' then 1
				when EPIC.ef_offender_cell(ab.entity_id) like 'ME%' then 2
				when EPIC.ef_offender_cell(ab.entity_id) like '2A%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2B%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2C%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '3A%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '3B%' then 3
			 	when EPIC.ef_offender_cell(ab.entity_id) like '3C%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2D%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '2E%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '2F%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3D%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3E%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3F%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '4A%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4B%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4C%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5A%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5B%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5C%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4D%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '4E%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '4F%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5D%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5E%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5F%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '6A%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6B%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6C%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7A%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7B%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7C%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6D%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '6E%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '6F%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7D%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7E%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7F%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '8A%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8B%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8C%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9A%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9B%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9C%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8D%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '8E%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '8F%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9D%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9E%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9F%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '10A%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10B%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10C%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11A%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11B%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11C%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10D%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '10E%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '10F%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11D%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11E%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11F%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like 'R%' then 13
				when EPIC.ef_offender_cell(ab.entity_id) like '1A%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1B%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1C%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1D%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like 'D%' then 15
				when EPIC.ef_offender_cell(ab.entity_id) like 'MH%' then 16
				when EPIC.ef_offender_cell(ab.entity_id) like 'MS%' then 17
				when EPIC.ef_offender_cell(ab.entity_id) like 'X%' then 18
				when EPIC.ef_offender_cell(ab.entity_id) like 'D1%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D2%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D3%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D4%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D5%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D6%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'WRIT%' then 20
				else 21 end) as Sort


		FROM   	EPIC.eh_active_booking ab,
				EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	ab.entity_id = t.entity_id
				and t.trust_account_id = tat.trust_account_id
				and tat.transaction_number =
					(SELECT MAX(tat2.transaction_number)
   					FROM EPIC.eh_trust_account_trans tat2
   					WHERE tat2.trust_account_id = t.trust_account_id)

ORDER BY Flag, Sort, Cell, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmatesByJdgCount_CRE
	(vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJdgCounts_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.  This reports displays Judge Name, Court, #Bed count(Inmates in Jail)
                    --A sentence that has a FINE amount thus giving us everyone sent to a fine
                    --then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned 
                    --list will only have inmates with the charge that they are here on that only requires a fine to get out of jail 
                    -- any minimual jail time has been taken care of.


	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      11-21-05       Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80)    
					DLK         03/21/06       ADDED MACOMB AND EPIC NOTATIONS
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Count of Inmates By Court/Judge' as RptTitle,
				'' as Judge,
                '' as CourtType,
                '' as CourtName,
                '' as Court,
                '' as InmateNum
                    		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Count of Inmates By Court/Judge' as RptTitle,
      			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,
      			EPIC.el.sub_1 as CourtType,
      			EPIC.el.sub_4 as CourtName,
                MACOMB.mcmb_fnt_CourtName(ch.charge_id) as Court,    
                EPIC.ef_offender_id(ab.entity_id) as InmateNum
             

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so,
				EPIC.eh_release r,
				EPIC.epic_lookups el

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6' 
				and (EPIC.el.lookup_class = 'JUDGE NAME' 
				and EPIC.el.lookup_code = MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id) and EPIC.el.sub_2 <> '-AX')
         
order by Flag, CourtType, CourtName, Judge;

END;


/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmatesByJdgPorS_CRE
	(vJudgeName  in         EPIC.eh_generic_attribute.attribute_name%type, 
	 vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJudgePorS_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.  
                    A sentence that has a FINE amount thus giving us everyone sent to a fine
                    then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned 
                    list will only have inmates with the charge that they are here on that only requires a fine to get out of jail 
                    - any minimual jail time has been taken care of.


	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      11-21-05       Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80) 
					DLK			03/21/06       ADDED MACOMB AND EPIC NOTATION
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge - Pay or Stay' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
		        '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge - Pay or Stay' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,  -- removed 11-1-05
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
		        MACOMB.mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz 11/2/05 Meeting w/Judge Viviano       

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so, 
				EPIC.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id     
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'  
				and ((vJudgeName != 'ALL' and (EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = ' ' || vJudgeName
				                           or EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName))
				or vJudgeName = 'ALL')   -- added 11-23-05 for ALL selection
				and MACOMB.mcmb_fnt_FineAmount(ch.sentence_id) > 0      -- added 11-21-05
                and  to_date(substr(sysdate,1,10)) >= to_date (substr(EPIC.ef_epic_date_to_date(so.paid_out_date),1,10)) -- added 11-21-05
                --- above last 2 lines of code - per Glenn looks only for a sentence that has a FINE amount thus giving us everyone sent to a fine
                --- then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned list will only have
                --- inmates with the charge that they are here on that only requires a fine to get out of jail - any minimual jail time has been taken care of
	            
order by Flag, JUDGE, InmateName;

END;


/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmatesByJudge
 (vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY80
	Crystal: 		InmatesByJudge.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info

	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      09/16/05        Created         
					M. Zak      11-4-05         Added sentence to prisoner inmates(11/2/05 Meeting w/Judge Viviano)   
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATIONS
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
   	            '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
                MACOMB.mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz chgd 11-4-05 (11/2/05 Meeting w/Judge Viviano)                

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so, 
				EPIC.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'
	            --and mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'   -- MAZ removed 11-04-05 display sent to prisoner inmate charges (11/2/05 Meeting w/Judge Viviano)
	            
order by Flag, JUDGE, InmateName;

END;


/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmatesByJudge_CRE
	(vJudgeName  in         EPIC.eh_generic_attribute.attribute_name%type, 
	 vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJudge_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.

	Author:			Mary Ann Zak 
	                Received Query from Glenn.
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					M. Zak        11/02/05        Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80)   
					M. Zak        12/01/05        added ALL  
					D. Kuykendall 01/12/06		  added logic to return Court Name for calulation of totals 
					DLK           03/21/06        ADDED MACOMB AND EPIC NOTATIONS 
*/                  

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,               
				'' as CourtName, --011206 dlk
				'' as Court,     --011206 dlk
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
		        '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME',MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge, 
      			EPIC.el.sub_4 as CourtName,     --011206 dlk
      			MACOMB.mcmb_fnt_CourtName(ch.charge_id) as Court,	--011206 dlk			
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,  -- removed 11-1-05
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
		        MACOMB.mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz 11/2/05 Meeting w/Judge Viviano       

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so, 
				EPIC.eh_release r,
                EPIC.epic_lookups el
                
		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id     
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'  
				--and ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName  
				-- **** commented out above line - CR could not handle ' ' as parameter so had to force it with concatenation 	 
				and ((vJudgeName != 'ALL' and (EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = ' ' || vJudgeName
				                           or EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName))
				or vJudgeName = 'ALL')   -- added 12-01-05 for ALL selection
				  			
	            --and mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'  -- 11/2/05 Meeting w/Judge Viviano show all charges w/ indicator of Sent to Prison
	            and (EPIC.el.lookup_class = 'JUDGE NAME' and EPIC.el.lookup_code = MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id) and EPIC.el.sub_2 <> '-AX')   --011206  dlk
	            
order by Flag, CourtName, JUDGE, InmateName;

END;

/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmatesByJudge_ORG
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY80
	Crystal: 		InmatesByJudge.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info

	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      09/16/05        Created   
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt          

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so, 
				EPIC.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'
	            and MACOMB.mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'
	            
order by Flag, JUDGE;

END;


/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_InmateStChgsBkng
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS
/*	Form Usage: 	CRSTL.XX42
	Crystal: 		InmateCustodyStat_Main.rpt.rpt (Sub Report for: Daily Inmate Status Changes)
	Purpose:		Used by Reimbursement - Lori 
                    This first select statement pulls demographic data & Transaction amounts for inmates who have activity (payments) in
                    their Trust Account 205 - Legal Judgement Reimbursement (KH)
                    The second select pulls demographic and sentence data for inmate bookings that fall within
                    the proper date range and custody status.  It calculates the number of days incarceration
                    
						
	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak	    9-23-05		     Created 
					M.Zak       9-27-05          Added mcmb_fnt_505_560_trans_amt function replaced mcmb_fnt_505_trans_amt 
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATIONS
 */		
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;			
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN 
		v_min_date := EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from := substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;
        --set value for variables used in query
					
 	OPEN vCur FOR
		
	   SELECT	1 as Flag,
	            'Inmate Custody Status Changes' as RptTitle,
	            v_date_from as RptStart,
				v_date_to as RptEnd,
				''  as InmateNbr,
				''  as InmateName,
				''  as Bk_start_date,
				''  as Bk_end_date,
				'0' as DaysIncar,
				''  as Custody_Status,			
				''  as St_end_date,
				--'0' as Amt,      -- used for below query only        
				''  as BookingID
				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		

--	SELECT  2 as Flag,
--	    'Inmate Custody Status Changes' as RptTitle,
--	    v_date_from as RptStart,
--		v_date_to as RptEnd,
--		ef_offender_id(trust.entity_id) as InmateNbr,
--		ef_get_personororgname(trust.entity_id) as InmateName,
--	    '' as Bk_start_date,
--		'' as Bk_end_date,
--		'0' as DaysIncar,
--		'' as Custody_Status,
--		'' as St_end_date,
--		mcmb_fnt_505_560_trans_amt(trans.trust_account_trans_id, v_min_date, v_max_date) as Amt,  -- Pymts 505 Legal Judgement Reimbursement or account 560 Cash Settlement
--		'' as BookingID
--	FROM
--		eh_trust_account_trans trans,
--		eh_trust_account trust
--	WHERE
--	    trans.trust_account_id = trust.trust_account_id and
--		trans.code_source_of_funds in ('505','560') and
--		ABS(mcmb_fnt_505_560_trans_amt(trans.trust_account_trans_id, v_min_date, v_max_date)) > 0 and
--		trust.code_status = 'OPEN'
		
----------		
--UNION ALL   
----------

/*This select pulls demographic and sentence data for inmate bookings that fall within
  the proper date range and custody status.  It calculates the number of days incarceration
  and sends the result to GVt for room & board charges*/
	SELECT 3 as Flag,
	    'Inmate Custody Status Changes' as RptTitle,
	    v_date_from as RptStart,
		v_date_to as RptEnd,
	    EPIC.ef_offender_id(bk.entity_id) as InmateNbr,
	    EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
		to_char(MACOMB.mcmb_fnt_startdate_gvt(bk.booking_id), 'MM/DD/YYYY') as Bk_start_date,
		to_char(MACOMB.mcmb_fnt_enddate_gvt(bk.booking_id), 'MM/DD/YYYY') as Bk_end_date,
		MACOMB.mcmb_fnt_gvt_days(bk.booking_id) as DaysIncar,
		MACOMB.mcmb_fnt_custody_status_report(bk.booking_id) as Status,
		to_char(MACOMB.mcmb_fnt_status_startdate(bk.booking_id), 'MM/DD/YYYY') as St_end_date,
		--'0' as Amt,
		bk.booking_id as BookingID                                                                                                    
		
	FROM
	    EPIC.eh_booking bk
	WHERE
		 bk.booking_state = '3'
		and (MACOMB.mcmb_fnt_custody_status_gvt(bk.booking_id) in ('4201','4202','4229'))
		and MACOMB.mcmb_fnt_disporeason_sent(bk.booking_id) = 'S'
		and MACOMB.mcmb_fnt_enddate_gvt(bk.booking_id) > v_min_date and MACOMB.mcmb_fnt_enddate_gvt(bk.booking_id)< v_max_date
		and to_char(MACOMB.mcmb_fnt_startdate_gvt(bk.booking_id), 'MM/DD/YYYY') <> to_char(MACOMB.mcmb_fnt_status_startdate(bk.booking_id), 'MM/DD/YYYY') --MAZ exclude recds w/start dt and stat dt are =
	    and bk.booking_id in   -- make sure that 01 = release and 02 = sentenced
	      (select bk.booking_id
		    from EPIC.eh_booking_entity_status bk JOIN EPIC.eh_booking_entity_status bk2
		      on (bk.booking_id = bk2.booking_id)
		    where bk.code_entity_status = '01' AND bk2.code_entity_status = '02')
		      --and mcmb_fnt_sentdate_gvt(bk.booking_id) > ef_min_date('2005061100:00:00-000')--sentenced after June 11 at 00:00
		and MACOMB.mcmb_fnt_enddate_gvt(bk.booking_id) > v_min_date and MACOMB.mcmb_fnt_enddate_gvt(bk.booking_id)< v_max_date
	    and macomb.mcmb_fnt_gvt_days(bk.booking_id) > 0  -- added 10-4-05 per Lori - no records w/days <=0
	
	  order by Flag, InmateNbr;
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_inmate_his_alert_cn
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ32
	Crystal: 		HistoryCurrentNotes.rpt
	Purpose:		Used by Jail Office and other MCSO departments to list inmate's
					history (charges and notes)
                                                   
						Title: CURRENT charges and all notes created/updated during current stay.
						
	Author:			Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					A. Zdybel	02/04/05		Created 
					R. Stuve	02/11/05		Added Inmate ID prompt ($SelectedPerson$) and
												modified for current charges only and modified
												for current (filter on booking_date) notes and 
												deleted Property Bin history notes (per MCSO
												request) from this report	
					DLK			03/08/05		*Rather than re-create the Crystal report due to 
												procedure name change, "mcmb_rpt_HistoryCurrentNotes"
												was renamed "mcmb_rpt_inmate_his_alert_cn".
												*Both sets of data elements were reviewed prior
												and noted to have the same in both procedures.
												*Backup copies of each procedure have been saved
												to the server also. Backup original procedure names:
												mcmb_rpt_HistoryCurrentNotesOr and mcmb_rpt_inmate_his_alert_cnor
												The other option would have been to replace/declare
												all of the elements in Crystal.
												(a re-write of the Crystal report)      
					DLK			03/21/06        ADDED MACOMB AND EPIC NOTATIONS
												
*/
			
BEGIN
	
	OPEN vCur FOR 
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	  
	 FROM DUAL 
	 UNION ALL
	  
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.ef_get_personororgname(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
            
	    FROM
		  		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       UNION ALL
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    
		FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

       UNION ALL
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                 from EPIC.eh_person_snapshot ps where
                 ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType    
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ol.entity_id  
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     


	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
  
		  	UNION 
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(bk.start_date, bk.end_date) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
	    
	        FROM    EPIC.eh_booking bk,
	        		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id
                AND	ch.charge_state <> '6' --RAS: added to pull only current charges
                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information
               AND bk.booking_id = r.booking_id (+)
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION ALL	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
        
        FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk, 
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id 
				AND EPIC.ef_epic_date_to_date(sd.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
     UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
        
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
                                
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
			 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref 
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION  ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      	-- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				AND EPIC.ef_epic_date_to_date(sc.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id 
		 	 	AND EPIC.ef_epic_date_to_date(id.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking   
		 	 	
    				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	                      
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = er.entity_id
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(er.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    			
    	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	                                          
        FROM
		   		EPIC.eh_booking bk,     
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = el.epic_id
		 	 	AND EPIC.el.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(EPIC.el.event_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND ab.booking_id = bk.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 	 	
      UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,  
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
   UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as HONote,
        'HO' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType 
        	                                          
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
	
	     UNION	ALL  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,    
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				     

             UNION	ALL  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    epic.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND bk.entity_id = ks.origin_entity_id 
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
                
	     UNION ALL
	     SELECT DISTINCT     -- Housing Allocation / Moves in date order
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ha.location_id as CLCellID,
		decode(EPIC.ef_location_path_name(ha.location_id,'UC',5),null,EPIC.ef_location_name(ha.location_id,'UC'),
			EPIC.ef_location_path_name(ha.location_id,'UC',5))as CLCellName,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLStartDate,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLEndDate,
	  	loc.gender_physical as CellGender,
	  	loc.classification_low as CellClassLo,
	  	loc.classification_high as CellClassHi,
	  	'CL' as CLType

	    FROM epicaudit.eh_housing_assignments ha,
		EPIC.eh_booking book, 
		EPIC.eh_active_booking ab,
		--added for gender/class of cell
		EPIC.epic_locations loc

	where
		ha.entity_id =	p_InmateID
		and ha.action_type = 'U'
		and ha.entity_id = book.entity_id
		and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)
		and ab.booking_id = book.booking_id
		and (EPIC.ef_epic_date_to_date(ha.action_time) <= EPIC.ef_epic_date_to_date(book.end_date) or EPIC.ef_epic_date_to_date(book.end_date) is null)
		and loc.location_id = ha.location_id
		AND EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)  --RAS: Added to pull notes only attached to current booking
             	
		  UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id;
                
    END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_inmate_his_alert_cnb2  (
          vCur OUT EPIC.epp_generic_ref_cursor.ref_cursor
			) 
/*          dlk        03/22/06              added macomb and epic notations
*/			
	is
	

	BEGIN

	OPEN vCur FOR
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
   
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
            
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       union
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

        union
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	   
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = 
               	    (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                     from EPIC.eh_person_snapshot ps 
                     where ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))    
                     
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --address
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,         
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --drivers license
				AND ep.entity_id = ol.entity_id  
				
				
				--STARTED HERE 1/5/2005
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	   
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime     


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				-- added for alerts
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				--added for Active Alerts
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
				
 	           
 	             
   
			    
			    
		  	UNION
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(EPIC.ef_epic_date_to_date(bk.start_date), EPIC.ef_epic_date_to_date(bk.end_date)) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
	    
	        FROM    EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id

                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information

               AND bk.booking_id = r.booking_id (+)
               
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION  	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND ep.entity_id = a.entity_id
				--added for notes

                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
        
        FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'-- 300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id
     UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
        
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for charge notes
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      
                                
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime       
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      -- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime       
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id    
		 	 	
    				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime     
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added
				AND ep.entity_id = er.entity_id
				-- added to get notes from epic_notes using the
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref
    			
    	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime    
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = EPIC.el.epic_id
		 	 	AND EPIC.el.note_id = n.note_ref
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime    
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
      UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime   
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref
   UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1 as HONote,
        'HO' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
 
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
	
	     UNION	  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
	     UNION
	     SELECT DISTINCT     -- Housing Allocation / Moves in date order
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ha.location_id as CLCellID,
		decode(EPIC.ef_location_path_name(ha.location_id,'UC',5),null,EPIC.ef_location_name(ha.location_id,'UC'),
			EPIC.ef_location_path_name(ha.location_id,'UC',5))as CLCellName,
		EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time) as CLStartDate,
	   	substr(EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLEndDate,
	  	loc.gender_physical as CellGender,
	  	loc.classification_low as CellClassLo,
	  	loc.classification_high as CellClassHi,
	  	'CL' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime 


	    FROM epicaudit.eh_housing_assignments ha,
		EPIC.eh_booking book,
		--added for gender/class of cell
		EPIC.epic_locations loc

	where
		ha.entity_id =	'0I1NSEC000USJ05N'	--'0EUZYQY000NZD02W'
		and ha.action_type = 'U'
		and ha.entity_id = book.entity_id
		and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)
		and (EPIC.ef_epic_date_to_date(ha.action_time) <= EPIC.ef_epic_date_to_date(book.end_date) or EPIC.ef_epic_date_to_date(book.end_date) is null)
		and loc.location_id = ha.location_id
       
    UNION
	     SELECT DISTINCT     -- Bin History Dates
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(min(i.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(min(i.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	max(b.bin_number) as CLBinHis, 
	  	substr(EPIC.ef_epic_date_to_date(max(i.action_time)),1,10) as CLBinEndDate,
	    substr(EPIC.ef_epic_date_to_date(max(i.action_time)),11,6) as CLBinEndTime
	  

		FROM 	epicaudit.otk_property_bin b,
				epicaudit.eh_property_item i,
				epicaudit.eh_offender_property p

		WHERE	p.entity_id = '0I1NSEC000USJ05N'
		     	AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id

	    group by b.bin_number
    
       	
		  UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'   --300171
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime  
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id

      ;
                
    END mcmb_rpt_inmate_his_alert_cnb2;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_inmate_his_alert_cnb3  (
          vCur OUT EPIC.epp_generic_ref_cursor.ref_cursor
			)
/*             dlk         03/22/06       added macomb and epic notations
*/			
			
	is
	

	BEGIN

	OPEN vCur FOR
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType
   
	     
	   
	     
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType
            
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       union
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

        union
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	   
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                 from EPIC.eh_person_snapshot ps where
                 ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --address
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --drivers license
				AND ep.entity_id = ol.entity_id  
				
				
				--STARTED HERE 1/5/2005
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType   


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				-- added for alerts
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				--added for Active Alerts
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
				
 	           
 	             
   
			    
			    
		  	UNION
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(EPIC.ef_epic_date_to_date(bk.start_date), EPIC.ef_epic_date_to_date(bk.end_date)) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
	    
	        FROM    EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc




		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id

                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information

               AND bk.booking_id = r.booking_id (+)
               
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION  	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND ep.entity_id = a.entity_id
				--added for notes

                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
        
        FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'-- 300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id
     UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
        
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for charge notes
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType    
                                
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType     
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      -- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType     
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id    
		 	 	
    				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType   
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added
				AND ep.entity_id = er.entity_id
				-- added to get notes from epic_notes using the
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref
    			
    	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType  
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = EPIC.el.epic_id
		 	 	AND EPIC.el.note_id = n.note_ref
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType  
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
      UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType 
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref
   UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1 as HONote,
        'HO' as HOType,
        ' ' as KSType
 
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
	
	     UNION	  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType    


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType    


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
	     
			 	
		  UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'   --300171
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
   
   
   
        
   UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id

                                           
    
      ;
                
    END mcmb_rpt_inmate_his_alert_cnb3;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_inmate_his_alert_cnor (
          vCur OUT     EPIC.epp_generic_ref_cursor.ref_cursor
			) 
/*          dlk              03/22/06            added macomb and epic notation
*/			
			
	is
	

	BEGIN

	OPEN vCur FOR
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2  
   
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2    
            
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       union
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

        union
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	   
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                 from EPIC.eh_person_snapshot ps where
                 ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --address
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --drivers license
				AND ep.entity_id = ol.entity_id  
				
				
				--STARTED HERE 1/5/2005
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2       


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				-- added for alerts
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				--added for Active Alerts
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
				
 	           
 	             
   
			    
			    
		  	UNION
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(EPIC.ef_epic_date_to_date(bk.start_date), EPIC.ef_epic_date_to_date(bk.end_date)) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
	    
	        FROM    EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id

                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information

               AND bk.booking_id = r.booking_id (+)
               
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION  	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND ep.entity_id = a.entity_id
				--added for notes

                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
        
        FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'-- 300471 '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id
     UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
        
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for charge notes
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        
                                
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2         
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      -- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2         
                                       
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id    
		 	 	
    				
		 UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2       
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added
				AND ep.entity_id = er.entity_id
				-- added to get notes from epic_notes using the
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref
    			
    	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2      
	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = el.epic_id
		 	 	AND el.note_id = n.note_ref
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2    
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2      
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
      UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2     
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref
   UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as HONote,
        'HO' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2    
 
        	                                          
        FROM
		   		EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  '0I1NSEC000USJ05N' --'0HYZMP9000XDPMIG'--'0I00VFI000USJ02Y' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	
		    	--added for notes
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
	
	     UNION	  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2        


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,

				--added for
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
	     UNION
	     SELECT DISTINCT     -- Housing Allocation / Moves in date order
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ha.location_id as CLCellID,
		decode(EPIC.ef_location_path_name(ha.location_id,'UC',5),null,EPIC.ef_location_name(ha.location_id,'UC'),
			EPIC.ef_location_path_name(ha.location_id,'UC',5))as CLCellName,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLStartDate,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLEndDate,
	  	loc.gender_physical as CellGender,
	  	loc.classification_low as CellClassLo,
	  	loc.classification_high as CellClassHi,
	  	'CL' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2   


	    FROM epicaudit.eh_housing_assignments ha,
		EPIC.eh_booking book,
		--added for gender/class of cell
		EPIC.epic_locations loc

	where
		ha.entity_id =	'0I1NSEC000USJ05N'	--'0EUZYQY000NZD02W'
		and ha.action_type = 'U'
		and ha.entity_id = book.entity_id
		and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)
		and (EPIC.ef_epic_date_to_date(ha.action_time) <= EPIC.ef_epic_date_to_date(book.end_date) or EPIC.ef_epic_date_to_date(book.end_date) is null)
		and loc.location_id = ha.location_id
       
    UNION
	     SELECT DISTINCT     -- Bin History Dates
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(min(i.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(min(i.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	max(b.bin_number) as CLBinHis, 
	  	substr(EPIC.ef_epic_date_to_date(max(i.action_time)),1,10) as CLBinEndDate,
	    substr(EPIC.ef_epic_date_to_date(max(i.action_time)),11,6) as CLBinEndTime,
	    'CL' AS CLType2  
	  

		FROM 	epicaudit.otk_property_bin b,
				epicaudit.eh_property_item i,
				epicaudit.eh_offender_property p

		WHERE	p.entity_id = '0I1NSEC000USJ05N'
		     	AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id

	    group by b.bin_number
    
       	
		  UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2    
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'   --300171
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType,
	  	' ' as CLBinHis, 
	  	' ' as CLBinEndDate,
	    ' ' as CLBinEndTime,
	    ' ' AS CLType2  
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id

      ;
                
    END mcmb_rpt_inmate_his_alert_cnor;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_inmate_his_alert_test
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ32
	Crystal: 		HistoryCurrentNotes.rpt
	Purpose:		Used by Jail Office and other MCSO departments to list inmate's
					history (charges and notes)
                                                   
						Title: CURRENT charges and all notes created/updated during current stay.
						
	Author:			Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					A. Zdybel	02/04/05		Created 
					R. Stuve	02/11/05		Added Inmate ID prompt ($SelectedPerson$) and
												modified for current charges only and modified
												for current (filter on booking_date) notes and 
												deleted Property Bin history notes (per MCSO
												request) from this report	
					DLK			03/08/05		*Rather than re-create the Crystal report due to 
												procedure name change, "mcmb_rpt_HistoryCurrentNotes"
												was renamed "mcmb_rpt_inmate_his_alert_cn".
												*Both sets of data elements were reviewed prior
												and noted to have the same in both procedures.
												*Backup copies of each procedure have been saved
												to the server also. Backup original procedure names:
												mcmb_rpt_HistoryCurrentNotesOr and mcmb_rpt_inmate_his_alert_cnor
												The other option would have been to replace/declare
												all of the elements in Crystal.
												(a re-write of the Crystal report) 
					dlk         03/22/06         added macomb and epic notations
					
												
*/
			
BEGIN
	
	OPEN vCur FOR 
 	  SELECT
 	    0   as Flag,
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		''  as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	  
	 FROM DUAL 
	 UNION ALL
	  
	  SELECT DISTINCT
	    10 as Flag,   
	    EPIC.ef_get_personororgname(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		'' as Alias,
		to_char(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		epi.Code_Birthplace_city as BirthCity,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' '  as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
  	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
            
	    FROM
		  		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id 
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
       
       UNION ALL
		select
		20   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		rtrim(EPIC.ef_lookup_text('RACE', er.code_race, ' ')) as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    
		FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_race er

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --race
				AND ep.entity_id = er.entity_id

       UNION ALL
		select --hair color & complexion 
		30  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		rtrim(EPIC.ef_lookup_text('HAIR COLOUR', ps.code_hair_color, '')) as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		rtrim(EPIC.ef_lookup_text('COMPLEXION', ps.code_complexion, '')) as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_person_snapshot ps

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                --complexion
               	AND ep.entity_id = ps.entity_id
               	AND EPIC.ef_epic_date_to_date(ps.date_snapshot) = 
               	    (select max(EPIC.ef_epic_date_to_date(date_snapshot))
                                from EPIC.eh_person_snapshot ps 
                                where ep.entity_id = EPIC.ef_epic_date_to_date(ps.date_snapshot))
union
		select --alias  
		40   as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		MACOMB.mcmb_fnt_alias(bk.entity_id) as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
        ' ' as City,
        ' ' as State,
        ' ' as Zip,
		' ' as Phone,
		' ' as SSN,   
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType    
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking bk,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'	    
        
         union
		select --address information  
		50  as Flag,
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		a.street_number || ' ' || a.street_name as Address,
        a.city_town_locale as City,
        a.state_province_region as State,
        a.postal_code as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
	    
		 FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a


		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
				--AND a.primary_flag = 'Y'
        
        union
		select  -- driver's license - 1  
		60  as Flag, 
		' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		ol.drivers_license_number as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
		' ' as SSN,  
		' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	     null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
 	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	    
		FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_operators_license ol

  		WHERE 	ha.entity_id (+) = bk.entity_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ol.entity_id  
				
	 	                                                
       UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     


	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
				     

             UNION	  
	  SELECT DISTINCT     -- KEEP SEPARATES - "CAUTION NOTES"  
	    70 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ks.separation_reason as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      


	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.origin_entity_id
			    

                                        
	  UNION	  
	  SELECT DISTINCT     -- alerts 4 of them  
	    80 as Flag,   
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ea.alert_type as ActiveAlert, 
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' 
  
		  	UNION 
 	  	SELECT --Charges  
 	  	100 as flag,  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		ca.judge_name as Judge_Name,
	    ec.case_number as Case_No,
	    eha.flat_no_or_floor_level as ArrestingDept,
        es.statute_number as ChargeStatuteNo,
	    MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as ChargeStatuteDesc,
	    EPIC.ef_sentence_length_text(EPIC.ef_epic_date_to_date(bk.start_date), EPIC.ef_epic_date_to_date(bk.end_date)) as Sentence,
	    substr(EPIC.ef_epic_date_to_date(bk.start_date),1, 10) as BookingDate,                         
        substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
        ' ' as Entity_ID,
	    ' ' as Booking_ID,
        sd.years as SentYears,
	    sd.months as SentMths,
	    sd.weeks as SentWeeks,
	    sd.days as SentDays,
	    substr(EPIC.ef_epic_date_to_date(s.sentence_end_date), 1, 10) as ProjectedOutDate,
        substr(EPIC.ef_epic_date_to_date(r.actual_release), 1, 10) as ActualReleaseDate,
        bc.cash_only_bail_amount as BailAmtCash,
        bc.bail_amount as BailAmtBond,
        bc.is_Satisfied as BailPaid,
		' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
	    
	        FROM    EPIC.eh_booking bk,
	        		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--charges
				EPIC.eh_case ec,
				EPIC.eh_charge ch,
				EPIC.eh_case_charge cch,
				--judge
				EPIC.eh_court_appearance ca,
				--arrest dept
				EPIC.eh_address eha,
				EPIC.eh_charge_agency eca,
				EPIC.epic_statutes es,
				--release info
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				-- added
				EPIC.eh_release r,
				-- bail information
				EPIC.eh_bail_condition bc

		WHERE 	ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added for charges
			    AND ch.booking_id (+) = bk.booking_id
                AND bk.booking_id = ec.booking_id (+)
                AND cch.charge_id (+) = ch.charge_id
                AND cch.case_id = ec.case_id
                AND	ch.charge_state <> '6' --RAS: added to pull only current charges
                --for judge initials
                AND ec.case_id = ca.owner_id(+)
                --for arresting dept
                AND eha.entity_id (+) = eca.agency_id
                AND ch.charge_id = eca.charge_id (+)
                --added to get correct statute # and Desc for all charges
                AND es.statute_id (+) = ch.statute_id
                --for sentence info
                --sentence duration and expected out date
				AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id (+)
                AND s.duration_id = sd.sentence_duration_id (+)
                -- added for actual release date information
               AND bk.booking_id = r.booking_id (+)
               -- added to get bail / bond information
               and bk.booking_id =  bc.booking_id
               and bc.cash_only_bail_amount <> 0
	                                            
     UNION ALL	
			  	
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- demographics notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        n.note_name as NoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as Note,
        'DN' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_address a,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE 	ha.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				AND ep.entity_id = a.entity_id
                AND a.entity_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
			
			  	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- food refusal notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		'' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sd.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        sd.refused as FRefused,
        sd.comments as FRefusedComment,
        'FR' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType      
        
        FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk, 
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_service_delivery sd

		WHERE 	ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added to get notes from eh_service_delivery
				-- for info added in OT under Booking, Food Refusal
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sd.booking_id 
				AND EPIC.ef_epic_date_to_date(sd.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
     UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- charges notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        n.note_name as CHNoteName,
        n.note_text_1 || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as CHNote,
        'CH' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
        
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_charge c,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb

		WHERE   ep.entity_id (+) = bk.entity_id 
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
                AND bk.booking_id = c.booking_id
                AND c.charge_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- sentencing  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
        ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        n.note_name as SENoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as SENote,
        'SE' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType       
                                
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			 	EPIC.eh_sentence s,
				EPIC.eh_charge ch,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
			 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		        --added for sentencing notes
               	AND ep.entity_id = bk.entity_id
                AND bk.booking_id = ch.booking_id
                AND ch.sentence_id = s.sentence_id
                AND s.sentence_id = nb.epic_id
			 	AND nb.note_id = n.note_ref 
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    
    UNION  ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- classification  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(sc.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
        sc.override_reason as SCClassOverReas,
        'SC' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_security_classification sc
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		      	-- added to get notes from eh_security_classification
				-- for info added in OT under Booking, Booking Mgt. Class tab
				AND ep.entity_id = bk.entity_id
				AND bk.booking_id = sc.booking_id 
				AND EPIC.ef_epic_date_to_date(sc.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- incidents  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(id.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        id.description as INIncidentDescription,
	    'IN' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType        
                                       
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_incident_offender io,
				EPIC.eh_incident i,
				EPIC.eh_incident_description id
					 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from eh_incident
				-- for info added in OT under Misc, Incidents
				AND ep.entity_id = io.entity_id
		 	 	AND io.incident_id = i.incident_id
		 	 	AND i.incident_id = id.incident_id 
		 	 	AND EPIC.ef_epic_date_to_date(id.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking   
		 	 	
    				
		 UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- restrictions  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(er.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    er.incident_id as DPIncidentId,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),1,10) as DPResBegDate,
        substr(EPIC.ef_epic_date_to_date(er.begin_date),12,5) as DPResBegTime,
        substr(EPIC.ef_epic_date_to_date(er.end_date),1,10) as DPResEndDate,
        substr(EPIC.ef_epic_date_to_date(er.end_date),12,5) as DPResEndTime,
        EPIC.ef_lookup_TEXT('RESTRICTION TYPE', er.code_restriction_type,'UC') as DPResType,
        EPIC.ef_lookup_TEXT('RESTRICTION REASON', er.code_restriction_reason, 'UC') as DPResReason,
        er.comments as DPResComment,
        n.note_name as DPResNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as DPResNote,
        'DP' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType
	  	                      
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_entity_restriction er,
				EPIC.eh_restriction_category rc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = er.entity_id
				AND er.entity_restriction_id = nb.epic_id
		 	 	AND nb.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(er.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
    			
    	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- log notes  
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        el.log_type as LGLogType,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as LGNoteFromEpicNotes,
        'LG' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
	                                          
        FROM
		   		EPIC.eh_booking bk,     
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.epic_note_book nb,
				EPIC.epic_notes n,
				EPIC.epic_entity_log el
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added to get notes from epic_notes using the
				-- epic_entity_log tables
				--used to get notes from the Log-Inmate OT screen
			    AND ep.entity_id = el.epic_id
		 	 	AND el.note_id = n.note_ref 
		 	 	AND EPIC.ef_epic_date_to_date(el.event_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 
	UNION
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking info 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        bk.booking_number as IBBKNumber,
	    ga.attribute_name as IBAttributeName,
	    ga.attribute_value as IBAttributeValue,
	    substr(EPIC.ef_epic_date_to_date(bk.accept_date),1,10) as IBAcceptDate,
	    substr(EPIC.ef_epic_date_to_date(bk.end_date),1,10) as IBEndDate,
	    'IB' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
	    	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for Inmate Bookings
			    AND bk.booking_id = ga.item_id (+)
		    	                                       
	UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),1,10)),
	    	(substr(EPIC.ef_epic_date_to_date(bk.action_time),1,10)))
	    	as NoteDate,
	    nvl((substr(EPIC.ef_epic_date_to_date(n.action_time),11,6)),
	        (substr(EPIC.ef_epic_date_to_date(bk.action_time),11,6)))
	    	as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    bk.booking_number as IB2BKNumber,
	    bk.booking_state as IB2BKState,
	    n.note_name as IB2NoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as IB2Note,
        'IB' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_generic_attribute ga,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				AND ab.booking_id = bk.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	-- added for booking text under Other Attributes for
				-- Inmate Bookings
			    AND bk.booking_id = ga.item_id (+) 
			    AND bk.booking_id = nb.epic_id (+)
		 	 	AND nb.note_id = n.note_ref (+)
		 	 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
		 	 	
      UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- inmate booking notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        n.note_name as BCNoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as BCNote,
        'BC' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType     
        	                                          
        FROM
		   		EPIC.eh_booking bk,  
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_bail_condition bc,
				EPIC.epic_notes n,
				EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
		    	--added for notes
                AND bk.booking_id = bc.booking_id
                AND bc.bail_condition_id = nb.epic_id
				AND nb.note_id = n.note_ref 
				AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				
   UNION ALL
 	  	SELECT DISTINCT 
 	  	10000 as flag, -- holds notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,   
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        n.note_name as HONoteName,
        n.note_text_1  || n.note_text_2 || n.note_text_3 || n.note_text_4 || n.note_text_5 as HONote,
        'HO' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType 
        	                                          
        FROM
		   		EPIC.eh_booking bk, 
		   		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
			    EPIC.eh_booking_holds bh,
				EPIC.epic_notes n,
			 	EPIC.epic_note_book nb
									 				 	
		WHERE   ep.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND epi.entity_id = bk.entity_id (+)
				AND ep.entity_id =  p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'	
				AND ep.entity_id = bk.entity_id
                AND bk.booking_id = bh.booking_id
                AND bh.hold_id = nb.epic_id
			 	AND nb.note_id = n.note_ref
			 	AND EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
	
	     UNION	ALL  
	  SELECT DISTINCT     -- Keep Separate Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --not originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.origin_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate, 
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
	    ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM
		   		EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,    
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                -- added for keep separate inmate ids
                AND bk.entity_id = ks.separate_entity_id
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
				     

             UNION	ALL  
	  SELECT DISTINCT     -- Keep Separates Comments (Notes)  
	    10000 as Flag,   
	    ' ' as Name,      --originating entity_id
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN, 
	    EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
	    EPIC.EF_GET_PERSONORORGNAME(ks.separate_entity_id) as KeepSepName,
	    ' ' as SepReason,
	    ks.comments as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert, 
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(ks.action_time),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType, 
        'KS' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType

	    FROM	
	    	    EPIC.eh_housing_assignments ha,
				EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
                EPIC.eh_keep_separate ks

		WHERE 	ha.entity_id (+) = bk.entity_id  
				and bk.booking_id = ab.booking_id
				AND ep.entity_id (+) = bk.entity_id
				AND epi.entity_id = bk.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND bk.entity_id = ks.origin_entity_id 
                AND EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)  --RAS: Added to pull notes only attached to current booking
                
	     UNION ALL
	     SELECT DISTINCT     -- Housing Allocation / Moves in date order
	    10000 as Flag,
	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Judge_Name,
		' ' as Case_No,
		' ' as ArrestingDept,
		' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as NoteDate,
	    substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),11,6) as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,
        ' ' as FRefused,
        ' ' as FRefusedComment,
   	    ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ha.location_id as CLCellID,
		decode(EPIC.ef_location_path_name(ha.location_id,'UC',5),null,EPIC.ef_location_name(ha.location_id,'UC'),
			EPIC.ef_location_path_name(ha.location_id,'UC',5))as CLCellName,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLStartDate,
		substr(EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)),1,10) as CLEndDate,
	  	loc.gender_physical as CellGender,
	  	loc.classification_low as CellClassLo,
	  	loc.classification_high as CellClassHi,
	  	'CL' as CLType

	    FROM epicaudit.eh_housing_assignments ha,
		EPIC.eh_booking book, 
		EPIC.eh_active_booking ab,
		--added for gender/class of cell
		EPIC.epic_locations loc

	where
		ha.entity_id =	p_InmateID
		and ha.action_type = 'U'
		and ha.entity_id = book.entity_id
		and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)
		and ab.booking_id = book.booking_id
		and (EPIC.ef_epic_date_to_date(ha.action_time) <= EPIC.ef_epic_date_to_date(book.end_date) or EPIC.ef_epic_date_to_date(book.end_date) is null)
		and loc.location_id = ha.location_id
		AND EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(book.start_date)  --RAS: Added to pull notes only attached to current booking
             	
		  UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    rtrim(EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type, ' ')) as Hold_Type,
		EPIC.EF_GET_PERSONORORGNAME(bh.agency_id) as Dept_Held_For,
		bh.code_charge_severity as Severity,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(bh.start_date),1,10)) as Hold_Start,
	   	' ' as HOTypeOA,
		' ' as HOTypeOADesc,
		' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,  
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType   
 
        FROM
		 		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh

		WHERE 	ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID 
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
   
           
   UNION ALL
 	  	SELECT DISTINCT 
 	  	11000 as flag, -- actual holds which appear after all notes 
 	  	' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB, 
		' ' as BirthCity,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
	    ' ' as KeepSepNo,
	    ' ' as KeepSepName,
	    ' ' as SepReason,
	    ' ' as SepComment,
	    ' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
	   	ga.attribute_name as HOTypeOA,
		ga.attribute_value as HOTypeOADesc,
	   	' ' as Jude_Name,
        ' ' as Case_No,
        ' ' as ArrestingDept,
        ' ' as ChargeStatuteNo,
        ' ' as ChargeStatuteDesc,
        ' ' as Sentence,
        ' ' as BookingDate,
        ' ' as BookingTime,
	    ' ' as Entity_ID,
	    ' ' as Booking_ID,
	    null as SentYears,
	    null as SentMths,
	    null as SentWeeks,
	    null as SentDays,
	    null as ProjectedOutDate,
	    null as ActualReleaseDate,    
	    null as BailAmtCash,
        null as BailAmtBond,
        ' ' as BailPaid,
	    ' ' as ActiveAlert,
	    ' ' as Charge,
	    ' ' as NoteDate,
	    ' ' as NoteTime,
	    ' ' as NoteName,
        ' ' as Note,
        ' ' as DNType,		
        ' ' as FRefused,
        ' ' as FRefusedComment,
        ' ' as FRType,
        ' ' as CHNoteName,
        ' ' as CHNote,
        ' ' as CHType,
        ' ' as SENoteName,
        ' ' as SENote,
        ' ' as SEType,
        ' ' as CTNoteName,
        ' ' as CTNote,
        ' ' as CTType,
        ' ' as SCClass,
        ' ' as SCClassRes,
        ' ' as SCClassOverReas,
        ' ' as SCType,
        ' ' as INIncidentDescription,
	    ' ' as INType,
	    ' ' as DPIncidentId,
        ' ' as DPResBegDate,
        ' ' as DPResBegTime,
        ' ' as DPResEndDate,
        ' ' as DPResEndTime,
        ' ' as DPResType,
        ' ' as DPResReason,
        ' ' as DPResComment,
        ' ' as DPResNoteName,
        ' ' as DPResNote,
        ' ' as DPType,
        ' ' as LGLogType,
        ' ' as LGNoteFromEpicNotes,
        ' ' as LGType,
        ' ' as IBBKNumber,
	    ' ' as IBAttributeName,
	    ' ' as IBAttributeValue,
	    ' ' as IBAcceptDate,
	    ' ' as IBEndDate,
	    ' ' as IB1Type,
	    ' ' as IB2BKNumber,
	    ' ' as IB2BKState,
	    ' ' as IB2NoteName,
        ' ' as IB2Note,
        ' ' as IB2Type,
        ' ' as BCNoteName,
        ' ' as BCNote,
        ' ' as BCType,
        ' ' as HONoteName,
        ' ' as HONote,
        ' ' as HOType,
        ' ' as KSType,
        ' ' as CLCellID,
		' ' as CLCellName,
		' ' as CLStartDate,
	   	' ' as CLEndDate,
	  	' ' as CellGender,
	  	' ' as CellClassLo,
	  	' ' as CellClassHi,
	  	' ' as CLType  
 
       FROM
		  		EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				EPIC.eh_booking_holds bh,
				EPIC.eh_generic_attribute ga

		WHERE 	 ep.entity_id (+) = ab.entity_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = p_InmateID
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
                AND ab.booking_id = bh.booking_id
                AND bh.hold_id = ga.item_id;
                
    END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JailPopByCity
		(	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.YY75
	Crystal: 		jailpopbycity.rpt
	Purpose:		Lists Jail Inmates by City in Alpha order

	Author:			Diana Kuykendall

	Change Log:		Changed By	   Date Modified	Change Made
					----------	   -------------	------------------------------------------
					D.Kuykendall   12/01/06		    Created 
					D. Kuykendall  12/28/05			uploaded to OTMain for test on content and design by client	
					DLK            03/20/06         ADDED MACOMB AND EPIC NOTATIONS
					
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Jail Population by City' as RptTitle,				
				' ' as InmateNumber,
		        ' ' as InmateName,
		        ' ' as Address,
		        ' ' as City,
		        ' ' as State,
		        ' ' as Zip

		
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Jail Population by City' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as InmateNumber,
		        EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
		        --mcmb_fnt_address_numstr_dlk(ep.entity_id) as Address,
		  		MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
		        --mcmb_fnt_address_city_dlk(ep.entity_id) as City,
		        MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
		        --mcmb_fnt_address_state_dlk(ep.entity_id) as State,
		        MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
		        --mcmb_fnt_address_postal_dlk(ep.entity_id) as Zip
                MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep
		
		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY City, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JailReimb
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.action_time%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX51
	Crystal: 		jailreimb.rpt
	Purpose:		Used by Reimbursement to list medical expenses/payments for inmates
					during the specified time.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/01/05		Created  
					DLK			021105			added to tree to test  
					R. Stuve	05/28/05		Compiled on OTMAIN 
					R. Stuve	06/21/05		Removed link to booking table to prevent duplicate records   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
					
*/
        v_min_date		EPIC.eh_trans_distribution.action_time%type;  
		v_max_date		EPIC.eh_trans_distribution.action_time%type;  
     	v_date_from		EPIC.eh_trans_distribution.action_time%type;
 		v_date_to		EPIC.eh_trans_distribution.action_time%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Activity from Jail Reimbursement' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Description,
				0 as Amount,
				v_date_null as TDate,
				'' as Reversal
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data 
(
	(
--Medical Fees Charged (510 Expense Account)
	SELECT	2 as Flag,
			'Activity from Jail Reimbursement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(t.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(t.entity_id) as InmateName,
			tat.description as Description,
			tat.amount as Amount,
			EPIC.ef_epic_date_to_date(tat.action_time) as TDate,
			tat.reverse_flag as Reversal

	FROM	EPIC.eh_trust_account t,
			EPIC.eh_trust_account_trans tat

	WHERE	t.trust_account_id = tat.trust_account_id
			and tat.code_source_of_funds = '510'
			and EPIC.ef_epic_date_to_date(tat.action_time) >= v_min_date
			and EPIC.ef_epic_date_to_date(tat.action_time) <= v_max_date
	)

UNION ALL

	(
--Medical Fees Paid (110 Cash Account)
	SELECT	2 as Flag,
			'Activity from Jail Reimbursement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(t.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(t.entity_id) as InmateName,
			concat('PAYMENT: ',d.description) as Description,
			d.amount as Amount,
			EPIC.ef_epic_date_to_date(d.action_time) as TDate,
			'' as Reversal

	FROM	EPIC.eh_trust_account t,
			EPIC.eh_trans_distribution d


	WHERE	t.trust_account_id = d.trust_account_id
			and d.gl_account_number = '110'
			and d.trust_account_trans_id in
							(select trust_account_trans_id
							from EPIC.eh_trans_distribution
							where gl_account_number = '510')
			and EPIC.ef_epic_date_to_date(d.action_time) >= v_min_date
			and EPIC.ef_epic_date_to_date(d.action_time) <= v_max_date
	)
)

ORDER BY Flag, TDate, InmateNum;

END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSBooking
(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN   
					dlk         03/22/06        added macomb and epic notation
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,1,1) as Sort1,
		substr(Cell,3,2) as Sort2
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
  		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
   		and temporary_location_flag = 'N'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
)
GROUP BY Cell
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--this portion pulls the Grand Total for Holding Cells for the area (from the above query)
SELECT  'HCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'A' as Sort1,
		'22' as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
  		and temporary_location_flag = 'N'
 	)
)
-------
UNION ALL
---------
--this portion pulls the Grand Total for Detox Cells for the area (from the above query)
SELECT  'DCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'D' as Sort1,
		'03' as Sort2
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
   			and EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort1 desc, Sort2;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSBotSummary
(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/02/05		Created 
					R. Stuve	06/06/05		Compiled on OTMAIN
					dlk         03/22/06		added macomb and epic notation
	    
*/

BEGIN
	 OPEN vCur FOR	
	SELECT	'PAROLEE' as InmateType,
		count(ha.entity_id) as Count,
		1 as Sort

FROM	EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '3'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEDERAL' as InmateType,
		count(ha.entity_id) as Count,
		2 as Sort

FROM	EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '2'
		and ha.temporary_location_flag = 'N'
---------
UNION ALL
---------

SELECT	'OTHER' as InmateType,
		count(ha.entity_id) as Count,
		3 as Sort

FROM	EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status in ('14','15','16')
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'TOTAL CONTRACT INMATES' as InmateType,
		0 as Count,
		4 as Sort

FROM	dual

---------
UNION ALL
---------

SELECT	'WORK RELEASE' as InmateType,
		count(ha.entity_id) as Count,
		5 as Sort

FROM	EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '5'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'JUVENILES' as InmateType,
		count(ha.entity_id) as Count,
		7 as Sort

FROM	EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_person p

WHERE	ha.entity_id = p.entity_id
		and p.juvenile_flag = 'Y'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'MEDICAL HOSP' as InmateType,
		count(ha.entity_id) as Count,
		8 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like 'HOSPITALS%'
		and EPIC.ef_location_path_name(location_id,'UC',6) not like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'PSYCH HOSP' as InmateType,
		count(ha.entity_id) as Count,
		9 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'WRIT' as InmateType,
		count(ha.entity_id) as Count,
		10 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) = 'WRIT'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		11 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		12 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'MALE' as InmateType,
		count(ha.entity_id) as Count,
		13 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'M'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEMALE' as InmateType,
		count(ha.entity_id) as Count,
		14 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'F'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'UNKNOWN-HIDE' as InmateType,
		count(ha.entity_id) as Count,
		15 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'U'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'TOTAL INMATES' as InmateType,
		0 as Count,
		16 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'UNKNOWN' as InmateType,
		count(ha.entity_id) as Count,
		17 as Sort

FROM	EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'U'
		and ha.temporary_location_flag = 'N'

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSDBlock
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN 
					dlk         03/22/06        added macomb and epic notation
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,2,2) as Sort,
		decode(Cell,'D1PC','01','D2PC','02','D3PC','03','D4PC','04','D5PC','05','D6PC','06') as Sort2
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(ha.entity_id) as Cnt,
		EPIC.ef_location_name(ha.location_id, 'UC') as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE	(EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%LOW D%'
			or EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%UPPER D%') 
		and ha.temporary_location_flag = 'N'	
GROUP BY  EPIC.ef_location_name(ha.location_id, 'UC')
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		EPIC.ef_location_path_name(el.location_id,'UC',7) as Cell
FROM	EPIC.epic_locations el
WHERE	(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%LOW D%'
		 	or EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%UPPER D%')
		and EPIC.ef_location_path_name(EPIC.el.location_id,'UC',7) is not null
GROUP BY EPIC.ef_location_path_name(EPIC.el.location_id,'UC',7)
----------------------------------------------
)
GROUP BY Cell

-----
UNION ALL
------
--this portion pulls the Grand Total for Low D cells (D1PC-D6PC)
SELECT 	'LowDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'7P' as Sort,
		'07' as Sort2
FROM
(
SELECT	sum(Cnt)as CellCnt
FROM
	(SELECT count(ha.entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'LOW D,%'
			and ha.temporary_location_flag = 'N'
	)
)

-------
UNION ALL
---------
--this portion pulls the Grand Total for Upper D cells (D07-D12)
SELECT  'UpperDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'13' as Sort,
		'' as Sort2
FROM
(
SELECT	sum(Cnt)as CellCnt
FROM
	(SELECT count(ha.entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'UPPER D,%'
			and ha.temporary_location_flag = 'N'
	)
)
ORDER BY Sort2, Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSMS
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,3,2) as Sort
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(ha.entity_id) as Cnt,
  		substr(EPIC.ef_location_path_name(ha.location_id, 'UC',6),1,4) as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%MAX%'
		and ha.temporary_location_flag = 'N'
GROUP BY  	substr(EPIC.ef_location_path_name(ha.location_id, 'UC', 6),1,4) 
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		substr(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',6),1,4) as Cell
FROM 	EPIC.epic_locations el
WHERE	EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%MAX%'
		and housing_flag = 'Y'
GROUP BY  substr(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',6),1,4)
----------------------------------------------
)
GROUP BY Cell

-----
UNION ALL
------
--this portion pulls the Grand Total for cell groups MS01-MS06 (from the above query)
SELECT 	'MS01-06Total' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'066' as Sort
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',6),1,4) in ('MS01','MS02','MS03','MS04','MS05','MS06')
			and temporary_location_flag = 'N'
	)
)

-------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups MS07-MS12 (from the above query)
SELECT  'MS07-MS12Total' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'13' as Sort
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',6),1,4) in ('MS07','MS08','MS09','MS10','MS11','MS12') 
			and temporary_location_flag = 'N'
	)
)
ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSStation23
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN    
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,1,1) as Sort

FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
  		substr(EPIC.ef_location_name(location_id, 'UC'),1,2) as Cell
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%STATION%' 
		and temporary_location_flag = 'N'
GROUP BY  substr(EPIC.ef_location_name(location_id, 'UC'),1,2)
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		substr(EPIC.ef_location_name(location_id, 'UC'),1,2) as Cell
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%STATION%'
		and EPIC.ef_location_path_name(location_id, 'UC',7) is not null
GROUP BY  substr(EPIC.ef_location_name(location_id, 'UC'),1,2)
----------------------------------------------
)
GROUP BY Cell


-----
UNION ALL
------
--this portion pulls the Grand Total for cell groups 1A-1D (from the above query)
SELECT  '1A-1DTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'1' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like 'STATION 2,%'
			and temporary_location_flag = 'N'
	)

)

-------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups RA-RD (from the above query)
SELECT  'RA-RDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'R' as Sort
FROM
(
SELECT	SUM(Cnt)as CellCnt
FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like 'STATION 3,%'
			and temporary_location_flag = 'N'
	)
)
ORDER BY Sort, GrandTotal;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSSummary
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/02/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION

*/

BEGIN
	 OPEN vCur FOR
		  SELECT	LocTitle,
		to_number(RDC) as RDC,
		to_number(Count) as Count,
		(RDC - Count) as Var,
		Sort
FROM
(
SELECT	'TOWER 2/3' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 2/3%') as RDC,
		count(ha.entity_id) as Count,
		1 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 3%'
	  and ha.temporary_location_flag = 'N'	

--------
UNION ALL
--------

SELECT	'TOWER 4/5' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 4/5%') as RDC,
		count(ha.entity_id) as Count,
		2 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 5%'
      and ha.temporary_location_flag = 'N'

--------
UNION ALL
--------

SELECT	'TOWER 6/7' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 6/7%') as RDC,
		count(ha.entity_id) as Count,
		3 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 7%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'TOWER 8/9' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 8/9%') as RDC,
		count(ha.entity_id) as Count,
		4 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 9%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'TOWER 10/11' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 10/11%') as RDC,
		count(ha.entity_id) as Count,
		5 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR11%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'MAX SECURITY 1' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Max Security 1%') as RDC,
		count(ha.entity_id) as Count,
		6 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 1%'
     and ha.temporary_location_flag = 'N'

--------
UNION ALL
--------

SELECT	'MAX SECURITY 2' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Max Security 2%') as RDC,
		count(ha.entity_id) as Count,
		7 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 2%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'STATION 2 1A-1D' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Minimum Security 1A-1D%') as RDC,
		count(ha.entity_id) as Count,
		8 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 2%'
      and ha.temporary_location_flag = 'N'

--------
UNION ALL
--------

SELECT	'STATION 3 2A-2D' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Minimum Security 2A-2D%') as RDC,
		count(ha.entity_id) as Count,
		9 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 3%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'D01-D06' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D01-D06%') as RDC,
		count(ha.entity_id) as Count,
		10 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MED CONTRL, LOW D%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'D07-D12' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D07-D12%') as RDC,
		count(ha.entity_id) as Count,
		11 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MH CONTRL, UPPER D%'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'MH1-17' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('MH1-17%') as RDC,
		count(ha.entity_id) as Count,
		12 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, LOW%'
      and ha.temporary_location_flag = 'N'

--------
UNION ALL
--------

SELECT	'MH18-24' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('MH18-24%') as RDC,
		count(ha.entity_id) as Count,
		13 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, HIGH%'
      and ha.temporary_location_flag = 'N'

--------
UNION ALL
--------

SELECT	'BOOKING A-C' as LocTitle,
		to_char(to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking A%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking B%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking C%'))) as RDC,
		count(ha.entity_id) as Count,
		14 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) in ('BOOKING, A','BOOKING, B','BOOKING, C')
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'ANNEX-A' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Annex A%') as RDC,
		count(ha.entity_id) as Count,
		15 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, A'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'ANNEX-B' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Annex B%') as RDC,
		count(ha.entity_id) as Count,
		16 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, B'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'BREAK' as LocTitle,
		'0' as RDC,
		0 as Count,
		17 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'RATED DESIGN CAPACITY' as LocTitle,
		'0' as RDC,
		0 as Count,
		18 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'BOOKING HOLDING CELLS' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Booking Holding Cells%') as RDC,
		count(ha.entity_id) as Count,
		19 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'HOLDING%'
        and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'MEDICAL UNIT' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('Medical Unit%') as RDC,
		count(ha.entity_id) as Count,
		20 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'MED CONTRL, MEDICAL'
      and ha.temporary_location_flag = 'N'
--------
UNION ALL
--------

SELECT	'TOTAL BEDS' as LocTitle,
		'0' as RDC,
		0 as Count,
		21 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'GENERAL USE BEDSPACE' as LocTitle,
		'0' as RDC,
		0 as Count,
		22 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'BREAK' as LocTitle,
		'0' as RDC,
		0 as Count,
		23 as Sort

FROM	dual
)

GROUP BY LocTitle, RDC, Count, Sort

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS

*/

BEGIN
  OPEN vCur FOR
--2/3: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		2 as Sort2
FROM
(
----------------------------------------------
--2/3: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--2/3: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups A-C
SELECT 	'2/3: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		2 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2A','3A','2B','3B','2C','3C')
	)
)

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups D-F
SELECT 	'2/3: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		2 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2D','3D','2E','3E','2F','3F')
	)
)

------
UNION ALL
------
--4/5: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		4 as Sort2
FROM
(
----------------------------------------------
--4/5: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--4/5: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups A-C
SELECT 	'4/5: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		4 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4A','5A','4B','5B','4C','5C')
	)
)

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups D-F
SELECT 	'4/5: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		4 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4D','5D','4E','5E','4F','5F')
	)
)

--------
UNION ALL
--------

--6/7: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		6 as Sort2
FROM
(
----------------------------------------------
--6/7: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--6/7: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups A-C
SELECT 	'6/7: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		6 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6A','7A','6B','7B','6C','7C')
	)
)

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups D-F
SELECT 	'6/7: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		6 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6D','7D','6E','7E','6F','7F')
	)
)

--------
UNION ALL
--------
--8/9: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		8 as Sort2
FROM
(
----------------------------------------------
--8/9: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--8/9: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups A-C
SELECT 	'8/9: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		8 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8A','9A','8B','9B','8C','9C')
	)
)

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups D-F
SELECT 	'8/9: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		8 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8D','9D','8E','9E','8F','9F')
	)
)

-------
UNION ALL
-------
--10/11: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		10 as Sort2
FROM
(
----------------------------------------------
--10/11: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--10/11: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups A-C
SELECT 	'10/11: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		10 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10A','11A','10B','11B','10C','11C')
	)
)

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups D-F
SELECT 	'10/11: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		10 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10D','11D','10E','11E','10F','11F')
	)
)

ORDER BY Sort2, Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower1011
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created 
					R. Stuve	06/06/05		Compiled on OTMAIN  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--10/11: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--10/11: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--10/11: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups A-C
SELECT 	'10/11: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10A','11A','10B','11B','10C','11C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups D-F
SELECT 	'10/11: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10D','11D','10E','11E','10F','11F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower23
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--2/3: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--2/3: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--2/3: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups A-C
SELECT 	'2/3: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2A','3A','2B','3B','2C','3C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups D-F
SELECT 	'2/3: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2D','3D','2E','3E','2F','3F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower45
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN  
					DLK			03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--4/5: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--4/5: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--4/5: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups A-C
SELECT 	'4/5: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4A','5A','4B','5B','4C','5C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups D-F
SELECT 	'4/5: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4D','5D','4E','5E','4F','5F')   
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower67
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--6/7: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--6/7: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--6/7: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups A-C
SELECT 	'6/7: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6A','7A','6B','7B','6C','7C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups D-F
SELECT 	'6/7: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6D','7D','6E','7E','6F','7F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_JCSTower89
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
	    
*/

BEGIN
  OPEN vCur FOR	
--8/9: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--8/9: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--8/9: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups A-C
SELECT 	'8/9: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8A','9A','8B','9B','8C','9C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups D-F
SELECT 	'8/9: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8D','9D','8E','9E','8F','9F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_KtchTrusSnrty
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.XX10
	Crystal: 		KtchTrusSnrty.rpt
	Purpose:		Used by Jail Admin(Lt Moore)  -- Classification tree node
	                CKT =  Current Kitchen Trustee's in order by date they became a KT housed in RA or RB
                    PKT =  next possible trustee housed in 1B unit
                    
	Author:			Mary Ann Zak (CR/PROCEDURE) / Glenn Sopfe (SELECT STATEMENT)

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak  		12-19-05        Created  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
						    
*/

BEGIN 

  OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as CellLoc,
				'' as HouseDate,
				'' as KTStatus
	   
		FROM	dual
		
----------
UNION ALL
----------
		--the below query pulls back the actual report data	
		SELECT 2 as Flag,
	           'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
               EPIC.ef_offender_id (ab.entity_id) as InmateNum,
               EPIC.ef_get_personororgname (ab.entity_id) as InmateName,
               EPIC.ef_Offender_Housing (ab.entity_id) as CellLoc,
               substr(EPIC.ef_epic_date_to_date(ha.action_time),1,10) as HouseDate,
               'CKT' as KTStatus  -- CKT = for CR grouping Current Kitchen Trustees  -- maz added

        FROM   EPIC.eh_active_booking ab,
	           EPIC.eh_housing_assignments ha

        WHERE  ha.entity_id = ab.entity_id
		       AND (substr(EPIC.ef_Offender_Housing (ab.entity_id),1,2)= 'RA' or  substr(EPIC.ef_Offender_Housing (ab.entity_id),1,2)= 'RB')

 ----------
UNION ALL
----------

		-- for report as to next possible trustee housed in 1B unit
		SELECT 3 as Flag,
	           'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
	           EPIC.ef_offender_id (ab.entity_id) as InmateNum,
       		   EPIC.ef_get_personororgname (ab.entity_id) as InmateName,
               EPIC.ef_Offender_Housing (ab.entity_id) as CellLoc,
               substr(EPIC.ef_epic_date_to_date(ha.action_time),1,10) as HouseDate,
               'PKT' as KTStatus  -- PKT = for CR grouping Possible Kitchen Trustees  -- maz added

		FROM   EPIC.eh_active_booking ab,
	           EPIC.eh_housing_assignments ha

        WHERE  substr(EPIC.ef_Offender_Housing(ab.entity_id),1,2)='1B'
	           AND ha.entity_id = ab.entity_id

ORDER BY KTStatus, HouseDate, InmateName;

END;




/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_LC_Minors
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX58
	Crystal: 		LC_Minors.rpt
	Purpose:		To list inmates that reside in jail age 15 - 17 for a given booking date range.
					requested by Jon Weatherup

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak	    11/17/05		Created
					M.Zak       12-2-05         OT Main  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION 
					R. Stuve    4/12/06			Verified EPIC and MACOMB schemas and added logic to
												where clause to discount rejected bookings
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Lanse Creuse Minors Residing in Jail' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				v_date_null as BookingDate,
				v_date_null as ActualReleaseDate
					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Lanse Creuse Minors Residing in Jail' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(ep.entity_id),EPIC.ef_epic_date_to_date(bk.start_date)) as AgeatBooking,
            	EPIC.ef_offender_id(ep.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
   		    	MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
	        	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
	        	EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate
		    		    	

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_release r,
		    	EPIC.eh_entity_person ep

		WHERE 	bk.booking_id = r.booking_id (+)  
				and bk.entity_id = ep.entity_id   
				and EPIC.ef_epic_date_to_date(bk.start_date) >= v_min_date 
				and EPIC.ef_epic_date_to_date(bk.start_date) <=v_max_date 
				and bk.booking_state <> '2' --RAS: added on 4/12 to discount bookings that had been rejected
                and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(ep.entity_id), EPIC.ef_epic_date_to_date(bk.start_date)) >= 5
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(ep.entity_id), EPIC.ef_epic_date_to_date(bk.start_date)) <= 17		
		
				
ORDER BY  Inmatename, bookingdate asc;    

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_LC_Minors_30
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX59
	Crystal: 		LC_Minors_30.rpt
	Purpose:		To list inmates that reside in jail age 15 - 17 for a given booking date range resided in jail for more
	                than 30 days. Total number of residents, aged 5-17 inclusive, who during the period of (ex.9/2/05 thru 11/29/05 )
	                resided in jail for 30+ consecutive days (at least one of these days must been in October)).
                    requested by Jon Weatherup

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak	    12/02/05		Created
					M. Zak      12/2/05         OT Main
					R. Stuve    4/12/06			Verified EPIC and MACOMB schemas and added logic to
												where clause to discount rejected bookings
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type; 
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Lanse Creuse Minors Residing in Jail 30+ days' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				v_date_null as BookingDate,
				v_date_null as ActualReleaseDate
					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Lanse Creuse Minors Residing in Jail 30+ Days' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(bk.entity_id),EPIC.ef_epic_date_to_date(bk.start_date)) as AgeatBooking,
            	EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
   		    	MACOMB.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
	         	EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate
		    		    	

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_release r

		WHERE 	bk.booking_id = r.booking_id (+)  
				and EPIC.ef_epic_date_to_date(bk.start_date) >= v_min_date 
				and EPIC.ef_epic_date_to_date(bk.start_date) <=v_max_date
				and bk.booking_state <> '2' --RAS: added on 4/12 to discount bookings that had been rejected
			    and EPIC.ef_epic_date_to_date(bk.start_date) <= (to_date(v_max_date)-30) 
				and (EPIC.ef_epic_date_to_date(r.actual_release) is null 
					or (EPIC.ef_epic_date_to_date(r.actual_release) >= (to_date(v_min_date)+30)) 
			 	and to_date(substr(EPIC.ef_epic_date_to_date(r.actual_release),1,10)) - to_date(substr(EPIC.ef_epic_date_to_date(bk.start_date),1,10))+ 1 >= 30)
			 	and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(bk.entity_id), EPIC.ef_epic_date_to_date(bk.start_date)) >= 5
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(bk.entity_id), EPIC.ef_epic_date_to_date(bk.start_date)) <= 17	

ORDER BY  Inmatename, bookingdate asc;   


END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_LgyVoidBkFees
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY58
	Crystal: 		lgyvoidbkfees.rpt
	Purpose:		Used by Accounting to track voided booking fees from converted legacy data

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/15/05		Created 
					DLK			06/16/05		Development in Crystal begins  
					DLK			06/20/05		Upload to Report Tree (OTMain) for test   
					dlk         03/22/06        added macomb and epic notations 
					
*/


BEGIN 
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Legacy: Voided Booking Fees' as RptTitle,
				'' as InmateNum,
				0 as Amt,
				'' as LastName,
				'' as FirstName				
		
		FROM	dual
		
	UNION ALL
	
		--the below query pulls back the actual report data	
		SELECT  2 as Flag,
				'Legacy: Voided Booking Fees' as RptTitle,
		 		 EPIC.ef_offender_id(pi.entity_id) as InmateNum,
				td.amount as Amt,
				pi.name_family as LastName,
				pi.name_first as FirstName

		FROM	 EPIC.eh_trans_distribution td,
				 EPIC.eh_trust_account ta,
				 EPIC.eh_person_identity pi
	
		WHERE	td.gl_account_number = '499' AND
				(td.description = 'VBKC' or td.description = 'VBKS') and
				td.trust_account_id = ta.trust_account_id and
				ta.entity_id = pi.entity_id and
				pi.code_name_type = 'MAS'
				       
		ORDER BY Flag, LastName;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MoJuv_Summary_CRE
	(	p_StartDate 		in		EPIC.eh_booking.start_date%type,
	    p_EndDate           in      EPIC.eh_booking.start_date%type,
	    vCur        		out     EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		MoJuvsum_CRE.rpt
	Purpose:		To list Juvenile inmates for a given monthly booking date range.
					requested by Michelle Sanborn  (with a Booking Date greater than 06/01/2005) 

	Author:			Mary Ann (CRE) / Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					d. Kuykendall	12/27/05		added additional substr to remove the time from the DOB
					M. Zak          1-4-06          Created CRE version of mcmb_rpt_MO_Juvenile_Summary  
					dlk             03/22/06        added macomb and epic notation
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_null		date; 
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  
       
		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_null := null;
   		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		
	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	
			
	select distinct  2 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(ep.entity_id) as InmateNum,
	        	to_char(substr(MACOMB.mcmb_fnt_DOB(ep.entity_id),1,10)) as DOB,
                MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
				MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Most_Serious_Offense, --returns the description of the charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				MACOMB.mcmb_fnt_sent_date(bk.booking_id) as Adjudicated, --if sentenced then this is not a juvenile?
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				EPIC.ef_epic_date_to_date(r.actual_release) as Release_DateTime
				

From 			EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_release r,
		    	EPIC.eh_entity_person ep,
		    	EPIC.eh_charge ch,
		    	EPIC.epic_statutes es


Where			bk.booking_id = r.booking_id (+)
				and bk.entity_id = ep.entity_id
				and bk.booking_id = ch.booking_id
				and es.statute_id = ch.statute_id
				and (EPIC.ef_epic_date_to_date(bk.start_date) >  v_min_date and  EPIC.ef_epic_date_to_date(bk.start_date) <=  v_max_date)
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(ep.entity_id)),EPIC.ef_epic_date_to_date(bk.start_date)) < 17
				and ((MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(ep.entity_id)),EPIC.ef_epic_date_to_date(bk.start_date))) >= 5
				and (MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(ep.entity_id)),EPIC.ef_epic_date_to_date(bk.start_date)) < 17 ))

order by InmateNum;
    

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MoJuv_Summary_SCH
	(	vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRYSTAL ENTERPRISE - SCHEDULE (Automatic email - monthly)
	Crystal: 		MoJuvsum_CRE_SCH.rpt
	Purpose:		To list Juvenile inmates for prior month of sysdate.
					requested by Sgt Roberts - scheduled report to run once a month and email to state 
					set up to email to Sgt Roberts to review and then he can forward email   

	Author:			Mary Ann (SCH)  / Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					d. Kuykendall	12/27/05		added additional substr to remove the time from the DOB
					M. Zak          1-6-06          Created CRE schedule version of mcmb_rpt_MO_Juvenile_Summary 
					M. Zak          4-5-06          Copied modified select logic from mcmb_rpt_MO_Juvenile_Summary
*/
	
		vStartDate      EPIC.eh_booking.start_date%type; 
		vEndDate        EPIC.eh_booking.start_date%type;    
    	v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_null		date; 
 		
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_date_null := null;
        vStartDate := EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2))))); --  -2 go back to previous month used to pull data back
        vEndDate := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))));      -- used to pull data back
        v_date_from := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2)))), EPIC.ef_date_format),1,100); -- display only in report
		v_date_to := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))), EPIC.ef_date_format),1,100); -- display only in report
		
		             
		             
		             
		             
	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				--0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			    --'' as MostSerious	
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	

select distinct  2 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	EPIC.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				decode(MACOMB.mcmb_fnt_sent_date(bk.booking_id), NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				MACOMB.mf_actualrelease(bk.booking_id) as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 


From 			EPIC.eh_booking bk

Where			(EPIC.ef_epic_date_to_date(bk.start_date) >= vStartDate and  EPIC.ef_epic_date_to_date(bk.start_date) <= vEndDate)
      			and  MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(bk.entity_id),EPIC.ef_epic_date_to_date(bk.start_date)) < 17
				
				
				
				
				
order by InmateNum;    

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MonthlyIncar
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.YY35
	Crystal: 		monthlyincarcerated.rpt
	Purpose:		Returns a summary count of inmates booked during the selected month--  
					Number per day and per shift

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created
					R. Stuve	05/11/05		Changed DisplayDate to calculate from Oracle date to resolve
												incorrect parsing due to GMT time calculation
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/22/05		Commented DisplayDate and added mcmb_fnt_JuvFlag: recompiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  :=  substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				v_date_null as BookingDate,
				--'' as DisplayDate,
				'' as Juvenile,
				'' as Gender,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Monthly Incarceration' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateID,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				--to_char(substr(ef_epic_date_to_date(b.start_date),4,2)) as DisplayDate,
					--we will be using the BookingDate to display on the report to display the full date
  				MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  				MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  				decode(to_char(substr((EPIC.ef_epic_date_to_date(b.start_date)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

	FROM  	EPIC.eh_booking  b

	WHERE  	EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) <= v_max_date

ORDER BY Flag, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MonthlyRelease
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.YY23
	Crystal: 		MonthlyRelease.rpt
	Purpose:		Used by the Jail Office to summarize the Daily Release report: lists inmates who have already been
					physically released during the selected dates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created
					R. Stuve	05/11/05		Changed DisplayDate to calculate from Oracle date to resolve
												incorrect parsing due to GMT time calculation
					R. Stuve	05/28/05		Compiled on OTMAIN                                                      
					R. Stuve	06/22/05		Commented DisplayDate and added mcmb_fnt_JuvFlag: recompiled on OTMAIN  
					dlk         03/22/06        added macomb and epic notation
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Release' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				v_date_null as ReleaseDate,
				--'' as DisplayDate,
				'' as Juvenile,
				'' as Gender,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Monthly Release' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateID,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
				--to_char(substr(ef_epic_date_to_date(r.actual_release),4,2)) as DisplayDate,
					--we will be using the ReleaseDate to display on the report to display the full date
		  		MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
		  		MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
		  		decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

			FROM  	EPIC.eh_booking  b,
		  			EPIC.eh_release r

			WHERE  	b.booking_id = r.booking_id
					and EPIC.ef_epic_date_to_date(r.actual_release) >= v_min_date 
					and EPIC.ef_epic_date_to_date(r.actual_release) <= v_max_date

ORDER BY Flag, ReleaseDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MO_Juvenile_Summary
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX57
	Crystal: 		MO_Juvenile_Summary.rpt
	Purpose:		To list Juvenile inmates for a given monthly booking date range.
					requested by Michelle Sanborn  (with a Booking Date greater than 06/01/2005) 

	Author:			Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					M Zak            3-17-06        Modified from/where stmt
					M Zak            4-4-06         removed tables from where clause and used functions
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	
			
	select distinct  2 as Flag,
				'Monthly Juvenile Summary' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	MACOMB.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				decode(bk.sentence_start_date, NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				MACOMB.mf_actualrelease(bk.booking_id) as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 


From 			EPIC.eh_booking bk

Where			EPIC.ef_epic_date_to_date(bk.start_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(bk.start_date) <= v_max_date
      			and MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(MACOMB.mcmb_fnt_DOB(bk.entity_id),EPIC.ef_epic_date_to_date(bk.start_date)) < 17

order by InmateNum;
    

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MultiCtrAgy
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ80
	Crystal: 		MultiCtrAgy.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have more than
					one controlling agency per charge

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created   
					DLK			05/31/05		Crystal report created/uploaded for test 
					R. Stuve	06/06/05		Compiled on OTMAIN 
					dlk         03/22/06        added macomb and epic notation
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Multiple Control Agencies' as RptTitle,
				'' as InmateNum,
				'' as InmateName
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Exception: Multiple Control Agencies' as RptTitle,
				EPIC.ef_offender_id(EPIC.ef_get_entity_from_book(cc.booking_id)) as InmateNum,
				EPIC.ef_get_personororgname(EPIC.ef_get_entity_from_book(cc.booking_id)) as InmateName

		FROM 	EPIC.eh_charge_agency ca,
				EPIC.eh_charge_agency ca2,
				EPIC.eh_charge cc
		
		WHERE	ca.charge_id = ca2.charge_id
				and ca.agency_id <> ca2.agency_id
				and cc.charge_id = ca2.charge_id

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_MusterNotCount
(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ40
	Crystal: 		musternotcount.rpt
	Purpose:		Used by the Jail Office to track inmates added to muster, but not
					to count (most often a data-entry error)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/25/05		Created  
					DLK			03/25/05		Added to report tree for test  
					R. Stuve	05/24/05		Compiled on OTMAIN   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
*/                 
			
BEGIN  

	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Inmates on Muster but Not on Count' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Count
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Inmates on Muster but Not on Count' as RptTitle,
				EPIC.ef_offender_id(m.entity_id) as InmateNum,
      			EPIC.ef_get_personororgname(m.entity_id) as InmateName,
      			EPIC.ef_offender_housing(m.entity_id) as Cell,
      			m.in_muster_flag as Count

		FROM    EPIC.eh_muster m

		WHERE	m.in_muster_flag = 'N'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
Procedure     mcmb_rpt_NeedsClassify
--saved as a backup copy only

--	12/16/04	Bob Meeks
--	Take the rpt_not_classified_proc and modify it for Macomb County.  Saving it as a new
--  report procedure and will use the same Crystal Report (ICL1_2_3_4.rpt), but will have its own form usage 

/*         DLK        03/22/06            ADDED MACOMB AND EPIC NOTATIONS
*/

	(RPT_Not_Classified	IN OUT	EPIC.epp_generic_ref_cursor.ref_cursor,
	P_Form_usage		IN		EPIC.epic_form.Form_usage%type,
	P_UserID			In		EPIC.epic_user_names.user_int_id%type,
	p_Location			IN		EPIC.EPIC_LOCATIONS.LOCATION_ID%type,
	p_end_date			in		EPIC.eh_security_classification.next_review_date%type
)
          
AS
	lookup_code			constant varchar2(10) := 'CRSTL.';
	Form_usage			constant varchar2(10) := P_Form_usage;
	v_security_object	constant EPIC.epic_user_objects.object_code%type := lookup_code || P_Form_usage;

	Report_Title		EPIC.epic_col_types.varchar_255%type;
	Report_Version		EPIC.epic_col_types.varchar_255%type;
	InsititionName		EPIC.epic_col_types.varchar_255%type;
	EnterpriseName		EPIC.epic_col_types.varchar_255%type;
	PageBreak			EPIC.epic_col_types.varchar_255%type;
	f_Enterprise		EPIC.epic_col_types.varchar_255%type;
	f_Location			EPIC.epic_col_types.varchar_255%type;
	f_LocationID		EPIC.epic_col_types.varchar_255%type;
	f_Off_Ident_Col		EPIC.epic_col_types.varchar_255%type;

	p_result			number(9,0);
	p_result_msg		varchar2(255);
	v_review			EPIC.epic_configuration.config_value%type;
	n_review			integer;
--	v_review_date		epic_col_types.varchar_255%type;
	v_next_review_date	EPIC.eh_security_classification.next_review_date%type;
	f_review_date		EPIC.epic_col_types.varchar_255%type;
	f_today_date		EPIC.epic_col_types.varchar_255%type;
	f_location_type		varchar2(255);

	v_modified_charges	EPIC.epic_configuration.config_value%type;
	v_new_charges     	EPIC.epic_configuration.config_value%type;
	v_new_holds			EPIC.epic_configuration.config_value%type;
	v_new_incidents		EPIC.epic_configuration.config_value%type;

BEGIN

	Report_Title	:=	substr(EPIC.ef_lookup_text ('REPORT TREE', lookup_code || Form_usage, 'IC'),1,255);
	Report_Version	:=	substr(EPIC.ef_ReportVersion (Form_usage),1,255);
	InsititionName	:=	substr(EPIC.ef_get_Licensee('ABOUT', 'LICENSEE'),1, 255);
	EnterpriseName	:=	substr(EPIC.ef_get_Enterprise, 1, 255);
	f_Off_Ident_Col	:=	substr(initcap(EPIC.ef_config_offender_id),1,200) || ':';

--	ep_log_info(Report_Title, 'R', -1, Report_Title ||' Report_Version: ' || Report_Version);

	v_next_review_date := p_end_date;
--	f_review_date		:=	substr(to_char(ef_epic_date_to_date(v_review_date), ef_date_format),1,100) ;
--	f_today_date		:=	substr(to_char(ef_epic_date_to_date(epicdatenow), ef_date_format),1,100);
	f_today_date		:=	substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(v_next_review_date)), EPIC.ef_date_format),1,100) ;
	f_review_date		:=	substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdatenow), EPIC.ef_date_format),1,100);


	-- determine which conditions should cause someone to appear on the
	-- report.  All of these default to N, which means the base report is the same
	-- as before.
--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE MODIFIED CHARGES', v_modified_charges, 'N', p_result, p_result_msg);
--	if v_modified_charges is null then
		v_modified_charges := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW CHARGES', v_new_charges, 'N', p_result, p_result_msg);
--	if v_new_charges is null then
		v_new_charges := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW HOLDS', v_new_holds, 'N', p_result, p_result_msg);
--	if v_new_holds is null then
		v_new_holds := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW INCIDENTS', v_new_incidents, 'N', p_result, p_result_msg);
--	if v_new_incidents is null then
		v_new_incidents := 'Y';
--	end if;


	if Form_usage = 'ICX1' THEN		-- Enterprise Report
		f_LocationID	:=	EPIC.ef_get_EnterpriseID;
		f_location_type := 'ENTERPRISE';
	else
		f_LocationID	:=	p_Location;
	end if;

	if Form_usage = 'ICX2' then
		f_location_type := 'REGION';
	end if;
	if Form_usage = 'ICX3' then
		f_location_type := 'FACILITY';
	end if;
	if Form_usage = 'ICX4' then
		f_location_type := 'UNIT';
	end if;

	PageBreak	:=	EPIC.ef_Report_PageBreak(f_LocationID);
	f_Location	:=	substr(EPIC.ef_location_name(f_LocationID, ''),1,200);

	OPEN RPT_Not_Classified FOR
		SELECT
			1					as flag,	-- Page Header Section of Report
			Report_Title		as	Report_Title,
			Report_Version		as	Report_Version,
			InsititionName 		as	Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(f_LocationID),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			0					as	ChildLevel,
			' '					as 	ChildLocation,
			' '					as 	ChildType,
			' '					as 	Offender_Name,
			' '					as 	Offender_Ident,
			f_review_date		as 	Review_date1,
			f_today_date		as 	Review_date2,
			v_review			as	Review_Period,
			' '					as  dob,
			' '					as  secclass,
			' '					as  sortdate
		FROM DUAL
		UNION
		--
		--	the section below finds all persons on muster with active bookings
		--		who have NO classifications for the booking
		--
/*		SELECT  distinct
			2	as flag,
			'NO CLASSIFICATION'	as	Report_Title,
			' '	as	Report_Version,
			substr(ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col			as	Offender_Ident_Col,
			f_Location				as 	Location_Name,
			substr(ef_location_type_name(elc.location_id),1,200) as Location_Type,
			PageBreak				as	PageBreak,
			nvl(ef_location_level(ef_sub_location(em.Entity_ID, elc.location_id)), 99)
									as	ChildLevel,
			substr(ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
									as ChildLocation,
			substr(ef_location_type_name(ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
									as ChildType,
			substr(decode(
				ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				ef_get_personororgname(em.Entity_ID)), 1, 255)
									as 	Offender_Name,
			substr(decode(
				ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				ef_offender_ident(em.Entity_ID)), 1, 255)
									as 	Offender_Ident,
			' '						as 	Review_date1,
			' '						as 	Review_date2,
			' '						as  Review_Period
		from
			EH_ACTIVE_BOOKING ab,
			eh_muster em,
			eh_Housing_assignments ua,
			epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID			--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.Entity_ID = ab.Entity_ID
			and	not exists (select 1
				from	EH_SECURITY_CLASSIFICATION sc
				where	ab.BOOKING_ID = sc.BOOKING_ID)
		Union
*/
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at a subordinate location of the location parameter
		--
		SELECT  distinct
			3	as flag,
			'SCHEDULED'	as	Report_Title,
			' '	as	Report_Version,
			substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)), 99)
								as	ChildLevel,
			substr(EPIC.ef_sub_location_name(em.Entity_ID, EPIC.elc.location_id), 1, 255)
								as ChildLocation,
			substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)),1,200)
								as ChildType,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(v_next_review_date)), EPIC.ef_date_format), 1,100) as Review_date2,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.review_date)), EPIC.ef_date_format),1,100)
								as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate
		from
			EPIC.eh_muster em,
			EPIC.EH_Housing_ASSIGNMENTS ua,
			EPIC.EH_ACTIVE_BOOKING ab,
			EPIC.EH_SECURITY_CLASSIFICATION sc,
			EPIC.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	EPIC.elc.child_location_id = ua.LOCATION_ID
			and	EPIC.elc.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	EPIC.ef_epic_date_to_date(sc.review_date) < EPIC.ef_epic_date_to_date(v_next_review_date)
			and not exists (select 1 from EPIC.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and EPIC.ef_epic_date_to_date(sc2.action_time) > EPIC.ef_epic_date_to_date(sc.action_time))
			and EPIC.ef_epic_date_to_date(sc.next_review_date) is not null and EPIC.ef_epic_date_to_date(sc.next_review_date) < EPIC.ef_epic_date_to_date(v_next_review_date) 
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
		Union
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at the location parameter
		--
		SELECT  distinct
			3					as flag,
			'SCHEDULED'					as	Report_Title,
			' '					as	Report_Version,
			substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			99					as	ChildLevel,
			' ' 				as ChildLocation,
			'HOUSED AT ' || f_location_type || ' LEVEL'					as ChildType,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(v_next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.review_date)), EPIC.ef_date_format),1,100)
								as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate

		from
			EPIC.eh_muster em,
			EPIC.EH_Housing_ASSIGNMENTS ua,
			EPIC.EH_ACTIVE_BOOKING ab,
			EPIC.EH_SECURITY_CLASSIFICATION sc
		where
				em.Entity_ID = ua.Entity_ID
			and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	EPIC.ef_epic_date_to_date(sc.review_date) < EPIC.ef_epic_date_to_date(v_next_review_date)
			and not exists (select 1 from EPIC.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and EPIC.ef_epic_date_to_date(sc2.action_time) > EPIC.ef_epic_date_to_date(sc.action_time))
			and (EPIC.ef_epic_date_to_date(sc.next_review_date)) is not null and EPIC.ef_epic_date_to_date(sc.next_review_date) < EPIC.ef_epic_date_to_date(v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
   --******************************************************************
   --
   --                        Inmates at, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(ch.action_time) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and EPIC.ef_epic_date_to_date(ach.action_time) < EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(EPIC.elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = EPIC.elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(ch.action_time) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and EPIC.ef_epic_date_to_date(ach.action_time) < EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(ch.action_time) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and EPIC.ef_epic_date_to_date(ach.action_time) < EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(EPIC.elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = EPIC.elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(ch.action_time) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and   sc.booking_id = ab.booking_id
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and EPIC.ef_epic_date_to_date(ach.action_time) < EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date))), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_booking_holds hld,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	EPIC.ef_epic_date_to_date(hld.start_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(EPIC.elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, EPIC.elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, EPIC.elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_booking_holds hld,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(hld.start_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_booking_holds hld,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	EPIC.ef_epic_date_to_date(hld.hold_removed_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(EPIC.elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(EPIC.ef_epic_date_to_date(sc.next_review_date)), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_booking_holds hld,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(hld.hold_removed_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_incident inc,
		EPIC.eh_incident_offender inco,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(inc.incident_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_incident inc,
		EPIC.eh_incident_offender inco,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   EPIC.ef_epic_date_to_date(inc.incident_date) > EPIC.ef_epic_date_to_date(sc.review_date)
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
	  order by 1, 19, 12;


exception
	when others THEN
		EPIC.ep_log_info(Report_Title, 'E', -1,
			sqlerrm || ' - ' || Report_Title || ' (' || Form_usage || ')');
		RETURN;
end ;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_NoJudgeEntered
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY76, CRSTL.YY77
	Crystal: 		NoJudgeEnteredBk.rpt, NoJudgeEnteredAdm.rpt
	Purpose:		Used by the Jail Office to determine ALL inmates where no Judge Name has been entered and ZZZ for Unknown Judge Name
 					to assist with key missing information. Booking report does not list staff name; Admin report does list staff name

	Author:			D. Kuykendall 
					
	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/28/05        Modified Procedure Header names created Crystal report
					DLK             03/22/06        ADDED MACOMB AND EPIC NOTATION
					R. Stuve		4/6/06			Modified Staff field (combined to one field), inserted Charge function to 
													eliminate connection to epic_statutes table
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				'' as InmateNum,
				'' as IName,
				'' as CaseNo,
				'' as Charge,
				'' as Judge,
				'' as DateModified,
				'' as Staff
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		      	EPIC.ef_get_personororgname(ab.entity_id) as IName,
		     	MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNo,
		      	MACOMB.mcmb_fnt_statutetext(c.charge_id) as Charge,
		       	MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) as Judge,
		      	substr(EPIC.ef_epic_date_to_date(c.action_time),1,10) as DateModified,
		      	EPIC.ef_get_username1stlast(c.action_by) as Staff

		FROM 	EPIC.eh_active_booking ab,
				EPIC.eh_charge c

		WHERE 	ab.booking_id = c.booking_id
				and c.charge_state <> 6
				and (MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) is null 
					or MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) = 'ZZZ')

ORDER BY Judge;
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_NoJudgeEntered_backup
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY76
	Crystal: 		nojudgeentered.rpt 
	Purpose:		Used by the Jail Office to determine ALL inmates where no Judge Name has been entered and ZZZ for Unknown Judge Name
 					to assist with key missing information. It appears that the Judge criteria comes from the Case tab rather than the Court Tab.

	Author:			Original Query recieved from Glenn Sophe (via MAZ 12/28/05)
					D. Kuykendall 
	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/28/05        Modified Procedure Header names created Crystal report
					DLK             03/22/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				'' as InmateNum,
				'' as IName,
				'' as CaseNo,
				'' as Charge,
				'' as Judge,
				'' as DateModified,
				'' as OffLstNm,
				'' as OffFstNm
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 2 as Flag,
		'Exception: No Judge Entered' as RptTitle, 
		EPIC.ef_offender_id(ab.entity_id) as INMATENUM,
      	EPIC.ef_get_personororgname(ab.entity_id) as INAME,
     	MACOMB.mcmb_fnt_CaseNumber (C.charge_id) as CASENO,
      	es.statute_description as CHARGE,
       	MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) as JUDGE,
       	substr(EPIC.ef_epic_date_to_date(C.action_time),1,10) as DATEMODIFIED, --011306 dlk added max function 
      	--MAX(C.action_time) as datemodified,
      	un.user_name_last as OFFLSTNM,
      	Un.user_NAME_FIRST as OFFLSTNM

from 	EPIC.eh_active_booking ab,
		EPIC.eh_charge c,
		EPIC.epic_statutes es,
		EPIC.epic_user_names un

where 	c.booking_id = ab.booking_id
		and c.statute_id = es.statute_id
		and c.action_by = un.user_int_id
		and c.charge_state <> 6
		and (MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) is null or MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) ='ZZZ' )
        --and c.action_by = 19
        
order by Judge;
end;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_NoStatus
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ52
	Crystal: 		nostatus.rpt 
	Purpose:		Used by the Jail Office to determine which inmate files need to be
					updated/processed

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/23/04		Created
					dlk			01/10/05		Added to the tree for test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/14/05		Changed mcmb_fnt_inmatestatusb to 
												mcmb_fnt_inmatestatus(charge_id) and changed
												to SELECT DISTINCT to limit one record/inmate
					R. Stuve	05/05/05		Changed logic to include incomplete bookings and bookings
												with no associated charges; included GroupOrder field to
												assist in proper display on Crystal report    
					R. Stuve	05/24/05		Compiled on OTMAIN  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Case Status (No Status)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as DOB,
				'' as Gender,
				'' as GroupOrder
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT  DISTINCT
			2 as Flag,
			'Case Status (No Status)' as RptTitle, 
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_cell(b.entity_id) as Cell,
			EPIC.ef_offender_DOB(b.entity_id)as DOB,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			'No Status' as GroupOrder
	
	FROM 	EPIC.eh_charge c,
			EPIC.eh_active_booking  b
	
	WHERE 	b.booking_id = c.booking_id (+)
			and c.charge_state != '6'
			and (
				MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'NO STATUS'
				or
				MACOMB.mcmb_fnt_EntityStatus(b.entity_id) = 'NO STATUS'
				)
-----------
UNION ALL
-----------

SELECT	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b1.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b1.entity_id) as InmateName,
		EPIC.ef_offender_cell(b1.entity_id) as Cell,
		EPIC.ef_offender_DOB(b1.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b1.entity_id) as Gender,
		'Unaccepted Booking' as GroupOrder

FROM	EPIC.eh_active_booking b1,
		EPIC.eh_booking bkg

WHERE	bkg.booking_id = b1.booking_id
		and EPIC.ef_epic_date_to_date(bkg.accept_date) is null

-----------
UNION ALL
-----------
(
--select all inmates with any booking
SELECT	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b2.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b2.entity_id) as InmateName,
		EPIC.ef_offender_cell(b2.entity_id) as Cell,
		EPIC.ef_offender_DOB(b2.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b2.entity_id) as Gender,
		'No Charges' as GroupOrder

FROM	EPIC.eh_active_booking b2

minus
--subtract inmates with bookings that have associated charges
SELECT 	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b3.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b3.entity_id) as InmateName,
		EPIC.ef_offender_cell(b3.entity_id) as Cell,
		EPIC.ef_offender_DOB(b3.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b3.entity_id) as Gender,
		'No Charges' as GroupOrder

FROM 	EPIC.eh_active_booking b3,
		EPIC.eh_charge c

WHERE	b3.booking_id = c.booking_id
)

ORDER BY Flag, GroupOrder, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_OnDeck
	 (	vCur 			out      	EPIC.epp_generic_ref_cursor.ref_cursor)
		
IS

 /*	Form Usage: 	CRSTL.XX01 (Female); CRSTL.XX02 (Male)
	Crystal: 		OnDeckFemale.rpt (Female): OnDeckMale.rpt (Male)
	Purpose:		Used by Classification to indicate which classified inmates (by classification
					type and booking date) are next to be moved.  Two reports by gender: Female cells
					begin with 6B/7B--18 cells alltogether (6B01, 6B02, 6B03, 6B04, 6B05, 6B06, 6B07,
					6B08, 6B09, 7B01, 7B02, 7B03, 7B04 7B05, 7B06, 7B07, 7B08, 7B09); Male cells begin 
					with D (but not 12 or 7 or DC01 or DC02)--10 cells alltogether (D1PC, D2PC, D3PC, 
					D4PC, D5PC, D6PC, D08, D09, D10, D11)


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/03/05		Created    
					DLK			03/28/05		Begin development Crystal - Added to the Report Tree
					R.Stuve		05/28/05		Compiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
						
*/
 
v_date_null	date;   
 
BEGIN
        
v_date_null := null;     
        
	OPEN vCur FOR
          --the below query pulls back the header information	
		SELECT 	1 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				v_date_null as BookingDate,
				'' as SecurityClass,
				'' as ActiveAlerts,
				'' as SortOrder,
				'' as KeepSep
			
		FROM 	dual

UNION ALL

		SELECT	2 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) AS InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) AS InmateName,
				EPIC.ef_offender_cell(ab.entity_id) AS Cell,
				EPIC.ef_epic_date_to_date(b.start_date) AS BookingDate,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') AS SecurityClass,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) AS ActiveAlerts,
				decode (sc.classification, 	'01', '1',
									'02', '1',
									'03', '1',
									'04', '2',
									'05', '2',
									'06', '3',
									'07', '4',
									'08', '5') as SortOrder,
				MACOMB.mcmb_fnt_KeepSep(ab.entity_id) as KeepSep

		FROM 	EPIC.eh_active_booking ab,
				EPIC.eh_booking b,
				EPIC.eh_security_classification sc,
				EPIC.eh_generic_attribute g
		
		WHERE 	b.booking_id = ab.booking_id
				AND ab.booking_id = sc.booking_id
				AND sc.classification <> '00'
				AND ab.booking_id = g.item_id
				AND g.attribute_name = 'NEEDS CLASSIFICATION INTERVIEW'
				AND g.attribute_value = 'N'
				AND NOT EXISTS (SELECT classification_id
						FROM EPIC.eh_security_classification sc2
						WHERE sc.booking_id = sc2.booking_id
						AND EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))

ORDER BY Flag, SortOrder, BookingDate, InmateNum;      

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_OnDeck_backup
	  (	vCur 			out      	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Cell			in			EPIC.eh_person_identity.other_identity_number%type)
		
IS

 /*	Form Usage: 	CRSTL.XX01 (Female); CRSTL.XX02 (Male)
	Crystal: 		***.rpt (Female): ***.rpt (Male)
	Purpose:		Used by Classification to indicate which classified inmates (by classification
					type and booking date) are next to be moved.  Two reports by gender:Female
					(6B01, 6B02, 6B03, 6B04, 6B05, 6B06, 6B07, 6B08, 6B09, 7B01, 7B02, 7B03, 7B04
					7B05, 7B06, 7B07, 7B08, 7B09); Male (D1PC, D2PC, D3PC, D4PC, D5PC, D6PC, D08, 
					D09, D10, D11)


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/14/04		Added header information via union query 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/28/05		Added KeepSep for Keep Separate information 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
						
*/
 
p_cellt varchar2(255) := concat(concat(chr(39),replace(p_cell,',' , concat( concat(chr(39),',') ,chr(39) ))),chr(39));
v_date_null date;

queryin  varchar2(2000) := 'SELECT 1 as Flag,''Inmates on Deck for Moves'' as RptTitle,''' || p_Cell || ''' as CellRange,'''' as Inmate#,'''' as InmateName,'''' as Cell,''v_date_null'' as BookingDate,'''' as SecurityClass,'''' as ActiveAlerts,'''' as SortOrder, '''' as KeepSep FROM dual UNION ALL SELECT 2 as Flag,''Inmates on Deck for Moves'' as RptTitle,'''' as CellRange,EPIC.ef_offender_id(ab.entity_id) AS Inmate#,EPIC.ef_get_personororgname(ab.entity_id) AS InmateName,EPIC.ef_offender_cell(ab.entity_id) AS Cell,EPIC.ef_epic_date_to_date(b.start_date) AS BookingDate,EPIC.ef_lookup_text (''SECURITY CLASSIFICATION'', EPIC.ef_get_Security_Class(ab.entity_id), ''UC'') AS SecurityClass,MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) AS ActiveAlerts,decode(sc.classification,''01'',''1'',''02'',''1'',''03'',''1'',''04'',''2'',''05'',''2'',''06'',''3'',''07'',''4'',''08'',''5'') as SortOrder, MACOMB.mcmb_fnt_KeepSep(ab.entity_id) as KeepSep FROM EPIC.eh_housing_assignments ha, EPIC.eh_active_booking ab,EPIC.eh_booking b,EPIC.eh_security_classification sc,EPIC.eh_generic_attribute g WHERE b.booking_id = ab.booking_id AND ab.booking_id = sc.booking_id AND sc.classification <> ''00''AND ab.booking_id = g.item_id AND g.attribute_name = ''NEEDS CLASSIFICATION INTERVIEW'' AND g.attribute_value = ''N'' AND NOT EXISTS (SELECT classification_id FROM EPIC.eh_security_classification sc2 WHERE sc.booking_id = sc2.booking_id AND EPIC.ef_epic_date_todate(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date)) AND EPIC.ef_location_name(ha.location_id,''UC'') IN (';

queryout   varchar2(2000) := concat(concat(queryin, p_cellt), ') ORDER BY Flag,SortOrder, BookingDate, Inmate#');

BEGIN           
	v_date_null := null;    
	OPEN vCur FOR	queryout;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_OutstandBndChk
	(	vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY51
	Crystal: 		****.rpt
	Purpose:		Used by the Finance department for auditing puroses: Lists all outstanding checks 
					written from the MCJ facility account

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	5/02/05			Created  
					R. Stuve	5/03/05			Changed CheckNumber to number format  
					DLK			05/03/05		Begin devl. for test   
					R. Stuve	05/28/05		Compiled on OTMAIN  
					dlk         03/23/06        added macomb and epic notation
	
*/

v_date_null	date;
	
BEGIN

v_date_null := null;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Outstanding Bond Checks' as RptTitle,
				0 as CheckNum,
				0 as Amount,
				v_date_null as TransDate,
				'' as Court
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT	2 as Flag,
        	'Outstanding Bond Checks' as RptTitle,
        	to_number(tat.check_number) as CheckNum,
			tat.amount as Amount,
			EPIC.ef_epic_date_to_date(tat.trans_date) as TransDate,
			tat.payee_or as Court

	FROM	EPIC.eh_trust_account_trans tat,
			EPIC.eh_check_register cr

	WHERE	cr.trust_account_trans_id = tat.trust_account_trans_id
			and tat.trust_account_id = '0I8RANB000USJ0BR'
				--facility account
			and not exists
				(select 1 from EPIC.eh_trust_trans_cleared ttc
				where ttc.trust_account_trans_id = tat.trust_account_trans_id)
				--makes sure check is not cleared
			and cr.void_flag is null
				--makes sure check is not void
	
	ORDER BY Flag, TransDate, CheckNum;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_PaidBookFees
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.trans_date%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.trans_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY56  
	Crystal: 		paidbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were paid during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					DLK			01/28/05		begin devl 
					DLK			02/08/05		add to tree test 
					R. Stuve	02/28/05		Added Reversal field to indicate transaction reversals
					DLK			03/01/05		Added reversal to he Crystal Report
					R. Stuve	05/28/05		Compiled on OTMAIN   
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
	
*/
        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_max_date		EPIC.eh_trans_distribution.trans_date%type;  
     	v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		v_date_to		EPIC.eh_trans_distribution.trans_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency,
				'' as Reversal
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(d.trans_date) as TDate,
				d.amount as Amount,
				MACOMB.mcmb_fnt_FeePmtType(d.trust_account_trans_id) as Agency,
				MACOMB.mcmb_fnt_Reversal(t.trust_account_id) as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trans_distribution d

		WHERE	t.trust_account_id = d.trust_account_id
				and d.gl_account_number = '110'
				and d.trust_account_trans_id in
							(select trust_account_trans_id
							from EPIC.eh_trans_distribution
							where gl_account_number in ('502','503'))
				and EPIC.ef_epic_date_to_date(d.trans_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(d.trans_date) < v_max_date

ORDER BY Flag, Agency, InmateNum, TDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ParoleViolator
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ54
	Crystal: 		paroleviolator.rpt
	Purpose:		Sent by the Jail Office to the Parole office daily for their use
					to track inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created
					dlk			01/06/05		created for test added to the tree
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'  
					R. Stuve	05/30/05		Compiled in OTMAIN 
					M.Zak       03-06-06        Removed Booking Date and Time per Sgt Roberts
												Removed eh_Booking table 
												Use offense date = Charge Booked date on Charge Tab  
					dlk         03/23/06        added macomb and epic notation
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Parole Violators)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as MDOC,
				--v_date_null as BookingDate,
				--'' as BookingTime,
				'' as Cell,
				'' as Bin,
				 v_date_null as OffDate  -- offense date
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Parole Violators)' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		 		MACOMB.mcmb_fnt_mdoc(ab.entity_id) as MDOC,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(c.offense_date) as offdate  --offense date  -- used instead of booking per Sgt Roberts 3-6-06
			
		FROM	EPIC.eh_active_booking ab,
	 			EPIC.eh_charge c
		  	

		WHERE	ab.booking_id = c.booking_id
				and c.charge_state != 6
         		and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'PAROLE VIOLATOR'

		ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ParoleViolators_Fin
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY70
	Crystal: 		ParoleViolators_Fin.rpt
	Purpose:		Used by Finance to list Parole Violators total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-24-05		Created   (orig use custody status (Glen Sopfe)
					M.Zak		08-30-05        Modified   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay)   
					DLK         03/23/06                   ADDED MACOMB AND EPIC NOTATION                                       
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate)); --p_EndDate; use < and > when comparing in where clause
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - Parole Violators' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
			  	v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

--Parole Violators with in selected date range 
SELECT	2 as Flag,
			'Finance - Parole Violators' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

       		                                                                   		
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'PAROLE VIOLATOR'  
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            


 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_PostArraignDist
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ53
	Crystal: 		postarraigndist.rpt
	Purpose:		Used by the Jail Office to track the length between court dates for
					inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created    
					dlk			12/28/04		Created Crystal rpt
					dlk			12/29/04		added to tree test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Post-Arraignment District Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Charge
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Post-Arraignment District Court)' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				cs.case_number as DocketNum,
				ca.judge_name as Judge,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c,
				EPIC.eh_case_charge a,
				EPIC.eh_court_appearance ca,
				EPIC.eh_case cs

		WHERE	ab.booking_id = c.booking_id
				and c.charge_id = a.charge_id
				and a.case_id = ca.owner_id (+)
				and cs.case_id (+) = a.case_id
				and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'POST-ARRAIGNMENT DISTRICT'
				and c.charge_state != 6

		ORDER BY Flag, InmateName, Judge;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_PreArraignCirc
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ50
	Crystal: 		prearraigncirc.rpt
	Purpose:		Used by the Jail Office: sent to all Circuit Courts and Probation Dept
					to be used to call for inmates due for court on the specified date

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created  
					dlk			12/29/04		added to the tree test 
					R. Stuve	01/25/05		Added Charge
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN     
					M.Zak       03/03/06        Added 'POST-ARRAIGNMENT DISTRICT' for indicator "D" = also in District(Crystal Report)
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Pre Arraignment Circuit Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				'' as DistFlag
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Pre Arraignment Circuit Court)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmchrgstat(ab.entity_id,'PRE-ARRAIGNMENT DISTRICT' ) as DistFlag

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id 
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) ='PRE-ARRAIGNMENT CIRCUIT COURT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_PreArraignDist
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ51
	Crystal: 		prearraigndist.rpt
	Purpose:		Used by the Jail Office: sent to all District Courts to be used to 
					call for inmates due for court on the specified date

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/23/04		Created 
					dlk			12/29/04		added to the tree test 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/16/05		Added Warrant# and Arrest Reason   
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Pre Arraignment District Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				0 as Funds,
				'' as ControlAgy,
				0 as Bond,
				'' as Holds,
				'' as Charge,
				'' as WarrantNum,
				'' as ArrestReason
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Pre Arraignment District Court)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,
			to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bond,
			MACOMB.mcmb_fnt_Holds(ab.entity_id) as Holds,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			c.arrest_number as WarrantNum,
			MACOMB.mcmb_fnt_arresttype(c.charge_id) as ArrestReason
	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs
	
	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'PRE-ARRAIGNMENT DISTRICT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ProbViol_CC
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY36
	Crystal: 		probviolcc.rpt
	Purpose:		Used by Community Corrections to determine which inmates have been
					incarcerated for Probation Violation

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/05/05		Created 
					R. Stuve	04/22/05		Linked to Report Tree 
					R. Stuve	05/28/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION 
					R. Stuve	04/10/06		Changed address function to address_city function
*/
	v_date_null date;
			
BEGIN 

	v_date_null := null; 
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Incarcerated for Probation Violation' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Race,
				'' as Gender,
				'' as ChargeNum,
				'' as ChargeName,
				'' as CourtDate,
				'' as ChargeState,
				0 as Bond,
				v_date_null as ChargeDisp,
				0 as SentencedMonths,
				0 as SentencedDays,
				'' as City,
				'' as Judge
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 	2 as Flag,
			'Incarcerated for Probation Violation' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
	        MACOMB.mcmb_fnt_race(ab.entity_id) as Race,
	        MACOMB.mcmb_fnt_gendershort(ab.entity_id) as Gender,
	        MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
	        MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeName,
	  		decode(MACOMB.mcmb_fnt_CourtDate(c.charge_id),null,'TBA',to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as CourtDate,
	        	--above line inserts 'TBA' when no court date is scheduled
	        	--due to the mix of dates and strings per above, dates in this field are formatted as a string
	        MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as ChargeState,
	        	--above line returns charge state (Sentenced, Pre-Arraignment, etc)
	        to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bond, 
	        	--above line returns bond amount (if entered).  If not entered, returns '0'
	       	EPIC.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
				--date the single charge can be disposed (expected end-date on Sentences tab)
	        sd.months as SentencedMonths,
	        	--number of sentenced months
	        sd.days as SentencedDays,
	        	--number of sentenced days
	  		MACOMB.mcmb_fnt_address_city(ab.entity_id) as City, 
	  			--inmate's resident city
	       	MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) as Judge
	        	--judge's initials: for grouping--doesn't need to be displayed on report in column
	
	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd
	
	WHERE 	ab.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
		   	and c.arrest_reason = 'PV'
		   	and c.charge_state != '6'

ORDER BY Flag, Judge, InmateName;
     	
END;
/

CREATE OR REPLACE
procedure Mcmb_Rpt_PropBins(
          vCur 	OUT           EPIC.epp_generic_ref_cursor.ref_cursor

)
is
-- Report Name: Property Bins - Filled (JAIL/314) 
-- Create Date: 07/2004
-- Created by : JGORSKI	      
--ADDED MACOMB AND EPIC NOTATION DLK 03/23/06

begin

	      open vCur for
	     
select  EPIC.ef_offender_id(ep.entity_id) as "Inmate #",
		EPIC.EF_GET_PERSONORORGNAME(ep.entity_id) as "Name",
		EPIC.ef_location_name(ha.location_id,'uc') as "Cell",
		MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as "Bin"

from    EPIC.eh_housing_assignments ha,
		EPIC.eh_entity_person ep

where   ha.entity_id (+) = ep.entity_id
and 	MACOMB.mcmb_fnt_alphabin(ep.entity_id) is not Null

order by 4;

end;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Psych
		(curPsych		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
   
 /*	Form Usage: 	CRSTL.XX52
	Crystal: 		pysch.rpt
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	11/16/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			12/15/04		Added to the tree - test 
					R. Stuve	12/28/04		Converted dates from string type to date type
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	05/28/05		Compiled on OTMAIN	
					R. Stuve	06/12/05		Changed WHERE clause to like 'PSYCH%' from = 'PSYCH RX' to 
												encompass different transaction for trustees 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
	
*/
   
 v_date_null date;
 
 BEGIN
    
 v_date_null := null;
 
	OPEN curPsych FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Charge,
				v_date_null as BookingDate,
				v_date_null as LatestOutDate,
				'' as Holds,
				'' as MultiChrgs
		
		FROM	dual
		
	UNION ALL			    
		--the below query pulls back the actual report data
		SELECT	DISTINCT 2 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,		
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_housing(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphacharge (ab.booking_id) as Charge,
				EPIC.ef_epic_date_to_date(ab.action_time) as BookingDate,
  				EPIC.ef_epic_date_to_date(EPIC.ef_earliest_release_date(ab.booking_id)) as LatestOutDate,
    			MACOMB.mcmb_fnt_holds (ab.entity_id) as Holds,
    			MACOMB.mcmb_fnt_MultipleCharges(ab.entity_id) as MultiChrgs

		FROM	EPIC.eh_active_booking ab,
	  			EPIC.eh_trust_account t,
	  			EPIC.eh_trust_account_trans ta

		WHERE	ab.entity_id = t.entity_id
	  			and t.trust_account_id = ta.trust_account_id
	  			and ta.description like 'PSYCH%'
	  			and EPIC.ef_epic_date_to_date(ta.action_time) >= EPIC.ef_epic_date_to_date(ab.action_time)

		ORDER BY Flag, Cell, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Psych_wHolds
		(curPsych		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
   
 /*	Form Usage: 	CRSTL.XX55
	Crystal: 		PyschWHolds_Main.rpt   (part 1 of 2) 
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs with Hold Data. Sorted by Flag(N, Y), Cell #, and then InamteName.

	Author:			Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/05/05		Created
					D. Kuykendall	12/07/05		loaded for testing
									12/09/05		determined that Latest Outdate was not correct. Function  (ef_earleist_release_
									12/09/05        date) replaced with mcmb_fnt_rel_date.  
					DLK             03/23/06        ADDED MACOMB AND EPIC NOTATION	
					R. Stuve		04/10/06		BookingDate incorrect: replaced with bk.start_date; returned final_release_date
													directly rather than use function (which returned same date)			
									                					
*/
   
 v_date_null date;
 
 BEGIN
    
 v_date_null := null;
 
	OPEN curPsych FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Charge,
				v_date_null as BookingDate,
				--'' as LatestOutDate,
				v_date_null as LatestOutDate,
				'' as Holds,
				'' as MultiChrgs,
				'' as EntityID
		
		FROM	dual
		
	UNION ALL			    
		--the below query pulls back the actual report data
		SELECT	DISTINCT 2 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,		
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_housing(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphacharge(bk.booking_id) as Charge,
				EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
  				--ef_epic_date_to_date(ef_earliest_release_date(ab.booking_id)) as LatestOutDate,  --Returns incorrect date
  				EPIC.ef_epic_date_to_date(bk.final_release_date) as LatestOutDate, --dlk   
    			MACOMB.mcmb_fnt_holds (ab.entity_id) as Holds,
    			MACOMB.mcmb_fnt_MultipleCharges(ab.entity_id) as MultiChrgs,
    			ab.entity_id as EntityId

		FROM	EPIC.eh_active_booking ab,
	  			EPIC.eh_trust_account t,
	  			EPIC.eh_trust_account_trans ta,
	  			EPIC.eh_charge ch,     --dlk   to allow new function to process
	  			EPIC.eh_booking bk     --dlk   to allow new function to process

		WHERE	ab.entity_id = t.entity_id
	  			and t.trust_account_id = ta.trust_account_id
	  			and ta.description like 'PSYCH%'
	  			and EPIC.ef_epic_date_to_date(ta.action_time) >= EPIC.ef_epic_date_to_date(ab.action_time) 
	  			and ab.entity_id = bk.entity_id
	  			and bk.booking_id = ch.booking_id

		ORDER BY Flag, Cell, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_PyschHolds_sub
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.XX56
	Crystal: 		PyschHolds_sub.rpt (Sub Report: of PsychWHolds) PART 2 OF 2
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs with Hold Data
						
	Author:			Diana Kuykendall

	Change Log:		Changed By	    Date Modified	Change Made
					----------	    -------------	------------------------------------------
					D. Kuykendall	12/02/05		Created  
					DLK             03/23/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
procedure mcmb_rpt_reimburse_booking
 	(p_cursor		in out		EPIC.epp_generic_ref_cursor.ref_cursor)
is


--	This report is custom to Macomb County.  It is to be run hoursly (URP)
--  and will show any inmates who have been booked over the past x hours
--  who show an outstanding balance in the reimbursement attribute fields.

--DLK      03/23/06         ADDED MACOMB AND EPIC NOTATION               


	v_result		number(9,0);
	v_result_msg	varchar2(255);       
	v_hours			number(9,0);
	v_start_date	varchar2(20);


begin                                   

	-- get the configurable period.  This indicates how far back the
	-- report should look for new bookings.
	EPIC.ep_get_configuration_value('REIMBURSEMENT', 'REPORT PERIOD HOURS', v_hours, '6', v_result, v_result_msg);
	
	-- calculate the start date
	v_start_date := EPIC.ef_epic_add_hours(EPIC.epicdatenow(), - v_hours);
	
	-- execute the query.  Since this is a custom report, assume that the title, etc. are
	-- hardcoded in the Crystal report file.	


	Open p_cursor for
		select 	EPIC.ef_epic_date_to_date(bk.start_date) as start_date,
				substr(EPIC.ef_get_personororgname(bk.entity_id),1,255) as name,
				substr(EPIC.ef_offender_id(bk.entity_id),1,255) as inmate_id,
				ga.attribute_name as attr_name,
				ga.attribute_value as attr_value
		from
			EPIC.eh_booking bk,
			EPIC.eh_generic_attribute ga,
			EPIC.eh_trust_account ta
		where 
			EPIC.ef_epic_date_to_date(bk.start_date) > EPIC.ef_epic_date_to_date(v_start_date)
			and bk.entity_id = ta.entity_id
			and ta.trust_account_id = ga.item_id
			and ga.attribute_name like '%REIMBURSEMENT%'
			and ga.attribute_value is not null
			and ga.attribute_value > '0'
			and not exists
			(select 1 from EPIC.eh_trust_account ta2
			where ta.entity_id = ta2.entity_id
			and EPIC.ef_epic_date_to_date(ta2.date_created) > EPIC.ef_epic_date_to_date(ta.date_created))	
		order by 1;
		
	return;
	
end;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ReimRel
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,
		p_EndDate		in			EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX40
	Crystal: 		ReimbAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/15/05		Created 
	                M.Zak       07/18/05        Linked to otmain 
	                dlk         03/23/06        added macomb and epic notations
*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| MACOMB.mcmb_fnt_address_city(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_state(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays

		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s
		
		WHERE	b.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date
		
		ORDER BY Flag, InmateName, SentenceEnd;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_RelTrustees
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX43
	Crystal: 		RelTrustees.rpt
	Purpose:		Used by the Reimbursement billings to lists inmates who have already been
					physically released during the selected dates and have had a custody status (trustees)
					of Kitchen Trustee (white)(code=6), , or Trustee (Orange)(code= 9)

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-13-05        Created procedure and report
         			M.Zak       10-19-05        Special Trustee (green)(code= 10) removed per Sgt Roberts
                                                Added pre-Kitchen Trustee (code = 65) 
                    dlk         03/23/06        added macomb and epic notation                            
*/				
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Released Trustees - Historical' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				v_date_null as ReleaseDate,
				'' as Custody_Status,
				v_date_null as CS_start_date,
				v_date_null as CS_end_date				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
	         	'Released Trustees - Historical' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
                EPIC.ef_offender_id(b.entity_id) as InmateID,
                EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
			 	MACOMB.mcmb_fnt_custody_status_desc(bcs.code_custody_status) as Custody_Status,
			 	EPIC.ef_epic_date_to_date(bcs.date_start) as CS_start_date,
			 	EPIC.ef_epic_date_to_date(bcs.date_end) as CS_end_date
            			
			FROM  	EPIC.eh_booking  b,
		  			EPIC.eh_release r,
		  			EPIC.eh_booking_custody_status bcs

			WHERE  	b.booking_id = r.booking_id
			        and b.booking_id = bcs.booking_id
			        and bcs.code_custody_status in ('6','65','9')  -- replaced 10 with 65 10-19-05
			        and EPIC.ef_epic_date_to_date(r.actual_release) >= v_min_date 
			        and EPIC.ef_epic_date_to_date(r.actual_release) <= v_max_date
			        
			ORDER BY Flag, ReleaseDate, InmateID; 
			
END;			
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_residentfunds   (
         vCur OUT         EPIC.epp_generic_ref_cursor.ref_cursor
)
is

/*	Form Usage: 	CRSTL.YY17
	Crystal: 		0DCCRYY170EPI001.rpt
	Purpose:		Used by the Reimbursement Office to list new inmates with previous reimbursement debt

	Author:			Motorola

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/23/05		Compiled on OTMAIN   
					dlk         03/23/06        added macomb and epic notation
	
*/	

BEGIN

OPEN vCur FOR
   SELECT
		' '	as	Offender_Ident,
		' '	as	Offender_Name,    
		' ' as Cell_Location,
		0   as 	current_balance,
		' '  as Last_Trans_Date,
		' ' as Last_Trans_Time,
		' ' as Last_Trans_Type,
		0   as Last_Trans_Amt
   FROM	DUAL
   UNION
        SELECT  Distinct
		EPIC.ef_offender_ident(book.Entity_ID)
				as 	Offender_Ident,   
		EPIC.ef_get_personororgname(book.Entity_ID)
			  	as 	Offender_Name,
		EPIC.ef_location_name (ua.location_id, 'UC') as Cell_Location, 
		nvl(ca.total_debits - ca.total_credits, 0) as current_balance,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(tat.action_time),1,10)) as Last_Trans_Date,
		substr (EPIC.ef_epic_date_to_date(tat.action_time),9,5) as Last_Trans_Time,  
		tat.description as Last_Trans_Type,
		tat.amount as Last_Trans_Amt
		
		
	from
		   	EPIC.eh_active_booking book,
			EPIC.eh_chart_of_accounts ca,
			EPIC.eh_trust_account ta,
			EPIC.eh_Housing_assignments ua,
			EPIC.eh_trust_account_trans tat  
	where	book.entity_id = ta.entity_id
	  and	ca.trust_account_id = ta.trust_account_id
	  and   tat.trust_account_id = ca.trust_account_id  
      and	ca.gl_account_number = '110'
      and	book.Entity_ID = ua.Entity_ID
	  and   tat.transaction_number = (select max(transaction_number)
                 from EPIC.eh_trust_account_trans where
                 trust_account_id = ta.trust_account_id)
      order by cell_location
	;   


END mcmb_rpt_residentfunds;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Restitution
	(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	
	Crystal: 		
	Purpose:		 List current inmates that owe money for Restitution Judgements.
	Author:			Kelly Heinz

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					K. Heinz		08/07/06		Created  
                    
*/                 

v_sent_date		date;
v_sent_end		date;
			
BEGIN  

v_sent_date := null; 
v_sent_end := null;
		
	OPEN vCur FOR 
	    --the following select statement pulls back the header information
	   SELECT	1 as Flag,
				'Restitution Judgements' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as RestitutionAmt,
				0 as CurBal,
				v_sent_date as SentStartDate,
				v_sent_end as SentEndDate
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Restitution Judgements' as RptTitle,
				epic.ef_offender_id(ab.entity_id) as InmateNum,
				epic.ef_get_personororgname(ab.entity_id) as InmateName,
				macomb.mcmb_fnt_Sent_Restitution(ab.entity_id) as RestitutionAmt,
				macomb.mcmb_fnt_inmatefunds(ab.entity_id) as CurBal,
				epic.ef_epic_date_to_date(macomb.mcmb_fnt_sent_date(ab.booking_id)) as SentStartDate,
                epic.ef_epic_date_to_date(macomb.mcmb_fnt_sent_enddate(ab.booking_id)) as SentEndDate
                
		FROM   	epic.eh_active_booking ab
				--eh_trust_account t,
				--eh_trust_account_trans tat

		WHERE	macomb.mcmb_fnt_Sent_Restitution(ab.entity_id) > 0
					
ORDER BY InmateNum, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_restriction
	(	curRest				OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ31 (Lockdown), CRSTL.ZZ32 (Commissary), CRSTL.ZZ33 (Visitors)
	Crystal: 		restlock.rpt (Lockdown), restcomm.rpt (Commissary), restvisits.rpt (Visitors)
	Purpose:		Lists name, number, and cell of inmates under the specified restriction

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/22/04		Added to the tree test  
					DLK			12/27/04		ADDED CHANGES TO FORMAT DATE FIELD
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	02/17/05		Added ef_min_date to sysdate in where clause 
					R. Stuve	04/23/05		Compiled on OTMAIN
	
*/   

v_date_null date;
 
 BEGIN
	
v_date_null := null;   
	
	OPEN curRest FOR 
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Restriction Report' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Floor,
				v_date_null as EndDate,
				'' as RestrictionCode			
		
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Restriction Report' as RptTitle,
				EPIC.ef_offender_id (r.entity_id) as InmateNum,
				EPIC.ef_get_personororgname (r.entity_id) as InmateName,
				EPIC.ef_location_name (h.location_id, 'UC') as Cell,
				substr(EPIC.ef_location_path_name(h.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(h.location_id,'US',5),',',1)-1) as Floor,
				EPIC.ef_epic_date_to_date(end_date) as EndDate,
                r.code_restriction_type as RestrictionCode

		FROM 	EPIC.eh_entity_restriction r,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m

		WHERE	h.entity_id (+) = r.entity_id
		AND		r.entity_id = m.entity_id
		AND		EPIC.ef_epic_date_to_date(r.end_date) >= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate)))
		AND		m.in_muster_flag = 'Y'

		ORDER BY Flag, EndDate, Cell;
	
END;   
--RAS
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_restrictiontest
	(	curRest				OUT		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	--p_rest_type	in		eh_entity_restriction.code_restriction_type%type)

IS
 
 /*	Form Usage: 	CRSTL.ZZ20 (Lockdown), CRSTL.ZZ21 (Commissary), CRSTL.ZZ22 (Visitors)
	Crystal: 		****.rpt (Lockdown), ***.rpt (Commissary), ***.rpt (Visitors)
	Purpose:		Lists name, number, and cell of inmates under the specified restriction

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/21/04		Added to the tree  test    
					dlk         03/23/06        added macomb and epic notation
	
*/   

v_date_null date;
 
 BEGIN
	
v_date_null := null;   
	
	OPEN curRest FOR 
			--the below query pulls back the header information
/*	   SELECT	1 as Flag,
				'Restriction Report' as RptTitle,
				--p_rest_type as RestType,
				' ' as Inmate#,
				' ' as InmateName,
				' ' as Cell,
				v_date_null as EndDate			
		
		FROM	dual
		
	UNION			
*/
		--the below query pulls back the actual report data	
		SELECT 	--2 as Flag,
				--' ' as RptTitle,
				--' ' as RestType,
				EPIC.ef_offender_id (r.entity_id) as Inmate#,
				EPIC.ef_get_personororgname (r.entity_id) as InmateName,
				EPIC.ef_location_name (h.location_id, 'UC') as Cell,
				EPIC.ef_epic_date_to_date(end_date) as EndDate,
                r.code_restriction_type as RestrictionCode
                
		FROM 	EPIC.eh_entity_restriction r,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m

		WHERE	h.entity_id (+) = r.entity_id
		AND		r.entity_id = m.entity_id
		--AND		r.code_restriction_type = p_rest_type
		AND		EPIC.ef_epic_date_to_date(end_date) >= sysdate
		AND		m.in_muster_flag = 'Y'

		ORDER BY EndDate, Cell;
	
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ReviewDate
	( 	vCur 			out     EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_security_classification.next_review_date%type)
IS
   
 /*	Form Usage: 	CRSTL.XX04
	Crystal: 		***.rpt
	Purpose:		Used by Classification to list the inmates due for a review on/before 
					the selected date

	Author:			John Gorski

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					J.Gorski	07/27/04		Created 
					R. Stuve	12/14/04		Added header information via union query,
												inmate type, DOB, NextReviewDate
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'	 
					dlk         03/23/06        added macomb and epic notations
*/

	v_date_from		EPIC.eh_security_classification.next_review_date%type;
	v_null_date		date; 

BEGIN
         
	v_date_from	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
	v_null_date := null;

	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Classification Periodic Review' as RptTitle, 
				EPIC.ef_epic_date_to_date(v_date_from) as RptStart,
				'' as InmateNum,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Class,
				v_null_date as DOB,
				v_null_date as NextReviewDate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Classification Periodic Review' as RptTitle,
			EPIC.ef_epic_date_to_date(v_date_from) as RptStart,
     		EPIC.ef_offender_id(ha.entity_id) as InmateNum,
      		EPIC.ef_get_personororgname(mu.entity_id) as InmateName,
      		decode(es.code_custody_status,
      			'1', 'R',
      			'2', 'F',
      			'3', 'P',
      			'4', 'W',
      			'5', 'WR',
      			'6', 'T',
      			'7', 'AW',
      			'9', 'T',
      			'10', 'T',
      			'12', 'WW',
      			'13', 'IT', 'B') as InmateType,
      		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
 			EPIC.ef_offender_SecClass(mu.entity_id) as Class,
      		EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
      		EPIC.ef_epic_date_to_date(sc.next_review_date) as NextReviewDate

	FROM 	EPIC.eh_muster mu,
 			EPIC.eh_housing_assignments ha,
    		EPIC.eh_active_booking bk,
			EPIC.eh_security_classification sc,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep,
			EPIC.eh_entity_status es

	WHERE	 mu.entity_id = ha.entity_id
			AND  ha.entity_id = bk.entity_id
			AND  bk.entity_id = ep.entity_id
			AND  es.entity_id = ep.entity_id
			AND epi.entity_id = ha.entity_id
			AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			AND sc.booking_id = bk.booking_id
			AND EPIC.ef_epic_date_to_date(sc.next_review_date) IS NOT NULL
			AND EPIC.ef_epic_date_to_date(sc.next_review_date) <= v_date_from
			AND NOT EXISTS
				(SELECT 1
				FROM EPIC.eh_security_classification sc2
				WHERE sc.booking_id = sc2.booking_id
				AND EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))

		ORDER BY Flag, NextReviewDate, InmateName;

      	
END;
/

CREATE OR REPLACE
Procedure      mcmb_rpt_ReviewDateBackup
	(RPT_Not_Classified	IN OUT	EPIC.epp_generic_ref_cursor.ref_cursor,
	P_Form_usage		IN		EPIC.epic_form.Form_usage%type,
	P_UserID			In		EPIC.epic_user_names.user_int_id%type,
	p_Location			IN		EPIC.EPIC_LOCATIONS.LOCATION_ID%type,
	p_end_date			in		EPIC.eh_security_classification.next_review_date%type
)

--	12/16/04	Bob Meeks
--	Take the rpt_not_classified_proc and modify it for Macomb County.  Saving it as a new
--  report procedure and will use the same Crystal Report (ICL1_2_3_4.rpt), but will have its own form usage  

--	REPORT CREATED BY MOTOROLA: THIS IS A BACKUP COPY SAVED BY MACOMB
--	02/18/05 RAS

AS
	lookup_code			constant varchar2(10) := 'CRSTL.';
	Form_usage			constant varchar2(10) := P_Form_usage;
	v_security_object	constant EPIC.epic_user_objects.object_code%type := lookup_code || P_Form_usage;

	Report_Title		EPIC.epic_col_types.varchar_255%type;
	Report_Version		EPIC.epic_col_types.varchar_255%type;
	InsititionName		EPIC.epic_col_types.varchar_255%type;
	EnterpriseName		EPIC.epic_col_types.varchar_255%type;
	PageBreak			EPIC.epic_col_types.varchar_255%type;
	f_Enterprise		EPIC.epic_col_types.varchar_255%type;
	f_Location			EPIC.epic_col_types.varchar_255%type;
	f_LocationID		EPIC.epic_col_types.varchar_255%type;
	f_Off_Ident_Col		EPIC.epic_col_types.varchar_255%type;

	p_result			number(9,0);
	p_result_msg		varchar2(255);
	v_review			EPIC.epic_configuration.config_value%type;
	n_review			integer;
--	v_review_date		epic_col_types.varchar_255%type;
	v_next_review_date	EPIC.eh_security_classification.next_review_date%type;
	f_review_date		EPIC.epic_col_types.varchar_255%type;
	f_today_date		EPIC.epic_col_types.varchar_255%type;
	f_location_type		varchar2(255);

	v_modified_charges	EPIC.epic_configuration.config_value%type;
	v_new_charges     	EPIC.epic_configuration.config_value%type;
	v_new_holds			EPIC.epic_configuration.config_value%type;
	v_new_incidents		EPIC.epic_configuration.config_value%type;

BEGIN

	Report_Title	:=	substr(EPIC.ef_lookup_text ('REPORT TREE', lookup_code || Form_usage, 'IC'),1,255);
	Report_Version	:=	substr(EPIC.ef_ReportVersion (Form_usage),1,255);
	InsititionName	:=	substr(EPIC.ef_get_Licensee('ABOUT', 'LICENSEE'),1, 255);
	EnterpriseName	:=	substr(EPIC.ef_get_Enterprise, 1, 255);
	f_Off_Ident_Col	:=	substr(initcap(EPIC.ef_config_offender_id),1,200) || ':';

--	ep_log_info(Report_Title, 'R', -1, Report_Title ||' Report_Version: ' || Report_Version);

	v_next_review_date := p_end_date;
--	f_review_date		:=	substr(to_char(ef_epic_date_to_date(v_review_date), ef_date_format),1,100) ;
--	f_today_date		:=	substr(to_char(ef_epic_date_to_date(epicdatenow), ef_date_format),1,100);
	f_today_date		:=	substr(to_char(EPIC.ef_epic_date_to_date(v_next_review_date), EPIC.ef_date_format),1,100) ;
	f_review_date		:=	substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdatenow), EPIC.ef_date_format),1,100);


	-- determine which conditions should cause someone to appear on the
	-- report.  All of these default to N, which means the base report is the same
	-- as before.
--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE MODIFIED CHARGES', v_modified_charges, 'N', p_result, p_result_msg);
--	if v_modified_charges is null then
		v_modified_charges := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW CHARGES', v_new_charges, 'N', p_result, p_result_msg);
--	if v_new_charges is null then
		v_new_charges := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW HOLDS', v_new_holds, 'N', p_result, p_result_msg);
--	if v_new_holds is null then
		v_new_holds := 'Y';
--	end if;

--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW INCIDENTS', v_new_incidents, 'N', p_result, p_result_msg);
--	if v_new_incidents is null then
		v_new_incidents := 'Y';
--	end if;


	if Form_usage = 'ICX1' THEN		-- Enterprise Report
		f_LocationID	:=	EPIC.ef_get_EnterpriseID;
		f_location_type := 'ENTERPRISE';
	else
		f_LocationID	:=	p_Location;
	end if;

	if Form_usage = 'ICX2' then
		f_location_type := 'REGION';
	end if;
	if Form_usage = 'ICX3' then
		f_location_type := 'FACILITY';
	end if;
	if Form_usage = 'ICX4' then
		f_location_type := 'UNIT';
	end if;

	PageBreak	:=	EPIC.ef_Report_PageBreak(f_LocationID);
	f_Location	:=	substr(EPIC.ef_location_name(f_LocationID, ''),1,200);

	OPEN RPT_Not_Classified FOR
		SELECT
			1					as flag,	-- Page Header Section of Report
			Report_Title		as	Report_Title,
			Report_Version		as	Report_Version,
			InsititionName 		as	Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(f_LocationID),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			0					as	ChildLevel,
			' '					as 	ChildLocation,
			' '					as 	ChildType,
			' '					as 	Offender_Name,
			' '					as 	Offender_Ident,
			f_review_date		as 	Review_date1,
			f_today_date		as 	Review_date2,
			v_review			as	Review_Period,
			' '					as  dob,
			' '					as  secclass,
			' '					as  sortdate
		FROM DUAL
		UNION
		--
		--	the section below finds all persons on muster with active bookings
		--		who have NO classifications for the booking
		--
/*		SELECT  distinct
			2	as flag,
			'NO CLASSIFICATION'	as	Report_Title,
			' '	as	Report_Version,
			substr(ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col			as	Offender_Ident_Col,
			f_Location				as 	Location_Name,
			substr(ef_location_type_name(elc.location_id),1,200) as Location_Type,
			PageBreak				as	PageBreak,
			nvl(ef_location_level(ef_sub_location(em.Entity_ID, elc.location_id)), 99)
									as	ChildLevel,
			substr(ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
									as ChildLocation,
			substr(ef_location_type_name(ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
									as ChildType,
			substr(decode(
				ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				ef_get_personororgname(em.Entity_ID)), 1, 255)
									as 	Offender_Name,
			substr(decode(
				ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				ef_offender_ident(em.Entity_ID)), 1, 255)
									as 	Offender_Ident,
			' '						as 	Review_date1,
			' '						as 	Review_date2,
			' '						as  Review_Period
		from
			EH_ACTIVE_BOOKING ab,
			eh_muster em,
			eh_Housing_assignments ua,
			epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID			--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.Entity_ID = ab.Entity_ID
			and	not exists (select 1
				from	EH_SECURITY_CLASSIFICATION sc
				where	ab.BOOKING_ID = sc.BOOKING_ID)
		Union
*/
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at a subordinate location of the location parameter
		--
		SELECT  distinct
			3	as flag,
			'SCHEDULED'	as	Report_Title,
			' '	as	Report_Version,
			substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
								as	ChildLevel,
			substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
								as ChildLocation,
			substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
								as ChildType,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(EPIC.ef_epic_date_to_date(v_next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.review_date), EPIC.ef_date_format),1,100)
								as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate
		from
			EPIC.eh_muster em,
			EPIC.EH_Housing_ASSIGNMENTS ua,
			EPIC.EH_ACTIVE_BOOKING ab,
			EPIC.EH_SECURITY_CLASSIFICATION sc,
			EPIC.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from EPIC.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
		Union
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at the location parameter
		--
		SELECT  distinct
			3					as flag,
			'SCHEDULED'					as	Report_Title,
			' '					as	Report_Version,
			substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			99					as	ChildLevel,
			' ' 				as ChildLocation,
			'HOUSED AT ' || f_location_type || ' LEVEL'					as ChildType,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(EPIC.ef_epic_date_to_date(v_next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.review_date), EPIC.ef_date_format),1,100)
								as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate

		from
			EPIC.eh_muster em,
			EPIC.EH_Housing_ASSIGNMENTS ua,
			EPIC.EH_ACTIVE_BOOKING ab,
			EPIC.EH_SECURITY_CLASSIFICATION sc
		where
				em.Entity_ID = ua.Entity_ID
			and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from EPIC.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
   --******************************************************************
   --
   --                        Inmates at, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_charge ch,
		EPIC.eh_security_classification sc,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and   sc.booking_id = ab.booking_id
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_booking_holds hld,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_booking_holds hld,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_booking_holds hld,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_booking_holds hld,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_incident inc,
		EPIC.eh_incident_offender inco,
		EPIC.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(EPIC.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(EPIC.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(EPIC.ef_location_level(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(EPIC.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(EPIC.ef_location_type_name(EPIC.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			EPIC.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', EPIC.ef_suppressed_text(0),
				EPIC.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(EPIC.ef_epic_date_to_date(sc.next_review_date), EPIC.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(EPIC.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(EPIC.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		EPIC.EH_ACTIVE_BOOKING ab,
		EPIC.eh_muster em,
		EPIC.eh_Housing_assignments ua,
		EPIC.eh_security_classification sc,
		EPIC.eh_incident inc,
		EPIC.eh_incident_offender inco,
		EPIC.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from EPIC.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
	  order by 1, 19, 12;


exception
	when others THEN
		EPIC.ep_log_info(Report_Title, 'E', -1,
			sqlerrm || ' - ' || Report_Title || ' (' || Form_usage || ')');
		RETURN;
end ;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_ReviewRoster
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_security_classification.review_date%type,
		p_EndDate		in		EPIC.eh_security_classification.review_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX06
	Crystal: 		reviewroster.rpt
	Purpose:		Used by Classification: Which inmate(s) had a review on the selected
					date and, as a result, his/her classification changed

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/15/05		Created
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					DLK			02/11/05		Added to report tree to test 
					R. Stuve	02/15/05		Added classification line to WHERE clause AND
												added SortingDate as a means to sort records
					R. Stuve	05/10/05		Added Interview flag
					R. Stuve	05/28/05		Compiled on OTMAIN     
					dlk         03/23/06         added macomb and epic notation
*/

		v_min_date		EPIC.eh_security_classification.review_date%type; 
		v_max_date		EPIC.eh_security_classification.review_date%type;
 		v_date_from	  	EPIC.eh_security_classification.review_date%type; 
 		v_date_to		EPIC.eh_security_classification.review_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail									
			
BEGIN  
		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Classification Review Roster' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as Interview,
				'' as InmateName,
				'' as Cell,
				'' as NewClass,
				'' as Alerts,
				'' as PrevClass,
				'' as SortingDate					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data														
	SELECT	2 as Flag,
			'Classification Review Roster' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_Interview(b.booking_id) as Interview,
				--flag to determine if inmate has had an interview completed or not
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
	 		EPIC.ef_offender_housing(b.entity_id) as Cell,
			EPIC.ef_lookup_text('SECURITY CLASSIFICATION',sc1.classification,'UC')as NewClass,
			MACOMB.mcmb_fnt_activealerts_trunc(b.entity_id) as Alerts,
			EPIC.ef_lookup_text('SECURITY CLASSIFICATION',sc2.classification,'UC') as PrevClass,
			sc1.review_date as SortingDate  --RAS: added 2/15 (not a date-type in database)

	FROM 	EPIC.eh_active_booking b,
			EPIC.eh_security_classification sc1,
			EPIC.eh_security_classification sc2

	WHERE	b.booking_id = sc1.booking_id
			and EPIC.ef_epic_date_to_date(sc1.review_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(sc1.review_date) < v_max_date
			and sc1.booking_id = sc2.booking_id
			and EPIC.ef_epic_date_to_date(sc2.review_date) < EPIC.ef_epic_date_to_date(sc1.review_date)
			and sc1.classification <> sc2.classification --RAS: added 2/15
			and not exists
			(
			 select 1
			 from	EPIC.eh_security_classification sc3
		 	 where 	sc3.booking_id = sc2.booking_id
					and EPIC.ef_epic_date_to_date(sc3.review_date) < EPIC.ef_epic_date_to_date(sc1.review_date)
					and EPIC.ef_epic_date_to_date(sc3.review_date) > EPIC.ef_epic_date_to_date(sc2.review_date)
			)
			
ORDER BY Flag, InmateName, SortingDate desc;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Sentenced
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_sentence.sentence_start_date%type,
		p_EndDate		in		EPIC.eh_sentence.sentence_start_date%type)
	 	
IS
 
/*	Form Usage: 	CRSTL.YY31
	Crystal: 		sentenced.rpt
	Purpose:		To list all inmates sentenced within the time period specified.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	09/21/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/11/05		Added to tree to test and title/date fields to query2	
					R. Stuve	01/31/05        Changed 'Union' to 'Union All'  
					R. Stuve	05/05/05		Changed where logic to exclude records with no sentence end date
												and/or disposed charges.  Also inserted functions to pull data
												instead of pulling directly from tables
					R. Stuve	06/16/05		Compiled on OTMAIN		
	                dlk 		02/08/06		Added Work Release Granted and Work seek Flag (Y/N)   
	                dlk         03/23/06        added macomb and epic notations  
	                R. Stuve	04/10/06		Added RlsFlag function; Changed where clause to limit on
	                							charge state action time
*/
 		
		v_min_date		EPIC.eh_sentence.final_release_date%type;
 		v_max_date		EPIC.eh_sentence.final_release_date%type; 
 		v_date_from	  	EPIC.eh_sentence.final_release_date%type;
		v_date_to	   	EPIC.eh_sentence.final_release_date%type;
		v_date_null     date;                    
		--must be same datatype as declarations above so WHERE clause doesn't fail
 			
BEGIN
        
		v_min_date	:= 	EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= 	EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate)); 
		v_date_from	:=	substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to	:=	substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null :=  null;               
		--set value for variables used in query

	OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Sentenced Report' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as Inmate#,
				'' as InmateName,
				'' as CaseNumber,
				--'' as Judge,
				0 as Months,
				0 as Days,
				v_date_null as Outdate,
				'' as Charge,
				'' as WRFlag
		
		FROM	dual
		
	UNION			
		--the below query pulls back the actual report data
		SELECT DISTINCT 2 as Flag,
				'Sentenced Report' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as Inmate#,
      			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
      			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
	      		--MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,   not needed on report (RAS 4/10/06)
				nvl((select sd.months from EPIC.eh_sentence_duration sd
		    		where sd.sentence_duration_id = s.duration_id),
		    				(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id))  as Months,
			 	nvl((select sd.days from EPIC.eh_sentence_duration sd
		    		where sd.sentence_duration_id = s.duration_id),
		      				(select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id))  as Days,
       			EPIC.ef_epic_date_to_date(s.sentence_end_date) as Outdate,
       			MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Charge,
                MACOMB.mf_SentRelAttr(ch.charge_id) as WRFlag
      		
		FROM    EPIC.eh_booking b,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration d,
				EPIC.eh_charge ch

		WHERE	b.booking_id = ch.booking_id
				and s.sentence_id = ch.sentence_id
				and d.sentence_duration_id (+) = s.duration_id
				and ch.charge_state != '6'
				and MACOMB.mf_SentActTm(ch.charge_id) is not null
					--limit based on when charge action was changed to 'Convict and Sentenced
				and EPIC.ef_epic_date_to_date(MACOMB.mf_SentActTm(ch.charge_id)) >= v_min_date
				and EPIC.ef_epic_date_to_date(MACOMB.mf_SentActTm(ch.charge_id)) < v_max_date
    
    	ORDER BY Flag, InmateName;

END;     
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_SenttoPrison
	(vCaseStatus in            EPIC.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.
	Crystal: 		****.rpt
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter   
			 		dlk         03/23/06          added macomb and epic notations
*/

	-- v_date_null date;

BEGIN 

--	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Sentenced to Prison Awaiting Papers' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Charge
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
				'Sentenced to Prison Awaiting Papers' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c
		
		WHERE  	ab.booking_id = c.booking_id
				and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = vCaseStatus
				and c.charge_state != '6'
				
		ORDER BY Flag, InmateNum;            

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_SntToPrsn
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnAWPap.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report  
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
SELECT	distinct 'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,--'AW' as RecType,
			--'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON AWAITING PAPERS'
			and c.charge_state != 6
			
UNION ALL			                                        

		--the below query pulls back the actual report data	
	SELECT distinct 'Case Status (Sentenced to Prison Papers Here)' as RptTitle,--'PH'as RecType,
			--'Case Status (Sentenced to Prison Papers Here)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON PAPERS HERE'
			and c.charge_state != 6

	ORDER BY RptTitle, InmateName;   -- was RecType
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_SntToPrsn_AWPap
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnAWPap.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report   
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON AWAITING PAPERS'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_SntToPrsn_PapH
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnPapHere.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report  
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Sentenced to Prison Papers Here)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Sentenced to Prison Papers Here)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON PAPERS HERE'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_test   (
          vCur OUT EPIC.epp_generic_ref_cursor.ref_cursor
)
is

BEGIN

OPEN vCur FOR

       -- This is for the notes data.  The following will pull
        -- notes located in the eh_generic attribute table where
        -- another link to the epic_lookup table is needed to
        -- display the full text of the note (because a drop down
        -- list box was used to populate the comment in the OT screen

        --first SQL gives only the record that needs the lookup table text (where
          -- attribute_value is a number and needs the lookup table to disp the text    
        --the second SQL gives the note that does not need the lookup text 
        --DLK      03/23/06     ADDED MACOMB AND EPIC NOTATIONS

       SELECT DISTINCT
		EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as Description,
	    epi.entity_id as Entity_ID,
	    bk.booking_id as Booking_ID,
	    --added
	    ec.charge_id as Charge_ID,
	    ga.attribute_name as AttributeName,
	    ga.attribute_value as AttributeValue,
	    lu.text_full as FullText

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_active_booking ab,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_charge ec,
				EPIC.eh_generic_attribute ga,
				EPIC.epic_lookups lu

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND bk.booking_id = ec.booking_id
				AND ec.charge_id = ga.item_id
				--added to get the text for the attribute_value
				AND ga.attribute_name = lu.lookup_class
				AND ga.attribute_value = lu.sub_1



	 	UNION
        SELECT DISTINCT
		EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as Description,
	    epi.entity_id as Entity_ID,
	    bk.booking_id as Booking_ID,
	    --added
	    ec.charge_id as Charge_ID,
	    ga.attribute_name as AttributeName,
	    ga.attribute_value as AttributeValue,
	    ' ' as FullText

	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_active_booking ab,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep,
				--added
				EPIC.eh_charge ec,
				EPIC.eh_generic_attribute ga,
				EPIC.epic_lookups lu

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND bk.booking_id = ec.booking_id
				AND ec.charge_id = ga.item_id
				-- added to get the text for the attribute_value
				--AND ga.attribute_name <> lu.lookup_class
				--AND ga.attribute_value <> lu.sub_1
               AND ga.attribute_name not in (select distinct lookup_class
				              from EPIC.epic_lookups);
				              
		end;


/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_test1  (
          vCur OUT EPIC.epp_generic_ref_cursor.ref_cursor
			)  
/* DLK       03/23/06          ADDED MACOMB AND EPIC NOTATIONS			
*/			
			
	is
	

	BEGIN

	OPEN vCur FOR
 	  SELECT  
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
		EPIC.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		EPIC.ef_location_name(ha.location_id,'uc') as Cell,
		EPIC.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(EPIC.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(EPIC.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(EPIC.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		EPIC.ef_offender_height(ep.entity_id) as Height,
		EPIC.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(EPIC.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		EPIC.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN
	    FROM
		   EPIC.eh_housing_assignments ha,
				EPIC.eh_active_booking ab,
				EPIC.eh_booking bk,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
         
            ;
                
    END mcmb_rpt_test1;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_UnclArr
		(curUcAr		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
/*	Form Usage: 	CRSTL.XX04
	Crystal: 		unclarr.rpt
	Purpose:		Used by Classification to locate inmates that have been arraigned 
					on at least one charge and have not yet been classified.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	08/20/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/20/04		Added to report tree test
					R. Stuve	12/20/04		Changed BookingDate to date/time; removed other
												date/sorting fields.
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'   
					R. Stuve	05/28/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
*/
 v_date_null date;
 
 BEGIN
                  
 v_date_null := null;
 
	OPEN curUcAr FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Unclassified/Arraigned' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as InmateType,
				v_date_null as BookingDate,
				'' as BookingTime			
		
		FROM	dual
		
		UNION ALL			
		--the below query pulls back the actual report data	
			SELECT 	distinct 2 as Flag,
					'Unclassified/Arraigned' as RptTitle,			
					EPIC.ef_offender_id(ab.entity_id) as Inmate#,
  					EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
  					EPIC.ef_location_name(ha.location_id,'UC') as Cell,
  					decode(es.code_custody_status,	
  										'1','R',
  										--Regular
  										'2','F',
  										--Federal
  								 		'3','P',
  								 		--Parole
  										'4','W',
  										--Weekender
           								'5','WR',
           								--WorkRelease
                  						'6', 'KT',
                  						--Kitchen Trustee
                       					'7', 'AW', 
                       					--Alternative Weekend
                           				'9', 'GT',
                           				--Garage Trustee
                              			'10', 'ST',
                              			--Special Trustee
                                		'11', 'JS', 
                                		--Jail Sanction
                                 		'12', 'WW',
                                 		--Writ Witness
                                  		'13', 'T',
                                  		--In Transit
                                   		'14', 'SCC',
                                   		--St. Clair County
                                    	'15', 'LC',
                                    	--Lapeer County
                                    	'16', 'OC')  as InmateType,
                                    	--Oakland County                                    
  				EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
  				substr(EPIC.ef_epic_date_to_Date(bk.start_date),12,5) as BookingTime

		FROM 	EPIC.eh_entity_status es,
  				EPIC.eh_housing_assignments ha,
       		 	EPIC.eh_active_booking ab,
        		EPIC.eh_booking bk,
        		EPIC.eh_generic_attribute g,
        		EPIC.eh_charge c,
        		EPIC.eh_security_classification s

		WHERE 	ha.entity_id (+) = ab.entity_id
 				and ab.booking_id = bk.booking_id
  				and es.entity_id = bk.entity_id
  				and g.item_id = c.charge_id
  				and c.booking_id = bk.booking_id
  				and s.booking_id (+) = bk.booking_id
  				and g.attribute_name = 'CHARGE STATUS'
  				and g.attribute_value not in ('01', '04')
  				and s.classification is null

		ORDER BY Flag, BookingDate, BookingTime;
	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_usbrdptrl_fin
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY71
	Crystal: 		UsBorderPatrol_Fin.rpt
	Purpose:		Used by Finance to list US Boarder Patrol total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS                                       
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null     date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Border Patrol' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

-- US - BORDER PATROL with in selected date range 
SELECT	2 as Flag,
			'Finance - U.S. Border Patrol' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

           
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - BORDER PATROL' 
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_UsedPropBins
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ60
	Crystal: 		****.rpt
	Purpose:		Used by the Jail Office, Booking to list all used property bins

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
*/

BEGIN
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Used Property Bins' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Bin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Used Property Bins' as RptTitle,
				EPIC.ef_offender_id(op.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(op.entity_id) as InmateName,
				EPIC.ef_offender_cell(op.entity_id) as Cell,
				pb.bin_number as Bin

		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op
		
		WHERE	pb.bin_id = pi.bin_id
				and op.item_id = pi.item_id

		ORDER BY Flag, Bin;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_usimmigratn_fin
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY72
	Crystal: 		UsImmigratn_Fin.rpt
	Purpose:		Used by Finance to list US Immigration total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					M.Zak       09-26-05        Modified   Added 'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                                       Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE)  
					dlk         03/23/06        added macomb and epic notations                                                              				
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

--   US - MARSHALL SERVICE with in selected date range 
SELECT	2 as Flag,
			'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

       		
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) in ('IMMIGRATION/NATURALIZATION SERVICE','US - IMMIGRATION & CUSTOM ENFORCEMENT')
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_usmarshall_fin
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY73
	Crystal: 		UsMarshallSrv_Fin.rpt
	Purpose:		Used by Finance to list US - MARSHALL SERVICE total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					M.Zak       8-17-06         added macomb and epic schemas
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Marshall Service' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

-- US - MARSHALL SERVICE with in selected date range 
SELECT	2 as Flag,
			'Finance - U.S. Marshall Service' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - MARSHALL SERVICE'  
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_VacantBeds
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)


IS

/*	Form Usage: 	CRSTL.XX05
	Crystal: 		vacantbed.rpt
	Purpose:		Used to determine available/empty beds within the facility

	Author:			Rachel Stuve/Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/28/04		Created   
					A. Zdybel
					R. Stuve	11/23/04		Added header information via union query	
					DLK			12/20/04		Added to the report tree - test 
					R. Stuve	12/20/04		Added Floor field 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
	
*/

BEGIN

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Vacant Beds' as RptTitle,
				'' as Path,
				'' as Floor,
				'' as Cell,
				0 as Vacancies
		
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data
	     SELECT 2 as Flag,
	     		'Vacant Beds' as RptTitle,
	     		EPIC.ef_location_path_name(location_id,'UC',5) as Path,
	     	    substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1)-1) as Floor,
				location_name as Cell,
				capacity_minimum - (EPIC.ef_location_count(location_id, 'F') + EPIC.ef_location_count(location_id, 'M')) as Vacancies

		FROM 	EPIC.epic_locations

		WHERE	housing_flag = 'Y'
				and location_description in ('CELL', 'DORMITORY')
				and capacity_minimum - (EPIC.ef_location_count(location_id, 'F') + EPIC.ef_location_count(location_id, 'M')) > 0

		ORDER BY Flag, Path;

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_VacPropBins
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ61
	Crystal: 		VacPropBins.rpt
	Purpose:		Used by the Jail Office, Booking to list all empty/available property bins

	Author:			John Gorski/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/13/05		Created (modified code from John G.)
	                M. Zak      04/21/05        Added to Report tree (completed)   
	                R. Stuve	05/24/05		Compiled on OTMAIN  
	                DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
*/

BEGIN
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Vacant Property Bins' as RptTitle,
				'' as Bin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		   --all property bins	
		(SELECT 2 as Flag,
				'Vacant Property Bins' as RptTitle,
				pb.bin_number as Bin

		FROM	EPIC.otk_property_bin pb

			MINUS
           --used property bins
		SELECT	2 as Flag,
				'Vacant Property Bins' as RptTitle,
				pb.bin_number as Bin
		
		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op
		
		WHERE	pb.bin_id = pi.bin_id
				and op.item_id = pi.item_id);

END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_VoidBookFees
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.trans_date%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.trans_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY57
	Crystal: 		voidbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were void during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					DLK			02/25/05		Added to report tree to test
					R. Stuve	05/28/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOATIONS 
	
*/
        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_max_date		EPIC.eh_trans_distribution.trans_date%type;  
     	v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		v_date_to		EPIC.eh_trans_distribution.trans_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Void Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Void Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				decode(tat.code_source_of_funds,'502','C','503','S') as Agency


		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat


		WHERE	t.trust_account_id = tat.trust_account_id
				and (code_source_of_funds = '502'
					or code_source_of_funds = '503')
				and tat.reverse_flag = 'Y'
				and EPIC.ef_epic_date_to_date(tat.trans_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(tat.trans_date) <= v_max_date

ORDER BY Flag, Agency, InmateNum, TDate;

END;  
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Weekender
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ63
	Crystal: 		weekenders.rpt
	Purpose:		Used by the Jail Office to determine when those inmates with weekender
					sentences are due to be released

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/29/04		Created  
					dlk			01/10/05		Added to the tree. Changed RlsDate format
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled in OTMAIN   
					dlk         03/23/06        added macomb and epic notations
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Weekenders)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				'' as WRTime,
				v_date_null as RlsDate
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Weekenders)' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
				cs.case_number as DocketNum,
				ca.judge_name as Judge,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				MACOMB.mcmb_fnt_wrlstime(ab.entity_id) as WRTime,
				EPIC.ef_epic_date_to_date(b.sentence_end_date) as RlsDate

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_case_charge a,
				EPIC.eh_court_appearance ca,
				EPIC.eh_case cs,
				EPIC.eh_entity_status e

		WHERE	b.booking_id = ab.booking_id
				and ab.booking_id = c.booking_id
				and c.charge_id = a.charge_id
				and a.case_id = ca.owner_id (+)
				and cs.case_id (+) = a.case_id
				and (MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED WEEKENDER' or e.code_custody_status = '4')
				and c.charge_state != 6
				and b.entity_id = e.entity_id (+)

		ORDER BY Flag, RlsDate, WRTime, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_Writ
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		Writ.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report  
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'HERE ON WRIT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_WritHldPrb
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		WritHldPrb.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report  
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ - Hold for Prob Intrvw)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ - Hold for Prob Intrvw)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'HERE ON WRIT HOLD FOR PROBATION INTERVIEW'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE mcmb_rpt_WritRdytoRtn
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		WritRdytoRtn.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report 
					DLK           03/23/06       ADDED MACOMB AND EPIC NOTATIONS
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ - Ready to Return)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ - Ready to Return)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'READY TO RETURN WRIT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
VIEW MCMB_VIEW_ALIAS ( ENTITY_ID, ALIAS_ID, LASTNAME, FIRSTNAME, MIDDLENAME, SUFFIXNAME, DOB, CODE_NAME_TYPE, LINK_PK ) AS
select 	id.OFFENDER_ID AS entity_id,
		pi.identity_id AS alias_id,
		pi.name_family AS lastname,
		pi.name_first  AS firstname,
		pi.name_other  AS middlename,
		pi.name_suffix AS suffixname,
 	    NVL(NVL(to_char(EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
 	    		to_char(EPIC.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
 	                   'UNKNOWN') AS DOB,
 	    pi.CODE_NAME_TYPE AS CODE_NAME_TYPE,
 	    decode(pi.CODE_NAME_TYPE, 'MAS',id.OFFENDER_ID, 'ALIAS') AS LINK_PK
FROM    EPIC.eh_person_identity pi,
		EPIC.eh_offender_ids id
WHERE	id.ENTITY_ID = pi.entity_id
  AND	pi.CODE_NAME_TYPE in ('MAS','ALI')
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where id.entity_id = ab.entity_id)
/

CREATE OR REPLACE
VIEW MCMB_VIEW_CHARGE ( ENTITY_ID, CHARGE_ID, STATUTE_ID, PACC, CHARGE_DESC, CHARGE_CLASS, SENTENCE_ID, CHARGE_ID_NUMBER, AGENCY_ID, COMPLAINT_DEPT, COURT_ID, CASE_NO, COURT_NAME, COURT_DATE, COURT_DIVISION, COURT_JUDGE, START_DATE, FINAL_RELEASE_DATE, AMOUNT, AMOUNT_TYPE, TRANS_TYPE, SORTORDER, WEB_CHARGE_PK, REDUCEAMOUNT, PAIDOUTDATE, UNPAIDOUTDATE ) AS
SELECT 	id.OFFENDER_ID				AS entity_id,
		c.charge_id 				AS charge_id,
        c.statute_id 				AS statute_id,
        es.statute_number 			AS pacc,
        es.statute_description 		AS charge_desc,
    	EPIC.ef_lookup_text('STATUTE CLASS', es.code_statute_class, 'UC') AS charge_class,
        s.sentence_id 				AS sentence_id,
       	charge_id_number 			AS charge_id_number,
       	ca.agency_id 				AS agency_id,
       	eo.organization_name 		AS complaint_dept,
       	cct.court_id 				AS court_id,
       	cs.case_number 				AS case_no,
       	EPIC.mcmb_fnt_courtname(c.charge_id) AS court_name,
       	decode(
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY'),'12/25/2025','Call Court',
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY')) AS court_date,
       	
       	EPIC.ef_next_court_division(b.entity_id) AS court_division,
       	EPIC.ef_lookup_text('JUDGE NAME',EPIC.ef_next_court_judge(b.entity_id),'UC') AS court_judge,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.start_date(b.booking_id))         		AS Start_Date,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.final_release_date(b.booking_id))     	AS final_releASe_date ,
		decode(c.sentence_id,NULL,
							to_number(bc.cash_only_bail_amount),
							to_number(EPIC.mcmb_fnt_fineamount(c.sentence_id)))  AS amount,
		decode(c.sentence_id,NULL, 'BAIL', 'FINE') AS amount_type,
		decode(c.sentence_id,NULL, 'U', 'S') AS Trans_type,
		decode(c.sentence_id,NULL, 2, 1) AS sortorder,
		EPIC.ef_offender_id(b.entity_id)||' - '||c.charge_id  AS web_charge_pk,
		decode(EPIC.ef_get_attribute_value('10 PERCENT BOND',bc.BAIL_CONDITION_ID),'YES',
															'Y',
															'N') AS reduceamount,
		so.paid_out_date AS paidoutdate,
		so.unpaid_out_date AS unpaidoutdate
FROM 	EPIC.eh_charge c, 
		EPIC.eh_booking b, 
		EPIC.eh_active_booking ab,
		EPIC.eh_charge_agency ca ,
     	EPIC.eh_case cs, 
     	EPIC.eh_case_charge cc, 
     	EPIC.eh_case_court cct,
     	EPIC.eh_entity_organization eo, 
     	EPIC.eh_sentence s, 
     	EPIC.eh_sentence_out_dates so,
     	EPIC.epic_statutes es, 
     	EPIC.eh_bail_condition bc, 
     	EPIC.eh_bail_condition_charge bcc,
		EPIC.eh_offender_ids id
WHERE b.booking_id = c.booking_id 
  AND c.charge_id = ca.charge_id 
  AND s.sentence_id (+) = c.sentence_id 
  AND cs.booking_id = b.booking_id 
  AND cc.charge_id = c.charge_id 
  AND cc.cASe_id = cs.cASe_id 
  AND cct.cASe_id = cs.cASe_id 
  AND eo.entity_id = ca.agency_id 
  AND es.STATUTE_ID = c.statute_id
  AND so.sentence_id (+)  = c.sentence_id
  AND bc.booking_id = b.booking_id
  AND bcc.charge_id = c.charge_id
  AND bc.bail_condition_id = bcc.bail_condition_id
  AND b.booking_id = ab.booking_id
  AND id.ENTITY_ID = ab.entity_id
  AND EPIC.ef_is_active_booking(b.entity_id)='TRUE'
union
-- HOLD records
SELECT EPIC.ef_offender_id(b.entity_id) AS entity_id,
       h.hold_id AS charge_id,
	   NULL      AS statute_id,
       NULL      AS pacc,
       NULL      AS charge_desc,
       EPIC.ef_lookup_text('STATUTE CLASS', code_charge_severity, 'UC') AS charge_clASs,
       NULL                 AS sentence_id,
       EPIC.ef_lookup_text('HOLD TYPE',code_hold_type,'UC') AS charge_id_number,
       h.agency_id          AS agency_id,
       eo.organization_name AS complaint_dept,
       NULL                 AS court_id,
       -- case number (other attrib - hold warant number)
       EPIC.ef_get_attribute_value('HOLD WARRANT NUMBER',h.hold_id) AS case_no,
       -- court name  (other attrib - hold court)
       EPIC.ef_get_attribute_value('HOLD COURT',h.hold_id) AS court_name,
       NULL AS court_date,
       NULL AS court_division,
       NULL AS court_judge,
       NULL AS start_date,
       NULL AS final_release_date,
       -- bond/fines  (other attrib - hold amount)
       to_number(EPIC.ef_get_attribute_value('HOLD AMOUNT',h.hold_id)) AS amount,
       'BOND' AS amount_type,
	   'H'    AS Trans_type,
       3      AS sortorder,
        EPIC.mcmb_fnt_offenderidfrombk(b.booking_id)||' - '||h.hold_id,
   	    decode(sign(instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10%')+
  					instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10 %')+
   					instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'10 PERCENT'))-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO 10')*100)-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO10')*100),
				  					1,'Y','N') AS reduceamount,
		NULL AS paidoutdate,
		NULL AS unpaidoutdate
FROM EPIC.eh_booking_holds h, 
     EPIC.eh_active_booking b,
     EPIC.eh_entity_organization eo
WHERE b.booking_id = h.booking_id 
  AND eo.entity_id = h.agency_id
/

CREATE OR REPLACE
VIEW MCMB_VIEW_INMATE ( ENTITY_ID, LASTNAME, FIRSTNAME, LEVEL4, LEVEL5, LEVEL6, LEVEL7, LEVEL8, DOB, PAID_RELEASE, PROJECTED_RELEASE, JUVENILE_FLAG, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, MUGPATH, VEHICLE_ID, TOW_COMPANY, OTHERNAME, INMATECLASS, GENDER, CELL, RESTRICTIONUNTIL ) AS
select      id.OFFENDER_ID AS entity_id,
				pi.NAME_FAMILY as lastname,
			    pi.NAME_FIRST  as firstname,
	   		 substr(epic.ef_location_path_name(ha.location_id ,'uc',4),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',4),',')-1) as Level4,
	   		 substr(epic.ef_location_path_name(ha.location_id ,'uc',5),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',5),',')-1) as Level5,
	  		 substr(epic.ef_location_path_name(ha.location_id ,'uc',6),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',6),',')-1) as Level6,
       		 substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1) as level7,
       		 substr(epic.ef_location_path_name(ha.location_id ,'uc',8),
              instr(epic.ef_location_path_name(ha.location_id ,'uc',8),
        		/*level7 */ substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1)
                    ,2)+1) as level8,
				NVL(NVL(to_char(epic.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
						to_char(epic.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
					'UNKNOWN_DOB') as DOB,
				epic.ef_epic_date_to_date(epic.epp_booking_dates.earliest_release_date(ab2.booking_id)) as paid_release,
    	   		epic.ef_epic_date_to_date(epic.epp_booking_dates.final_release_date(ab2.booking_id))    as Projected_release,--,
				decode(ep.JUVENILE_FLAG,'Y','Y','N') as juvenile_flag,
    	   		EPIC.mcmb_fnt_sent_Total_Amount(ab2.booking_id) as sent_total,
    	   		EPIC.mcmb_fnt_hold_Total_Amount(ab2.booking_id) as hold_total,
    	   		EPIC.mcmb_fnt_Bail_Total_Amount(ab2.booking_id) as bail_total,
				decode(ei.imageref, null,null,
					'\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
   				vehicle_id as vehicle_id,
				eo.ORGANIZATION_NAME as tow_company,
				pi.NAME_OTHER  as othername,
	   		 decode(epic.ef_offender_CustStat(ab2.entity_id),
                  	'REGULAR INMATE','R',
					'WORK RELEASE','W',
                  	'KITCHEN TRUSTEE (White)','K',
                  	'GARAGE TRUSTEE (Orange)','O',
                  	'SPECIAL TRUSTEE (Green)','G',
                  	'R') as inmateclass,
   				decode(ep.CODE_GENDER,'_NOSP','U',ep.CODE_GENDER) as gender,
		   		 substr(epic.ef_location_name(ha.location_id ,'uc'),1,10) as cell,
    	   		epic.ef_epic_date_to_date(r.end_date) as restrictionuntil
			 from   epic.EH_OFFENDER_IDS id,
			 		epic.EH_PERSON_IDENTITY pi,
			 		epic.eh_entity_person ep,
			 		epic.EH_VEHICLE v,
					epic.EH_ENTITY_ORGANIZATION  eo,
					epic.Epicvolume ev,
					epic.Epicimage ei,
					epic.Eh_entity_default_photo ph,
					epic.eh_active_booking ab2,
					epic.eh_housing_assignments ha,
					epic.EH_ENTITY_RESTRICTION r
			 where  id.entity_id = ab2.entity_id
  			   and  epic.ef_is_active_booking(ab2.entity_id)='TRUE'
  			   and  id.entity_id = pi.entity_id
  			   and  id.entity_id = ep.entity_id
  			   and  ab2.entity_id = ha.entity_id
			   and  v.entity_id(+) = pi.entity_id
			   and  v.tow_company_id = eo.entity_id(+)
			   and  ei.imageref(+) = ph.photo_id
			   and  ev.volumeid(+) = ei.volumeid
			   and  ph.entity_id(+) = id.entity_id
  			   and  pi.code_name_type = 'MAS'
  			   and  ab2.entity_id = id.entity_id
  			   and  ab2.entity_id = r.entity_id(+)
/

CREATE OR REPLACE
VIEW MCMB_VIEW_VISTITOR ( ENTITY_ID, VISITOR_ID, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ, VISTITOR_PK ) AS
SELECT 	id.offender_id AS entity_id, 
		er.ENTITY_RELATED_TO AS VISITOR_ID,
		DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_app_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS application_date,
       	DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_expir_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS expiration_date,
       	pi.name_family AS lastname,
       	pi.name_first  AS firstname,
       	DECODE(er.RELATIONSHIP_TYPE,'21','A','N') AS status,
       	DECODE(er.RELATIONSHIP_TYPE,'21','1','2') AS typeseq,
   	   	id.offender_id ||'-'||er.ENTITY_RELATED_TO AS vistitor_pk
FROM   	EPIC.eh_offender_ids id,
		EPIC.eh_person_identity pi,
       	EPIC.eh_entity_relationship er
--       	EPIC.eh_active_booking ab
WHERE  er.ENTITY_RELATED_TO = pi.entity_id
--  AND  ab.entity_id = pi.entity_id
  AND  id.entity_id = er.entity_id
  AND  er.related_as_role = 'VISTR'
  AND  pi.code_name_type = 'MAS'   
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where pi.entity_id = ab.entity_id)
  
UNION
-- Banned
SELECT 	'' AS entity_id, 
		va.visitor_id AS vistitor_id, 
		va.date_FROM AS application_date, 
		va.date_to AS expiration_date, 
		vpi.name_family AS lastname, 
		vpi.name_first  AS firstname, 
		'B' AS status, 
		'3' AS typeseq,
		''||'-'||va.VISITOR_ID
FROM 	EPIC.eh_banned_visitor va, 
		EPIC.eh_person_identity vpi
--       	EPIC.eh_active_booking ab
WHERE 	va.visitor_id = vpi.entity_id
--  AND	ab.entity_id = vpi.entity_id
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where vpi.entity_id = ab.entity_id)
/

CREATE OR REPLACE
FUNCTION mf_Active_book_id
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate.
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
	select 'Y'
	INTO vActive
	FROM EPIC.eh_active_booking ab
	WHERE ab.booking_id = p_booking_id;
    EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_Active_case_id
	(p_case_id	in		EPIC.eh_case_court.case_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
		select 'Y'
		INTO vActive
		FROM   EPIC.eh_active_booking ab,
	    	   EPIC.eh_charge c,
	       	   EPIC.eh_case_charge cc,
	           EPIC.eh_case_court cct,
	           EPIC.eh_case cs
		WHERE  CCT.CASE_ID = p_case_id
		  and  c.charge_id = cc.charge_id
		  AND  c.booking_id = ab.booking_id
		  AND  cc.case_id = cs.case_id
		  AND  cs.case_id = cct.case_id;
 	EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_Active_charge_id
	(p_charge_id	in		EPIC.eh_booking.booking_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
	select 'Y'
	INTO vActive
	FROM EPIC.eh_active_booking ab, EPIC.eh_charge c
	WHERE ab.booking_id = c.booking_id
	  AND c.charge_id = p_charge_id;
    EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_Active_ENTITY_id
	(p_entity_id	in		EPIC.eh_active_booking.entity_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
		select 'Y'
		INTO vActive
		FROM   EPIC.eh_active_booking ab
		WHERE  ab.entity_id = p_entity_id;
 	EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_Active_item_id
	(p_item_id	in		EPIC.eh_generic_attribute.item_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
		select 'Y'
		INTO vActive
		FROM   EPIC.eh_active_booking ab,
			   EPIC.eh_booking_holds h
		WHERE  h.hold_id = p_item_id
		  AND  h.booking_id = ab.booking_id  ;
   	EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_Active_SENTENCE_id
	(p_sentence_id	in		EPIC.eh_charge.sentence_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/11/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(2);
  
BEGIN          
	vActive := 'N';
    BEGIN
		select 'Y'
		INTO vActive
		FROM   EPIC.eh_active_booking ab,
				EPIC.eh_charge c
		WHERE  c.booking_id  = ab.booking_id
		  AND  c.sentence_id = p_sentence_id ;
   	EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION mf_actualrelease
	(p_booking_id	in		EPIC.eh_release.booking_id%type)

/*
Purpose: Returns actual release date per booking id

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/12/06			Verified MACOMB/EPIC schema
*/

RETURN DATE 
IS

v_actual_release varchar2(20);

BEGIN
	SELECT	actual_release
	INTO 	v_actual_release	
	FROM	EPIC.eh_release
	WHERE booking_id = p_booking_id
	ORDER BY actual_release;   
	
RETURN EPIC.ef_epic_date_to_date(v_actual_release);
END;
/

CREATE OR REPLACE
FUNCTION MF_addrbytype_address_id
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--testing address id MAZ, ADDRESS_ID

RETURN VARCHAR2 AS

v_addressid		varchar2(128);

	CURSOR cur_Addressid IS
		SELECT
			a.address_id
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Addressid;
		FETCH cur_Addressid INTO v_Addressid;
	CLOSE cur_Addressid;
			
RETURN v_Addressid;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_city_town
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work city_town_locale based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_country
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work country based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.code_country
		FROM
		    EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_dwelling
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)     
	 
--Returns the inmate's most current dwelling_name based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.dwelling_name
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_flatno_floor
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work flat_no_or_floor_level based on type 
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.flat_no_or_floor_level
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_postal
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work postal code based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.postal_code
		FROM
		    EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_state_province
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work state_province_region based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.state_province_region
		FROM
		    EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_streetname
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work street_name based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.street_name
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_AddrByType_streetnumber
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)
	
--Returns the inmate's most current work street_number based on type
-- Demographics - address based on address type

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.street_number 
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			and a.address_type = p_type  -- work 
 		ORDER BY   a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION mf_agency
	 (p_entity_id	in 	EPIC.eh_charge.charge_id%TYPE)  
return EPIC.epic_col_types.varchar_255%type
is

/*
Purpose: Returns the agency for the selected entity 
FIRST complaint Department only!!!!

Change Log:		Changed By  	Date Modified	Change Made
				------------  	-------------	------------------------------------------
				J. McBratnie	9/3/06			Create
*/		 

v_complaint_dept varchar2(16);

BEGIN
	    select ca.agency_id
	    into v_complaint_dept
		from  	EPIC.eh_charge c,
				EPIC.eh_charge_agency ca 
		where c.charge_id = p_entity_id
		  AND c.charge_id = ca.charge_id
		  AND rownum = 1;
    
	RETURN v_complaint_dept;
END;
--JDM
/

CREATE OR REPLACE
Function mf_Arrestee_EntityID
	(p_Arrest_id in MACOMB.mt_pb_arrestee.arrest_id%type)

RETURN VARCHAR2 AS

v_Ar_entityID VARCHAR2(16);

CURSOR cur_ArEntityID IS
	SELECT matchedoffender_id
		FROM	MACOMB.mt_pb_arrestee ar
		WHERE	ar.arrest_id = p_Arrest_id;
BEGIN
OPEN cur_ArEntityID;
	FETCH cur_ArEntityID into v_Ar_entityID;
CLOSE cur_ArEntityID; 

RETURN v_Ar_entityID;
END;
/

CREATE OR REPLACE
FUNCTION        mf_BailCrtDsp
	(p_ChargeID		IN		EPIC.eh_charge.charge_id%type)
	
/*	
	Purpose:		Returns the value of the 'Court Disposition' other attribute of the selected bail condition
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  

vBail		EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR curBail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = 'COURT DISPOSITION'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_ChargeID;
			
BEGIN	
	OPEN curBail;
		FETCH curBail into vBail;
	CLOSE curBail;

RETURN vBail;

END;
/

CREATE OR REPLACE
FUNCTION        mf_BailMayBeRls
	(p_ChargeID		IN		EPIC.eh_charge.charge_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MAY BE RELSD IF FINE PD' other attribute of the selected bail condition
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  

vBail		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curBail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = 'MAY BE RELSD IF FINE PD'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_ChargeID;
			
BEGIN	
	OPEN curBail;
		FETCH curBail into vBail;
	CLOSE curBail;

RETURN vBail;

END;
/

CREATE OR REPLACE
FUNCTION        mf_bailtotal_unsent
	 (p_booking_id 	in 	EPIC.eh_bail_condition.booking_id%TYPE) 
	 

 /*	
	Purpose:		Returns the total bail amount per booking for all unsentenced charges

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 09/26/06		Created
*/  	 
RETURN VARCHAR2 AS

CURSOR curBail IS   	
	SELECT 	sum(b.cash_only_bail_amount)
	
	FROM 	EPIC.eh_charge c,
			EPIC.eh_bail_condition_charge bcc,
			EPIC.eh_bail_condition b
	
   	WHERE	c.charge_id = bcc.charge_id
   			and bcc.bail_condition_id = b.bail_condition_id
   			and c.charge_state != '4' --sentenced
			and c.charge_state != '6' --disposed	
   			and p_booking_id = c.booking_id
   	
	GROUP BY c.booking_id;

vBail	 EPIC.eh_bail_condition.cash_only_bail_amount%TYPE;

BEGIN
  	OPEN curBail;
  		FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
/

CREATE OR REPLACE
function MF_bail_charge_ID (
	p_bail_condition_id           in      EPIC.EH_BAIL_CONDITION_CHARGE.BAIL_CONDITION_ID%type)
return EPIC.EH_BAIL_CONDITION_CHARGE.CHARGE_ID%type
is

/*	
	Purpose:		Get the charge_id from bail_condition_id

	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/25/06		Created
*/


v_id					EPIC.EH_BAIL_CONDITION_CHARGE.CHARGE_ID%type;

begin
    SELECT CHARGE_ID
    INTO v_id
    FROM EPIC.EH_BAIL_CONDITION_CHARGE
    WHERE BAIL_CONDITION_ID = p_bail_condition_id;

	return v_id;
end MF_bail_charge_ID ;
/

CREATE OR REPLACE
function MF_bail_cond_cashonly (
	p_booking_id           in      EPIC.EH_BAIL_CONDITION.BOOKING_ID%type)
return EPIC.EH_BAIL_CONDITION.CASH_ONLY_BAIL_AMOUNT%type
is

/*	
	Purpose:		Get the Bail_condition_id from booking_ID

	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/25/06		Created
*/


v_id					EPIC.EH_BAIL_CONDITION.CASH_ONLY_BAIL_AMOUNT%type;

begin
    SELECT CASH_ONLY_BAIL_AMOUNT
    INTO v_id
    FROM EPIC.EH_BAIL_CONDITION
    WHERE BOOKING_ID = p_booking_id;

	return v_id;
end MF_bail_cond_cashonly ;
/

CREATE OR REPLACE
function MF_bail_cond_ID (
	p_booking_id           in      EPIC.EH_BAIL_CONDITION.BOOKING_ID%type)
return EPIC.EH_BAIL_CONDITION.BAIL_CONDITION_ID%type
is

/*	
	Purpose:		Get the Bail_condition_id from booking_ID

	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/25/06		Created
*/


v_id					EPIC.EH_BAIL_CONDITION.BAIL_CONDITION_ID%type;

begin
    SELECT BAIL_CONDITION_ID
    INTO v_id
    FROM EPIC.EH_BAIL_CONDITION
    WHERE BOOKING_ID = p_booking_id;

	return v_id;
end MF_bail_cond_ID ;
/

CREATE OR REPLACE
FUNCTION        mf_birthcountry_code
	(p_entity_id				in		EPIC.eh_person_identity.entity_id%type)
	
/*
Purpose: Returns the code for the country of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	07/20/06			Created
*/

RETURN VARCHAR2
IS

v_country		EPIC.eh_person_identity.birth_country%type;

	CURSOR cur_country IS
		SELECT
			i.birth_country
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_country;
		FETCH cur_country INTO v_country; 
	CLOSE cur_country;
			
RETURN v_country;

END; 
/

CREATE OR REPLACE
FUNCTION MF_Bookid_Most_Recent
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
--Returns an inmate's booking id for the most recent released booking
RETURN VARCHAR2 AS

v_booking_id				EPIC.eh_booking.booking_id%type;

	CURSOR cur_id IS
		select
			bk.booking_id  
		FROM EPIC.eh_booking bk,
		  	 EPIC.eh_release r
        WHERE
        	bk.entity_id = p_entity_id   --0IHULAOXG0XD3MIG
			and bk.booking_id = r.booking_id
			and EPIC.ef_epic_date_to_date(bk.start_date) is not null
        	and EPIC.ef_epic_date_to_date(r.actual_release) is not null
		ORDER BY start_date DESC;
  
BEGIN
	OPEN cur_id;
		FETCH cur_id INTO v_booking_id;
	 	CLOSE cur_id;	
			
--RETURN v_booking_id;
RETURN NVL (v_booking_id, NULL);

END;                            

/

CREATE OR REPLACE
FUNCTION mf_CanReadYN
	 (p_entity_id IN EPIC.eh_entity_work_skills.entity_id%TYPE) 

/*
Purpose: Returns a 'YES' flag if the inmate can READ ENGLISH  (Demographics View, Addr/Tele/Info Tab, field Read/Write 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M.Zak	     5-9-06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curRead IS   	
  	SELECT 	'YES'

    FROM 	EPIC.eh_entity_work_skills ws   -- '0IR6B8O000USJ1IR'

	WHERE	ws.entity_id = p_entity_id
	        and ws.code_skill in ('READ/WRITE','READS ONLY') ;	
     
    
v_read EPIC.eh_entity_work_skills.code_skill%type;


BEGIN
	OPEN curRead;
  		FETCH curRead INTO v_read;
  	CLOSE curRead;
	RETURN NVL(v_read, NULL);
  		
END;

/

CREATE OR REPLACE
FUNCTION mf_CanWriteYN
	 (p_entity_id IN EPIC.eh_entity_work_skills.entity_id%TYPE) 

/*
Purpose: Returns a 'YES' flag if the inmate can WRITE ENGLISH  (Demographics View, Addr/Tele/Info Tab, field Read/Write 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M.Zak	     5-9-06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curRead IS   	
  	SELECT 	'YES'

    FROM 	EPIC.eh_entity_work_skills ws   -- '0IR6B8O000USJ1IR'

	WHERE	ws.entity_id = p_entity_id
	        and ws.code_skill in ('WRITES ONLY','WRITE NAME') ;	
     
    
v_read EPIC.eh_entity_work_skills.code_skill%type;


BEGIN
	OPEN curRead;
  		FETCH curRead INTO v_read;
  	CLOSE curRead;
	RETURN NVL(v_read, NULL);
  		
END;
/

CREATE OR REPLACE
FUNCTION mf_ChargeStatusCode
	(p_charge_id		in	EPIC.eh_charge.charge_id%type,
	 p_StartDate		in	EPIC.eh_charge.action_time%type) 

/*
Purpose: Returns the charge status at the selected time  

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/12/06			Created
*/

RETURN VARCHAR2 AS

vCode		VARCHAR2(12);
v_max_date	VARCHAR2(20);

BEGIN
  vCode := 'NOT ENTERED';
  v_max_date := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_StartDate));
	BEGIN
		SELECT 	ga.attribute_value
		INTO	vCode
		FROM	EPICAUDIT.eh_generic_attribute ga
		WHERE	attribute_name = 'CHARGE STATUS'
				and ga.item_id = p_charge_id
				and EPIC.ef_epic_date_to_date(ga.action_time) <= v_max_date
				and not exists
					(select 1 
					from EPICAUDIT.eh_generic_attribute ga2
					where ga2.item_id = ga.item_id
					and EPIC.ef_epic_date_to_date(ga2.action_time) < v_max_date
					and EPIC.ef_epic_date_to_date(ga2.action_time) > EPIC.ef_epic_date_to_date(ga.action_time))
		UNION ALL
		SELECT 	ga.attribute_value
		FROM 	EPICAUDIT.eh_generic_attribute ga
		WHERE 	ga.item_id = p_charge_id  
				and EPIC.ef_epic_date_to_date(ga.action_time) <= v_max_date
				and not exists
					(select 1
					 from EPICAUDIT.eh_generic_attribute ga2
					 where ga2.item_id = ga.item_id
					 and EPIC.ef_epic_date_to_date(ga2.action_time) < v_max_date);
		EXCEPTION
			WHEN NO_DATA_FOUND THEN
				vCode := 'NOT ENTERED';
	END;

RETURN vCode;
END;
/

CREATE OR REPLACE
FUNCTION mf_complaint_dept
	 (p_entity_id	in 	EPIC.eh_charge.charge_id%TYPE,
	  p_type        in  char)  
return EPIC.epic_col_types.varchar_255%type
is

/*
Purpose: Returns the complaint_dept for the selected entity 
FIRST complaint Department only!!!!

Change Log:		Changed By  	Date Modified	Change Made
				------------  	-------------	------------------------------------------
				J. McBratnie	9/3/06			Create
*/		 

v_complaint_dept varchar2(64);

BEGIN
	IF p_type = 'C' then
	    select eo.organization_name
	    into v_complaint_dept
		from  	EPIC.eh_charge c,
				EPIC.eh_charge_agency ca ,
     			EPIC.eh_entity_organization eo
		where c.charge_id = p_entity_id
		  AND c.charge_id = ca.charge_id
		  AND eo.entity_id = ca.agency_id
		  AND rownum = 1;
	ELSIF p_type = 'H' THEN
	    select eo.organization_name
	    into v_complaint_dept
		FROM EPIC.eh_booking_holds h,
		     EPIC.eh_entity_organization eo
		WHERE h.booking_id = p_entity_id
		  AND eo.entity_id = h.agency_id
		  AND rownum = 1;
	ELSE
		v_complaint_dept := 'Type undefined';
	END IF;		                            
    
	RETURN v_complaint_dept;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION        mf_complexion_code
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the code for an inmate's complexion
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	07/20/06			Created
*/	
	
RETURN VARCHAR2 AS

v_comp		EPIC.eh_person_snapshot.code_complexion%type;

	CURSOR cur_comp IS
		SELECT
			s.code_complexion
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_comp;
		FETCH cur_comp INTO v_comp;
		CLOSE cur_comp;
			
RETURN v_comp;

END;
/

CREATE OR REPLACE
FUNCTION mf_CstyStBk
(p_booking_id	in		EPIC.eh_booking.booking_id%type)    

/*
Purpose: Returns the code entity status for the input booking 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/13/06			Created
*/	 		

RETURN VARCHAR2 AS

--vDate	VARCHAR2(20);
--vBond	VARCHAR2(20);
--vTime	VARCHAR2(20); 
vID		VARCHAR2(1);

BEGIN
--vDate  := null;
--vBond  := null;
vID    := 'N';
	BEGIN
		SELECT	'Y'
		INTO	vID
		FROM 	EPIC.eh_booking_entity_status bk,
		     	EPIC.eh_booking_entity_status bk2
		WHERE 	bk.booking_id = bk2.booking_id
				and bk.code_entity_status = '01'
				and bk2.code_entity_status = '02';
		EXCEPTION
			WHEN NO_DATA_FOUND THEN
	         vID := 'N';
	  END;
	  
RETURN vID;
END;
	
/

CREATE OR REPLACE
function mf_date_between(
		p_date_check			EPIC.eh_charge.action_time%type,
		p_min_date				EPIC.eh_charge.action_time%type,
		p_max_date				EPIC.eh_charge.action_time%type
		)
return varchar2

/*
Purpose: Returns 'TRUE' if p_date_check is between p_min_date and p_max_Date  
                 'FALSE'  if NOT p_date_check is between p_min_date and p_max_Date
                 'INVALID' if p_max_date <= p_min_date
	        
Change Log:		Changed By		Date Modified	Change Made
				----------		-------------	------------------------------------------
				J. Mcbratnie	5/18/06			Created function
*/	

is


begin      
	IF epic.ef_epic_date_to_date(p_max_date) <= epic.ef_epic_date_to_date(p_min_date) then
		RETURN 'INVALID';
	END IF;
	IF epic.ef_epic_date_to_date(p_date_check) >= epic.ef_epic_date_to_date(p_min_date) and 
	   epic.ef_epic_date_to_date(p_date_check) <= epic.ef_epic_date_to_date(p_max_date) THEN 
	   	RETURN 'TRUE';
	ELSE
		RETURN 'FALSE';
	END IF;
end;
/

CREATE OR REPLACE
FUNCTION MF_EC_Area
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Area Code
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_Area		varchar2(128);

	CURSOR cur_Area IS
		SELECT
			tr.area_code
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
 
BEGIN
	OPEN cur_Area;
		FETCH cur_Area INTO v_Area;
	CLOSE cur_Area;
			
RETURN v_Area;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_Contact
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact 
-- Demographics - Contacts tab

RETURN VARCHAR2 AS

v_Contact		varchar2(128);

	CURSOR cur_Contact IS
		SELECT
			epic.EF_GET_PERSONORORGNAME(tr.entity_id)
		FROM
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                  
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Contact;
		FETCH cur_Contact INTO v_Contact;
	CLOSE cur_Contact;
			
RETURN v_Contact;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_Contact_ID
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact ID (entity_related_to) 
-- Demographics - Contacts tab

RETURN VARCHAR2 AS

v_ContactID		varchar2(128);

	CURSOR cur_ContactID IS
		SELECT
			er.entity_related_to     --(related to entity id)
		FROM
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                  
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_ContactID;
		FETCH cur_ContactID INTO v_ContactID;
	CLOSE cur_ContactID;
			
RETURN v_ContactID;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_Country
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Country code
-- Demographics - Contacts tab

RETURN VARCHAR2 AS

v_Country		varchar2(128);

	CURSOR cur_Country IS
		SELECT
			tr.code_country
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Country;
		FETCH cur_Country INTO v_Country;
	CLOSE cur_Country;
			
RETURN v_Country;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_Extension
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Extension
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_Ext		varchar2(128);

	CURSOR cur_Ext IS
		SELECT
			tr.extension
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Ext;
		FETCH cur_Ext INTO v_Ext;
	CLOSE cur_Ext;
			
RETURN v_Ext;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_PhNumber
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Phone Number
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_Number		varchar2(128);

	CURSOR cur_Number IS
		SELECT
			tr.Base_number
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Number;
		FETCH cur_Number INTO v_Number;
	CLOSE cur_Number;
			
RETURN v_Number;

END;
-- MAZ

/

CREATE OR REPLACE
FUNCTION MF_EC_PhType
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Phone Type
-- Demographics - Contacts tab

RETURN VARCHAR2 AS

v_PhType		varchar2(128);

	CURSOR cur_PhType IS
		SELECT
			tr.code_phone_number_type
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_PhType;
		FETCH cur_PhType INTO v_PhType;
	CLOSE cur_PhType;
			
RETURN v_PhType;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EC_Ph_ID
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Phone Number ID
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_ID		varchar2(128);

	CURSOR Cur_ID IS
		SELECT
			tr.telephone_record_id
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN Cur_ID;
		FETCH Cur_ID INTO v_ID;
	CLOSE Cur_ID;
			
RETURN v_ID;

END;
-- MAZ

/

CREATE OR REPLACE
FUNCTION MF_EC_Relation
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Relationship
-- Demographics - Contacts tab

RETURN VARCHAR2 AS

v_Relation		varchar2(128);

	CURSOR cur_Relation IS
		SELECT
			EPIC.ef_lookup_text('PERSONAL RELATIONSHIP', er.relationship_type, 'UC')
		FROM
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                  
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Relation;
		FETCH cur_Relation INTO v_Relation;
	CLOSE cur_Relation;
			
RETURN v_Relation;

END;
-- MAZ

/

CREATE OR REPLACE
FUNCTION MF_EC_Relation_code
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Relationship
-- Demographics - Contacts tab
-- 7-21-06 same as  MF_EC_Relation bu returns code

RETURN VARCHAR2 AS

v_Relation		varchar2(128);

	CURSOR cur_Relation IS
		SELECT
			er.relationship_type
		FROM
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                  
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Relation;
		FETCH cur_Relation INTO v_Relation;
	CLOSE cur_Relation;
			
RETURN v_Relation;

END;
-- MAZ
/

CREATE OR REPLACE
function mf_ef_get_Primary_Lang_code(
	p_entity_id	IN	EPIC.eh_language.Entity_ID%type
)
return EPIC.epic_lookups.lookup_code%type
is
	p_language	EPIC.epic_lookups.lookup_code%type;
	cursor cur_language is
		select	el.code_language
		from 	EPIC.eh_language el
		where 	el.entity_id = p_entity_id
		  and	el.order_of_preference = 1;
	p_code_language	cur_language%rowtype;
begin
	open cur_language;
	fetch cur_language into p_code_language;
	if cur_language%NOTFOUND then
		close cur_language;
		return '';
	end if;
	close cur_language;
	p_language := p_code_language.code_language;
	return p_language;
end;
/

CREATE OR REPLACE
function mf_ef_offender_race (
	p_entity_id				in		EPIC.eh_entity_person.entity_id%type)	
return EPIC.epic_col_types.varchar_255%type
is
        v_code_race             EPIC.eh_entity_race.code_race%type;

        cursor curRace is
                select code_race
                from EPIC.eh_entity_race
                where entity_id = p_entity_id;
begin
        open curRace;
        fetch curRace into v_code_race;
        if curRace%notfound then
                v_code_race := '  ';
        end if;

        close curRace;

        return v_code_race;
end;
/

CREATE OR REPLACE
function MF_EmpAdrcity_town_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address city/town with no end date
	 
RETURN VARCHAR2 AS

v_city_town		varchar2(128);

	CURSOR cur_city_town IS

		select
			a.city_town_locale
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_city_town;
		FETCH cur_city_town INTO v_city_town;
	CLOSE cur_city_town;
			
RETURN v_city_town;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrCountry_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address Country code with no end date
	 
RETURN VARCHAR2 AS

v_Country		varchar2(128);

	CURSOR cur_Country IS

		select
			a.code_country
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_Country;
		FETCH cur_Country INTO v_Country;
	CLOSE cur_Country;
			
RETURN v_Country;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrDwelling_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address Dwelling  with no end date
	 
RETURN VARCHAR2 AS

v_Dwelling		varchar2(128);

	CURSOR cur_Dwelling IS

		select
			a.Dwelling_name
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_Dwelling;
		FETCH cur_Dwelling INTO v_Dwelling;
	CLOSE cur_Dwelling;
			
RETURN v_Dwelling;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrFlatno_floor_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address Flatno_floor with no end date
	 
RETURN VARCHAR2 AS

v_Flatno_floor		varchar2(128);

	CURSOR cur_Flatno_floor IS

		select
			a.Flat_no_or_floor_level
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_Flatno_floor;
		FETCH cur_Flatno_floor INTO v_Flatno_floor;
	CLOSE cur_Flatno_floor;
			
RETURN v_Flatno_floor;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrPostal_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address Postal code with no end date
	 
RETURN VARCHAR2 AS

v_Postal		varchar2(128);

	CURSOR cur_Postal IS

		select
			a.Postal_code
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_Postal;
		FETCH cur_Postal INTO v_Postal;
	CLOSE cur_Postal;
			
RETURN v_Postal;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrstate_prov_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address state_province  with no end date
	 
RETURN VARCHAR2 AS

v_state_province		varchar2(128);

	CURSOR cur_state_province IS

		select
			a.state_province_region
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_state_province;
		FETCH cur_state_province INTO v_state_province;
	CLOSE cur_state_province;
			
RETURN v_state_province;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrstreetname_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address street name with no end date
	 
RETURN VARCHAR2 AS

v_streetname		varchar2(128);

	CURSOR cur_streetname IS

		select
			a.street_name
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_streetname;
		FETCH cur_streetname INTO v_streetname;
	CLOSE cur_streetname;
			
RETURN v_streetname;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdrstreetnmbr_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address street number with no end date
	 
RETURN VARCHAR2 AS

v_streetnumber		varchar2(128);

	CURSOR cur_streetnumber IS

		select
			a.street_number
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_streetnumber;
		FETCH cur_streetnumber INTO v_streetnumber;
	CLOSE cur_streetnumber;
			
RETURN v_streetnumber;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpAdr_ID_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
	 -- Returns most current Employer Address id with no end date
	 
RETURN VARCHAR2 AS

v_addressid		varchar2(128);

	CURSOR cur_addressid IS

		select
			a.address_id
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee,
			epic.eh_address a
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id   -- employer address
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
BEGIN
	OPEN cur_addressid;
		FETCH cur_addressid INTO v_addressid;
	CLOSE cur_addressid;
			
RETURN v_addressid;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_EmployerName  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%type)
		 
--Returns the employer record with no end date and most current date from

RETURN VARCHAR2 AS

v_employer		varchar2(128);

	CURSOR cur_employer IS
		select 
			eo.organization_name
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
	
  
BEGIN
	OPEN cur_employer;
		FETCH cur_employer INTO v_employer;
	CLOSE cur_employer;
			
RETURN v_employer;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_Employment_ID  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%type)
		 
--Returns the employer id for the employer record with no end date and most current date from

RETURN VARCHAR2 AS

v_empoyer_id		varchar2(128);

	CURSOR cur_employer_id IS
		select
			ee.employment_id
		from
			epic.eh_entity_employment_info ee
		where ee.entity_id = p_entity_id
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
	
  
BEGIN
	OPEN cur_employer_id;
		FETCH cur_employer_id INTO v_empoyer_id;
	CLOSE cur_employer_id;
			
RETURN v_empoyer_id;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpPhArea_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)  -- code_phone_number_type (ie WORK, PAGER...)
	 
	 -- Returns most current Employer area code with no end date
	 
RETURN VARCHAR2 AS

v_phAreacode		varchar2(128);

	CURSOR cur_phAreacode IS

		select
			tr.area_code
        from
    		epic.eh_entity_organization eo, epic.eh_entity_employment_info ee,
    		epic.eh_telephone_records tr
		where
		    ee.entity_id = p_entity_id
			and eo.entity_id = ee.organization_id
			and ee.organization_id = tr.entity_id
			and ee.end_date is null     -- end date of employment record
			and tr.code_phone_number_type = p_type --'WORK' etc...
		order by
			ee.from_date desc;
BEGIN
	OPEN cur_phAreacode;
		FETCH cur_phAreacode INTO v_phAreacode;
	CLOSE cur_phAreacode;
			
RETURN v_phAreacode;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpPhCountry_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)  -- code_phone_number_type (ie WORK, PAGER...)
	 
	 -- Returns most current Employer Phone Country code with no end date
	 
RETURN VARCHAR2 AS

v_phCountry		varchar2(128);

	CURSOR cur_phCountry IS

		select
			tr.code_country
        from
    		epic.eh_entity_organization eo, epic.eh_entity_employment_info ee,
    		epic.eh_telephone_records tr
		where
		    ee.entity_id = p_entity_id
			and eo.entity_id = ee.organization_id
			and ee.organization_id = tr.entity_id
			and ee.end_date is null     -- end date of employment record
			and tr.code_phone_number_type = p_type --'WORK' etc...
		order by
			ee.from_date desc;
BEGIN
	OPEN cur_phCountry;
		FETCH cur_phCountry INTO v_phCountry;
	CLOSE cur_phCountry;
			
RETURN v_phCountry;

END;
-- MAZ

/

CREATE OR REPLACE
function MF_EmpPhExt_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)  -- code_phone_number_type (ie WORK, PAGER...)
	 
	 -- Returns most current Employer phone extension with no end date
 
RETURN VARCHAR2 AS

v_PhExtcode		varchar2(128);

	CURSOR cur_PhExtcode IS

		select
			tr.extension
		from	
    		epic.eh_entity_organization eo, epic.eh_entity_employment_info ee,
    		epic.eh_telephone_records tr
		where
		    ee.entity_id = p_entity_id
			and eo.entity_id = ee.organization_id
			and ee.organization_id = tr.entity_id
			and ee.end_date is null     -- end date of employment record
			and tr.code_phone_number_type = p_type --'WORK' etc...
		order by
			ee.from_date desc;
BEGIN
	OPEN cur_PhExtcode;
		FETCH cur_PhExtcode INTO v_PhExtcode;
	CLOSE cur_PhExtcode;
			
RETURN v_PhExtcode;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpPhNmbr_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)  -- code_phone_number_type (ie WORK, PAGER...)
	 
	 -- Returns most current Employer phone Number base with no end date
 
RETURN VARCHAR2 AS

v_PhNmbrcode		varchar2(128);

	CURSOR cur_PhNmbrcode IS

		select
			tr.base_number
		from	
    		epic.eh_entity_organization eo, epic.eh_entity_employment_info ee,
    		epic.eh_telephone_records tr
		where
		    ee.entity_id = p_entity_id
			and eo.entity_id = ee.organization_id
			and ee.organization_id = tr.entity_id
			and ee.end_date is null     -- end date of employment record
			and tr.code_phone_number_type = p_type --'WORK' etc...
		order by
			ee.from_date desc;
BEGIN
	OPEN cur_PhNmbrcode;
		FETCH cur_PhNmbrcode INTO v_PhNmbrcode;
	CLOSE cur_PhNmbrcode;
			
RETURN v_PhNmbrcode;

END;
-- MAZ
/

CREATE OR REPLACE
function MF_EmpPh_ID_by_entid 
	(p_entity_id	in		EPIC.eh_address.entity_id%type,
	 p_type         in      EPIC.eh_address.address_type%type)  -- code_phone_number_type (ie WORK, PAGER...)
	 
	 -- Returns most current Employer phone ID with no end date
 
RETURN VARCHAR2 AS

v_PhNmbrid		varchar2(128);

	CURSOR cur_PhNmbrid IS

		select
			tr.telephone_record_id 
		from	
    		epic.eh_entity_organization eo, epic.eh_entity_employment_info ee,
    		epic.eh_telephone_records tr
		where
		    ee.entity_id = p_entity_id
			and eo.entity_id = ee.organization_id
			and ee.organization_id = tr.entity_id
			and ee.end_date is null     -- end date of employment record
			and tr.code_phone_number_type = p_type --'WORK' etc...
		order by
			ee.from_date desc;
BEGIN
	OPEN cur_PhNmbrid;
		FETCH cur_PhNmbrid INTO v_PhNmbrid;
	CLOSE cur_PhNmbrid;
			
RETURN v_PhNmbrid;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION mf_Entity_from_Booking
	(p_booking_id	in		EPIC.eh_active_booking.booking_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns entity_id from booking_id
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/18/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vEntity_ID EPIC.eh_active_booking.entity_id%type;
  
BEGIN          
	vEntity_ID := '';
    BEGIN
		select entity_id
		INTO vEntity_ID
		FROM   EPIC.eh_active_booking ab
		WHERE  ab.booking_id = p_booking_id;
 	EXCEPTION
    	when NO_DATA_FOUND then
			vEntity_ID := 'No value';
	END;    		
			
RETURN vEntity_ID;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION        mf_ExpngdCharge
	(p_charge_id	in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Determines if the charge class has been set to Seal/Expunge. Used for the Inmate History Public Report
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	01/03/07		Created
*/

RETURN VARCHAR2 AS
  CURSOR curExp IS 
		SELECT  'Y'	
		FROM  EPIC.eh_charge c
		WHERE c.charge_id = p_charge_id
			  and c.statute_class = 'EXP';
          
vExp	varchar2(1);

BEGIN
	OPEN curExp;
  		FETCH curExp INTO vExp;
  	CLOSE curExp;

RETURN NVL(vExp,'N');
  	 	
END;       
/

CREATE OR REPLACE
FUNCTION        mf_eyecolorleft_code
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns the code for an inmate's left eye color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	07/20/06			Created
*/		

RETURN VARCHAR2 AS

v_leye					EPIC.eh_entity_person.code_eye_color_left%type;

	CURSOR cur_leye IS
		SELECT
			p.code_eye_color_left
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_leye;
		FETCH cur_leye INTO v_leye;
			IF (cur_leye%notfound or v_leye = '_NOSP' or v_leye is null)THEN
				v_leye := 'XXX';
			END IF;	
	 CLOSE cur_leye;	
			
RETURN v_leye;
END;
/

CREATE OR REPLACE
FUNCTION        mf_eyecolorright_code
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)    
	
/*
Purpose: Returns the code for an inmate's right eye color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	07/20/06			Created
*/

RETURN VARCHAR2 AS

v_reye					EPIC.eh_entity_person.code_eye_color_right%type;

	CURSOR cur_reye IS
		SELECT
			p.code_eye_color_right
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_reye;
		FETCH cur_reye INTO v_reye;
			IF (cur_reye%notfound or v_reye = '_NOSP' or v_reye is null) THEN
				v_reye := 'XXX';
			END IF;	
	 CLOSE cur_reye;	
			
RETURN v_reye;
END;
/

CREATE OR REPLACE
FUNCTION        mf_final_release_date 
	(p_booking_id	IN		EPIC.eh_booking.booking_id%TYPE)
	
/*
Purpose: Returns the Final Release Date from the Release Dates tab in Offendertrak. Uses an EPIC package

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	09/25/06		Created
*/	

RETURN 	EPIC.epic_col_types.varchar_255%TYPE

IS

BEGIN
	RETURN EPIC.epp_booking_dates.final_release_date(p_booking_id);
END;
/

CREATE OR REPLACE
FUNCTION mf_GAValue_byItmIdName
	(p_item_id		in		    EPIC.eh_generic_attribute.item_id%type,
	 p_attribute_name   in      EPIC.eh_generic_attribute.attribute_name%type)
	
--Returns the latest(action_time) attribute value from eh_generic_attribute table per item id,attribute name

	
RETURN VARCHAR2 AS

v_attrValue					EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_attrName IS
		SELECT
			ga.attribute_value
		FROM
		 	EPIC.eh_generic_attribute ga
		WHERE
			ga.item_id = p_item_id and				
		    ga.attribute_name = p_attribute_name  
		ORDER BY ga.action_time desc;    
  
BEGIN
	OPEN cur_attrName;
		FETCH cur_attrName INTO v_attrValue;
		CLOSE cur_attrName;
			
RETURN v_attrValue;

END;

/

CREATE OR REPLACE
FUNCTION mf_GA_Bail
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
	 
/*	
	Purpose:		Returns the value of the input generic attribute attached to bail condition

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_generic_attribute ga
			
	WHERE	b.bail_condition_id = bc.bail_condition_id 
			and bc.bail_condition_id = ga.item_id
			and bc.charge_id = p_charge_id
			and ga.attribute_name = p_ga_type;
     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MF_GA_Charge
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
/*	
	Purpose:		Returns the value of the input generic attribute attached to charge

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value 
  	
	FROM 	EPIC.eh_generic_attribute ga,
			EPIC.eh_charge c
			
	WHERE	c.charge_id = p_charge_id
			and c.charge_id = ga.item_id
			and ga.attribute_name = p_ga_type;     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

  	RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION mf_GA_Sent
	 (p_sentence_id IN 	EPIC.eh_sentence.sentence_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
	 
/*	
	Purpose:		Returns the value of the input generic attribute attached to sentence

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value
  	
	FROM 	EPIC.eh_sentence s,
			EPIC.eh_generic_attribute ga
			
	WHERE	s.sentence_id = p_sentence_id
			and s.sentence_id = ga.item_id
			and ga.attribute_name = p_ga_type;
     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION        mf_hair_code
	(p_entity_id		IN		EPIC.eh_entity_person.entity_id%TYPE)
RETURN EPIC.epic_col_types.varchar_255%TYPE
IS
/*	
	Purpose:		Return the code for an offender's hair color--to be used in the pre-booking system	

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve	 	07/20/06		Created 
*/  

v_Hair					EPIC.epic_col_types.varchar_255%type;

CURSOR cur_Hair IS
	SELECT	p.code_hair_color
	
	FROM	EPIC.eh_person_snapshot p
	
	WHERE	p.entity_id = p_entity_id
		
	ORDER BY date_snapshot desc;
	
BEGIN
	OPEN cur_Hair;
	FETCH cur_Hair INTO v_Hair;
	CLOSE cur_Hair;

RETURN v_Hair;
END;
/

CREATE OR REPLACE
function mf_highest_education (p_Entity_ID	in	EPIC.eh_entity_hi_education.entity_id%type)
       return	EPIC.eh_entity_hi_education.code_highest_grade_completed%type
as
--
-- given an ENTITY_ID,  returns the highest education level
--
cursor cur_hi_education is
       	select he.code_highest_grade_completed
     	from EPIC.eh_entity_hi_education he
     	where he.entity_id = p_Entity_ID;

v_result	EPIC.eh_operators_license.state%type;
begin
	open cur_hi_education;
	fetch cur_hi_education into v_result;
	if cur_hi_education%NOTFOUND then
		v_result := null;
	end if;
	close cur_hi_education;
	return v_result;
end;
--MAZ same as ef_get_highest_education except removed he.last_year



/

CREATE OR REPLACE
FUNCTION        mf_HoldCourt
	(	p_HoldID	in	EPIC.eh_booking_holds.hold_id%type)

/*	
	Purpose:		Returns the value of the 'HOLD COURT' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD COURT'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
FUNCTION        mf_HoldInfo
	(p_HoldID	in	EPIC.eh_booking_holds.hold_id%TYPE)
	                          
/*	
	Purpose:		Returns the value of the 'Hold Info' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	
	
RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD INFO'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
FUNCTION mf_Homeless
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
 /*	
	Purpose:		Returns a Y/N flag if an inmate is homeless

	Author:			R. Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
	    			R. Stuve		07/31/06	Created
	    			R. Stuve		01/09/07	Added cur_street to check for people coded as 'HOMELESS'
	    										via Offendertrak address field (per JO/Booking business process)
*/  

RETURN VARCHAR2
IS

v_flag		varchar2(1);
v_street	varchar2(1);

CURSOR cur_flag IS
	SELECT DECODE(i.homeless_flag, 'Y','Y','N')
	FROM EPIC.eh_person_identity i	
	WHERE i.entity_id =  p_entity_id;
 
CURSOR cur_street IS
	SELECT 'Y'
	FROM EPIC.eh_address a
	WHERE street_name like '%HOMELESS%'
		  and a.entity_id = p_entity_id;
 
BEGIN
	OPEN cur_flag;
		FETCH cur_flag INTO v_flag;
	CLOSE cur_flag;
	
BEGIN
	OPEN cur_street;
		FETCH cur_street INTO v_street;
	CLOSE cur_street;
	
IF v_street IS NULL 
	THEN RETURN v_flag;
END IF;
IF v_street IS NOT NULL 
	THEN RETURN v_street; 
END IF;

END; 
END;
/

CREATE OR REPLACE
FUNCTION        mf_JuvAudit
	(p_entity_id		in	EPIC.eh_entity_person.entity_id%type,
	 p_StartDate		in	EPIC.eh_charge.action_time%type) 

/*
Purpose: Returns the juvenile status at the selected time  

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	01/24/07		Created
*/
	 
RETURN VARCHAR2 AS                                 

	v_max_date		varchar2(20);

	CURSOR curJuv IS
		SELECT	decode(ep.juvenile_flag, null, 'N', ep.juvenile_flag)
		
		FROM 	EPICAUDIT.eh_entity_person ep
		
		WHERE 	ep.entity_id = p_entity_id
				and EPIC.ef_epic_date_to_date(ep.action_time) <= v_max_date
				and not exists
					(select 1 
					from EPICAUDIT.eh_entity_person ep2
					where ep2.entity_id = ep.entity_id
					and EPIC.ef_epic_date_to_date(ep2.action_time) < v_max_date
					and EPIC.ef_epic_date_to_date(ep2.action_time) > EPIC.ef_epic_date_to_date(ep.action_time));

				
vJuv	EPIC.eh_entity_person.juvenile_flag%type;

BEGIN                

	v_max_date := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_StartDate));
	OPEN curJuv;
		FETCH curJuv INTO vJuv;
	CLOSE curJuv;
	
RETURN vJuv;
	
END;
/

CREATE OR REPLACE
FUNCTION        mf_location_id
	(pLocationName		IN		EPIC.EPIC_LOCATIONS.location_name%TYPE)
	
/*	
	Purpose:		Returns the location_id based on the location name
	
	Called By:		Macomb.Per-booking
						
	Author:			Joe McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					------------ -------------	------------------------------------------
					J. McBratnie 03/26/06		Created  
					
*/	

RETURN VARCHAR2
IS  

vLocationId		EPIC.EPIC_LOCATIONS.location_id%TYPE;

	CURSOR cur IS
		SELECT location_id 
		  FROM EPIC.EPIC_LOCATIONS 
		 WHERE location_name = pLocationName --'HC04' 
		   AND eff_to_date IS NULL;

			
BEGIN	
	OPEN cur;
		FETCH cur into vLocationId;
	CLOSE cur;

RETURN vLocationId;

END;
/

CREATE OR REPLACE
FUNCTION mf_mug_with_Path
	(p_photo_id		in		EPIC.eh_entity_photo.Photo_ID%type)   
	
--Returns all of an inmate's alias names (one line, seperated by a '\')
	
RETURN  EPIC.epic_col_types.VARCHAR_2000%type
IS   

    CURSOR curPhotoPath IS
	    SELECT 'ftp://' || ev.volumeserver ||'/'|| ev.volumepath || '/' || ei.imageref as mugpath
    	FROM	epic.Epicvolume ev,
				epic.Epicimage ei,
				epic.Eh_entity_default_photo ph,
				epic.eh_entity_photo ep
		WHERE
				ei.imageref = ph.photo_id(+)
	  	  AND   ev.volumeid = ei.volumeid
		  AND   ei.imageref = p_photo_id
		  AND   ep.photo_id = ei.imageref;

noPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;
vPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;

BEGIN  
	vPhotoLink := null;
	noPhotoLink := 'ftp://PHOTOFILE/PRODUCTION/NODATE/noimage.jpg';

	OPEN curPhotoPath;
	FETCH curPhotoPath INTO vPhotoLink;
	CLOSE curPhotoPath;                
	
	IF vPhotoLink IS NULL THEN
		vPhotoLink := noPhotoLink;
	END IF;
	
	RETURN vPhotoLink;
END;	

--JDM
/

CREATE OR REPLACE
FUNCTION        mf_NextCourtDate
		 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns an inmate's next (soonest) court date for the selected booking

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	9/26/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	decode(EPIC.ef_epic_date_to_date(ca.appearance_date), '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YYYY'))
            --dates listed as 'TBN' in Offendertrak interface are stored in database as '2200010100:00:00+000'
  	
	FROM 	EPIC.eh_booking b,
			EPIC.eh_case c,
			EPIC.eh_court_appearance ca
			
	WHERE	b.booking_id = c.booking_id
			and c.case_id = ca.owner_id
			and b.booking_id = p_booking_id
			and EPIC.ef_epic_date_to_date(ca.appearance_date) >= sysdate
	
	ORDER BY ca.appearance_date;
     
     
vCourtDate	varchar2(20);


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

RETURN 	vCourtDate;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION        mf_NextCourtDate_Charge
		 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns an inmate's next (soonest) court date for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	11/21/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	decode(EPIC.ef_epic_date_to_date(ca.appearance_date), '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YYYY'))
            --dates listed as 'TBN' in Offendertrak interface are stored in database as '2200010100:00:00+000'
  	
	FROM 	EPIC.eh_charge ch,
			EPIC.eh_case_charge cc,
			EPIC.eh_case c,
			EPIC.eh_court_appearance ca
			
	WHERE	ch.charge_id = cc.charge_id
			and cc.case_id = c.case_id
			and c.case_id = ca.owner_id
			and ch.charge_id = p_charge_id
			and EPIC.ef_epic_date_to_date(ca.appearance_date) >= sysdate
	
	ORDER BY ca.appearance_date;
     
     
vCourtDate	varchar2(20);


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

RETURN 	vCourtDate;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION        mf_NonPblcCharge
	(p_charge_id	in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Determines if the charge generic attribute has been set to Conviction Set Aside Non Public. Used for the Inmate History Public Report
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	01/03/07		Created
*/

RETURN VARCHAR2 AS
  CURSOR curNonP IS 
		SELECT 'Y'
		FROM EPIC.eh_generic_attribute g,
		     EPIC.eh_charge c
		WHERE g.attribute_name = 'CONVICTION SET ASIDE NON PUBLIC'
			and g.attribute_value = 'Y'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;
        
vNonP	 varchar2(1);

BEGIN
  	OPEN curNonP;
  		FETCH curNonP INTO vNonP;
  	CLOSE curNonP;

RETURN NVL(vNonP,'N');
  	 	
END; 
/

CREATE OR REPLACE
FUNCTION MF_Occupation  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%type)
		 
--Returns the occupation with no end date and most current date from

RETURN VARCHAR2 AS

v_occupation		varchar2(128);

	CURSOR cur_occupation IS
		select 
			 EPIC.ef_lookup_text('OCCUPATION', ee.code_occupation_type, 'UC')
		from
			epic.eh_entity_organization eo,
			epic.eh_entity_employment_info ee
		where ee.entity_id = p_entity_id
			and ee.organization_id = eo.entity_id
			and ee.from_date is not null
			and ee.end_date is null
		order by ee.from_date desc;
	            
BEGIN
	OPEN cur_occupation;
		FETCH cur_occupation INTO v_occupation;
	CLOSE cur_occupation;
			
RETURN v_occupation;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION        mf_occupation_code  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%TYPE)
		 
/*	
	Purpose:		Used for the Pre-Booking system: returns the occupation code for the
					input inmate with no end-date

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve	  08/7/06		Created	
*/

RETURN VARCHAR2 AS

v_occupation		varchar2(64);

CURSOR cur_occupation IS
	SELECT 	code_occupation_type
	
	FROM 	EPIC.eh_entity_employment_info		 

	WHERE 	end_date is null
			and employment_id = MACOMB.mf_pb_Employment_ID(p_entity_id);
	            
BEGIN
	OPEN cur_occupation;
		FETCH cur_occupation INTO v_occupation;
	CLOSE cur_occupation;
			
RETURN v_occupation;

END;
/

CREATE OR REPLACE
FUNCTION mf_offender_from_entity
	(p_entity_id	in		EPIC.EH_OFFENDER_IDS.ENTITY_ID%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns entity_id from booking_id
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/18/06		Created 
					
					
*/       


RETURN VARCHAR2 AS

vOffender_ID EPIC.EH_OFFENDER_IDS.offender_id%type;
  
BEGIN          
	vOffender_ID := '';
    BEGIN
		select Offender_ID
		INTO vOffender_ID
		FROM   EPIC.EH_OFFENDER_IDS
		WHERE  entity_id = p_entity_id;
 	EXCEPTION
    	when NO_DATA_FOUND then
			vOffender_ID := 'No value';
	END;    		
			
RETURN vOffender_ID;
END;
--JDM
/

CREATE OR REPLACE
FUNCTION        mf_pb_BirthCity
	(p_entity_id		in		EPIC.eh_person_identity.entity_id%type) 

/*
Purpose: Returns the city of an inmates birth from the generic attribute field 
		 (this information is captures in eh_person_identity, but the MCSO uses the generic attribute field for this info)
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	11/08/06		Created
*/	

RETURN VARCHAR2
IS

v_city		EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_city IS
		SELECT	ga.attribute_value
		FROM	EPIC.eh_generic_attribute ga,
				EPIC.eh_person_identity i	
		WHERE  	i.entity_id =  p_entity_id
				and i.code_name_type = 'MAS'
				and i.identity_id = ga.item_id
				and attribute_name = 'BIRTH CITY';
  
BEGIN
	OPEN cur_city;
		FETCH cur_city INTO v_city; 
	CLOSE cur_city;
			
RETURN v_city;

END; 
/

CREATE OR REPLACE
FUNCTION        mf_pb_build
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the code for an inmate's build
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	02/15/07		Created
*/	
	
RETURN VARCHAR2 AS

v_build		EPIC.eh_person_snapshot.code_build%type;

	CURSOR cur_build IS
		SELECT
			s.code_build
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_build;
		FETCH cur_build INTO v_build;
		CLOSE cur_build;
			
RETURN v_build;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_CanReadYN
	 (p_entity_id IN EPIC.eh_entity_work_skills.entity_id%TYPE) 

/*	
	Purpose:		Returns a 'Y' if the inmate can read English (as a second language) (Demographics: Address tab)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/08/06		Created
*/  	 
	 
RETURN VARCHAR2 AS
  CURSOR curRead IS   	
  	SELECT 	'Y'

    FROM 	EPIC.eh_entity_work_skills

	WHERE	entity_id = p_entity_id
	        and code_skill in ('READ/WRITE','READS ONLY') ;	
     
    
v_read EPIC.eh_entity_work_skills.code_skill%type;


BEGIN
	OPEN curRead;
  		FETCH curRead INTO v_read;
  	CLOSE curRead;
	RETURN NVL(v_read, 'N');
  		
END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_CanWriteYN
	 (p_entity_id IN EPIC.eh_entity_work_skills.entity_id%TYPE) 

/*	
	Purpose:		Returns a 'Y' if the inmate can write English (as a second language) (Demographics: Address tab)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/08/06		Created 
					R. Stuve	11/08/06		Added 'READ/WRITE' to WHERE clause
*/  		 
	 
RETURN VARCHAR2 AS
  CURSOR curRead IS   	
  	SELECT 	'Y'

    FROM 	EPIC.eh_entity_work_skills

	WHERE	entity_id = p_entity_id
	        and code_skill in ('WRITES ONLY','WRITE NAME', 'READ/WRITE') ;	
     
    
v_read EPIC.eh_entity_work_skills.code_skill%type;


BEGIN
	OPEN curRead;
  		FETCH curRead INTO v_read;
  	CLOSE curRead;
  	
RETURN NVL(v_read, 'N');
  		
END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_Area
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact phone area code (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_Area		varchar2(3);

CURSOR cur_Area IS
	SELECT 	tr.area_code
	
	FROM  	EPIC.eh_entity_relationship er,
		 	EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
 
BEGIN
	OPEN cur_Area;
		FETCH cur_Area INTO v_Area;
	CLOSE cur_Area;
			
RETURN v_Area;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_Country
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current country code (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/

RETURN VARCHAR2 AS

v_Country		varchar2(128);

CURSOR cur_Country IS
	SELECT	tr.code_country
	
	FROM  	EPIC.eh_entity_relationship er,
		 	EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_Country;
		FETCH cur_Country INTO v_Country;
	CLOSE cur_Country;
			
RETURN v_Country;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_Extension
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact phone extension (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_Ext		varchar2(64);

CURSOR cur_Ext IS
	SELECT	tr.extension

	FROM  	EPIC.eh_entity_relationship er,
		 	EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_Ext;
		FETCH cur_Ext INTO v_Ext;
	CLOSE cur_Ext;
			
RETURN v_Ext;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_PhNumber
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current country code (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/

RETURN VARCHAR2 AS

v_Number		varchar2(128);

CURSOR cur_Number IS
	SELECT	tr.Base_number
	
	FROM  	EPIC.eh_entity_relationship er,
		 	EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_Number;
		FETCH cur_Number INTO v_Number;
	CLOSE cur_Number;
			
RETURN v_Number;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_PhType
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)

/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact phone type (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_PhType		varchar2(64);

CURSOR cur_PhType IS
	SELECT  tr.code_phone_number_type
		
	FROM  	EPIC.eh_entity_relationship er,
		 	EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_PhType;
		FETCH cur_PhType INTO v_PhType;
	CLOSE cur_PhType;
			
RETURN v_PhType;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_Ph_ID
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current phone ID (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/

RETURN VARCHAR2 AS

v_ID		varchar2(128);

CURSOR Cur_ID IS
	SELECT	tr.telephone_record_id
		
	FROM  	EPIC.eh_entity_relationship er,
			EPIC.eh_telephone_records tr
		 	
	WHERE	er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
                 
 	ORDER by decode(primary_flag,'Y',1,2) asc, tr.date_from desc;
  
BEGIN
	OPEN Cur_ID;
		FETCH Cur_ID INTO v_ID;
	CLOSE Cur_ID;
			
RETURN v_ID;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EC_Relation_code
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)

/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact relationship type (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_Relation		varchar2(128);

	CURSOR cur_Relation IS
		SELECT	er.relationship_type
		
		FROM 	EPIC.eh_entity_relationship er 
				
		WHERE   er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    	and er.entity_id = p_entity_id
		    	                  
       	ORDER by er.action_time desc;
  
BEGIN
	OPEN cur_Relation;
		FETCH cur_Relation INTO v_Relation;
	CLOSE cur_Relation;
			
RETURN v_Relation;

END;
/

CREATE OR REPLACE
FUNCTION        MF_PB_EmgCntc
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)

/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_Contact		varchar2(128);

CURSOR cur_Contact IS
	SELECT	EPIC.ef_get_personororgname(er.entity_related_to)
	
	FROM 	EPIC.eh_entity_relationship er
		
	WHERE   er.entity_related_to = MACOMB.mf_pb_emgcntc_id(p_entity_id)
		    and er.entity_id = p_entity_id 
		                    
 	ORDER BY er.action_time desc;
  
BEGIN
	OPEN cur_Contact;
		FETCH cur_Contact INTO v_Contact;
	CLOSE cur_Contact;
			
RETURN v_Contact;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_emgcntc_id
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)

/*	
	Purpose:		Used in Pre-Booking to return an inmates's most current contact id (CONTACTS tab in Demographics)
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	08/07/06		Created
*/  

RETURN VARCHAR2 AS

v_Contact		varchar2(64);

CURSOR cur_Contact IS
	SELECT	er.entity_related_to
	
	FROM 	EPIC.eh_entity_relationship er,
			EPIC.epic_lookups el
		WHERE    
		    er.entity_id = p_entity_id
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP' 
		    and er.related_as_role = 'CNTCT'                 
       	ORDER by er.action_time desc, el.display_order asc;
  
BEGIN
	OPEN cur_Contact;
		FETCH cur_Contact INTO v_Contact;
	CLOSE cur_Contact;
			
RETURN v_Contact;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpAdrDwelling 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address dwelling text for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_Dwelling		varchar2(128);

CURSOR cur_Dwelling IS
	SELECT	dwelling_name

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN cur_Dwelling;
		FETCH cur_Dwelling INTO v_Dwelling;
	CLOSE cur_Dwelling;
			
RETURN v_Dwelling;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpAdr_ID 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
		 
 /*	
	Purpose:		Pre Booking: Returns the employer address ID for the inmate's employment record

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
RETURN VARCHAR2 AS

v_addressid		varchar2(128);

CURSOR cur_addressid IS
	SELECT	a.address_id

	FROM	EPIC.eh_entity_organization eo,
			EPIC.eh_entity_employment_info ee,
			EPIC.eh_address a
			
	WHERE	ee.employment_id = mf_pb_Employment_ID(p_entity_id)
			and ee.organization_id = eo.entity_id
			and eo.entity_id = a.entity_id
			and (a.date_to is null or EPIC.ef_epic_date_to_date(a.date_to) > sysdate)
	ORDER BY a.action_time desc;
			
BEGIN
	OPEN cur_addressid;
		FETCH cur_addressid INTO v_addressid;
	CLOSE cur_addressid;
			
RETURN v_addressid;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpCity
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address city name for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	city_town_locale

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpCountry
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address country code for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	code_country

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpFlatFloor 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address flat/floor text for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_floor		varchar2(8);

CURSOR curFloor IS
	SELECT	flat_no_or_floor_level

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curFloor;
		FETCH curFloor INTO v_floor;
	CLOSE curFloor;
			
RETURN v_floor;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmployerName  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%type)
		 
 /*	
	Purpose:		Pre Booking: Returns the employer name for the inmate's employment record

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
RETURN VARCHAR2 AS

v_employer		varchar2(255);

CURSOR cur_employer IS
	SELECT	eo.organization_name

	FROM	EPIC.eh_entity_organization eo,
			EPIC.eh_entity_employment_info ee
			
	WHERE 	ee.employment_id = MACOMB.mf_pb_Employment_ID(p_entity_id)
			and ee.organization_id = eo.entity_id;	
  
BEGIN
	OPEN cur_employer;
		FETCH cur_employer INTO v_employer;
	CLOSE cur_employer;
			
RETURN v_employer;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_Employment_ID  
(p_entity_id	in		EPIC.eh_entity_employment_info.entity_id%type)

 /*	
	Purpose:		Pre Booking: Returns the employment id (unique PK) for the inmate's employment record

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/  		 

RETURN VARCHAR2 AS

v_empoyer_id		varchar2(128);

CURSOR cur_employer_id IS
	SELECT	employment_id

	FROM	EPIC.eh_entity_employment_info
	
	WHERE	entity_id = p_entity_id
			and end_date is null

	ORDER BY action_time desc;
	
  
BEGIN
	OPEN cur_employer_id;
		FETCH cur_employer_id INTO v_empoyer_id;
	CLOSE cur_employer_id;
			
RETURN v_empoyer_id;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPh_Area 
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type) 
	 
/*	
	Purpose:		Pre Booking: Returns the employer telephone area code for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
 
RETURN VARCHAR2 AS

v_Ph		varchar2(128);

CURSOR cur_Ph IS
	SELECT	area_code
	
	FROM	EPIC.eh_telephone_records tr
			
	WHERE	telephone_record_id = MACOMB.mf_pb_EmpPh_ID(p_entity_id, 'WORK');
			
BEGIN
	OPEN cur_Ph;
		FETCH cur_Ph INTO v_Ph;
	CLOSE cur_Ph;
			
RETURN v_Ph;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPh_Cnt 
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type) 
	 
/*	
	Purpose:		Pre Booking: Returns the employer telephone country code for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
 
RETURN VARCHAR2 AS

v_Ph		varchar2(128);

CURSOR cur_Ph IS
	SELECT	code_country

	FROM	EPIC.eh_telephone_records tr
			
	WHERE	telephone_record_id = MACOMB.mf_pb_EmpPh_ID(p_entity_id, 'WORK');
			
BEGIN
	OPEN cur_Ph;
		FETCH cur_Ph INTO v_Ph;
	CLOSE cur_Ph;
			
RETURN v_Ph;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPh_Ext
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type) 
	 
/*	
	Purpose:		Pre Booking: Returns the employer telephone extension for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
 
RETURN VARCHAR2 AS

v_Ph		varchar2(128);

CURSOR cur_Ph IS
	SELECT	extension
	
	FROM	EPIC.eh_telephone_records tr
			
	WHERE	telephone_record_id = MACOMB.mf_pb_EmpPh_ID(p_entity_id, 'WORK');
			
BEGIN
	OPEN cur_Ph;
		FETCH cur_Ph INTO v_Ph;
	CLOSE cur_Ph;
			
RETURN v_Ph;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPh_ID 
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type) 
	 
/*	
	Purpose:		Pre Booking: Returns the employer telephone id for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
 
RETURN VARCHAR2 AS

v_Ph		varchar2(128);

CURSOR cur_Ph IS
	SELECT	tr.telephone_record_id

	FROM	EPIC.eh_entity_organization eo,
			EPIC.eh_entity_employment_info ee,
			EPIC.eh_telephone_records tr
			
	WHERE	ee.employment_id = mf_pb_Employment_ID(p_entity_id)
			and ee.organization_id = eo.entity_id
			and eo.entity_id = tr.entity_id
			and (tr.date_to is null or EPIC.ef_epic_date_to_date(tr.date_to) > sysdate)
	ORDER BY tr.action_time desc;
			
BEGIN
	OPEN cur_Ph;
		FETCH cur_Ph INTO v_Ph;
	CLOSE cur_Ph;
			
RETURN v_Ph;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPh_Nbr
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type) 
	 
/*	
	Purpose:		Pre Booking: Returns the employer telephone base number for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
 
RETURN VARCHAR2 AS

v_Ph		varchar2(128);

CURSOR cur_Ph IS
	SELECT	base_number
	
	FROM	EPIC.eh_telephone_records tr
			
	WHERE	telephone_record_id = MACOMB.mf_pb_EmpPh_ID(p_entity_id, 'WORK');
			
BEGIN
	OPEN cur_Ph;
		FETCH cur_Ph INTO v_Ph;
	CLOSE cur_Ph;
			
RETURN v_Ph;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpPostal
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address postal code for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	postal_code

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpState
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address state name for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	state_province_region

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpStreetName
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address street name for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	street_name

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_EmpStreetNum 
	(p_entity_id	in		EPIC.eh_address.entity_id%type)
	 
/*	
	Purpose:		Pre Booking: Returns the employer address street number for the selected inmate

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		08/09/06		Created	
*/
	 
RETURN VARCHAR2 AS

v_add		varchar2(20);

CURSOR curAdd IS
	SELECT	street_number

	FROM	EPIC.eh_address
	
	WHERE	address_id = MACOMB.mf_pb_EmpAdr_ID(p_entity_id);
	 
BEGIN
	OPEN curAdd;
		FETCH curAdd INTO v_add;
	CLOSE curAdd;
			
RETURN v_add;

END;
/

CREATE OR REPLACE
FUNCTION mf_pb_height 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 
	
/*	
	Purpose:		Pre Booking: Returns the inmates height in a 3-digit format used by the Sheriff

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					R. Stuve		09/18/06		Created	
*/
	
RETURN VARCHAR2 AS

v_height 	EPIC.eh_entity_height.height%type;

CURSOR cur_height IS
	SELECT	to_char(trunc(height/12))|| decode(mod(height,12),
												0,'00',
												1,'01',
												2,'02',
												3,'03',
												4,'04',
												5,'05',
												6,'06',
												7,'07',
												8,'08',
												9,'09',
												mod(height,12))										
	FROM	EPIC.eh_entity_height
	
	WHERE   entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_height;
		FETCH cur_height INTO v_height;
	CLOSE cur_height;
			
RETURN v_height;

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_keepsep_verify
	 (p_arrest_id 		IN 		EPIC.eh_entity.entity_id%TYPE,
	  p_location_id 	IN  	VARCHAR2) 

	 
 /*	
	Purpose:		Pre-Booking: Verifies keep separates are not violated: returns 'T' if housing
					selection does not violate k/s, or 'F' if it does violate k/s
					
	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					R. Stuve		06/19/06		Created 
*/ 
RETURN VARCHAR2 AS
	CURSOR curKeepSep IS
		SELECT	location_id
		FROM	MACOMB.mt_pb_keep_separate
		WHERE	(p_arrest_id = origin_entity_id
				or p_arrest_id = separate_entity_id)
				and location_id = p_location_id; 
				
v_location		MACOMB.mt_pb_keep_separate.location_id%TYPE;
v_KeepSep		varchar2(1);

BEGIN
	OPEN curKeepSep;
	FETCH curKeepSep INTO v_location;
	CLOSE curKeepSep;

	IF v_location = p_location_id
	THEN v_KeepSep := 'F';
	ELSE v_KeepSep := 'T';
	END IF;
	
	RETURN v_KeepSep;
	
END;	
/

CREATE OR REPLACE
FUNCTION        mf_pb_loginok
	 (	vUserID     IN     EPIC.epic_user_names.user_id%type)

/*
Purpose:		Returns a 'Y' value if a user has login rights

Author:			Joe McBratnie

Change Log:		Changed By  	Date Modified	Change Made
				------------	-------------	------------------------------------------
				J. McBratnie	02/14/07     	Created					
*/
RETURN VARCHAR2 AS 
	CURSOR curAdmin IS     	
		SELECT 	'Y'
		FROM 	EPIC.epic_user_names n,
    			EPIC.epic_user_roles r
		WHERE	n.user_int_id = r.user_int_id
				and EPIC.ef_epic_date_to_date(r.date_end) >= sysdate
				and EPIC.ef_epic_date_to_date(r.date_start) <= sysdate
				and UPPER(r.role_code) in('BOOKING','JAIL OFFICE','31')
	  			and n.user_id = UPPER(vUserID); 
	  			
vAdmin	varchar2(1); 

BEGIN
	OPEN curAdmin;
		FETCH curAdmin INTO vAdmin;
	CLOSE curAdmin;

	RETURN NVL (vAdmin,'N');

END;
/

CREATE OR REPLACE
FUNCTION        mf_pb_religion
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
return EPIC.epic_col_types.varchar_255%type
is


	cursor cur_religion is
		select
			code_religion,
			start_date
		from
			EPIC.eh_entity_religion
		where
			entity_id = p_entity_id
			and (end_date is null or end_date >= EPIC.epicdate(sysdate))
		order by start_date desc
		;
v_cur_religion 	cur_religion%rowtype;
begin
	open cur_religion;
	fetch cur_religion into v_cur_religion;
	if cur_religion%found then
		close cur_religion;
		return v_cur_religion.code_religion;
	end if;
	close cur_religion;
	return '';
end;
/

CREATE OR REPLACE
FUNCTION        mf_pb_security
	 (	vUserID     IN     EPIC.epic_user_names.user_id%type)

/*
Purpose:		Returns a 'Y' value if a user has administrative rights

Author:			Rachel Stuve

Change Log:		Changed By  	Date Modified	Change Made
				------------	-------------	------------------------------------------
				R. Stuve	    01/04/07     	Created					
*/
RETURN VARCHAR2 AS 
	CURSOR curAdmin IS     	
		SELECT 	'Y'
		FROM 	EPIC.epic_user_names n,
    			EPIC.epic_user_roles r
		WHERE	n.user_int_id = r.user_int_id
				and EPIC.ef_epic_date_to_date(r.date_end) >= sysdate
				and EPIC.ef_epic_date_to_date(r.date_start) <= sysdate
				and r.role_code in('COMMAND LEVEL 2','COMMAND LEVEL 1','26')
	  			and n.user_id = UPPER(vUserID); 
	  			
vAdmin	varchar2(1); 

BEGIN
	OPEN curAdmin;
		FETCH curAdmin INTO vAdmin;
	CLOSE curAdmin;

	RETURN NVL (vAdmin,'N');

END;
/

CREATE OR REPLACE
FUNCTION MF_PhArea
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type)  
	 
--Returns the inmate's most current Phone Area code based on type
-- Demographics - Phone # based on phone type

RETURN VARCHAR2 AS

v_Area		varchar2(128);

	CURSOR cur_Area IS
		SELECT
			tr.Area_code
		FROM
		 	epic.eh_telephone_records tr
		WHERE    
		    tr.entity_id = p_entity_id
		    and tr.code_phone_number_type = p_type
            and tr.date_to is null       -- end date of phone record
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_Area;
		FETCH cur_Area INTO v_Area;
	CLOSE cur_Area;
			
RETURN v_Area;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_PhCountry
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type)     
	 
--Returns the inmate's most current Phone Country code based on type
-- Demographics - Phone # based on phone type
--tr.date_from, tr.date_to, tr.code_country, tr.area_code,
--	tr.base_number, tr.extension, tr.code_phone_number_type

RETURN VARCHAR2 AS

v_country		varchar2(128);

	CURSOR cur_country IS
		SELECT
			tr.code_country
		FROM
		 	epic.eh_telephone_records tr
		WHERE    
		    tr.entity_id = p_entity_id
		    and tr.code_phone_number_type = p_type
            and tr.date_to is null       -- end date of phone record
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_country;
		FETCH cur_country INTO v_country;
	CLOSE cur_country;
			
RETURN v_country;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_PhExtension
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type)  
	 
--Returns the inmate's most current Phone Extension code based on type
-- Demographics - Phone # based on phone type

RETURN VARCHAR2 AS

v_extension		varchar2(128);

	CURSOR cur_extension IS
		SELECT
			tr.extension
		FROM
		 	epic.eh_telephone_records tr
		WHERE    
		    tr.entity_id = p_entity_id
		    and tr.code_phone_number_type = p_type
            and tr.date_to is null       -- end date of phone record
        ORDER by decode(primary_flag, 'Y', 1, 2) asc, tr.date_from desc;
  
BEGIN
	OPEN cur_extension;
		FETCH cur_extension INTO v_extension;
	CLOSE cur_extension;
			
RETURN v_extension;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MF_PhNumber
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type)  
	 
--Returns the inmate's most current Phone Number code based on type
-- Demographics - Phone # based on phone type

RETURN VARCHAR2 AS

v_Number		varchar2(128);

	CURSOR cur_Number IS
		SELECT
			tr.Base_number
		FROM
		 	epic.eh_telephone_records tr
		WHERE    
		    tr.entity_id = p_entity_id
		    and tr.code_phone_number_type = p_type
            and tr.date_to is null       -- end date of phone record
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc;
  
BEGIN
	OPEN cur_Number;
		FETCH cur_Number INTO v_Number;
	CLOSE cur_Number;
			
RETURN v_Number;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION mf_PhotoShow
	(	p_booking_id	IN	EPIC.eh_active_booking.booking_id%TYPE,
	    p_image_path    IN  VARCHAR2,
	    p_noimage_path  IN  VARCHAR2 )


RETURN VARCHAR2 AS 
	CURSOR cur IS
		SELECT 'OK TO SHOW'
		FROM 	epic.eh_active_booking ab,
              	epic.eh_charge charge,
              	epic.eh_generic_attribute ga
		WHERE 	ab.booking_id = charge.booking_id
		  AND 	charge.charge_id = ga.item_id
		  AND 	ga.attribute_value NOT IN ('01','04','14','16','1','4')
		  AND 	ab.booking_id = p_booking_id
		  -- active charges only
		  AND 	charge_state <> '6';


vDisplay	 VARCHAR2(10);
vOutputimage VARCHAR2(255);
BEGIN
	OPEN cur;
		FETCH cur INTO vDisplay;
	CLOSE cur;
	IF vDisplay = 'OK TO SHOW' THEN
		vOutputimage := p_image_path;
	ELSE
		vOutputimage := p_noimage_path;
	END IF;					

RETURN vOutputimage;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mf_photo_id
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)   
	
--Returns all of an inmate's alias names (one line, seperated by a '\')
	
RETURN  EPIC.eh_entity_photo.photo_id%type
IS   
noPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;

	CURSOR curDefault IS
		SELECT photo_id
		FROM epic.Eh_entity_default_photo ep
		WHERE p_entity_id = ep.entity_id;

	CURSOR curAllPhotos IS
		SELECT photo_id
		FROM epic.eh_entity_photo ep
		WHERE p_entity_id = ep.entity_id
		  AND epic.ef_epic_date_to_date(date_taken) = (	SELECT MAX(epic.ef_epic_date_to_date(date_taken))
														FROM epic.eh_entity_photo ep
														WHERE p_entity_id = ep.entity_id);

vPhotoID   epic.eh_entity_photo.photo_id%type;
														
BEGIN
	OPEN curDefault;
	FETCH curDefault INTO vPhotoID;
	IF curDefault%NOTFOUND THEN
		OPEN curAllPhotos;	
		FETCH curAllPhotos INTO vPhotoID;
		CLOSE curAllPhotos;
	END IF;
	CLOSE curDefault;     
	RETURN vPhotoID;														
END;
/

CREATE OR REPLACE
FUNCTION MF_Ph_ID
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type,
	 p_type         in      EPIC.eh_telephone_records.code_phone_number_type%type)  
	 
--Returns the inmate's most current Phone ID  code based on type
-- Demographics - telephone_record_id of Phone # based on phone type

RETURN VARCHAR2 AS

v_ID		varchar2(128);

	CURSOR Cur_ID IS
		SELECT
			tr.telephone_record_id 
		FROM
		 	epic.eh_telephone_records tr
		WHERE    
		    tr.entity_id = p_entity_id
		    and tr.code_phone_number_type = p_type
            and tr.date_to is null       -- end date of phone record
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc;
  
BEGIN
	OPEN Cur_ID;
		FETCH Cur_ID INTO v_ID;
	CLOSE Cur_ID;
			
RETURN v_ID;

END;
-- MAZ
/

CREATE OR REPLACE
function mf_primary_dlicno_expire (
	p_entity_id			in		EPIC.eh_operators_license.entity_id%type)
return 	EPIC.eh_operators_license.EXPIRATION_DATE%type    -- return expiration of primary driver license
as

cursor cur_dlicnoexp is
	select ol.expiration_date
	from EPIC.eh_operators_license ol
	where ol.entity_id = p_entity_id
	and ol.primary_dl = 'Y';

v_result	EPIC.eh_operators_license.expiration_date%type;

begin
	open cur_dlicnoexp;
	fetch cur_dlicnoexp into v_result;
	if cur_dlicnoexp%NOTFOUND then
		v_result := null;
	end if;
	close cur_dlicnoexp;
	return EPIC.ef_epic_date_to_date(v_result);
end;
-- MAZ 
/

CREATE OR REPLACE
function mf_primary_dlicno_ID (
	p_entity_id			in		EPIC.eh_operators_license.entity_id%type)
return 	EPIC.eh_operators_license.operator_license_id%type    -- return ID of primary driver license
as

cursor cur_dlicnoid is
	select ol.operator_license_id
	from EPIC.eh_operators_license ol
	where ol.entity_id = p_entity_id
	and ol.primary_dl = 'Y';

v_result	EPIC.eh_operators_license.operator_license_id%type;

begin
	open cur_dlicnoid;
	fetch cur_dlicnoid into v_result;
	if cur_dlicnoid%NOTFOUND then
		v_result := null;
	end if;
	close cur_dlicnoid;
	return v_result;
end;
-- MAZ 
/

CREATE OR REPLACE
function mf_primary_dlicno_state (
	p_entity_id			in		EPIC.eh_operators_license.entity_id%type)
return 	EPIC.eh_operators_license.STATE%type    -- return state of primary driver license
as

cursor cur_dlicnost is
	select ol.state
	from EPIC.eh_operators_license ol
	where ol.entity_id = p_entity_id
	and ol.primary_dl = 'Y';
	

v_result	EPIC.eh_operators_license.state%type;

begin
	open cur_dlicnost;
	fetch cur_dlicnost into v_result;
	if cur_dlicnost%NOTFOUND then
		v_result := null;
	end if;
	close cur_dlicnost;
	return v_result;
end;
-- MAZ 
/

CREATE OR REPLACE
FUNCTION mf_releasedate
	(p_booking_id		in		EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the overall latest release date for the given booking


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	09/22/06		Created
*/	
	
RETURN VARCHAR2
IS		v_release		EPIC.eh_release.release_type%type;

	CURSOR cur_release IS
		SELECT	r.scheduled_release
		
		FROM	EPIC.eh_release r,
				EPIC.eh_booking b
		
		WHERE 	b.booking_id = r.booking_id
				and b.booking_id = p_booking_id;
  
BEGIN
	OPEN cur_release;
		FETCH cur_release INTO v_release;
	CLOSE cur_release;
			
	RETURN v_release;
END;
/

CREATE OR REPLACE
FUNCTION mf_SentActTm
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the action time when a charge action (eh_charge.charge_state) was changed to 'Convict and 
		 Sentence' in Offendertrak

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/11/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curTime IS 
  	SELECT 	c.action_time 
  	
	FROM 	EPICAUDIT.eh_charge c
			
	WHERE	c.charge_state = '4'
			and c.charge_id =  p_charge_id;
        
vTime	EPICAUDIT.eh_charge.action_time%TYPE;


BEGIN
	OPEN curTime;
  		FETCH curTime INTO vTime;
  	CLOSE curTime;
	
RETURN vTime;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION        mf_SentEndDate
	(p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the sentence end date (if available) for the specified charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	9/26/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	s.sentence_end_date
  	
	FROM 	EPIC.eh_sentence s,
			EPIC.eh_charge c
			
	WHERE	s.sentence_id = c.sentence_id
			and c.charge_id = p_charge_id;
     
vSent	EPIC.eh_sentence.sentence_end_date%TYPE;


BEGIN
  	OPEN curSent;
  		FETCH curSent INTO vSent;
  	CLOSE curSent;

  	RETURN vSent;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION mf_SentRelAttr
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns a '*' flag if an inmate has any value (i.e. YES or NO) in the sentence attrib's: 
		 Work Seek, Work Release, or Educational Release

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curAtt IS 
  	SELECT 	'*' 
  	
	FROM 	EPIC.eh_sentence s,
			EPIC.eh_generic_attribute g,
			EPIC.eh_charge c
			
	WHERE	c.charge_id = p_charge_id
			and c.sentence_id = s.sentence_id
			and s.sentence_id = g.item_id  
			and (attribute_name = 'WORK SEEK' 
				or attribute_name = 'WORK RELEASE GRANTED' 
				or attribute_name ='EDUCATIONAL RELEASE');
        
vAtt	varchar2(1);


BEGIN
	OPEN curAtt;
  		FETCH curAtt INTO vAtt;
  	CLOSE curAtt;
	
RETURN NVL (vAtt, null);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION mf_sent_overlap
	(p_booking_id		in		EPIC.eh_booking.booking_id%type,
	 p_charge_id        in      EPIC.eh_charge.charge_id%type,
	 p_StartDate		in		EPIC.eh_booking.start_date%type,
	 p_EndDate			in		EPIC.eh_booking.start_date%type)

return varchar2
	
--Returns 'TRUE' if per booking, charge id, sentence start and end, a sentence exist with a start-end dates that overlap else 'FALSE'
--used for Lori's anticipated reimb rpt- indicator that days need to be adjusted
is

	v_Overlap			varchar2(10);
	v_Chrg_Overlap		varchar2(16);
	
	CURSOR cur_Overlap IS
		select ch1.charge_id as charge_id    --start date overlaps
  		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id  --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_StartDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_StartDate)

		UNION
		select ch1.charge_id as charge_id    -- end date overlaps
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_EndDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_EndDate)--;
			
        UNION
	
		select ch1.charge_id as charge_id     -- start and end date w/in given range (overlap)
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
 		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) >= EPIC.ef_epic_date_to_date(p_StartDate)  
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) <= EPIC.ef_epic_date_to_date(p_EndDate);

						
begin
v_Overlap := 'FALSE';  -- init overlap as false
   
	open cur_Overlap;
	fetch cur_Overlap into v_Chrg_Overlap;  
		if cur_Overlap%found then              -- if any records are found then overlap is TRUE
			v_Overlap := 'TRUE';
		end if;
	close cur_Overlap;
	return v_Overlap;
end;
/

CREATE OR REPLACE
FUNCTION mf_sent_overlap_2
	(p_booking_id		in		EPIC.eh_booking.booking_id%type,
	 p_StartDate		in		EPIC.eh_booking.start_date%type,
	 p_EndDate			in		EPIC.eh_booking.start_date%type)  
return varchar2
	
--Returns 'TRUE' if per booking(all sentences), a sentence start and end dates overlap else 'FALSE'
--used for Lori's anticipated reimb rpt- indicator that days need to be adjusted
is

	v_Overlap			varchar2(10);
	v_S1		        EPIC.eh_booking.start_date%type;   -- s1 start date
	v_E1				EPIC.eh_booking.start_date%type;   -- s1 end date
	v_S2		        EPIC.eh_booking.start_date%type;   -- s2 start date
	v_E2				EPIC.eh_booking.start_date%type;   -- s2 end date
	v_StartDate         EPIC.eh_booking.start_date%type;
	v_EndDate			EPIC.eh_booking.start_date%type;
	
	CURSOR cur_Overlap IS
		select distinct 
		  	 	EPIC.ef_epic_date_to_date(s1.sentence_start_date) as s1_start,
	 			EPIC.ef_epic_date_to_date(s1.sentence_end_date) as s1_end, 
			    EPIC.ef_epic_date_to_date(s2.sentence_start_date) as s2_start,
			    EPIC.ef_epic_date_to_date(s2.sentence_end_date) as s2_end
		from
			EPIC.eh_sentence s1,
			EPIC.eh_sentence s2,
			EPIC.eh_charge ch1,
			EPIC.eh_charge ch2,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id  --bk.booking_id
			and ch2.booking_id = ch1.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch2.sentence_id = s2.sentence_id
			and ch1.charge_id <> ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(s2.sentence_start_date)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(s2.sentence_start_date)
		UNION
		select distinct 
		   	EPIC.ef_epic_date_to_date(s1.sentence_start_date) as s1_start,
	 		EPIC.ef_epic_date_to_date(s1.sentence_end_date) as s1_end, 
			EPIC.ef_epic_date_to_date(s2.sentence_start_date) as s2_start,
			EPIC.ef_epic_date_to_date(s2.sentence_end_date) as s2_end
		from
			EPIC.eh_sentence s1,
			EPIC.eh_sentence s2,
			EPIC.eh_charge ch1,
			EPIC.eh_charge ch2,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch2.booking_id = ch1.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch2.sentence_id = s2.sentence_id
			and ch1.charge_id <> ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(s2.sentence_end_date)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(s2.sentence_end_date);
				
begin
v_Overlap := 'FALSE';   --init 
v_StartDate := EPIC.ef_epic_date_to_date(p_StartDate);
v_EndDate := EPIC.ef_epic_date_to_date(p_EndDate); 
  
	open cur_Overlap; 
	fetch cur_Overlap into v_S1, v_E1, v_S2, v_E2; 
	While cur_Overlap%FOUND and v_Overlap = 'FALSE'   -- if sentence start end date = one of the overlap dates then overlap is true
	  Loop
	    Begin
	    If (v_StartDate = v_S1 and v_EndDate = v_E1) 
	    	or (v_StartDate = v_S2 and v_EndDate = v_E2) then 
	        	begin
	    		v_Overlap := 'TRUE';
	    		end; 
	    	end if;	
	    End;	
	  fetch cur_Overlap into v_S1, v_E1, v_S2, v_E2; 
	  end Loop;
	close cur_Overlap;
	return v_Overlap;
end;

	   				
	
/

CREATE OR REPLACE
FUNCTION        mf_SntEdcRl
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'EDUCATIONAL RELEASE' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'EDUCATIONAL RELEASE'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION        mf_SntFine
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MAY BE RLSD IF FINE PD' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'MAY BE RLSD IF FINE PD'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION        mf_SntMiscInfo
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MISC SENTENCE INFO' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'MISC SENTENCE INFO'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION        mf_SntWrkRlsG
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WORK RELEASE GRANTED' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WORK RELEASE GRANTED'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION        mf_SntWrkSk
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WORK SEEK' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WORK SEEK'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION mf_statute_id
 (p_statute_number	in		EPIC.EPIC_STATUTES.statute_id%type) 

/*
Purpose: Returns the statute id for the given statute number 


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M Zak    	6-8-06			Created
*/	 
 
RETURN EPIC.epic_statutes.statute_id%type AS

	CURSOR curStat IS
		SELECT
			es.statute_id
		FROM
			EPIC.epic_statutes es
		WHERE
			es.statute_number = p_statute_number;
	                                      
	vStatute     EPIC.epic_statutes.statute_id%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;	
	
--RETURN NVL(vStatute,'0G2DFNP030HDSMIG');               0-0000 = UNKNOWN pacc code and 0G2DFNP030HDSMIG is the statute id
	
END;
/

CREATE OR REPLACE
FUNCTION mf_USCitizen
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
 /*	
	Purpose:		Returns a Y/N flag if an inmate is a US citzen

	Author:			R. Stuve
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
	    			R. Stuve		07/31/06	Created
*/  

RETURN VARCHAR2
IS

v_citizen	EPIC.eh_citizenship.country_code%type;

	CURSOR cur_citizenship IS
		SELECT
			DECODE(c.country_code, 'US','Y','N')
		FROM
		 	EPIC.eh_citizenship c	
		WHERE    
			c.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_citizenship;
		FETCH cur_citizenship INTO v_citizen;
	CLOSE cur_citizenship;
			
RETURN v_citizen;

END;
/

CREATE OR REPLACE
FUNCTION mf_visiting_restrictions
	 (p_entity_id	in 	epic.eh_active_booking.entity_id%TYPE) 
	 
--Returns the case number of the selected charge
	 
RETURN VARCHAR2 AS
  CURSOR currestrictions IS 
	select 	max(epic.ef_epic_date_to_date(r.end_date)) as resdate
	from  	epic.EH_ENTITY_RESTRICTION r
	where epic.ef_epic_date_to_date(r.end_date) > sysdate
	  and r.entity_id = p_entity_id	;
	     
     
vrestiction_date	 epic.EH_ENTITY_RESTRICTION.end_date%TYPE;


BEGIN
  	OPEN curRestrictions;
  		FETCH curRestrictions INTO vrestiction_date;
  	CLOSE curRestrictions;

  	RETURN vrestiction_date;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION        mf_WknRlsTm
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WEEKENDER RELEASE TIME' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WEEKENDER RELEASE TIME'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
function mf__max_restrict_end_dt (
	p_entity_id				in		EPIC.eh_entity_person.entity_id%type)
return EPIC.epic_col_types.varchar_255%type
is

v_end_date varchar2(20);

BEGIN
		select
			max(r.end_date)
			into v_end_date
		from
			EPIC.eh_entity_restriction r
		where
			r.entity_id = p_entity_id
		 	and EPIC.ef_epic_date_to_date(r.end_date) > sysdate;
	
	RETURN v_end_date;
END;
/

CREATE OR REPLACE
PACKAGE        mpk_avgdailypop
IS

/*	
Purpose:		Used by the Jail Administration to return the Average Daily Population for the 
				selected time period. This package is called by procedure MACOMB.mpr_avgdailypop to run 
				as a Crystal report through Offendertrak

Author:			Rachel Stuve

Change Log:		Changed By	Date Modified	Change Made
		 		----------	-------------	------------------------------------------
				R. Stuve	02/13/07		Created   
*/


--procedure to get the total population for the entire date range
PROCEDURE Calculate 
	(p_StartDate	in		EPIC.eh_housing_assignments.action_time%type,
	 p_EndDate		in		EPIC.eh_housing_assignments.action_time%type,
	 p_Cur 			in OUT 	EPIC.epp_generic_ref_cursor.ref_cursor);
END;
/

CREATE OR REPLACE
PACKAGE BODY        mpk_avgdailypop
IS

/*	
Purpose:		Used by the Jail Administration to return the Average Daily Population for the 
				selected time period. 
				
Author:			Rachel Stuve

Change Log:		Changed By	Date Modified	Change Made
		 		----------	-------------	------------------------------------------
				R. Stuve	02/09/07		Created   
				J. McBratnie 02/13/07		Added error trapping/logging
*/

cs_mod				constant varchar2(255) := 'DA';
gv_debug			boolean := false; --set to true to turn on logging

v_writ				EPIC.epic_locations.location_id%type;

v_dailytotal		number;
v_dailygender		number;  
v_dailyjuv			number; 
v_days				number; 
v_tcount			number;
v_mcount			number;
v_fcount			number;
v_jcount			number; 
v_total_count		number;
v_male_count		number;
v_female_count		number;
v_juvenile_count	number; 
v_BeginDate			date;
v_EndDate			date;
p_as_of_date		date;
v_total_average		number;
v_male_average		number;
v_female_average	number;
v_juvenile_average	number;

--Error trapping/logging procedures
PROCEDURE log_error (p_code IN integer, p_message IN varchar2)
	IS
		BEGIN
			EPIC.ep_log_info (cs_mod/*p_module_id*/,'E'/*p_logtype*/,-1/*p_action_by,*/,'(' || p_code || ') ' || p_message/*p_text*/);
			RETURN;
		END;

PROCEDURE logit (p_text	IN	varchar2)
	IS
		BEGIN
			IF gv_debug THEN
				EPIC.ep_log_info (cs_mod,'D',-1,p_text);
			END IF;
			RETURN;
		END;
          

--get the location_id for 'WRIT' (inmates on WRIT are not counted in the daily count)
FUNCTION procWrit
	RETURN EPIC.epic_locations.location_id%type
	IS
		BEGIN
			SELECT	location_id
			INTO	v_writ
			FROM	EPIC.epic_locations
			WHERE 	location_name = 'WRIT';
			RETURN v_writ;
		END; 

-----------------------------------Procedures to return the counts for each day----------------------------------
FUNCTION funcTotal	(p_date	in	date)
	RETURN number 
	IS
		BEGIN
			SELECT	count(distinct entity_id)
			INTO	v_dailytotal
			FROM	EPICAUDIT.eh_housing_assignments ha
			WHERE	EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
					and ha.muster_display_flag = 'Y'
					and ha.action_type = 'U'
					and ha.temporary_location_flag = 'N'
					and ha.location_id != v_writ
					and not exists (
						--Exclude housing changes
						SELECT	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE	ha2.entity_id = ha.entity_id
								and ha2.muster_display_flag = 'Y'
								and (ha2.action_time > ha.action_time
								-- Exclude changes where action types 'U' and 'D' are done at the same time
								or (ha2.action_type <> ha.action_type
									and ha2.action_time = ha.action_time
									and ha2.location_id = ha.location_id))
								and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date
									)
					 and not exists (
						--Exclude updates of any kind
						SELECT 	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE 	ha2.entity_id = ha.entity_id
								and ha2.location_id = ha.location_id
								and ha2.action_time > ha.action_time
								and EPIC.ef_epic_date_to_date(ha2.action_time) < p_date
									)
					and not exists (
						--Exclude inmates that were merged
						SELECT	entity_id
						FROM	EPICAUDIT.eh_entity et
						WHERE	et.entity_id = ha.entity_id
								and EPIC.ef_epic_date_to_date(et.action_time) <= p_date
								and et.action_type = 'D'
									) ;  
			RETURN NVL(v_dailytotal,0);
		END;                       

FUNCTION funcGender	(p_date	in	date, p_gender in varchar2) 
	RETURN number
	IS
		BEGIN 
			SELECT	count(distinct entity_id)
			INTO 	v_dailygender
			FROM	EPICAUDIT.eh_housing_assignments ha
			WHERE	EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
					and ha.muster_display_flag = 'Y'
					and ha.action_type = 'U'
					and ha.temporary_location_flag = 'N'
					and ha.location_id != v_writ
					and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = p_gender
					and not exists (
						--Exclude housing changes
						SELECT	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE	ha2.entity_id = ha.entity_id
								and ha2.muster_display_flag = 'Y'
								and (ha2.action_time > ha.action_time
								-- Exclude changes where action types 'U' and 'D' are done at the same time
								or (ha2.action_type <> ha.action_type
									and ha2.action_time = ha.action_time
									and ha2.location_id = ha.location_id))
								and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date
									)
					 and not exists (
						--Exclude updates of any kind
						SELECT 	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE 	ha2.entity_id = ha.entity_id
								and ha2.location_id = ha.location_id
								and ha2.action_time > ha.action_time
								and EPIC.ef_epic_date_to_date(ha2.action_time) < p_date
									)
					and not exists (
						--Exclude inmates that were merged
						SELECT	entity_id
						FROM	EPICAUDIT.eh_entity et
						WHERE	et.entity_id = ha.entity_id
								and EPIC.ef_epic_date_to_date(et.action_time) <= p_date
								and et.action_type = 'D'
									) ; 
				RETURN NVL(v_dailygender,0);
			END;


FUNCTION funcJuv	(p_date	in date)
	RETURN number
	IS
		BEGIN 
			SELECT	count(distinct entity_id)
			INTO	v_dailyjuv
			FROM	EPICAUDIT.eh_housing_assignments ha
			WHERE	EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
					and ha.muster_display_flag = 'Y'
					and ha.action_type = 'U'
					and ha.temporary_location_flag = 'N'
					and ha.location_id != v_writ
					and MACOMB.mf_JuvAudit(ha.entity_id, EPIC.epicdate(p_date)) = 'Y' 
					and not exists (
						--Exclude housing changes
						SELECT	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE	ha2.entity_id = ha.entity_id
								and ha2.muster_display_flag = 'Y'
								and (ha2.action_time > ha.action_time
								-- Exclude changes where action types 'U' and 'D' are done at the same time
								or (ha2.action_type <> ha.action_type
									and ha2.action_time = ha.action_time
									and ha2.location_id = ha.location_id))
								and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date
									)
					 and not exists (
						--Exclude updates of any kind
						SELECT 	entity_id
						FROM	EPICAUDIT.eh_housing_assignments ha2
						WHERE 	ha2.entity_id = ha.entity_id
								and ha2.location_id = ha.location_id
								and ha2.action_time > ha.action_time
								and EPIC.ef_epic_date_to_date(ha2.action_time) < p_date
									)
					and not exists (
						--Exclude inmates that were merged
						SELECT	entity_id
						FROM	EPICAUDIT.eh_entity et
						WHERE	et.entity_id = ha.entity_id
								and EPIC.ef_epic_date_to_date(et.action_time) <= p_date
								and et.action_type = 'D'
									) ;
			RETURN NVL(v_dailyjuv,0); 
		END; 
                     
---------------------calculate actual averages-----------------------------------	
PROCEDURE Calculate (p_StartDate		in		EPIC.eh_housing_assignments.action_time%type,
					 p_EndDate			in		EPIC.eh_housing_assignments.action_time%type,
	 				 p_Cur 				in out 	EPIC.epp_generic_ref_cursor.ref_cursor)   
IS                                                      

BEGIN
v_BeginDate			:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)) + 2/24;
v_EndDate			:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_EndDate)) + 2/24;
v_tcount 			:= 0; 
v_mcount 			:= 0;
v_fcount 			:= 0;
v_jcount 			:= 0;
v_total_count 		:= 0;
v_male_count 		:= 0;
v_female_count 		:= 0;
v_juvenile_count	:= 0;
v_days 				:= 0;
p_as_of_date 		:= v_BeginDate;
v_juvenile_average  := 0;
v_female_average    := 0;
v_male_average      := 0;
v_total_average     := 0;

--Run function to find the epic ID for WRIT location
v_writ := procWrit;

--initial entry in log
logit('adequate tcount   Current    Total');	
	
	WHILE p_as_of_date <= v_EndDate
		LOOP   
			logit('adequate date ' ||p_as_of_date );
		
			v_tcount := funcTotal(p_as_of_date);
			v_mcount := funcGender(p_as_of_date,'M');
			v_fcount := funcGender(p_as_of_date,'F');
			v_jcount := funcJuv(p_as_of_date);
			
    		v_total_count := v_total_count + v_tcount; 
    		v_male_count := v_male_count + v_mcount;
    		v_female_count := v_female_count + v_fcount;
		    v_juvenile_count := v_juvenile_count + v_jcount;   
			
			logit('adequate tcount' ||v_tcount || ' '|| v_total_count);
			logit('adequate male' ||v_mcount || ' '||v_male_count );
			logit('adequate female' ||v_fcount || ' '||v_female_count );
			logit('adequate juv' ||v_jcount || ' '||v_juvenile_count );
				
			p_as_of_date := p_as_of_date + 1;
			v_days := v_days + 1;
		END LOOP; 
		
v_total_average := v_total_count / v_days;  
v_male_average := v_male_count / v_days;
v_female_average := v_female_count / v_days;
v_juvenile_average := v_juvenile_count / v_days;  

OPEN p_Cur FOR
	SELECT 	v_total_average as TotalAvg,
			round(v_male_average,0) as MaleAvg, 
			round(v_female_average,0) as FemaleAvg, 
			round(v_juvenile_average,0) as JuvAvg, 
			round(v_days,0) as vDays,
			to_char(v_BeginDate, 'MM/DD/YY') as BeginDate,
			to_char(v_EndDate, 'MM/DD/YY') as EndDate 
	FROM 	dual;
	
logit('adequate average total' ||v_total_average);
logit('adequate average male' ||v_male_average);
logit('adequate average female' ||v_female_average);
logit('adequate average juv' ||v_juvenile_average);

--end of procedure Calculate
END; 

--package end
END; 
/

CREATE OR REPLACE
package        MPK_JIL is
/*	Purpose:		Macomb JIL internet - This is the process to make the triggering of who gets copied and not.
	Process:		Register the request, signal the action in a trigger, create a job to run (that moves the 
					data from OT to JIL.  All procedures are included in this package to handle alert, signal, 
					and create job functionality.
					
					The selected data has its own procedures and functions that are more global in nature.
	                
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	08/15/06		Created 

*/ 	
	--
	--	8/15/2006 J McBratnie
	--
	--		This package contains the JIL interface procedures
	--		which can be called from various triggering events
	--
	--  
	cs_JIL_module			constant varchar2(255) := 'JIL';
	cs_JIL_ALIAS_alert		constant varchar2(255) := 'MCMB$JIL_ALIAS';
	cs_JIL_INMATE_alert		constant varchar2(255) := 'MCMB$JIL_INMATE';
	cs_JIL_CHARGE_alert		constant varchar2(255) := 'MCMB$JIL_CHARGE';
	cs_JIL_BOOKING_alert	constant varchar2(255) := 'MCMB$JIL_BOOKING';
	cs_JIL_SENTENCE_alert	constant varchar2(255) := 'MCMB$JIL_SENTENCE';
	cs_JIL_VISITOR_alert	constant varchar2(255) := 'MCMB$JIL_VISITOR';
	cs_JIL_BANNED_alert		constant varchar2(255) := 'MCMB$JIL_BANNED';
	cs_JIL_RELEASE_alert	constant varchar2(255) := 'MCMB$JIL_RELEASE';
	cs_JIL_BOOK_alert   	constant varchar2(255) := 'MCMB$JIL_INSERT'; -- do not use!!!
	cs_JIL_PHOTO_alert	    constant varchar2(255) := 'MCMB$JIL_PHOTO';

	--termination alerts
	cs_stop_alert			constant varchar2(255) := 'IOMS$TERMINATE';
	cs_stop_JIL_alert		constant varchar2(255) := 'JIL$TERMINATE';


	-----------------------------------
	--PUBLIC PROCEDURES and FUNCTIONS--
	-----------------------------------
	--
	--		procedure to initialize the "config.inf" file for the TCP/IP file transfer process
	--
	procedure init;
	--

	--
	--		procedure to register the alerts we care about
	--
	procedure register;
	--

	--
	--		procedure to remove the alerts we care about
	--
	procedure unregister;
	--                         
	
	--
	--		procedure to deal with waitany loop, termination and maintaining the mt_jil_alertmessage table
	--
	procedure waitany;                                                                                    
	--

	--
	--		procedure to Register and waitany loop. This will replace the need to call register and waitany procedures
	--
	procedure regwaitany;
	--

	procedure signal(                                                                                    
		p_alert	   				in		varchar2,
		p_message				in		epic.epic_col_types.varchar_255%type);
	
    -- See package body for internal procedures and functions for record processing
end MPK_JIL;
/

CREATE OR REPLACE
package body        MPK_JIL is
/*	Purpose:		Macomb JIL internet - This is the process to make the triggering of who gets copied and not.
	Process:		Register the request, signal the action in a trigger, create a job to run (that moves the 
					data from OT to JIL.  All procedures are included in this package to handle alert, signal, 
					and create job functionality.
					
					The selected data has its own procedures and functions that are more global in nature.
	                
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	08/15/06		Created 

*/ 	


	--
	cs_mod							constant varchar2(255) := 'JIL';
	--
	--
	--		server type = Unix (true) or NT (false)
	--
	--
	c_server_unix					constant boolean := FALSE;
	cs_debug						constant epic.epic_configuration.config_key%type := 'ENABLE LOGGING';
	cs_enabled						constant epic.epic_configuration.config_key%type := 'ENABLED';
	--
	--		last configuration values - write new config file when they change
	--
	gv_debug						boolean := false;
	--
	gv_retry_period					integer;
	gv_enabled						char(1);
	--
	--		current sequence number for file names
	--
	gv_seq_num						integer := 1;
	--
	--		standard character definitions used for Ascribe interface
	--
	cCR								constant char(1) := chr(13);
	cLF								constant char(1) := chr(10);
	cCRLF							constant char(2) := chr(13) || chr(10);
	cSep							constant char(1) := '|';
	cBell							constant char(1) := chr(07);
	--
	--		end of line constants for unix/nt
	--
	cUnix_EOLN						constant char(1) := chr(10);
	cNT_EOLN						constant char(2) := chr(13) || chr(10);

--------------------------------------------
--LOCAL Support PROCEDURES and FUNCTIONS  --
--------------------------------------------

	--
	--	internal procedure to log errors
	--
	procedure log_error (
		p_code				in		integer,
		p_message			in		varchar2)
	is
	begin
		epic.ep_log_info (
			cs_mod,						--	p_module_id,
			'E',						--	p_logtype,
			-1,	--	p_action_by,
			'(' || p_code || ') ' || p_message);	--	p_text);
		return;
	end;

	--
	--	internal procedure for debug logging
	--
	procedure ConvertDate(
		p_epic_date			in		epic.eh_entity_person.action_time%type,
		p_string_date		in out  varchar2,
		p_string_time		in out  varchar2)
	is
		p_oracle_date		date;
	begin
		if not p_epic_date is null then
			p_oracle_date := epic.ef_epic_date_to_date(p_epic_date);
			p_string_date := to_char(p_oracle_date,'yyyymmdd');
			p_string_time := to_char(p_oracle_date,'hh24MI');
		end if;

		return;
	end;

	--
	--	internal procedure for stoing the message
	--
	procedure logit (
		p_text				in		varchar2)
	is
	begin
		if gv_debug then
			epic.ep_log_info (
				cs_mod,
				'D',
				-1,
				p_text);
		end if;
		return;
	end;

	--
	--	internal procedure for handleing nul data in file write
	--
	function nonnull(
		p_text				in		varchar2
		) return varchar2
	is
		v_return varchar2(128);
	begin
		if p_text is null then
			v_return := ' ';
		else
			v_return := p_text;
		end if;

		return v_return;
	end;                                                       
	
	--
	--
	--
	--	procedure to get the current system configuration parameters
	--
	--
	procedure get_configuration (
		p_path				in out	epic.epic_configuration.config_value%type,
		p_file_name			in out  epic.epic_configuration.config_value%type,
		p_synch_file_name	in out  epic.epic_configuration.config_value%type,
		p_sending_agency_id	in out	epic.epic_configuration.config_value%type,
		p_adult_age			in out	integer,
		p_suppress_ssn		in out  boolean,
		p_enabled			in out	char)
	is
		v_debug					epic.epic_configuration.config_value%type;
		v_file_name				epic.epic_configuration.config_value%type;
		v_synch_file_name		epic.epic_configuration.config_value%type;
		v_path					epic.epic_configuration.config_value%type;
		v_sending_agency_id		epic.epic_configuration.config_value%type;
		v_adult_age_value		epic.epic_configuration.config_value%type;
		v_adult_age				integer;
		v_suppress_ssn			epic.epic_configuration.config_value%type;
		v_enabled_value			epic.epic_configuration.config_value%type;
		v_enabled				char(1);
		p_result				epic.epic_col_types.number_9%type;
		p_result_msg			epic.epic_col_types.varchar_255%type;
	begin
		--
		--	get debug flag value
		--
		epic.ep_get_configuration_value(cs_JIL_module, cs_debug, v_debug, 'N', p_result, p_result_msg);
		if upper(substr(v_debug, 1, 1)) = 'Y' then
			gv_debug := true;
		else
			gv_debug := false;
		end if;
		--
		--	get interface enabled flag
		--
		epic.ep_get_configuration_value(cs_JIL_module, cs_enabled, v_enabled_value, 'Y', p_result, p_result_msg);
		v_enabled := upper(substr(v_enabled_value, 1, 1));
		if v_enabled not in ('Y','N') then
			raise_application_error(-20001, 'JIL Enabled value must be "Y" or "N" [' || v_enabled_value || ']');
		end if;
		--
		--	return values
		--
		p_enabled := v_enabled;
	end;


--------------------------------------------------
--LOCAL PROCEDURES and FUNCTIONS to do the work --
--------------------------------------------------
	--
	--	Procedure update JIL with ALIAS records for a given inmate
	--
	procedure jil_alias(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- copy the data from OT to JIL
		logit('JIL alias'); 
		INSERT INTO MT_JIL_ALIAS@Link_IVR
		(ENTITY_ID_FK, OFFENDER_ID, ALIAS_ID_PK, LASTNAME, FIRSTNAME, MIDDLENAME, SUFFIXNAME, DOB, CODE_NAME_TYPE)
		(select 	id.entity_id AS entity_id,
			        id.OFFENDER_ID AS offender_id,
					pi.identity_id AS alias_id,
					pi.name_family AS lastname,
					pi.name_first  AS firstname,
					pi.name_other  AS middlename,
					pi.name_suffix AS suffixname,
			 	    NVL(NVL(to_char(EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
			 	    		to_char(EPIC.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
			 	                   'UNKNOWN') AS DOB,
			 	    pi.CODE_NAME_TYPE AS CODE_NAME_TYPE
			FROM    EPIC.eh_person_identity pi,
					EPIC.eh_offender_ids id
			WHERE	id.ENTITY_ID = pi.entity_id
			  AND	id.entity_id = p_message
			  AND	pi.CODE_NAME_TYPE in ('MAS','ALI')
			  AND EXISTS (select 1 from EPIC.eh_active_booking ab where id.entity_id = ab.entity_id));
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN		
				UPDATE MT_JIL_ALIAS--@Link_IVR
				set (ENTITY_ID_FK, OFFENDER_ID, ALIAS_ID_PK, LASTNAME, FIRSTNAME, MIDDLENAME, SUFFIXNAME, DOB, CODE_NAME_TYPE) =
				(select 	id.entity_id AS entity_id,
					        id.OFFENDER_ID AS offender_id,
							pi.identity_id AS alias_id,
							pi.name_family AS lastname,
							pi.name_first  AS firstname,
							pi.name_other  AS middlename,
							pi.name_suffix AS suffixname,
					 	    NVL(NVL(to_char(EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
					 	    		to_char(EPIC.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
					 	                   'UNKNOWN') AS DOB,
					 	    pi.CODE_NAME_TYPE AS CODE_NAME_TYPE
					FROM    EPIC.eh_person_identity pi,
							EPIC.eh_offender_ids id
					WHERE	id.ENTITY_ID = pi.entity_id
					  AND	id.entity_id = p_message
					  AND	pi.CODE_NAME_TYPE in ('MAS','ALI')
					  AND EXISTS (select 1 from EPIC.eh_active_booking ab where id.entity_id = ab.entity_id));
		
		return;

	end;
	--
	
	--
	--	Procedure update JIL with inmate record
	--
	procedure jil_inmate(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- copy the data from OT to JIL
		logit('JIL inmate');
				insert into MT_JIL_INMATE--@Link_IVR
				(ENTITY_ID_PK, OFFENDER_ID, INMATECLASS, LASTNAME, FIRSTNAME, OTHERNAME, GENDER, DOB, JUVENILE_FLAG, CELL, MUGPATH, TOW_COMPANY, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, PAID_RELEASE, PROJECTED_RELEASE, RESTRICTIONUNTIL)
				(select 	id.entity_id AS entity_id,
		       	id.OFFENDER_ID AS offender_id,
		   		decode(epic.ef_offender_CustStat(ab2.entity_id),
		               	'REGULAR INMATE','R',
						'WORK RELEASE','W',
		               	'KITCHEN TRUSTEE (White)','K',
		               	'GARAGE TRUSTEE (Orange)','O',
		               	'SPECIAL TRUSTEE (Green)','G',
		               	'R') as inmateclass,
				pi.NAME_FAMILY as lastname,
				pi.NAME_FIRST  as firstname,
				pi.NAME_OTHER  as othername,
		   		decode(ep.CODE_GENDER,'_NOSP','U',ep.CODE_GENDER) as gender,
				NVL(NVL(to_char(epic.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
						to_char(epic.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
						'UNKNOWN_DOB') as DOB,
				decode(ep.JUVENILE_FLAG,'Y','Y','N') as juvenile_flag,
			   	substr(epic.ef_location_name(ha.location_id ,'uc'),1,10) as cell,
				decode(ei.imageref, null,null,
						'\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
				--vehicle_id as vehicle_id,
				eo.ORGANIZATION_NAME as tow_company,
		   	   	EPIC.mcmb_fnt_sent_Total_Amount(ab2.booking_id) as sent_total,
		   	   	EPIC.mcmb_fnt_hold_Total_Amount(ab2.booking_id) as hold_total,
		   		EPIC.mcmb_fnt_Bail_Total_Amount(ab2.booking_id) as bail_total,
				epic.ef_epic_date_to_date(epic.epp_booking_dates.earliest_release_date(ab2.booking_id)) as paid_release,
		   	   	epic.ef_epic_date_to_date(epic.epp_booking_dates.final_release_date(ab2.booking_id))    as Projected_release,--,
		   	   	(select max(epic.ef_epic_date_to_date(r.end_date)) from epic.EH_ENTITY_RESTRICTION r where ab2.entity_id = r.entity_id(+) and epic.ef_epic_date_to_date(r.end_date)>sysdate ) as restrictionuntil
		 from   epic.EH_OFFENDER_IDS id,
		 		epic.EH_PERSON_IDENTITY pi,
		 		epic.eh_entity_person ep,
		 		epic.EH_VEHICLE v,
				epic.EH_ENTITY_ORGANIZATION  eo,
				epic.Epicvolume ev,
				epic.Epicimage ei,
				epic.Eh_entity_default_photo ph,
				epic.eh_active_booking ab2,
				epic.eh_housing_assignments ha
		 where  id.entity_id = ab2.entity_id
		   and  epic.ef_is_active_booking(ab2.entity_id)='TRUE'
		   and  id.entity_id = p_message
		   and  id.entity_id = pi.entity_id
		   and  id.entity_id = ep.entity_id
		   and  ab2.entity_id = ha.entity_id
		   and  v.entity_id(+) = pi.entity_id
		   and  v.tow_company_id = eo.entity_id(+)
		   and  ei.imageref(+) = ph.photo_id
		   and  ev.volumeid(+) = ei.volumeid
		   and  ph.entity_id(+) = id.entity_id
		   and  pi.code_name_type = 'MAS'
		   and  ab2.entity_id = id.entity_id);
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN		
				UPDATE MT_JIL_INMATE--@Link_IVR
				 set (ENTITY_ID_PK, OFFENDER_ID, INMATECLASS, LASTNAME, FIRSTNAME, OTHERNAME, GENDER, DOB, JUVENILE_FLAG, CELL, MUGPATH, TOW_COMPANY, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, PAID_RELEASE, PROJECTED_RELEASE, RESTRICTIONUNTIL)
				=(	select 	id.entity_id AS entity_id,
					       	id.OFFENDER_ID AS offender_id,
					   		decode(epic.ef_offender_CustStat(ab2.entity_id),
					               	'REGULAR INMATE','R',
									'WORK RELEASE','W',
					               	'KITCHEN TRUSTEE (White)','K',
					               	'GARAGE TRUSTEE (Orange)','O',
					               	'SPECIAL TRUSTEE (Green)','G',
					               	'R') as inmateclass,
							pi.NAME_FAMILY as lastname,
							pi.NAME_FIRST  as firstname,
							pi.NAME_OTHER  as othername,
					   		decode(ep.CODE_GENDER,'_NOSP','U',ep.CODE_GENDER) as gender,
							NVL(NVL(to_char(epic.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
									to_char(epic.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
									'UNKNOWN_DOB') as DOB,
							decode(ep.JUVENILE_FLAG,'Y','Y','N') as juvenile_flag,
						   	substr(epic.ef_location_name(ha.location_id ,'uc'),1,10) as cell,
							decode(ei.imageref, null,null,
									'\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
							--vehicle_id as vehicle_id,
							eo.ORGANIZATION_NAME as tow_company,
					   	   	EPIC.mcmb_fnt_sent_Total_Amount(ab2.booking_id) as sent_total,
					   	   	EPIC.mcmb_fnt_hold_Total_Amount(ab2.booking_id) as hold_total,
					   		EPIC.mcmb_fnt_Bail_Total_Amount(ab2.booking_id) as bail_total,
							epic.ef_epic_date_to_date(epic.epp_booking_dates.earliest_release_date(ab2.booking_id)) as paid_release,
					   	   	epic.ef_epic_date_to_date(epic.epp_booking_dates.final_release_date(ab2.booking_id))    as Projected_release,--,
					   	   	(select max(epic.ef_epic_date_to_date(r.end_date)) from epic.EH_ENTITY_RESTRICTION r where ab2.entity_id = r.entity_id(+) and epic.ef_epic_date_to_date(r.end_date)>sysdate ) as restrictionuntil
					 from   epic.EH_OFFENDER_IDS id,
					 		epic.EH_PERSON_IDENTITY pi,
					 		epic.eh_entity_person ep,
					 		epic.EH_VEHICLE v,
							epic.EH_ENTITY_ORGANIZATION  eo,
							epic.Epicvolume ev,
							epic.Epicimage ei,
							epic.Eh_entity_default_photo ph,
							epic.eh_active_booking ab2,
							epic.eh_housing_assignments ha
					 where  id.entity_id = ab2.entity_id
					   and  epic.ef_is_active_booking(ab2.entity_id)='TRUE'
					   and  id.entity_id = p_message
					   and  id.entity_id = pi.entity_id
					   and  id.entity_id = ep.entity_id
					   and  ab2.entity_id = ha.entity_id
					   and  v.entity_id(+) = pi.entity_id
					   and  v.tow_company_id = eo.entity_id(+)
					   and  ei.imageref(+) = ph.photo_id
					   and  ev.volumeid(+) = ei.volumeid
					   and  ph.entity_id(+) = id.entity_id
					   and  pi.code_name_type = 'MAS'
					   and  ab2.entity_id = id.entity_id); 		
		
		
		return;

	end;
	--
	
	--
	--	Procedure update JIL with VISITOR records for a given inmate
	--  p_message is the EPIC.eh_offender_ids.entity_id
	--
	procedure jil_visitor(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- copy the data from OT to JIL
		logit('JIL visitor'); 
		insert into  MT_JIL_VISITOR--@Link_IVR
		(ENTITY_ID_fk, offender_id, entity_related_to_pk, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ)
			SELECT 	id.entity_id AS entity_id_fk,
			        id.offender_id AS entity_id, 
					er.ENTITY_RELATED_TO AS entity_related_to_pk,
					DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_app_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS application_date,
			       	DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_expir_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS expiration_date,
			       	pi.name_family AS lastname,
			       	pi.name_first  AS firstname,
			       	DECODE(er.RELATIONSHIP_TYPE,'21','A','N') AS status,
			       	DECODE(er.RELATIONSHIP_TYPE,'21','1','2') AS typeseq--,
			   	   	--id.offender_id ||'-'||er.ENTITY_RELATED_TO AS vistitor_pk
			FROM   	EPIC.eh_offender_ids id,
					EPIC.eh_person_identity pi,
			       	EPIC.eh_entity_relationship er
			--       	EPIC.eh_active_booking ab
			WHERE  er.ENTITY_RELATED_TO = pi.entity_id
			--  AND  ab.entity_id = pi.entity_id
			  AND  id.entity_id = er.entity_id
			  AND  er.related_as_role = 'VISTR'
			  AND  pi.code_name_type = 'MAS'   
			  AND  id.entity_id = p_message
			  AND EXISTS (select 1 from EPIC.eh_active_booking ab where pi.entity_id = ab.entity_id);
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MT_JIL_VISITOR--@Link_IVR
				 set (ENTITY_ID_fk, offender_id, entity_related_to_pk, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ/*, VISTITOR_PK*/) = 
					(SELECT id.entity_id AS entity_id_fk,
					        id.offender_id AS entity_id, 
							er.ENTITY_RELATED_TO AS entity_related_to_pk,
							DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_app_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS application_date,
					       	DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_expir_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS expiration_date,
					       	pi.name_family AS lastname,
					       	pi.name_first  AS firstname,
					       	DECODE(er.RELATIONSHIP_TYPE,'21','A','N') AS status,
					       	DECODE(er.RELATIONSHIP_TYPE,'21','1','2') AS typeseq--,
					   	   	--id.offender_id ||'-'||er.ENTITY_RELATED_TO AS vistitor_pk
					FROM   	EPIC.eh_offender_ids id,
							EPIC.eh_person_identity pi,
					       	EPIC.eh_entity_relationship er
					--       	EPIC.eh_active_booking ab
					WHERE  er.ENTITY_RELATED_TO = pi.entity_id
					--  AND  ab.entity_id = pi.entity_id
					  AND  id.entity_id = er.entity_id
					  AND  er.related_as_role = 'VISTR'
					  AND  pi.code_name_type = 'MAS'   
					  AND  id.entity_id = p_message
					  AND EXISTS (select 1 from EPIC.eh_active_booking ab where pi.entity_id = ab.entity_id)
				);
		return;
	end;
	--

	--
	--	Procedure update JIL with BANNED records for a given inmate
	--  p_message is the EPIC.eh_banned_visitor.visitor_id
	--
	procedure jil_banned
	is
	begin 
		-- copy the data from OT to JIL
		
		logit('JIL banned'); 
		begin
			insert into MT_JIL_VISITOR--@Link_IVR
			(ENTITY_ID_fk, offender_id, entity_related_to_pk, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ/*, VISTITOR_PK*/)
				SELECT 	'' AS ENTITY_ID_fk, 
				        null as  offender_id,
						va.visitor_id AS vistitor_id, 
						va.date_FROM AS application_date, 
						va.date_to AS expiration_date, 
						vpi.name_family AS lastname, 
						vpi.name_first  AS firstname, 
						'B' AS status, 
						'3' AS typeseq--,
						--''||'-'||va.VISITOR_ID
				FROM 	EPIC.eh_banned_visitor va, 
						EPIC.eh_person_identity vpi,
				      	EPIC.eh_active_booking ab
				WHERE 	va.visitor_id = vpi.entity_id
				  AND	ab.entity_id = vpi.entity_id 
				  --AND   vpi.entity_id = p_message
				  AND EXISTS (select 1 from EPIC.eh_active_booking ab where vpi.entity_id = ab.entity_id);           
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MT_JIL_VISITOR--@Link_IVR
				SET (ENTITY_ID_fk, offender_id, entity_related_to_pk, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ/*, VISTITOR_PK*/) = 
				(	SELECT 	'' AS ENTITY_ID_fk, 
   				            null as  offender_id,
							va.visitor_id AS vistitor_id, 
							va.date_FROM AS application_date, 
							va.date_to AS expiration_date, 
							vpi.name_family AS lastname, 
							vpi.name_first  AS firstname, 
							'B' AS status, 
							'3' AS typeseq--,
							--''||'-'||va.VISITOR_ID
					FROM 	EPIC.eh_banned_visitor va, 
							EPIC.eh_person_identity vpi,
					       	EPIC.eh_active_booking ab
					WHERE 	va.visitor_id = vpi.entity_id
					  AND	ab.entity_id = vpi.entity_id 
					  --AND   vpi.entity_id = p_message
					  AND EXISTS (select 1 from EPIC.eh_active_booking ab where vpi.entity_id = ab.entity_id));
		end;		
		return;
	end;
	--

	--
	--	Procedure update JIL with CHARGE records for a given inmate
	--
	procedure jil_charge(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- copy the data from OT to JIL
		logit('JIL charge');
		insert into MT_JIL_CHARGE--@Link_IVR
		(ENTITY_ID_FK, OFFENDER_ID, CHARGE_ID, STATUTE_ID, PACC, CHARGE_DESC, CHARGE_CLASS,
		SENTENCE_ID, CHARGE_ID_NUMBER, AGENCY_ID, COMPLAINT_DEPT, COURT_ID, CASE_NO, COURT_NAME, 
		COURT_DATE, COURT_DIVISION, JUDGE, START_DATE, FINAL_RELEASE_DATE, AMOUNT, AMOUNT_TYPE, 
		TRANS_TYPE, SORT_ORDER, REDUCEAMOUNT, PAIDOUTDATE, UNPAIDOUTDATE, surcharge_amount,
		charge_state)
		SELECT 	b.entity_id                AS entity_id,
		        id.OFFENDER_ID				AS offender_id,
				c.charge_id 				AS charge_id,
		        c.statute_id 				AS statute_id,
		        es.statute_number 			AS pacc,
		        es.statute_description 		AS charge_desc,
		    	EPIC.ef_lookup_text('STATUTE CLASS', es.code_statute_class, 'UC') AS charge_class,
		        s.sentence_id 				AS sentence_id,
		       	charge_id_number 			AS charge_id_number,
		       	ca.agency_id 				AS agency_id,
		       	eo.organization_name 		AS complaint_dept,
		       	cct.court_id 				AS court_id,
		       	cs.case_number 				AS case_no,
		       	EPIC.mcmb_fnt_courtname(c.charge_id) AS court_name,
		       	decode(
		       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY'),'12/25/2025','Call Court',
		       	                                                                                      '01/01/2200','Call Court',
		       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY')) AS court_date,
		       	EPIC.ef_next_court_division(b.entity_id) AS court_division,
		       	EPIC.ef_lookup_text('JUDGE NAME',EPIC.ef_next_court_judge(b.entity_id),'UC') AS court_judge,
				EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.start_date(b.booking_id))         		AS Start_Date,
				EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.final_release_date(b.booking_id))     	AS final_release_date ,
				decode(c.sentence_id,NULL,
									to_number(bc.cash_only_bail_amount),
									to_number(EPIC.mcmb_fnt_fineamount(c.sentence_id)))  AS amount,
				decode(c.sentence_id,NULL, 'BAIL', 'FINE') AS amount_type,
				decode(c.sentence_id,NULL, 'U', 'S') AS Trans_type,
				decode(c.sentence_id,NULL, 2, 1) AS sortorder,
				--EPIC.ef_offender_id(b.entity_id)||' - '||c.charge_id  AS web_charge_pk,
				decode(EPIC.ef_get_attribute_value('10 PERCENT BOND',bc.BAIL_CONDITION_ID),'YES',
																	'Y',
																	'N') AS reduceamount,
				EPIC.ef_epic_date_to_date(so.paid_out_date) AS paidoutdate,
				EPIC.ef_epic_date_to_date(so.unpaid_out_date) AS unpaidoutdate,
				bc.surcharge_amount  AS surcharge_amount,
				c.charge_state
		FROM 	EPIC.eh_charge c,
				EPIC.eh_booking b,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge_agency ca ,
		     	EPIC.eh_case cs,
		     	EPIC.eh_case_charge cc,
		     	EPIC.eh_case_court cct,
		     	EPIC.eh_entity_organization eo,
		     	EPIC.eh_sentence s,
		     	EPIC.eh_sentence_out_dates so,
		     	EPIC.epic_statutes es,
		     	EPIC.eh_bail_condition bc,
		     	EPIC.eh_bail_condition_charge bcc,
				EPIC.eh_offender_ids id
		WHERE b.booking_id = c.booking_id
		  AND c.charge_id = ca.charge_id
		  AND b.booking_id = p_message
		  AND s.sentence_id (+) = c.sentence_id
		  AND cs.booking_id = b.booking_id
		  AND cc.charge_id = c.charge_id
		  AND cc.case_id = cs.case_id
		  AND cct.case_id = cs.case_id
		  AND eo.entity_id = ca.agency_id
		  AND es.STATUTE_ID = c.statute_id
		  AND so.sentence_id (+)  = c.sentence_id
		  AND bc.booking_id = b.booking_id
		  AND bcc.charge_id = c.charge_id
		  AND bc.bail_condition_id = bcc.bail_condition_id
		  AND b.booking_id = ab.booking_id
		  AND id.ENTITY_ID = ab.entity_id
		  AND EPIC.ef_is_active_booking(b.entity_id)='TRUE'
		union
		-- HOLD records
		SELECT b.entity_id AS entity_id,
		       EPIC.ef_offender_id(b.entity_id) AS offender_id,
		       h.hold_id AS charge_id,
			   NULL      AS statute_id,
		       NULL      AS pacc,
		       NULL      AS charge_desc,
		       EPIC.ef_lookup_text('STATUTE CLASS', code_charge_severity, 'UC') AS charge_class,
		       NULL                 AS sentence_id,
		       EPIC.ef_lookup_text('HOLD TYPE',code_hold_type,'UC') AS charge_id_number,
		       h.agency_id          AS agency_id,
		       eo.organization_name AS complaint_dept,
		       NULL                 AS court_id,
		       -- case number (other attrib - hold warant number)
		       EPIC.ef_get_attribute_value('HOLD WARRANT NUMBER',h.hold_id) AS case_no,
		       -- court name  (other attrib - hold court)
		       EPIC.ef_get_attribute_value('HOLD COURT',h.hold_id) AS court_name,
		       NULL AS court_date,
		       NULL AS court_division,
		       NULL AS court_judge,
		       NULL AS start_date,
		       NULL AS final_release_date,
		       -- bond/fines  (other attrib - hold amount)
		       to_number(EPIC.ef_get_attribute_value('HOLD AMOUNT',h.hold_id)) AS amount,
		       'BOND' AS amount_type,
			   'H'    AS Trans_type,
		       3      AS sortorder,
		        --EPIC.mcmb_fnt_offenderidfrombk(b.booking_id)||' - '||h.hold_id,
		   	    decode(sign(instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10%')+
		  					instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10 %')+
		   					instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'10 PERCENT'))-
		   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO 10')*100)-
		   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO10')*100),
						  					1,'Y','N') AS reduceamount,
				NULL AS paidoutdate,
				NULL AS unpaidoutdate,
				NULL AS surcharge_amount,
				NULL AS charge_state
		FROM EPIC.eh_booking_holds h,
		     EPIC.eh_active_booking b,
		     EPIC.eh_entity_organization eo
		WHERE b.booking_id = h.booking_id
		  AND eo.entity_id = h.agency_id
		  AND b.booking_id = p_message;
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MT_JIL_CHARGE--@Link_IVR
				set (ENTITY_ID_FK, OFFENDER_ID, CHARGE_ID, STATUTE_ID, PACC, CHARGE_DESC, CHARGE_CLASS,
					SENTENCE_ID, CHARGE_ID_NUMBER, AGENCY_ID, COMPLAINT_DEPT, COURT_ID, CASE_NO, COURT_NAME, 
					COURT_DATE, COURT_DIVISION, JUDGE, START_DATE, FINAL_RELEASE_DATE, AMOUNT, AMOUNT_TYPE, 
					TRANS_TYPE, SORT_ORDER, REDUCEAMOUNT, PAIDOUTDATE, UNPAIDOUTDATE, surcharge_amount,
					charge_state)=
					(SELECT b.entity_id                AS entity_id,
					        id.OFFENDER_ID				AS offender_id,
							c.charge_id 				AS charge_id,
					        c.statute_id 				AS statute_id,
					        es.statute_number 			AS pacc,
					        es.statute_description 		AS charge_desc,
					    	EPIC.ef_lookup_text('STATUTE CLASS', es.code_statute_class, 'UC') AS charge_class,
					        s.sentence_id 				AS sentence_id,
					       	charge_id_number 			AS charge_id_number,
					       	ca.agency_id 				AS agency_id,
					       	eo.organization_name 		AS complaint_dept,
					       	cct.court_id 				AS court_id,
					       	cs.case_number 				AS case_no,
					       	EPIC.mcmb_fnt_courtname(c.charge_id) AS court_name,
					       	decode(
					       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY'),'12/25/2025','Call Court',
					       	                                                                                      '01/01/2200','Call Court',
					       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY')) AS court_date,
					       	EPIC.ef_next_court_division(b.entity_id) AS court_division,
					       	EPIC.ef_lookup_text('JUDGE NAME',EPIC.ef_next_court_judge(b.entity_id),'UC') AS court_judge,
							EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.start_date(b.booking_id))         		AS Start_Date,
							EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.final_release_date(b.booking_id))     	AS final_releASe_date ,
							decode(c.sentence_id,NULL,
												to_number(bc.cash_only_bail_amount),
												to_number(EPIC.mcmb_fnt_fineamount(c.sentence_id)))  AS amount,
							decode(c.sentence_id,NULL, 'BAIL', 'FINE') AS amount_type,
							decode(c.sentence_id,NULL, 'U', 'S') AS Trans_type,
							decode(c.sentence_id,NULL, 2, 1) AS sortorder,
							--EPIC.ef_offender_id(b.entity_id)||' - '||c.charge_id  AS web_charge_pk,
							decode(EPIC.ef_get_attribute_value('10 PERCENT BOND',bc.BAIL_CONDITION_ID),'YES',
																				'Y',
																				'N') AS reduceamount,
							EPIC.ef_epic_date_to_date(so.paid_out_date) AS paidoutdate,
							EPIC.ef_epic_date_to_date(so.unpaid_out_date) AS unpaidoutdate,
							bc.surcharge_amount  AS surcharge_amount,
							c.charge_state
					FROM 	EPIC.eh_charge c,
							EPIC.eh_booking b,
							EPIC.eh_active_booking ab,
							EPIC.eh_charge_agency ca ,
					     	EPIC.eh_case cs,
					     	EPIC.eh_case_charge cc,
					     	EPIC.eh_case_court cct,
					     	EPIC.eh_entity_organization eo,
					     	EPIC.eh_sentence s,
					     	EPIC.eh_sentence_out_dates so,
					     	EPIC.epic_statutes es,
					     	EPIC.eh_bail_condition bc,
					     	EPIC.eh_bail_condition_charge bcc,
							EPIC.eh_offender_ids id
					WHERE b.booking_id = c.booking_id
					  AND c.charge_id = ca.charge_id
					  AND b.booking_id = p_message
					  AND s.sentence_id (+) = c.sentence_id
					  AND cs.booking_id = b.booking_id
					  AND cc.charge_id = c.charge_id
					  AND cc.case_id = cs.case_id
					  AND cct.case_id = cs.case_id
					  AND eo.entity_id = ca.agency_id
					  AND es.STATUTE_ID = c.statute_id
					  AND so.sentence_id (+)  = c.sentence_id
					  AND bc.booking_id = b.booking_id
					  AND bcc.charge_id = c.charge_id
					  AND bc.bail_condition_id = bcc.bail_condition_id
					  AND b.booking_id = ab.booking_id
					  AND id.ENTITY_ID = ab.entity_id
					  AND EPIC.ef_is_active_booking(b.entity_id)='TRUE'
					union
					-- HOLD records
					SELECT b.entity_id AS entity_id,
					       EPIC.ef_offender_id(b.entity_id) AS offender_id,
					       h.hold_id AS charge_id,
						   NULL      AS statute_id,
					       NULL      AS pacc,
					       NULL      AS charge_desc,
					       EPIC.ef_lookup_text('STATUTE CLASS', code_charge_severity, 'UC') AS charge_class,
					       NULL                 AS sentence_id,
					       EPIC.ef_lookup_text('HOLD TYPE',code_hold_type,'UC') AS charge_id_number,
					       h.agency_id          AS agency_id,
					       eo.organization_name AS complaint_dept,
					       NULL                 AS court_id,
					       -- case number (other attrib - hold warant number)
					       EPIC.ef_get_attribute_value('HOLD WARRANT NUMBER',h.hold_id) AS case_no,
					       -- court name  (other attrib - hold court)
					       EPIC.ef_get_attribute_value('HOLD COURT',h.hold_id) AS court_name,
					       NULL AS court_date,
					       NULL AS court_division,
					       NULL AS court_judge,
					       NULL AS start_date,
					       NULL AS final_release_date,
					       -- bond/fines  (other attrib - hold amount)
					       to_number(EPIC.ef_get_attribute_value('HOLD AMOUNT',h.hold_id)) AS amount,
					       'BOND' AS amount_type,
						   'H'    AS Trans_type,
					       3      AS sortorder,
					        --EPIC.mcmb_fnt_offenderidfrombk(b.booking_id)||' - '||h.hold_id,
					   	    decode(sign(instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10%')+
					  					instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10 %')+
					   					instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'10 PERCENT'))-
					   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO 10')*100)-
					   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO10')*100),
									  					1,'Y','N') AS reduceamount,
							NULL AS paidoutdate,
							NULL AS unpaidoutdate,
							NULL AS surcharge_amount,
							NULL AS charge_state
					FROM EPIC.eh_booking_holds h,
					     EPIC.eh_active_booking b,
					     EPIC.eh_entity_organization eo
					WHERE b.booking_id = h.booking_id
					  AND eo.entity_id = h.agency_id
					  AND b.booking_id = p_message);	
		return;

	end;
	--
	  
	--
	--	Procedure update JIL with PHOTO records for a given inmate
	--
	procedure jil_PHOTO(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- copy the data from OT to JIL
		logit('JIL PHOTO');
		return;

	end;
	--
	
	--
	--	Procedure update JIL with RELEASE records for a given inmate
	--
	procedure jil_release(
		p_message       in  varchar2,
		p_offender_id   in  varchar2)
	is
	begin 
		-- remove the data from JIL
		logit('JIL release');
		delete from MT_JIL_CHARGE@Link_IVR  where ENTITY_ID_FK = p_message;
		delete from MT_JIL_VISITOR@Link_IVR where ENTITY_ID_FK = p_message;
		delete from MT_JIL_ALIAS@Link_IVR   where ENTITY_ID_FK = p_message;
		delete from MT_JIL_INMATE@Link_IVR  where ENTITY_ID_PK = p_message;
		
		commit;
		
		return;

	end;
	--
	
	--
	--	Procedure to run a centeral processing of alerts.  
	--  Get first request
	--  open connection to dblink database
	--  Make updates where needed
	--  Update sync table
	--  Get next row.  When completed all exit....
	--  close dblink.
	--    
	
	procedure jil_process_alert (
		p_module		in  varchar2, 
		p_which_alert	in  varchar2, 
		p_message       in  varchar2)
	is

	cursor jil_process_requests is
		select JIL_SYNC_ID, OFFENDER_ID, ENTITY_ID, BOOKING_ID, ALERT_TYPE 
		from MACOMB.MT_JIL_SYNC_LIST 
		where PROCESS_STATUS = 'I' 
		  and COMPLETE is null 
		order by DATETIME;
		
	v_JIL_SYNC_ID		MACOMB.MT_JIL_SYNC_LIST.JIL_SYNC_ID%type; 
	v_OFFENDER_ID		MACOMB.MT_JIL_SYNC_LIST.OFFENDER_ID%type; 
	v_ENTITY_ID			MACOMB.MT_JIL_SYNC_LIST.ENTITY_ID%type;
	v_BOOKING_ID		MACOMB.MT_JIL_SYNC_LIST.BOOKING_ID%type;
	v_ALERT_TYPE		MACOMB.MT_JIL_SYNC_LIST.ALERT_TYPE%type;
	
	begin 
		-- copy the data from OT to JIL
		logit('JIL central processing');
		--  Get first request
		  -- open cursor     
			open jil_process_requests;
			fetch jil_process_requests into v_JIL_SYNC_ID, v_OFFENDER_ID, v_ENTITY_ID, v_BOOKING_ID, v_ALERT_TYPE;
			if jil_process_requests%notfound then  
			    -- nothing to process
				close jil_process_requests;				
				return;
			else   
  		        -- create dblink
				begin 
				--create database link Link_IVR connect to IVR identified by IVR01 using 'IntTempdb';

				-- this needs some work on processing the cursor
				
				while jil_process_requests%found  loop
					-- update sync process status to 'P' 
					update MACOMB.MT_JIL_SYNC_LIST
					set PROCESS_STATUS = 'P'
					where JIL_SYNC_ID = v_JIL_SYNC_ID;
					commit;
					
					-- update/insert based on alert_type
					IF v_ALERT_TYPE =  	 cs_JIL_ALIAS_alert	  then 
					   -- use  v_ENTITY_ID, v_OFFENDER_ID
					   mpk_jil.jil_alias(v_ENTITY_ID, v_OFFENDER_ID);
					elsif v_ALERT_TYPE = cs_JIL_INMATE_alert  then 
						-- use v_ENTITY_ID, v_OFFENDER_ID
						mpk_jil.jil_inmate(v_ENTITY_ID, v_OFFENDER_ID);
					elsif v_ALERT_TYPE = cs_JIL_CHARGE_alert  then 
						-- use v_BOOKING_ID, v_OFFENDER_ID
						mpk_jil.jil_charge(v_BOOKING_ID, v_OFFENDER_ID);
					elsif v_ALERT_TYPE = cs_JIL_VISITOR_alert then
						-- use v_ENTITY_ID, v_OFFENDER_ID  
						mpk_jil.jil_visitor(v_ENTITY_ID, v_OFFENDER_ID);
					elsif v_ALERT_TYPE = cs_JIL_BANNED_alert  then
						-- Just bring them all Macomb does not really use this yet	
						mpk_jil.jil_banned();
					elsif v_ALERT_TYPE = cs_JIL_RELEASE_alert then 
						-- use v_ENTITY_ID and V_BOOKING_ID to delete all data
						mpk_jil.jil_release(v_ENTITY_ID, v_OFFENDER_ID);
					elsif v_ALERT_TYPE = cs_JIL_PHOTO_alert	  then 
						mpk_jil.jil_photo(v_ENTITY_ID, v_OFFENDER_ID);
					end if;
					
					-- update sync process status to 'C' and complete to 1
					update MACOMB.MT_JIL_SYNC_LIST
					set (PROCESS_STATUS, COMPLETE)  = (select 'C', '1' from dual) 
					where JIL_SYNC_ID = v_JIL_SYNC_ID;
					
					commit;
					
				end loop;    
				-- close dblink
				--DROP database link Link_IVR ;
				end;
			end if;
		close jil_process_requests;
		
		
		return;

	end;
	--	
-----------------------------------
--PUBLIC PROCEDURES and FUNCTIONS--
-----------------------------------
	--
	--
	--	procedure to initialize the "config.inf" file for the TCP/IP file transfer process
	--
	--
	procedure init
	is
		--
		cs_mod					constant varchar2(255) := 'init';
		--
		v_config_data			varchar2(32767);
		v_eoln					varchar2(2);
		--
	begin
		logit('JIL init');
		return;
	end;
	--      
	
	--
	--
	--	procedure to register the alerts to watch for
	--
	--
	procedure register
	is
		--
		cs_mod					constant varchar2(255) := 'jil$register';
		--
	
	begin	
		--
		--	register alert
		--
		dbms_alert.register(mpk_jil.cs_JIL_ALIAS_alert);
		dbms_alert.register(mpk_jil.cs_JIL_INMATE_alert);
		dbms_alert.register(mpk_jil.cs_JIL_CHARGE_alert);
		dbms_alert.register(mpk_jil.cs_JIL_VISITOR_alert);
		dbms_alert.register(mpk_jil.cs_JIL_BANNED_alert);
		dbms_alert.register(mpk_jil.cs_JIL_RELEASE_alert);
		dbms_alert.register(mpk_jil.cs_JIL_PHOTO_alert);
		--
		--	register for termination alert
		--
		dbms_alert.register(mpk_jil.cs_stop_alert);
		dbms_alert.register(mpk_jil.cs_stop_JIL_alert); 
		commit work;

	end;
	--                             
	
	--
	--
	--	procedure to un register alerts
	--
	--
	procedure unregister
	is
		--
		cs_mod					constant varchar2(255) := 'jil$unregister';
		--
	
	begin	
		--
		--	register alert
		--  
		mpk_jil.signal(mpk_jil.cs_stop_JIL_alert, null);
		dbms_alert.remove(mpk_jil.cs_JIL_ALIAS_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_INMATE_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_CHARGE_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_VISITOR_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_BANNED_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_RELEASE_alert);
		dbms_alert.remove(mpk_jil.cs_JIL_PHOTO_alert);
		--
		--	register for termination alert
		--
		dbms_alert.remove(mpk_jil.cs_stop_alert);
		dbms_alert.remove(mpk_jil.cs_stop_JIL_alert); 
		commit work;

	end;
	--                             

	--
	--
	--	procedure to wait for an alert and process it
	--
	--
	procedure waitany                                                                                    
	is
		v_module				varchar2(64);

		v_which_alert			varchar2(30);
		v_message				varchar2(32767);
		v_status				integer;
		v_timeout				number;
		v_error_count			integer := 0;
		v_debug					boolean;
		
		p_result				epic.epic_col_types.number_9%type;
		p_result_msg			epic.epic_col_types.varchar_255%type;
		v_temp					epic.epic_configuration.config_value%type;
        v_jobno					number;
		--
		--	cursor to read from the transaction table
		--
		--cursor cur_process is
		--	select * from macomb.mt_jil_alertmessage
		--	where module_id = v_module
		--	order by process_id;
	
	begin
		--
		--	main loop - wait for alert or termination signal
		--
		while true
		loop
			--
			--	trap errors here if possible
			--
			begin
				--
				--	wait for an alert
				--
				v_timeout := 3;	--	wake up each hour, anyway... 3600
				dbms_alert.waitany(v_which_alert,
	                    v_message,
	                    v_status,
	                    v_timeout);
	            --
	            --	first, check if alert and terminate message
	            --
	            if v_status = 0 then  --real alert  1 is a timeout.
	            	logit(v_which_alert);
	            	if v_which_alert = cs_stop_alert or v_which_alert = cs_stop_JIL_alert then
	            		--
	            		--	received termination message, log and end
	            		--
	            		logit('JIL Alert process terminated normally at ' || sysdate);
	            		unregister();
	            		return;
	            	end if; 
	            else
					-- close the alert process
            		logit('JIL Alert process terminated normally at ' || sysdate);
            		unregister();
            		return;
	            end if;
				--
				--	ok, either alert or timeout - don't care which, process anyway
				--
				if v_debug then
					if v_status = 0 then
						logit('JIL got alert');
					else
						logit('JIL got timeout');
					end if;
				end if;
				-- Insert into table MT_JIL_sync_list 
				-- this way if the alert is missed it will still be cared for
				insert into MT_JIL_sync_list 
				(jil_sync_id, offender_id, entity_id, booking_id, alert_type, 
				 process_status, complete, Datetime )
				select EPIC.epic_ids.new_epic_id,
				        id.offender_id,
				        id.entity_id,
				        b.booking_id,
				        v_which_alert,
				        'I',      -- Initialized (other statuses P - processing, C - completed, X - process by another request)
				        NULL,
				        sysdate
				from   EPIC.EH_OFFENDER_IDS id,
				       EPIC.EH_BOOKING b 
				where b.entity_id = id.entity_id
				  and id.entity_id = v_message; 
				commit;
				--
				--	check if any records in table to process
				--
					-- create job to process the record  
					-- v_message contains the epic_id (booking_id, entity_id, or charge_id)
					-- v_module deals with the task at hand         
				if v_debug = true then
					logit(v_which_alert|| ' - '||v_message|| ' in '||v_module);
				end if;
				mpk_jil.jil_process_alert(v_module, v_which_alert, v_message);
				
				/*
				if v_which_alert = mpk_jil.cs_JIL_ALIAS_alert then
					v_module := 'JIL ALIAS';
					mpk_jil.jil_alias(v_module, v_which_alert, v_message);
				elsIF v_which_alert = mpk_jil.cs_JIL_INMATE_alert then
					v_module := 'JIL INMATE';
					mpk_jil.jil_inmate(v_module, v_which_alert, v_message);
				elsIF v_which_alert = mpk_jil.cs_JIL_CHARGE_alert then
					v_module := 'JIL CHARGE';  
					mpk_jil.jil_charge(v_module, v_which_alert, v_message);
				elsIF v_which_alert = mpk_jil.cs_JIL_VISITOR_alert then
					v_module := 'JIL VISITOR';  
					mpk_jil.jil_visitor(v_module, v_which_alert, v_message); 
				elsIF v_which_alert = mpk_jil.cs_JIL_BANNED_alert then
					v_module := 'JIL BANNED';  
					mpk_jil.jil_banned(v_module, v_which_alert, v_message); 
				elsIF v_which_alert = mpk_jil.cs_JIL_RELEASE_alert then
					v_module := 'JIL RELEASE';   
					mpk_jil.jil_release(v_module, v_which_alert, v_message); 
				else 
					v_module := 'JIL UN-REGISTERED ALERT';
				end if;
	
				if v_debug = true then
					logit('*' || v_module || '*');
				end if;
	            */

			exception
				when others then
					--	log error and continue - if error count exceeds 100, bail
					epic.EP_LOG_INFO(
						mpk_jil.cs_JIL_module,	--	P_MODULE_ID,
						'E',							--	P_LOGTYPE,
						-1,								--	P_ACTION_BY,
						substr(sqlerrm || ' - ' || cs_mod, 1, 2000)	--	P_TEXT
						);
					v_error_count := v_error_count + 1;
					if v_error_count > 100 then
						logit('JIL Alert process terminated abnormally at ' || sysdate);
						return;
					end if;
			end;
		end loop;
	
	end;	
	
	procedure signal(
		p_alert				in		varchar2,
		p_message			in		epic.epic_col_types.varchar_255%type)
		-- p_alert - is the message type
		-- p_message - the key data to be moved.
	is
	begin
		DBMS_ALERT.SIGNAL(p_alert, p_message);	
		COMMIT WORK;
	end; 
	
	procedure regwaitany
	is 
	begin
		mpk_jil.register;
		mpk_jil.waitany;
	end;	
end MPK_JIL;
/

CREATE OR REPLACE
package        mpk_matching_offenders is
--
--  15 Aug 2006, J McBratnie, created a macomb version to include default mug in the result set.
--
--
--	25 July 2001, K Crosser
--		Package to perform match name/id checks on new offender creations
--	to see if the person is already known
--
	--
	--
	--	procedure to return counts of similar offenders
	--
	--
	procedure count_match_ofndrs (
		p_user_int_id				in		epic.epic_user_names.user_int_id%type,
		p_offender_id				in		epic.eh_offender_ids.offender_id%type,
		p_state_id					in		epic.eh_offender_ids.state_id%type,
		p_ssn						in		epic.eh_person_identity.social_security_number%type,
		p_name_last					in		epic.eh_person_identity.name_family%type,
		p_name_first				in		epic.eh_person_identity.name_first%type,
		p_total_oi					in out	epic.epic_col_types.number_9%type,
		p_total_si					in out 	epic.epic_col_types.number_9%type,
		p_total_ssn					in out  epic.epic_col_types.number_9%type,
		p_total_name				in out	epic.epic_col_types.number_9%type,
		p_result                	in out  epic.epic_col_types.number_9%type,
		p_result_msg            	in out  epic.epic_col_types.varchar_255%type);
	--
	--
	--	function to return result set of matching offenders
	--
	--
	function matching_offenders (
		p_user_int_id				in		epic.epic_user_names.user_int_id%type,
		p_offender_id				in		epic.eh_offender_ids.offender_id%type,
		p_state_id					in		epic.eh_offender_ids.state_id%type,
		p_ssn						in		epic.eh_person_identity.social_security_number%type,
		p_name_last					in		epic.eh_person_identity.name_family%type,
		p_name_first				in		epic.eh_person_identity.name_first%type)
		return epic.epp_generic_ref_cursor.ref_cursor;
	--
	--
	--	procedure to return a list of similar names matching a given name
	--
	--
	procedure will_match (
		p_name_first				in		epic.eh_person_identity.name_first%type,
		p_matching_names			in out	epic.epic_col_types.varchar_2000%type);
	--
end mpk_matching_offenders;
/

CREATE OR REPLACE
package body        mpk_matching_offenders is
-- 
--   02 Feb 2007 Modified ci_last_clip and ci_last_short_clip to 2

--  21 Nov 2006, Added Alias decode string to matching_offenders function 
--
--  15 Aug 2006, J McBratnie, created a macomb version to include default mug in the result set.
--
--
--	02 Jan 2004, K Crosser
--		Require 4 chars for name matching to speed up Mississippi (and others)
--		With 3 chars, MDOC takes up to 126 seconds for "SMITH, BRIAN"
--
--	25 September 2003, K Crosser
--		Fixed again to return the two extra columns that were added by someone
--		(without any comments!!!) at some point in the past year
--
--	23 September 2003, K Crosser
--		Modified the setup for cur_name to reduce last name matching times -
--		now requires 3 characters to match, rather than just 2
--
--	05 September 2003, K Crosser
--		Modified cur_name to remove extraneous soundex returns - only use where
--		first two chars of name match - this reduced processing time from 40 seconds to
--		2-5 seconds for 2.5 Million names
--
--	30 July 2001, K Crosser
--		If more than one identity for same offender, only return highest ranked identity
--
--	27 July 2001, K Crosser
--		Tuning, minor bug fixes
--
--	25 July 2001, K Crosser
--		Package to perform match name/id checks on new offender creations
--	to see if the person is already known
--
--		NOTE - in normal practice, the count function is called first, followed
--	by the retrieve list function.  The count function thus actually builds the list
--	of candidates, and the retrieve function will return that list UNLESS one or more
--	of the parameters is different.
--
	cs_mod							constant varchar2(255) := 'epp_matching_offenders';
	--
	cb_debug						constant boolean := FALSE;
	--
	--	scoring constants
	--
	ci_oid_score					constant integer := 10000;	--	matching offender id score
	ci_state_id_score				constant integer := 10000;	--	matching state id score
	ci_ssn_score					constant integer := 5000;	--	matching ssn score
	ci_name_last_score				constant integer := 750;	--	matching last name score
	ci_name_last_like_score			constant integer := 500;	--	like last name score
	ci_name_last_sndx_score			constant integer := 200;	--	matching soundex last name score
	ci_name_first_score				constant integer := 500;	--	matching first name score
	ci_name_first_like_score		constant integer := 250;	--	like first name score
	ci_similar_first_score			constant integer := 250;	--	first name similar (i.e. jack=john) score
	--
	--	cutoff threshold for results
	--
	cs_min_thresh					constant epic.epic_configuration.config_key%type := 'MINIMUM THRESHOLD';
	ci_default_threshold			constant integer := 751;
	gi_min_threshold				integer := ci_default_threshold;
	--
	--	clipping for like comparisons
	--
	ci_last_clip					constant integer := 2;		--	clip to this when doing a like without soundex   (changed from 5 to 2)
	ci_last_short_clip				constant integer := 2;		--	clip to this when doing a like with soundex      (changed from 4 to 2)
	ci_first_clip					constant integer := 4;		--	clip to this when doing a like without soundex
	--
	--	last parameters from count call
	--
	vlUserIntId						epic.epic_user_names.user_int_id%type;
	vlOffenderId					epic.eh_offender_ids.offender_id%type;
	vlStateId						epic.eh_offender_ids.state_id%type;
	vlSSN							epic.eh_person_identity.social_security_number%type;
	vlNameLast						epic.eh_person_identity.name_family%type;
	vlNameFirst						epic.eh_person_identity.name_first%type;
	vlGender						epic.eh_entity_person.code_gender%type;
	--
	--	structure of "found" candidates
	--
	type tPerson is record (
		entity_id				epic.eh_entity_person.entity_id%type,
		identity_id				epic.eh_person_identity.identity_id%type,
		offender_id				epic.eh_offender_ids.offender_id%type,
		state_id				epic.eh_offender_ids.state_id%type,
		ssn						epic.eh_person_identity.social_security_number%type,
		namelast				epic.eh_person_identity.name_family%type,
		namefirst				epic.eh_person_identity.name_first%type,
		gender					epic.eh_entity_person.code_gender%type,
		offender_id_match		integer,
		state_id_match			integer,
		ssn_match				integer,
		name_match				integer,
		score					integer
	);
	--
	type tPersons is table of tPerson index by binary_integer;
	--
	vPersons					tPersons;
	lPersons					integer;
	--
	type tFirst is table of epic.eh_person_identity.name_first%type index by binary_integer;
	--
	vFirsts						tFirst;
	lFirsts						integer;
	--
	--
	--	procedure for debug logging
	--
	--
	procedure logit (
		p_msg					in		varchar2)
	is
	begin
		if cb_debug then
			epic.ep_log_info(cs_mod, 'D', vlUserIntId, p_msg);
		end if;
	end;
	--
	--
	--
	function similar_names (
		p_name				in		epic.epic_similar_names.search_name%type)
	return varchar2
	is
	--
	--	function to recursively retrieve names that are similar
	--		returns delimited (by '|') list of names
	--	returns the putative gender as the first character, then '|' and names
	--
		type tRec is record (
			thename					epic.epic_similar_names.common_name%type,
			gender					epic.epic_similar_names.gender%type);
		type tName is table of tRec index by binary_integer;
		vNames						tName;
		lNames						integer := 0;
		--
		v_name						epic.epic_similar_names.search_name%type;
		v_gender					epic.epic_similar_names.gender%type;
		--
		v_new						integer := 1;
		v_result					varchar2(2000) := null;
		--
		cursor cur_names (a_name epic.epic_similar_names.search_name%type) is
			select common_name as thename, gender
			from epic.epic_similar_names
			where search_name = a_name
			union
			select search_name as thename, gender
			from epic.epic_similar_names
			where common_name = a_name;
		--
		--	try to add name to list unless already exists
		--
		procedure add_name (
			p_newname				in		epic.epic_similar_names.search_name%type,
			p_gender				in		epic.epic_similar_names.gender%type)
		is
		begin
			for i in 1..lNames
			loop
				if vNames(i).thename = p_newname then
					if vNames(i).gender <> p_gender then
						vNames(i).gender := 'X';
					end if;
					return;
				end if;
			end loop;
	--		ep_log_info('add_name','D',-1,lNames || ' - ' || p_newname);
			lNames := lNames + 1;
			vNames(lNames).thename := p_newname;
			vNames(lNames).gender := p_gender;
		end;
	begin
		add_name(p_name, 'X');
		for j in 1..2
		loop
			for i in 1..lNames
			loop
				v_name := vNames(i).thename;
				for cur in cur_names(v_name)
				loop
					add_name(cur.thename, cur.gender);
				end loop;
			end loop;
		end loop;
		--	see if all one gender
		v_gender := 'X';
		for i in 1..lNames
		loop
	--		ep_log_info('gender - ','D',-1,vNames(i).gender || ' - ' || vNames(i).thename);
			if v_gender = 'X' then
				v_gender := vNames(i).gender;
			elsif v_gender <> vNames(i).gender then
				v_gender := 'X';
				exit;
			end if;
		end loop;
		--	pack and return results
		v_result := v_gender || '|';
		for i in 1..lNames
		loop
			v_result := v_result || vNames(i).thename || '|';
		end loop;
		return v_result;
	end;
	--
	--
	--	add a person identity to internal table
	--
	--
	procedure add_person (
		p_entity_id				in		epic.eh_entity_person.entity_id%type,
		p_identity_id			in		epic.eh_person_identity.identity_id%type,
		p_offender_id			in		epic.eh_offender_ids.offender_id%type,
		p_state_id				in		epic.eh_offender_ids.state_id%type,
		p_ssn					in		epic.eh_person_identity.social_security_number%type,
		p_namelast				in		epic.eh_person_identity.name_family%type,
		p_namefirst				in		epic.eh_person_identity.name_first%type,
		p_gender				in		epic.eh_entity_person.code_gender%type)
	is
	--
	--	add a person identity - if already there, accumulate points
	--
	begin
		if vlGender = 'X' OR p_gender = vlGender then
			for i in 1..lPersons
			loop
				if vPersons(i).identity_id = p_identity_id then
					return;
				end if;
			end loop;
			--	fell through, not in list, add
			lPersons := lPersons + 1;
			vPersons(lPersons).entity_id := p_entity_id;
			vPersons(lPersons).identity_id := p_identity_id;
			vPersons(lPersons).offender_id := p_offender_id;
			vPersons(lPersons).state_id := p_state_id;
			vPersons(lPersons).ssn := p_ssn;
			vPersons(lPersons).namelast := p_namelast;
			vPersons(lPersons).namefirst := p_namefirst;
			vPersons(lPersons).gender := p_gender;
			vPersons(lPersons).offender_id_match := 0;
			vPersons(lPersons).state_id_match := 0;
			vPersons(lPersons).ssn_match := 0;
			vPersons(lPersons).name_match := 0;
			vPersons(lPersons).score := 0;
		end if;
		return;
	end;
	--
	--
	--	procedure to return counts of similar offenders
	--
	--
	procedure count_match_ofndrs (
		p_user_int_id				in		epic.epic_user_names.user_int_id%type,
		p_offender_id				in		epic.eh_offender_ids.offender_id%type,
		p_state_id					in		epic.eh_offender_ids.state_id%type,
		p_ssn						in		epic.eh_person_identity.social_security_number%type,
		p_name_last					in		epic.eh_person_identity.name_family%type,
		p_name_first				in		epic.eh_person_identity.name_first%type,
		p_total_oi					in out	epic.epic_col_types.number_9%type,
		p_total_si					in out 	epic.epic_col_types.number_9%type,
		p_total_ssn					in out  epic.epic_col_types.number_9%type,
		p_total_name				in out	epic.epic_col_types.number_9%type,
		p_result                	in out  epic.epic_col_types.number_9%type,
		p_result_msg            	in out  epic.epic_col_types.varchar_255%type)
	is
		--
		v_score						integer;
		v_name_family_like			epic.eh_person_identity.name_family%type;
		v_name_family_like_q		epic.eh_person_identity.name_family%type;
		v_name_family_short_like_q	epic.eh_person_identity.name_family%type;
		v_name_family_sndx			epic.eh_person_identity.name_family_soundex%type;
		v_name_last					epic.eh_person_identity.name_family%type;
		v_name_first				epic.eh_person_identity.name_first%type;
		V_name_first_like			epic.eh_person_identity.name_first%type;
		v_min_threshold				epic.epic_configuration.config_value%type;
		--
		v_offender_id				epic.eh_offender_ids.offender_id%type;
		v_state_id					epic.eh_offender_ids.state_id%type;
		--
		cursor cur_oid is
			select oi.entity_id, pi.identity_id, oi.offender_id, oi.state_id,
				pi.social_security_number, pi.name_family, pi.name_first, ep.code_gender
			from epic.eh_offender_ids oi,
				epic.eh_person_identity pi,
				epic.eh_entity_person ep
			where
				p_offender_id is not null
				and oi.offender_id = p_offender_id
				and pi.entity_id = oi.entity_id
				and ep.entity_id = pi.entity_id
			union
			select oi.entity_id, pi.identity_id, oi.offender_id, oi.state_id,
				pi.social_security_number, pi.name_family, pi.name_first, ep.code_gender
			from epic.eh_offender_ids oi,
				epic.eh_person_identity pi,
				epic.eh_entity_person ep
			where
				p_state_id is not null
				and oi.state_id = p_state_id
				and pi.entity_id = oi.entity_id
				and ep.entity_id = oi.entity_id
			union
			select pi.entity_id, pi.identity_id, '' as offender_id, '' as state_id,
				pi.social_security_number, pi.name_family, pi.name_first, ep.code_gender
			from epic.eh_person_identity pi,
				epic.eh_entity_person ep
			where
				p_ssn is not null
				and pi.social_security_number = p_ssn
				and ep.entity_id = pi.entity_id;
		--
		cursor cur_name is
			select pi.entity_id, pi.identity_id,
				pi.social_security_number, pi.name_family, pi.name_first,
				pi.code_name_type
			from
				epic.eh_person_identity pi
			where
				pi.name_family like v_name_family_like_q
			union
			select pi.entity_id, pi.identity_id,
				pi.social_security_number, pi.name_family, pi.name_first,
				pi.code_name_type
			from
				epic.eh_person_identity pi
			where
				pi.name_family like v_name_family_short_like_q
				and pi.name_family_soundex = v_name_family_sndx;
		--
		cursor cur_ids (pc_entity_id   epic.eh_offender_ids.entity_id%type) is
			select
				offender_id, state_id
			from
				epic.eh_offender_ids
			where
				entity_id = pc_entity_id;
		--
		--	function to see if the first name is a variant of the person's first name
		--
		function similar_name (
			p_master				in		epic.eh_person_identity.name_first%type,
			p_variant				in		epic.eh_person_identity.name_first%type)
		return boolean
		is
			vList						varchar2(2000);
			iPos						integer;
			vName						varchar2(255);
		begin
			--	if table not instantiated, do it now
			if lFirsts = 0 then
				vList := similar_names(p_master);
				vlGender := substr(vList,1,1);
				vList := substr(vList, 3, 2000);
				--	parse names into table
				while instr(vList, '|') > 0
				loop
					lFirsts := lFirsts + 1;
					iPos := instr(vList, '|');
					vName := substr(vList, 1, iPos-1);
					vList := substr(vList, iPos+1, 2000);
					logit('adding ' || vName || ' to similar names');
					vFirsts(lFirsts) := vName;
				end loop;
			end if;
			--	see if same in table
			for i in 1..lFirsts
			loop
				if p_variant = vFirsts(i) then
					return true;
				end if;
			end loop;
			return false;
		end;
		--
		--	function to score an entry
		--
		procedure score_entry (
			e_entity_id				in		epic.eh_entity_person.entity_id%type,
			e_identity_id			in		epic.eh_person_identity.identity_id%type,
			e_offender_id			in		epic.eh_offender_ids.offender_id%type,
			e_state_id				in		epic.eh_offender_ids.state_id%type,
			e_ssn					in		epic.eh_person_identity.social_security_number%type,
			e_namelast				in		epic.eh_person_identity.name_family%type,
			e_namefirst				in		epic.eh_person_identity.name_first%type,
			e_oid_match				in out	integer,
			e_sid_match				in out	integer,
			e_ssn_match				in out	integer,
			e_name_match			in out	integer,
			e_score					in out	integer)
		is
			bLast						boolean := false;
		begin
			e_score := 0;
			if e_offender_id is not null and p_offender_id is not null and e_offender_id = p_offender_id then
				e_score := e_score + ci_oid_score;
				e_oid_match := 1;
			end if;
			if e_state_id is not null and p_state_id is not null and e_state_id = p_state_id then
				e_score := e_score + ci_state_id_score;
				e_sid_match := 1;
			end if;
			if e_ssn is not null and p_ssn is not null and e_ssn = p_ssn then
				e_score := e_score + ci_ssn_score;
				e_ssn_match := 1;
			end if;
			if e_namelast = v_name_last then
				e_score := e_score + ci_name_last_score;
				bLast := true;
				e_name_match := 1;
			else
				if soundex(e_namelast) = soundex(v_name_last) then
					e_score := e_score + ci_name_last_sndx_score;
					bLast := true;
					e_name_match := 1;
				end if;
				if substr(e_namelast, 1, length(v_name_family_like)) = v_name_family_like then
					e_score := e_score + ci_name_last_like_score;
					bLast := true;
					e_name_match := 1;
				end if;
			end if;
			if e_namefirst = v_name_first then
				e_score := e_score + ci_name_first_score;
			else
				if substr(e_namefirst, 1, length(v_name_first_like)) = v_name_first_like then
					e_score := e_score + ci_name_first_like_score;
				end if;
				--	special case - if last name was "similar", check if first name is variant
				if bLast then
					--	compare first with "similar" names
					if similar_name(v_name_first, e_namefirst) then
						e_score := e_score + ci_similar_first_score;
					end if;
				end if;
			end if;
			--
			-- *** logit(e_score || ' - ' || e_namelast || ', ' || e_namefirst);
			--	CUT OFF at a defined threshold
			--
			if e_score < gi_min_threshold then
				e_score := 0;
			else
				--	still a candidate, check if another identity for this person
				--
				--	see if same entity has another identity with a higher score - if so, drop this one
				--
				for i in 1..lPersons
				loop
					if vPersons(i).entity_id = e_entity_id and vPersons(i).score > 0 then
						if vPersons(i).identity_id <> e_identity_id then
							if vPersons(i).score >= e_score then
								--	other one higher, remove this one
								e_score := 0;
							elsif vPersons(i).score < e_score then
								--	this one higher, remove other
								vPersons(i).score := 0;
							end if;
						end if;
					end if;
				end loop;
			end if;
			return;
		end;
		--
		--	function to clean name fields - must be non-null, non-blank after removing wildcards
		--
		function cleanname (
			p_name					in		varchar2)
		return varchar2
		is
			v_temp							varchar2(255);
		begin
			--	remove wildcards
			v_temp := replace(p_name, '%',' ');
			v_temp := replace(v_temp, '_',' ');
			v_temp := ltrim(rtrim(v_temp));
			return v_temp;
		end;
	begin
		logit(to_char(sysdate, 'SSSSS') || '- count_match_ofndrs called');
		p_result 		:= 0;
		p_result_msg 	:= null;
		--	reset found count
		lPersons 		:= 0;
		lFirsts 		:= 0;
		p_total_oi 		:= 0;
		p_total_si 		:= 0;
		p_total_ssn 	:= 0;
		p_total_name 	:= 0;
		vlUserIntId 	:= null;	--	p_user_int_id;
		vlOffenderId 	:= null;	--	p_offender_id;
		vlStateId 		:= null;	--	p_state_id;
		vlSSN 			:= null;	--	p_ssn;
		vlNameLast 		:= null;	--	p_name_last;
		vlNameFirst 	:= null;	--	p_name_first;
		--
		vlGender 		:= 'X';
		--
		--	validate input parameters - last and first name must be non-empty
		--
		if p_user_int_id is null then
			raise_application_error(-20001,
	epic.otk_dyn_msg_server.otk_dyn_msg('SERVER.mpk_MATCHING_OFFENDERS','0GW7BIE000MOTZZZ',cs_mod)
	-- User int id must be supplied - %s1%
		);
		end if;
		--	clean the name fields
		v_name_last := cleanname(p_name_last);
		if v_name_last is null or (not length(v_name_last) >= 1) then
			raise_application_error(-20001,
	epic.otk_dyn_msg_server.otk_dyn_msg('SERVER.mpk_MATCHING_OFFENDERS','0GW7BIJ000MOTZZZ',cs_mod)
	-- Last name must be supplied and must be non-blank - %s1%
		);
		end if;
		v_name_first := cleanname(p_name_first);
		if v_name_first is null or (not length(v_name_first) >= 1) then
			raise_application_error(-20001,
	epic.otk_dyn_msg_server.otk_dyn_msg('SERVER.mpk_MATCHING_OFFENDERS','0GW7BIM010MOTZZZ',cs_mod)
	-- First name must be supplied and must be non-blank - %s1%
		);
		end if;
		--
		--	set threshold
		--
		gi_min_threshold := ci_default_threshold;
--		begin
--			ep_get_configuration_value(cs_mod, cs_min_thresh, v_min_threshold, ci_default_threshold, p_result, p_result_msg);
--			gi_min_threshold := v_min_threshold;
--		exception
--			when others then
--				gi_min_threshold := ci_default_threshold;
--		end;
--		if gi_min_threshold < 100 then
--			gi_min_threshold := ci_default_threshold;
--		end if;
		--
		--	get persons matching the offender id, state_id, and/or SSN
		--
		logit(to_char(sysdate, 'SSSSS') || '- searching by ID');
		if p_offender_id is not null or p_state_id is not null or p_ssn is not null then
			for cur in cur_oid
			loop
				add_person(cur.entity_id, cur.identity_id, cur.offender_id, cur.state_id,
					cur.social_security_number, cur.name_family, cur.name_first, cur.code_gender);
			end loop;
		end if;
		--
		--	ok, now get persons matching the name fields
		--
		v_name_family_like := substr(v_name_last, 1, ci_last_clip);
		if length(v_name_family_like) >= ci_last_short_clip then
			v_name_family_like_q := v_name_family_like || '%';
			v_name_family_short_like_q := substr(v_name_family_like_q, 1, ci_last_short_clip) || '%';
		else
			v_name_family_like_q := v_name_family_like;
			v_name_family_short_like_q := v_name_family_like_q;
		end if;
		v_name_family_sndx := soundex(v_name_last);
		v_name_first_like := substr(v_name_first, 1, ci_first_clip);
		logit(to_char(sysdate, 'SSSSS') || '- searching by name');
		logit(to_char(sysdate, 'SSSSS') || '- [' || v_name_family_like_q || ',' || v_name_family_sndx || ']');
		for cur in cur_name
		loop
			if cur.code_name_type <> 'UNK' then
				open cur_ids(cur.entity_id);
				fetch cur_ids into v_offender_id, v_state_id;
				if cur_ids%notfound then
					v_offender_id := null;
					v_state_id := null;
				end if;
				close cur_ids;
				add_person(cur.entity_id, cur.identity_id,
					v_offender_id,
					v_state_id,
					cur.social_security_number, cur.name_family, cur.name_first,
					epic.ef_offender_person_gender(cur.entity_id));
			end if;
		end loop;
		--
		--	now, score each entry and count results
		--
		logit(to_char(sysdate, 'SSSSS') || '- scoring results');
		for i in 1..lPersons
		loop
			score_entry(vPersons(i).entity_id, vPersons(i).identity_id,
				vPersons(i).offender_id, vPersons(i).state_id, vPersons(i).ssn,
				vPersons(i).namelast, vPersons(i).namefirst,
				vPersons(i).offender_id_match, vPersons(i).state_id_match, vPersons(i).ssn_match,
				vPersons(i).name_match, vPersons(i).score);
			if vPersons(i).score > 0 then
				p_total_oi 		:= p_total_oi + vPersons(i).offender_id_match;
				p_total_si 		:= p_total_si + vPersons(i).state_id_match;
				p_total_ssn 	:= p_total_ssn + vPersons(i).ssn_match;
				p_total_name 	:= p_total_name + vPersons(i).name_match;
			end if;
		end loop;
		vlOffenderId := p_offender_id;
		vlStateId := p_state_id;
		vlSSN := p_ssn;
		vlNameLast := p_name_last;
		vlNameFirst := p_name_first;
		--
		logit(to_char(sysdate, 'SSSSS') || '- exiting count_match_ofndrs');
		return;
	exception
		when others then
			p_result := sqlcode;
			p_result_msg := substr(sqlerrm || ' - ' || cs_mod || '.count_match_ofndrs', 1, 255);
	end;
	--
	--
	--	function to return result set of matching offenders
	--
	--
	function matching_offenders (
		p_user_int_id				in		epic.epic_user_names.user_int_id%type,
		p_offender_id				in		epic.eh_offender_ids.offender_id%type,
		p_state_id					in		epic.eh_offender_ids.state_id%type,
		p_ssn						in		epic.eh_person_identity.social_security_number%type,
		p_name_last					in		epic.eh_person_identity.name_family%type,
		p_name_first				in		epic.eh_person_identity.name_first%type)
		return epic.epp_generic_ref_cursor.ref_cursor
	is
		p_total_oi							epic.epic_col_types.number_9%type;
		p_total_si							epic.epic_col_types.number_9%type;
		p_total_ssn							epic.epic_col_types.number_9%type;
		p_total_name						epic.epic_col_types.number_9%type;
		p_result                			epic.epic_col_types.number_9%type;
		p_result_msg            			epic.epic_col_types.varchar_255%type;
		--
		vCur						epic.epp_generic_ref_cursor.ref_cursor;
		v_request					epic.eh_temp_matching_offenders.request_id%type;
		--
		--	function to check if a parameter is different
		--
		function IsDiff (
			p_arg					varchar2,
			p_old					varchar2)
		return boolean
		is
		begin
			logit('checking [' || p_arg || '] against [' || p_old || ']');
			if p_arg is null and p_old is not null then
				return true;
			elsif p_arg is not null and p_old is null then
				return true;
			elsif p_arg is null and p_old is null then
				return false;
			else
				return p_arg <> p_old;
			end if;
		end;
	begin
		logit(to_char(sysdate, 'SSSSS') || '- matching offenders called');
		--	if any parameters changed, or 0 count, call count again
		if p_user_int_id <> vlUserIntId or
			IsDiff(p_offender_id, vlOffenderId) or
			IsDiff(p_state_id, vlStateId) or
			IsDiff(p_ssn, vlSSN) or
			IsDiff(p_name_last, vlNameLast) or
			IsDiff(p_name_first, vlNameFirst) then
			--	regen list
			count_match_ofndrs (
				p_user_int_id,
				p_offender_id,
				p_state_id,
				p_ssn,
				p_name_last,
				p_name_first,
				p_total_oi,
				p_total_si,
				p_total_ssn,
				p_total_name,
				p_result,
				p_result_msg);
		end if;
		--	populate temp table for select
		v_request := epic.epic_ids.new_epic_id;
		for i in 1..lPersons
		loop
			if vPersons(i).score > 0 then
				insert into macomb.eh_temp_matching_offenders
					(request_id, identity_id, score)
				values
					(v_request, vPersons(i).identity_id, vPersons(i).score);
			end if;
		end loop;
		--	try analysis
--		logit(to_char(sysdate, 'SSSSS') || '- analyzing temp table');
--		commit;
--		execute immediate 'analyze table eh_temp_matching_offenders compute statistics';
		--	return result set
		logit(to_char(sysdate, 'SSSSS') || '- opening cursor');  
		-- joe update this to add link to image
		open vCur for
			select /*+ RULE */
				PI.entity_id				as entity_id,
				PI.name_family				as name_family,
				PI.Name_first				as name_first,
				PI.Name_other				as name_other,
				PI.NAME_SUFFIX				as name_suffix,
				EP.code_gender				as code_gender,
				ER.code_race				as code_race,
				EPIC.ef_EPIC_DATE_TO_DATE(PI.DATE_OF_BIRTH)	as date_of_birth,
				PI.IDENTITY_ID				as identity_id,
				OI.state_ID					as state_id,
				oi.offender_ID				as offender_id,
				EP.DECEASED_FLAG			as deceased_flag,
				PI.SOCIAL_SECURITY_NUMBER	as social_security_number,
				ep.juvenile_flag			as juvenile_flag,
				substr(epic.ef_can_read(p_user_int_id,'OFFENDER DETAILS',pi.entity_id),1,1) as CanReadOffender,
				es.Code_Entity_Status       as code_entity_status,
				es.Code_Custody_Status      as Code_Custody_Status,
				decode(ei.imageref, null,null,
				'\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
			 	decode(pi.identity_id, ep.primary_identity_id,null, 'ALIAS') as alias --------------------RAS: ADDED TO SHOW ALIAS NAME TYPE ON INMATE SEARCH SCREEN
			from
				macomb.eh_temp_matching_offenders mo,
				epic.EH_Person_Identity PI,
				epic.EH_Offender_IDs OI,
				epic.EH_ENTITY_PERSON EP,
				epic.eh_entity_status es,
				epic.EH_ENTITY_RACE ER,
				epic.Eh_entity_default_photo ph,
				epic.Epicvolume ev,
				epic.Epicimage ei
			where
				mo.request_id = v_request
				and pi.identity_id = mo.identity_id
				and ep.entity_id = pi.entity_id
				and er.entity_id(+) = pi.entity_id
				and oi.entity_id(+) = pi.entity_id
				and ES.Entity_ID(+) = PI.Entity_ID 
			    and  ei.imageref(+) = ph.photo_id
			    and  ev.volumeid(+) = ei.volumeid
			    and  ph.entity_id(+) = pi.entity_id
				
			order by mo.score desc;
		--	clear temp set
		logit(to_char(sysdate, 'SSSSS') || '- deleting temp records');
		delete from macomb.eh_temp_matching_offenders
			where request_id = v_request;
		commit;
		--
		logit(to_char(sysdate, 'SSSSS') || '- exiting matching_offenders');
		return vCur;
	end;
	--
	--
	--	procedure to return a list of similar names matching a given name
	--
	--
	procedure will_match (
		p_name_first				in		epic.eh_person_identity.name_first%type,
		p_matching_names			in out	epic.epic_col_types.varchar_2000%type)
	is
	--
	--	note - returns a one-char gender, then list of names separated by "|" chars
	--		up to 2000 characters long
	--
	begin
		p_matching_names := similar_names(p_name_first);
	end;
	--
end mpk_matching_offenders;
/

CREATE OR REPLACE
PROCEDURE        mpr_avgdailypop
	(p_StartDate	IN		EPIC.eh_housing_assignments.action_time%type,
	 p_EndDate		IN		EPIC.eh_housing_assignments.action_time%type,
	 p_Cur 			IN OUT 	EPIC.epp_generic_ref_cursor.ref_cursor) 

IS
/*	Form Usage: 	CRSTL.YY81
	Crystal: 		AvgDailyPop.rpt
	Purpose:		Used by the administration to calculate the average daily population of the 
					jail for the given time period

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/13/07		Created
*/

	
BEGIN
	MACOMB.mpk_avgdailypop.calculate(p_StartDate, p_EndDate, p_cur);
END;
/

CREATE OR REPLACE
PROCEDURE        mpr_BkDspCard
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_EntityID		in		EPIC.eh_entity_person.entity_id%type,
		p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
IS
/*	
	Form Usage: 	CRSTL.XX60
	Crystal: 		BkDispCard.rpt
	Purpose:		To notify booking to prepare an inmate for release, along with the information
					needed to process the release

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/15/06		Created
*/
BEGIN

	OPEN vCur FOR
    	SELECT	EPIC.ef_offender_id(b.entity_id) as InmateNum,
				MACOMB.mcmb_fnt_alphabin_current(b.entity_id) as PropertyNum,
				EPIC.ef_offender_cell(b.entity_id) as RoomNum,
				EPIC.ef_offender_1st_last_name(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_primarycharge(b.booking_id) as Offense,
				EPIC.ef_get_username1stlast(p_UserID) as ReleasedBy,     --<input prompt based on current user> 
				--Orders of (Free text)
				--ReasonReleased (Free text)
				--ReleasedTo (Free text)
				--Received by (Signature)
				to_char(sysdate, 'MM/DD/YYYY') as DateOut,
				--Time Out (Free text)
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY') as DateIn,
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'HH12:MI AM') as TimeIn,
				--Remarks (Free text)
				MACOMB.mcmb_fnt_inmatefunds(b.entity_id) as Money

		FROM	EPIC.eh_active_booking b,
				EPIC.eh_booking bk

		WHERE	b.booking_id = bk.booking_id
				and b.entity_id = p_EntityID;  --<input prompt based on current inmate>   

END;   
/

CREATE OR REPLACE
PROCEDURE        mpr_cmhExtract
	(vCur 	out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	Scheduled report on Crystal Report Server
	Crystal: 		CMHExtract.rpt
	Purpose:		Used by Community Mental Health (CMH) to import Offendertrak/inmate data into their system
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/01/06		Created
					R. Stuve	05/03/06		Compiled OTMAIN 	
*/			
BEGIN 
	OPEN vCur FOR 
	    SELECT	rpad(NVL(EPIC.ef_offender_id(ab.entity_id),' '),7,' ') || (select substr(rpad(NVL(ep.name_family,' '),20,' '),1,20) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || (select substr(rpad(NVL(ep.name_first,' '),15,' '),1,15) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 )
	    ||(select substr(rpad(NVL(ep.name_other,' '),15,' '),1,15) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || (select NVL(to_char(EPIC.ef_epic_date_to_date(ep.date_of_birth), 'YYYYMMDD'),'        ') from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 )
	    ||(select NVL(ep.social_security_number,'         ') from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || substr(NVL(EPIC.ef_get_security_class(ab.entity_id),'  '),1,2) || (select NVL(to_char(EPIC.ef_epic_date_to_date(b.start_date), 'YYYYMMDD'),'        ') from EPIC.eh_booking b where b.booking_id = ab.booking_id)
	    || substr(rpad(NVL(MACOMB.mcmb_fnt_inmatestatus(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)),' '),30,' '),1,30) || substr(rpad(NVL(MACOMB.mcmb_fnt_statutetext(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)), ' '),40,' '),1,40) || substr(rpad(lpad(NVL(MACOMB.mcmb_fnt_CountHolds(ab.entity_id),'00'),2,'0')||'HOLDS',7,' '),1,7) || substr(rpad(NVL(MACOMB.mcmb_fnt_statutenumber(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)),' '),15,' '),1,15) as Field

		FROM	EPIC.eh_active_booking ab

		ORDER BY 1;     	
END;
/

CREATE OR REPLACE
PROCEDURE        mpr_Detainer
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_EntityID		in		EPIC.eh_entity_person.entity_id%type,
		p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
IS
/*	
	Form Usage: 	CRSTL.XX62
	Crystal: 		Detainer.rpt
	Purpose:		To notify another agency (who is borrowing the inmate from MCSO on a WRIT) that 
					the inmate is needed back and the agency should not release him/her

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    09/25/06		Created
*/
BEGIN

	OPEN vCur FOR
		SELECT	INITCAP(EPIC.ef_get_personororgname(ab.entity_id)) as Prisoner,      --link to current inmate
				INITCAP(MACOMB.mcmb_fnt_alias(ab.entity_id)) as AKAs,
				to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_final_release_date(ab.booking_id)), 'MM/DD/YYYY') as OverallOutDate,
					--the above needs to be final release date from the release date tab
				'$' || MACOMB.mf_bailtotal_unsent(ab.booking_id) as OverallBond,
		        MACOMB.mf_NextCourtDate(ab.booking_id) as OverallCourtDate,
				MACOMB.mcmb_fnt_statutetext(c.charge_id) as Charge,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as Case#,
		        NVL(to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_SentEndDate(c.charge_id)),'MM/DD/YYYY'),'$' || MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as OutdateBond,
		        	--be sure to verify this against pay-or-stay 
		        INITCAP(EPIC.ef_get_username1stlast(p_UserID)) as MCSDOfficer,     --<input prompt based on current user>  
		        --WRIT Officer (blank field on Crystal report)
				--Badge # (blank field on Crystal report)
				--WRIT date (blank field on Crystal report)
				--Dept & Section (blank field on Crystal report)
				EPIC.ef_offender_id(ab.entity_id) as Descriptor#
				--Phone# (blank field on Crystal report)
				--Other Remarks (blank field on Crystal report)	

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c

		WHERE	ab.booking_id = c.booking_id
				and c.charge_state <> '6'
				and ab.entity_id = p_EntityID  --<input prompt based on current inmate> 
				
		ORDER BY c.index_number;
		 

END;   
/

CREATE OR REPLACE
PROCEDURE        mpr_DispFaceShtBk
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_booking.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ72
	Crystal: 		DispInmateFaceSheetBK_sub.rpt (Sub Report: Part 2 of 3). Main report: DisposedFaceSheet_Main.rpt
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
					in regards to disposed charges only. This report also uses the same procedures for
					demographics & holds as the original Inmate Profile Sheet (mcmb_rpt_facesheetdemo;
					mcmb_rpt_faceshetholds)
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	09/28/06		Created 
					R. Stuve	11/21/06		Added Next Court Date (per SRF 12791)				
					
*/
 				
BEGIN 
	OPEN vCur FOR
	SELECT	to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY') as BookingDate,
			substr(EPIC.ef_epic_date_to_date(bk.start_date),12,5) as BookingTime,
			bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
			MACOMB.mf_NextCourtDate_Charge(ch.charge_id) as NextCourtDate, 
			MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
			to_char(EPIC.ef_epic_date_to_date(ch.offense_date), 'MM/DD/YYYY') as OffenseDate,
			MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
			MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
			MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
			to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_SentEndDate(ch.charge_id)), 'MM/DD/YYYY') as SentenceEndDate,
			EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
			to_date(MACOMB.mcmb_fnt_DispoDate(ch.charge_id)) as DispoDate,
			bk.entity_id as EntityID

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch
		
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.charge_state = '6'
			and bk.entity_id = p_InmateID
	
	ORDER BY DispoDate desc, OffenseDate desc, ch.index_number desc;
END;
/

CREATE OR REPLACE
PROCEDURE mpr_HistPublic_Book
 (	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ38
	Crystal: 		HistPublicListBk_sub.rpt (Sub Report: Part 2 of 2)
	Purpose:		Used by General Office when there is a public request for an inmate's history. Does not 
					show expunged or non-public charges.
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/03/07	Created 					
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    to_char(to_date(MACOMB.mcmb_fnt_DispoDate(ch.charge_id)), 'MM/DD/YYYY') as DispoDate,
		    EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate,
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    MACOMB.mf_GA_Charge(ch.charge_id, 'HELD FOR') as HeldFor,
			MACOMB.mf_GA_Charge(ch.charge_id, 'BONDING AGENCY') as BondingAgency,
			MACOMB.mf_GA_Charge(ch.charge_id, 'PACC CODE') as PACCCode,
			MACOMB.mf_GA_Charge(ch.charge_id, 'DIST VENUE') as DistVenue,
			MACOMB.mf_GA_Charge(ch.charge_id, 'CONVICTION SET ASIDE NON PUBLIC') as Conviction,
			MACOMB.mf_GA_Bail(ch.charge_id, 'COURT DISPOSITION') as CourtDispo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'EDUCATIONAL RELEASE') as EducRls,
			MACOMB.mf_GA_Sent(s.sentence_id, 'MISC SENTENCE INFO') as MiscSentInfo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'RESTITUTION JUDGEMENT AMOUNT') as RestJudAmt,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WEEKENDER RELEASE TIME') as WeekenderRlsTime,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK RELEASE GRANTED') as WorkRlsGranted,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK SEEK') as WorkSeek

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID 
			and not(MACOMB.mf_nonpblccharge(ch.charge_id) = 'Y' or MACOMB.mf_expngdcharge(ch.charge_id) = 'Y')

	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE mpr_HistPublic_Demo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ38
	Crystal: 		HistPublicList_Main.rpt (Main Report: Part 1 of 2)
	Purpose:		Used by General Office when there is a public request for an inmate's history. Does not 
					show expunged or non-public charges.
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/03/07		Created  
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID;

END;
/

CREATE OR REPLACE
PROCEDURE mpr_NmAsscData
	(vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	v_FirstName		IN		varchar2,
	v_LastName		IN		varchar2)
	 	
IS
   
 /*	Form Usage:		linked to Crystal Enterprise server
 	Crystal: 		NmAsscData.rpt 
	Purpose:		Used by the Jail Administration to list all of the potential matches of external people
					and the inmates he/she is associated with

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/06		Created   
					R. Stuve	01/23/07		Commented out one name match and employer organization queries (per Sgt. Roberts)
					R. Stuve	01/25/07		Added RelatedRole field 
					R. Stuve	02/07/07		Commented out reversal of names to increase report speed
*/

p_FirstName	varchar2(100);
p_LastName	varchar2(100);
v_location	EPIC.epic_locations.location_id%type;
	
BEGIN

p_FirstName := '%' || UPPER(v_FirstName) || '%';
p_LastName := '%' || UPPER(v_LastName) || '%'; 

--get the location_id for 'MCJ' 
BEGIN	
	SELECT	location_id
	INTO	v_location
	FROM	EPIC.epic_locations
	WHERE 	location_name = 'MCJ';
END;	
  		
OPEN vCur FOR 
	--Visitors and Contacts--Two Name Match
	SELECT distinct	EPIC.ef_offender_id(er.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(er.entity_id) as InmateName,
			EPIC.ef_get_personororgname(er.entity_related_to) as ContactName,
			CASE er.relationship_type WHEN '_NOSP' THEN 'VISITOR'
				ELSE EPIC.ef_lookup_text('PERSONAL RELATIONSHIP',er.relationship_type,'UC') END as RelationshipType,
			DECODE (er.related_as_role, 'CNCT','CONTACT','CNTCT','CONTACT','VISTR','VISITOR','CONTACT') as RelatedRole,
			'Two Name Match' as Match
	
	FROM	EPIC.eh_entity_relationship er
	
	WHERE	er.entity_id <> v_location --facility visitors are handled elsewhere
			and (
				--first and last name match inputs (first = first; last = last)
				(substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_LastName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),',')+1) like p_FirstName)
	    	/*	--first and last name match inputs (first = last; last = first): for times where first & last may have been reversed
	    		or (substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_FirstName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),',')+1) like p_LastName)*/)
/*			
	--------------
	UNION ALL
	--------------
	--Visitors and Contacts--One Name Match
	SELECT distinct	EPIC.ef_offender_id(er.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(er.entity_id) as InmateName,
			EPIC.ef_get_personororgname(er.entity_related_to) as ContactName,
			CASE er.relationship_type WHEN '_NOSP' THEN 'VISITOR'
				ELSE EPIC.ef_lookup_text('PERSONAL RELATIONSHIP',er.relationship_type,'UC') END as RelationshipType,
			'One Name Match' as Match
	
	FROM	EPIC.eh_entity_relationship er
	
	WHERE	er.entity_id <> v_location --facility visitors are handled elsewhere
			and (
				--last name matches where first name is null
				(substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_LastName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),' ')+1) is null)
	    		--first name matches where last name is null
	    		or (substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) is null
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),' ')+1) like p_FirstName))
*/			
	--------------
	UNION ALL
	--------------
	--Employer Contacts--Two Name Match
	SELECT distinct EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.contact_person_id) as ContactName,
			'EMPLOYER CONTACT' as RelationshipType,
			null as RelatedRole,
			'Two Name Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	--first and last name match inputs (first = first; last = last)
			(substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_LastName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')+1) like p_FirstName)
			/*--first and last name match inputs (first = last; last = first): for times where first & last may have been reversed
	    	or (substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_FirstName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')+1) like p_LastName)*/
/*	
	--------------
	UNION ALL
	--------------
	--Employer Contacts--One Name Match
	SELECT	EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.contact_person_id) as ContactName,
			'EMPLOYER CONTACT' as RelationshipType,
			'One Name Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	--last name matches where first name is null
			(substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_LastName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),' ')+1) is null)
	    	--first name matches where last name is null
	    	or (substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) is null
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),' ')+1) like p_FirstName)
	
	--------------
	UNION ALL
	--------------
	--Employer Organizations--Employer Match (on both names)
	SELECT distinct EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.organization_id) as ContactName,
			'EMPLOYER' as RelationshipType,
			'Employer Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	EPIC.ef_get_personororgname(organization_id) like p_LastName
			and EPIC.ef_get_personororgname(organization_id) like p_FirstName
	
*/	
	ORDER BY Match, ContactName, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE mpr_NmAsscData2
	(vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	v_FirstName		IN		varchar2,
	v_LastName		IN		varchar2)

IS

 /*	Form Usage:		linked to Crystal Enterprise server
 	Crystal: 		NmAsscData2.rpt (sub report)
	Purpose:		Used by the Jail Administration to list all of the potential matches of external people
					and the inmates he/she is associated with

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/06		Created
					R. Stuve	01/23/07		Modified WHERE clause to include 'and' instead of 'or' for FN/LN parameters
					R. Stuve	02/07/07		Removed from the Crystal report: may be added at a later time.
	
*/

p_FirstName	varchar2(100);
p_LastName	varchar2(100);
v_location	EPIC.epic_locations.location_id%type;

BEGIN

p_FirstName := '%' || UPPER(v_FirstName) || '%';
p_LastName := '%' || UPPER(v_LastName) || '%'; 

--get the location_id for 'MCJ' 
BEGIN	
	SELECT	location_id
	INTO	v_location
	FROM	EPIC.epic_locations
	WHERE 	location_name = 'MCJ';
END;

OPEN vCur FOR
	--Facility Visitors
	SELECT 	distinct EPIC.ef_get_personororgname(pi.entity_id),
			'FACILITY VISITORS' as Match

	FROM	EPIC.eh_entity_person ep,
			EPIC.eh_person_identity pi,
			EPIC.eh_entity_relationship er

	WHERE   er.entity_id = v_location 
			and er.related_as_role = 'VISTR'
            and ep.entity_id = er.entity_related_to
            and pi.identity_id = ep.primary_identity_id
            and EPIC.ef_get_personororgname(pi.entity_id) like p_LastName
            and EPIC.ef_get_personororgname(pi.entity_id) like p_FirstName

 	---------------
 	UNION ALL
 	---------------
 	--Official Visitors
 	SELECT 	distinct EPIC.ef_get_personororgname(pi.entity_id),
 			'OFFICIAL VISITORS' as Match

	FROM	EPIC.eh_entity_person ep,
			EPIC.eh_person_identity pi,
			EPIC.eh_entity_relationship er

	WHERE	er.related_as_role = 'OFFVISTR'
            and ep.entity_id = er.entity_related_to
            and pi.identity_id = ep.primary_identity_id
 	        and EPIC.ef_get_personororgname(pi.entity_id) like p_LastName
            and EPIC.ef_get_personororgname(pi.entity_id) like p_FirstName;

END;
/

CREATE OR REPLACE
PROCEDURE        MPR_ProofOfIncar
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,  
	    p_Entity_ID		in		EPIC.eh_booking.booking_id%type,
	    p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
	 	
IS

/*	Form Usage: 	CRSTL.XX61
	Crystal: 		ProofOfIncar.rpt
	Purpose:		Letter written up, on release from booking officer
	                Inmate Proof of Incarecartion


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	    02/17/05	Created
					M.Zak           03/09/06    Modified  
					R. Stuve		03/22/06 	Modified: formatted CurUsrSign so that name would display as FirstInitial.LastName
*/
	
		
			
BEGIN  

OPEN vCur FOR
		--the below query pulls back the actual report data		
SELECT	EPIC.ef_offender_1st_last_name(p_Entity_ID) as CurInmate, 
		EPIC.ef_epic_date_to_date(bk.start_date) as BkStDtTm,
		EPIC.ef_epic_date_to_date(r.actual_release) as BkEndDtTm,
		--EPIC.EF_Get_UserName1stLast(p_UserID) as CurUsrSign,   previous formatting: changed per above (RAS 3/22/06)
		substr(EPIC.ef_Get_UserName1stLast(p_UserID),1,1) || '. ' || substr(EPIC.ef_get_username1stlast(p_UserID),instr(EPIC.ef_get_username1stlast(p_UserID),' ',1)+1) as CurUsrSign,
		EPIC.ef_user_title_by_int_id(p_UserID) as CurUsrSignTitle

FROM	EPIC.eh_booking bk,
		EPIC.eh_release r

WHERE	bk.entity_id = p_Entity_ID
		and bk.booking_id = r.booking_id
		and bk.booking_id = MACOMB.MF_Bookid_Most_Recent(p_Entity_ID);  --maz added function MF_Bookid_Most_Recent
		
END;  
--RAS
/

CREATE OR REPLACE
PROCEDURE mp_AliasUpdate
	 (	p_ArID		IN	MACOMB.mt_pb_person_alias.arrest_id%TYPE,
	 	p_AliID		IN	MACOMB.mt_pb_person_alias.alias_id%TYPE,
	 	p_FNm		IN	MACOMB.mt_pb_person_alias.firstname%TYPE,
	 	p_LNm		IN	MACOMB.mt_pb_person_alias.lastname%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Updates the MACOMB.mt_pb_person_alias table based on input information
					This procedure is called by MACOMB.mp_pb_arrest4

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 03/21/06		Created
					R. Stuve	 08/02/06		Added: p_AliID for passed in alias ID
	
*/ 
v_OT		MACOMB.mt_pb_person_alias.ot_data%TYPE; 

BEGIN 
	BEGIN
		INSERT INTO MACOMB.mt_pb_person_alias (alias_id, arrest_id, firstname, lastname, nametype, ot_data)
		VALUES (p_AliID,
				p_ArID,
				p_FNm,
				p_LNm,
				'ALI',
				'N');
	EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
	 		UPDATE MACOMB.mt_pb_person_alias
				SET firstname = p_FNm,
			 		lastname = p_LNm,
					nametype = 'ALI'
				WHERE alias_id = p_AliID;
	END;

COMMIT;
END;  
/

CREATE OR REPLACE
FUNCTION mp_AuditCell
	 (p_entity_id 	IN 	EPIC.eh_entity_person.entity_id%TYPE) 
	 
 /*	
	System: 		
	Purpose:		Returns the last/most current inmate's cell prior to being released

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 03/14/06		Created 
	
*/  	 
RETURN EPIC.epic_col_types.varchar_255%TYPE  
IS

  CURSOR curCell IS 
  	SELECT 	DISTINCT EPIC.ef_location_name(ha.location_id, 'UC')
  	
	FROM 	EPICAUDIT.eh_housing_assignments ha
			
	WHERE	ha.entity_id = p_entity_id
			AND ha.muster_display_flag = 'Y'
			AND ha.action_time = (SELECT MAX(h2.action_time)
								FROM EPICAUDIT.eh_housing_assignments h2
								WHERE h2.entity_id = ha.entity_id);
     
     
v_Cell		EPIC.epic_col_types.varchar_255%TYPE;


BEGIN
  	OPEN curCell;
  	FETCH curCell INTO v_Cell;
  		IF curCell%found THEN
  			CLOSE curCell;
  			RETURN v_Cell;
  		END IF;
  	
  	CLOSE curCell;
	
	RETURN '-No Cell-';
	 	
END;
/

CREATE OR REPLACE
procedure        MP_AUTO_JIL_Alert_REG_test
is   

	v_message				varchar2(1800);
	v_status				integer;
	v_timeout				number;
	v_error_count			integer := 0;
	v_which_alert			varchar2(1800);

	v_module				varchar2(64);
    v_count                 number;
    
begin
	--
	--	register alert
	--
    dbms_output.put_line('REGISTERING');
		dbms_alert.register('INMATE');
    dbms_output.put_line('REGISTERED');  
	v_count := 1;
     commit;
	while true
	loop
		--
		--	trap errors here if possible
		--
		begin
			--
			--	wait for an alert
			--   
			v_timeout := 3;	--	wake up in 30 seconds, anyway...
		    dbms_output.put_line('WAIT');

			dbms_alert.waitany(v_which_alert,
                    v_message,
                    v_status,
                    v_timeout);
            --
            --	first, check if alert and terminate message
            -- 
		    dbms_output.put_line('GOT SOMETHING, '|| v_which_alert|| ' '|| v_message||' eot');
            if v_status = 1 then
			    dbms_output.put_line('timeout');
   				v_count := v_count+1;  
				if v_count > 30 then           
				    dbms_output.put_line('EXIT THE LOOP'); 
				    DBMS_ALERT.remove('INMATE');
					exit;
				end if;         
			else
			    dbms_output.put_line('signal');
            	IF v_which_alert = 'INMATE' then
					 insert into MACOMBSIGNAL
					(SIGNAME, PROGNAME)
					values
					(upper(v_which_alert),'2');  
					v_count := 40;			
					commit;		
				else 
				    dbms_output.put_line('Other alert'|| v_which_alert|| ' '|| v_message);
					v_module := 'JIL UN-REGISTERED ALERT';                         
					v_count := v_count + 1;
				end if;     
				exit;
            end if;
		end;
	END loop;   
END;
/

CREATE OR REPLACE
procedure        MP_AUTO_JIL_Alert_test
is   

	c_stop_alert			constant varchar2(255) := 'IOMS$TERMINATE';
	c_stop_JIL_alert		constant varchar2(255) := 'JIL$TERMINATE';
	v_debug					boolean := false;
	--
	v_message				varchar2(32767);
	v_status				integer;
	v_timeout				number;
	v_error_count			integer := 0;
	p_result				epic.epic_col_types.number_9%type;
	p_result_msg			epic.epic_col_types.varchar_255%type;
	v_transaction_id		varchar2(255);
	v_temp					epic.epic_configuration.config_value%type;
	v_which_alert			varchar2(32767);

	v_module				varchar2(64);
	v_synch_flag			char(1);
    v_count                 number;

begin
--	mpp_jil_test.init;
--	commit work;
	--
	--	register alert
	--
--    dbms_output.put_line('REGISTERING');

--	dbms_alert.register(mpp_jil_test.cs_JIL_ALIAS_alert);
--	dbms_alert.register(mpp_jil_test.cs_JIL_INMATE_alert);
--	dbms_alert.register(mpp_jil_test.cs_JIL_CHARGE_alert);
--	dbms_alert.register(mpp_jil_test.cs_JIL_VISITOR_alert);
--	dbms_alert.register(mpp_jil_test.cs_JIL_RELEASE_alert);
--	dbms_alert.register(mpp_jil_test.cs_JIL_PHOTO_alert);
    dbms_output.put_line('WAITONE');

	--dbms_alert.register(epp_vine.cs_vine_synch_alert);
	--
	--	register for termination alert
	--
--	dbms_alert.register(c_stop_alert);
	--
	--	now, fire one alert to start processing
	--
/*	dbms_alert.signal(mpp_jil_test.cs_JIL_ALIAS_alert, null);
	dbms_alert.signal(mpp_jil_test.cs_JIL_INMATE_alert, null);
	dbms_alert.signal(mpp_jil_test.cs_JIL_CHARGE_alert, null);
	dbms_alert.signal(mpp_jil_test.cs_JIL_VISITOR_alert, null);
	dbms_alert.signal(mpp_jil_test.cs_JIL_RELEASE_alert, null);
	dbms_alert.signal(mpp_jil_test.cs_JIL_PHOTO_alert, null);*/
--	dbms_alert.signal(epp_vine.cs_vine_alert, null);
--	dbms_alert.signal(epp_vine.cs_vine_synch_alert, null);

	--
	--	must commit work, or signal will hang
	--
--	commit work;
	--
	--
	--	main loop - wait for alert or termination signal
	--
	--                             
	v_count := 1;
	while true
	loop
		--
		--	trap errors here if possible
		--
--		begin
			--
			--	wait for an alert
			--   
			v_timeout := 30;	--	wake up in 30 seconds, anyway...
		    dbms_output.put_line('WAIT');
			
			dbms_alert.waitone('JIL_INMATE',
                    v_message,
                    v_status,
                    v_timeout);
            --
            --	first, check if alert and terminate message
            -- 
                                                                                
		    dbms_output.put_line('Status '|| to_char(v_status));
		    dbms_output.put_line('GOT SOMETHING! '|| v_which_alert|| ' '|| v_message||' eot');
		    --dbms_output.put_line(nvl(v_message,'NULL IS IT'));
            if v_status = 1 then
   				v_count := v_count+1;  
				if v_count > 3 then 
					exit;
				end if;         
			else
            	IF v_which_alert = 'JIL_INMATE' then
					 insert into MACOMBSIGNAL
					(SIGNAME, PROGNAME)
					values
					(upper(v_which_alert),'2');
				else 
				    dbms_output.put_line('Other alert'|| v_which_alert|| ' '|| v_message);
					v_module := 'JIL UN-REGISTERED ALERT       ';                         
					-- insert into MACOMBSIGNAL
					--(SIGNAME, PROGNAME)
					--values
					--(upper(v_which_alert),'E');
				end if;     
				commit work;
				exit;
            end if;

--		end;
	END loop;   
    dbms_output.put_line('REMOVE');
	dbms_alert.REMOVE('JIL_INMATE');
end;
/

CREATE OR REPLACE
procedure        MP_AUTO_JIL_Alert_test_ins
is   


begin
	    DBMS_ALERT.SIGNAL('INMATE', 'Joe is the best');
	    commit;
end;
/

CREATE OR REPLACE
procedure        MP_AUTO_JIL_Alert_test_REMOVE
is   


begin
	    DBMS_ALERT.removeALL;
end;
/

CREATE OR REPLACE
PROCEDURE        mp_get_current_statutes (
	p_filter_number				in		EPIC.epic_col_types.varchar_255%type,
	p_filter_description		in		EPIC.epic_col_types.varchar_255%type,
	p_code_id					in		EPIC.epic_statutes.code_id%type,
	p_result					in OUT  EPIC.epp_generic_ref_cursor.ref_cursor)
is
--	cur_result				epp_generic_ref_cursor.ref_cursor;
	v_date					EPIC.epic_statutes.expiration_date%type;
begin
	v_date := EPIC.epicdatenow;
	if LENGTH(p_filter_number) > 2 then
		if length(p_filter_description) > 2 then
			if length(p_code_id) > 0 then
				open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
					FROM EPIC.EPIC_STATUTES s,
    	    		     EPIC.EH_CATEGORY_STATUTE c,
		 				 EPIC.EH_STATUTE_CATEGORY es
					WHERE
			      			es.statute_category_id = c.statute_category_id
						and c.statute_id = s.statute_id				
						and	s.statute_number like p_filter_number
						and s.statute_description like p_filter_description
						and s.code_id = p_code_id
						and (s.expiration_date is null or s.expiration_date > v_date)
						and s.effective_date <= v_date
					ORDER BY s.STATUTE_NUMBER;
			else
				open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
					FROM EPIC.EPIC_STATUTES s,
    	    		     EPIC.EH_CATEGORY_STATUTE c,
		 				 EPIC.EH_STATUTE_CATEGORY es
					WHERE
			      			es.statute_category_id = c.statute_category_id
						and c.statute_id = s.statute_id				
						and s.statute_number like p_filter_number
						and s.statute_description like p_filter_description
						and (s.expiration_date is null or s.expiration_date > v_date)
						and s.effective_date <= v_date
					ORDER BY s.STATUTE_NUMBER;
			end if;
		else
			if length(p_code_id) > 0 then
				open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
					FROM EPIC.EPIC_STATUTES s, 
    	    		     EPIC.EH_CATEGORY_STATUTE c,
		 				 EPIC.EH_STATUTE_CATEGORY es
					WHERE
			      			es.statute_category_id = c.statute_category_id
						and c.statute_id = s.statute_id				
						and s.statute_number like p_filter_number
						and s.code_id = p_code_id
						and (s.expiration_date is null or s.expiration_date > v_date)
						and s.effective_date <= v_date
					ORDER BY s.STATUTE_NUMBER;
			else
				open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
					FROM EPIC.EPIC_STATUTES s,
    	    		     EPIC.EH_CATEGORY_STATUTE c,
		 				 EPIC.EH_STATUTE_CATEGORY es
					WHERE
				      			es.statute_category_id = c.statute_category_id
							and c.statute_id = s.statute_id				
							and s.statute_number like p_filter_number
							and (s.expiration_date is null or s.expiration_date > v_date)
							and s.effective_date <= v_date
					ORDER BY s.STATUTE_NUMBER;
			end if;
		end if;
	elsif length(p_filter_description) > 2 then
		if length(p_code_id) > 0 then
			open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
				FROM EPIC.EPIC_STATUTES s,
       		     	 EPIC.EH_CATEGORY_STATUTE c,
		 			 EPIC.EH_STATUTE_CATEGORY es
				WHERE
				      es.statute_category_id = c.statute_category_id
					and c.statute_id = s.statute_id				
					and s.statute_description like p_filter_description
					and s.code_id = p_code_id
						and (s.expiration_date is null or s.expiration_date > v_date)
						and s.effective_date <= v_date
				ORDER BY s.STATUTE_NUMBER;
		else
			open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
				FROM EPIC.EPIC_STATUTES s,
        		     EPIC.EH_CATEGORY_STATUTE c,
	 				 EPIC.EH_STATUTE_CATEGORY es
				WHERE
				      es.statute_category_id = c.statute_category_id
					and c.statute_id = s.statute_id				
					and s.statute_description like p_filter_description
					and (s.expiration_date is null or s.expiration_date > v_date)
					and s.effective_date <= v_date
				ORDER BY s.STATUTE_NUMBER;
		end if;
	else
		if length(p_code_id) > 0 then
			open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
				FROM EPIC.EPIC_STATUTES s,
        		     EPIC.EH_CATEGORY_STATUTE c,
		 			 EPIC.EH_STATUTE_CATEGORY es
				WHERE
				      es.statute_category_id = c.statute_category_id
					and c.statute_id = s.statute_id				
					and s.code_id = p_code_id
					and (s.expiration_date is null or s.expiration_date > v_date)
					and s.effective_date <= v_date
				ORDER BY s.STATUTE_NUMBER;
		else
			open p_result for
				SELECT s.STATUTE_ID, s.CODE_ID, s.STATUTE_NUMBER, s.STATUTE_DESCRIPTION, s.CODE_STATUTE_CLASS, s.EXPIRATION_DATE, s.EFFECTIVE_DATE
				FROM EPIC.EPIC_STATUTES s,
        		     EPIC.EH_CATEGORY_STATUTE c,
	 				 EPIC.EH_STATUTE_CATEGORY es
				WHERE
				      es.statute_category_id = c.statute_category_id
					and c.statute_id = s.statute_id				
					and s.expiration_date is null or s.expiration_date > v_date
					and s.effective_date <= v_date
				ORDER BY STATUTE_NUMBER;
		end if;
	end if;
end;
/

CREATE OR REPLACE
PROCEDURE        MP_GET_ORGANIZATIONS
(p_role_code      IN     VARCHAR2, 
 p_cur            IN OUT EPIC.epp_generic_ref_cursor.ref_cursor) 
  AS
 /*	
	System: 		Reports
	Purpose:		Return the bail amount

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
                                J. McBratnie      3.25.2006     Created
*/
begin

		open p_cur for
			select
				eo.entity_id,
				eo.organization_name,
				eo.primary_contact_id,
				er.code_entity_role,
				eo.date_ceased_operating
		    from
		    	EPIC.eh_entity_organization eo,
		    	EPIC.eh_entity_roles er
		    where
		    	eo.entity_id = er.entity_id
		    	and er.code_entity_role = p_role_code
		    order by eo.organization_name;

end;
/

CREATE OR REPLACE
PROCEDURE MP_GVT_Request
	 	
IS

 v_result number;
 v_result_msg varchar2(255);
 v_new_status varchar2(255);
 v_request_id varchar2(255);

--Assign the ID
begin
	v_request_id := EPIC.epic_ids.new_epic_id();

	--Insert the tracking record
 	EPIC.EHI_EH_INTERFACE_REQUEST ( v_request_id,'GVT EXPORT',null,null,-201,-25,	EPIC.epicdatenow(), null,'I',v_result,v_result_msg	);

	--Run the process
  	mcmb_gvt_interface.process_request(v_request_id, v_new_status);
	commit;
end;

/

CREATE OR REPLACE
PROCEDURE mp_jcs_booking_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query 		varchar2(4000) := 'SELECT Cl,''00'',(case when sum(Cnt)<10 then ''0''||sum(cnt) else to_char(sum(cnt)) end),''';
query2		varchar2(8000) := ''',''BK'',substr(Cl,1,1),substr(Cl,3,2) FROM (SELECT count(distinct h.entity_id) as Cnt,EPIC.ef_location_name(h.location_id,''UC'') as Cl FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(h.location_id,''UC'',5) like ''%BOOKING%'' and (EPIC.ef_location_name(h.location_id,''UC'') like ''HC%'' or EPIC.ef_location_name(h.location_id,''UC'') like ''DC%''or EPIC.ef_location_name(h.location_id,''UC'') like ''GYM'') and h.temporary_location_flag = ''N'' ';
qaudit 		varchar2(4000) := 'and EPIC.ef_epic_date_to_date(h.action_time)<=''';
qaudit2		varchar2(4000) := ''' and h.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
grp 		varchar2(4000) := ''')GROUP BY location_id';
qunion 		varchar2(4000) := ' UNION ALL ';
error 		varchar2(4000) := 'SELECT 0 as Cnt,EPIC.ef_location_name(l.location_id,''UC'') as Cl FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%BOOKING%'' and (EPIC.ef_location_name(l.location_id,''UC'') like ''HC%'' or EPIC.ef_location_name(l.location_id,''UC'') like ''DC%'' or EPIC.ef_location_name(l.location_id,''UC'') like ''GYM'')';
auditloc 	varchar2(4000) := 'and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >=''';
auditloc2	varchar2(4000) := ''') and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
auditloc3	varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations e where l.location_id = e.location_id and EPIC.ef_epic_date_to_date(e.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(e.eff_to_date) >=''';
error2 		varchar2(4000) := ') GROUP BY Cl';
blank1 		varchar2(4000) := 'SELECT ''B1'',''00'',''00'',''';
blank1a 	varchar2(4000) := ''',''BK'',''E'',null FROM dual';
blank2 		varchar2(4000) := 'SELECT ''B2'',''00'',''00'',''';
blank2a		varchar2(4000) := ''',''BK'',''E1'',null FROM dual';
blank3 		varchar2(4000) := 'SELECT ''B3'',''00'',''00'',''';
blank3a		varchar2(4000) := ''',''BK'',''E2'',null FROM dual';
blank4 		varchar2(4000) := 'SELECT ''B4'',''00'',''00'',''' ;
blank4a		varchar2(4000) := ''',''BK'',''E3'',null FROM dual';
HCTot 		varchar2(4000) := 'SELECT ''HTot'',''00'',(case when sum(count(distinct h.entity_id))<10  then ''0'' || sum(count(distinct h.entity_id)) else to_char(sum(count(distinct h.entity_id))) end), ''';
HCTot2		varchar2(4000) := ''',''BK'',''A'',''22'' FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(h.location_id,''UC'',5) like ''%BOOKING%'' and EPIC.ef_location_name(h.location_id,''UC'') like ''HC%'' and h.temporary_location_flag = ''N''';
GroupTot 	varchar2(4000) := ' GROUP BY entity_id';
DCTot 		varchar2(4000) := 'SELECT ''DTot'',''00'',(case when sum(count(distinct h.entity_id)) < 10  then ''0'' || sum(count(distinct h.entity_id)) else to_char(sum(count(distinct h.entity_id))) end), ''';
DCTot2		varchar2(4000) := ''',''BK'',''D'',''03'' FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(h.location_id,''UC'',5) like ''%BOOKING%'' and EPIC.ef_location_name(h.location_id,''UC'') like ''DC%'' and h.temporary_location_flag = ''N''';
qOrder 		varchar2(4000) := ' ORDER BY 6 desc,7';

test		varchar2(32767) := query || p_date || query2 || qaudit || p_date || qaudit2 || p_date || grp || qunion || error || auditloc || p_date || auditloc2 ||  p_date ||  auditloc3 || p_date || grp || error2 || qunion || blank1 || p_date || blank1a || qunion || blank2 || p_date || blank2a ||qunion || blank3 || p_date || blank3a ||qunion || blank4 || p_date || blank4a || qunion || HCTot || p_date || HCTot2 || qaudit || p_date || qaudit2 || p_date || ''')'|| grouptot || qunion || DCTot || p_date || DCTot2 || qaudit || p_date || qaudit2 || p_date || ''')'|| grouptot || qOrder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'BK'; 
			 	DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('HC04','HTot','GYM','DTot'); 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		        BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'HC04' or v_cell = 'HTot' or v_cell = 'GYM' or v_cell = 'DTot') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'HC04','A', 'HTot','B', 'GYM','C', 'DTot','D', null));
						END;
					END IF;
			 	END;  
			FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
			END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_botsummary2_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query1 		varchar2(400) := 'SELECT''JUVENILES'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),'''; 
query2		varchar2(4000) := ''',''B2'',''F'',null FROM EPICAUDIT.eh_housing_assignments h,EPICAUDIT.eh_entity_person p WHERE h.entity_id=p.entity_id and p.juvenile_flag=''Y'' and h.temporary_location_flag=''N''and EPIC.ef_epic_date_to_date(p.action_time)<=''';
query3		varchar2(100) := '''and EPIC.ef_epic_date_to_date(h.action_time)<= ''';
query4		varchar2(4000) := '''and h.action_type=''U''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.entity_id=a.entity_id and a.location_id=h.location_id and a.action_type=''D''and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time) <= ''';
query5		varchar2(10)   := ''')';
query6		varchar2(4000) := 'and not exists(select 1 from EPICAUDIT.eh_entity_person e where EPIC.ef_epic_date_to_date(e.action_time)>EPIC.ef_epic_date_to_date(p.action_time) and EPIC.ef_epic_date_to_date(e.action_time)<=''';
query7		varchar2(100) := '''and p.entity_id=e.entity_id)';
query8		varchar2(40)   := ' UNION ALL ';
query9		varchar2(4000) := 'SELECT ''MEDICAL HOSP'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query10		varchar2(4000) := ''',''B2'',''G'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) like ''HOSPITALS%'' and EPIC.ef_location_path_name(location_id,''UC'',6) not like ''%PSYCHIATRIC%'' and h.temporary_location_flag=''N'' and h.action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query11		varchar2(400) := 'SELECT ''PSYCH HOSP'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query12		varchar2(4000) := ''',''B2'',''H'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) like ''%PSYCHIATRIC%''and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query13		varchar2(4000) := 'SELECT ''WRIT'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end), ''';
query14		varchar2(4000) := ''',''B2'',''I'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6)=''WRIT'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query15		varchar2(40)  := ' ORDER BY 5,6';

test		varchar2(32767) := query1 || p_date || query2 || p_date || query3 || p_date || query4 || p_date || query5 || query6 ||  p_date ||  query7 || query8 || query9 || p_date || query10 || p_date || query4 || p_date || query5 || query8 || query11 || p_date || query12 ||  p_date ||  query4 || p_date || query5 || query8 || query13 || p_date || query14 || p_date || query4 || p_date || query5  || query15;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'BS1'; 
			 	DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('JUVENILES','MEDICAL HOSP','PSYCH HOSP','WRIT'); 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		        BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'JUVENILES' or v_cell = 'MEDICAL HOSP' or v_cell = 'PSYCH HOSP' or v_cell = 'WRIT') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'JUVENILES','Q','MEDICAL HOSP','R','PSYCH HOSP','S','WRIT',null));
						END;
					END IF;
			 	END;		 		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_botsummary3_audit
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query1 		varchar2(400)  := 'SELECT ''MALE'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query2		varchar2(4000) := ''',''B3'',''L'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) != ''WRIT'' and MACOMB.mcmb_fnt_gendershort(entity_id)=''M'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query3		varchar2(4000) := ''' and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query4		varchar2(40)   := ''')UNION ALL ';
query5 		varchar2(400) := 'SELECT ''FEMALE'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query6		varchar2(4000) := ''',''B3'',''M'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) != ''WRIT'' and MACOMB.mcmb_fnt_gendershort(entity_id)=''F'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query7	 	varchar2(400) := 'SELECT ''UNKNOWN'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query8		varchar2(4000) := ''',''B3'',''N'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) != ''WRIT'' and MACOMB.mcmb_fnt_gendershort(entity_id)=''U'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query9		varchar2(400)  := 'SELECT ''TOTAL INMATES'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query10		varchar2(4000) := ''',''B3'',''O'',null FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) !=''WRIT'' and temporary_location_flag=''N''and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query11		varchar2(40)  := ''')ORDER BY 5,6';




test		varchar2(32767) := query1 || p_date  || query2 || p_date || query3 || p_date || query4 || query5 || p_date || query6 || p_date || query3 || p_date || query4 || query7 || p_date || query8 || p_date || query3 || p_date || query4 || query9 || p_date || query10 || p_date || query3 || p_date || query11;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'BS1'; 
			 	DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('MALE','FEMALE','TOTAL INMATES'); 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		        BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'MALE' or v_cell = 'FEMALE' or v_cell = 'TOTAL INMATES') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'MALE','U','FEMALE','V','TOTAL INMATES','W',null));
						END;
					END IF;
			 	END;		 		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_botsummary_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query1 		varchar2(4000) := 'SELECT ''PAROLEE'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end), '''; 
query2		varchar2(4000) := ''',''BS'',''A'',null FROM EPICAUDIT.eh_entity_status e,EPICAUDIT.eh_housing_assignments h WHERE e.code_custody_status=''3''';
query3 		varchar2(4000) := 'and e.entity_id = h.entity_id and h.action_type=''U'' and h.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(h.action_time)<=''';
query4		varchar2(4000) := '''and EPIC.ef_epic_date_to_date(e.action_time) <= ''';
query5  	varchar2(4000) := '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.entity_id=a.entity_id and a.location_id=h.location_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time) >= EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time) <= ''';
query6		varchar2(4000) := ''')and not exists(select 1 from EPICAUDIT.eh_entity_status s where EPIC.ef_epic_date_to_date(s.action_time) > EPIC.ef_epic_date_to_date(e.action_time)and EPIC.ef_epic_date_to_date(s.action_time) <= ''';
query7		varchar2(4000) := '''and e.entity_id = s.entity_id)';
query8		varchar2(40)   := ' UNION ALL '; 
query9		varchar2(4000) := 'SELECT ''FEDERAL'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query10		varchar2(4000) := ''',''BS'',''B'',null FROM EPICAUDIT.eh_entity_status e, EPICAUDIT.eh_housing_assignments h WHERE e.code_custody_status=''2''';
query11		varchar2(4000) := 'SELECT ''OTHER'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query12		varchar2(4000) := ''',''BS'',''C'',null FROM EPICAUDIT.eh_housing_assignments h,EPICAUDIT.eh_entity_status e WHERE e.code_custody_status in (''14'',''15'',''16'')';
query13		varchar2(4000) := 'SELECT ''TOTAL CONTRACT INMATES'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query14		varchar2(4000) := ''',''BS'',''D'',null FROM EPICAUDIT.eh_housing_assignments h,EPICAUDIT.eh_entity_status e WHERE e.code_custody_status in (''2'',''3'',''14'',''15'',''16'')';
query15		varchar2(4000) := 'SELECT ''WORK RELEASE'',''00'',(case when count(distinct h.entity_id) < 10 then ''0'' || count(distinct h.entity_id) else to_char(count(distinct h.entity_id)) end),''';
query16		varchar2(4000) := ''',''BS'',''E'',null FROM EPICAUDIT.eh_housing_assignments h,EPICAUDIT.eh_entity_status e WHERE e.code_custody_status=''5''';
query17		varchar2(4000) := ' ORDER BY 5,6';


test		varchar2(32767) := query1 || p_date || query2 || query3 || p_date || query4 || p_date || query5 || p_date || query6 ||  p_date ||  query7 || query8 || query9 || p_date || query10  || query3 || p_date || query4 || p_date || query5 || p_date || query6 || p_date || query7 || query8 || query11 || p_date || query12 || query3 || p_date || query4 || p_date || query5 || p_date || query6 || p_date || query7 || query8 || query13 || p_date || query14 || query3 || p_date || query4 || p_date || query5 || p_date || query6 || p_date || query7 || query8 || query15 || p_date || query16 || query3 || p_date || query4 || p_date || query5 || p_date || query6 || p_date || query7 || query17;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'BS'; 
			 	DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('PAROLEE','FEDERAL','OTHER','TOTAL CONTRACT INMATES','WORK RELEASE'); 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		        BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'PAROLEE' or v_cell = 'FEDERAL' or v_cell = 'OTHER' or v_cell = 'TOTAL CONTRACT INMATES' or v_cell = 'WORK RELEASE') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'PAROLEE','M','FEDERAL','N','TOTAL CONTRACT INMATES','O','WORK RELEASE','P',null));
						END;
					END IF;
			 	END;		 		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_dblock_audit
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''DB'',decode(Cell,''D1PC'',''01'',''D2PC'',''02'',''D3PC'',''03'',''D4PC'',''04'',''D5PC'',''05'',''D6PC'',''06''),substr(Cell,2,2) FROM(SELECT count(distinct ha.entity_id) as Cnt,EPIC.ef_location_name(ha.location_id,''UC'') as Cell FROM EPICAUDIT.eh_housing_assignments ha WHERE (EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%LOW D%''or EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%UPPER D%'') and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, EPIC.ef_location_path_name(l.location_id,''UC'',7) as Cell FROM EPICAUDIT.epic_locations l WHERE (EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%LOW D%'' or EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%UPPER D%'') and EPIC.ef_location_path_name(l.location_id,''UC'',7) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell ';   
lowtot		varchar2(4000) := 'SELECT ''LowDTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D01-D06'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D01-D06'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D01-D06'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''DB'',''07'',''07'' FROM EPICAUDIT.eh_housing_assignments ha	WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',6) like ''LOW D,%'' and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''UpperDTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D07-D12'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D07-D12'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D07-D12'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''DB'',null,''13'' FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',6) like ''UPPER D,%'' and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6,7';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'DB'; 
			 	DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('LowDTotal','UpperDTotal'); 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		        BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'LowDTotal' or v_cell = 'UpperDTotal') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'LowDTotal','E','UpperDTotal','F',null));
						END;
					END IF;
			 	END;		 		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_MS_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 
insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cl,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cl) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cl) else MACOMB.mcmb_fnt_rdccapacity_cell(Cl) end),(case when sum(Ct) < 10 then ''0'' || sum(Ct) else to_char(sum(Ct)) end),''';
query2		varchar2(8000) := ''',''MS'',substr(Cl,3,2),null FROM (SELECT count(distinct h.entity_id) as Ct,substr(EPIC.ef_location_path_name(h.location_id,''UC'',6),1,4) as Cl FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(h.location_id,''UC'',5) like ''%MAX%'' and h.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(h.action_time) <= ''';
query3		varchar2(8000) := ''' and action_type=''U'' and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time) >=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time) <= ''';
groupby		varchar2(30)   := ''') GROUP BY location_id';
qunion		varchar2(16)   := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Ct, substr(EPIC.ef_location_path_name(l.location_id,''UC'',6),1,4) as C1 FROM EPICAUDIT.epic_locations l	WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%MAX%'' and EPIC.ef_location_path_name(l.location_id,''UC'',7) is not null and housing_flag = ''Y'' and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''') and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations e where l.location_id=e.location_id and EPIC.ef_epic_date_to_date(e.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(e.eff_to_date) >= ''';
groupby2	varchar2(30)   := ') GROUP BY Cl';
m1tot		varchar2(4000) := 'SELECT ''M1Tot'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') end),to_char(sum(count(distinct h.entity_id))), ''';
m1tot1		varchar2(4000) := ''',''MS'',''061'',null FROM EPICAUDIT.eh_housing_assignments h WHERE substr(EPIC.ef_location_path_name(h.location_id,''UC'',6),1,4) in (''MS01'',''MS02'',''MS03'',''MS04'',''MS05'',''MS06'') and temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(h.action_time) <= ''';
m1tot2		varchar2(4000) := '''and action_type =''U''and not exists (select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id = a.location_id and h.entity_id = a.entity_id and action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time) >= EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time) <= ''';
totgroup	varchar2(30)   := ''') GROUP BY entity_id';
m2tot		varchar2(4000) := 'SELECT ''M2Tot'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1'') end),to_char(sum(count(distinct h.entity_id))),''';
m2tot1		varchar2(4000) := ''',''MS'',''13'',null FROM EPICAUDIT.eh_housing_assignments h WHERE substr(EPIC.ef_location_path_name(h.location_id,''UC'',6),1,4) in (''MS07'',''MS08'',''MS09'',''MS10'',''MS11'',''MS12'') and temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(h.action_time) <= ''';
m2tot2	    varchar2(4000) := '''and action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time) >= EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time) <= ''';
qorder		varchar2(30)   := ' ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2  || p_date || error3 || p_date || groupby || groupby2 || qunion || m1tot || p_date || m1tot1 || p_date || m1tot2 || p_date || totgroup || qunion || m2tot || p_date || m2tot1 || p_date || m2tot2 || p_date || totgroup  || qorder;

BEGIN
	BEGIN
    	BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'MS'; 
			END IF;
		END;
	OPEN insert_cur FOR test;
	FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
	WHILE insert_cur%FOUND
		LOOP
			BEGIN
				IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	            	BEGIN
						INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
						EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
					END;
				END IF;
			END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
	CLOSE insert_cur;
	COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;
END; 
 

/

CREATE OR REPLACE
PROCEDURE mp_jcs_station23_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''ST'',substr(Cell,1,1), null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_name(ha.location_id,''UC''),1,2) as Cell FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%STATION%'' and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_name(location_id,''UC''),1,2) as Cell FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%STATION%'' and EPIC.ef_location_path_name(l.location_id,''UC'',7) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell ';   
lowtot		varchar2(4000) := 'SELECT ''1A-1DTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 1A-1D'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 1A-1D'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 1A-1D'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''ST'',''2'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''STATION 2,%'' and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''RA-RDTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 2A-2D'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 2A-2D'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 2A-2D'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''ST'',''S'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''STATION 3,%'' and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'ST'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_summary1_audit
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE;
v_var		number; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query1 		varchar2(400) 	:= 'SELECT ''TOWER 2/3'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3%''),count(distinct entity_id),''';
query2		varchar2(4000) 	:= ''',''S1'',''A'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3%''))-to_number(count(distinct entity_id)) ';
query3		varchar2(400)	:= 'FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',5) like ';
query4		varchar2(400) 	:= 'and temporary_location_flag=''N''and action_type=''U''and EPIC.ef_epic_date_to_date(action_time)<=''';
query5		varchar2(4000) 	:= '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query6		varchar2(10)	:= ''')';
query7		varchar2(15)	:= ' UNION ALL ';
query8		varchar2(400) 	:= 'SELECT ''TOWER 4/5'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5%''),count(distinct entity_id),''';
query9		varchar2(400)   := ''',''S1'',''B'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5%'')) - to_number(count(distinct entity_id)) '; 
query10		varchar2(400) 	:= 'SELECT ''TOWER 6/7'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7%''),count(distinct entity_id),''';
query11		varchar2(400)   := ''',''S1'',''C'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7%'')) - to_number(count(distinct entity_id)) ';
query12		varchar2(400) 	:= 'SELECT ''TOWER 8/9'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9%''),count(distinct entity_id),''';
query13		varchar2(400)   := ''',''S1'',''D'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9%'')) - to_number(count(distinct entity_id)) ';
query14		varchar2(400) 	:= 'SELECT ''TOWER 10/11'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11%''),count(distinct entity_id),''';
query15		varchar2(400)   := ''',''S1'',''E'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11%'')) - to_number(count(distinct entity_id)) ';  

test		varchar2(32767) := query1 || p_date || query2 || query3 || '''TWR 3%''' || query4 || p_date || query5 || p_date || query6 || query7 || query8 || p_date || query9 || query3 || '''TWR 5%''' || query4 || p_date || query5 || p_date || query6 || query7 ||  query10 || p_date || query11 || query3 || '''TWR 7%''' || query4 || p_date || query5 || p_date || query6 || query7 || query12 || p_date || query13 || query3 || '''TWR 9%''' || query4 || p_date || query5 || p_date || query6 || query7 || query14 || p_date || query15 || query3 || '''TWR11%''' || query4 || p_date || query5 || p_date || query6; 
BEGIN
 	BEGIN 
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'S1'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END; 
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_summary2_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS

v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE;
v_var		number; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query3		varchar2(400)	:= 'FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',5) like ';
query4		varchar2(400) 	:= 'and temporary_location_flag=''N''and action_type=''U''and EPIC.ef_epic_date_to_date(action_time)<=''';
query5		varchar2(4000) 	:= '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query6		varchar2(10)	:= ''')';
query7		varchar2(15)	:= ' UNION ALL ';
query16		varchar2(400) 	:= 'SELECT ''MAX SECURITY 1'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1%''),count(distinct entity_id),''';
query17		varchar2(400)   := ''',''S2'',''F'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 1%''))-to_number(count(distinct entity_id)) ';
query18		varchar2(400) 	:= 'SELECT ''MAX SECURITY 2'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 2%''),count(distinct entity_id),''';
query19		varchar2(400)   := ''',''S2'',''G'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Max Security 2%''))-to_number(count(distinct entity_id)) ';
query20		varchar2(400) 	:= 'SELECT ''STATION 2 1A-1D'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 1A-1D%''),count(distinct entity_id),''';
query21		varchar2(400)   := ''',''S2'',''H'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 1A-1D%''))-to_number(count(distinct entity_id)) '; 
query22		varchar2(400) 	:= 'SELECT ''STATION 3 2A-2D'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 2A-2D%''),count(distinct entity_id),''';
query23		varchar2(400)   := ''',''S2'',''I'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Minimum Security 2A-2D%''))-to_number(count(distinct entity_id)) ';
query24		varchar2(400) 	:= 'SELECT ''D01-D06'',MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D01-D06%''),count(distinct entity_id),''';
query25		varchar2(400)   := ''',''S2'',''J'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D01-D06%''))-to_number(count(distinct entity_id)) ';

test		varchar2(32767) := query16 || p_date || query17 || query3 || '''MAX 1%''' || query4 || p_date || query5 || p_date || query6 || query7 || query18 || p_date || query19 || query3 || '''MAX 2%''' || query4 || p_date || query5 || p_date || query6 || query7 || query20 || p_date || query21 || query3 || '''STATION 2%''' || query4 || p_date || query5 || p_date || query6 || query7 || query22 || p_date || query23 || query3 || '''STATION 3%''' || query4 || p_date || query5 || p_date || query6 || query7 || query24 || p_date || query25 || query3 || '''MED CONTRL, LOW D%''' || query4 || p_date || query5 || p_date || query6; 
BEGIN
 	BEGIN 
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'S2'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END; 
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_summary3_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS

v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 
v_var		number;

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query3		varchar2(400)	:= 'FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',5) like ';
query4		varchar2(400) 	:= 'and temporary_location_flag=''N''and action_type=''U''and EPIC.ef_epic_date_to_date(action_time)<=''';
query5		varchar2(4000) 	:= '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query6		varchar2(10)	:= ''')';
query7		varchar2(15)	:= ' UNION ALL '; 
query26		varchar2(400) 	:= 'SELECT ''D07-D12'',MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D07-D12%''),count(distinct entity_id),''';
query27		varchar2(400)   := ''',''S3'',''K'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''D-Block: D07-D12%''))-to_number(count(distinct entity_id)) ';
query28		varchar2(400) 	:= 'SELECT ''MH1-17'',MACOMB.mcmb_fnt_RDCCapacity_Location(''MH1-17%''),count(distinct entity_id),''';
query29		varchar2(400)   := ''',''S3'',''L'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''MH1-17%''))-to_number(count(distinct entity_id)) ';
query30		varchar2(400) 	:= 'SELECT ''MH18-24'',MACOMB.mcmb_fnt_RDCCapacity_Location(''MH18-24%''),count(distinct entity_id),''';
query31		varchar2(400)   := ''',''S3'',''M'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''MH18-24%''))-to_number(count(distinct entity_id)) '; 
query32		varchar2(4000)	:= 'SELECT ''BOOKING A-C'',to_char(to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking A%'')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking B%'')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking C%''))),count(distinct entity_id),''';
query33		varchar2(4000)  := ''',''S3'',''N'',null,to_number(to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking A%'')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking B%'')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking C%'')))-to_number(count(distinct entity_id)) FROM EPICAUDIT.eh_housing_assignments h	WHERE substr(EPIC.ef_location_path_name(location_id,''UC'',5),1,instr(EPIC.ef_location_path_name(location_id,''UC'',5),'','',1,2)-1) in (''BOOKING, A'',''BOOKING, B'',''BOOKING, C'') and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query34		varchar2(4000)	:= 'SELECT ''ANNEX-A'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Annex A%''),count(distinct entity_id),''';
query35		varchar2(4000)	:= ''',''S3'',''O'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Annex A%''))-to_number(count(distinct entity_id)) FROM EPICAUDIT.eh_housing_assignments h WHERE substr(EPIC.ef_location_path_name(location_id,''UC'',5),1,instr(EPIC.ef_location_path_name(location_id,''UC'',5),'','',1,2)-1)=''ANNEX, A'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';

test		varchar2(32767) :=  query26 || p_date || query27 || query3 || '''MH CONTRL, UPPER D%''' || query4 || p_date || query5 || p_date || query6 || query7 || query28 || p_date || query29 || query3 || '''MH CONTRL, MENT HLTH, LOW%''' || query4 || p_date || query5 || p_date || query6 ||  query7 || query30 || p_date || query31 || query3 || '''MH CONTRL, MENT HLTH, HIGH%''' || query4 || p_date || query5 || p_date || query6 || query7 || query32 || p_date || query33 || p_date || query5 || p_date || query6 || query7 || query34 || p_date || query35 || p_date || query5 || p_date || query6;
BEGIN
 	BEGIN 
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'S3';
				DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell in ('MH1-17','MH18-24','BOOKING A-C','ANNEX-A');  
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and (v_cell = 'MH1-17' or v_cell = 'MH18-24' or v_cell = 'BOOKING A-C' or v_cell = 'ANNEX-A') THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, decode(v_cell,'MH1-17','G','MH18-24','H','BOOKING A-C','I','ANNEX-A','J',null));
						END;
					END IF;
			 	END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END; 
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_summary4_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)
	 
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 
v_var		number;

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query3		varchar2(400)	:= 'FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',5) like ';
query4		varchar2(400) 	:= 'and temporary_location_flag=''N''and action_type=''U''and EPIC.ef_epic_date_to_date(action_time)<=''';
query5		varchar2(4000) 	:= '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query6		varchar2(10)	:= ''')';
query7		varchar2(15)	:= ' UNION ALL '; 
query37 	varchar2(400)	:= 'SELECT ''ANNEX-B'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Annex B%''),count(distinct entity_id),''';
query38		varchar2(4000)	:= ''',''S4'',''P'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Annex B%''))-to_number(count(distinct entity_id)) FROM EPICAUDIT.eh_housing_assignments h WHERE substr(EPIC.ef_location_path_name(location_id,''UC'',5),1,instr(EPIC.ef_location_path_name(location_id,''UC'',5),'','',1,2)-1)=''ANNEX, B'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query39		varchar2(400)	:= 'SELECT ''BREAK'',null,null,''';
query40		varchar2(400)	:= ''',''S4'',''Q'',null,null FROM dual';
query50 	varchar2(400)	:= 'SELECT ''RATED DESIGN CAPACITY'',null, null,''';
query51		varchar2(400)	:= ''',''S4'',''R'',null,null FROM dual'; 
query52		varchar2(400)	:= 'SELECT ''BOOKING HOLDING CELLS'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking Holding Cells%''),count(distinct entity_id),''';
query53		varchar2(4000)  := ''',''S4'',''S'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Booking Holding Cells%''))-to_number(count(distinct entity_id)) FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',6) like ''HOLDING%'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';


test		varchar2(32767) := query37 || p_date || query38 || p_date || query5 || p_date || query6 || query7 || query39 || p_date || query40 || query7 || query50 || p_date || query51 || query7 || query52 || p_date || query53 || p_date || query5 || p_date || query6; 
BEGIN
 	BEGIN

 	
 	
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'S4';
				DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell = 'ANNEX-B'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and v_cell = 'ANNEX-B' THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, 'K');
						END;
					END IF;
			 	END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END; 

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_summary5_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2)

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE;
v_var		number; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;
query3		varchar2(400)	:= 'FROM EPICAUDIT.eh_housing_assignments h WHERE EPIC.ef_location_path_name(location_id,''UC'',5) like ';
query4		varchar2(400) 	:= 'and temporary_location_flag=''N''and action_type=''U''and EPIC.ef_epic_date_to_date(action_time)<=''';
query5		varchar2(4000) 	:= '''and not exists(select 1 from EPICAUDIT.eh_housing_assignments a where h.location_id=a.location_id and h.entity_id=a.entity_id and a.action_type=''D'' and EPIC.ef_epic_date_to_date(a.action_time)>=EPIC.ef_epic_date_to_date(h.action_time) and EPIC.ef_epic_date_to_date(a.action_time)<=''';
query6		varchar2(10)	:= ''')';
query7		varchar2(15)	:= ' UNION ALL '; 
query54		varchar2(400)	:= 'SELECT ''MEDICAL UNIT'',MACOMB.mcmb_fnt_RDCCapacity_Location(''Medical Unit%''),count(distinct entity_id),''';
query55		varchar2(4000)  := ''',''S5'',''T'',null,to_number(MACOMB.mcmb_fnt_RDCCapacity_Location(''Medical Unit%''))-to_number(count(distinct entity_id)) FROM EPICAUDIT.eh_housing_assignments h WHERE substr(EPIC.ef_location_path_name(location_id,''UC'',5),1,instr(EPIC.ef_location_path_name(location_id,''UC'',5),'','',1,2)-1)=''MED CONTRL, MEDICAL'' and temporary_location_flag=''N'' and action_type=''U'' and EPIC.ef_epic_date_to_date(action_time)<=''';
query56		varchar2(400)	:= 'SELECT ''TOTAL BEDS'',null,null,''';
query57		varchar2(400)	:= ''',''S5'',''U'',null,null FROM dual';
query58		varchar2(400)	:= 'SELECT ''GENERAL USE BEDSPACE'',null,null,''';
query59		varchar2(400)	:= ''',''S5'',''V'',null,null FROM dual'; 
query60		varchar2(400)	:= 'SELECT ''BREAK'',null,null,''';
query61		varchar2(400)	:= ''',''S5'',''W'',null,null FROM dual'; 

test		varchar2(32767) := query54 || p_date || query55 || p_date || query5 || p_date || query6 || query7 || query56 || p_date || query57 || query7 || query58 || p_date || query59 || query7 || query60 || p_date || query61; 
BEGIN
 	BEGIN 
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'S5'; 
				DELETE FROM MACOMB.mt_jcs_history WHERE datetm = p_date and cell = 'MEDICAL UNIT';
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' and v_cell = 'MEDICAL UNIT'  THEN
	                	BEGIN
				 			INSERT INTO MACOMB.mt_jcs_history(cell, rdc, count, datetm, sort) 
					 		VALUES (v_cell, v_rdc, v_count, v_datetm, 'L');
						END;
					END IF;
			 	END;
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3, v_var; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END; 
 	
END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_tower1011_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''T11'', sort, null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,3) as Cell, substr(EPIC.ef_location_path_name(ha.location_id,''UC'',7),1,1) as Sort FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%TWR11%'' and EPIC.ef_location_path_name(ha.location_id,''UC'',8) is not null and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_path_name(location_id,''UC'',8),1,3) as Cell, substr(EPIC.ef_location_path_name(location_id,''UC'',7),1,1) FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%TWR11%'' and EPIC.ef_location_path_name(l.location_id,''UC'',8) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell, Sort ';   
lowtot		varchar2(4000) := 'SELECT ''10/11: A-CTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 East'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 East'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 East'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''T11'',''CC'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,3) in (''10A'',''11A'',''10B'',''11B'',''10C'',''11C'') and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''10/11: D-FTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 West'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 West'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 10/11 West'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''T11'',''FF'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,3) in (''10D'',''11D'',''10E'',''11E'',''10F'',''11F'') and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'T11'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_tower23_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''T3'', sort, null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(ha.location_id,''UC'',7),1,1) as Sort FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%TWR 3%'' and EPIC.ef_location_path_name(ha.location_id,''UC'',8) is not null and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_path_name(location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(location_id,''UC'',7),1,1) FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%TWR 3%'' and EPIC.ef_location_path_name(l.location_id,''UC'',8) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell, Sort ';   
lowtot		varchar2(4000) := 'SELECT ''2/3: A-CTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 East'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 East'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 East'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''T3'',''CC'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''2A'',''3A'',''2B'',''3B'',''2C'',''3C'') and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''2/3: D-FTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 West'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 West'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 2/3 West'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''T3'',''FF'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''2D'',''3D'',''2E'',''3E'',''2F'',''3F'') and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'T3'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_tower45_audit
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''T5'', sort, null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(ha.location_id,''UC'',7),1,1) as Sort FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%TWR 5%'' and EPIC.ef_location_path_name(ha.location_id,''UC'',8) is not null and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_path_name(location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(location_id,''UC'',7),1,1) FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%TWR 5%'' and EPIC.ef_location_path_name(l.location_id,''UC'',8) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell, Sort ';   
lowtot		varchar2(4000) := 'SELECT ''4/5: A-CTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 East'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 East'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 East'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''T5'',''CC'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''4A'',''5A'',''4B'',''5B'',''4C'',''5C'') and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''4/5: D-FTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 West'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 West'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 4/5 West'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''T5'',''FF'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''4D'',''5D'',''4E'',''5E'',''4F'',''5F'') and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'T5'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_tower67_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/
v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''T7'', sort, null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(ha.location_id,''UC'',7),1,1) as Sort FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%TWR 7%'' and EPIC.ef_location_path_name(ha.location_id,''UC'',8) is not null and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_path_name(location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(location_id,''UC'',7),1,1) FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%TWR 7%'' and EPIC.ef_location_path_name(l.location_id,''UC'',8) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell, Sort ';   
lowtot		varchar2(4000) := 'SELECT ''6/7: A-CTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 East'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 East'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 East'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''T7'',''CC'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''6A'',''7A'',''6B'',''7B'',''6C'',''7C'') and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''6/7: D-FTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 West'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 West'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 6/7 West'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''T7'',''FF'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''6D'',''7D'',''6E'',''7E'',''6F'',''7F'') and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'T7'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE mp_jcs_tower89_audit	
	(return_cur	OUT	 	MACOMB.mcmb_generic_ref_cursor.ref_cursor,
	 p_date		IN		date,
	 p_save		IN		varchar2) 

IS

/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of auditJCS.rpt
	Purpose:		Used by Administration to return a snapshot of the jail population on the selected date/time. 
					If prompted, inserts information into the monthly & historical MACOMB tables as well.
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/23/06		Created					
*/

v_cell		MACOMB.mt_jcs_monthly.cell%TYPE;
v_rdc		MACOMB.mt_jcs_monthly.rdc%TYPE;
v_count 	MACOMB.mt_jcs_monthly.count%TYPE;
v_datetm 	MACOMB.mt_jcs_monthly.datetm%TYPE;
v_sort1		MACOMB.mt_jcs_monthly.sort1%TYPE;
v_sort2		MACOMB.mt_jcs_monthly.sort2%TYPE;
v_sort3		MACOMB.mt_jcs_monthly.sort3%TYPE; 

insert_cur 	MACOMB.mcmb_generic_ref_cursor.ref_cursor;

query 		varchar2(4000) := 'SELECT Cell,(case when MACOMB.mcmb_fnt_rdccapacity_cell(Cell) < 10 then ''0'' || MACOMB.mcmb_fnt_rdccapacity_cell(Cell) else MACOMB.mcmb_fnt_rdccapacity_cell(Cell) end),(case when nvl(SUM(Cnt),0) < 10 then ''0'' || nvl(SUM(Cnt),0) else to_char(nvl(SUM(Cnt),0)) end),''';
query2		varchar2(8000) := ''',''T9'', sort, null FROM(SELECT count(distinct ha.entity_id) as Cnt,substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(ha.location_id,''UC'',7),1,1) as Sort FROM EPICAUDIT.eh_housing_assignments ha WHERE EPIC.ef_location_path_name(ha.location_id,''UC'',5) like ''%TWR 9%'' and EPIC.ef_location_path_name(ha.location_id,''UC'',8) is not null and ha.temporary_location_flag = ''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
query3 		varchar2(4000) := '''and ha.action_type =''U'' and not exists (select 1	from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id	and ha2.action_type =''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
groupby		varchar2(40) := ''')GROUP BY location_id';
qunion		varchar2(40) := ' UNION ALL ';
error		varchar2(4000) := 'SELECT 0 as Cnt, substr(EPIC.ef_location_path_name(location_id,''UC'',8),1,2) as Cell, substr(EPIC.ef_location_path_name(location_id,''UC'',7),1,1) FROM EPICAUDIT.epic_locations l WHERE EPIC.ef_location_path_name(l.location_id,''UC'',5) like ''%TWR 9%'' and EPIC.ef_location_path_name(l.location_id,''UC'',8) is not null and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null or EPIC.ef_epic_date_to_date(l.eff_to_date) >= ''';
error2		varchar2(4000) := ''')and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null or EPIC.ef_epic_date_to_date(l.eff_from_date) <= ''';
error3		varchar2(4000) := ''') and not exists (select 1 from EPICAUDIT.epic_locations l2 where l.location_id = l2.location_id and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date) and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= ''';
groupby2	varchar2(40)   := ')GROUP BY Cell, Sort ';   
lowtot		varchar2(4000) := 'SELECT ''8/9: A-CTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 East'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 East'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 East'') end), to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
lowtot2		varchar2(4000) := ''',''T9'',''CC'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''8A'',''9A'',''8B'',''9B'',''8C'',''9C'') and ha.temporary_location_flag =''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
lowtot3		varchar2(4000) := '''and ha.action_type=''U''and not exists	(select 1 from EPICAUDIT.eh_housing_assignments ha2	where ha.location_id=ha2.location_id and ha.entity_id=ha2.entity_id and ha2.action_type=''D''and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)and EPIC.ef_epic_date_to_date(ha2.action_time) <= ''';
totgroup	varchar2(40)   := ''')GROUP BY ha.entity_id ';
uppertot	varchar2(4000) := 'SELECT ''8/9: D-FTotal'',(case when MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 West'') < 10 then ''0'' || MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 West'') else MACOMB.mcmb_fnt_RDCCapacity_Location(''Tower 8/9 West'') end),to_char(nvl(sum(count(distinct ha.entity_id)),0)), ''';
uppertot2	varchar2(4000) := ''',''T9'',''FF'', null FROM EPICAUDIT.eh_housing_assignments ha WHERE substr(EPIC.ef_location_path_name(ha.location_id,''UC'',8),1,2) in (''8D'',''9D'',''8E'',''9E'',''8F'',''9F'') and ha.temporary_location_flag=''N'' and EPIC.ef_epic_date_to_date(ha.action_time) <=''';
uppertot3	varchar2(4000) := '''and ha.action_type=''U'' and not exists (select 1 from EPICAUDIT.eh_housing_assignments ha2 where ha.location_id=ha2.location_id and ha.entity_id = ha2.entity_id and ha2.action_type=''D'' and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time) and EPIC.ef_epic_date_to_date(ha2.action_time) <=''';
qorder		varchar2(40)   := 'ORDER BY 5,6';


test		varchar2(32767) := query || p_date || query2 || p_date || query3 || p_date || groupby || qunion || error || p_date || error2 ||  p_date ||  error3 || p_date || groupby || groupby2 || qunion || lowtot || p_date || lowtot2 || p_date || lowtot3 || p_date || totgroup ||qunion || uppertot || p_date || uppertot2 || p_date || uppertot3 || p_date || totgroup || qorder;

BEGIN
	BEGIN
		BEGIN
			IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
				DELETE FROM MACOMB.mt_jcs_monthly WHERE datetm = p_date and sort1 = 'T9'; 
			END IF;
	  	END;
	
		OPEN insert_cur FOR test;
		FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3;
		WHILE insert_cur%FOUND
			LOOP
				BEGIN
					IF p_save = 'Y' and p_date > (sysdate - 30) and to_char(p_date, 'HH24:MI') = '02:00' THEN
	                    BEGIN
							INSERT INTO MACOMB.mt_jcs_monthly VALUES(v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3);
							EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');	
						END;
					END IF;
				END;   		 
		 FETCH insert_cur INTO v_cell, v_rdc, v_count, v_datetm, v_sort1, v_sort2, v_sort3; 
		 END LOOP; 
		CLOSE insert_cur;
		COMMIT;
	END;
	
	BEGIN
	OPEN return_cur FOR test;
	END;

END;
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_charge_detail (
		p_entity_id_fk		IN		VARCHAR2,
		p_type				IN		VARCHAR2, 
		p_charge_id			IN		VARCHAR2,
		v_cur				OUT	       EPIC.epp_generic_ref_cursor.ref_cursor
	 )
		
IS
/*	
	Purpose:		Look up Charges money details 
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	open v_cur for 
		select rownum, c.amount, amount_type,c.reduceamount
		from MT_JIL_CHARGE c
		where c.entity_id_fk = upper(p_entity_id_fk||'%')
		  and c.Trans_type = p_type
		  and charge_id_number = p_charge_id;

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_charge_lk (
		p_entity_id_fk		IN		VARCHAR2,
		p_type				IN		VARCHAR2,
		v_cur				OUT	       EPIC.epp_generic_ref_cursor.ref_cursor
	 )
		
IS
/*	
	Purpose:		Look up Charges based on type 
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	open v_cur for 
		select rownum, c.charge_id_number
		from MT_JIL_CHARGE c
		where c.entity_id_fk = p_entity_id_fk
		  and c.Trans_type = p_type;

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_inmateid_lk (
		p_inmate_ID			IN		MACOMB.MT_JIL_INMATE.OFFENDER_ID%TYPE,
		v_cur				OUT	        EPIC.epp_generic_ref_cursor.ref_cursor
	 )
		
IS
/*	
	Purpose:		Look up inmate based on inmate number 
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	open v_cur for 
		select rownum, entity_id_fk, offender_id
		from MT_JIL_ALIAS
		where offender_id like p_inmate_ID ;

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_inmate_details (
		p_entity_id_fk		IN		MACOMB.MT_JIL_INMATE.ENTITY_ID_PK%TYPE, 
		p_offender_id 		   OUT  MACOMB.MT_JIL_INMATE.OFFENDER_ID%TYPE,
		p_juvenile			   OUT  MACOMB.MT_JIL_INMATE.JUVENILE_FLAG%TYPE, 
		p_cell				   OUT  MACOMB.MT_JIL_INMATE.CELL%TYPE,
		p_paid				   OUT  MACOMB.MT_JIL_INMATE.PAID_RELEASE%TYPE,
		p_paid_release		   OUT  MACOMB.MT_JIL_INMATE.PROJECTED_RELEASE%TYPE,
		p_restrictionuntil	   OUT  MACOMB.MT_JIL_INMATE.RESTRICTIONUNTIL%TYPE,
		p_sent_total		   OUT  MACOMB.MT_JIL_INMATE.SENT_TOTAL%TYPE,
		p_hold_total		   OUT  MACOMB.MT_JIL_INMATE.HOLD_TOTAL%TYPE,
		p_bail_total		   OUT  MACOMB.MT_JIL_INMATE.BAIL_TOTAL%TYPE,
		p_dob				   OUT  MACOMB.MT_JIL_INMATE.DOB%TYPE
 )
		
IS
/*	
	Purpose:		Look up visitor and reply if approved 
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	SELECT OFFENDER_ID,JUVENILE_FLAG, CELL, PAID_RELEASE, PROJECTED_RELEASE, RESTRICTIONUNTIL, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, DOB
	INTO   p_offender_id, p_juvenile, p_cell, p_paid, p_paid_release, p_restrictionuntil, p_sent_total, p_hold_total, p_bail_total, p_dob
	FROM MT_JIL_INMATE
	WHERE ENTITY_ID_PK = p_entity_id_fk	;	       

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_inmate_visitday (
		p_entity_id_fk		IN		VARCHAR2,
		v_cur				OUT	       EPIC.epp_generic_ref_cursor.ref_cursor
	 )
		
IS
/*	
	Purpose:		Look up inmate visiting days
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	open v_cur for 
	select v.entrance, v.dayofweek, v.starttime, v.endtime, v.visitingarea  report_to, i.cell 
	from MT_JIL_INMATE i, WEB_VISITATION v, WEB_VISITATION_CELL c
	where c.cell = i.cell
	  and c.inmatetype= i.INMATECLASS
	  and i.gender = v.gender
	  and c.web_visitation_id = v.web_visitation_id
	  and i.ENTITY_ID_PK = p_entity_id_fk;	       

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_name_lk (
		p_name				IN		VARCHAR2,
		p_DOB				IN		VARCHAR2, 
		v_cur				OUT	       EPIC.epp_generic_ref_cursor.ref_cursor
	 )
		
IS
/*	
	Purpose:		Look up inmate by name and DOB
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
	open v_cur for 
		select rownum,entity_id_fk
		from MT_JIL_ALIAS
		where (lastname like upper(p_name||'%')
		       or firstname like upper(p_name||'%')
		       or middlename like upper(p_name||'%'))
		  and DOB = to_date(p_DOB);

END;   
/

CREATE OR REPLACE
PROCEDURE MP_JILIVR_VisitorApproved (
		p_entity_id_fk		IN		MACOMB.MT_JIL_INMATE.ENTITY_ID_PK%TYPE,
		p_name				IN		VARCHAR2,
		p_Status			OUT	    VARCHAR2
	 )
		
IS
/*	
	Purpose:		Look up visitor and reply if approved 
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 09/29/06		Created
*/                                    

BEGIN    
		select 'Y' approved INTO p_Status
		from MT_JIL_VISITOR
		where entity_id_fk = p_entity_id_fk
		  and (lastname like upper(p_name ||'%')
		       or firstname like upper(p_name ||'%')); 
		       
		IF p_Status is null then
			p_Status := 'N';
		END IF;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_LanguageUpdate
	 (	p_LangID	IN	MACOMB.mt_pb_language.language_id%TYPE,
	 	p_ArrestID		IN	MACOMB.mt_pb_language.arrest_id%TYPE, 
	 	p_LangTp	IN	MACOMB.mt_pb_language.languagetype%TYPE) 

IS	 
 /*	
	Purpose:		Updates the MACOMB.mt_pb_language table based on input information
					This procedure is called by MACOMB.mp_pb_arrest9

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 03/21/06		Created   
					R. Stuve	 09/14/06		Added cursor to ensure only one language record per arrestee
					R. Stuve	 11/02/06	    Added language id
	
*/ 
CURSOR curLang IS
	SELECT 	language_id
	FROM 	MACOMB.mt_pb_language
	WHERE 	arrest_id = p_ArrestID;

v_lang		MACOMB.mt_pb_language.language_id%TYPE;
nodata		EXCEPTION;

BEGIN 	 
	OPEN curLang;
	FETCH curLang INTO v_lang;
		IF curLang%found THEN
			UPDATE MACOMB.mt_pb_language
			SET languagetype = p_LangTp
			WHERE arrest_id = p_ArrestID;
		ELSE
			RAISE nodata;
		END IF;
	CLOSE curLang;
	
	EXCEPTION
		WHEN nodata THEN
			INSERT INTO MACOMB.mt_pb_language (language_id, arrest_id, languagetype)
			VALUES (p_LangID,--(SELECT EPIC.epic_ids.new_epic_id FROM dual),
					p_ArrestID,
					p_LangTp); 
COMMIT;
END; 
/

CREATE OR REPLACE
PROCEDURE        mp_matching_offenders
	(p_user_int_id				in		epic.epic_user_names.user_int_id%type,
	 p_offender_id				in		epic.eh_offender_ids.offender_id%type,
	 p_state_id					in		epic.eh_offender_ids.state_id%type,
	 p_ssn						in		epic.eh_person_identity.social_security_number%type,
	 p_name_last				in		epic.eh_person_identity.name_family%type,
	 p_name_first				in		epic.eh_person_identity.name_first%type,
		vCur		OUT		epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	  Usage: 		
	Crystal: 		
	Purpose:		Procedure to call matching offenders

	Author:			Joe McBratnie

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					J. McBRatnie	03/01/06		Created 
*/

	
BEGIN
	vCur := macomb.mpk_matching_offenders.matching_offenders(
		p_user_int_id, p_offender_id, p_state_id, p_ssn, p_name_last, p_name_first);

END;
/

CREATE OR REPLACE
PROCEDURE mp_mg_RPT_lineup
(	p_LINEUP_ID	in  MT_MG_LINEUP_PEOPLE.LINEUP_ID%type,
	vCur		OUT		epic.epp_generic_ref_cursor.ref_cursor)
IS
/*	
	Purpose:		Create the dataset for lineup
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/ 
BEGIN  
	OPEN vCur FOR  
	SELECT l.CASE_NUMBER, l.CASE_DESCRIPTION, l.HEADER, l.FOOTER, l.NOTES_TEXT, l.RACE, 
			l.ETHNICITY, l.BUILD, l.SKIN_TONE, l.LEFT_EYE_COLOR, l.RIGHT_EYE_COLOR, 
			l.HEIGHT, l.WEIGHT, l.JUVENILE, l.DOB, l.HAIRCOLOR, l.HAIRTYPE, l.FACIAL_HAIR1, 
			l.FACIAL_HAIR2, l.FACIAL_HAIR3, l.GANG,
			p.LINEUP_TYPE, p.IMAGE_ID, p.LINEUP_ROW, p.LINEUP_COL, p.HOT_SEAT
	FROM MT_MG_LINEUP l,
	     MT_MG_LINEUP_PEOPLE p
	WHERE l.LINEUP_ID = p.LINEUP_ID
	  AND p_LINEUP_ID = l.LINEUP_ID ;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_RPT_wanted_person
(	p_offender_id	in  EPIC.EH_OFFENDER_IDS.OFFENDER_ID%type,
	vCur		OUT		epic.epp_generic_ref_cursor.ref_cursor)
IS
/*	
	Purpose:		Create the dataset for wanted poster report
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/ 
BEGIN  
	OPEN vCur FOR  
	SELECT w.WANTED_ID, w.ENTITY_ID, w.OFFENDER_NUMBER, w.TEXT_ON_POSTER,w.ACTION_TIME, 
			--decode(d.imageref, null,null, '\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
			d.imageref, PHOTO_ID, IMAGE_TYPE
	FROM MT_MG_IMAGE_DETAILS d,
	     MT_MG_WANTED w
	WHERE w.ENTITY_ID = d.ENTITY_ID
	  AND p_offender_id = d.OFFENDER_ID ;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_set_lineup
(	p_lineup_ID				IN MACOMB.MT_MG_LINEUP.LINEUP_ID%type,
	p_CASE_NUMBER			IN MACOMB.MT_MG_LINEUP.CASE_NUMBER%type,
	p_CASE_DESCRIPTION		IN MACOMB.MT_MG_LINEUP.CASE_DESCRIPTION%type,
	p_HEADER				IN MACOMB.MT_MG_LINEUP.HEADER%type,
	p_FOOTER				IN MACOMB.MT_MG_LINEUP.FOOTER%type,
	p_NOTES					IN MACOMB.MT_MG_LINEUP.NOTES_TEXT%type,
	p_RACE 					IN MACOMB.MT_MG_IMAGE_DETAILS.RACE%type,
	p_ETHNICITY 			IN MACOMB.MT_MG_IMAGE_DETAILS.ETHNICITY%type,
	p_BUILD 				IN MACOMB.MT_MG_IMAGE_DETAILS.BUILD%type,
	p_SKIN_TONE 			IN MACOMB.MT_MG_IMAGE_DETAILS.SKIN_TONE%type,
	p_LEFT_EYE_COLOR 		IN MACOMB.MT_MG_IMAGE_DETAILS.LEFT_EYE_COLOR%type,
	p_RIGHT_EYE_COLOR 		IN MACOMB.MT_MG_IMAGE_DETAILS.RIGHT_EYE_COLOR%type,
	p_HEIGHT 				IN MACOMB.MT_MG_IMAGE_DETAILS.HEIGHT%type,
	p_WEIGHT 				IN MACOMB.MT_MG_IMAGE_DETAILS.WEIGHT%type,
	p_JUVENILE 				IN MACOMB.MT_MG_IMAGE_DETAILS.JUVENILE%type,
	p_DOB 					IN MACOMB.MT_MG_IMAGE_DETAILS.DOB%type ,
	p_HAIRCOLOR 			IN MACOMB.MT_MG_IMAGE_DETAILS.HAIRCOLOR%type,
	p_HAIRTYPE 				IN MACOMB.MT_MG_IMAGE_DETAILS.HAIRTYPE%type,
	p_FACIAL_HAIR1 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR1%type,
	p_FACIAL_HAIR2 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR2%type,
	p_FACIAL_HAIR3 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR3%type,
	p_GANG 					IN MACOMB.MT_MG_IMAGE_DETAILS.GANG%type,
	p_IMAGEREF 				IN MACOMB.MT_MG_IMAGE_DETAILS.IMAGEREF%type,
	p_IMAGE_TYPE 			IN MACOMB.MT_MG_IMAGE_DETAILS.IMAGE_TYPE%type,
	p_PHOTO_ID 				IN MACOMB.MT_MG_IMAGE_DETAILS.PHOTO_ID%type,
	p_ACTION_TYPE 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_TYPE%type,
	p_ACTION_TIME 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_TIME%type,
	p_ACTION_BY 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_BY%type
	)
IS
/*	
	Purpose:		Creates a lineup
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/  

  v_entity_id     			varchar2(16);  


BEGIN  
	
	BEGIN
		INSERT INTO MACOMB.MT_MG_LINEUP (LINEUP_ID, CASE_NUMBER, CASE_DESCRIPTION,
					HEADER, FOOTER,NOTES_TEXT, RACE, ETHNICITY, BUILD, SKIN_TONE, LEFT_EYE_COLOR, 
					RIGHT_EYE_COLOR, HEIGHT, WEIGHT, JUVENILE, DOB, HAIRCOLOR, 
					HAIRTYPE, FACIAL_HAIR1, FACIAL_HAIR2, FACIAL_HAIR3, GANG, 
					ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (p_LINEUP_ID, p_CASE_NUMBER, p_CASE_DESCRIPTION,
					p_HEADER, p_FOOTER, p_NOTES, p_RACE, p_ETHNICITY, p_BUILD, p_SKIN_TONE, p_LEFT_EYE_COLOR,
					p_RIGHT_EYE_COLOR, p_HEIGHT, p_WEIGHT, p_JUVENILE, p_DOB, p_HAIRCOLOR,
					p_HAIRTYPE, p_FACIAL_HAIR1, p_FACIAL_HAIR2, p_FACIAL_HAIR3, p_GANG,
					'I', epic.epicdatenow(), p_ACTION_BY);
	EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.MT_MG_LINEUP
				SET CASE_NUMBER			= p_CASE_NUMBER,
					CASE_DESCRIPTION 	= p_CASE_DESCRIPTION,
					HEADER				= p_HEADER,
					FOOTER 				= p_FOOTER,
					NOTES_TEXT			= p_NOTES,
					RACE				= p_RACE, 
					ETHNICITY			= p_ETHNICITY, 
					BUILD				= p_BUILD, 
					SKIN_TONE			= p_SKIN_TONE, 
					LEFT_EYE_COLOR		= p_LEFT_EYE_COLOR, 
					RIGHT_EYE_COLOR		= p_RIGHT_EYE_COLOR, 
					HEIGHT				= p_HEIGHT, 
					WEIGHT				= p_WEIGHT, 
					JUVENILE			= p_JUVENILE, 
					DOB					= p_DOB, 
					HAIRCOLOR			= p_HAIRCOLOR, 
					HAIRTYPE			= p_HAIRTYPE, 
					FACIAL_HAIR1		= p_FACIAL_HAIR1, 
					FACIAL_HAIR2		= p_FACIAL_HAIR2, 
					FACIAL_HAIR3		= p_FACIAL_HAIR3, 
					GANG				= p_GANG, 
				    ACTION_TYPE 		= 'U', 
				    ACTION_TIME 		= epic.epicdatenow(),
			    	ACTION_BY 			= p_ACTION_BY
				WHERE LINEUP_ID = p_LINEUP_ID; 
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_set_MT_MG_LINEUP_PEOPLE
(	p_LINEUPPEOPLE_ID		IN MACOMB.MT_MG_LINEUP_PEOPLE.LINEUPPEOPLE_ID%type,
	p_lineup_ID				IN MACOMB.MT_MG_LINEUP_PEOPLE.LINEUP_ID%type,
   	p_LINEUP_TYPE           IN MACOMB.MT_MG_LINEUP_PEOPLE.LINEUP_TYPE%type,
   	p_IMAGE_ID				IN MACOMB.MT_MG_LINEUP_PEOPLE.IMAGE_ID%type,
   	p_HOT_SEAT	 			IN MACOMB.MT_MG_LINEUP_PEOPLE.HOT_SEAT%type, 
   	p_LINEUP_ROW 			IN MACOMB.MT_MG_LINEUP_PEOPLE.LINEUP_ROW%type,
   	p_LINEUP_COL 			IN MACOMB.MT_MG_LINEUP_PEOPLE.LINEUP_COL%type,
   	p_ACTION_TYPE 			IN MACOMB.MT_MG_LINEUP_PEOPLE.ACTION_TYPE%type,
   	p_ACTION_TIME 			IN MACOMB.MT_MG_LINEUP_PEOPLE.ACTION_TIME%type,
   	p_ACTION_BY				IN MACOMB.MT_MG_LINEUP_PEOPLE.ACTION_BY%type
	)
IS
/*	
	Purpose:		Add people to line up
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/  

  v_LINEUPPEOPLE_ID     			varchar2(16);  


BEGIN  
	IF (p_LINEUPPEOPLE_ID is null OR p_LINEUPPEOPLE_ID = '') THEN
		v_LINEUPPEOPLE_ID := EPIC.epic_ids.new_epic_id();
	ELSE
		v_LINEUPPEOPLE_ID := p_LINEUPPEOPLE_ID; 
	END IF;
	
	BEGIN
		INSERT INTO MACOMB.MT_MG_LINEUP_people (LINEUPPEOPLE_ID, LINEUP_TYPE, LINEUP_ID, IMAGE_ID, 
		            LINEUP_ROW, LINEUP_COL, HOT_SEAT,
					ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (v_LINEUPPEOPLE_ID, p_LINEUP_TYPE, p_LINEUP_ID,
					p_IMAGE_ID, p_LINEUP_ROW, p_LINEUP_COL, p_HOT_SEAT, 
					'I', epic.epicdatenow(), p_ACTION_BY);
	EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.MT_MG_LINEUP_PEOPLE
				SET LINEUP_ID =p_LINEUP_ID, 
					LINEUP_TYPE = p_LINEUP_TYPE, 
					IMAGE_ID = p_IMAGE_ID, 
					LINEUP_ROW = p_LINEUP_ROW, 
					LINEUP_COL = p_LINEUP_COL, 
					HOT_SEAT = p_HOT_SEAT, 
					ACTION_TYPE = p_ACTION_TYPE, 
					ACTION_TIME = p_ACTION_TIME, 
					ACTION_BY = p_ACTION_BY
				WHERE LINEUPPEOPLE_ID = v_LINEUPPEOPLE_ID; 
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_set_suspect
(	p_OFFENDER_ID			IN MACOMB.MT_MG_IMAGE_DETAILS.OFFENDER_ID%type,
	p_PURPOSE 				IN MACOMB.MT_MG_IMAGE_DETAILS.PURPOSE%type,
	p_RACE 					IN MACOMB.MT_MG_IMAGE_DETAILS.RACE%type,
	p_ETHNICITY 			IN MACOMB.MT_MG_IMAGE_DETAILS.ETHNICITY%type,
	p_BUILD 				IN MACOMB.MT_MG_IMAGE_DETAILS.BUILD%type,
	p_SKIN_TONE 			IN MACOMB.MT_MG_IMAGE_DETAILS.SKIN_TONE%type,
	p_LEFT_EYE_COLOR 		IN MACOMB.MT_MG_IMAGE_DETAILS.LEFT_EYE_COLOR%type,
	p_RIGHT_EYE_COLOR 		IN MACOMB.MT_MG_IMAGE_DETAILS.RIGHT_EYE_COLOR%type,
	p_HEIGHT 				IN MACOMB.MT_MG_IMAGE_DETAILS.HEIGHT%type,
	p_WEIGHT 				IN MACOMB.MT_MG_IMAGE_DETAILS.WEIGHT%type,
	p_JUVENILE 				IN MACOMB.MT_MG_IMAGE_DETAILS.JUVENILE%type,
	p_DOB 					IN MACOMB.MT_MG_IMAGE_DETAILS.DOB%type ,
	p_HAIRCOLOR 			IN MACOMB.MT_MG_IMAGE_DETAILS.HAIRCOLOR%type,
	p_HAIRTYPE 				IN MACOMB.MT_MG_IMAGE_DETAILS.HAIRTYPE%type,
	p_FACIAL_HAIR1 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR1%type,
	p_FACIAL_HAIR2 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR2%type,
	p_FACIAL_HAIR3 			IN MACOMB.MT_MG_IMAGE_DETAILS.FACIAL_HAIR3%type,
	p_GANG 					IN MACOMB.MT_MG_IMAGE_DETAILS.GANG%type,
	p_IMAGEREF 				IN MACOMB.MT_MG_IMAGE_DETAILS.IMAGEREF%type,
	p_IMAGE_TYPE 			IN MACOMB.MT_MG_IMAGE_DETAILS.IMAGE_TYPE%type,
	p_PHOTO_ID 				IN MACOMB.MT_MG_IMAGE_DETAILS.PHOTO_ID%type,
	p_SYSTEM 				IN MACOMB.MT_MG_IMAGE_DETAILS.SYSTEM%type,
	p_ACTION_TYPE 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_TYPE%type,
	p_ACTION_TIME 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_TIME%type,
	p_ACTION_BY 			IN MACOMB.MT_MG_IMAGE_DETAILS.ACTION_BY%type
	)
IS
/*	
	Purpose:		Store non booked suspects into Suspect system
					p_SYSTEM should be 'S'
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/  

  v_entity_id     			varchar2(16);  


BEGIN  
	SELECT ENTITY_ID 
	INTO v_entity_id 
	FROM MT_MG_IMAGE_DETAILS 
	WHERE OFFENDER_ID = p_offender_id;
	-- Need to check if v_entity_id is null before continuing
	
	BEGIN
		INSERT INTO MACOMB.MT_MG_IMAGE_DETAILS (IMAGE_ID, ENTITY_ID, OFFENDER_ID,
					PURPOSE, RACE, ETHNICITY, BUILD, SKIN_TONE, LEFT_EYE_COLOR, 
					RIGHT_EYE_COLOR, HEIGHT, WEIGHT, JUVENILE, DOB, HAIRCOLOR, 
					HAIRTYPE, FACIAL_HAIR1, FACIAL_HAIR2, FACIAL_HAIR3, GANG, 
					IMAGEREF, IMAGE_TYPE, PHOTO_ID, SYSTEM, 
					ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (EPIC.epic_ids.new_epic_id(), EPIC.epic_ids.new_epic_id(), 'autoID',
					p_PURPOSE, p_RACE, p_ETHNICITY, p_BUILD, p_SKIN_TONE, p_LEFT_EYE_COLOR,
					p_RIGHT_EYE_COLOR, p_HEIGHT, p_WEIGHT, p_JUVENILE, p_DOB, p_HAIRCOLOR,
					p_HAIRTYPE, p_FACIAL_HAIR1, p_FACIAL_HAIR2, p_FACIAL_HAIR3, p_GANG,
					p_IMAGEREF, p_IMAGE_TYPE, p_PHOTO_ID, p_SYSTEM,
					'I', epic.epicdatenow(), p_ACTION_BY);
	EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.MT_MG_IMAGE_DETAILS
				SET PURPOSE				= p_PURPOSE, 
					RACE				= p_RACE, 
					ETHNICITY			= p_ETHNICITY, 
					BUILD				= p_BUILD, 
					SKIN_TONE			= p_SKIN_TONE, 
					LEFT_EYE_COLOR		= p_LEFT_EYE_COLOR, 
					RIGHT_EYE_COLOR		= p_RIGHT_EYE_COLOR, 
					HEIGHT				= p_HEIGHT, 
					WEIGHT				= p_WEIGHT, 
					JUVENILE			= p_JUVENILE, 
					DOB					= p_DOB, 
					HAIRCOLOR			= p_HAIRCOLOR, 
					HAIRTYPE			= p_HAIRTYPE, 
					FACIAL_HAIR1		= p_FACIAL_HAIR1, 
					FACIAL_HAIR2		= p_FACIAL_HAIR2, 
					FACIAL_HAIR3		= p_FACIAL_HAIR3, 
					GANG				= p_GANG, 
					IMAGEREF			= p_IMAGEREF, 
					IMAGE_TYPE			= p_IMAGE_TYPE, 
					PHOTO_ID			= p_PHOTO_ID, 
					SYSTEM				= p_SYSTEM, 
				    ACTION_TYPE 		= 'U', 
				    ACTION_TIME 		= epic.epicdatenow(),
			    	ACTION_BY 			= p_ACTION_BY
				WHERE OFFENDER_ID = p_offender_id; 
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_set_wanted_person
(	p_offender_id		in   EPIC.EH_OFFENDER_IDS.OFFENDER_ID%type,
	p_TEXT_ON_POSTER 	in   MT_MG_WANTED.TEXT_ON_POSTER%type,
	p_ACTION_BY 		in   MT_MG_WANTED.ACTION_BY%type
	)
IS
/*	
	Purpose:		Return the record set of the inmates with the matching Mug data 
	                to build wanted poster
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/  

  v_entity_id     			varchar2(16);  


BEGIN  
	SELECT ENTITY_ID 
	INTO v_entity_id 
	FROM MT_MG_IMAGE_DETAILS 
	WHERE OFFENDER_ID = p_offender_id;
	-- Need to check if v_entity_id is null before continuing
	
	BEGIN
		INSERT INTO MACOMB.MT_MG_WANTED (WANTED_ID, ENTITY_ID, OFFENDER_NUMBER, TEXT_ON_POSTER, 
		                                 ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (EPIC.epic_ids.new_epic_id(), v_entity_id, p_offender_id, p_TEXT_ON_POSTER,
		    	    'I', epic.epicdatenow(), p_ACTION_BY);
	EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.MT_MG_WANTED
				SET TEXT_ON_POSTER = p_TEXT_ON_POSTER, 
				    ACTION_TYPE = 'U', 
				    ACTION_TIME = epic.epicdatenow(),
			    	ACTION_BY = p_ACTION_BY
				WHERE OFFENDER_NUMBER = p_offender_id; 
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_mg_wanted_person
(	p_offender_id	in  EPIC.EH_OFFENDER_IDS.OFFENDER_ID%type,
	vCur		OUT		epic.epp_generic_ref_cursor.ref_cursor)
IS
/*	
	Purpose:		Return the record set of the inmates with the matching Mug data 
	                to build wanted poster
					
	Author:			Joseph McBratnie

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J MCBRATNIE  07/01/06		Created
*/ 
BEGIN  
	OPEN vCur FOR  
	select * 
	from MT_MG_IMAGE_DETAILS
	where p_offender_id = OFFENDER_ID ;
END;   
/

CREATE OR REPLACE
PROCEDURE        mp_OfficerUpdate
	 (	p_OffID		IN	MACOMB.mt_pb_arrest_officer.arrestofficer_pk%TYPE,
	 	p_Role 		IN 	MACOMB.mt_pb_arrest_officer.officerrole%TYPE,
	 	p_ArID		IN	MACOMB.mt_pb_arrest_officer.arrest_id%TYPE,
	 	p_Dpt		IN	MACOMB.mt_pb_arrest_officer.officerdepartment%TYPE,
	 	p_Nm		IN	MACOMB.mt_pb_arrest_officer.officername%TYPE,
	 	p_Bdg		IN	MACOMB.mt_pb_arrest_officer.officerbadge%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Updates the MACOMB.mt_pb_arrest_officer table based on input information
					This procedure is called by MACOMB.mp_pb_arrest2

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 03/17/06		Created 
	
*/  	 
BEGIN    
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrest_officer (arrestofficer_pk, arrest_id, officerdepartment, officerrole, officername, officerbadge)
		VALUES (p_OffID,
				p_ArID,
				p_Dpt,
				p_Role,
				p_Nm,
				p_Bdg);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN		
			UPDATE MACOMB.mt_pb_arrest_officer
			SET OfficerDepartment = p_Dpt,
				OfficerRole = p_Role,
				OfficerName = p_Nm,
				OfficerBadge = p_Bdg 
			WHERE Arrest_ID = p_ArID and OfficerRole = p_Role;
	END;		
COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE          mp_pb_arrest1
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_detail.arrest_id%TYPE,
	 p_ArDate		IN      varchar2, 
	 p_ArTime		IN      varchar2, 
	 p_ArWithID		IN      MACOMB.mt_pb_arrest_detail.arrestedwith_id%TYPE,
	 p_ArLoc		IN		MACOMB.mt_pb_arrest_detail.arrestlocation%TYPE,
	 p_ArCity		IN      MACOMB.mt_pb_arrest_detail.arrestcity%TYPE,
	 p_ArPrvHld		IN     	MACOMB.mt_pb_arrest_detail.arrestprevheld%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					R. Stuve      	03/15/06		Created   
					J. McBratnie 	04/02/06      	Updated the time to varchar2 to work with GUI
					R. Stuve	    07/27/06		Added Arrestdatetime field 
*/

BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrest_detail (arrest_id, arrestdate, arresttime, arrestedwith_id, arrestlocation, arrestcity, arreststate, arrestprevheld, arrestdatetime) 
   				VALUES (	p_ArrestID,
           					p_ArDate,  
           					p_ArTime,
           					p_ArWithID,
           					p_ArLoc,
           					p_ArCity,
           					'MI',
           					p_ArPrvHld,
           					to_date(p_ArDate || p_ArTime)
       					); 
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrest_detail
			SET arrestdate = p_ArDate,
				arresttime = p_ArTime,
				arrestedwith_id = p_ArWithID,
				arrestlocation = p_ArLoc,
				arrestcity = p_ArCity,
				arrestprevheld = p_ArPrvHld,
				arrestdatetime = to_date(p_ArDate  || p_ArTime) 
			WHERE arrest_id = p_ArrestID; 
   	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE                                                    mp_pb_arrest1a
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_detail.arrest_id%TYPE,
	 p_ArDate		IN      varchar2, 
	 p_ArTime		IN      varchar2,
	 p_ArWithID		IN      MACOMB.mt_pb_arrest_detail.arrestedwith_id%TYPE,
	 p_ArLoc		IN		MACOMB.mt_pb_arrest_detail.arrestlocation%TYPE,
	 p_ArCity		IN      MACOMB.mt_pb_arrest_detail.arrestcity%TYPE,
	 p_ArPrvHld		IN     	MACOMB.mt_pb_arrest_detail.arrestprevheld%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					R. Stuve      03/15/06		Created   
					J. McBratnbie 04/02/06      Updated the time to varchar2 to work with GUI
*/

v_dttm		date; 
 
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrest_detail (arrest_id, arrestdate, arresttime, arrestedwith_id, 
		                                        arrestlocation, arrestcity, arreststate, 
		                                        arrestprevheld) 
   				VALUES (	p_ArrestID,
       						p_ArDate, 
                                                p_ArTime,
                                                p_ArWithID,
           					p_ArLoc,
           					p_ArCity,
           					'MI',
           					p_ArPrvHld); 
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrest_detail
			SET arrestdate = p_ArDate,
				arresttime = p_ArTime,
				arrestedwith_id = p_ArWithID,
				arrestlocation = p_ArLoc,
				arrestcity = p_ArCity,
				arrestprevheld = p_ArPrvHld
			WHERE arrest_id = p_ArrestID; 
   	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest2 (
		p_ArrestID		IN		MACOMB.mt_pb_arrest_officer.arrest_id%TYPE,
		p_ArOffDpt		IN     	MACOMB.mt_pb_arrest_officer.officerdepartment%TYPE,
	 	p_ArOffNm		IN		MACOMB.mt_pb_arrest_officer.officername%TYPE,
	 	p_ArOffBdg		IN      MACOMB.mt_pb_arrest_officer.officerbadge%TYPE,
		p_TrnsDpt		IN      MACOMB.mt_pb_arrest_officer.officerdepartment%TYPE,
	 	p_TrnsNm		IN		MACOMB.mt_pb_arrest_officer.officername%TYPE,
	 	p_TrnsOffBdg 	IN     	MACOMB.mt_pb_arrest_officer.officerbadge%TYPE,
	 	p_VhTow			IN		MACOMB.mt_pb_arrest_detail.vehicletowedto%TYPE,
	 	p_OffIDT		IN		MACOMB.mt_pb_arrest_officer.arrestofficer_pk%TYPE,
	 	p_OffIDA		IN		MACOMB.mt_pb_arrest_officer.arrestofficer_pk%TYPE
	 )
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/17/06		Created
					R. Stuve	06/28/06		Changed mp_OfficerUpdate inputs from text (Arresting/Transporting) to lookup code values 
					R. Stuve	08/08/06		Added p_OffID fields for epic id for arrest/trans officer
*/
BEGIN    
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrest_detail (arrest_id, vehicletowedto)
		VALUES (p_ArrestID,
				 p_VhTow); 			
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN		
			UPDATE MACOMB.mt_pb_arrest_detail
			SET vehicletowedto = p_VhTow
			WHERE arrest_id = p_ArrestID;  						
	END;
		
		BEGIN
			MACOMB.mp_OfficerUpdate (p_OffIDA, '701', p_ArrestID, p_ArOffDpt, p_ArOffNm, p_ArOffBdg);  
			MACOMB.mp_OfficerUpdate (p_OffIDT, '702', p_ArrestID, p_TrnsDpt, p_TrnsNm, p_TrnsOffBdg);		
		END;
	
COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE   mp_pb_arrest3
	(p_ArrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 --p_ArrTime		IN		MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN      MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN      MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_MNm			IN      MACOMB.mt_pb_arrestee.middlename%TYPE,
--	 p_NmTp			IN      MACOMB.mt_pb_arrestee.code_name_type%TYPE,
	 p_NmSfx		IN      MACOMB.mt_pb_arrestee.name_suffix%TYPE,
	 p_NmTtl		IN		MACOMB.mt_pb_arrestee.name_title%TYPE,
	 p_SSN			IN      MACOMB.mt_pb_arrestee.ssn%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE,
	 p_InmID		IN      MACOMB.mt_pb_arrestee.offender_id%TYPE,
	 p_StID			IN      MACOMB.mt_pb_arrestee.state_id%TYPE,
	 p_FBI			IN      MACOMB.mt_pb_arrestee.fbi_id%TYPE,
	 p_Gnd			IN      MACOMB.mt_pb_arrestee.gender%TYPE,
	 p_CntBth		IN      MACOMB.mt_pb_arrestee.birthcountry%TYPE,
	 p_DOB			IN		MACOMB.mt_pb_arrestee.dob%TYPE,
	 p_TempHouse	IN		MACOMB.mt_pb_arrestee.temphousinglocation%TYPE
	 )
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/17/06		Created
					R. Stuve	05/02/06		Added fields: arrive_time, action_by, action_time
					R. Stuve	05/03/06		Removed ArrTime parameter and set to sysdate 
					R. Stuve	07/20/06		Added temporary housing parameter and insert 
					R. Stuve	08/23/06		Added action_time to update statement
*/
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, middlename, /*code_name_type, */ name_suffix, name_title, ssn, action_by, offender_id, state_id, fbi_id, gender, birthcountry, dob, temphousinglocation ) 
  		VALUES (p_ArrestID,
  				sysdate,
  				sysdate,
  				p_LNm,
              	p_FNm,
              	p_MNm,
              	p_NmSfx,
              	p_NmTtl,  
              	p_SSN,
              	p_ActionBy,
              	p_InmID,
              	p_StID,
              	p_FBI,
              	p_Gnd,
              	p_CntBth,
              	to_date(p_DOB),
              	p_TempHouse); 
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN   	
              	UPDATE MACOMB.mt_pb_arrestee
				SET action_time = sysdate,
					lastname = p_LNm,
					firstname = p_FNm,
					middlename = p_MNm,
					name_suffix = p_NmSfx,
					name_title = p_NmTtl,
					ssn = p_SSN,
					action_by = p_ActionBy,
					offender_id	= p_InmID,
					state_id = p_StID,
					fbi_id = p_FBI,
					gender = p_Gnd,
					birthcountry = p_CntBth,
					dob = to_date(p_DOB),
					temphousinglocation = p_TempHouse
				WHERE arrest_id = p_ArrestID;
	END;

COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE        mp_pb_arrest_Alerts_1
	(p_arrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
     p_Aslt			IN		MACOMB.mt_pb_arrestee.assultiveflag%TYPE,
     p_Med			IN		MACOMB.mt_pb_arrestee.medicalflag%TYPE,
     p_Suc			IN		MACOMB.mt_pb_arrestee.suicideflag%TYPE,
     p_CtnCmt		IN		MACOMB.mt_pb_arrestee.cautioncomment%TYPE,
     p_DfSp			IN		MACOMB.mt_pb_arrestee.sprayflag%TYPE,
     p_DfSpDt		IN		MACOMB.mt_pb_arrestee.spraywhen%TYPE,
     p_DfElc		IN		MACOMB.mt_pb_arrestee.electroshockflag%TYPE,
     p_DfElcDt		IN		MACOMB.mt_pb_arrestee.electroshockwhen%TYPE,
     p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/20/06		Created 
					R. Stuve	05/12/06		Added to_date function on date fields
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	08/23/06		Added action_time to insert and update statement
*/

BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, assultiveflag, medicalflag, suicideflag, cautioncomment, sprayflag, spraywhen, electroshockflag, electroshockwhen) 
  		VALUES (	p_ArrestID,
  					sysdate,
  					sysdate,
  					p_LNm,
	  		        p_FNm,
	  		        p_ActionBy,
   					p_Aslt,
					p_Med,
					p_Suc,
					p_CtnCmt,
					p_DfSp,
					to_date(p_DfSpDt),
					p_DfElc,
					to_date(p_DfElcDt));
	    EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN	
			UPDATE MACOMB.mt_pb_arrestee
			SET action_time = sysdate,
				lastname = p_LNm,
				firstname = p_FNm,
				action_by = p_ActionBy,
				assultiveflag = p_Aslt,
				medicalflag = p_Med, 
				suicideflag = p_Suc,
				cautioncomment = p_CtnCmt, 
				sprayflag = p_DfSp, 
				spraywhen = to_date(p_DfSpDt), 
				electroshockflag = p_DfElc, 
				electroshockwhen = to_date(p_DfElcDt)                               		
			WHERE arrest_id = p_arrestID; 
   		END;

COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_birth
	(p_arrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_DOB			IN		MACOMB.mt_pb_arrestee.dob%TYPE,
	 p_BCity		IN		MACOMB.mt_pb_arrestee.birthcity%TYPE,
	 p_BState		IN		MACOMB.mt_pb_arrestee.birthstate%TYPE,
	 p_BCntry		IN		MACOMB.mt_pb_arrestee.birthcountry%TYPE,
	 p_RelPref		IN		MACOMB.mt_pb_arrestee.religiouspref%TYPE,
	 p_USCit		IN		MACOMB.mt_pb_arrestee.uscitizen%TYPE,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	-------------------
					R. Stuve    03/20/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	08/23/06		Added action_time to insert and update
*/
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, dob, birthcity, birthstate, birthcountry, religiouspref, uscitizen) 
   		VALUES (p_ArrestID,
   				sysdate,
   				sysdate,
  		        p_LNm,
  		        p_FNm,
  		        p_ActionBy,
   				to_date(p_DOB),
   				p_BCity,
   				p_BState,
   				p_BCntry,
   				p_RelPref,
   				p_USCit); 
  	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN		
  			UPDATE MACOMB.mt_pb_arrestee
			SET action_time = sysdate,
				lastname = p_LNm,
				firstname = p_FNm,
				action_by = p_ActionBy,
				dob = to_date(p_DOB),
				birthcity = p_BCity,
				birthstate = p_BState,
				birthcountry = p_BCntry,
				religiouspref = p_RelPref,
				uscitizen = p_USCit
			WHERE arrest_id = p_arrestID; 
	END;

COMMIT;
END;  
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_charge
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_charge.arrest_id%TYPE,
	 p_ChargeID		IN		MACOMB.mt_pb_arrest_charge.charge_id%TYPE,
	 p_Ch			IN		MACOMB.mt_pb_arrest_charge.charge%TYPE,	
     p_PACC 	    IN		MACOMB.mt_pb_arrest_charge.pacc%TYPE,
	 p_IncNum       IN		MACOMB.mt_pb_arrest_charge.incidentnumber%TYPE,
	 p_Year 		IN		MACOMB.mt_pb_arrest_charge.crimeyear%TYPE,
	 p_Count        IN		MACOMB.mt_pb_arrest_charge.count%TYPE,
	 p_Class        IN		MACOMB.mt_pb_arrest_charge.class%TYPE,
	 p_ArRs         IN		MACOMB.mt_pb_arrest_charge.arrestreason%TYPE,
	 p_CrtNm        IN		MACOMB.mt_pb_arrest_charge.courtname%TYPE,
	 p_CmpAgy       IN		MACOMB.mt_pb_arrest_charge.complaintagency%TYPE,
	 p_ArrAgy       IN		MACOMB.mt_pb_arrest_charge.arrestagency%TYPE,
	 p_CTN          IN		MACOMB.mt_pb_arrest_charge.ctn%TYPE,
	 p_TCN          IN		MACOMB.mt_pb_arrest_charge.tcn%TYPE,
	 p_StatID		IN		MACOMB.mt_pb_arrest_charge.statute_id%TYPE
	)

IS
/*
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Expedited Booking system
					(Charge)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/24/06		Created 
					R. Stuve	07/31/06		Added statute_id
*/
BEGIN
	BEGIN 
		INSERT INTO MACOMB.mt_pb_arrest_charge (arrest_id, charge_id, charge, pacc, incidentnumber, crimeyear, count, class, arrestreason, courtname, complaintagency, arrestagency, ctn, tcn, statute_id)
  		VALUES (p_ArrestID,
   				p_ChargeID,
				p_Ch,	
				p_PACC,
				p_IncNum,
				p_Year,
				p_Count,
				p_Class,
				p_ArRs,
				p_CrtNm,
				p_CmpAgy,
				p_ArrAgy,
				p_CTN,
				p_TCN,
				p_StatID);
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.mt_pb_arrest_charge
				SET arrest_id = p_ArrestID,
					charge = p_Ch,
					pacc = p_PACC,
					incidentnumber = p_IncNum,
					crimeyear = p_Year,
					count = p_Count,
					class = p_Class,
					arrestreason = p_ArRs,
					courtname = p_CrtNm,
					complaintagency = p_CmpAgy,
					arrestagency = p_ArrAgy,
					ctn = p_CTN,
			 		tcn = p_TCN,
			 		statute_id = p_StatID
			WHERE charge_id = p_ChargeID;
   END;

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_charge_delete
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_charge.arrest_id%TYPE,
	 p_ChargeID		IN		MACOMB.mt_pb_arrest_charge.charge_id%TYPE)

IS
/*
	Purpose:		Delete a record from a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Expedited Booking system
					(Charge)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    05/15/06		Created
*/
BEGIN
	BEGIN 
		DELETE FROM MACOMB.mt_pb_arrest_charge 
		WHERE arrest_id = p_ArrestID and charge_id = p_ChargeID;
	END;

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_demog
	(p_arrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_height		IN		MACOMB.mt_pb_arrestee.height%TYPE,
	 p_weight		IN		MACOMB.mt_pb_arrestee.weight%TYPE,
	 p_race			IN		MACOMB.mt_pb_arrestee.race%TYPE,  
	 p_gender		IN		MACOMB.mt_pb_arrestee.gender%TYPE,
	 p_eye			IN		MACOMB.mt_pb_arrestee.eyeright%TYPE,
	 p_hair			IN		MACOMB.mt_pb_arrestee.hair%TYPE,
	 p_comp			IN		MACOMB.mt_pb_arrestee.complexion%TYPE,
	 p_mar			IN		MACOMB.mt_pb_arrestee.maritalstatus%TYPE,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE 
	 --p_build		IN		MACOMB.mt_pb_arrestee.build%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/20/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	08/23/06		Added action_time to insert and update
*/
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, height, weight, race, gender, eyeright, eyeleft, hair, complexion, maritalstatus /*, build)*/) 
   		VALUES (p_ArrestID,
   				sysdate,
   				sysdate,
  		        p_LNm,
  		        p_FNm,
  		        p_ActionBy,
   				p_height,
   				p_weight,
   				p_race,
   				p_gender,
   				p_eye,
   				p_eye,
   				p_hair,
   				p_comp,
   				p_mar);
   				--p_build
  		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN		
   				UPDATE MACOMB.mt_pb_arrestee
				SET action_time = sysdate,
					lastname = p_LNm,
					firstname = p_FNm,
					action_by = p_ActionBy,
					height = p_height,
					weight = p_weight,
					race = p_race,
					gender = p_gender,
					eyeright = p_eye,
					eyeleft = p_eye,
					hair = p_hair,
					complexion = p_comp,
					maritalstatus = p_mar
					--build = p_build
				WHERE arrest_id = p_arrestID; 
	END;

COMMIT;
END;  
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_DL
	(p_arrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_DLID			IN		MACOMB.mt_pb_arrestee.dl_id%TYPE,
	 p_DL			IN		MACOMB.mt_pb_arrestee.dlnumber%TYPE,
	 p_DLState		IN		MACOMB.mt_pb_arrestee.dlstate%TYPE,
	 p_SSN			IN		MACOMB.mt_pb_arrestee.ssn%TYPE,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/20/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	07/27/06		Added DL ID field for Driver's License epic id 
					R. Stuve	08/23/06		Added action_time to insert and update
*/
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, dl_id, action_time, arrive_time, lastname, firstname, action_by, dlnumber, dlstate, ssn) 
   		VALUES (p_ArrestID,
   				p_DLID,
   				sysdate, 
   				sysdate,
  		        p_LNm,
  		        p_FNm,
  		        p_ActionBy,
   				p_DL,
   				p_DLState,
   				p_SSN);  
  EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrestee
			SET dl_id = p_DLID,
				action_time = sysdate,
				lastname = p_LNm,
				firstname = p_FNm,
				action_by = p_ActionBy,
				dlnumber = p_DL,
				dlstate = p_DLState,
				ssn = p_SSN
			WHERE arrest_id = p_arrestID; 
	END;
	
COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE        mp_pb_arrest_EmergCnt
	(p_arrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
     p_ECNmF		IN		MACOMB.mt_pb_arrestee.emergencycontact%TYPE,
     p_ECNmL		IN		MACOMB.mt_pb_arrestee.emergencycontact%TYPE,
     p_ECID			IN		MACOMB.mt_pb_arrestee.ec_person_id%TYPE,
     p_ECRel		IN		MACOMB.mt_pb_arrestee.emergencyrelationship%TYPE,
     p_ECPhID		IN		MACOMB.mt_pb_arrestee.ec_phone_id%TYPE,
     p_ECPh			IN		varchar2,
     p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	)
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/22/06		Created
					R. Stuve	06/12/06		Removed references to Marital Status and Religious Pref
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	07/27/06		Added EC person/phone id and country code
					R. Stuve	07/31/06		Added First and Last Names for Emg. Contact 
					R. Stuve	08/23/06		Added action_time to insert and update 
					R. Stuve    11/27/06		Added ec_phone_type 
					R. Stuve	11/28/06		Added UPPER function to emergency contact name
*/
 
BEGIN     
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, ec_person_id, emergencycontact, emergencyrelationship, ec_phone_id, ec_phone_country_code, ec_phone_area_code, ec_phone_number, ec_phone_type) 
  		VALUES (	p_ArrestID,
  					sysdate,
  					sysdate,
	  				UPPER(p_LNm),
	  		        UPPER(p_FNm),
	  		        p_ActionBy,
	  		        p_ECID,
   					UPPER(p_ECNmF) || ' ' || UPPER(p_ECNmL),
   					p_ECRel,
   					p_ECPhID,
   					'001',
   					substr(p_ECPh,1,3),
					substr(p_ECPh,4),
					'HOME'
				);	
		EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrestee
			SET action_time = sysdate,
				lastname = UPPER(p_LNm),
				firstname = UPPER(p_FNm),
				action_by = p_ActionBy,
				ec_person_id = p_ECID,
				emergencycontact = UPPER(p_ECNmF) || ' ' || UPPER(p_ECNmL),
				emergencyrelationship = p_ECRel,
				ec_phone_id = p_ECPhID, 
				ec_phone_country_code = '001',
				ec_phone_area_code = substr(p_ECPh,1,3),
				ec_phone_number = substr(p_ECPh,4),
				ec_phone_type = 'HOME'		
			WHERE arrest_id = p_arrestID; 
	END;

COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE               mp_pb_arrest_homeadd
	(p_ArrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_AddID		IN		MACOMB.mt_pb_arrestee.rs_address_id%TYPE,
	 p_AdNum		IN		MACOMB.mt_pb_arrestee.rs_street_number%TYPE,
	 p_AdSt			IN		MACOMB.mt_pb_arrestee.rs_street_name%TYPE,
	 p_City			IN		MACOMB.mt_pb_arrestee.rs_city_town_locale%TYPE,
	 p_State		IN     	MACOMB.mt_pb_arrestee.rs_state_province_region%TYPE,
	 p_Zip         	IN		MACOMB.mt_pb_arrestee.rs_postal_code%TYPE,
	 p_Cntry		IN		MACOMB.mt_pb_arrestee.rs_code_country%TYPE,
	 p_PhoneID		IN		MACOMB.mt_pb_arrestee.rs_phone_id%TYPE,
	 p_HmPh			IN		varchar2,
	 p_PhCntry		IN		MACOMB.mt_pb_arrestee.rs_phone_country_code%TYPE,
	 p_CellID		IN		MACOMB.mt_pb_arrestee.cl_phone_id%TYPE,
	 p_ClPh			IN		varchar2,
	 p_ClCntry		IN		MACOMB.mt_pb_arrestee.cl_phone_country_code%TYPE,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE,
	 p_Home			IN		MACOMB.mt_pb_arrestee.homeless%TYPE
	)

IS
/*
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/20/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters 
					R. Stuve	07/02/04		Added RS/CL phone type fields
					R. Stuve	07/28/06		Added homeless flag
					R. Stuve	07/31/06		Added rs_code_country
					R. Stuve	08/23/06		Added action_time to insert and update
*/
BEGIN
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, homeless, rs_address_id, rs_street_number, rs_street_name, rs_city_town_locale, rs_state_province_region, rs_postal_code, rs_code_country, rs_phone_id, rs_phone_country_code, rs_phone_area_code, rs_phone_number,rs_phone_type, cl_phone_id, cl_phone_country_code,cl_phone_area_code, cl_phone_number, cl_phone_type)
  		VALUES (p_ArrestID,
  		        sysdate,
  		        sysdate,
  		        p_LNm,
  		        p_FNm,
  		        p_ActionBy,
  		        p_Home,
  		        p_AddID,
   				p_AdNum,
   				p_AdSt,
   				p_City,
   				p_State,
   				p_Zip,
   				p_Cntry,
   				p_PhoneID,
   				p_PhCntry,
   				substr(p_HmPh,1,3),
   				substr(p_HmPh,4),
   				'HOME',
   				p_CellID, 
   				p_ClCntry,
   				substr(p_ClPh,1,3),
   				substr(p_ClPh,4),
   				'MOBILE');
	   EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
				UPDATE MACOMB.mt_pb_arrestee
				SET action_time = sysdate,
					lastname = p_LNm,
					firstname = p_FNm,
					action_by = p_ActionBy,
					homeless = p_Home,
					rs_address_id = p_AddID,
					rs_street_number  = p_AdNum,
					rs_street_name  = p_AdSt,
					rs_city_town_locale = p_City,
					rs_state_province_region = p_State,
					rs_postal_code = p_Zip,
					rs_code_country = p_Cntry,
					rs_phone_id = p_PhoneID,
					rs_phone_country_code = p_PhCntry,
					rs_phone_area_code = substr(p_HmPh,1,3),
					rs_phone_number = substr(p_HmPh,4),
					rs_phone_type = 'HOME',
					cl_phone_id = p_CellID,
					cl_phone_country_code = p_ClCntry,
					cl_phone_area_code = substr(p_ClPh,1,3),
					cl_phone_number = substr(p_ClPh,4),
					cl_phone_type = 'MOBILE'
				WHERE arrest_id = p_ArrestID;
	END;

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_pb_arrest_LangEmp
	(p_ArrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_Lang			IN		MACOMB.mt_pb_language.languagetype%TYPE,
	 p_LangID		IN		MACOMB.mt_pb_language.language_id%TYPE,
	 p_LanR			IN      MACOMB.mt_pb_arrestee.ENGLISHREAD%TYPE,
	 p_LanW         IN      MACOMB.mt_pb_arrestee.ENGLISHWRITTEN%TYPE,
	 p_LanS         IN      MACOMB.mt_pb_arrestee.ENGLISHSPOKEN%TYPE,
	 p_Edu          IN      MACOMB.mt_pb_arrestee.educationlevel%TYPE,
	 p_EmpID		IN		MACOMB.mt_pb_arrestee.employement_id%TYPE,
	 p_Occ          IN      MACOMB.mt_pb_arrestee.occupation%TYPE,
	 p_EmpNm        IN      MACOMB.mt_pb_arrestee.employername%TYPE,
	 p_EmpAdID		IN		MACOMB.mt_pb_arrestee.em_address_id%TYPE,
	 p_EmpANum	    IN     	MACOMB.mt_pb_arrestee.em_street_number%TYPE,
	 p_EmpAStr	    IN     	MACOMB.mt_pb_arrestee.em_street_name%TYPE,
	 p_EmpACt		IN     	MACOMB.mt_pb_arrestee.em_city_town_locale%TYPE,
	 p_EmpASt		IN    	MACOMB.mt_pb_arrestee.em_state_province_region%TYPE,
	 p_EmpAZip		IN    	MACOMB.mt_pb_arrestee.em_postal_code%TYPE,
	 p_EmpPhID		IN		MACOMB.mt_pb_arrestee.em_phone_id%TYPE,
	 p_EmpPh		IN		varchar2,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	 )
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Information Match

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/22/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters 
					R. Stuve	06/19/06		Edited em_phone_number to be one string start at character 4
					R. Stuve	07/27/06		Added employer id, employer address id, and employer phone id (epic id's)
					R. Stuve	08/23/06		Added action_time to insert and update
					R. Stuve	11/27/06		Added em_phone_type
*/
BEGIN    
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, action_by, educationlevel, employement_id, occupation, employername, em_address_id, em_street_number, em_street_name, em_city_town_locale, em_state_province_region, em_postal_code, em_phone_id, em_code_country, em_phone_country_code, em_phone_area_code, em_phone_number, em_phone_type, englishspoken, englishread, englishwritten)
		VALUES (p_ArrestID,
				sysdate,
				sysdate,
  		        p_LNm,
  		        p_FNm,
  		        p_ActionBy,
				p_Edu,
				p_EmpID,
				p_Occ,
				p_EmpNm,
				p_EmpAdID,
				p_EmpANum,
				p_EmpAStr,
				p_EmpACt,
				p_EmpASt,
				p_EmpAZip,
				p_EmpPhID,
				'US',
				'001',
				substr(p_EmpPh,1,3),
				substr(p_EmpPh,4),
				'WORK',
				p_LanS,
				p_LanW,
				p_LanR); 
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrestee
			SET action_time = sysdate,
				lastname = p_LNm,
				firstname = p_FNm,
				action_by = p_ActionBy,
				educationlevel = p_Edu,
				employement_id = p_EmpID,
				occupation = p_Occ,
				employername = p_EmpNm,
				em_address_id = p_EmpAdID,
				em_street_number = p_EmpANum,
				em_street_name = p_EmpAStr,
				em_city_town_locale = p_EmpACt,
				em_state_province_region = p_EmpASt,
				em_postal_code = p_EmpAZip,
				em_phone_id = p_EmpPhID,
				em_code_country = 'US',
				em_phone_country_code = '001',
				em_phone_area_code = substr(p_EmpPh,1,3), 
				em_phone_number = substr(p_EmpPh,4),
				em_phone_type = 'WORK',
				englishspoken = p_LanS,
				englishwritten = p_LanW,
				englishread = p_LanR 
			WHERE arrest_id = p_ArrestID;  
	END;
	
	BEGIN
		MACOMB.mp_LanguageUpdate (p_LangID, p_ArrestID, p_Lang);  		
	END;
	
COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_maiden
	(p_ArrestID		IN		MACOMB.mt_pb_arrestee.arrest_id%TYPE,
	 p_LNm			IN		MACOMB.mt_pb_arrestee.lastname%TYPE,
	 p_FNm			IN		MACOMB.mt_pb_arrestee.firstname%TYPE,
	 p_SSN			IN		MACOMB.mt_pb_arrestee.ssn%TYPE,
	 p_MNm			IN		MACOMB.mt_pb_arrestee.middlename%TYPE,
	 p_NmSx			IN		MACOMB.mt_pb_arrestee.name_suffix%TYPE,
	 p_MadNm		IN		MACOMB.mt_pb_arrestee.maidenname%TYPE,
	 p_ArrTime		IN	    MACOMB.mt_pb_arrestee.arrive_time%TYPE,
	 p_ActionBy		IN		MACOMB.mt_pb_arrestee.action_by%TYPE
	 )
		
IS
/*	
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Inmate Demographic Information

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/21/06		Created
					R. Stuve	06/12/06		Added Arrive_Time and Action_By parameters
					R. Stuve	08/01/06		Added First/Last Name parameters for alias
					R. Stuve	08/02/06		Removed alias refernces due to addition of alias grid to GUI
					R. Stuve	08/23/06		Added action_time to insert and update
*/
BEGIN  
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrestee (arrest_id, arrive_time, action_time, lastname, firstname, ssn, middlename, name_suffix, maidenname, action_by) 
   		VALUES (p_ArrestID,
   				sysdate,
   				sysdate,
   				p_LNm,
   				p_FNm,
   				p_SSN,
              	p_MNm,
              	p_NmSx,
              	p_MadNm,
              	p_ActionBy); 
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrestee
			SET action_time = sysdate,
				lastname = p_LNm,
				firstname = p_FNm,
				ssn = p_SSN,
				middlename = p_MNm,
				name_suffix = p_NmSx,
				maidenname = p_MadNm,
				action_by = p_ActionBy				
			WHERE arrest_id = p_ArrestID; 
	END;
	
	--BEGIN
	--	MACOMB.mp_AliasUpdate (p_ArrestID, p_AliasID1, p_Alias1F, p_Alias1L);  
	--	MACOMB.mp_AliasUpdate (p_ArrestID, p_AliasID2, p_Alias2F, p_Alias2L);
	--END;

COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE         mp_PB_arrest_processing
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE,
	 	p_booking_id		IN	EPIC.eh_booking.booking_id%TYPE, 
	 	p_matched_id        IN  macomb.MT_PB_ARRESTEE.MATCHEDOFFENDER_ID%type,
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - Wrapper program to save that
					Data needed for the follow the process
					NOTE:  p_arrrest_id = entity_id
	Process:		IF fresh arrest
						Update person with minimal details
					END IF                               
					create the inital booking
					create the inital housing
					create the Arrest details
					
					After the booking process is complete and the button
					"Send to Offendertrak" is pushed  Then mp_pb_wrapper_final
					will be called

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					J. McBratnie  05/06/06		Created 
					R. Stuve	  06/08/06		Added IF statements based on v_result_msg 
					R. Stuve	  06/27/06		Initial testing of EHI insert statements (individually commented). 
												Edited as appropriate to de-bug	 
					R. Stuve	  06/30/06		Unit testing: commented results within code
					J. McBratnie  07/01/06      Updated decode on arresting/transporting officer to allow codes in 
												standard epic form and text form.  
					R. Stuve	  10/06/05		Updated Electroshock/Taser GA wording to match attribute text
					R. Stuve	  11/30/06		Added EPICDATE function to shockwhen/spraywhen fields  
					R. Stuve	  12/5/06		Edited electroshock/spray flag to only populate when "yes"
*/  	 
v_arrest_incident		VARCHAR2(16);
v_vehicletowedto		MACOMB.mt_pb_arrest_detail.vehicletowedto%type;
v_vehicletowedtotext	EPIC.epic_lookups.text_full%TYPE;
v_arrestdate            DATE;
v_arrestlocation       	MACOMB.mt_pb_arrest_detail.arrestlocation%type;
v_arrestprevheld		MACOMB.mt_pb_arrest_detail.arrestprevheld%type; 

v_arrestofficer_pk      MACOMB.mt_pb_arrest_officer.arrestofficer_pk%type;
v_officerdepartment     MACOMB.mt_pb_arrest_officer.officerdepartment%type;
v_officerrole           MACOMB.mt_pb_arrest_officer.officerrole%type;
v_officername           MACOMB.mt_pb_arrest_officer.officername%type;
v_officerbadge          MACOMB.mt_pb_arrest_officer.officerbadge%type;

v_result				EPIC.epic_col_types.number_9%type;
v_result_msg 			EPIC.epic_col_types.varchar_255%type; 

v_ArrestOfficerCode		EPIC.eh_arrest_roles.officer_role%type;
v_transportingOfficer	EPIC.eh_arrest_roles.officer_role%type;
v_AlertSource			EPIC.epic_lookups.lookup_code%type;   
v_alert_remarks         VARCHAR2(60);
v_code_service			VARCHAR2(5);
v_assultiveflag         VARCHAR2(60); 
v_medicalflag         	VARCHAR2(60);
v_suicideflag         	VARCHAR2(60);
v_sprayflag         	VARCHAR2(60);
v_spraywhen         	VARCHAR2(60);
v_electroshockflag      VARCHAR2(60);
v_electroshockwhen      VARCHAR2(60);
v_cautioncomment	    VARCHAR2(60);
v_incident				VARCHAR2(64);

CURSOR MC_officer_cursor IS
	SELECT 	arrestofficer_pk,officerdepartment,officerrole,officername,officerbadge
	FROM MACOMB.mt_pb_arrest_officer
	WHERE arrest_id = p_arrest_id;


BEGIN   
	-- Code setup
	v_alert_remarks := 'Booking Card Information'; -- Standard message stating the source of the ALERT
	v_code_service := 'PPSER'; 
	v_arrest_incident := EPIC.epic_ids.new_epic_id();
	p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
	p_errormsg := null; 
	
	--select the incident number
	BEGIN
		SELECT incidentnumber
		INTO v_incident
		FROM MACOMB.mt_pb_arrest_charge
		WHERE arrest_id = p_arrest_id;	
	END;
 		
	BEGIN
		SELECT lookup_code 
		INTO  v_AlertSource
		FROM EPIC.epic_lookups            
		WHERE lookup_class LIKE 'ALERT SOURCE'
		  AND text_full = 'Arresting Agency';  
	END;
	
/*	not needed due to code being saved into pb tables
	BEGIN
		SELECT lookup_code 
		INTO  v_ArrestOfficerCode
		FROM EPIC.epic_lookups            
		WHERE lookup_class LIKE 'ARRESTINGOFFICERS'
		  AND text_full = 'ARRESTING OFFICER';  
	END;
	BEGIN
		SELECT lookup_code 
		INTO  v_transportingOfficer
		FROM EPIC.epic_lookups            
		WHERE lookup_class LIKE 'ARRESTINGOFFICERS'
		  AND text_full = 'TRANSPORTING OFFICER';  
	END; 
*/ 

	BEGIN
		-- Only one record here.
		SELECT assultiveflag,medicalflag,suicideflag,sprayflag,EPIC.epicdate(spraywhen),electroshockflag,EPIC.epicdate(electroshockwhen),cautioncomment 
		INTO v_assultiveflag,v_medicalflag,v_suicideflag,v_sprayflag,v_spraywhen,v_electroshockflag,v_electroshockwhen,v_cautioncomment 
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id;
	END;
	
	BEGIN
		SELECT  arrestdatetime, (arrestlocation || ', ' || arrestcity), arrestprevheld, vehicletowedto
		INTO    v_arrestdate, v_arrestlocation, v_arrestprevheld, v_vehicletowedto
		FROM    MACOMB.mt_pb_arrest_detail   
		WHERE 	arrest_id = p_arrest_id;
	END;
	
 	--insert the arrest incident
 	EPIC.ehi_eh_entity_arrest_incident(v_arrest_incident,v_incident,p_booking_id,null,v_arrestlocation,EPIC.epicdate(v_arrestdate),v_arrestlocation,EPIC.epicdate(v_arrestdate),p_action_by,'I',v_result,v_result_msg);
    
    
    OPEN MC_officer_cursor;
	LOOP 
		FETCH MC_officer_cursor 
		INTO v_arrestofficer_pk, v_officerdepartment, v_officerrole, v_officername, v_officerbadge;
		EXIT WHEN  MC_officer_cursor%NOTFOUND; 
		
		--insert arresting/transporting officerts
		EPIC.ehi_eh_arrest_roles(EPIC.epic_ids.new_epic_id(),v_arrest_incident,v_officerrole,v_officername,v_officerbadge,null,v_officerdepartment,p_action_by,'I',v_result,v_result_msg);  
	END LOOP;
	CLOSE MC_officer_cursor;
				
	-- Prev Held location, if one was entered.
	IF v_arrestprevheld IS NOT NULL THEN
 		--insert the prev held location
    	EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'PREVIOUS HELD LOCATION',v_arrestprevheld,p_action_by,'I',v_result,v_result_msg);
		IF v_result <> 0 THEN
 			BEGIN                                      
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
	END IF;    

	-- Vehicle details, if one was entered.
	IF v_vehicletowedto IS NOT NULL THEN  
		--find the vehicle towing company text name
		BEGIN
			SELECT EPIC.ef_lookup_text('VEHICLE TOW COMPANY',towcompanycode,'UC')
			INTO v_vehicletowedtotext
			FROM MACOMB.mt_pb_tow_details
			WHERE towcomany_id = v_vehicletowedto;
		END;
 		--insert where the vehicle was towed to
    	EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'VEHICLE TOWED TO',v_vehicletowedtotext,p_action_by,'I',v_result,v_result_msg);
		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
	END IF;    

    --insert the electric shock properties
	IF (v_electroshockflag = 'Y') THEN  
	    EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'EXPOSED TO DEFENSIVE ELECTRONIC SHOCK MANAGEMENT (TASER)',NVL(v_electroshockflag,'N'),p_action_by,'I',v_result,v_result_msg );
	    IF v_result <> 0 THEN
			BEGIN
	   			p_errornum := v_result; 
	   			p_errormsg := v_result_msg;  
	   			RETURN;
	   		END;
	   	END IF; 	
	   	        
		--insert the electric shock time
		EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'DATE - TIME EXPOSED TO DEFENSIVE ELECTRONIC SHOCK MANAGEMENT (TASER)',v_electroshockwhen,p_action_by,'I',v_result,v_result_msg );
		    IF v_result <> 0 THEN
				BEGIN
	       			p_errornum := v_result; 
	       			p_errormsg := v_result_msg;  
	       			RETURN;
	       		END;
	    	END IF; 	                         
	END IF;
    --insert the defense spray properties
	IF (v_sprayflag = 'Y') THEN
	    EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'EXPOSED TO DEFENSE SPRAY PRIOR/DURING ARREST',NVL(v_sprayflag,'N'),p_action_by,'I',v_result,v_result_msg);
	    IF v_result <> 0 THEN
			BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; 
	       	END;
	   	END IF;
	   	 	       
		--insert the defense spray time
		EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(),v_arrest_incident,'DATE - TIME EXPOSED TO DEFENSE SPRAY',v_spraywhen,p_action_by,'I',v_result,v_result_msg);
			IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN;
		       	END;
		   	END IF; 	                       
	END IF;		

	IF v_medicalflag IS NOT NULL THEN
	 	IF v_medicalflag = 'Y'  then  
	 	    -- do we need to check for duplicate alerts??????
	 	    --insert medical alerts
	 		EPIC.ehi_eh_entity_alerts(p_matched_id,EPIC.epic_ids.new_epic_id(),'Y','MEDICAL',v_AlertSource,p_action_by,epic.epicdatenow(),null,null,v_alert_remarks,p_action_by,v_code_service,'I',v_result,v_result_msg);
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		       	END;
	    	END IF; 	
	 	END IF;
	END IF;
	
	IF v_suicideflag IS NOT NULL THEN
	 	IF  v_suicideflag = 'Y' then
	 		--insert suicide alerts
	 		EPIC.ehi_eh_entity_alerts(p_matched_id,EPIC.epic_ids.new_epic_id(),'Y','SUICIDAL',v_AlertSource,p_action_by,epic.epicdatenow(),null,null,v_alert_remarks,p_action_by,v_code_service,'I',v_result,v_result_msg);
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN;
		       	END;
		   	END IF; 	
	 	END IF;
    END IF;
    
	IF v_assultiveflag IS NOT NULL THEN
		IF v_assultiveflag = 'Y' then
			--insert assultive alerts
	 		EPIC.ehi_eh_entity_alerts(p_matched_id,EPIC.epic_ids.new_epic_id(),'Y','ASSAULTIVE',v_AlertSource,p_action_by,epic.epicdatenow(),null,null,v_alert_remarks,p_action_by,v_code_service,'I',v_result,v_result_msg);
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		       	END;
		   	END IF; 	
		END IF;
	END IF;	  
	
	IF v_cautioncomment IS NOT NULL THEN
	 	IF v_cautioncomment = 'Y' then                                 
	 		--insert the caution comments
	 		EPIC.ehi_eh_entity_alerts(p_matched_id,EPIC.epic_ids.new_epic_id(),'Y','PRC',v_AlertSource,p_action_by,epic.epicdatenow(),null,null,v_alert_remarks,p_action_by,v_code_service,'I',v_result,v_result_msg);
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		       	END;
		   	END IF; 	
	 	END IF;
	END IF;
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_property
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_property.arrest_id%TYPE,
	 p_PropID		IN		MACOMB.mt_pb_arrest_property.property_id%TYPE,
	 p_Prop			IN		MACOMB.mt_pb_arrest_property.property%TYPE,
	 p_Desc			IN		MACOMB.mt_pb_arrest_property.description%TYPE,
	 p_Image		IN		MACOMB.mt_pb_arrest_property.image%TYPE,
	 p_Quant		IN		MACOMB.mt_pb_arrest_property.quantity%TYPE,
	 p_Color		IN		MACOMB.mt_pb_arrest_property.color%TYPE
	)

IS
/*
	Purpose:		Populate/update a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Expedited Booking system
					(Property)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/27/06		Created
*/
BEGIN
	BEGIN
		INSERT INTO MACOMB.mt_pb_arrest_property (arrest_id, property_id, property, description, image, quantity, color)
  		VALUES (	p_ArrestID,
   					p_PropID,
   					p_Prop,
   					p_Desc,
   					p_Image, 
   					p_Quant,  
   					p_Color);
	    EXCEPTION 
			WHEN DUP_VAL_ON_INDEX THEN
			UPDATE MACOMB.mt_pb_arrest_property
			SET arrest_id = p_ArrestID,
				property = p_Prop,
				description = p_Desc,
				image = p_Image,        
				quantity = p_Quant,   
				color = p_Color				
			WHERE property_id = p_PropID;
   END;

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_arrest_property_delete
	(p_ArrestID		IN		MACOMB.mt_pb_arrest_property.arrest_id%TYPE,
	 p_PropID		IN		MACOMB.mt_pb_arrest_property.property_id%TYPE,
	 p_error		OUT		varchar2)

IS
/*
	Purpose:		Delete a record from a table in the MACOMB schema that saves data intermediately
					so as to speed up the final save of information from the Expedited Booking system
					(Property)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    05/15/06		Created
*/
BEGIN
	BEGIN 
		DELETE FROM MACOMB.mt_pb_arrest_property
		WHERE arrest_id = p_ArrestID and property_id = p_PropID;
	END;

COMMIT;
END;

/

CREATE OR REPLACE
PROCEDURE         mp_PB_booking_processing
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE,
	 	p_booking_id		IN	EPIC.eh_booking.booking_id%TYPE,
	 	p_matched_id        IN  MACOMB.mt_pb_arrestee.matchedoffender_id%TYPE,
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - Wrapper program to save that
					Data needed for the follow the process
					NOTE:  p_arrrest_id = entity_id
	Process:		IF fresh arrest
						Update person with minimal details
					END IF                               
					create the inital booking
					create the inital housing
					create the Arrest details
					
					After the booking process is complete and the button
					"Send to OffenderTrak" is pushed  Then mp_pb_wrapper_final
					will be called.

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	05/06/06		Created 
					R. Stuve		06/05/06		Edited to complete input parameters: booking number is only field left to calculate
					J. MCBRATNIE	06/07/06		Updated select into
					R. Stuve	  	06/12/06		Added IF statements based on v_result_msg  
					R. Stuve		06/23/06		Initial testing of EHI insert statements (individually commented)
					R. Stuve		06/29/06		Preliminary unit testing on entire procedure: successful insert & error throw
					J. MCBRATNIE	07/14/06		Updated eh_booking call to handle defaults    
					R. Stuve		08/17/06		Added if statement to housing assignment insert; increased allowable size of error message
					R. Stuve		10/05/06		Added WHERE clause to goodtimerate selection; 
					R. Stuve		12/06/05		Added v_entitystatus (set to NOSTATUS)
*/ 

v_facility_id		varchar2(16);
v_location_id   	MACOMB.mt_pb_arrestee.temphousinglocation%type;
v_result			EPIC.epic_col_types.number_9%type;
v_result_msg 		EPIC.epic_col_types.varchar_2000%type;
v_custodystatus		EPIC.eh_entity_status.code_custody_status%type;
v_entitystatus		EPIC.eh_entity_status.code_entity_status%type;
v_bookingstate		EPIC.epic_col_types.char_1%type;
v_DOB               MACOMB.mt_pb_arrestee.dob%type;
v_JuvFlag           EPIC.epic_col_types.char_1%type;
v_goodtime			varchar2(16);
v_booking_num		varchar2(64);
v_booking_num_id	varchar2(16);
v_InsUpd			EPIC.epic_col_types.char_1%type;
 	 
BEGIN  
    p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
	p_errormsg := null;      
	BEGIN
		SELECT autoid_id 
		INTO v_booking_num_id
		FROM EPIC.eh_autoid
		where autoid_name = 'Booking Numbers'; -- or  in autoid_id  is 'BOOKING_ID'
	END;
		
	BEGIN
		v_booking_num := EPIC.ef_generate_autoid(v_booking_num_id, null, 'ERROR');
		IF v_booking_num = 'ERROR' THEN
			dbms_output.put_line('you failed ' ||v_booking_num);
			p_errornum := 123; 
	   		p_errormsg := 'Booking number failed to generate';  
	   		RETURN;
		END IF;
	END;
		
		--get the location id  
	BEGIN
	 	SELECT	temphousinglocation
 	 	INTO	v_location_id
 	 	FROM	MACOMB.mt_pb_arrestee
 		WHERE	arrest_id = p_arrest_id; 
 	END;	
 		--get the facility_id
 	BEGIN
 		SELECT	location_id
        INTO	v_facility_id
		FROM	EPIC.epic_locations
		WHERE 	location_name = 'MCJ';
	END;	
		--get the booking state code
	BEGIN
 		SELECT	lookup_code
 		INTO	v_bookingstate
 		FROM	EPIC.epic_lookups
 		WHERE	lookup_class = 'BOOKING STATE'
 				and EPIC.ef_epic_date_to_date(effective_end_date) > sysdate
 				and text_full like 'Accepted';
 	END;	
 		--get the code custody status
 	BEGIN
 		SELECT	lookup_code
 		INTO	v_custodystatus
 		FROM	EPIC.epic_lookups
 		WHERE	lookup_class = 'ADMIN STATUS'
 				and EPIC.ef_epic_date_to_date(effective_end_date) > sysdate
 				and text_full like 'REGULAR INMATE'; 
 	END;
 		--get the code entity status
 	BEGIN
 		SELECT	lookup_code
 		INTO	v_entitystatus
 		FROM	EPIC.epic_lookups
 		WHERE	lookup_class = 'OFFENDER STATUS'
 				and EPIC.ef_epic_date_to_date(effective_end_date) > sysdate
 				and text_full like 'NO STATUS'; 
 	END; 				
 		--get the most current good time rate type id
 	BEGIN
 		SELECT	g.goodtimeratetypeid
 		INTO	v_goodtime
 		FROM	EPIC.eh_good_time_rate g,
 				EPIC.eh_good_time_rate_type gt,
 				EPIC.epic_locations e
	 	WHERE 	g.goodtimeratetypeid = gt.goodtimeratetypeid
	 			and e.location_id = gt.facility_id
	 			and e.location_name = 'MCJ';
 	END;	 		
 		--get the juvenile flag: based on DOB (17 or younger is juvenile)
 	BEGIN
 		SELECT	DOB
 		INTO    v_DOB
 		FROM	MACOMB.mt_pb_arrestee
 		WHERE	arrest_id = p_arrest_id;
 		
 		IF MACOMB.mcmb_fnt_epic_DateDiff_Years(v_DOB, sysdate) <= 17 
 		THEN
 			v_JuvFlag := 'Y';
 		ELSE
 			v_JuvFlag := 'N'; 
 		END IF;
 	END;
 	
 	BEGIN

 		EPIC.ehi_eh_active_booking(p_booking_id, p_matched_id, p_action_by, 0, 'I', v_result, v_result_msg);
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF; 
 		
 		EPIC.ehi_eh_good_time_rate_assign(EPIC.epic_ids.new_epic_id(), v_goodtime, EPIC.epicdate(sysdate), p_matched_id, p_action_by, p_booking_id, 'I', v_result, v_result_msg);
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF;          
 		
 		EPIC.ehi_eh_muster(p_matched_id, v_facility_id, 'Y'/*in muster flag*/, EPIC.epicdate(sysdate), p_action_by, 'BOOKING', 'I', v_result, v_result_msg);
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF; 
 		
 		IF v_location_id is not null THEN
 			EPIC.ehi_eh_housing_assignments(p_matched_id, v_location_id, 'N'/*temp housing flag*/, 'Y'/*muster flag*/, p_action_by, null, 'I', v_result, v_result_msg);
	 		IF v_result <> 0 THEN
	 			BEGIN
	       			p_errornum := v_result; 
	       			p_errormsg := v_result_msg;  
	       			RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       		END;
	   	 	END IF;
	   	 END IF; 	
 		
 		EPIC.ehi_eh_booking(p_booking_id, p_matched_id, v_booking_num, EPIC.epicdate(sysdate)/*startdate*/, EPIC.epicdate(sysdate)/*acceptdate*/, null /*end date*/, v_bookingstate, p_action_by, 'N'/*manual override*/, null/*sentence start date*/, null/*sentence end date*/, null/*earliest release date*/,null/*final release date*/, v_facility_id, 'N'/*hour sentence flag*/, v_JuvFlag, 'I', v_result, v_result_msg); 
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF;         
 		
 		EPIC.ehi_eh_current_location(v_location_id, p_matched_id, EPIC.epicdate(sysdate)/*move_date_time*/, p_action_by, 'I', v_result, v_result_msg); 
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF; 
 		
 		--entity status records are updated: thus, need to check if a record already exists for this inmate
  		IF v_custodystatus is not null THEN
	 		BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_status
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;                      
	 		EPIC.ehi_eh_entity_status(p_matched_id, v_entitystatus, p_action_by, v_custodystatus, NVL(v_InsUpd, 'I'), v_result, v_result_msg);
		 	IF v_result <> 0 THEN
		 		BEGIN
		       		p_errornum := v_result;                          
		       		p_errormsg := v_result_msg;  
		       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
		       	END;
		    END IF; 
		END IF;
		
 		EPIC.ehi_eh_booking_custody_status(EPIC.epic_ids.new_epic_id(), p_booking_id, v_custodystatus, EPIC.epicdate(sysdate)/*date_start*/, null/*date_end*/, p_action_by, 'I', v_result, v_result_msg);
	 	IF v_result <> 0 THEN
	 		BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       	END;
	    END IF; 
	END;
END;
/

CREATE OR REPLACE
PROCEDURE mp_PB_charge_processing
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE,
	 	p_booking_id		IN	EPIC.eh_booking.booking_id%TYPE,
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 

IS	 
/*	
	Purpose:		Insert OT Property (using EPIC.EHI_EH_CASE(),         ) 
	                --EHI_EH_CASE  	Reqd Fields: 			case_id, booking id, action_by, p_iu, p_result, p_result_msg
	                				Fields in Question:		case number ??? -- One per charge. I asked Ken about using an auto number for this.   
	                --EHI_EH_CASE_CHARGE 
	                				Reqd Fields: 			case_id, charge_id, action_by, p_iu, p_result, p_result_msg
	                				Fields in Question:
	                --EHI_EH_CHARGE (REQD... action_by,booking_id,charge_id,charge_state,index_number(SEQ#?),statute_id )
                                    Reqd Fields:  			action_by, booking_id, charge_id, charge_state, index_number, statute_id
                                                            p_iu, p_result, p_result_msg
                                    
                                    Assumptions:			Index_Cnt used to track # of charges records
	                                              			Charge State - using 0 ?
	                                						PACC - should be statute id for OT
	                                
	                                Fields in Question      PACC ???  Need to return statute id from MACOMB.MV_STATUTE  (MARCO)
	                                						** mf_statute_id(chrgcur.pacc) created function, 
	                                						   need to Remove this function if this is going to be handled by MARCO**  Marco is handling this code.
	                                                        Class ??  MACOMB.MV_STATUTE code_stature_class (MARCO)  Class is handled in lookups and marco is using.
	                                                        Arrestreason ? MACOMB.MV_BOOKING_LOOKUPS ARREST REASON (SUB_1) (MARCO) Arrestreason is handled in lookup and marco is using.
	                                	                                              
	                                Other ?   			    Not updating all columns in MACOMB.MT_PB_ARREST_CHARGE to OT
															Charge,     -- This can be ignored
															IncidentNumber,  This needs to be saved
															CrimeYear,  -- This can be ignored
															Count,      -- This can be ignored
															CourtName,       This needs to be saved
															ComplaintAgency, This needs to be saved 
															ArrestAgency,    This needs to be saved
															CNT, -- this is a free form text (other attribute)
															TCN  -- this is a free form text (other attribute)
															
					--EHI_EH_BAIL_CONDITION 
									 Reqd Fields:   		bail_condition_id,bail_condition_number,booking_id,action_by, p_iu, p_result, p_result_msg
									 
									 Assumptions:			bail_condition_number = 0 ?  (not sure about assignment epic_statutes statute_number + eh_charge index # )
									 Fields in Question
 
 					--EHI_EH_BAIL_CONDITION_CHARGE
									 Reqd Fields:    		bail_condition_id, charge_id,action_by, p_iu, p_result, p_result_msg		
									 Assumptions 
									 Fields in Question  
									   
					--EHI_EH_CHARGE_AGENCY					
									 Reqd Fields: 			charge_id, agency_id, p_iu, p_result, p_result_msg
									 						agency_id ??? COMPLAINT DEPARTMENT in epic_lookups?, Entity_id in eh_entity_organization
									   			
									 Assumptions 		    Aggency_id = 0
									 Fields in Question   
								              
									 
					--EHI_EH_CHARGE_CHANGE -- Not needed for our system
									 
									 
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        06/05/06		Created
					R. Stuve	 07/07/06		Replaced '' with null, added auto-generated charge_id_num/bail num, case number, De-bugged, tested
					J. MCBRATNIE 07/14/06 		Update eh_charge call with corrected defaults updated bail_condition and case number.
					R. Stuve	 09/27/06		Added incidentnumber (eh_charge.arrest_number); added charge booked date/time
					R. Stuve	 10/09/06		Inserted ehi routine for courtname
					R. Stuve	10/12/06		Inserted eh_charge_primary to flag a primary charge
					R. Stuve	12/05/06		Inserted ehi_case_court routine to populate court name on case tab
	
	
	
*/   
CURSOR chrgout IS
  	SELECT  *
	FROM 	MACOMB.mt_pb_arrest_charge ac
	WHERE   ac.arrest_id = p_arrest_id
	ORDER BY ac.arrest_id;

  v_case_id     			varchar2(16);  
  v_bail_condition_id     	varchar2(16); 		
  v_index_Cnt   			number;   -- used to store index count for number of charges
  v_result      			EPIC.epic_col_types.number_9%type;
  v_result_msg				EPIC.epic_col_types.varchar_255%type; 
  v_charge_id_num			varchar2(64);
  v_charge_num				varchar2(16);
  v_bailcondition           varchar2(16);
  v_bail_num				varchar2(64);
  v_TCN						varchar2(16);
  v_CTN						varchar2(16);
  v_ChargeBooked			varchar2(20);


BEGIN  
  v_case_id				:= EPIC.epic_ids.new_epic_id(); 
  v_bail_condition_id 	:= EPIC.epic_ids.new_epic_id();          
  v_index_Cnt  			:= 1;  
  p_errornum			:= 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
  p_errormsg 			:= null;
  
  --auto generate the charge id number (to be used in ehi_eh_charge)
  	BEGIN
		SELECT autoid_id 
		INTO v_charge_num
		FROM EPIC.eh_autoid
		where autoid_name = 'Charge ID'; 
	END;
		
	BEGIN
		v_charge_id_num := EPIC.ef_generate_autoid(v_charge_num, null, 'ERROR');
		IF v_charge_id_num = 'ERROR' THEN
			dbms_output.put_line('you failed ' ||v_charge_id_num);
			p_errornum := 123; 
	   		p_errormsg := 'Charge ID failed to generate';  
	   		RETURN;
		END IF;
	END;   
	
	--auto generate the bail condition number (to be used in ehi_eh_bail_condition)
  	BEGIN
		SELECT autoid_id 
		INTO v_bail_num
		FROM EPIC.eh_autoid
		where autoid_name = 'Bail Condition Numbers'; 
	END;
		
	BEGIN
		SELECT 	tcn, ctn	
		INTO 	v_TCN, v_CTN
		FROM	MACOMB.mt_pb_arrest_charge
		WHERE	arrest_id = p_arrest_id;
	END;
		  
	--retreive the charge offense date (charges tab > Date Booked)
	BEGIN
		SELECT	EPIC.epicdate(arrive_time)
		INTO	v_ChargeBooked
		FROM	MACOMB.mt_pb_arrestee
		WHERE	arrest_id = p_arrest_id;
	END;
	
	BEGIN
		v_bailcondition := EPIC.ef_generate_autoid(v_bail_num, null, 'ERROR');
		IF v_bailcondition = 'ERROR' THEN
			dbms_output.put_line('you failed ' ||v_bailcondition);
			p_errornum := 123; 
	   		p_errormsg := 'Bail Condition number failed to generate';  
	   		RETURN;
		END IF;
	END;
	
	FOR chrgcur IN chrgout
	LOOP 
		  --NOTE: case number initially set to PACC code (stored as an EPIC id in Macomb tables). Will be changed later by jail office  
	    EPIC.ehi_eh_case(v_case_id,p_booking_id,chrgcur.pacc/*case number*/,p_action_by,'I',v_result,v_result_msg);
	    IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF;
      	
      	--insert the court name on the court tab
      	 EPIC.ehi_eh_court_appearance(EPIC.epic_ids.new_epic_id(), v_case_id, chrgcur.courtname, null, null, null, p_action_by, null, 'I', v_result, v_result_msg);
      	 IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF;      	
      	
      	--insert the court name on the case tab
      	EPIC.ehi_eh_case_court(v_case_id, chrgcur.courtname, p_action_by, 'I', v_result, v_result_msg);
      	IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
      	
	  	EPIC.ehi_eh_case_charge(v_case_id,chrgcur.charge_id,p_action_by,'I',v_result,v_result_msg); 
   		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 	    

        EPIC.ehi_eh_charge(NVL(chrgcur.charge_id, EPIC.epic_ids.new_epic_id()), p_booking_id, chrgcur.statute_id, '0', chrgcur.arrestreason, chrgcur.incidentnumber/*arrest_number*/, v_index_Cnt, v_charge_id_num, chrgcur.class, 'N'/*is_held*/, NULL/*held_date*/, 'N'/*bill_agency*/, v_ChargeBooked/*offense_date*/, null/*disposition_reason*/, null/*agency_id*/,null/*sentence_id*/, null/*ncic_offense_id*/, null/*ucr_offense_id*/, p_action_by, null/*modifier*/, null/*associated_arrest_id*/, 'I', v_result, v_result_msg); 
		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
      	
      	--flag the inserted charge as the primary charge
      	EPIC.ehi_eh_charge_primary(p_booking_id, chrgcur.charge_id, p_action_by, 'I', v_result, v_result_msg);
      	IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
      	
      	IF v_CTN is not null THEN
      		EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(), chrgcur.charge_id, 'CTN', v_CTN, p_action_by, 'I', v_result, v_result_msg);
      		IF v_result <> 0 THEN
 				BEGIN
        			p_errornum := v_result; 
        			p_errormsg := v_result_msg;  
        			RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        		END;
      		END IF;
      	END IF;
      	
      	IF v_TCN is not null THEN
      		EPIC.ehi_eh_generic_attribute(EPIC.epic_ids.new_epic_id(), chrgcur.charge_id, 'TCN', v_TCN, p_action_by, 'I', v_result, v_result_msg);
      		IF v_result <> 0 THEN
 				BEGIN
        			p_errornum := v_result; 
        			p_errormsg := v_result_msg;  
        			RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        		END;
      		END IF;
      	END IF;
                                                                      
	    EPIC.ehi_eh_bail_condition(v_bail_condition_id, p_booking_id, v_bailcondition, 'N'/*is_bailable*/, null/*cash_only_bail_amount*/, 0/*bail_amount*/, null/*surcharge_amount*/, null/*require_both*/, null/*own_recognizance*/, 'N'/*is_satisfied*/, 'N'/*charges_disposed*/, p_action_by, 'I', v_result, v_result_msg);
		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 
      		    
		EPIC.ehi_eh_bail_condition_charge(v_bail_condition_id, chrgcur.charge_id, p_action_by, 'I', v_result, v_result_msg);
 		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF; 	                     
	
		EPIC.ehi_eh_charge_agency(chrgcur.charge_id, chrgcur.complaintagency, p_action_by, 'I', v_result, v_result_msg);
	 	IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
        	END;
      	END IF;  
	 	         
		 v_index_Cnt := v_index_Cnt + 1; 
	END LOOP;	
END;   

		 
/

CREATE OR REPLACE
PROCEDURE        mp_pb_Clear
	(p_arrest_id 	IN 		EPIC.eh_entity.entity_id%TYPE)
	
/*	
	Purpose:		Macomb Pre Booking - Deletes records from the MACOMB pre-booking tables after the inmate's records have been
					inserted into the EPIC tables.

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					R. Stuve	 	06/05/06		Created 
*/  
IS

BEGIN

DELETE FROM MACOMB.mt_pb_arrestee
WHERE arrest_id = p_arrest_id;

DELETE FROM MACOMB.mt_pb_arrest_charge
WHERE arrest_id = p_arrest_id;

DELETE FROM MACOMB.mt_pb_arrest_detail
WHERE arrest_id = p_arrest_id;

DELETE FROM MACOMB.mt_pb_arrest_officer
WHERE arrest_id = p_arrest_id; 

DELETE FROM MACOMB.mt_pb_arrest_property
WHERE arrest_id = p_arrest_id;  

DELETE FROM MACOMB.mt_pb_keep_separate
WHERE origin_entity_id = p_arrest_id; 

DELETE FROM MACOMB.mt_pb_language
WHERE arrest_id = p_arrest_id;

DELETE FROM MACOMB.mt_pb_officers
WHERE arrest_id = p_arrest_id;  

DELETE FROM MACOMB.mt_pb_person_alias
WHERE arrest_id = p_arrest_id; 

END; 
/

CREATE OR REPLACE
PROCEDURE        mp_pb_EpicID
	(p_epic_id		OUT		varchar2)
	
/*	
	Purpose:		Macomb Pre Booking - Returns a new Epic ID

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					R. Stuve	 	06/23/06		Created 
*/  
IS

BEGIN

p_epic_id	:= EPIC.epic_ids.new_epic_id();

END; 
/

CREATE OR REPLACE
PROCEDURE        MP_PB_HOUSING_lookup
		(	cur			      OUT epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Purpose:		pull back a list of values for lookup in pre-booking

	Author:			Joe McBratnie

	Change Log:		Changed By	    Date Modified	Change Made
					----------  	-------------	------------------------------------------
					J. McBratnie	3/134/2006		Created
*/
    
BEGIN
        
	OPEN cur FOR
         SELECT	HOUSING_ID, CELL_NAME, GENDER
 		 FROM	MACOMB.MT_PB_TEMP_HOUSING
 		 ORDER BY cell_name;
	
END;
/

CREATE OR REPLACE
PROCEDURE  mp_PB_inmate_processing
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE,
	 	--p_identity_id  		IN	EPIC.eh_booking.booking_id%TYPE,    RAS: 11/03/06
	 	p_matched_id        IN  MACOMB.mt_pb_arrestee.matchedoffender_id%TYPE,
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - Wrapper program to save that
					Data needed for the follow the process
					NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					J. MCBRATNIE  05/06/06		Created 
					R. Stuve	  06/08/06		Added IF statements based on v_result_msg 
					R. Stuve	  07/02/06		Added ehi routines for RS/CL phone, education level, citizenship
					R. Stuve	  07/03/06		Added employer information, emergency contact	
					R. Stuve	  07/05/06		Added alias names, maiden name, work skills 
					R. Stuve	  07/06/06		Completed testing on entire procedure and de-bugged ehi insert routines
					J. MCBRATNIE  07/13/06      Added parameter for matched offender. 
					R. Stuve	  07/27/06		Commented query to populate v_arrest...info: not needed because it's inserted in the arrest procedure	 
					R. Stuve	  08/09/06		Added v_InsUpd to signal an update or an insert for each procedure
					R. Stuve	  08/22/06 		Changed height calculation to account for 3-digit number as input and convert to 2-digit number to store to epic tables
					R. Stuve	  10/05/06		Updated routine for Birth Place City to run off primary_identity_id	      
					R. Stuve	  10/12/06		Added routine to create new Inmate ID 
					R. Stuve	  11/02/06		Added language insert routine 
					R. Stuve      11/03/06		Removed p_identity_id: not used within this routine; commented insert/update check on snapshot table (more comments below)
					R. Stuve	  11/08/06     	Edited Emergency Contact insert routine; added v_birthcity_attrib   
					R. Stuve	  11/27/06		Changed primary # flag to 'N' for cellular telephone number 
					R. Stuve	  11/28/06		Added UPPER function to Emergency Contact name; added ehi_eh_entity insert routine for Emergency Contact; edited ehi_entity_relationship inputs for EC
					R. Stuve	 11/29/06		Changed some epic_id functions in relations to employer (commented within code)   

*/  	 

v_ARRIVE_TIME			MACOMB.MT_PB_ARRESTEE.ARRIVE_TIME%type;
v_LASTNAME				MACOMB.MT_PB_ARRESTEE.LASTNAME%type;
v_MIDDLENAME			MACOMB.MT_PB_ARRESTEE.MIDDLENAME%type;
v_FIRSTNAME				MACOMB.MT_PB_ARRESTEE.FIRSTNAME%type;
v_OFFENDER_ID			MACOMB.MT_PB_ARRESTEE.OFFENDER_ID%type;
v_STATE_ID				MACOMB.MT_PB_ARRESTEE.STATE_ID%type;
v_FBI_ID				MACOMB.MT_PB_ARRESTEE.FBI_ID%type;
v_SSN					MACOMB.MT_PB_ARRESTEE.SSN%type;
v_TEMPHOUSINGLOCATION	MACOMB.MT_PB_ARRESTEE.TEMPHOUSINGLOCATION%type;
v_NAME_TITLE			MACOMB.MT_PB_ARRESTEE.NAME_TITLE%type;
v_NAME_SUFFIX			MACOMB.MT_PB_ARRESTEE.NAME_SUFFIX%type;
v_GENDER				MACOMB.MT_PB_ARRESTEE.GENDER%type;
v_BIRTHCOUNTRY			MACOMB.MT_PB_ARRESTEE.BIRTHCOUNTRY%type;
v_BIRTHCITY				MACOMB.MT_PB_ARRESTEE.BIRTHCITY%type;
v_BIRTHSTATE            MACOMB.MT_PB_ARRESTEE.BIRTHSTATE%type;
v_DOB                   MACOMB.MT_PB_ARRESTEE.DOB%type;
v_DL_NUMBER				MACOMB.MT_PB_ARRESTEE.DLNUMBER%type;
v_DL                    MACOMB.MT_PB_ARRESTEE.DL_ID%type;
v_DL_STATE              MACOMB.MT_PB_ARRESTEE.DLSTATE%type;
v_DL_EXPIRE				MACOMB.MT_PB_ARRESTEE.DLEXPIRE%type;

v_RS_ADDRESS_ID         	MACOMB.MT_PB_ARRESTEE.RS_ADDRESS_ID%type;
v_RS_DWELLING_NAME  	    MACOMB.MT_PB_ARRESTEE.RS_DWELLING_NAME%type;
v_RS_FLAT_NO_OR_FLOOR_LEVEL	MACOMB.MT_PB_ARRESTEE.RS_FLAT_NO_OR_FLOOR_LEVEL%type;
v_RS_STREET_NUMBER          MACOMB.MT_PB_ARRESTEE.RS_STREET_NUMBER%type;
v_RS_STREET_NAME            MACOMB.MT_PB_ARRESTEE.RS_STREET_NAME%type;
v_RS_CITY_TOWN_LOCALE		MACOMB.MT_PB_ARRESTEE.RS_CITY_TOWN_LOCALE%type;
v_RS_STATE_PROVINCE_REGION  MACOMB.MT_PB_ARRESTEE.RS_STATE_PROVINCE_REGION%type;
v_RS_POSTAL_CODE            MACOMB.MT_PB_ARRESTEE.RS_POSTAL_CODE%type;
v_RS_CODE_COUNTRY			MACOMB.MT_PB_ARRESTEE.RS_CODE_COUNTRY%type;
 
v_RS_PHONE_ID				MACOMB.MT_PB_ARRESTEE.RS_PHONE_ID%type;
v_RS_PHONE_COUNTRY_CODE     MACOMB.MT_PB_ARRESTEE.RS_PHONE_COUNTRY_CODE%type;
v_RS_PHONE_AREA_CODE        MACOMB.MT_PB_ARRESTEE.RS_PHONE_AREA_CODE%type;
v_RS_PHONE_NUMBER           MACOMB.MT_PB_ARRESTEE.RS_PHONE_NUMBER%type;
v_RS_PHONE_EXTENSION        MACOMB.MT_PB_ARRESTEE.RS_PHONE_EXTENSION%type;
v_RS_PHONE_TYPE             MACOMB.MT_PB_ARRESTEE.RS_PHONE_TYPE%type;

v_CL_PHONE_ID				MACOMB.MT_PB_ARRESTEE.CL_PHONE_ID%type;
v_CL_PHONE_COUNTRY_CODE     MACOMB.MT_PB_ARRESTEE.CL_PHONE_COUNTRY_CODE%type;
v_CL_PHONE_AREA_CODE        MACOMB.MT_PB_ARRESTEE.CL_PHONE_AREA_CODE%type;
v_CL_PHONE_NUMBER           MACOMB.MT_PB_ARRESTEE.CL_PHONE_NUMBER%type;
v_CL_PHONE_EXTENSION        MACOMB.MT_PB_ARRESTEE.CL_PHONE_EXTENSION%type;
v_CL_PHONE_TYPE             MACOMB.MT_PB_ARRESTEE.CL_PHONE_TYPE%type;

v_EM_PHONE_ID				MACOMB.MT_PB_ARRESTEE.EM_PHONE_ID%type;
v_EM_PHONE_COUNTRY_CODE     MACOMB.MT_PB_ARRESTEE.EM_PHONE_COUNTRY_CODE%type;
v_EM_PHONE_AREA_CODE        MACOMB.MT_PB_ARRESTEE.EM_PHONE_AREA_CODE%type;
v_EM_PHONE_NUMBER           MACOMB.MT_PB_ARRESTEE.EM_PHONE_NUMBER%type;
v_EM_PHONE_EXTENSION        MACOMB.MT_PB_ARRESTEE.EM_PHONE_EXTENSION%type;
v_EM_PHONE_TYPE             MACOMB.MT_PB_ARRESTEE.EM_PHONE_TYPE%type;
v_EM_ID						MACOMB.MT_PB_ARRESTEE.EMPLOYEMENT_ID%type;
v_EM_NAME                   MACOMB.MT_PB_ARRESTEE.EMPLOYERNAME%type;
v_EM_ADD_ID                 MACOMB.MT_PB_ARRESTEE.EM_ADDRESS_ID%type;
v_EM_DWELL                 	MACOMB.MT_PB_ARRESTEE.EM_DWELLING_NAME%type;
v_EM_FLAT                  	MACOMB.MT_PB_ARRESTEE.EM_FLAT_NO_OR_FLOOR_LEVEL%type;
v_EM_STNUM                  MACOMB.MT_PB_ARRESTEE.EM_STREET_NUMBER%type;
v_EM_STRNAME                MACOMB.MT_PB_ARRESTEE.EM_STREET_NAME%type;
v_EM_CITY                  	MACOMB.MT_PB_ARRESTEE.EM_CITY_TOWN_LOCALE%type;
v_EM_STATE                  MACOMB.MT_PB_ARRESTEE.EM_STATE_PROVINCE_REGION%type;
v_EM_POSTAL                 MACOMB.MT_PB_ARRESTEE.EM_POSTAL_CODE%type;
v_EM_COUNTRY				MACOMB.MT_PB_ARRESTEE.EM_CODE_COUNTRY%type;
v_ORG_ID					EPIC.EH_ENTITY_ORGANIZATION.ENTITY_ID%type; 
v_EMPROLE					EPIC.EH_ENTITY_ROLES.CODE_ENTITY_ROLE%type;

v_EC_PERSON_ID           	MACOMB.MT_PB_ARRESTEE.EC_PERSON_ID%type;
v_EC_EMERGENCYCONTACTLAST   MACOMB.MT_PB_ARRESTEE.EMERGENCYCONTACT%type;
v_EC_EMERGENCYCONTACTFIRST  MACOMB.MT_PB_ARRESTEE.EMERGENCYCONTACT%type;
v_EC_PHONE_ID				MACOMB.MT_PB_ARRESTEE.EC_PHONE_ID%type;
v_EC_PHONE_COUNTRY_CODE     MACOMB.MT_PB_ARRESTEE.EC_PHONE_COUNTRY_CODE%type;
v_EC_PHONE_AREA_CODE        MACOMB.MT_PB_ARRESTEE.EC_PHONE_AREA_CODE%type;
v_EC_PHONE_NUMBER           MACOMB.MT_PB_ARRESTEE.EC_PHONE_NUMBER%type;
v_EC_PHONE_EXTENSION        MACOMB.MT_PB_ARRESTEE.EC_PHONE_EXTENSION%type;
v_EC_PHONE_TYPE             MACOMB.MT_PB_ARRESTEE.EC_PHONE_TYPE%type; 
v_EC_EMERGENCYRELATIONSHIP  MACOMB.MT_PB_ARRESTEE.EMERGENCYRELATIONSHIP%type; 
v_EC_PRIMID					EPIC.EH_ENTITY_PERSON.PRIMARY_IDENTITY_ID%type; 

v_RELIGIOUSPREF 			MACOMB.MT_PB_ARRESTEE.RELIGIOUSPREF%type;
v_MARITALSTATUS             MACOMB.MT_PB_ARRESTEE.MARITALSTATUS%type;  
v_ENGLISHREAD               MACOMB.MT_PB_ARRESTEE.ENGLISHREAD%type;
v_ENGLISHWRITTEN            MACOMB.MT_PB_ARRESTEE.ENGLISHWRITTEN%type;  
v_HEIGHT					MACOMB.MT_PB_ARRESTEE.HEIGHT%type;
v_EYERIGHT                  MACOMB.MT_PB_ARRESTEE.EYERIGHT%type;
v_EYELEFT					MACOMB.MT_PB_ARRESTEE.EYELEFT%type;
v_RACE						MACOMB.MT_PB_ARRESTEE.RACE%type;
v_WEIGHT                    MACOMB.MT_PB_ARRESTEE.WEIGHT%type;
--v_ETHNICITY					MACOMB.MT_PB_ARRESTEE.ETHNICITY%type;
v_HAIR						MACOMB.MT_PB_ARRESTEE.HAIR%type;
v_COMPLEXION				MACOMB.MT_PB_ARRESTEE.COMPLEXION%type;
--v_BUILD					MACOMB.MT_PB_ARRESTEE.BUILD%type;
v_HOMELESS					MACOMB.MT_PB_ARRESTEE.HOMELESS%type;
v_CITIZEN					EPIC.EH_CITIZENSHIP.COUNTRY_CODE%type;
v_OCCUPATION				MACOMB.MT_PB_ARRESTEE.OCCUPATION%type;
v_EDUCATIONLEVEL			MACOMB.MT_PB_ARRESTEE.EDUCATIONLEVEL%type;
v_ALIASID                   MACOMB.MT_PB_PERSON_ALIAS.ALIAS_ID%type;
v_ALIASFIRST                MACOMB.MT_PB_PERSON_ALIAS.FIRSTNAME%type;
v_ALIASLAST                 MACOMB.MT_PB_PERSON_ALIAS.LASTNAME%type;
v_MAIDEN					MACOMB.MT_PB_ARRESTEE.MAIDENNAME%type;

v_IDENTITY_ID				varchar2(16);
v_LOCATION_ID				varchar2(16); -- added to table
v_EMPLOYMENTSTATUS			varchar2(20);
v_ADDRESSCODE				varchar2(20);
v_EM_ADDRESSCODE			varchar2(20);
v_JUV						CHAR(1);  
v_WORKSKILL					varchar2(64);
v_WorkSkillID				EPIC.eh_entity_work_skills.work_skills_id%type;
v_LANGID                   	MACOMB.MT_PB_LANGUAGE.LANGUAGE_ID%type;
v_LANGTYPE                  MACOMB.MT_PB_LANGUAGE.LANGUAGETYPE%type;  				

v_result					EPIC.epic_col_types.number_9%type;
v_result_msg 				EPIC.epic_col_types.varchar_255%type; 
v_InsUpd					EPIC.epic_col_types.char_1%type; 
v_birthcity_attrib			EPIC.eh_generic_attribute.attribute_id%type;

--cursor to select all of the inmate's alias names
CURSOR cur_Alias IS
	SELECT alias_id, firstname, lastname
    FROM MACOMB.mt_pb_person_alias
    WHERE arrest_id = p_arrest_id;

--cursor to select the organization id if it exists    
CURSOR cur_Org IS	
	SELECT o.entity_id
	FROM EPIC.eh_entity_organization o,
		 EPIC.eh_address a
	WHERE o.entity_id = a.entity_id
		  and a.street_number = v_EM_STNUM
		  and UPPER(a.street_name) = UPPER(v_EM_STRNAME)
		  and UPPER(a.city_town_locale) = UPPER(v_EM_CITY)
		  and UPPER(o.organization_name) = UPPER(v_EM_NAME);
		  
--cursor to select an existing identity_id
CURSOR cur_PriIdent IS
	SELECT primary_identity_id 
	FROM EPIC.eh_entity_person
	WHERE entity_id = p_matched_id;
	
    
BEGIN

p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
p_errormsg := null; 


 	-- get mt_pb_arrestee basic demographic information
	BEGIN
	    SELECT ARRIVE_TIME,LASTNAME,MIDDLENAME,FIRSTNAME,NAME_SUFFIX,NAME_TITLE,OFFENDER_ID,STATE_ID,FBI_ID,SSN,TEMPHOUSINGLOCATION,DOB,NVL(GENDER, 'U'),BIRTHCITY,BIRTHSTATE,NVL(BIRTHCOUNTRY, '_NOSP'),NVL(HOMELESS,'N'),OCCUPATION, decode(USCITIZEN,'Y','US','YY'), religiouspref, maritalstatus, dl_id, dlnumber, dlstate, dlexpire, (substr(height,1,1)*12 + substr(height,2,2)), weight, eyeright, eyeleft, race, hair, complexion /*, build */
	    INTO v_ARRIVE_TIME, v_LASTNAME, v_MIDDLENAME, v_FIRSTNAME, v_NAME_SUFFIX, v_NAME_TITLE, v_OFFENDER_ID, v_STATE_ID, v_FBI_ID, v_SSN, v_TEMPHOUSINGLOCATION, v_DOB, v_GENDER, v_BIRTHCITY, v_BIRTHSTATE,v_BIRTHCOUNTRY, v_HOMELESS, v_OCCUPATION, v_CITIZEN, v_RELIGIOUSPREF, v_MARITALSTATUS, v_DL, v_DL_NUMBER, v_DL_STATE, v_DL_EXPIRE, v_HEIGHT, v_WEIGHT, v_EYERIGHT, v_EYELEFT, v_RACE, v_HAIR, v_COMPLEXION /*, v_BUILD */
	    FROM MACOMB.MT_PB_ARRESTEE
 		WHERE arrest_id = p_arrest_id;
 	END;  
 	
 	--select the language
 	BEGIN
 		SELECT	language_id, languagetype
  		INTO	v_LANGID, v_LANGTYPE
  		FROM    MACOMB.MT_PB_LANGUAGE
  		WHERE	arrest_id = p_arrest_id;
 	END;                                                                                                                                                                                                                                                                                                                                                                 
    
 	--select the employment status
	BEGIN
		SELECT lookup_code 
		INTO v_EMPLOYMENTSTATUS
		FROM EPIC.epic_lookups             
		WHERE lookup_class LIKE 'EMPLOYMENT STATUS'
		  AND Text_full = 'FULL TIME';  
	END;
   
   --select the address code for residential
	BEGIN
		SELECT lookup_code 
		INTO v_ADDRESSCODE
		FROM EPIC.epic_lookups             
		WHERE lookup_class = 'ADDRESS TYPE'
		  AND Text_full = 'RESIDENTIAL ADDRESS';  		  
	END; 
	
	--select the role code for employer
	BEGIN
		SELECT lookup_code 
		INTO v_EMPROLE
		FROM EPIC.epic_lookups             
		WHERE lookup_class = 'ORGANISATION ROLE'
		  AND Text_full = 'EMPLOYER';  		  
	END;
	
	--select the address code for employer
	BEGIN
		SELECT lookup_code 
		INTO v_EM_ADDRESSCODE
		FROM EPIC.epic_lookups          
		WHERE lookup_class = 'ADDRESS TYPE'
		  AND Text_full = 'POSTAL ADDRESS';  		  
	END;	
	
	--select the the Resident Phone/Adress information 
	BEGIN
		SELECT rs_phone_id, rs_phone_country_code, rs_phone_area_code, rs_phone_number, rs_phone_extension, rs_phone_type, rs_address_id, rs_dwelling_name, rs_flat_no_or_floor_level, rs_street_number, rs_street_name, rs_city_town_locale, rs_state_province_region, rs_postal_code, rs_code_country
		INTO v_RS_PHONE_ID, v_RS_PHONE_COUNTRY_CODE,v_RS_PHONE_AREA_CODE,v_RS_PHONE_NUMBER ,v_RS_PHONE_EXTENSION ,v_RS_PHONE_TYPE, v_RS_ADDRESS_ID, v_RS_DWELLING_NAME, v_RS_FLAT_NO_OR_FLOOR_LEVEL, v_RS_STREET_NUMBER, v_RS_STREET_NAME, v_RS_CITY_TOWN_LOCALE, v_RS_STATE_PROVINCE_REGION, v_RS_POSTAL_CODE, v_RS_CODE_COUNTRY  
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id; 
	END; 
	
	--select the Cellular/Mobile Phone information
	BEGIN
		SELECT cl_phone_id, cl_phone_country_code, cl_phone_area_code, cl_phone_number, cl_phone_extension, cl_phone_type
		INTO v_CL_PHONE_ID, v_CL_PHONE_COUNTRY_CODE,v_CL_PHONE_AREA_CODE,v_CL_PHONE_NUMBER ,v_CL_PHONE_EXTENSION ,v_CL_PHONE_TYPE  
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id; 
	END; 
	
	 --select the Emergency Contact information from the PB tables
	BEGIN
		SELECT ec_person_id, UPPER(substr(emergencycontact,1,instr(emergencycontact,',')-1)),UPPER(substr(emergencycontact,instr(emergencycontact,',')+2)), ec_phone_id, ec_phone_country_code, ec_phone_area_code, ec_phone_number, ec_phone_extension, ec_phone_type, emergencyrelationship
		INTO v_EC_PERSON_ID, v_EC_EMERGENCYCONTACTLAST, v_EC_EMERGENCYCONTACTFIRST, v_EC_PHONE_ID, v_EC_PHONE_COUNTRY_CODE, v_EC_PHONE_AREA_CODE, v_EC_PHONE_NUMBER, v_EC_PHONE_EXTENSION, v_EC_PHONE_TYPE, v_EC_EMERGENCYRELATIONSHIP 
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id; 
	END;
	
	--find or create a new Emergency Contact primary identification id
	BEGIN
		SELECT	primary_identity_id
		INTO 	v_EC_PRIMID
		FROM	EPIC.eh_entity_person
		WHERE 	entity_id = v_EC_PERSON_ID;
		EXCEPTION WHEN NO_DATA_FOUND THEN
			v_EC_PRIMID := EPIC.epic_ids.new_epic_id();
	END;
	
	--select the education level
	BEGIN
		SELECT educationlevel
		INTO v_EDUCATIONLEVEL
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id;
	END;
	
	--select the employer information (name, address, telephone)
	BEGIN	
		SELECT employement_id, UPPER(employername), em_address_id, em_dwelling_name, em_flat_no_or_floor_level, em_street_number, em_street_name, em_city_town_locale, em_state_province_region, em_postal_code, em_phone_id, em_code_country, em_phone_country_code, em_phone_area_code, em_phone_number, em_phone_extension, em_phone_type
		INTO v_EM_ID, v_EM_NAME, v_EM_ADD_ID, v_EM_DWELL, v_EM_FLAT, v_EM_STNUM, v_EM_STRNAME, v_EM_CITY, v_EM_STATE, v_EM_POSTAL, v_EM_PHONE_ID, v_EM_COUNTRY, v_EM_PHONE_COUNTRY_CODE, v_EM_PHONE_AREA_CODE, v_EM_PHONE_NUMBER, v_EM_PHONE_EXTENSION, v_EM_PHONE_TYPE 
		FROM MACOMB.mt_pb_arrestee
		WHERE arrest_id = p_arrest_id;  
	END;
	
	 --select the inmate's maiden name
	 BEGIN
	 	SELECT maidenname
	 	INTO v_MAIDEN
	 	FROM MACOMB.mt_pb_arrestee
	 	WHERE arrest_id = p_arrest_id;
	 	EXCEPTION WHEN NO_DATA_FOUND THEN
	 		v_MAIDEN := null;
	 END; 
	 
	 --select the inmate's language work skills
	 BEGIN
	 	SELECT decode((NVL(englishread, 'N') || NVL(englishwritten,'N')), 'YY', 'READ/WRITE', 'YN', 'READS ONLY', 'NY', 'WRITES ONLY', 'NN','CANNOT READ/WRITE')
	 	INTO v_WORKSKILL
	 	FROM MACOMB.mt_pb_arrestee
	 	WHERE arrest_id = p_arrest_id;
	 END;   
	 
	 --select the existing work skill id (if it exists)
	 BEGIN
	 	SELECT 	work_skills_id
		INTO    v_WorkSkillID
		FROM	EPIC.eh_entity_work_skills
		WHERE	entity_id = p_matched_id; 
		EXCEPTION WHEN NO_DATA_FOUND THEN
			v_WorkSkillID := EPIC.epic_ids.new_epic_id();
	END;
	 
	 --calculate if the inmate is a juvenile		
		IF MACOMB.mcmb_fnt_epic_DateDiff_Years(v_DOB, sysdate) <= 17 THEN
 			v_JUV := 'Y';
 		ELSE
 			v_JUV := 'N'; 
 		END IF;  
 		
 		--determine if offender has inmate id. if not, create one
	 	BEGIN
	 		IF v_OFFENDER_ID is null THEN
	 			v_OFFENDER_ID := EPIC.ef_generate_autoid('OFFENDER_ID', null, 'ERROR');
	 		END IF;
	 	END;
 		
 	-- main loop
 	BEGIN
	 	--determine if offender id already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
	 	BEGIN
	 		SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_offender_ids
	 		WHERE	entity_id = p_matched_id;
	 		EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;
	 	
	 	--insert the offender's main id        
 		EPIC.ehi_eh_offender_ids(p_matched_id, v_STATE_ID, v_FBI_ID, v_OFFENDER_ID, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg ); 
 		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; 
        	END;
      	END IF; 				
	     
	   --determine if offender already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
	 	BEGIN
	 		SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_entity
	 		WHERE	entity_id = p_matched_id; 
	 		EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;  
	     --insert the offender as a person into the system       
	   	EPIC.ehi_eh_entity(p_matched_id, 'PERSN', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
	   	IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; 
        	END;
      	END IF;
      	
      	--determine if offender role already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
	 	BEGIN
	 		SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_entity_roles
	 		WHERE	entity_id = p_matched_id
	 				and code_entity_role = 'OFNDR';
	 		EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;   
	   --insert the offender role into the system         
	   EPIC.ehi_eh_entity_roles(p_matched_id, 'OFNDR', EPIC.epicdatenow(), '2999123100:00:00+000', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
	   IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; 
        	END;
      	END IF; 
      	
      	--open the cursor to retrieve the primary identity id
      	BEGIN
      		OPEN cur_PriIdent;
      		FETCH cur_PriIdent INTO v_IDENTITY_ID;
      		      		
      	--if the identity_id is not found, create a new one
      		IF cur_PriIdent%NOTFOUND or v_IDENTITY_ID IS NULL
      			THEN v_IDENTITY_ID := EPIC.epic_ids.new_epic_id();
      		END IF;
      		CLOSE cur_PriIdent;
      	END;

      	--determine if offender demographics already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
	 	BEGIN
	 		SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_entity_person
	 		WHERE	entity_id = p_matched_id
	 				and primary_identity_id = v_IDENTITY_ID;
	 		EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END; 
	    --insert offender basic information and demographics (gender, eye color, handedness)
		EPIC.ehi_eh_entity_person(p_matched_id, v_IDENTITY_ID, v_GENDER, null, v_EYERIGHT, v_EYELEFT, 'UNKWN', 'N', null, '_NOSP', p_action_by, null, v_JUV, NVL(v_InsUpd,'I'), v_result, v_result_msg); 
		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg; 
        		RETURN;
        	END;
      	END IF;
      	
      	--determine if offender primary name already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
	 	BEGIN
	 		SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_person_identity
	 		WHERE	entity_id = p_matched_id
	 				and identity_id = v_IDENTITY_ID;
	 		EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;        
 		--insert the offender's primary name
		EPIC.ehi_eh_person_identity(p_matched_id, v_IDENTITY_ID, EPIC.epicdatenow(), null, 'N','MAS', v_LASTNAME, soundex(v_LASTNAME), v_FIRSTNAME, soundex(v_FIRSTNAME), v_MIDDLENAME, v_NAME_SUFFIX, v_NAME_TITLE, '_NOSP', EPIC.epicdate(v_DOB), null, null, v_HOMELESS, 'N' /*pars_auth*/, null, 'N' /*restricted_flag */, null, null, v_BIRTHCOUNTRY, v_BIRTHSTATE, v_BIRTHCITY, p_action_by, null, v_SSN, v_BIRTHSTATE, v_BIRTHCOUNTRY, 'N', null, NVL(v_InsUpd,'I'), v_result, v_result_msg );  --name and such CODE_NAME_TYPE = 'MAS'
 		IF v_result <> 0 THEN
 			BEGIN
        		p_errornum := v_result; 
        		p_errormsg := v_result_msg;  
        		RETURN; 
        	END;
      	END IF;
      	
      	IF v_BIRTHCITY is not null THEN
	      	--determine if offender birth city already exists: if so, set to 'U' (update). if not, set to 'I' (insert)
		 	BEGIN
		 		SELECT 	'U', attribute_id
		 		INTO    v_InsUpd, v_birthcity_attrib
		 		FROM	EPIC.eh_generic_attribute
		 		WHERE	item_id = v_IDENTITY_ID
		 				and attribute_name = 'BIRTH CITY';
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;  
		 			v_birthcity_attrib := EPIC.epic_ids.new_epic_id(); 
		 	END; 
		 	
	      	--insert birth city into eh_generic_attribute table also (even though it has already been inserted into eh_person_identity). MCSO uses the generic attribute under Demographics > Names > Other Attributes 
	      	EPIC.ehi_eh_generic_attribute(v_birthcity_attrib, v_IDENTITY_ID, 'BIRTH CITY', v_BIRTHCITY, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
	      	IF v_result <> 0 THEN
	 			BEGIN
	        		p_errornum := v_result; 
	        		p_errormsg := v_result_msg;  
	        		RETURN; 
	        	END;
	      	END IF;
		END IF;
   
      	--loop through the cursor and insert the offender's alias name(s)
		OPEN cur_Alias;
			LOOP
      			FETCH cur_Alias
      			INTO v_ALIASID, v_ALIASFIRST, v_ALIASLAST;
      			EXIT WHEN cur_Alias%NOTFOUND;  
      			
      			BEGIN
	 				SELECT 	'U'
	 				INTO    v_InsUpd
	 				FROM	EPIC.eh_person_identity
	 				WHERE	entity_id = p_matched_id
	 						and identity_id = v_ALIASID;
	 				EXCEPTION WHEN NO_DATA_FOUND THEN
	 					v_InsUpd := null;
	 			END; 
      			EPIC.ehi_eh_person_identity(p_matched_id, NVL(v_ALIASID, EPIC.epic_ids.new_epic_id()), EPIC.epicdatenow(), null, 'N','ALI', v_ALIASLAST, soundex(v_ALIASLAST), v_ALIASFIRST, soundex(v_ALIASFIRST), null, null, null, '_NOSP', EPIC.epicdate(v_DOB), null, null, v_HOMELESS, 'N', null, 'N', null, null, v_BIRTHCOUNTRY, v_BIRTHSTATE, v_BIRTHCITY, p_action_by, null, v_SSN, v_BIRTHSTATE, v_BIRTHCOUNTRY, 'N', null,NVL(v_InsUpd,'I'), v_result, v_result_msg );
 					IF v_result <> 0 THEN
 						BEGIN
	        				p_errornum := v_result; 
	        				p_errormsg := v_result_msg;  
	        				RETURN; 
        				END;
      				END IF;   
      	
      		END LOOP;
		CLOSE cur_Alias; 
		
	  --maiden name is uniquely generated through PB. Thus, no need to check if already exists. Previously entered maiden names (through OT) will be handled in alias section above.	
      --insert the inmate's maiden name (if it exists) 
      IF v_MAIDEN is not null THEN
	      EPIC.ehi_eh_person_identity(p_matched_id, EPIC.epic_ids.new_epic_id(), EPIC.epicdatenow(), null, 'N', 'ALI', v_MAIDEN, soundex(v_MAIDEN), v_FIRSTNAME, soundex(v_FIRSTNAME), v_MIDDLENAME, v_NAME_SUFFIX, v_NAME_TITLE, '_NOSP', EPIC.epicdate(v_DOB), null, null, v_HOMELESS, 'N', null, 'N', null, null, v_BIRTHCOUNTRY, v_BIRTHSTATE, v_BIRTHCITY, p_action_by, null, v_SSN, v_BIRTHSTATE, v_BIRTHCOUNTRY, 'N', null, 'I', v_result, v_result_msg );
	      IF v_result <> 0 THEN
	 					BEGIN
		        			p_errornum := v_result; 
		        			p_errormsg := v_result_msg;  
		        			RETURN; 
	        			END;
	      			END IF;
	  END IF;
      			   			
      	IF v_EC_PERSON_ID is not null THEN
	      	--determine if the emergency contact already exists
	      	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_person
		 		WHERE	entity_id = v_EC_PERSON_ID;
		 				--and primary_identity_id = v_EC_PRIMID;    --ras 11/8/06: not needed, entity_id is PK
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END; 		   	
	      	--insert emergency contact as a person into the system 
	 		EPIC.ehi_eh_entity(v_EC_PERSON_ID, 'PERSN', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);       --ras added 11/28
	 		IF v_result <> 0 THEN
	 			BEGIN
	        		p_errornum := v_result; 
	     	  		p_errormsg := v_result_msg; 
	       			RETURN; 
	  		   	END;
	      	END IF;
	      	
	     	EPIC.ehi_eh_entity_person(v_EC_PERSON_ID, v_EC_PRIMID, '_NOSP', '_NOSP', '_NOSP', '_NOSP', '_NOSP', 'N', null, '_NOSP', p_action_by, null, null, NVL(v_InsUpd,'I'), v_result, v_result_msg); 
			IF v_result <> 0 THEN
	 			BEGIN
	        		p_errornum := v_result; 
	     	  		p_errormsg := v_result_msg; 
	       			RETURN; 
	  		   	END;
	      	END IF;
	
	      	--determine if the emergency contact already exists (continued)
	      	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_person_identity
		 		WHERE	entity_id = v_EC_PERSON_ID
		 				and identity_id = v_EC_PRIMID;
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END; 
	      	--continue inserting emergency contact                                         
	      	EPIC.ehi_eh_person_identity(v_EC_PERSON_ID, v_EC_PRIMID, EPIC.epicdatenow(), '2999123100:00:00+000', 'N','MAS', v_EC_EMERGENCYCONTACTLAST, soundex(v_EC_EMERGENCYCONTACTLAST), v_EC_EMERGENCYCONTACTFIRST, soundex(v_EC_EMERGENCYCONTACTFIRST), null, null, null, '_NOSP', null, null, 0, 'N', 'N', null, 'N', null, null, '_NOSP', null, null, p_action_by, null, null, null, null, 'N', null, NVL(v_InsUpd,'I'), v_result, v_result_msg ); 	            
	 		IF v_result <> 0 THEN
	 			BEGIN
	        		p_errornum := v_result; 
	        		p_errormsg := v_result_msg;  
	        		RETURN; 
	        	END;
	      	END IF;
      	    
			IF v_EC_EMERGENCYRELATIONSHIP is not null THEN
		      	--determine if the emergency contact role already exists
		      	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_entity_relationship
			 		WHERE	entity_id = p_matched_id
			 				and entity_related_to = v_EC_PERSON_ID
			 				and related_as_role = 'CNTCT';
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;              
		 		--insert emergency contact as a contact (i.e. set the relationship type)
		 		EPIC.ehi_eh_entity_relationship(p_matched_id, v_EC_PERSON_ID, 'CNTCT', v_EC_EMERGENCYRELATIONSHIP, '01', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);  
		 		IF v_result <> 0 THEN
		 			BEGIN
		        		p_errornum := v_result; 
		        		p_errormsg := v_result_msg;  
		        		RETURN; 
		        	END;
		      	END IF; 
		    END IF;	        
      
	      	IF v_EC_PHONE_ID is not null THEN
		      	--determine if the emergency contact phone already exists
		      	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_telephone_records
			 		WHERE	entity_id = v_EC_PERSON_ID
			 				and telephone_record_id = v_EC_PHONE_ID;
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;
		      	--insert emergency contact phone information
			   	EPIC.ehi_eh_telephone_records(v_EC_PHONE_ID, v_EC_PERSON_ID, EPIC.epicdatenow(), null, v_EC_PHONE_TYPE, 'Y', v_EC_PHONE_COUNTRY_CODE, v_EC_PHONE_AREA_CODE, v_EC_PHONE_NUMBER, v_EC_PHONE_EXTENSION, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg); 
			 	IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			       		p_errormsg := v_result_msg;  
			       		RETURN; 
			       	END;
			   	END IF;
			END IF;
		END IF;
  	   
  		IF v_CITIZEN is not null THEN
	      	--determine if the citizenship status already exists
	      	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_citizenship
		 		WHERE	entity_id = p_matched_id;
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
	      	--insert the citizenship status
	      	EPIC.ehi_eh_citizenship(p_matched_id, v_CITIZEN, epic.epicdatenow(), null, null, p_action_by, null, NVL(v_InsUpd,'I'), v_result, v_result_msg);
		 	IF v_result <> 0 THEN
				BEGIN
	    			p_errornum := v_result; 
	    			p_errormsg := v_result_msg;  
	    			RETURN;
	    		END;
	    	END IF;
	    END IF; 
        
   		IF v_EM_NAME is not null THEN
	    	--select the organization id from the cursor if it exists. If not, create a new organization: Org ID, Address ID, Telephone ID
	    	OPEN cur_Org;
	    		FETCH cur_Org INTO v_ORG_ID;
				IF cur_Org%NOTFOUND
					THEN v_ORG_ID := EPIC.epic_ids.new_epic_id();
						-- v_EM_ADD_ID := EPIC.epic_ids.new_epic_id();            --RAS deleted 11/29/06
						-- v_EM_PHONE_ID := EPIC.epic_ids.new_epic_id();          --RAS deleted 11/29/06
				END IF;
			CLOSE cur_Org; 
		
			--determine if the employer organization already exists
	      	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_organization
		 		WHERE	entity_id = v_ORG_ID
		 				and UPPER(organization_name) = UPPER(v_EM_NAME);             
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 			v_ORG_ID := EPIC.epic_ids.new_epic_id();			
		 	END;    	
	    	--insert the employer as an organization 
	    	EPIC.ehi_eh_entity_organization(v_ORG_ID, v_EM_NAME, null, null, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
	    	IF v_result <> 0 THEN
				BEGIN
	    			p_errornum := v_result; 
	    			p_errormsg := v_result_msg;  
	    			RETURN; 
	    		END;
	    	END IF; 
	    	
	    	--insert the organization role as employer        --RAS: added 11/29/06
	    	EPIC.ehi_eh_entity_roles(v_ORG_ID, v_EMPROLE, EPIC.epicdatenow(), '2999123100:00:00+000', p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);
	    	IF v_result <> 0 THEN
				BEGIN
	    			p_errornum := v_result; 
	    			p_errormsg := v_result_msg;  
	    			RETURN; 
	    		END;
	    	END IF; 
    	
	    	IF  v_EM_ADD_ID is not null THEN
		    	--determine if the employer address already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_address
			 		WHERE	address_id = v_EM_ADD_ID;
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;  
		    	--insert the employer address
		    	EPIC.ehi_eh_address(v_ORG_ID, v_EM_ADD_ID, 'N', v_EM_ADDRESSCODE, EPIC.epicdatenow(), null, v_EM_DWELL, v_EM_FLAT, v_EM_STNUM, v_EM_STRNAME, v_EM_CITY, v_EM_STATE, v_EM_POSTAL, v_EM_COUNTRY, null, null, null, p_action_by, null, EPIC.epicdatenow(), null, null, null, 'Y', NVL(v_InsUpd,'I'), v_result, v_result_msg);  
		    	IF v_result <> 0 THEN
					BEGIN
		    			p_errornum := v_result; 
		    			p_errormsg := v_result_msg;  
		    			RETURN; 
		    		END;
		    	END IF;
		   END IF;
    	
    		IF v_EM_PHONE_ID is not null THEN
		    	--determine if the employer telephone already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_telephone_records
			 		WHERE	telephone_record_id = v_EM_PHONE_ID;
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;   
		    	--insert employer telephone
		    	EPIC.ehi_eh_telephone_records(v_EM_PHONE_ID, v_ORG_ID, EPIC.epicdatenow(), null, v_EM_PHONE_TYPE, 'Y', v_EM_PHONE_COUNTRY_CODE, v_EM_PHONE_AREA_CODE, v_EM_PHONE_NUMBER, v_EM_PHONE_EXTENSION, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);		          
				IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			       		p_errormsg := v_result_msg;  
			       		RETURN; 
			       	END;
			   	END IF;
			 END IF; 
	   	
    		IF (v_EM_PHONE_ID is not null and v_EM_ADD_ID is not null) THEN
		    	--determine if the employer address/telephone link already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_address_phone_number
			 		WHERE	address_id= v_EM_ADD_ID
			 				and telephone_record_id = v_EM_PHONE_ID;
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END; 
		    	--insert link between employer address and telephone
		    	EPIC.ehi_eh_address_phone_number(v_EM_ADD_ID, v_EM_PHONE_ID, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg); 
		    	IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			       		p_errormsg := v_result_msg;  
			       		RETURN; 
			       	END;
			   	END IF;
			 END IF;
		END IF;
	   	
	   	IF v_EM_ID is not null THEN
		   	--determine if the employment info already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_employment_info
		 		WHERE	employment_id = v_EM_ID;
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END; 
	    	--insert employment info
	      	EPIC.ehi_eh_entity_employment_info(NVL(v_EM_ID, EPIC.epic_ids.new_epic_id()), p_matched_id, v_ORG_ID, null, v_EMPLOYMENTSTATUS, v_OCCUPATION, 'N', 0, null, null, null, null, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);  
	      	IF v_result <> 0 THEN
				BEGIN
		     		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN;
		       	END;
		   	END IF;
         END IF;	           
      
      	IF v_DL_NUMBER is not null THEN
	      	--determine if the driver's license information already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_operators_license
		 		WHERE	operator_license_id = v_DL;
		 		EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END; 
	      	--insert the driver's license information
			EPIC.ehi_eh_operators_license(NVL(v_DL, EPIC.epic_ids.new_epic_id()), p_matched_id, v_IDENTITY_ID,'Y', v_DL_NUMBER, null, EPIC.epicdate(v_DL_EXPIRE), v_DL_STATE, 'US', p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);
		 	IF v_result <> 0 THEN
				BEGIN
	    			p_errornum := v_result; 
	    			p_errormsg := v_result_msg;  
	    			RETURN; 
	    		END;
	    	END IF; 
	   END IF;
 				
 		IF v_HOMELESS = 'N' THEN
	 		IF v_RS_ADDRESS_ID is not null THEN
		 		--determine if the inmate's address already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_address
			 		WHERE	--entity_id = p_matched_id
			 				address_id = v_RS_ADDRESS_ID;
			 		EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END; 
		 		--insert the offender address		
		 		EPIC.ehi_eh_address(p_matched_id, v_RS_ADDRESS_ID, 'N', v_ADDRESSCODE, EPIC.epicdatenow(), null, v_RS_DWELLING_NAME, v_RS_FLAT_NO_OR_FLOOR_LEVEL, v_RS_STREET_NUMBER, v_RS_STREET_NAME, v_RS_CITY_TOWN_LOCALE, v_RS_STATE_PROVINCE_REGION, v_RS_POSTAL_CODE, v_RS_CODE_COUNTRY, null, null, null, p_action_by, null, EPIC.epicdatenow(), null, null, null, 'Y', NVL(v_InsUpd, 'I'), v_result, v_result_msg);        
				IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			     		p_errormsg := v_result_msg;  
			     		RETURN;
			       	END;
		   		END IF;
		   	END IF; 
	 		
	 		IF v_RS_PHONE_ID is not null THEN
		 		--determine if the inmate's telephone already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_telephone_records
				 	WHERE	telephone_record_id = v_RS_PHONE_ID;
				 	EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;
		 		--insert resident phone information			
		 		EPIC.ehi_eh_telephone_records(NVL(v_RS_PHONE_ID, EPIC.epic_ids.new_epic_id()), p_matched_id, EPIC.epicdatenow(), null, v_RS_PHONE_TYPE, 'Y', v_RS_PHONE_COUNTRY_CODE, v_RS_PHONE_AREA_CODE, v_RS_PHONE_NUMBER, v_RS_PHONE_EXTENSION, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);		          
				IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			       		p_errormsg := v_result_msg;  
			       		RETURN; 
			       	END;
			   	END IF;
			END IF;
	   	
		   	IF v_CL_PHONE_ID is not null THEN
			   	--determine if the inmate's cellular/mobile phone information already exists
		    	BEGIN
			 	 	SELECT 	'U'
			 		INTO    v_InsUpd
			 		FROM	EPIC.eh_telephone_records
				 	WHERE	telephone_record_id = v_CL_PHONE_ID;
				 	EXCEPTION WHEN NO_DATA_FOUND THEN
			 			v_InsUpd := null;
			 	END;
			   	--insert cellular/mobile phone information
			   	EPIC.ehi_eh_telephone_records(NVL(v_CL_PHONE_ID, EPIC.epic_ids.new_epic_id()), p_matched_id, EPIC.epicdatenow(), null, v_CL_PHONE_TYPE, 'N', v_CL_PHONE_COUNTRY_CODE, v_CL_PHONE_AREA_CODE, v_CL_PHONE_NUMBER, v_CL_PHONE_EXTENSION, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg); 
			 	IF v_result <> 0 THEN
					BEGIN
			     		p_errornum := v_result; 
			       		p_errormsg := v_result_msg;  
			       		RETURN; 
			       	END;
			   	END IF;
			 END IF;  
		END IF;	   
	   --determine if the inmate's dependents already exists
    	BEGIN
	 	 	SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_dependents
		 	WHERE	entity_id = p_matched_id;
		 	EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;	
	   --insert the offender's dependents		
 		EPIC.ehi_eh_dependents(p_matched_id, 0, 0, 0, 0, null, 'N', null, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg );        
 		IF v_result <> 0 THEN
			BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN; 
	       	END;
	   	END IF; 
 		
 		IF v_RELIGIOUSPREF is not null THEN
 		--determine if the inmate's religous preference already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_religion
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
	 		--insert the offender's religious preference		
	 		EPIC.ehi_eh_entity_religion(p_matched_id, v_RELIGIOUSPREF, EPIC.epicdatenow(), '2999123100:00:00+000', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
			IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		       	END;
		   	END IF; 
		 END IF;
	 	
	 	IF v_MARITALSTATUS is not null THEN
		 	--determine if the inmate's marital status already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_marital_status
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
		 	--insert the offender's marital status		
			EPIC.ehi_eh_marital_status(p_matched_id,v_MARITALSTATUS,epic.epicdatenow(), null, null, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg );
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		       	END;
		   	END IF;
		 END IF; 
	    
		IF v_EDUCATIONLEVEL is not null THEN
			--determine if the inmate's education already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_education
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
			--insert the offender's education
			EPIC.ehi_eh_entity_education(EPIC.epic_ids.new_epic_id(), p_matched_id, null, null, null, null, null, null, null, EPIC.epicdate(sysdate), null, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg); 
			IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		      	END;
		   	END IF; 
		
			--determine if the inmate's highest education level already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_hi_education
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
			--insert offender's highest education level
			EPIC.ehi_eh_entity_hi_education(p_matched_id, v_EDUCATIONLEVEL, null, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);	
			IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		      	END;
		   	END IF; 
		END IF;   
		
		IF v_LANGID is not null THEN
			--determine if the inmate's language already exists
			BEGIN
				SELECT	'U'
				INTO	v_InsUpd
				FROM	EPIC.eh_language
				WHERE	entity_id = p_matched_id;
				EXCEPTION WHEN NO_DATA_FOUND THEN
					v_InsUpd := null;
			END;
			--insert the inmate's language
			EPIC.ehi_eh_language(p_matched_id, v_LANGID, v_LANGTYPE, 1, EPIC.epicdate(sysdate), '_NOSP', '_NOSP', '_NOSP', p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);	
			IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		      	END;
		   	END IF;
		END IF;  		
	 	
		IF v_WORKSKILL is not null THEN		      
			--determine if the inmate's work skills already exist
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_work_skills
			 	WHERE	entity_id = p_matched_id; 
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;
			--insert the inmate's work skills (Read/Write English)
	 		EPIC.ehi_eh_entity_work_skills(v_WorkSkillID, p_matched_id, v_WORKSKILL, p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);  
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		      	END;
		   	END IF;
		END IF;   
		
	 --determine if the inmate's gender already exists
	 BEGIN
		SELECT 	'U'
		INTO    v_InsUpd
		FROM	EPIC.eh_entity_gender
		WHERE	entity_id = p_matched_id; 
		EXCEPTION WHEN NO_DATA_FOUND THEN
			v_InsUpd := null;
		END;
	 --insert the offender's gender
	 EPIC.ehi_eh_entity_gender(p_matched_id, v_GENDER, EPIC.epicdatenow(), p_action_by, NVL(v_InsUpd, 'I'), v_result, v_result_msg);
		IF v_result <> 0 THEN
			BEGIN
				p_errornum := v_result; 
				p_errormsg := v_result_msg;  
				RETURN; 
		 	END;
		END IF;	 	

	 	--determine if the inmate's ethnicity already exists
    	BEGIN
	 	 	SELECT 	'U'
	 		INTO    v_InsUpd
	 		FROM	EPIC.eh_ethnicity
		 	WHERE	entity_id = p_matched_id;
		 	EXCEPTION WHEN NO_DATA_FOUND THEN
	 			v_InsUpd := null;
	 	END;		
	 	--insert the offender's ethnicity
		EPIC.ehi_eh_ethnicity(p_matched_id, EPIC.epic_ids.new_epic_id(), 62,1,epic.epicdatenow(), p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
        IF v_result <> 0 THEN
			BEGIN
	       		p_errornum := v_result; 
	       		p_errormsg := v_result_msg;  
	       		RETURN;
	       	END;
	   	END IF;
	   	
	   	IF v_HEIGHT is not null THEN       
	        --each time the height is modified, it creates a new record. No need to verify pre-existing	
		   	--insert the offender's height		
			EPIC.ehi_eh_entity_height(p_matched_id, EPIC.epic_ids.new_epic_id(), v_HEIGHT, EPIC.epicdatenow(), p_action_by, 'I', v_result, v_result_msg);
	        IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN;
		       	END;
		   	END IF; 
		END IF;		
	 
	  IF v_RACE is not null THEN
		  --determine if the inmate's race already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_entity_race
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;	
		 	--insert the offender's race		
			EPIC.ehi_eh_entity_race(p_matched_id, v_RACE, p_action_by, NVL(v_InsUpd,'I'), v_result, v_result_msg);
			IF v_result <> 0 THEN
	 			BEGIN
	        		p_errornum := v_result; 
	        		p_errormsg := v_result_msg; 
	        		RETURN;
	        	END;
	      	END IF;
		END IF;

	 	IF v_WEIGHT is not null THEN
		 	--each time the weight is modified, it creates a new record. No need to verify pre-existing	
			--insert the offender's weight
			EPIC.ehi_eh_entity_weight(p_matched_id, EPIC.epic_ids.new_epic_id(), v_WEIGHT, EPIC.epicdatenow(), p_action_by, 'I', v_result, v_result_msg);
			IF v_result <> 0 THEN
				BEGIN
	        		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;    
		       		RETURN; 
		       	END;
		   	END IF;
		END IF;
	   	
	   	IF (v_HAIR is not null and v_COMPLEXION is not null /*and v_BUILD is not null*/) THEN
	 		/*commented block of code below: snapshot will always insert, so we don't need to do this check
	 		--determine if the inmate's physical demographics already exists
	    	BEGIN
		 	 	SELECT 	'U'
		 		INTO    v_InsUpd
		 		FROM	EPIC.eh_person_snapshot
			 	WHERE	entity_id = p_matched_id;
			 	EXCEPTION WHEN NO_DATA_FOUND THEN
		 			v_InsUpd := null;
		 	END;*/
	 		--insert other offender physical demographics (hair color, complexion, build)		
	 		EPIC.ehi_eh_person_snapshot(p_matched_id, EPIC.epicdatenow(), 'N', 'N', null, null, v_HAIR, null /*v_BUILD*/, v_COMPLEXION, null, null, null, p_action_by, null,'I', v_result, v_result_msg);
	 		IF v_result <> 0 THEN
				BEGIN
		       		p_errornum := v_result; 
		       		p_errormsg := v_result_msg;  
		       		RETURN; 
		      	END;
		   	END IF;
		END IF;
	END;
END;
/

CREATE OR REPLACE
PROCEDURE        MP_PB_lookup
		(	p_lookup_class IN MV_BOOKING_LOOKUPS.lookup_class%type,
			cur			      OUT epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Purpose:		pull back a list of values for lookup in pre-booking

	Author:			Joe McBratnie

	Change Log:		Changed By	    Date Modified	Change Made
					----------  	-------------	------------------------------------------
					J. McBratnie	3/134/2006		Created
*/
    
BEGIN
        
	OPEN cur FOR
         SELECT	Lookup_code, Text_full
 		 FROM	MV_BOOKING_LOOKUPS
 		 WHERE  lookup_class = p_lookup_class
 		 ORDER BY display_order;
	
END;
/

CREATE OR REPLACE
PROCEDURE        MP_PB_property_lookup
		(	cur			      OUT epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Purpose:		pull back a list of values for lookup in pre-booking

	Author:			Joe McBratnie

	Change Log:		Changed By	    Date Modified	Change Made
					----------  	-------------	------------------------------------------
					J. McBratnie	3/134/2006		Created
*/
    
BEGIN
        
	OPEN cur FOR
         SELECT	property_id, description
 		 FROM	MACOMB.MT_PB_PROPERTY_LK
 		 ORDER BY sortorder;
	
END;
/

CREATE OR REPLACE
PROCEDURE mp_PB_property_processing
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE,
	 	p_matched_id        IN  MACOMB.mt_pb_arrestee.matchedoffender_id%TYPE,
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 
	
IS	 

/*	
	Purpose:		Insert OT Property (using EPIC.ehi_eh_property_item()) with MACOMB MT_PB_Arrest_Property Data
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/09/06		Created                 
	                M Zak        06/08/06       Need to test p_errornum & msg (added but not tested w/execute cmd)  
	                R. Stuve	 07/07/06		De-bugged, tested
	                J. MCBRATNIE 07/14/06		Updated missing defaults and added institution_id as hard code. 
	                R. Stuve	 08/01/2006		Removed hard-code for institution_id, added item condition 
	                R. Stuve	 09/11/06		Removed open/close cursor: not needed with for..in...loop (was not inserting data) 
	
*/ 
	
v_result        EPIC.epic_col_types.number_9%TYPE;
v_result_msg    EPIC.epic_col_types.varchar_255%TYPE;
v_facility_id	EPIC.epic_locations.location_id%TYPE;
  
   
CURSOR pout IS
  	SELECT      * 
	FROM 	MACOMB.mt_pb_arrest_property
	WHERE   arrest_id = p_arrest_id; 

BEGIN 
  
p_errornum 	:= 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
p_errormsg 	:= null;
  
--get the institution_id
BEGIN
	SELECT	location_id
 	INTO	v_facility_id
	FROM	EPIC.epic_locations
	WHERE 	location_name = 'MCJ';
END;  

--OPEN pout;
	--IF pout%FOUND THEN  
		FOR pcur in pout
			LOOP 
				EPIC.ehi_eh_offender_property(p_matched_id, pcur.property_id, 'I'/*code item type*/, p_action_by, 'I', v_result, v_result_msg); 
					IF v_result <> 0 THEN
	 					BEGIN
	        				p_errornum := v_result; 
	        				p_errormsg := v_result_msg;  
	        				RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	        			END;
	      			END IF; 	
	      			 
				EPIC.ehi_eh_property_item(pcur.property_id, v_facility_id, pcur.property, pcur.quantity, null/*item_manufacturer*/, null/*make_or_label*/, null/*item_model*/, pcur.color, pcur.description, null/*code_item_source_type*/, null/*item_serial_number*/, null/*code_item_material*/, null/*code_item_location*/, null/*item_received_date*/, null/*item_destroyed_date*/,
				p_action_by, pcur.description, null/*item_note*/, null/*item_reason_destroyed*/, null/*item_remove_by_date*/, null/*code_removal_reason*/, null/*item_confiscation_return_date*/, null/*item_disposal_date*/, 'N'/*item_is_valuable*/, 'N'/*item_is_boxed*/, null/*code_storage_reason*/, null/*orphan_property*/, null/*unit_id*/, null/*bin_id*/, 'I', v_result, v_result_msg);
					IF v_result <> 0 THEN
	 					BEGIN
	        				p_errornum := v_result; 
	        				p_errormsg := v_result_msg;  
	        				RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	        			END;
	      			END IF; 			
			END LOOP;
		--ELSE
		--	p_errornum := 6;
		--	p_errormsg := 'Property cursor returned no property rows';
	--END IF;
--CLOSE pout;	
END;
		 
/

CREATE OR REPLACE
PROCEDURE MP_PB_Security_data
	 (	vUserID     IN              EPIC.EPIC_USER_NAMES.USER_ID%type,
	    vCur 			out      	EPIC.epp_generic_ref_cursor.ref_cursor)
		
IS

 /*
	Purpose:		Used for pulling the data needed for the security Module.


	Author:			Joe McBratnie

	Change Log:		Changed By  	Date Modified	Change Made
					------------	-------------	------------------------------------------
					J. McBratnie    12/14/2006      Created  
					R. Stuve		01/04/07		Added sysdate check, mf_pb_security function
					J. McBratnie    02/14/07        Added loging ok
						
*/
 
 
BEGIN     
	OPEN vCur FOR
          	SELECT n.user_id,
			       n.user_int_id,
			       n.encrypted_password,
			       n.user_name_first,
			       n.user_name_last,
				   MACOMB.mf_pb_security(vUserID) Command,
				   MACOMB.mf_pb_loginok(vUserID) Login
			FROM   EPIC.epic_user_names n,
			       EPIC.epic_user_roles r
			WHERE n.user_int_id = r.user_int_id
  	              and n.user_id = UPPER(vUserID)
  	              and EPIC.ef_epic_date_to_date(r.date_end) >= sysdate
				  and EPIC.ef_epic_date_to_date(r.date_start) <= sysdate
				  and rownum = 1 ;     
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_set_mt_keep_separate
 (	p_Entity_id		in  epic.eh_entity_person.entity_id%type,
	p_Arrest_Id		in	mt_pb_arrestee.arrest_id%type, 
	p_errornum		OUT number,
	p_errormsg      OUT epic.epic_col_types.varchar_255%type ) 
	

IS
/*	
	Purpose:		Update Web Mt_PB_keep_separate Table with OT data, so it can be pulled back into
	                web app for inmates found           
	                
	                NOTE:  Mary Ann - I think we need to store the location_id (varchar2)
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created
					m Zak        06-26-06       removed mf_Arrestee_EntityID, added errornum and errormsg 
					R. Stuve	 07/17/06      	Changed p_errornum from 1 to 4 (for easier trouble-shooting) through GUI
*/
BEGIN
	BEGIN
		INSERT into MACOMB.MT_PB_KEEP_SEPARATE
   		(SELECT	
   				ks.keep_separate_id,
				--p_Arrest_Id,
				--EPIC.ef_offender_id(ks.origin_entity_id),
				EPIC.ef_offender_id(ks.origin_entity_id),
			    EPIC.ef_offender_id(ks.separate_entity_id),
		   		EPIC.ef_offender_cell(ks.origin_entity_id) 

		FROM	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
	  			EPIC.eh_keep_separate ks

		WHERE	bk.booking_id = ab.booking_id
	    		and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    		and bk.entity_id = p_Entity_id --MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
	    		and not ks.origin_entity_id = p_Entity_id --MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 

		UNION ALL
		
 		SELECT	
 				ks.keep_separate_id,
				--p_Arrest_Id,
 				--EPIC.ef_offender_id(ks.separate_entity_id),
 				EPIC.ef_offender_id(ks.origin_entity_id),
			    EPIC.ef_offender_id(ks.separate_entity_id),
				EPIC.ef_offender_cell(ks.separate_entity_id) 

		FROM	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
	  			EPIC.eh_keep_separate ks

		WHERE	bk.booking_id = ab.booking_id
				and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    		and bk.entity_id = p_Entity_id --MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
	    		and not ks.separate_entity_id = p_Entity_id --MACOMB.mf_Arrestee_EntityID(p_Arrest_id)
		);
		
		EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
			BEGIN
			p_errornum := 4;  -- set to error exist
			p_errormsg := 'Keep Separate Record(s) already exist';
			return;
			END;
		--RAISE_APPLICATION_ERROR(-20920, 'Keep Separate Record(s) already exist');  	
	END;  

	COMMIT;
END;		
/

CREATE OR REPLACE
PROCEDURE mp_pb_Set_mt_pb_arrestee
(	p_entity_id		in  epic.eh_entity_person.entity_id%type,
	p_Arrest_Id		in	mt_pb_arrestee.arrest_id%type,
	p_errornum		OUT number,
	p_errormsg      OUT epic.epic_col_types.varchar_255%type )

IS
/*	
	Purpose:		Update Web Mt_PB_Arrestee Table with OT data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/09/06		Created
					R. Stuve	 07/17/06		Changed links in WHERE logic (commented within code)
					R. Stuve	 07/20/06		Changed functions that were returning text values to functions that will return code values
												(this is for proper saving to the pb/epic tables)
					R. Stuve	 07/27/06		Changed SSN function to MCMB function with no dashes
					R. Stuve	 07/31/06		Added USCitizen & Homeless flags
					R. Stuve	 08/02/06		Substituted height function to return in needed format
					R. Stuve	 08/07/06		Added mf_occupation_code to return code instead of text; 
												new functions for emg contact info to ensure return of proper EC info 
					R. Stuve	 08/08/06		Created new functions for read/write/speak english in order to return proper value
					R. Stuve	 08/09/06		Created new functions for employer address & phone in order to return proper information
					R. Stuve	 09/18/06		Added new height function to return 3-digit height as used by MCSO 
					R. Stuve	 11/08/06		Added function to return birth city from generic attribute (field MCSO uses for this data)  
					R. Stuve	 11/27/06		Replaced EPIC religion function with MACOMB religion function
*/ 
v_errormsg		varchar2(100);
BEGIN    
	BEGIN  	
			UPDATE MACOMB.MT_PB_ARRESTEE
			set (lastname, firstname, middlename,
				name_title, name_suffix,
				offender_id, state_id,
				fbi_id, ssn, rs_address_id,
				rs_dwelling_name, rs_flat_no_or_floor_level, rs_street_number, rs_street_name,
				rs_city_town_locale, rs_state_province_region, rs_postal_code, rs_code_country,
				rs_phone_id,
				rs_phone_country_code, rs_phone_area_code,
				rs_phone_number, rs_phone_extension, rs_phone_type,
				cl_phone_id,
				cl_phone_country_code, cl_phone_area_code,
				cl_phone_number, cl_phone_extension, cl_phone_type,
				dob, height,
				weight, race,
				--build,
				gender, eyeright,
				eyeleft, hair,
				complexion,	maritalstatus,
				birthcity, birthstate,
				birthcountry, religiouspref,
				dl_id,
				dlnumber, dlstate,
				dlexpire,
				--englishspoken,
				englishread,
				englishwritten,
				educationlevel, 
				employement_id,
				occupation,
				employername,
				em_address_id,
				em_dwelling_name, em_flat_no_or_floor_level,
				em_street_number, em_street_name,
				em_city_town_locale, em_state_province_region,
				em_postal_code, em_code_country, 
				em_phone_id,
				em_phone_country_code, em_phone_area_code,
				em_phone_number, em_phone_extension, em_phone_type,
				ec_person_id,
				emergencycontact, 
				ec_phone_id,
				ec_phone_country_code,
				ec_phone_area_code, ec_phone_number,
				ec_phone_extension, ec_phone_type,
				emergencyrelationship,
				homeless, 
				uscitizen
				) =
				(select	name_family, name_first, name_other,
				        EPIC.ef_lookup_text('TITLE', pi.NAME_TITLE, 'UC'), name_suffix,
						EPIC.ef_offender_id(p_entity_id),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'SID NUMBER'),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'FBI TRACKING'),
   						MACOMB.mcmb_fnt_socsec_numeric(p_entity_id),
			            address_id,dwelling_name, flat_no_or_floor_level, street_number,street_name,
			            city_town_locale, state_province_region, postal_code, code_country,
			            MACOMB.MF_Ph_ID(p_entity_id, 'HOME'),
			            MACOMB.MF_PhCountry(p_entity_id, 'HOME'), MACOMB.MF_PhArea(p_entity_id, 'HOME'),
			            MACOMB.MF_PhNumber(p_entity_id, 'HOME'), MACOMB.MF_PhExtension(p_entity_id, 'HOME'), 'HOME',
			            MACOMB.MF_Ph_ID(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhCountry(p_entity_id, 'MOBILE'), MACOMB.MF_PhArea(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhNumber(p_entity_id, 'MOBILE'), MACOMB.MF_PhExtension(p_entity_id, 'MOBILE'), 'MOBILE',
			            EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),
			            MACOMB.mf_pb_height(p_entity_id), 
			            EPIC.ef_Offender_Weight(p_entity_id), 
			            MACOMB.mf_ef_offender_race(p_entity_id),
			            --MACOMB.mf_pb_build(p_entity_id),
			            EPIC.ef_offender_person_gender(p_entity_id),
			            MACOMB.mf_eyecolorright_code(p_entity_id),
			            MACOMB.mf_eyecolorleft_code(p_entity_id),
			            MACOMB.mf_Hair_code(p_entity_id),
			            MACOMB.mf_complexion_code(p_entity_id), 
			            EPIC.ef_marital_status(p_entity_id),
			            MACOMB.mf_pb_BirthCity(p_entity_id), --MACOMB.mcmb_fnt_birthcity(p_entity_id), 
			            MACOMB.mcmb_fnt_birthstate(p_entity_id),
			            MACOMB.mf_birthcountry_code(p_entity_id),
			            MACOMB.mf_pb_religion(p_entity_id), --EPIC.ef_offender_religion(p_entity_id),
			            MACOMB.mf_primary_dlicno_ID(p_entity_id),
			            EPIC.ef_primary_dlicno(EPIC.ef_identity_id(p_entity_id)),  -- primary drivers license & info
			            MACOMB.mf_primary_dlicno_state(p_entity_id),
			            MACOMB.mf_primary_dlicno_expire(p_entity_id),
			            --MACOMB.mf_ef_get_Primary_Lang_code(p_entity_id),
			            MACOMB.mf_pb_CanReadYN(p_entity_id), --MACOMB.mf_CanReadYN(p_entity_id),
			            MACOMB.mf_pb_CanWriteYN(p_entity_id), --MACOMB.mf_CanWriteYN(p_entity_id),
			            MACOMB.mf_highest_education(p_entity_id), 
			            MACOMB.mf_pb_Employment_ID(p_entity_id),  --MACOMB.mf_Employment_ID(p_entity_id),
			            MACOMB.mf_occupation_code(p_entity_id), --MACOMB.mf_Occupation(p_entity_id),
                        MACOMB.mf_pb_EmployerName(p_entity_id), --MACOMB.mf_EmployerName(p_entity_id),
                        MACOMB.mf_pb_EmpAdr_ID(p_entity_id), --MACOMB.MF_EmpAdr_ID_by_entid(p_entity_id),
                        MACOMB.mf_pb_EmpAdrDwelling(p_entity_id), --MACOMB.mf_EmpAdrDwelling_by_entid(p_entity_id), 
                        MACOMB.mf_pb_EmpFlatFloor(p_entity_id), --MACOMB.MF_EmpAdrFlatno_floor_by_entid(p_entity_id),
                        MACOMB.mf_pb_EmpStreetNum(p_entity_id), --MACOMB.MF_EmpAdrstreetnmbr_by_entid(p_entity_id), 
                        MACOMB.mf_pb_EmpStreetName(p_entity_id), --MACOMB.MF_EmpAdrstreetname_by_entid(p_entity_id),
                        MACOMB.mf_pb_EmpCity(p_entity_id), --MACOMB.MF_EmpAdrcity_town_by_entid(p_entity_id),
						MACOMB.mf_pb_EmpState(p_entity_id), --MACOMB.MF_EmpAdrstate_prov_by_entid(p_entity_id),
                        MACOMB.mf_pb_EmpPostal(p_entity_id), --MACOMB.MF_EmpAdrPostal_by_entid (p_entity_id), 
                        MACOMB.mf_pb_EmpCountry(p_entity_id), --MACOMB.MF_EmpAdrCountry_by_entid (p_entity_id),
                        MACOMB.mf_pb_EmpPh_ID(p_entity_id, 'WORK'), --MACOMB.MF_EmpPh_ID_by_entid(p_entity_id, 'WORK'),
                        MACOMB.mf_pb_EmpPh_Cnt(p_entity_id), --MACOMB.MF_EmpPhCountry_by_entid(p_entity_id, 'WORK'), 
                        MACOMB.mf_pb_EmpPh_Area(p_entity_id), --MACOMB.MF_EmpPhArea_by_entid(p_entity_id, 'WORK'),
                        MACOMB.mf_pb_EmpPh_Nbr(p_entity_id), --MACOMB.MF_EmpPhNmbr_by_entid(p_entity_id, 'WORK'), 
                        MACOMB.mf_pb_EmpPh_Ext(p_entity_id), --MACOMB.MF_EmpPhExt_by_entid(p_entity_id, 'WORK'),
                        'WORK',
                        MACOMB.mf_pb_emgcntc_id(p_entity_id), -- MACOMB.MF_EC_Contact_ID(p_entity_id),
                        MACOMB.mf_pb_emgcntc(p_entity_id), --MACOMB.MF_EC_Contact(p_entity_id),
                        MACOMB.mf_pb_EC_Ph_ID(p_entity_id),--MACOMB.MF_EC_Ph_ID(p_entity_id), 
                        MACOMB.mf_pb_EC_Country(p_entity_id), --MACOMB.MF_EC_Country(p_entity_id),
						MACOMB.mf_pb_EC_Area(p_entity_id), --MACOMB.MF_EC_Area(p_entity_id), 
						MACOMB.mf_pb_EC_PhNumber(p_entity_id), --MACOMB.MF_EC_PhNumber(p_entity_id),
						MACOMB.mf_pb_EC_Extension(p_entity_id), --MACOMB.MF_EC_Extension(p_entity_id), 
						MACOMB.mf_pb_EC_PhType(p_entity_id), --MACOMB.MF_EC_PhType(p_entity_id),
						MACOMB.mf_pb_EC_Relation_code(p_entity_id), --MACOMB.MF_EC_Relation_code(p_entity_id),
						MACOMB.mf_homeless(p_entity_id),
						MACOMB.mf_USCitizen(p_entity_id)

					from	EPIC.eh_person_identity pi, EPIC.eh_entity_person ep, EPIC.eh_address a--,

					where	ep.entity_id =  p_entity_id   -- matchedoffender_id
					        and	pi.identity_id = ep.primary_identity_id
	                        and ep.entity_id = a.entity_id(+)   --changed pi.identity_id to ep.entity_id (RAS)
					        and (EPIC.ef_get_primary_address_id(p_entity_id) is null or
					             a.address_id = EPIC.ef_get_primary_address_id(p_entity_id))
	                )  

		where MACOMB.mt_pb_arrestee.arrest_id = p_arrest_id; 
	
	IF SQL%NOTFOUND THEN
	    BEGIN
        p_errornum := 1;  -- set to error exist
		p_errormsg := 'Arrestee Update Failed, Arrest ID not found.';
		return;
		END;
		END IF;  							
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_pb_set_mt_pb_language
 (	p_Entity_id		in  epic.eh_entity_person.entity_id%type,
	p_Arrest_Id		in	mt_pb_arrestee.arrest_id%type, 
	p_errornum		OUT number,
	p_errormsg      OUT epic.epic_col_types.varchar_255%type ) 

IS
/*	
	Purpose:		Insert Web Mt_PB_Person_Language Table with OT data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created 
					m Zak        06-26-06       removed mf_Arrestee_EntityID, added errornum and errormsg
					R. Stuve	 07/17/06      	Changed p_errornum from 1 to 3 (for easier trouble-shooting) through GUI
*/
					
BEGIN    
	BEGIN 				
		INSERT into MACOMB.MT_PB_LANGUAGE
			(SELECT
				el.language_id,
	       		p_Arrest_id,
	       		el.code_language
				
		FROM 	EPIC.eh_language el

   		WHERE	el.entity_id =  p_Entity_id
     	      
	 		);

	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN 
			BEGIN
			p_errornum := 5;  -- set to error exist
			p_errormsg := 'Language Record(s) already exist';
			return;
			END;
		--RAISE_APPLICATION_ERROR(-20122, 'Language Record(s) already exist');  	
	END;  

	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE mp_pb_set_mt_pb_person_alias
 (	p_Entity_id		in  epic.eh_entity_person.entity_id%type,
	p_Arrest_Id		in	mt_pb_arrestee.arrest_id%type, 
	p_errornum		OUT number,
	p_errormsg      OUT epic.epic_col_types.varchar_255%type ) 

IS
/*	
	Purpose:		Insert Web Mt_PB_Person_Alias Table with OT Alias data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created 
					m Zak        06-26-06       removed mf_Arrestee_EntityID, added errornum and errormsg
					R. Stuve	 07/17/06      	Changed p_errornum from 1 to 2 (for easier trouble-shooting) through GUI
					R. Stuve	 08/02/06       Added 'Y' flag for OT_DATA field
					R. Stuve	 08/28/06		Added DOB and SSN fields 
					R. Stuve	 09/07/06		Hard-coded 'ALI' name type and added decode in WHERE clause to account for multiple master names
*/
					
BEGIN    
	BEGIN 				
		INSERT into MACOMB.MT_PB_PERSON_ALIAS
			(SELECT
				pi.identity_id,
	       		p_Arrest_id,
				pi.name_family,
				pi.name_first,
				'ALI',  --this needs to be hard-coded due to multiple MASTER name types
				'Y',
				EPIC.ef_epic_date_to_date(pi.date_of_birth),
				pi.social_security_number

		FROM 	EPIC.eh_person_identity pi,
				EPIC.eh_entity_person ep

   		WHERE	ep.entity_id = pi.entity_id
   				and pi.entity_id =  p_Entity_id 
     	      	--and pi.code_name_type != 'MAS'    --this does not work in cases of multiple master names. must use decode in those cases
     	      	and decode(pi.identity_id, ep.primary_identity_id, 'P', 'A') = 'A'
	 		);

	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN 
			BEGIN
			p_errornum := 2;  -- set to error exist
			p_errormsg := 'Alias Record(s) already exist.';
			return;
			END;
		--RAISE_APPLICATION_ERROR(-20506, 'Alias Record(s) already exist');  	
	END;  

	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE		              mp_pb_set_wrapper
	 (	p_entity_id         IN  epic.eh_entity_person.entity_id%type,
  		p_arrest_id 	    IN 	macomb.MT_PB_ARRESTEE.ARREST_ID%type,  
		p_errornum			OUT number,
	    p_errormsg          OUT EPIC.epic_col_types.varchar_255%type
	 ) 
 
IS	 
 /*	
	Purpose:		Macomb Pre booking - Wrapper program to pull data from
	                OT to MACOMB TABLESsave that
					Data needed for the follow the process
					NOTE:  matching offender id = entity_id
					
	Process:		

	Author:			M Zak
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					M. ZAK		  06/22/06		Created 
					J. McBratnie  07/17/2006    save matching offender.
					R. Stuve	  08/16/06		Added check for existing record in epic active booking table
*/  
--  p_errornum		number;
--  p_errormsg		varchar2(100);	 
v_errornum		number;
v_errormsg		varchar2(100);
v_epic			varchar2(1);

CURSOR curExists IS
	SELECT	'Y'
	FROM	EPIC.eh_active_booking
	WHERE	entity_id = p_entity_id;

BEGIN 
	-- init error vars
	p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
	p_errormsg := null; 
	v_epic	   := null; 

OPEN curExists;
	FETCH curExists INTO v_epic;
	
	IF v_epic is not null THEN
		p_errornum := 3;
		p_errormsg := 'Inmate already has an active booking in Offendertrak';
		RETURN;
	ELSE	 
		BEGIN
		    UPDATE MACOMB.MT_PB_ARRESTEE
		    SET MATCHEDOFFENDER_ID = p_entity_id
		    WHERE  ARREST_ID = p_arrest_id; 
		    COMMIT;
		END;
		
		-- check data for column p_entity_id is not null
		if p_entity_id is null then
			p_errormsg := 'parameter p_entity_id contains an invalid or null value.';
			return;
		end if;
		-- check data for column p_arrest_id is not null
		if p_arrest_id is null then
			p_errormsg := 'parameter p_arrest_id contains an invalid or null value.';
			return;
		end if;
	
		-- MT_PB_ARRESTEE   
	    MACOMB.mp_PB_set_mt_pb_arrestee( p_entity_id, p_arrest_id, v_errornum,v_errormsg);
		IF v_errornum <> 0 THEN
			BEGIN
			    p_errornum := v_errornum;
				p_errormsg := v_errormsg;
				RETURN; 
			END;
		END IF;
		
		-- MT_PB_PERSON_ALIAS 
	  MACOMB.mp_PB_set_mt_pb_person_alias( p_entity_id, p_arrest_id, v_errornum,v_errormsg);
		IF v_errornum <> 0 THEN
			BEGIN
			    p_errornum := v_errornum;
				p_errormsg := v_errormsg;
			 	RETURN; 
			END;
		END IF; 
		
		-- MT_PB_LANGUAGE
	   MACOMB.mp_PB_set_mt_pb_language( p_entity_id, p_arrest_id, v_errornum,v_errormsg);
		IF v_errornum <> 0 THEN
		 		BEGIN
				    p_errornum := v_errornum;
					p_errormsg := v_errormsg;
					RETURN; 
				END;
		END IF; 
		
		-- MT_PB_KEEPSEPERATE
	 	MACOMB.mp_pb_set_mt_keep_separate( p_entity_id, p_arrest_id, v_errornum,v_errormsg);
			IF v_errornum <> 0 THEN
		 		BEGIN
				    p_errornum := v_errornum;
					p_errormsg := v_errormsg;
					RETURN; 
				END;
			END IF;
		END IF;
	CLOSE curExists;
	
		IF (p_errornum IS NULL OR p_errornum = 0 ) THEN 
			COMMIT;
		ELSE
			ROLLBACK;
		END IF;			                         
END;
/

CREATE OR REPLACE
PROCEDURE        MP_PB_step_lookup
		(	cur			      OUT epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Purpose:		pull back a list of values for lookup in pre-booking

	Author:			Joe McBratnie

	Change Log:		Changed By	    Date Modified	Change Made
					----------  	-------------	------------------------------------------
					J. McBratnie	3/134/2006		Created
*/
    
BEGIN
        
	OPEN cur FOR
         SELECT	step_id, stepdescription
 		 FROM	MACOMB.MT_PB_STEP_LK;
	
END;
/

CREATE OR REPLACE
PROCEDURE        MP_PB_TOW_lookup
		(	cur			      OUT epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Purpose:		pull back a list of values for lookup in pre-booking

	Author:			Joe McBratnie

	Change Log:		Changed By	    Date Modified	Change Made
					----------  	-------------	------------------------------------------
					J. McBratnie	3/134/2006		Created
*/
    
BEGIN
        
	OPEN cur FOR
         SELECT	TOWCOMANY_ID, TOWCOMPANYNAME, PHONE_COUNTRY_CODE, PHONE_AREA_CODE, PHONE_NUMBER, PHONE_EXTENSION, TOWCOMPANYLOCATION, TOWCOMPANYCITY, TOWCOMPANYSTATE, TOWCOMPANYZIP
 		 FROM	MACOMB.MT_PB_TOW_DETAILS
 		 ORDER BY towcompanyname;
	
END;
/

CREATE OR REPLACE
PROCEDURE        mp_pb_workflow
	(p_arrest_id 	IN 		EPIC.eh_entity.entity_id%TYPE,
	 p_action_by	IN  	EPIC.eh_entity.action_by%TYPE,
	 p_action_time	IN		EPIC.eh_entity.action_time%TYPE,
	 p_errornum		OUT 	number,
	 p_errormsg		OUT 	varchar2)
	
/*	
	Purpose:		Macomb Pre Booking - Creates workflow entries in the EPIC tables.

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					R. Stuve	 10/12/06			Created 
					R. Stuve	 10/30/06			Edited Workflow priority query
*/  
IS

v_facility_id		EPIC.epic_locations.location_id%TYPE;
v_taskname			MACOMB.mt_pb_workflow.taskname%TYPE;
v_taskid        	MACOMB.mt_pb_workflow.taskid%TYPE;
v_lgcfield     		MACOMB.mt_pb_workflow.lgcfield%TYPE;
v_holder			NUMBER(1);
masterquery 		VARCHAR2(4000);
v_result			EPIC.epic_col_types.number_9%TYPE;
v_result_msg 		EPIC.epic_col_types.varchar_255%TYPE;
v_code_priority		EPIC.eh_workflow_task_instance.code_priority%TYPE;

 
query1 			VARCHAR2(200)	:= 	'SELECT 1 INTO v_holder FROM MACOMB.mt_pb_arrestee where arrest_id = p_arrest_id and';

--Loop through records of MACOMB.mt_pb_workflow table
CURSOR curwork IS
 	SELECT *
	INTO v_taskid, v_taskname, v_lgcfield
 	FROM MACOMB.mt_pb_workflow
	ORDER BY rownum;

BEGIN

p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
p_errormsg := null;
v_code_priority := null; 
      
	 --get the facility_id 
	 BEGIN
 		SELECT	location_id
        INTO	v_facility_id
		FROM	EPIC.epic_locations
		WHERE 	location_name = 'MCJ';
     END;                                  
     
     --set the code priority higer for inmates with special circumstances
	 BEGIN
	 	SELECT	'01'
	 	INTO	v_code_priority
	 	FROM	MACOMB.mt_pb_arrestee
	 	WHERE	arrest_id = p_arrest_id
	 			and (assultiveflag = 'Y' 
	 			or medicalflag = 'Y' 
	 			or suicideflag = 'Y' 
	 			or sprayflag = 'Y'
	 			or electroshockflag = 'Y');
	 	EXCEPTION WHEN NO_DATA_FOUND
	      then v_code_priority := null;
	 END;
				
		FOR workcur in curwork LOOP
			--If the lgcfield is null, the associated workflow will run for every inmate 
			--dbms_output.put_line('taskid: ' ||v_taskid || ' taskname: ' || v_taskname) ;
		 	IF workcur.lgcfield is null THEN
				BEGIN	
 					EPIC.ehi_eh_workflow_task_instance(EPIC.epic_ids.new_epic_id(),workcur.taskid,v_facility_id,'0',p_arrest_id,'INITIAL',v_code_priority, null, null,'0',null,null,0,0,null,p_action_by,'N',null,'I',v_result,v_result_msg);
	 				IF v_result <> 0 THEN
	 					BEGIN
	       					p_errornum := v_result; 
	       					p_errormsg := v_result_msg;  
	       					RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       				END;
	    			END IF; 
				END; 
     		ELSE 
     			--select the inmate records that have an associated logic: insert according to the criteria
     				--this is for future growth capabilities (dynamic querying: criteria added to the lgcfield field in the macomb.mt_pb_workflow table)
	     		masterquery := query1 ||' '|| workcur.lgcfield;
				IF v_holder = 1 THEN 
					BEGIN
				   		EPIC.ehi_eh_workflow_task_instance(EPIC.epic_ids.new_epic_id(),workcur.taskid,v_facility_id,'0',p_arrest_id,'INITIAL',v_code_priority, null, null,'0',null,null,0,0,null,p_action_by,'N',null,'I',v_result,v_result_msg);
						IF v_result <> 0 THEN
	 						BEGIN
	       						p_errornum := v_result; 
	       						p_errormsg := v_result_msg;  
	       						RETURN; --terminate the master SQL begin/end and set the value to output to the wrapper
	       					END;
	    				END IF; 
					END;						
	     		END IF;
	     	END IF; 
	     END LOOP;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_pb_workflow_backup
	(p_arrest_id 	IN 		EPIC.eh_entity.entity_id%TYPE,
	 p_action_by	IN  	EPIC.eh_entity.action_by%TYPE,
	 p_action_time	IN		EPIC.eh_entity.action_time%TYPE)
	
/*	
	Purpose:		Macomb Pre Booking - Creates workflow entries in the EPIC tables.

	Author:			Rachel Stuve
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					R. Stuve	 	06/06/06		Created 
*/  
IS

v_facility_id	EPIC.epic_locations.location_id%type;
v_taskname		MACOMB.mt_pb_workflow.taskname%type;
v_taskid        MACOMB.mt_pb_workflow.taskid%type;
v_lgcfield     	MACOMB.mt_pb_workflow.lgcfield%type;
v_holder		NUMBER(1);
masterquery 	VARCHAR2(4000);
 
query1 			VARCHAR2(200)	:= 	'SELECT 1 INTO v_holder FROM MACOMB.mt_pb_arrestee where arrest_id = p_arrest_id and';

--Loop through records of MACOMB.mt_pb_workflow table
		CURSOR cur_workflow IS
			SELECT *
			INTO v_taskname, v_taskid, v_lgcfield
			FROM MACOMB.mt_pb_workflow
			ORDER BY rownum;

BEGIN
	 --get the facility_id 
	 BEGIN
 		SELECT	location_id
        INTO	v_facility_id
		FROM	EPIC.epic_locations
		WHERE 	location_name = 'MCJ';
     END;                                  

			
	BEGIN
		FOR workflow_rec in cur_workflow LOOP
			--If the lgcfield is null, the associated workflow will run for every inmate
			IF v_lgcfield is null THEN
				BEGIN
			   		INSERT INTO EPIC.eh_workflow_task_instance
					VALUES (EPIC.epic_ids.new_epic_id(),v_taskid, v_facility_id, null , p_arrest_id, 'RUNNING',null, null, null, 0, null, null, 0,0, null, 'U', p_action_time, p_action_by, 'N' , null);
				EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');
				END;
     		ELSE 
     			--select the inmate records that have an associated logic: insert according to the criteria
	     		masterquery := query1 ||' '|| v_lgcfield;
				IF v_holder = 1 THEN 
					BEGIN
				   		INSERT INTO EPIC.eh_workflow_task_instance
						VALUES (EPIC.epic_ids.new_epic_id(),v_taskid, v_facility_id, null , p_arrest_id, 'RUNNING',null, null, null, 0, null, null, 0,0, null, 'U', p_action_time, p_action_by, 'N' , null);
					EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE_APPLICATION_ERROR(-20416,'Record already exists');
					END;						
	     		END IF;
	     	END IF;
	     END LOOP;
	END;
--COMMIT; Can not commit
END;
/

CREATE OR REPLACE
PROCEDURE         mp_PB_Wrapper
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,    --type: char(16)
	 	--p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE, --type: number(9)
	 	p_errornum			OUT number,
	 	p_errormsg			OUT varchar2
	 ) 
 
IS	 
 /*	
	Purpose:		Macomb Pre booking - Wrapper program to save the data needed for the Offendertrak insert
	Process:		IF fresh arrest
						Update person with minimal details
					END IF                               
					create the inital booking
					create the inital housing
					create the Arrest details
					
					After the booking process is complete and the button
					"Send to OffenderTrak" is pushed  Then mp_pb_wrapper_final
					will be called.

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					------------  -------------	------------------------------------------
					J. MCBRATNIE  05/06/06		Created 
					R. Stuve	  06/08/06		Added IF logic for errormsg and errornum
					J. MCBRATNIE  06/15/06      Cleaned up commit logic	corrected small typos
					R. Stuve	  06/19/06		Edited MACOMB.mp_pb_workflow and added associated IF statement
					R. Stuve	  07/17/06		Removed p_entity_type parameter
					R. Stuve	  07/24/06		Eliminated p_action_time (substituted for sysdate)  
					R. Stuve	  08/15/06		Added clear statement and validation check and commit statement 
					R. Stuve	  11/03/06		Removed v_identity_id: not used in pb_inmate procedure
					
*/  	 
v_booking_id    	varchar2(16);  
v_freshArrest   	char(1);
v_errornum			number;
v_errormsg			varchar2(255);
v_matched           varchar2(16);
v_id				varchar2(16);
v_success			varchar2(1);

--check if there is a matchedoffender_id 
CURSOR matched IS
	SELECT	matchedoffender_id
	FROM 	MACOMB.mt_pb_arrestee
	WHERE 	arrest_id = p_arrest_id;	

BEGIN    
 	v_booking_id := EPIC.epic_ids.new_epic_id();
 	--v_identity_id := EPIC.epic_ids.new_epic_id(); 
 	p_errornum := 0; --set the initial value of the variable to zero (implies correct processing unless otherwise changed)
	p_errormsg := null; 
	
	
    --Retrieve matchedoffender_id. If no matchedoffender_id, use the passed in value. Else, use the matchedoffender_id
    OPEN matched;
    FETCH matched INTO v_matched;
    CLOSE matched;
		IF v_matched is not null
			THEN v_id := v_matched;
			ELSE v_id := p_arrest_id;
		END IF;	
	
	/*	   
	BEGIN
		-- is this a fresh arrest???
	    SELECT decode(matchedoffender_id, null, 'N', 'Y') -- -1 is abandoned booking, 0 is new inmate, 1 an existing inmate 
    	INTO v_freshArrest
    	FROM MACOMB.mt_pb_arrestee
    	WHERE arrest_id = p_arrest_id;     
  	EXCEPTION        
  		WHEN  NO_DATA_FOUND
	      then v_freshArrest := 'Y';     --changed from 'N' to 'Y'
 	END;
 */

	MACOMB.mp_PB_inmate_processing(p_arrest_id, EPIC.epicdate(sysdate), p_action_by, /*v_identity_id*/ v_id, v_errornum, v_errormsg);
	IF v_errornum <> 0 THEN
		BEGIN
			p_errormsg := v_errormsg;
			p_errornum := v_errornum;
			RETURN;
		END;
	END IF;
	
	MACOMB.mp_PB_arrest_processing(p_arrest_id, EPIC.epicdate(sysdate), p_action_by, v_booking_id, v_id, v_errornum, v_errormsg);
	IF v_errornum <> 0 THEN
		BEGIN
			p_errormsg := v_errormsg;
			p_errornum := v_errornum;
			RETURN; 
		END;
	END IF;
	     
	MACOMB.mp_PB_booking_processing(p_arrest_id, EPIC.epicdate(sysdate), p_action_by, v_booking_id, v_id, v_errornum, v_errormsg);
	IF v_errornum <> 0 THEN
		BEGIN
		 	p_errormsg := v_errormsg;
			p_errornum := v_errornum;
			RETURN;
		END;
	END IF;
			
	MACOMB.mp_PB_charge_processing(p_arrest_id, EPIC.epicdate(sysdate), p_action_by, v_booking_id, v_errornum, v_errormsg);
	IF v_errornum <> 0 THEN
		BEGIN
			p_errormsg := v_errormsg;
			p_errornum := v_errornum;
			RETURN;
		END;
	END IF;
                                                                               
	MACOMB.mp_PB_property_processing(p_arrest_id, EPIC.epicdate(sysdate), p_action_by, v_id, v_errornum, v_errormsg);
	IF v_errornum <> 0 THEN
		BEGIN
			p_errormsg := v_errormsg;
			p_errornum := v_errornum;
			RETURN;
		END;
	END IF;
			
   --Create workflows  
		MACOMB.mp_pb_workflow(v_id, p_action_by, EPIC.epicdate(sysdate), v_errornum, v_errormsg);
        IF v_errornum <> 0 THEN
			BEGIN
				p_errormsg := v_errormsg;
				p_errornum := v_errornum;
				RETURN; 
			END;
		END IF; 

	IF p_errormsg IS NULL or p_errornum = 0 THEN          
		COMMIT;
	ELSE
		ROLLBACK;
		RETURN;
	END IF;	

	BEGIN
		SELECT	'Y'
		INTO 	v_success
		FROM	EPIC.eh_active_booking
		WHERE	entity_id = v_id; 
		EXCEPTION WHEN NO_DATA_FOUND THEN
			v_success := null;
	END; 
	
	IF v_success is null THEN
		p_errornum := 5;
		p_errormsg := 'Inmate was not inserted into Offendertrak';
		RETURN;
	ELSIF v_success = 'Y' THEN 
		--clear the pb tables of the record
		MACOMB.mp_pb_Clear(p_arrest_id); 
		COMMIT;
	END IF;                      
END;
/

CREATE OR REPLACE
PROCEDURE mp_search_schema
	(pOwner   IN       sys.all_source.name%type default 'EPIC',
	 v_keyword IN       varchar2, 
	 pCur 	    IN OUT   epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Usage: 			Execute macomb.mp_Search_Schema('EPIC','SENTENCE', :dbms_sql
	Crystal: 		
	Purpose:		Query Oracle database by owner and look for keyword

	Author:			Joe McBratnie

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					J. McBratnie	06/06/06		Created   
*/

BEGIN 

  OPEN pCur FOR
select 'CODE' as Source,
       Name, 
       Type, 
	   Line, 
	   Text,
	   1 as Sort_order
from sys.all_source
where owner = pOwner
  AND upper(text) like v_keyword
union
-- locate text in an object (index.....)
Select 'OBJECT' as source,
       Object_name as Name,
       Object_type as Type,
	   null as line,
	   Null as text,
	   2 as sort_order
from SYS.ALL_OBJECTS
WHERE OWNER = pOwner
  AND OBJECT_NAME LIKE v_keyword
union
-- locate a table containing text
SELECT 'TABLE' as source,
       table_name as name,
       'TABLE' as Type,
	   null as line,
	   null as text,
	   3 as sort_order
FROM SYS.ALL_TABLES
WHERE OWNER = pOwner
  AND TABLE_NAME LIKE v_keyword -- OWNER, TABLE_NAME;
union
-- locate a column with text
SELECT  'COLUMN' as Source,
        table_name ||'.' || Column_name as name,
        data_type as type,
	    null as line,
	   	null as text,
		4 as sort_order
FROM SYS.ALL_TAB_COLUMNS
WHERE OWNER = pOwner
  AND COLUMN_NAME LIKE v_keyword
union 
-- triggers looking for text
SELECT 'TRIGGER' as source,
	   trigger_name as name,
       trigger_type as type,
	   null as line,
	   null as text, --to_char(trigger_body) as text
	   5 as sort_order
FROM sys.all_triggers
WHERE table_owner = pOwner
  AND (trigger_name like v_keyword
       or table_name like v_keyword
       or column_name like v_keyword
       or description like v_keyword)
order by sort_order;

END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ADDRESS_phone
	 (	p_arrest_id 			IN 	EPIC.EH_ADDRESS.entity_id%TYPE,
		p_Address_type			IN	EPIC.EH_ADDRESS.ADDRESS_ID%TYPE,
	 	p_DWELLING_NAME			IN	MACOMB.MT_PB_ARRESTEE.RS_DWELLING_NAME%TYPE,
	 	p_FLAT_NO_OR_FLOOR_LEVEL IN MACOMB.MT_PB_ARRESTEE.RS_FLAT_NO_OR_FLOOR_LEVEL%TYPE,
	 	p_STREET_NUMBER			IN  MACOMB.MT_PB_ARRESTEE.RS_STREET_NUMBER%TYPE,
	 	p_STREET_NAME			IN  MACOMB.MT_PB_ARRESTEE.RS_STREET_NAME%TYPE,
	 	p_CITY_TOWN_LOCALE		IN  MACOMB.MT_PB_ARRESTEE.RS_CITY_TOWN_LOCALE%TYPE,
	 	p_STATE_PROVINCE_REGION IN  MACOMB.MT_PB_ARRESTEE.RS_STATE_PROVINCE_REGION%TYPE,
	 	p_POSTAL_CODE			IN  MACOMB.MT_PB_ARRESTEE.RS_POSTAL_CODE%TYPE,
	 	p_CODE_COUNTRY			IN	MACOMB.MT_PB_ARRESTEE.RS_CODE_COUNTRY%TYPE,
	 	p_PHONE_COUNTRY_CODE 	IN	MACOMB.MT_PB_ARRESTEE.RS_PHONE_COUNTRY_CODE%TYPE,
	 	p_PHONE_AREA_CODE		IN  MACOMB.MT_PB_ARRESTEE.RS_PHONE_AREA_CODE%TYPE,
	 	p_PHONE_NUMBER			IN  MACOMB.MT_PB_ARRESTEE.RS_PHONE_NUMBER%TYPE,
	 	p_PHONE_EXTENSION		IN 	MACOMB.MT_PB_ARRESTEE.RS_PHONE_EXTENSION%TYPE,
	 	p_PHONE_TYPE            IN 	MACOMB.MT_PB_ARRESTEE.RS_PHONE_TYPE%TYPE,
	 	p_action_by				IN  EPIC.EH_ADDRESS.action_by%TYPE,
	 	p_address_id			IN  EPIC.EH_ADDRESS.ADDRESS_ID%TYPE DEFAULT null
	 ) 
IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ADDRESS table.  NOTE:  p_arrrest_id = entity_id
					phone number will be added at the same time and the link 
					will be created.

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  

vAddressId char(16);
vLink_Rec_Id char(16);
vLink_Id char(16);
vTelephone_Id char(16);
vPrimaryFlag char(1);
BEGIN 
	-- add the address record         
	IF p_address_id IS NULL THEN
		vAddressId := EPIC.epic_ids.new_epic_id();
	END IF;

	-- what will my address_id before I start the work  I wil need it later also
	IF p_Address_type = 'RESIDENTIAL' THEN
	   -- add and create the link programs
	   	vPrimaryFlag := 'Y';
	ELSE
		vPrimaryFlag := 'N';
	END IF;

	BEGIN
			INSERT INTO EPIC.EH_ADDRESS (ENTITY_ID, ADDRESS_ID, ADDRESS_TYPE, DATE_FROM, 
										FLAT_NO_OR_FLOOR_LEVEL, STREET_NUMBER, STREET_NAME, 
										CITY_TOWN_LOCALE, STATE_PROVINCE_REGION, POSTAL_CODE, 
										CODE_COUNTRY, CODE_ADDR_CONFIRM_MEANS, CODE_ADDR_USAGE, 
										SOURCE_AGENCY, ACTION_TYPE, ACTION_TIME, ACTION_BY, 
										POST_PO_BOX, CREATE_DATE, CONFIRM_BY, CONFIRM_DATE, 
										NO_FIXED_ABODE, PRIMARY_FLAG)
			VALUES (	p_arrest_id,                                 
						(select EPIC.epic_ids.new_epic_id() from dual), p_ADDRESS_TYPE, epic.EPICDATENOW,
						p_FLAT_NO_OR_FLOOR_LEVEL, p_STREET_NUMBER, p_STREET_NAME, 
						p_CITY_TOWN_LOCALE, p_STATE_PROVINCE_REGION, p_POSTAL_CODE, 
						p_CODE_COUNTRY, null,null,
						null,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by,
						null, null, null, null, null,   
						vPrimaryFlag
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		UPDATE EPIC.EH_ADDRESS
			SET ADDRESS_TYPE = p_ADDRESS_TYPE,
				DATE_FROM = epic.EPICDATENOW,
				DATE_TO = null,
				FLAT_NO_OR_FLOOR_LEVEL = p_FLAT_NO_OR_FLOOR_LEVEL,
				STREET_NUMBER = p_STREET_NUMBER,
				STREET_NAME = p_STREET_NAME,
				CITY_TOWN_LOCALE = p_CITY_TOWN_LOCALE,
				STATE_PROVINCE_REGION = p_STATE_PROVINCE_REGION,
				POSTAL_CODE = p_POSTAL_CODE,
				CODE_COUNTRY = p_CODE_COUNTRY,
				CODE_ADDR_CONFIRM_MEANS = NULL, CODE_ADDR_USAGE = NULL,
				SOURCE_AGENCY = null, POST_PO_BOX = NULL, 
				NO_FIXED_ABODE = 'N', 
				PRIMARY_FLAG = vPrimaryFlag, --- look at this one
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
		WHERE entity_id = p_arrest_ID and address_id = p_address_id;
			-- update prim address if needed						
	END;                     
	-- add the associated phone record   
	  -- call 
	  mp_set_EH_TELEPHONE_RECORDS(p_arrest_id, vTelephone_Id, vPrimaryFlag, epic.EPICDATENOW, null, p_PHONE_TYPE, '01', substr(p_PHONE_NUMBER,1,3), substr(p_PHONE_NUMBER,4,7), p_PHONE_EXTENSION, p_ACTION_BY );
	  -- if needed link the number to the address 
	  IF  p_Address_type = 'RESIDENTIAL' THEN
		  mp_set_EH_ADDRESS_PHONE_NUMBER(vAddressId, vTelephone_Id, p_action_by);
	  END IF;

	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ADDRESS_PHONE_NUMBER
	 (	p_address_id 				IN 	EPIC.EH_ADDRESS_PHONE_NUMBER.ADDRESS_ID%TYPE,
	 	p_TELEPHONE_RECORD_ID		IN 	EPIC.EH_ADDRESS_PHONE_NUMBER.TELEPHONE_RECORD_ID%TYPE,
	 	p_action_by					IN  EPIC.EH_ADDRESS_PHONE_NUMBER.action_by%TYPE
	 ) 

IS	
 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ADDRESS_PHONE_NUMBER table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN   
	BEGIN
			INSERT INTO EPIC.EH_ADDRESS_PHONE_NUMBER (TELEPHONE_RECORD_ID, ADDRESS_ID, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_TELEPHONE_RECORD_ID, p_ADDRESS_ID,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
			UPDATE EPIC.EH_ADDRESS_PHONE_NUMBER
			SET ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
		WHERE ADDRESS_ID = p_ADDRESS_ID AND p_TELEPHONE_RECORD_ID = TELEPHONE_RECORD_ID;
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ADDRESS_PHONE_NUMBER
			SET ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE ADDRESS_ID = p_ADDRESS_ID AND p_TELEPHONE_RECORD_ID = TELEPHONE_RECORD_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_CITIZENSHIP
	 (	p_arrest_id 		IN 	EPIC.EH_CITIZENSHIP.entity_id%TYPE,
	 	p_COUNTRY_CODE		IN	EPIC.EH_CITIZENSHIP.COUNTRY_CODE%TYPE,
	 	p_action_by			IN  EPIC.EH_CITIZENSHIP.action_by%TYPE,
	 	p_start_date		IN  EPIC.EH_CITIZENSHIP.start_date%TYPE,
	 	p_end_date          IN  EPIC.EH_CITIZENSHIP.end_date%TYPE,
	 	p_verified_date     IN  EPIC.EH_CITIZENSHIP.date_verified%TYPE,
	 	p_NZ_RESIDENCY_FLAG IN  EPIC.EH_CITIZENSHIP.NZ_RESIDENCY_FLAG%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_CITIZENSHIP table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  
BEGIN 
	BEGIN
			INSERT INTO EPIC.EH_CITIZENSHIP (ENTITY_ID, COUNTRY_CODE, START_DATE, END_DATE, DATE_VERIFIED, NZ_RESIDENCY_FLAG, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_COUNTRY_CODE,
						p_start_date,
						p_end_date,
						p_verified_date,
						p_NZ_RESIDENCY_FLAG,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_CITIZENSHIP
			SET COUNTRY_CODE = p_COUNTRY_CODE,
				START_DATE = p_start_date,
				END_DATE = p_end_date,
				DATE_VERIFIED = p_verified_date,
				NZ_RESIDENCY_FLAG = p_NZ_RESIDENCY_FLAG,
			    ACTION_TIME 	= epic.EPICDATENOW,
		    	ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_CURRENT_LOCATION
	 (	p_arrest_id 					IN 	EPIC.EH_CURRENT_LOCATION.entity_id%TYPE,
	 	p_location_name					IN	MACOMB.MT_PB_ARRESTEE.TEMPHOUSINGLOCATION%TYPE,
	 	p_MOVE_DATE_TIME				IN  EPIC.EH_CURRENT_LOCATION.MOVE_DATE_TIME%TYPE,
	 	p_ACTION_BY						IN  EPIC.EH_CURRENT_LOCATION.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_CURRENT_LOCATION table.  NOTE:  p_arrrest_id = entity_id
					Need to call mp_set_eh_housing_Assignments after this
					p_MOVE_DATE_TIME is the arrest date/time

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/26/06		Created 
*/   
BEGIN  
	BEGIN
			INSERT INTO EPIC.EH_CURRENT_LOCATION (ENTITY_ID, MOVE_DATE_TIME, ACTION_TYPE, ACTION_TIME, ACTION_BY, LOCATION_ID)
			VALUES (	p_arrest_id,
						p_MOVE_DATE_TIME,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by,
						(select mf_location_id(p_location_name) from dual)
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_CURRENT_LOCATION
			SET MOVE_DATE_TIME	= p_MOVE_DATE_TIME,
				LOCATION_ID		= (select mf_location_id(p_location_name) from dual),
		    	ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID ;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_DEPENDENTS
	 (	p_arrest_id 					IN 	EPIC.EH_DEPENDENTS.entity_id%TYPE,
	 	p_DEPENDENTS_ADULT_CUSTODIAL	IN	EPIC.EH_DEPENDENTS.DEPENDENTS_ADULT_CUSTODIAL%TYPE,
	 	p_DEPENDENTS_ADULT_FINANCIAL	IN  EPIC.EH_DEPENDENTS.DEPENDENTS_ADULT_FINANCIAL%TYPE,
	 	p_DEPENDENTS_CHILD_CUSTODIAL	IN  EPIC.EH_DEPENDENTS.DEPENDENTS_CHILD_CUSTODIAL%TYPE,
	 	p_DEPENDENTS_CHILD_FINANCIAL	IN  EPIC.EH_DEPENDENTS.DEPENDENTS_CHILD_FINANCIAL%TYPE, 
	 	p_CHILD_DATES_OF_BIRTH_TEXT		IN  EPIC.EH_DEPENDENTS.CHILD_DATES_OF_BIRTH_TEXT%TYPE, 
	 	p_IRD_LIABLE_PARENT				IN  EPIC.EH_DEPENDENTS.IRD_LIABLE_PARENT%TYPE, 
	 	p_CHILDCARE_AVAILABLE_FLAG		IN  EPIC.EH_DEPENDENTS.CHILDCARE_AVAILABLE_FLAG%TYPE, 
	 	p_ACTION_BY						IN  EPIC.EH_DEPENDENTS.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_DEPENDENTS table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  

BEGIN
	BEGIN
			INSERT INTO EPIC.EH_DEPENDENTS (ENTITY_ID, DEPENDENTS_ADULT_CUSTODIAL, DEPENDENTS_ADULT_FINANCIAL, 
											DEPENDENTS_CHILD_CUSTODIAL, DEPENDENTS_CHILD_FINANCIAL, 
											CHILD_DATES_OF_BIRTH_TEXT, IRD_LIABLE_PARENT, 
											CHILDCARE_AVAILABLE_FLAG, 
											ACTION_BY, ACTION_TIME, ACTION_TYPE)
			VALUES (	p_arrest_id,
						p_DEPENDENTS_ADULT_CUSTODIAL,
						p_DEPENDENTS_ADULT_FINANCIAL,
						p_DEPENDENTS_CHILD_CUSTODIAL,
						p_DEPENDENTS_CHILD_FINANCIAL,
						p_CHILD_DATES_OF_BIRTH_TEXT,
						p_IRD_LIABLE_PARENT,
						p_CHILDCARE_AVAILABLE_FLAG,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_DEPENDENTS
			SET DEPENDENTS_ADULT_CUSTODIAL	= p_DEPENDENTS_ADULT_CUSTODIAL,
				DEPENDENTS_CHILD_FINANCIAL = p_DEPENDENTS_CHILD_FINANCIAL,
				DEPENDENTS_ADULT_FINANCIAL = p_DEPENDENTS_ADULT_FINANCIAL,
				DEPENDENTS_CHILD_CUSTODIAL = p_DEPENDENTS_CHILD_CUSTODIAL,
				CHILD_DATES_OF_BIRTH_TEXT = p_CHILD_DATES_OF_BIRTH_TEXT,
				IRD_LIABLE_PARENT = p_IRD_LIABLE_PARENT,
				CHILDCARE_AVAILABLE_FLAG = p_CHILDCARE_AVAILABLE_FLAG,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID ;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_eh_entity
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_entity_type		IN	EPIC.eh_entity.entity_type%TYPE,
	 	p_action_time		IN	EPIC.eh_entity.action_time%TYPE,
	 	p_action_by			IN  EPIC.eh_entity.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.eh_entity_id table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  	 

BEGIN
	BEGIN
			INSERT INTO EPIC.eh_entity (ENTITY_ID, ENTITY_TYPE, ACTION_TIME, ACTION_BY, ACTION_TYPE)
			VALUES (	p_arrest_id,
						p_entity_type,
						(select epic.EPICDATENOW from dual),
						p_action_by,
						'I');
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.eh_entity
			SET ENTITY_TYPE = p_entity_type,
			    ACTION_TIME = epic.EPICDATENOW,
		    	ACTION_BY   = p_action_by,
			    ACTION_TYPE = 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_GENDER
	 (	p_arrest_id 		IN 	EPIC.eh_entity.entity_id%TYPE,
	 	p_code_gender		IN	EPIC.eh_entity_gender.code_gender%TYPE,
	 	p_arrest_date		IN  EPIC.eh_entity_gender.start_date%TYPE,
	 	p_action_by			IN  EPIC.eh_entity_gender.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_GENDER table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  	 
BEGIN   
	BEGIN
			INSERT INTO EPIC.eh_entity_gender (ENTITY_ID, CODE_GENDER, START_DATE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_code_gender,
						p_arrest_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.eh_entity_gender
			SET CODE_GENDER = p_code_gender,
				START_DATE = p_arrest_date,
		    	ACTION_TIME = epic.EPICDATENOW,
			    ACTION_BY   = p_action_by,
			    ACTION_TYPE = 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_HEIGHT
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_HEIGHT.entity_id%TYPE,
	 	p_height			IN	EPIC.EH_ENTITY_HEIGHT.HEIGHT%TYPE,
	 	p_arrest_date		IN  EPIC.EH_ENTITY_HEIGHT.ASSESSMENT_DATE%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_HEIGHT.action_by%TYPE,
	 	p_height_id			IN  EPIC.EH_ENTITY_HEIGHT.HEIGHT_ID%TYPE  DEFAULT NULL
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_HEIGHT table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  	 
BEGIN  
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_HEIGHT (ENTITY_ID, HEIGHT_ID, HEIGHT, ASSESSMENT_DATE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						(select EPIC.epic_ids.new_epic_id() from dual),
						p_height,
						p_arrest_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_HEIGHT
			SET HEIGHT 			= p_HEIGHT,
				ASSESSMENT_DATE = p_arrest_date,
		    	ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID and HEIGHT_ID = p_height_id;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_HI_EDUCATION
	 (	p_arrest_id 					IN 	EPIC.EH_ENTITY_HI_EDUCATION.entity_id%TYPE,
	 	p_CODE_HIGHEST_GRADE_COMPLETED	IN	EPIC.EH_ENTITY_HI_EDUCATION.CODE_HIGHEST_GRADE_COMPLETED%TYPE,
	 	p_LAST_YEAR						IN  EPIC.EH_ENTITY_HI_EDUCATION.LAST_YEAR%TYPE,
	 	p_ACTION_BY						IN  EPIC.EH_ENTITY_HI_EDUCATION.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_HI_EDUCATION table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/26/06		Created 
*/  
BEGIN  
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_HI_EDUCATION (ENTITY_ID, CODE_HIGHEST_GRADE_COMPLETED, LAST_YEAR, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_HIGHEST_GRADE_COMPLETED,
						p_LAST_YEAR,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_HI_EDUCATION
			SET CODE_HIGHEST_GRADE_COMPLETED	= p_CODE_HIGHEST_GRADE_COMPLETED,
				LAST_YEAR		= p_LAST_YEAR,
		    	ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID ;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_INDIGENT
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_INDIGENT.entity_id%TYPE,
	 	p_indigent_flag		IN	EPIC.EH_ENTITY_INDIGENT.INDIGENT_FLAG%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_INDIGENT.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_INDIGENT table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_INDIGENT (ENTITY_ID, INDIGENT_FLAG, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_indigent_flag,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_INDIGENT
			SET INDIGENT_FLAG= p_indigent_flag,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_RACE
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_RACE.entity_id%TYPE,
	 	p_CODE_RACE		IN	EPIC.EH_ENTITY_RACE.CODE_RACE%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_RACE.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_RACE table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   

BEGIN   
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_RACE (ENTITY_ID, CODE_RACE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_RACE,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_RACE
			SET CODE_RACE= p_CODE_RACE,
			    ACTION_TIME 	= epic.EPICDATENOW,
		    	ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_RELIGION
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_RELIGION.entity_id%TYPE,
	 	p_CODE_RELIGION		IN	EPIC.EH_ENTITY_RELIGION.CODE_RELIGION%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_RELIGION.action_by%TYPE,
	 	p_start_date		IN  EPIC.EH_ENTITY_RELIGION.start_date%type,
	 	p_end_date			IN 	EPIC.EH_ENTITY_RELIGION.end_date%type DEFAULT NULL
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_RELIGION table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   

BEGIN   
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_RELIGION (ENTITY_ID, CODE_RELIGION,START_DATE, END_DATE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_RELIGION,
						p_start_date,
						p_end_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_RELIGION
			SET CODE_RELIGION= p_CODE_RELIGION,
				START_DATE = p_start_date,
				END_DATE = p_end_date,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_ROLES
	 (	p_arrest_id 			IN 	EPIC.EH_ENTITY_ROLES.entity_id%TYPE,
	 	p_CODE_ENTITY_ROLE		IN	EPIC.EH_ENTITY_ROLES.CODE_ENTITY_ROLE%TYPE,
	 	p_EFFECTIVE_FROM		IN  EPIC.EH_ENTITY_ROLES.EFFECTIVE_FROM%TYPE ,
	 	p_action_by				IN  EPIC.EH_ENTITY_ROLES.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_ROLES table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN 
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_ROLES (ENTITY_ID, CODE_ENTITY_ROLE, EFFECTIVE_FROM, EFFECTIVE_TO, 
												ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_ENTITY_ROLE,
						p_EFFECTIVE_FROM,
						null,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_ROLES
			SET CODE_ENTITY_ROLE = p_CODE_ENTITY_ROLE,
				EFFECTIVE_FROM = p_EFFECTIVE_FROM,
				EFFECTIVE_TO = null,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_STATUS
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_STATUS.entity_id%TYPE,
	 	p_CODE_ENTITY_STATUS	IN	EPIC.EH_ENTITY_STATUS.CODE_ENTITY_STATUS%TYPE,
	 	p_arrest_date		IN  EPIC.EH_ENTITY_STATUS.action_time%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_STATUS.action_by%TYPE,
	 	p_CODE_CUSTODY_STATUS	IN  EPIC.EH_ENTITY_STATUS.CODE_CUSTODY_STATUS%TYPE  DEFAULT NULL
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_STATUS table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  

BEGIN     
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_STATUS (ENTITY_ID, CODE_ENTITY_STATUS, CODE_CUSTODY_STATUS, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_ENTITY_STATUS,
						p_CODE_CUSTODY_STATUS,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_STATUS
			SET CODE_ENTITY_STATUS	= p_CODE_ENTITY_STATUS,
				CODE_CUSTODY_STATUS = p_CODE_CUSTODY_STATUS,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID ;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_WEIGHT
	 (	p_arrest_id 		IN 	EPIC.EH_ENTITY_WEIGHT.entity_id%TYPE,
	 	p_WEIGHT			IN	EPIC.EH_ENTITY_WEIGHT.WEIGHT%TYPE,
	 	p_arrest_date		IN  EPIC.EH_ENTITY_WEIGHT.ASSESSMENT_DATE%TYPE,
	 	p_action_by			IN  EPIC.EH_ENTITY_WEIGHT.action_by%TYPE,
	 	p_WEIGHT_id			IN  EPIC.EH_ENTITY_WEIGHT.WEIGHT_ID%TYPE  DEFAULT NULL
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_WEIGHT table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  	 
BEGIN   
	BEGIN
			INSERT INTO EPIC.EH_ENTITY_WEIGHT (ENTITY_ID, WEIGHT_ID, WEIGHT, ASSESSMENT_DATE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						(select EPIC.epic_ids.new_epic_id() from dual),
						p_WEIGHT,
						p_arrest_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ENTITY_WEIGHT
			SET WEIGHT 			= p_WEIGHT,
				ASSESSMENT_DATE = p_arrest_date,
		    	ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID and WEIGHT_ID = p_WEIGHT_id;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ENTITY_WORK_SKILLS
	 (	p_arrest_id 					IN 	EPIC.EH_ENTITY_WORK_SKILLS.entity_id%TYPE,
	 	p_ENGLISHSPOKEN					IN	MACOMB.MT_PB_ARRESTEE.ENGLISHSPOKEN%TYPE,
	 	p_ENGLISHREAD             		IN	MACOMB.MT_PB_ARRESTEE.ENGLISHREAD%TYPE,
	 	P_ENGLISHWRITTEN				IN	MACOMB.MT_PB_ARRESTEE.ENGLISHWRITTEN%TYPE,
	 	p_ACTION_BY						IN  EPIC.EH_ENTITY_WORK_SKILLS.action_by%TYPE,
	 	p_WORK_SKILLS_ID				IN 	EPIC.EH_ENTITY_WORK_SKILLS.WORK_SKILLS_ID%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ENTITY_WORK_SKILLS table.  NOTE:  p_arrrest_id = entity_id
					Need to call mp_set_EH_ENTITY_WORK_SKILLS after this

					select * from MACOMB.MT_PB_LANGUAGE --, 
					Matrix for EPIC.ENTITY_WORK_SKILLS
					lookupcode			OTHERLANGUAGESPOKEN, OTHERLANGUAGEREAD, OTHERLANGUAGEWRITTEN
					BILINGUAL			Y						Y				Y
					CANNOT READ/WRITE	Y						N				N
					CANREAD				Y						Y				N
					CANWRITE			Y                       N  				Y
					READ/WRITE			N						Y				Y
					READS ONLY          N                       Y				N
					WRITES ONLY         N   					N  				Y


	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/26/06		Created 
*/   
v_process char(1);
v_skill_code varchar2(32);
BEGIN 
	v_process := 'Y';
	-- First figure out the code_skill
	IF  (p_ENGLISHSPOKEN = 'Y' and p_ENGLISHREAD = 'Y' and P_ENGLISHWRITTEN = 'N') THEN
		-- locate the skill called 'CANREAD'
		v_skill_code := 'CANREAD';
	ELSIF (p_ENGLISHSPOKEN = 'Y' and p_ENGLISHREAD = 'N' and P_ENGLISHWRITTEN = 'Y') THEN
		-- locate the skill called 'CANWRITE'
		v_skill_code := 'CANWRITE';
	ELSIF (p_ENGLISHSPOKEN = 'N' and p_ENGLISHREAD = 'Y' and P_ENGLISHWRITTEN = 'Y') THEN
		-- locate the skill called 'READ/WRITE'
		v_skill_code := 'READ/WRITE';
	ELSIF (p_ENGLISHSPOKEN = 'N' and p_ENGLISHREAD = 'Y' and P_ENGLISHWRITTEN = 'N') THEN
		-- locate the skill called 'READS ONLY'
		v_skill_code := 'READS ONLY';
	ELSIF (p_ENGLISHSPOKEN = 'N' and p_ENGLISHREAD = 'N' and P_ENGLISHWRITTEN = 'Y') THEN
		-- locate the skill called 'WRITES ONLY'
		v_skill_code := 'WRITES ONLY';
	ELSE
		v_process := 'N';            
		v_skill_code := '';
	END IF;
	
	IF v_process = 'Y' then			
		-- update the work skills table
		BEGIN
			UPDATE EPIC.EH_ENTITY_WORK_SKILLS
				SET CODE_SKILL		= v_skill_code,
			    	ACTION_TIME 	= epic.EPICDATENOW,
				    ACTION_BY   	= p_action_by,
			    	ACTION_TYPE 	= 'U'
				 where WORK_SKILLS_ID = p_WORK_SKILLS_ID AND entity_id = p_arrest_ID;
		EXCEPTION 
			WHEN NO_DATA_FOUND THEN
				INSERT INTO EPIC.EH_ENTITY_WORK_SKILLS (WORK_SKILLS_ID, ENTITY_ID, CODE_SKILL, ACTION_TYPE, ACTION_TIME, ACTION_BY )
				VALUES (	(select EPIC.epic_ids.new_epic_id() from dual), --new workskill_id
							p_arrest_id,
							v_skill_code,
							'I',
							(select epic.EPICDATENOW from dual),
							p_action_by
							);
		END;
		COMMIT;
	END IF;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_ETHNICITY
	 (	p_arrest_id 			IN 	EPIC.EH_ETHNICITY.entity_id%TYPE,
	 	p_CODE_ETHNICITY		IN	EPIC.EH_ETHNICITY.CODE_ETHNICITY%TYPE,
	 	p_ORDER_OF_PREFERENCE	IN 	EPIC.EH_ETHNICITY.ORDER_OF_PREFERENCE%TYPE DEFAULT 1,
	 	p_arrest_date			IN 	EPIC.EH_ETHNICITY.DATE_RECORDED%TYPE,
	 	p_action_by				IN  EPIC.EH_ETHNICITY.action_by%TYPE,
	 	p_ETHNICITY_ID			IN  EPIC.EH_ETHNICITY.ETHNICITY_ID%TYPE DEFAULT NULL
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_ETHNICITY table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN
	BEGIN
			INSERT INTO EPIC.EH_ETHNICITY (ENTITY_ID, ETHNICITY_ID, CODE_ETHNICITY, ORDER_OF_PREFERENCE, 
											DATE_RECORDED, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						(select EPIC.epic_ids.new_epic_id() from dual),
						p_CODE_ETHNICITY,
						p_ORDER_OF_PREFERENCE,
						p_arrest_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_ETHNICITY
			SET CODE_ETHNICITY = p_CODE_ETHNICITY,
				ORDER_OF_PREFERENCE = p_ORDER_OF_PREFERENCE,
				DATE_RECORDED		= p_arrest_date,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID and ETHNICITY_ID = p_ETHNICITY_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_HOUSING_ASSIGNMENTS
	 (	p_arrest_id 					IN 	EPIC.EH_HOUSING_ASSIGNMENTS.entity_id%TYPE,
	 	p_code_allocation_reason		IN	MACOMB.MT_PB_ARRESTEE.TEMPHOUSINGLOCATION%TYPE,
	 	p_location_name                 IN	MACOMB.MT_PB_ARRESTEE.TEMPHOUSINGLOCATION%TYPE,
	 	p_ACTION_BY						IN  EPIC.EH_HOUSING_ASSIGNMENTS.action_by%TYPE,
	 	p_temp_location_flag			IN 	EPIC.EH_HOUSING_ASSIGNMENTS.TEMPORARY_LOCATION_FLAG%TYPE DEFAULT 'Y',
	 	p_muster_display_flag			IN  EPIC.EH_HOUSING_ASSIGNMENTS.MUSTER_DISPLAY_FLAG%TYPE DEFAULT 'N'
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_HOUSING_ASSIGNMENTS table.  NOTE:  p_arrrest_id = entity_id
					Need to call mp_set_eh_housing_Assignments after this
					p_MOVE_DATE_TIME is the arrest date/time

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/26/06		Created 
*/  
BEGIN  
	BEGIN
			INSERT INTO EPIC.EH_HOUSING_ASSIGNMENTS (ENTITY_ID, CODE_ALLOCATION_REASON, LOCATION_ID, 
			                                         TEMPORARY_LOCATION_FLAG, MUSTER_DISPLAY_FLAG, 
			                                         ACTION_TYPE, ACTION_TIME, ACTION_BY )
			VALUES (	p_arrest_id,
						p_code_allocation_reason,
						(select mf_location_id(p_location_name) from dual),
						p_temp_location_flag,
						p_muster_display_flag,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_HOUSING_ASSIGNMENTS
			SET code_allocation_reason	= p_code_allocation_reason,
				LOCATION_ID		= (select mf_location_id(p_location_name) from dual),
		    	ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U',
			    TEMPORARY_LOCATION_FLAG = p_temp_location_flag,
		    	MUSTER_DISPLAY_FLAG     = p_muster_display_flag  
	 		WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_MARITAL_STATUS
	 (	p_arrest_id 		IN 	EPIC.EH_MARITAL_STATUS.entity_id%TYPE,
	 	p_CODE_MARITAL_STATUS	IN	EPIC.EH_MARITAL_STATUS.CODE_MARITAL_STATUS%TYPE,
	 	p_action_by			IN  EPIC.EH_MARITAL_STATUS.action_by%TYPE,
	 	p_start_date		IN  EPIC.EH_MARITAL_STATUS.start_date%TYPE,
	 	p_end_date          IN  EPIC.EH_MARITAL_STATUS.end_date%TYPE,
	 	p_verified_date     IN  EPIC.EH_MARITAL_STATUS.verified_date%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_MARITAL_STATUS table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN  
	BEGIN
			INSERT INTO EPIC.EH_MARITAL_STATUS (ENTITY_ID, CODE_MARITAL_STATUS, START_DATE, END_DATE, VERIFIED_DATE, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_CODE_MARITAL_STATUS,
						p_start_date,
						p_end_date,
						p_verified_date,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_MARITAL_STATUS
			SET CODE_MARITAL_STATUS = p_CODE_MARITAL_STATUS,
				START_DATE = p_start_date,
				END_DATE = p_end_date,
				VERIFIED_DATE = p_verified_date,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
		    	ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_OFFENDER_IDS
	 (	p_arrest_id 		IN 	EPIC.EH_OFFENDER_IDS.entity_id%TYPE,
	 	p_STATE_ID			IN	EPIC.EH_OFFENDER_IDS.STATE_ID%TYPE,
	 	p_FBI_ID			IN  EPIC.EH_OFFENDER_IDS.FBI_ID%TYPE,
	 	p_ACTION_BY    		IN  EPIC.EH_OFFENDER_IDS.ACTION_BY%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_OFFENDER_IDS table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  

v_offender_id varchar2(12);

BEGIN     
	EPIC.epp_autoid.generate_auto_id('OFFENDER_ID', p_arrest_id, v_offender_id);
	BEGIN
			INSERT INTO EPIC.EH_OFFENDER_IDS (ENTITY_ID, STATE_ID, FBI_ID, OFFENDER_ID, ACTION_BY, ACTION_TYPE, ACTION_TIME)
			VALUES (	p_arrest_id,
						p_STATE_ID,
						p_FBI_ID,
						v_offender_id,   -- how this????,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_OFFENDER_IDS
			SET STATE_ID 		= p_STATE_ID,
				FBI_ID	 		= p_FBI_ID,
				--OFFENDER_ID 	= --p_OFFENDER_ID,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_OPERATORS_LICENSE
	 (	p_arrest_id 				IN 	EPIC.EH_OPERATORS_LICENSE.ENTITY_ID%TYPE,
	 	p_OPERATOR_LICENSE_ID		IN 	EPIC.EH_OPERATORS_LICENSE.OPERATOR_LICENSE_ID%TYPE,
	 	p_IDENTITY_ID				IN 	EPIC.EH_OPERATORS_LICENSE.IDENTITY_ID%TYPE,
	 	p_PRIMARY_DL				IN 	EPIC.EH_OPERATORS_LICENSE.PRIMARY_DL%TYPE,
	 	p_DRIVERS_LICENSE_NUMBER	IN 	EPIC.EH_OPERATORS_LICENSE.DRIVERS_LICENSE_NUMBER%TYPE,
	 	p_ISSUE_DATE				IN 	EPIC.EH_OPERATORS_LICENSE.ISSUE_DATE%TYPE,
	 	p_EXPIRATION_DATE			IN 	EPIC.EH_OPERATORS_LICENSE.EXPIRATION_DATE%TYPE,
	 	p_STATE						IN 	EPIC.EH_OPERATORS_LICENSE.STATE%TYPE,
	 	p_COUNTRY					IN 	EPIC.EH_OPERATORS_LICENSE.COUNTRY%TYPE,
	 	p_action_by					IN  EPIC.EH_OPERATORS_LICENSE.action_by%TYPE
	 ) 

IS	
 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_OPERATORS_LICENSE table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/  
 vOPERATOR_LICENSE_ID varchar2(16);
BEGIN   
	BEGIN
			-- 		OPERATOR_LICENSE_ID  
			vOPERATOR_LICENSE_ID := EPIC.epic_ids.new_epic_id();
			INSERT INTO EPIC.EH_OPERATORS_LICENSE ( OPERATOR_LICENSE_ID, ENTITY_ID, IDENTITY_ID, PRIMARY_DL, 
													DRIVERS_LICENSE_NUMBER, ISSUE_DATE, EXPIRATION_DATE, STATE, COUNTRY, 
													ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	 p_OPERATOR_LICENSE_ID, p_arrest_ID, p_IDENTITY_ID, p_PRIMARY_DL, 
						 p_DRIVERS_LICENSE_NUMBER, p_ISSUE_DATE, p_EXPIRATION_DATE, p_STATE, p_COUNTRY, 
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_OPERATORS_LICENSE
			SET IDENTITY_ID     = p_IDENTITY_ID,
				PRIMARY_DL      = p_PRIMARY_DL, 
				DRIVERS_LICENSE_NUMBER = p_DRIVERS_LICENSE_NUMBER,
				ISSUE_DATE = p_ISSUE_DATE,
				EXPIRATION_DATE = p_EXPIRATION_DATE,
				STATE = p_STATE,
				COUNTRY = p_COUNTRY,
				ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_ID = p_arrest_ID AND p_OPERATOR_LICENSE_ID = OPERATOR_LICENSE_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_PERSON_SNAPSHOT
	 (	p_arrest_id 		IN 	EPIC.EH_PERSON_SNAPSHOT.entity_id%TYPE,
	 	p_arrestdate		IN	EPIC.EH_PERSON_SNAPSHOT.DATE_SNAPSHOT%TYPE,
	 	p_CODE_HAIR_COLOR	IN  EPIC.EH_PERSON_SNAPSHOT.CODE_HAIR_COLOR%TYPE ,
	 	p_CODE_COMPLEXION	IN EPIC.EH_PERSON_SNAPSHOT.CODE_COMPLEXION%TYPE, 
	 	p_action_by			IN  EPIC.EH_PERSON_SNAPSHOT.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_PERSON_SNAPSHOT table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN
	BEGIN
			INSERT INTO EPIC.EH_PERSON_SNAPSHOT (ENTITY_ID, DATE_SNAPSHOT, CODE_HAIR_COLOR, CODE_COMPLEXION, ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_arrest_id,
						p_arrestdate,
						p_CODE_HAIR_COLOR,
						p_CODE_COMPLEXION,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_PERSON_SNAPSHOT
			SET DATE_SNAPSHOT = p_arrestdate,
				CODE_HAIR_COLOR = p_CODE_HAIR_COLOR,
				CODE_COMPLEXION = p_CODE_COMPLEXION,
			    ACTION_TIME 	= epic.EPICDATENOW,
		    	ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_TELEPHONE_RECORDS
	 (	p_arrest_id 				IN 	EPIC.EH_TELEPHONE_RECORDS.entity_id%TYPE,
	 	p_TELEPHONE_RECORD_ID	IN OUT	EPIC.EH_TELEPHONE_RECORDS.TELEPHONE_RECORD_ID%TYPE,
	 	p_PRIMARY_FLAG				IN	EPIC.EH_TELEPHONE_RECORDS.PRIMARY_FLAG%TYPE,
	 	p_DATE_FROM					IN	EPIC.EH_TELEPHONE_RECORDS.DATE_FROM%TYPE,
	 	p_DATE_TO					IN	EPIC.EH_TELEPHONE_RECORDS.DATE_TO%TYPE,
	 	p_CODE_PHONE_NUMBER_TYPE	IN	EPIC.EH_TELEPHONE_RECORDS.CODE_PHONE_NUMBER_TYPE%TYPE,
	 	p_CODE_COUNTRY				IN	EPIC.EH_TELEPHONE_RECORDS.CODE_COUNTRY%TYPE,
	 	p_AREA_CODE					IN	EPIC.EH_TELEPHONE_RECORDS.AREA_CODE%TYPE,
	 	p_BASE_NUMBER				IN	EPIC.EH_TELEPHONE_RECORDS.BASE_NUMBER%TYPE,
	 	p_EXTENSION					IN	EPIC.EH_TELEPHONE_RECORDS.EXTENSION%TYPE,
	 	p_action_by					IN  EPIC.EH_TELEPHONE_RECORDS.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_TELEPHONE_RECORDS table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   

BEGIN   
	BEGIN
			p_TELEPHONE_RECORD_ID := EPIC.epic_ids.new_epic_id();
			INSERT INTO EPIC.EH_TELEPHONE_RECORDS (TELEPHONE_RECORD_ID, ENTITY_ID, 
													PRIMARY_FLAG, 
													DATE_FROM, DATE_TO, CODE_PHONE_NUMBER_TYPE, 
													CODE_COUNTRY, AREA_CODE, BASE_NUMBER, EXTENSION, 
													ACTION_TYPE, ACTION_TIME, ACTION_BY)
			VALUES (	p_TELEPHONE_RECORD_ID, p_arrest_id,
			            p_PRIMARY_FLAG,
			            p_DATE_FROM, p_DATE_TO, p_CODE_PHONE_NUMBER_TYPE,
						p_CODE_COUNTRY, p_AREA_CODE, p_BASE_NUMBER, p_EXTENSION,
						'I',
						(select epic.EPICDATENOW from dual),
						p_action_by
						);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_TELEPHONE_RECORDS
			SET PRIMARY_FLAG= p_PRIMARY_FLAG,
				DATE_FROM = p_DATE_FROM,
				DATE_TO = p_DATE_TO, 
				CODE_PHONE_NUMBER_TYPE = p_CODE_PHONE_NUMBER_TYPE,
				CODE_COUNTRY = p_CODE_COUNTRY,
				AREA_CODE = p_AREA_CODE,
				BASE_NUMBER = p_BASE_NUMBER,
				EXTENSION = p_EXTENSION,
			    ACTION_TIME 	= epic.EPICDATENOW,
			    ACTION_BY   	= p_action_by,
			    ACTION_TYPE 	= 'U'
			WHERE entity_id = p_arrest_ID AND p_TELEPHONE_RECORD_ID = TELEPHONE_RECORD_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        mp_set_EH_VEHICLE
	 (	p_arrest_id 		IN 	EPIC.EH_VEHICLE.entity_id%TYPE,
	 	p_TOW_COMPANY_ID	IN	EPIC.EH_VEHICLE.TOW_COMPANY_ID%TYPE,
	 	p_CODE_STORAGE		IN  EPIC.EH_VEHICLE.CODE_STORAGE%TYPE DEFAULT 'TOW CO	',
	 	p_LOCATION_OF_VEHICLE IN EPIC.EH_VEHICLE.LOCATION_OF_VEHICLE%TYPE, 
	 	p_action_by			IN  EPIC.EH_VEHICLE.action_by%TYPE
	 ) 

IS	 
 /*	
	Purpose:		Macomb Pre booking - To save the data assocaited with 
					epic.EH_VEHICLE table.  NOTE:  p_arrrest_id = entity_id

	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. MCBRATNIE  03/25/06		Created 
*/   
BEGIN 
	BEGIN
		INSERT INTO EPIC.EH_VEHICLE (VEHICLE_ID, ENTITY_ID, TOW_COMPANY_ID, CODE_STORAGE, LOCATION_OF_VEHICLE, ACTION_TYPE, ACTION_TIME, ACTION_BY, CODE_COUNTRY)
		VALUES 	(	(select EPIC.epic_ids.new_epic_id() from DUAL),
					p_arrest_id,
					p_tow_company_id,
					p_code_storage,
					p_location_of_vehicle,
					'I',
					(select epic.EPICDATENOW from dual),
					p_action_by,
					'US'
				);
	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
			UPDATE EPIC.EH_VEHICLE
				SET VEHICLE_ID = (select EPIC.epic_ids.new_epic_id() from DUAL),
					TOW_COMPANY_ID = p_TOW_COMPANY_ID,
					CODE_STORAGE = p_CODE_STORAGE,
					LOCATION_OF_VEHICLE = p_LOCATION_OF_VEHICLE,
				    ACTION_TIME 	= epic.EPICDATENOW,
				    ACTION_BY   	= p_action_by,
			    	ACTION_TYPE 	= 'U',
				    CODE_COUNTRY    = 'US'
			WHERE entity_id = p_arrest_ID;
	END;
	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MP_Set_MT_PB_ARRESTEE
 (p_entity_id        in            epic.eh_entity_person.entity_id%type)

IS
/*	
	Purpose:		Update Web Mt_PB_Arrestee Table with OT data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/09/06		Created
*/
BEGIN    
	BEGIN  	
			UPDATE MACOMB.MT_PB_ARRESTEE
			set (lastname, firstname, middlename,
				name_title, name_suffix,
				offender_id, state_id,
				fbi_id, ssn, rs_address_id,
				rs_dwelling_name, rs_flat_no_or_floor_level, rs_street_number, rs_street_name,
				rs_city_town_locale, rs_state_province_region, rs_postal_code, rs_code_country,
				rs_phone_id,
				rs_phone_country_code, rs_phone_area_code,
				rs_phone_number, rs_phone_extension, rs_phone_type,
				cl_phone_id,
				cl_phone_country_code, cl_phone_area_code,
				cl_phone_number, cl_phone_extension, cl_phone_type,
				dob, height,
				weight, race,
				gender, eyeright,
				eyeleft, hair,
				complexion,	maritalstatus,
				birthcity, birthstate,
				birthcountry, religiouspref,
				dl_id,
				dlnumber, dlstate,
				dlexpire,
				englishspoken,
				englishread,
				englishwritten,
				educationlevel, employement_id,
				occupation,
				employername,
				em_address_id,
				em_dwelling_name, em_flat_no_or_floor_level,
				em_street_number, em_street_name,
				em_city_town_locale, em_state_province_region,
				em_postal_code, em_code_country, 
				em_phone_id,
				em_phone_country_code, em_phone_area_code,
				em_phone_number, em_phone_extension, em_phone_type,
				ec_person_id,
				emergencycontact, 
				ec_phone_id,
				ec_phone_country_code,
				ec_phone_area_code, ec_phone_number,
				ec_phone_extension, ec_phone_type,
				emergencyrelationship
				) =
				(select	name_family, name_first, name_other,
				        EPIC.ef_lookup_text('TITLE', pi.NAME_TITLE, 'UC'), name_suffix,
						EPIC.ef_offender_id(p_entity_id),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'SID NUMBER'),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'FBI TRACKING'),
   						EPIC.ef_offender_SSN(p_entity_id),
			            address_id,dwelling_name, flat_no_or_floor_level, street_number,street_name,
			            city_town_locale, state_province_region, postal_code, code_country,
			            MACOMB.MF_Ph_ID(p_entity_id, 'HOME'),
			            MACOMB.MF_PhCountry(p_entity_id, 'HOME'), MACOMB.MF_PhArea(p_entity_id, 'HOME'),
			            MACOMB.MF_PhNumber(p_entity_id, 'HOME'), MACOMB.MF_PhExtension(p_entity_id, 'HOME'), 'HOME',
			            MACOMB.MF_Ph_ID(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhCountry(p_entity_id, 'MOBILE'), MACOMB.MF_PhArea(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhNumber(p_entity_id, 'MOBILE'), MACOMB.MF_PhExtension(p_entity_id, 'MOBILE'), 'MOBILE',
			            EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),EPIC.ef_offender_height(p_entity_id),
			            EPIC.ef_Offender_Weight(p_entity_id), MACOMB.mf_ef_offender_race(p_entity_id),
			            EPIC.ef_offender_person_gender(p_entity_id),MACOMB.mf_eyecolorright_code(p_entity_id),
			            MACOMB.mf_eyecolorleft_code(p_entity_id),MACOMB.mf_hair_code(p_entity_id),
			            MACOMB.mf_complexion_code(p_entity_id), EPIC.ef_marital_status(p_entity_id),
			            MACOMB.mcmb_fnt_birthcity(p_entity_id), MACOMB.mcmb_fnt_birthstate(p_entity_id),
			            MACOMB.mf_birthcountry_code(p_entity_id),EPIC.ef_offender_religion(p_entity_id),
			            MACOMB.mf_primary_dlicno_ID(p_entity_id),
			            EPIC.ef_primary_dlicno(EPIC.ef_identity_id(p_entity_id)),  -- primary drivers license & info
			            MACOMB.mf_primary_dlicno_state(p_entity_id),
			            MACOMB.mf_primary_dlicno_expire(p_entity_id),
			            MACOMB.mf_ef_get_Primary_Lang_code(p_entity_id),
			            MACOMB.mf_CanReadYN(p_entity_id),
			            MACOMB.mf_CanWriteYN(p_entity_id),
			            MACOMB.mf_highest_education(p_entity_id), MACOMB.mf_Employment_ID(p_entity_id),
			            MACOMB.mf_Occupation(p_entity_id),
                        MACOMB.mf_EmployerName(p_entity_id),
                        MACOMB.MF_EmpAdr_ID_by_entid(p_entity_id),
                        MACOMB.mf_EmpAdrDwelling_by_entid(p_entity_id), MACOMB.MF_EmpAdrFlatno_floor_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrstreetnmbr_by_entid(p_entity_id), MACOMB.MF_EmpAdrstreetname_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrcity_town_by_entid(p_entity_id),MACOMB.MF_EmpAdrstate_prov_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrPostal_by_entid (p_entity_id), MACOMB.MF_EmpAdrCountry_by_entid (p_entity_id),
                        MACOMB.MF_EmpPh_ID_by_entid(p_entity_id, 'WORK'),
                        MACOMB.MF_EmpPhCountry_by_entid(p_entity_id, 'WORK'), MACOMB.MF_EmpPhArea_by_entid(p_entity_id, 'WORK'),
                        MACOMB.MF_EmpPhNmbr_by_entid(p_entity_id, 'WORK'), MACOMB.MF_EmpPhExt_by_entid(p_entity_id, 'WORK'),'WORK',
                        MACOMB.MF_EC_Contact_ID(p_entity_id),
                        MACOMB.MF_EC_Contact(p_entity_id),
                        MACOMB.MF_EC_Ph_ID(p_entity_id), 
                        MACOMB.MF_EC_Country(p_entity_id),
						MACOMB.MF_EC_Area(p_entity_id), 
						MACOMB.MF_EC_PhNumber(p_entity_id),
						MACOMB.MF_EC_Extension(p_entity_id), MACOMB.MF_EC_PhType(p_entity_id),
						MACOMB.MF_EC_Relation_code(p_entity_id)

					from	EPIC.eh_person_identity pi, EPIC.eh_entity_person ep, EPIC.eh_address a--,

					where	EPIC.ep.entity_id =  p_entity_id   -- matchedoffender_id
					        and	EPIC.pi.identity_id = EPIC.ep.primary_identity_id
	                        and EPIC.a.address_id = EPIC.ef_get_primary_address_id(p_entity_id)
	                )  

		where MACOMB.mt_pb_arrestee.matchedoffender_id = p_entity_id; 
	
	IF SQL%NOTFOUND THEN
		RAISE_APPLICATION_ERROR(-20314, 'Arrestee Matched Offender Id not found');
		END IF;  							
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE mp_set_mt_pb_keep_separate
	(p_Arrest_Id	in	mt_pb_keep_separate.Keep_separate_id%type)
IS
/*	
	Purpose:		Update Web Mt_PB_keep_separate Table with OT data, so it can be pulled back into
	                web app for inmates found           
	                
	                NOTE:  Mary Ann - I think we need to store the location_id (varchar2)
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created
*/
BEGIN
	BEGIN
		INSERT into MACOMB.MT_PB_KEEP_SEPARATE
   		(SELECT	
   				ks.keep_separate_id,
				--p_Arrest_Id,
				--EPIC.ef_offender_id(ks.origin_entity_id),
				EPIC.ef_offender_id(ks.origin_entity_id),
			    EPIC.ef_offender_id(ks.separate_entity_id),
		   		EPIC.ef_offender_cell(ks.origin_entity_id) 

		FROM	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
	  			EPIC.eh_keep_separate ks

		WHERE	bk.booking_id = ab.booking_id
	    		and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    		and bk.entity_id = MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
	    		and not ks.origin_entity_id = MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 

		UNION ALL
		
 		SELECT	
 				ks.keep_separate_id,
				--p_Arrest_Id,
 				--EPIC.ef_offender_id(ks.separate_entity_id),
 				EPIC.ef_offender_id(ks.origin_entity_id),
			    EPIC.ef_offender_id(ks.separate_entity_id),
				EPIC.ef_offender_cell(ks.separate_entity_id) 

		FROM	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
	  			EPIC.eh_keep_separate ks

		WHERE	bk.booking_id = ab.booking_id
				and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    		and bk.entity_id = MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
	    		and not ks.separate_entity_id = MACOMB.mf_Arrestee_EntityID(p_Arrest_id)
		);
		
		EXCEPTION
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20920, 'Keep Separate Record(s) already exist');  	
	END;  

	COMMIT;
END;		
/

CREATE OR REPLACE
PROCEDURE MP_Set_MT_PB_LANGUAGE
 (p_Arrest_id        in            MACOMB.mt_pb_language.arrest_id%type)

IS
/*	
	Purpose:		Insert Web Mt_PB_Person_Language Table with OT data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created 
*/
					
BEGIN    
	BEGIN 				
		INSERT into MACOMB.MT_PB_LANGUAGE
			(SELECT
				el.language_id,
	       		p_Arrest_id,
	       		el.code_language
				
		FROM 	EPIC.eh_language el

   		WHERE	el.entity_id =  MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
     	      
	 		);

	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20122, 'Language Record(s) already exist');  	
	END;  

	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MP_Set_MT_PB_PERSON_ALIAS
 (p_Arrest_id        in            MACOMB.mt_pb_person_alias.arrest_id%type)

IS
/*	
	Purpose:		Insert Web Mt_PB_Person_Alias Table with OT Alias data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/10/06		Created   
					**This is NOT the procedure called in the set_wrapper**
*/
					
BEGIN    
	BEGIN 				
		INSERT into MACOMB.MT_PB_PERSON_ALIAS
			(SELECT
				pi.identity_id,
	       		p_Arrest_id,
				pi.name_family,
				pi.name_first,
				pi.code_name_type,
				'Y',
				DATE_OF_BIRTH,
				SOCIAL_SECURITY_NUMBER

		FROM 	EPIC.eh_person_identity pi

   		WHERE	pi.entity_id =  MACOMB.mf_Arrestee_EntityID(p_Arrest_id) 
     	      	and pi.code_name_type != 'MAS'
	 		);

	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20506, 'Alias Record(s) already exist');  	
	END;  

	COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE        MP_SET_PRESTEE
 (p_entity_id        in            epic.eh_entity_person.entity_id%type)

IS
/*	
	Purpose:		Update Web Mt_PB_Arrestee Table with OT data, so it can be pulled back into
	                web app for inmates found
					
	Author:			Mary Ann Zak

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					M Zak        05/09/06		Created
*/
BEGIN    
	BEGIN  	
			UPDATE MACOMB.MT_PB_ARRESTEE
			set (lastname, firstname, middlename,
				name_title, name_suffix,
				offender_id, state_id,
				fbi_id, ssn, rs_address_id,
				rs_dwelling_name, rs_flat_no_or_floor_level, rs_street_number, rs_street_name,
				rs_city_town_locale, rs_state_province_region, rs_postal_code, rs_code_country,
				rs_phone_id,
				rs_phone_country_code, rs_phone_area_code,
				rs_phone_number, rs_phone_extension, rs_phone_type,
				cl_phone_id,
				cl_phone_country_code, cl_phone_area_code,
				cl_phone_number, cl_phone_extension, cl_phone_type,
				dob, height,
				weight, race,
				gender, eyeright,
				eyeleft, hair,
				complexion,	maritalstatus,
				birthcity, birthstate,
				birthcountry, religiouspref,
				dl_id,
				dlnumber, dlstate,
				dlexpire,
				englishspoken,
				englishread,
				englishwritten,
				educationlevel, employement_id,
				occupation,
				employername,
				em_address_id,
				em_dwelling_name, em_flat_no_or_floor_level,
				em_street_number, em_street_name,
				em_city_town_locale, em_state_province_region,
				em_postal_code, em_code_country, 
				em_phone_id,
				em_phone_country_code, em_phone_area_code,
				em_phone_number, em_phone_extension, em_phone_type,
				ec_person_id,
				emergencycontact, 
				ec_phone_id,
				ec_phone_country_code,
				ec_phone_area_code, ec_phone_number,
				ec_phone_extension, ec_phone_type,
				emergencyrelationship
				) =
				(select	name_family, name_first, name_other,
				        EPIC.ef_lookup_text('TITLE', pi.NAME_TITLE, 'UC'), name_suffix,
						EPIC.ef_offender_id(p_entity_id),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'SID NUMBER'),
						MACOMB.mf_GAValue_byItmIdName(p_entity_id,'FBI TRACKING'),
   						EPIC.ef_offender_SSN(p_entity_id),
			            address_id,dwelling_name, flat_no_or_floor_level, street_number,street_name,
			            city_town_locale, state_province_region, postal_code, code_country,
			            MACOMB.MF_Ph_ID(p_entity_id, 'HOME'),
			            MACOMB.MF_PhCountry(p_entity_id, 'HOME'), MACOMB.MF_PhArea(p_entity_id, 'HOME'),
			            MACOMB.MF_PhNumber(p_entity_id, 'HOME'), MACOMB.MF_PhExtension(p_entity_id, 'HOME'), 'HOME',
			            MACOMB.MF_Ph_ID(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhCountry(p_entity_id, 'MOBILE'), MACOMB.MF_PhArea(p_entity_id, 'MOBILE'),
			            MACOMB.MF_PhNumber(p_entity_id, 'MOBILE'), MACOMB.MF_PhExtension(p_entity_id, 'MOBILE'), 'MOBILE',
			            EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),EPIC.ef_offender_height(p_entity_id),
			            EPIC.ef_Offender_Weight(p_entity_id), EPIC.scg_ef_offender_race(p_entity_id),
			            EPIC.ef_offender_person_gender(p_entity_id),MACOMB.mcmb_fnt_eyecolorright(p_entity_id),
			            MACOMB.mcmb_fnt_eyecolorleft(p_entity_id),EPIC.ef_Offender_HairColor(p_entity_id),
			            MACOMB.mcmb_fnt_complexion(p_entity_id), EPIC.ef_marital_status(p_entity_id),
			            MACOMB.mcmb_fnt_birthcity(p_entity_id), MACOMB.mcmb_fnt_birthstate(p_entity_id),
			            MACOMB.mcmb_fnt_birthcountry(p_entity_id),EPIC.ef_offender_religion(p_entity_id),
			            MACOMB.mf_primary_dlicno_ID(p_entity_id),
			            EPIC.ef_primary_dlicno(EPIC.ef_identity_id(p_entity_id)),  -- primary drivers license & info
			            MACOMB.mf_primary_dlicno_state(p_entity_id),
			            MACOMB.mf_primary_dlicno_expire(p_entity_id),
			            EPIC.ef_get_Primary_Language(p_entity_id),
			            MACOMB.mf_CanReadYN(p_entity_id),
			            MACOMB.mf_CanWriteYN(p_entity_id),
			            MACOMB.mf_highest_education(p_entity_id), MACOMB.mf_Employment_ID(p_entity_id),
			            MACOMB.mf_Occupation(p_entity_id),
                        MACOMB.mf_EmployerName(p_entity_id),
                        MACOMB.MF_EmpAdr_ID_by_entid(p_entity_id),
                        MACOMB.mf_EmpAdrDwelling_by_entid(p_entity_id), MACOMB.MF_EmpAdrFlatno_floor_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrstreetnmbr_by_entid(p_entity_id), MACOMB.MF_EmpAdrstreetname_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrcity_town_by_entid(p_entity_id),MACOMB.MF_EmpAdrstate_prov_by_entid(p_entity_id),
                        MACOMB.MF_EmpAdrPostal_by_entid (p_entity_id), MACOMB.MF_EmpAdrCountry_by_entid (p_entity_id),
                        MACOMB.MF_EmpPh_ID_by_entid(p_entity_id, 'WORK'),
                        MACOMB.MF_EmpPhCountry_by_entid(p_entity_id, 'WORK'), MACOMB.MF_EmpPhArea_by_entid(p_entity_id, 'WORK'),
                        MACOMB.MF_EmpPhNmbr_by_entid(p_entity_id, 'WORK'), MACOMB.MF_EmpPhExt_by_entid(p_entity_id, 'WORK'),'WORK',
                        MACOMB.MF_EC_Contact_ID(p_entity_id),
                        MACOMB.MF_EC_Contact(p_entity_id),
                        MACOMB.MF_EC_Ph_ID(p_entity_id), 
                        MACOMB.MF_EC_Country(p_entity_id),
						MACOMB.MF_EC_Area(p_entity_id), 
						MACOMB.MF_EC_PhNumber(p_entity_id),
						MACOMB.MF_EC_Extension(p_entity_id), MACOMB.MF_EC_PhType(p_entity_id),
						MACOMB.MF_EC_Relation(p_entity_id)

					from	EPIC.eh_person_identity pi, EPIC.eh_entity_person ep, EPIC.eh_address a--,

					where	EPIC.ep.entity_id =  p_entity_id   -- matchedoffender_id
					        and	EPIC.pi.identity_id = EPIC.ep.primary_identity_id
	                        and EPIC.a.address_id = EPIC.ef_get_primary_address_id(p_entity_id)
	                )  

		where MACOMB.mt_pb_arrestee.matchedoffender_id = p_entity_id; 
	
	IF SQL%NOTFOUND THEN
		RAISE_APPLICATION_ERROR(-20314, 'Arrestee Matched Offender Id not found');
		END IF;  							
	END;
	COMMIT;
END;   
/

CREATE OR REPLACE
PROCEDURE        mp_Timing
	(	p_ArrestID		IN		MACOMB.mt_pb_timing.arrest_id%type,
		p_ActionBy		IN		MACOMB.mt_pb_timing.action_by%type,
		p_StepText		IN		varchar2,  --this needs to be the actual step text from MACOMB.mt_pb_step_lk table
		p_StartTm		IN		date,
		p_EndTm			IN		date
	)
		
IS
/*	
	Purpose:		Populate an auditing table in the MACOMB schema that tracks basic demographic information 
					(i.e. user, time to complete task, etc) regarding the booking process


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/14/06		Created 
					R. Stuve	09/12/06		Calculates duration based on p_StartTm & p_EndTm
*/

CURSOR curTime IS
    	SELECT	duration,
    			timing_id
    	FROM	MACOMB.mt_pb_timing
    	WHERE	arrest_id = p_ArrestID
    			and action_by = p_ActionBy;   
    			
v_time 		MACOMB.mt_pb_timing.duration%type; 
v_time_id 	MACOMB.mt_pb_timing.timing_id%type; 
v_duration	MACOMB.mt_pb_timing.duration%TYPE;
nodata		EXCEPTION; 
 
BEGIN 

v_duration := p_EndTm - p_StartTm;     --calculate the duration time
   
		BEGIN
			OPEN curTime;
			FETCH curTime INTO v_time, v_time_id;
				IF curTime%found THEN
					UPDATE MACOMB.mt_pb_timing
					SET duration = v_time + v_duration
					WHERE timing_id = v_time_id; 
				ELSE 
					RAISE nodata;
				END IF;    
			 CLOSE curTime;

   		EXCEPTION 
        		WHEN nodata THEN
        			INSERT INTO MACOMB.mt_pb_timing (timing_id, arrest_id, action_by, step_id, duration) 
   					VALUES (	(SELECT EPIC.epic_ids.new_epic_id FROM dual),
              					p_ArrestID, 
              					p_ActionBy,
              					(SELECT s.step_ID FROM MACOMB.mt_pb_step_lk s WHERE s.stepdescription = p_StepText),
              					v_duration);     					
		END;

COMMIT;
END;   
/

CREATE OR REPLACE
TRIGGER mtd_active_booking
before DELETE ON EPIC.EH_active_booking
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an delete into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_RELEASE_alert,:NEW.ENTITY_ID);
	RETURN;
END mtd_active_booking;
/

CREATE OR REPLACE
TRIGGER mti_active_booking
before  INSERT  ON EPIC.EH_active_booking
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an insert into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_ID);
	mpk_jil.signal(mpk_jil.cs_JIL_BOOKING_alert,:NEW.ENTITY_ID);  
	mpk_jil.signal(mpk_jil.cs_JIL_CHARGE_alert,:NEW.ENTITY_ID);  	
	
	RETURN;
END mti_active_booking;
/

CREATE OR REPLACE
TRIGGER mtu_active_booking
before UPDATE ON EPIC.EH_active_booking
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_ID);
	RETURN;
END mtu_active_booking;
/

CREATE OR REPLACE
TRIGGER mtu_EH_ACTIVE_BOOKING
before UPDATE ON EPIC.EH_ACTIVE_BOOKING

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	mpk_jil.signal(mpk_jil.cs_JIL_CHARGE_alert,:NEW.booking_id);
	RETURN;
END mtu_EH_ACTIVE_BOOKING;
/

CREATE OR REPLACE
TRIGGER mtu_eh_banned_visitor
before UPDATE ON EPIC.eh_banned_visitor
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_BANNED_alert,:NEW.VISITOR_ID);
	RETURN;
END mtu_eh_banned_visitor;
/

CREATE OR REPLACE
TRIGGER mtu_EH_BOOKING
before UPDATE ON EPIC.EH_BOOKING

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_id);
	mpk_jil.signal(mpk_jil.cs_JIL_BOOKING_alert,:NEW.BOOKING_id);
	RETURN;
END mtu_EH_BOOKING;
/

CREATE OR REPLACE
TRIGGER mtu_eh_booking_holds
before UPDATE ON EPIC.EH_booking_holds
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/30/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_CHARGE_alert,:NEW.BOOKING_ID);
	RETURN;
END mtu_eh_booking_holds;
/

CREATE OR REPLACE
TRIGGER mtu_EH_CASE
before UPDATE ON EPIC.EH_CASE

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_BOOKING_alert,:NEW.BOOKING_id);
	RETURN;
END mtu_EH_CASE;
/

CREATE OR REPLACE
TRIGGER mtu_EH_CHARGE
before UPDATE ON EPIC.EH_CHARGE

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_CHARGE_alert,:NEW.charge_id);
	RETURN;
END mtu_EH_CHARGE;
/

CREATE OR REPLACE
TRIGGER mtu_EH_CHARGE_AGENCY
before UPDATE ON EPIC.EH_CHARGE_AGENCY

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_CHARGE_alert,:NEW.charge_id);
	RETURN;
END mtu_EH_CHARGE_AGENCY;
/

CREATE OR REPLACE
TRIGGER mtu_EH_ENTITY_ORGANIZATION
before UPDATE ON EPIC.EH_ENTITY_ORGANIZATION

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	RETURN;
END mtu_EH_ENTITY_ORGANIZATION;
/

CREATE OR REPLACE
TRIGGER mtu_EH_ENTITY_PERSON
before UPDATE ON EPIC.EH_ENTITY_PERSON

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	RETURN;
END mtu_EH_ENTITY_PERSON;
/

CREATE OR REPLACE
TRIGGER mtu_EH_ENTITY_RELATIONSHIP
before UPDATE ON EPIC.EH_ENTITY_RELATIONSHIP
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_ID);
	mpk_jil.signal(mpk_jil.cs_JIL_ALIAS_alert,:NEW.ENTITY_ID);
	mpk_jil.signal(mpk_jil.cs_JIL_VISITOR_alert,:NEW.ENTITY_ID);
	RETURN;
END mtu_EH_ENTITY_RELATIONSHIP;
/

CREATE OR REPLACE
TRIGGER mtu_EH_ENTITY_RESTRICTION
before UPDATE ON EPIC.EH_ENTITY_RESTRICTION

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	RETURN;
END mtu_EH_ENTITY_RESTRICTION;
/

CREATE OR REPLACE
TRIGGER mtu_EH_HOUSING_ASSIGNMENTS
before UPDATE ON EPIC.EH_HOUSING_ASSIGNMENTS

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	RETURN;
END mtu_EH_HOUSING_ASSIGNMENTS;
/

CREATE OR REPLACE
TRIGGER mtu_eh_offender_ids
before UPDATE ON EPIC.eh_offender_ids
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_ID);
	RETURN;
END mtu_eh_offender_ids;
/

CREATE OR REPLACE
TRIGGER mtu_eh_person_identity
before UPDATE ON EPIC.eh_person_identity
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.ENTITY_ID);
	mpk_jil.signal(mpk_jil.cs_JIL_ALIAS_alert,:NEW.ENTITY_ID);
	mpk_jil.signal(mpk_jil.cs_JIL_VISITOR_alert,:NEW.ENTITY_ID);
	RETURN;
END mtu_eh_person_identity;
/

CREATE OR REPLACE
TRIGGER mtu_EH_SENTENCE_OUT_DATE
before UPDATE ON EPIC.EH_SENTENCE_OUT_DATES

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	01/03/07		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_SENTENCE_alert,:NEW.SENTENCE_id);
	RETURN;
END mtu_EH_SENTENCE_OUT_DATE;
/

CREATE OR REPLACE
TRIGGER mtu_EH_VEHICLE
before UPDATE ON EPIC.EH_VEHICLE

REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.entity_id);
	RETURN;
END mtu_EH_VEHICLE;
/

CREATE OR REPLACE
TRIGGER mtu_Epicimage
before UPDATE ON EPIC.Epicimage
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to signal the insert record to JIL
--  
/*	Purpose:		Macomb IVR and Inmate Locator - Creates the signal to request an update into 
                    the remote database
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	12/26/06		Created   

*/ 
BEGIN       
     
	mpk_jil.signal(mpk_jil.cs_JIL_INMATE_alert,:NEW.IMAGEREF);
	RETURN;
END mtu_Epicimage;
/

CREATE OR REPLACE
TRIGGER mt_eh_booking
before  UPDATE  ON EPIC.EH_booking
REFERENCING NEW AS NEW
FOR EACH ROW
--
--	trigger to Set the booking end_date
--  
/*	Purpose:		Macomb Pre booking - Release and end date trigger
	Process:		Update if the scheduled release date and actual release date 
	                are the same for a current booking
					
	Author:			Joe McBratnie
	
	Change Log:		Changed By	  Date Modified		Change Made
					------------  -------------		---------------------------------
					J. MCBRATNIE  	08/10/06		Created   
					J. MCBRATNIE	08/24/06		Move to production

*/ 
DECLARE
	v_actual_release 		VARCHAR2(20);
	v_scheduled_release 	VARCHAR2(20);
	v_system_date           VARCHAR2(20);

BEGIN       
     
	v_system_date := epic.epicdatenow();
    BEGIN
		SELECT actual_release, scheduled_release
		INTO v_actual_release, v_scheduled_release
		FROM epic.eh_release
		WHERE booking_id = :NEW.booking_id;
	EXCEPTION WHEN NO_DATA_FOUND THEN
		v_actual_release := NULL; 
		v_scheduled_release := EPIC.epic_ids.new_epic_id() ;
    END;
	IF v_scheduled_release = v_actual_release THEN 
		:NEW.end_date := v_system_date;
	
		UPDATE  epic.eh_release
		SET actual_release = v_system_date
		WHERE booking_id = :NEW.booking_id;
	END IF;	 
	RETURN;
END mt_eh_booking;
/

CREATE OR REPLACE
TRIGGER mt_eh_release_kjh
AFTER INSERT on EPIC.EH_RELEASE
REFERENCING NEW AS NEW
for each row
--
--	trigger to clear the restitution attribute of eh_sentence upon inmate release
--
Begin       
 		
		 mcmb_clear_restitution_attr(:new.booking_id);
	
End mt_eh_release_kjh;
/

CREATE OR REPLACE
TRIGGER MT_Epicimage
BEFORE INSERT OR UPDATE  on EPIC.Epicimage
REFERENCING NEW AS NEW
for each row          
Begin       
    -- insert into Macomb.MT_MG_IMAGE_DETAILS
    INSERT INTO Macomb.MT_MG_IMAGE_DETAILS
select 'newid', ph.entity_id, id.OFFENDER_ID, 'Trigger Loaded',
       r.CODE_RACE, e.CODE_ETHNICITY, s.CODE_BUILD, s.CODE_COMPLEXION,
       p.CODE_EYE_COLOR_LEFT, p.CODE_EYE_COLOR_RIGHT, h.HEIGHT, w.WEIGHT,
       p.JUVENILE_FLAG, i.DATE_OF_BIRTH, s.CODE_HAIR_COLOR, s.CODE_HAIR_STYLE,s.CODE_FACIAL_HAIR_1, s.CODE_FACIAL_HAIR_2,
       s.CODE_FACIAL_HAIR_3, g.GANG_ID, ei.imageref, 'Need to get from Bob',
       ph.photo_id, 'O', 'I',epic.epicdatenow(), -25

from 	epic.Epicvolume ev,
	epic.Epicimage ei,
	epic.Eh_entity_default_photo ph,
	EPIC.EH_OFFENDER_IDS id,
	EPIC.EH_ENTITY_RACE r,
	EPIC.EH_PERSON_SNAPSHOT s,
	EPIC.EH_ETHNICITY e,
	EPIC.EH_ENTITY_PERSON p,
	EPIC.EH_ENTITY_HEIGHT h,
	EPIC.EH_ENTITY_WEIGHT w,
	EPIC.EH_PERSON_IDENTITY i,
	EPIC.EH_GANG_RELATIONSHIPS g
where
	:new.imageref = ph.photo_id
	and  ev.volumeid(+) = ei.volumeid
	and  id.entity_id = ph.entity_id
	and  id.entity_id = r.ENTITY_ID
	and  id.entity_id = s.ENTITY_ID
	and  id.entity_id = e.ENTITY_ID
	and  id.entity_id = p.ENTITY_ID
	and  id.entity_id = h.ENTITY_ID
	and  id.entity_id = w.ENTITY_ID
	and  id.entity_id = i.ENTITY_ID
	and  id.entity_id = g.ENTITY_ID (+);   

End mt_eh_release;
/

CREATE OR REPLACE
VIEW MV_ACTIVE_ALIAS ( ENTITY_ID, OFFENDER_ID, ALIAS_ID, LASTNAME, FIRSTNAME, MIDDLENAME, SUFFIXNAME, DOB, CODE_NAME_TYPE, LINK_PK ) AS
select 	id.entity_id AS entity_id,
        id.OFFENDER_ID AS offender_id,
		pi.identity_id AS alias_id,
		pi.name_family AS lastname,
		pi.name_first  AS firstname,
		pi.name_other  AS middlename,
		pi.name_suffix AS suffixname,
 	    NVL(NVL(to_char(EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
 	    		to_char(EPIC.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
 	                   'UNKNOWN') AS DOB,
 	    pi.CODE_NAME_TYPE AS CODE_NAME_TYPE,
 	    decode(pi.CODE_NAME_TYPE, 'MAS',id.entity_id, 'ALIAS') AS LINK_PK
FROM    EPIC.eh_person_identity pi,
		EPIC.eh_offender_ids id
WHERE	id.ENTITY_ID = pi.entity_id
  AND	pi.CODE_NAME_TYPE in ('MAS','ALI')
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where id.entity_id = ab.entity_id)
/

CREATE OR REPLACE
VIEW MV_ACTIVE_CHARGE ( ENTITY_ID, OFFENDER_ID, CHARGE_ID, STATUTE_ID, PACC, CHARGE_DESC, CHARGE_CLASS, SENTENCE_ID, CHARGE_ID_NUMBER, AGENCY_ID, COMPLAINT_DEPT, COURT_ID, CASE_NO, COURT_NAME, COURT_DATE, COURT_DIVISION, COURT_JUDGE, START_DATE, FINAL_RELEASE_DATE, AMOUNT, AMOUNT_TYPE, TRANS_TYPE, SORTORDER, WEB_CHARGE_PK, REDUCEAMOUNT, PAIDOUTDATE, UNPAIDOUTDATE, SURCHARGE_AMOUNT, CHARGE_STATE ) AS
SELECT 	b.entity_id                AS entity_id,
        id.OFFENDER_ID				AS offender_id,
		c.charge_id 				AS charge_id,
        c.statute_id 				AS statute_id,
        es.statute_number 			AS pacc,
        es.statute_description 		AS charge_desc,
    	EPIC.ef_lookup_text('STATUTE CLASS', es.code_statute_class, 'UC') AS charge_class,
        s.sentence_id 				AS sentence_id,
       	charge_id_number 			AS charge_id_number,
       	ca.agency_id 				AS agency_id,
       	eo.organization_name 		AS complaint_dept,
       	cct.court_id 				AS court_id,
       	cs.case_number 				AS case_no,
       	EPIC.mcmb_fnt_courtname(c.charge_id) AS court_name,
       	decode(
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY'),'12/25/2025','Call Court',
       	                                                                                      '01/01/2200','Call Court',
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY')) AS court_date,
       	EPIC.ef_next_court_division(b.entity_id) AS court_division,
       	EPIC.ef_lookup_text('JUDGE NAME',EPIC.ef_next_court_judge(b.entity_id),'UC') AS court_judge,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.start_date(b.booking_id))         		AS Start_Date,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.final_release_date(b.booking_id))     	AS final_releASe_date ,
		decode(c.sentence_id,NULL,
							to_number(bc.cash_only_bail_amount),
							to_number(EPIC.mcmb_fnt_fineamount(c.sentence_id)))  AS amount,
		decode(c.sentence_id,NULL, 'BAIL', 'FINE') AS amount_type,
		decode(c.sentence_id,NULL, 'U', 'S') AS Trans_type,
		decode(c.sentence_id,NULL, 2, 1) AS sortorder,
		EPIC.ef_offender_id(b.entity_id)||' - '||c.charge_id  AS web_charge_pk,
		decode(EPIC.ef_get_attribute_value('10 PERCENT BOND',bc.BAIL_CONDITION_ID),'YES',
															'Y',
															'N') AS reduceamount,
		EPIC.ef_epic_date_to_date(so.paid_out_date) AS paidoutdate,
		EPIC.ef_epic_date_to_date(so.unpaid_out_date) AS unpaidoutdate,
		bc.surcharge_amount  AS surcharge_amount,
		c.charge_state 
FROM 	EPIC.eh_charge c,                                               
		EPIC.eh_booking b, 
		EPIC.eh_active_booking ab,
		EPIC.eh_charge_agency ca ,
     	EPIC.eh_case cs, 
     	EPIC.eh_case_charge cc, 
     	EPIC.eh_case_court cct,
     	EPIC.eh_entity_organization eo, 
     	EPIC.eh_sentence s, 
     	EPIC.eh_sentence_out_dates so,
     	EPIC.epic_statutes es, 
     	EPIC.eh_bail_condition bc, 
     	EPIC.eh_bail_condition_charge bcc,
		EPIC.eh_offender_ids id
WHERE b.booking_id = c.booking_id 
  AND c.charge_id = ca.charge_id 
  AND s.sentence_id (+) = c.sentence_id 
  AND cs.booking_id = b.booking_id 
  AND cc.charge_id = c.charge_id 
  AND cc.cASe_id = cs.cASe_id 
  AND cct.cASe_id = cs.cASe_id 
  AND eo.entity_id = ca.agency_id 
  AND es.STATUTE_ID = c.statute_id
  AND so.sentence_id (+)  = c.sentence_id
  AND bc.booking_id = b.booking_id
  AND bcc.charge_id = c.charge_id
  AND bc.bail_condition_id = bcc.bail_condition_id
  AND b.booking_id = ab.booking_id
  AND id.ENTITY_ID = ab.entity_id
  AND EPIC.ef_is_active_booking(b.entity_id)='TRUE'
union
-- HOLD records
SELECT b.entity_id AS entity_id,
       EPIC.ef_offender_id(b.entity_id) AS offender_id,
       h.hold_id AS charge_id,
	   NULL      AS statute_id,
       NULL      AS pacc,
       NULL      AS charge_desc,
       EPIC.ef_lookup_text('STATUTE CLASS', code_charge_severity, 'UC') AS charge_clASs,
       NULL                 AS sentence_id,
       EPIC.ef_lookup_text('HOLD TYPE',code_hold_type,'UC') AS charge_id_number,
       h.agency_id          AS agency_id,
       eo.organization_name AS complaint_dept,
       NULL                 AS court_id,
       -- case number (other attrib - hold warant number)
       EPIC.ef_get_attribute_value('HOLD WARRANT NUMBER',h.hold_id) AS case_no,
       -- court name  (other attrib - hold court)
       EPIC.ef_get_attribute_value('HOLD COURT',h.hold_id) AS court_name,
       NULL AS court_date,
       NULL AS court_division,
       NULL AS court_judge,
       NULL AS start_date,
       NULL AS final_release_date,
       -- bond/fines  (other attrib - hold amount)
       to_number(EPIC.ef_get_attribute_value('HOLD AMOUNT',h.hold_id)) AS amount,
       'BOND' AS amount_type,
	   'H'    AS Trans_type,
       3      AS sortorder,
        EPIC.mcmb_fnt_offenderidfrombk(b.booking_id)||' - '||h.hold_id,
   	    decode(sign(instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10%')+
  					instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10 %')+
   					instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'10 PERCENT'))-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO 10')*100)-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO10')*100),
				  					1,'Y','N') AS reduceamount,
		NULL AS paidoutdate,
		NULL AS unpaidoutdate,
		NULL AS surcharge_amount,
		NULL AS charge_state
FROM EPIC.eh_booking_holds h, 
     EPIC.eh_active_booking b,
     EPIC.eh_entity_organization eo
WHERE b.booking_id = h.booking_id 
  AND eo.entity_id = h.agency_id
/

CREATE OR REPLACE
VIEW MV_ACTIVE_INMATE ( ENTITY_ID, OFFENDER_ID, LASTNAME, FIRSTNAME, LEVEL4, LEVEL5, LEVEL6, LEVEL7, LEVEL8, DOB, PAID_RELEASE, PROJECTED_RELEASE, JUVENILE_FLAG, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, MUGPATH, VEHICLE_ID, TOW_COMPANY, OTHERNAME, INMATECLASS, GENDER, CELL, RESTRICTIONUNTIL ) AS
select      id.entity_id AS entity_id,
            id.OFFENDER_ID AS offender_id,
				pi.NAME_FAMILY as lastname,
			    pi.NAME_FIRST  as firstname,
	   		 substr(epic.ef_location_path_name(ha.location_id ,'uc',4),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',4),',')-1) as Level4,
	   		 substr(epic.ef_location_path_name(ha.location_id ,'uc',5),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',5),',')-1) as Level5,
	  		 substr(epic.ef_location_path_name(ha.location_id ,'uc',6),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',6),',')-1) as Level6,
       		 substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1) as level7,
       		 substr(epic.ef_location_path_name(ha.location_id ,'uc',8),
              instr(epic.ef_location_path_name(ha.location_id ,'uc',8),
        		/*level7 */ substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1)
                    ,2)+1) as level8,
				NVL(NVL(to_char(epic.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
						to_char(epic.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
					'UNKNOWN_DOB') as DOB,
				epic.ef_epic_date_to_date(epic.epp_booking_dates.earliest_release_date(ab2.booking_id)) as paid_release,
    	   		epic.ef_epic_date_to_date(epic.epp_booking_dates.final_release_date(ab2.booking_id))    as Projected_release,--,
				decode(ep.JUVENILE_FLAG,'Y','Y','N') as juvenile_flag,
    	   		EPIC.mcmb_fnt_sent_Total_Amount(ab2.booking_id) as sent_total,
    	   		EPIC.mcmb_fnt_hold_Total_Amount(ab2.booking_id) as hold_total,
    	   		EPIC.mcmb_fnt_Bail_Total_Amount(ab2.booking_id) as bail_total,
				decode(ei.imageref, null,null,
					'\\' || ev.volumeserver || '\F$\FTP\' || ev.volumepath || '\' || ei.imageref) as mugpath,
   				vehicle_id as vehicle_id,
				eo.ORGANIZATION_NAME as tow_company,
				pi.NAME_OTHER  as othername,
	   		 decode(epic.ef_offender_CustStat(ab2.entity_id),
                  	'REGULAR INMATE','R',
					'WORK RELEASE','W',
                  	'KITCHEN TRUSTEE (White)','K',
                  	'GARAGE TRUSTEE (Orange)','O',
                  	'SPECIAL TRUSTEE (Green)','G',
                  	'R') as inmateclass,
   				decode(ep.CODE_GENDER,'_NOSP','U',ep.CODE_GENDER) as gender,
		   		 substr(epic.ef_location_name(ha.location_id ,'uc'),1,10) as cell,
    	   	(select max(epic.ef_epic_date_to_date(r.end_date)) from epic.EH_ENTITY_RESTRICTION r where ab2.entity_id = r.entity_id(+) and epic.ef_epic_date_to_date(r.end_date)>sysdate ) as restrictionuntil
			 from   epic.EH_OFFENDER_IDS id,
			 		epic.EH_PERSON_IDENTITY pi,
			 		epic.eh_entity_person ep,
			 		epic.EH_VEHICLE v,
					epic.EH_ENTITY_ORGANIZATION  eo,
					epic.Epicvolume ev,
					epic.Epicimage ei,
					epic.Eh_entity_default_photo ph,
					epic.eh_active_booking ab2,
					epic.eh_housing_assignments ha
			 where  id.entity_id = ab2.entity_id
  			   and  epic.ef_is_active_booking(ab2.entity_id)='TRUE'
  			   and  id.entity_id = pi.entity_id
  			   and  id.entity_id = ep.entity_id
  			   and  ab2.entity_id = ha.entity_id
			   and  v.entity_id(+) = pi.entity_id
			   and  v.tow_company_id = eo.entity_id(+)
			   and  ei.imageref(+) = ph.photo_id
			   and  ev.volumeid(+) = ei.volumeid
			   and  ph.entity_id(+) = id.entity_id
  			   and  pi.code_name_type = 'MAS'
  			   and  ab2.entity_id = id.entity_id
/

CREATE OR REPLACE
VIEW MV_BOOKING_LOOKUPS ( LOOKUP_CLASS, SUB_1, SUB_2, SUB_3, SUB_4, LOOKUP_CODE, TEXT_FULL, DISPLAY_ORDER ) AS
SELECT LOOKUP_CLASS, SUB_1, SUB_2, SUB_3, SUB_4, LOOKUP_CODE, TEXT_FULL, display_order
FROM   EPIC.epic_lookups
WHERE  EFFECTIVE_END_DATE > EPIC.epicdatenow()
  AND  lookup_class IN ('NAME SUFFIX TYPE','STATES', 'RACE', 'SEX',
						'STAFF TITLE','EYE COLOUR', 'HAIR COLOUR',
                       'COMPLEXION', 'MARITAL STATUS', 'COUNTRY',
                       'LANGUAGE','LANGUAGE GRADING',
                       'RELATIONSHIP', 'RELATIONSHIP STATUS',
                       /*'RELATIONSHIP TYPE',*/ 'ALERT CATEGORY',
                       'PROPERTY LOCATION', 'CHARGE MODIFIER',
                       'ARREST REASON', 'COURT NAME',
                       'CPS EDUCATION LEVEL', 'ARRESTINGOFFICERS',
                       'MONTH', 'OCCUPATION', 'OWNING AGENCY',
                       'ORGANISATION ROLE', 'ORGANISATION TYPE',
                       'PROPERTY MATERIAL','PROPERTY TYPE',
                       'VEHICLE STORAGE', 'YES NO', 'YES NO NA',
                       'YES NO REFUSED','STATUTE CLASS', 'COLOUR TYPE', 'EDUCATION CLASS NAME', 'PERSONAL RELATIONSHIP' /*,'BUILD'*/ )
  
UNION
SELECT LOOKUP_CLASS, SUB_1, SUB_2, SUB_3, SUB_4, LOOKUP_CODE, TEXT_FULL, display_order
FROM   EPIC.epic_lookups
WHERE  EFFECTIVE_END_DATE > EPIC.epicdatenow()
  AND  lookup_class IN ('RELIGION') 
  AND  SUB_2 is not null
/

CREATE OR REPLACE
VIEW MV_COURTS ( ORGANIZATION_NAME, SORT, ENTITY_ID ) AS
select o.organization_name,  -- 0 MCSO, 1 Macomb others, 3 near counties, 4 others
       decode(a.postal_code, '48041',1,'48043',0,'48045',2,'48046',1,
                             '48047',1,'48048',1,'48060',3,'48062',3,
                             '48091',1,'48089',1,'48021',1,'48080',1,
                             '48081',1,'48066',1,'48015',1,'48092',1,
                             '48093',1,'48026',1,'48082',1,'48045',1,
                             '48035',1,'48036',1,'48312',1,'48310',1,
                             '48314',1,'49313',1,'48038',1,'48036',1,
                             '48317',1,'48094',1,'48096',1,'48048',1,
                             '48051',1,'48047',1,'48094',1,'48095',1,
                             '48096',1,'48050',1,'48065',1,'48005',1,
                             '48062',1,'48065',1,'48066',1,'48067',3,
                             '48069',3,'48070',3,'48071',3,'48072',3,
                             '48076',3,'48076',3,'48084',3,'48226',3,
                             '48234',3,'48236',3,'48242',3,'48313',1,
                             '48316',1,'48079',3,'48081',3,'48093',3,
                             '48317',1,'48341',2,'48342',2,'48413',3,'48455',1,4),
       o.entity_id
from EPIC.EH_ENTITY_ORGANIZATION o,epic.eh_entity_roles r, epic.eh_address a
where r.code_entity_role in ('783')
  and o.entity_id = r.entity_id
  and r.effective_to >= EPIC.epicdatenow()
  and o.date_ceased_operating is null
  and o.entity_id = a.entity_id
order by 2, 1          
/

CREATE OR REPLACE
VIEW MV_EPIC_USER_NAMES ( USER_INT_ID, USER_ID, ENCRYPTED_PASSWORD, USER_NAME_LAST, USER_NAME_FIRST, USER_NAME_MIDDLE, USER_NAME_SUFFIX, JOB_TITLE, DATE_START, DATE_END, TRAINING_ONLY_FLAG, DEFAULT_SERVICE, DEFAULT_LEVEL3, DEFAULT_LEVEL4, DEFAULT_LEVEL5, DEFAULT_LEVEL6, DEFAULT_LEVEL7, DEFAULT_LEVEL8, ACTION_TYPE, ACTION_TIME, ACTION_BY, EPIC_ID ) AS
SELECT "USER_INT_ID","USER_ID","ENCRYPTED_PASSWORD","USER_NAME_LAST","USER_NAME_FIRST","USER_NAME_MIDDLE","USER_NAME_SUFFIX","JOB_TITLE","DATE_START","DATE_END","TRAINING_ONLY_FLAG","DEFAULT_SERVICE","DEFAULT_LEVEL3","DEFAULT_LEVEL4","DEFAULT_LEVEL5","DEFAULT_LEVEL6","DEFAULT_LEVEL7","DEFAULT_LEVEL8","ACTION_TYPE","ACTION_TIME","ACTION_BY","EPIC_ID"
FROM   EPIC.epic_user_names
/

CREATE OR REPLACE
VIEW MV_ORGANIZATION ( ORGANIZATION_NAME, SORT, ENTITY_ID ) AS
select o.organization_name,  -- 0 MCSO, 1 Macomb others, 3 near counties, 4 others
       decode(a.postal_code, '48041',1,'48043',0,'48045',2,'48046',1,
                             '48047',1,'48048',1,'48060',3,'48062',3,
                             '48091',1,'48089',1,'48021',1,'48080',1,
                             '48081',1,'48066',1,'48015',1,'48092',1,
                             '48093',1,'48026',1,'48082',1,'48045',1,
                             '48035',1,'48036',1,'48312',1,'48310',1,
                             '48314',1,'49313',1,'48038',1,'48036',1,
                             '48317',1,'48094',1,'48096',1,'48048',1,
                             '48051',1,'48047',1,'48094',1,'48095',1,
                             '48096',1,'48050',1,'48065',1,'48005',1,
                             '48062',1,'48065',1,'48066',1,'48067',3,
                             '48069',3,'48070',3,'48071',3,'48072',3,
                             '48076',3,'48076',3,'48084',3,'48226',3,
                             '48234',3,'48236',3,'48242',3,'48313',1,
                             '48316',1,'48079',3,'48081',3,'48093',3,
                             '48317',1,'48341',2,'48342',2,'48413',3,'48455',1,4),
       o.entity_id
from EPIC.EH_ENTITY_ORGANIZATION o,epic.eh_entity_roles r, epic.eh_address a
where r.code_entity_role in ('784')
  and o.entity_id = r.entity_id
  and r.effective_to >= EPIC.epicdatenow()
  and o.date_ceased_operating is null
  and o.entity_id = a.entity_id
order by 2, 1
/

CREATE OR REPLACE
VIEW MV_STATUTE ( STATUTE_ID, STATUTE_NUMBER, STATUTE_DESCRIPTION, CODE_STATUTE_CLASS ) AS
SELECT 	statute_id, 
		statute_number, 
		statute_description, 
		code_statute_class
FROM   	EPIC.epic_statutes s
WHERE  	(s.expiration_date >= EPIC.epicdatenow() 
   OR 	s.expiration_date IS NULL)
/

CREATE OR REPLACE
VIEW MV_VISTITOR ( ENTITY_ID, OFFENDER_ID, VISITOR_ID, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ, VISTITOR_PK ) AS
SELECT 	id.entity_id AS entity_id,
        id.offender_id AS entity_id, 
		er.ENTITY_RELATED_TO AS VISITOR_ID,
		DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_app_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS application_date,
       	DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_expir_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS expiration_date,
       	pi.name_family AS lastname,
       	pi.name_first  AS firstname,
       	DECODE(er.RELATIONSHIP_TYPE,'21','A','N') AS status,
       	DECODE(er.RELATIONSHIP_TYPE,'21','1','2') AS typeseq,
   	   	id.offender_id ||'-'||er.ENTITY_RELATED_TO AS vistitor_pk
FROM   	EPIC.eh_offender_ids id,
		EPIC.eh_person_identity pi,
       	EPIC.eh_entity_relationship er
--       	EPIC.eh_active_booking ab
WHERE  er.ENTITY_RELATED_TO = pi.entity_id
--  AND  ab.entity_id = pi.entity_id
  AND  id.entity_id = er.entity_id
  AND  er.related_as_role = 'VISTR'
  AND  pi.code_name_type = 'MAS'   
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where pi.entity_id = ab.entity_id)
  
UNION
-- Banned
SELECT 	'' AS entity_id, 
        '' AS offender_id,
		va.visitor_id AS vistitor_id, 
		va.date_FROM AS application_date, 
		va.date_to AS expiration_date, 
		vpi.name_family AS lastname, 
		vpi.name_first  AS firstname, 
		'B' AS status, 
		'3' AS typeseq,
		''||'-'||va.VISITOR_ID
FROM 	EPIC.eh_banned_visitor va, 
		EPIC.eh_person_identity vpi
--       	EPIC.eh_active_booking ab
WHERE 	va.visitor_id = vpi.entity_id
--  AND	ab.entity_id = vpi.entity_id
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where vpi.entity_id = ab.entity_id)
/

