CREATE OR REPLACE
function MACOMB.mac_MCL_subset (
	p_statute				in epic.epic_statutes.statute_number%type
	)
	return boolean
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
begin
	if p_statute = '750.82' then
		return true;
	elsif p_statute = '750.83' then
		return true;
	elsif p_statute = '750.84' then
		return true;
	elsif p_statute = '750.86' then
		return true;
	elsif p_statute = '750.87' then
		return true;
	elsif p_statute = '750.88' then
		return true;
	elsif p_statute = '750.89' then
		return true;
	elsif p_statute = '750.91' then
		return true;
	elsif p_statute = '750.136' then
		return true;
	elsif p_statute = '750.136A' then
		return true;
	elsif p_statute = '750.197C' then
		return true;
	elsif p_statute = '750.205' then
		return true;
	elsif p_statute = '750.206' then
		return true;
	elsif p_statute = '750.207' then
		return true;
	elsif p_statute = '750.210' then
		return true;
	elsif p_statute = '750.211A' then
		return true;
	elsif p_statute = '750.213' then
		return true;
	elsif p_statute = '750.316' then
		return true;
	elsif p_statute = '750.317' then
		return true;
	elsif p_statute = '750.321' then
		return true;
	elsif p_statute = '750.324' then
		return true;
	elsif p_statute = '750.349' then
		return true;
	elsif p_statute = '750.377B' then
		return true;
	elsif p_statute = '750.397' then
		return true;
	elsif p_statute = '750.82' then
		return true;
	elsif p_statute = '750.83' then
		return true;
	elsif p_statute = '750.84' then
		return true;
	elsif p_statute = '750.86' then
		return true;
	elsif p_statute = '750.87' then
		return true;
	elsif p_statute = '750.88' then
		return true;
	elsif p_statute = '750.89' then
		return true;
	elsif p_statute = '750.91' then
		return true;
	elsif p_statute = '750.136' then
		return true;
	elsif p_statute = '750.136A' then
		return true;
	elsif p_statute = '750.197C' then
		return true;
	elsif p_statute = '750.205' then
		return true;
	elsif p_statute = '750.206' then
		return true;
	elsif p_statute = '750.207' then
		return true;
	elsif p_statute = '750.210' then
		return true;
	elsif p_statute = '750.211A' then
		return true;
	elsif p_statute = '750.213' then
		return true;
	elsif p_statute = '750.316' then
		return true;
	elsif p_statute = '750.317' then
		return true;
	elsif p_statute = '750.321' then
		return true;
	elsif p_statute = '750.324' then
		return true;
	elsif p_statute = '750.349' then
		return true;
	elsif p_statute = '750.377B' then
		return true;
	elsif p_statute = '750.397' then
		return true;
	elsif p_statute = '750.479' then
		return true;
	elsif p_statute = '750.479A' then
		return true;
	elsif p_statute = '750.529' then
		return true;
	elsif p_statute = '750.530' then
		return true;
	elsif p_statute = '750.531' then
		return true;
	elsif p_statute = '752.191' then
		return true;
	elsif p_statute = '752.541' then
		return true;
	elsif p_statute = '752.542' then
		return true;
	elsif p_statute = '752.861' then
		return true;
	elsif p_statute = '750.85' then
		return true;
	elsif p_statute = '750.158' then
		return true;
	elsif p_statute = '750.333' then
		return true;
	elsif p_statute = '750.336' then
		return true;
	elsif p_statute = '750.338' then
		return true;
	elsif p_statute = '750.338A' then
		return true;
	elsif p_statute = '750.338B' then
		return true;
	elsif p_statute = '750.339' then
		return true;
	elsif p_statute = '750.340' then
		return true;
	elsif p_statute = '750.341' then
		return true;
	elsif p_statute = '750.342' then
		return true;
	elsif p_statute = '750.520' then
		return true;
	elsif p_statute = '750.520b' then
		return true;
	elsif p_statute = '750.520c' then
		return true;
	elsif p_statute = '750.520d' then
		return true;
	elsif p_statute = '750.520e' then
		return true;
	elsif p_statute = '750.520f' then
		return true;
	elsif p_statute = '750.520g' then
		return true;
	elsif p_statute = '767.61' then
		return true;
	else
		return false;
	end if;
end;







 


 
/

CREATE OR REPLACE
function MACOMB.mark_rs_test   
    (p_unit_id   in  epic.epic_locations.location_id%type)
return       epic.epp_generic_ref_cursor.ref_cursor
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
       vCur          epic.epp_generic_ref_cursor.ref_cursor;

begin

   open      vCur for
   select
       ' Name' as "NAME",
       'Inmate ID:' as "INMATE NUM",
       'SSN' as ssn,
       'Booking #:' as booking_number,
       'Start Date' as start_date
       from dual
       union
   select    epic.ef_get_personororgname(ab.entity_id) as "NAME",
          epic.ef_offender_id(ab.entity_id) as "INMATE NUM",
          epic.ef_offender_ssn(ab.Entity_id) as ssn,
          bk.booking_number,
          to_char(epic.ef_epic_date_to_date(bk.start_date)) as Start_date
from      epic.eh_active_booking ab,
          epic.eh_booking  bk,
          epic.epic_location_child elc,
          epic.eh_housing_assignments ha
where  ab.booking_id = bk.booking_id 
   and ab.entity_id = ha.entity_id
   and ha.location_id =elc.child_location_id
   and elc.location_id =p_unit_id 
order by 1;

   
   return vCur;

end;
/

CREATE OR REPLACE
function MACOMB.master_alias (in_entity_id in epic.EH_PERSON_IDENTITY.ENTITY_ID%TYPE,
					   in_identity_id in epic.EH_PERSON_IDENTITY.IDENTITY_ID%TYPE)
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
 	return number is out_number number(1);
--
	got_primary_id   char(16);
--
begin
	out_number := 0;
	select  PRIMARY_IDENTITY_ID
	into    got_primary_id
	from    epic.EH_ENTITY_PERSON
	where   ENTITY_ID = in_entity_id;
--
	if got_primary_id = in_identity_id then
		out_number := 1;
	else
		out_number := 2;
	end if;
--
	return out_number;
exception
	when no_data_found then
		return out_number;
	when too_many_rows then
		return out_number;
end;
/

CREATE OR REPLACE
function MACOMB.master_dob (in_entity_id in epic.EH_PERSON_IDENTITY.ENTITY_ID%TYPE)
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
 	return string is out_dob char(20);
--
	got_primary_id	char(16);
--
begin
   out_dob := ' ';
   begin
	select  PRIMARY_IDENTITY_ID
	into    got_primary_id
	from    epic.EH_ENTITY_PERSON
	where   ENTITY_ID = in_entity_id;
   exception
	when no_data_found then
		return out_dob;
	when too_many_rows then
		return out_dob;
   end;
--
   begin
 	select  DATE_OF_BIRTH
	into    out_dob
	from    epic.EH_PERSON_IDENTITY
	where   IDENTITY_ID = got_primary_id;
--
	return out_dob;
   exception
	when no_data_found then
		return out_dob;
	when too_many_rows then
		return out_dob;
   end;
end;
/

CREATE OR REPLACE
function MACOMB.master_name (in_entity_id in epic.EH_PERSON_IDENTITY.ENTITY_ID%TYPE)
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
 	return string is out_master char(120);
--
	got_primary_id	char(16);
	got_first		char(32);
	got_other		char(64);
	got_family		char(32);
--
begin
   out_master := ' ';
   begin
	select  PRIMARY_IDENTITY_ID
	into    got_primary_id
	from    epic.EH_ENTITY_PERSON
	where   ENTITY_ID = in_entity_id;
   exception
	when no_data_found then
		return out_master;
	when too_many_rows then
		return out_master;
   end;
--
   begin
 	select  NAME_FAMILY, NAME_OTHER, NAME_FIRST
	into    got_family, got_other, got_first
	from    epic.EH_PERSON_IDENTITY
	where   IDENTITY_ID = got_primary_id;
--
	out_master := substr(epic.string_name(got_first,got_other,got_family),1,60);
--
	return out_master;
   exception
	when no_data_found then
		return out_master;
	when too_many_rows then
		return out_master;
   end;
end;
/

CREATE OR REPLACE
function MACOMB.MCF_isActiveBooking_From_Book (
	p_booking_id		in		epic.eh_active_booking.booking_id%type
)
return epic.epic_col_types.varchar_255%type
is

--01/27/2006, J McBratnie - returns true or false depending if booking_id is active booking or not
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	cursor curActiveBook is
		select *
		from epic.eh_active_booking
		where booking_id = p_booking_id;

		v_book	curActiveBook%rowtype;

		v_result epic.epic_col_types.varchar_255%type;
begin
	v_result := 'FALSE';

	open curActiveBook;
	fetch curActiveBook into v_book;
	if curActiveBook%found then
		v_result := 'TRUE';
	end if;
	close curActiveBook;
	return v_result;
end;
/

CREATE OR REPLACE
function MACOMB.MCF_isActiveBooking_From_CG (
	p_charge_id		in		epic.eh_charge.charge_id%type
)
return epic.epic_col_types.varchar_255%type
is

--01/27/2006 J McBratnie - returns true or false depending if Charge_ID is part of an active booking or not
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
	cursor curActiveBook is
		select '1'
		from epic.eh_active_booking b,
		     epic.eh_charge c
		where c.charge_id = p_charge_id
		  and c.booking_id = b.booking_id;

		v_book	curActiveBook%rowtype;

		v_result epic.epic_col_types.varchar_255%type;
begin
	v_result := 'FALSE';

	open curActiveBook;
	fetch curActiveBook into v_book;
	if curActiveBook%found then
		v_result := 'TRUE';
	end if;
	close curActiveBook;
	return v_result;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_acct_status_isOpen
		(p_offender_id		in		epic.eh_offender_ids.offender_id%type)
--Returns the inmate's ACTIVE Trust account id for the given offender_id	
RETURN VARCHAR2 AS
v_acctID 	epic.eh_trust_account.trust_account_id%type;

	CURSOR cur_acctID IS
		SELECT
			ta.trust_account_id
		FROM
      epic.eh_offender_ids oi,
		 	epic.eh_trust_account ta      
		WHERE
      p_offender_id = oi.offender_id
			and ta.entity_id =  oi.entity_id
			and ta.code_status = 'OPEN';  
BEGIN
	OPEN cur_acctID;
		FETCH cur_acctID INTO v_acctID;
	CLOSE cur_acctID;
			
RETURN v_acctID;

END;
 --kjh  Created 01/04/2011 for MJRS to Otrak interface
/

CREATE OR REPLACE
function MACOMB.mcmb_age_at_booking (
	p_dob in epic.EH_PERSON_IDENTITY.DATE_OF_BIRTH%TYPE,
	p_book_date in epic.EH_PERSON_IDENTITY.DATE_OF_BIRTH%TYPE)
	return epic.epic_col_types.number_4%type
is
	v_age epic.epic_col_types.number_4%type;
--
-- 10/22/2010 KJH to determine inmate's age at booking (for subsequent juvenile counts, etc.)
	v_dob	date;
	v_book_date	date;

begin
	if ltrim(p_dob) = ' ' OR p_dob IS NULL then
		v_age := 0;
	else
		v_dob := to_date(substr(epic.date_extract(p_dob,' '),1,8),'yyyymmdd');
		v_book_date  :=  to_date(substr(epic.date_extract(p_book_date,' '),1,8),'yyyymmdd');
		--v_book_date  := to_date(to_char(p_book_date,'yyyymmdd'),'yyyymmdd');
		
		---work_indate := to_date(substr(date_extract(in_dob,' '),1,8),'yyyymmdd');
		---work_today  := to_date(to_char(sysdate,'yyyymmdd'),'yyyymmdd');

		v_age := floor(months_between(v_book_date,v_dob)/12);
	end if;
 	return v_age;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_booking_enddate
	(p_book_id	   in		epic.eh_booking.booking_id%type)   
	

/*	 Returns final release date of a closed booking	
	Author:			Kelly Heinz 	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
		K. Heinz 3/30/09, changed name to mcmb_booking_enddate				
*/

RETURN VARCHAR2 AS

v_end_date				epic.eh_booking.final_release_date%type;

	CURSOR cur_end_date IS
		select
			bk.end_date  
			from epic.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
		
  
BEGIN
	OPEN cur_end_date;
		FETCH cur_end_date INTO v_end_date;
	 	CLOSE cur_end_date;	
			
RETURN v_end_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_booking_startdate	
	(p_book_id in		epic.eh_booking.booking_id%type)   
	
/*Returns the booking_start_date of a closed booking 	
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
			K. Heinz 3/30/09, changed name to mcmb_booking_startdate		
*/ 
RETURN VARCHAR2 AS

v_start_date				epic.eh_booking.sentence_start_date%type;

	CURSOR cur_start_date IS
		select
			bk.start_date  
			from epic.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_amount_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'AMOUNT:';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_court_date

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
 /*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curPayment is

		select bk.entity_id, cc.case_id

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_bail_condition_charge bcc,

		     epic.eh_case_charge cc,

		     epic.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		and bc.bail_condition_id = bcc.bail_condition_id

		and bcc.charge_id = cc.charge_id

		UNION

		select bk.entity_id, cc.case_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_case_charge cc,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id

		and   ch.charge_id = cc.charge_id;



	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curCourt is

		select payee from epic.eh_trust_account_trans

		where trust_account_trans_id = p_trans_id;



	v_now				varchar2(20);

	v_court_id			epic.eh_entity_organization.entity_id%type;

	v_entity_id			epic.eh_booking.entity_id%type;

	v_case_id			epic.eh_case_charge.case_id%type;



	cursor curAppearance is

		select to_char(epic.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YY HH:MI AM')

		from epic.eh_court_appearance ca,

		     epic.eh_booking bk

		where ca.owner_id = v_case_id

		and ca.court_name = v_court_id

		and ca.appearance_date > v_now

		and not exists

		(select 1 from epic.eh_court_appearance ca2

		where ca2.owner_id = v_case_id

		and ca2.court_name = v_court_id

		and ca2.appearance_date < ca.appearance_date);



	v_temp				number;

	v_return			varchar2(255);



begin



	v_now := epic.epicdatenow();



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id, v_case_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		-- now get the court for this check.

		open curCourt;

		fetch curCourt into v_court_id;

		if curCourt%found then



			-- get the next court appearance for this inmate

			-- for this court

			open curAppearance;

			fetch curAppearance into p_return;

			if curAppearance%notfound then

				p_return := '<No Future Court Date>';

			end if;

			close curAppearance;

		else

			p_return := '<No Future Court Date>';

		end if;



		close curCourt;



	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_court_l1

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curName is

	select eo.organization_name

	from epic.eh_trust_account_trans tat,

		 epic.eh_entity_organization eo

	where tat.trust_account_trans_id = p_trans_id

	and tat.payee = eo.entity_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_court_l2

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
 /*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curCourt is

	select trim(ad.street_number || ' ' || ad.street_name)

	from epic.eh_trust_account_trans tat,

		 epic.eh_address ad

	where tat.trust_account_trans_id = p_trans_id

	and ad.entity_id = tat.payee

	and ad.primary_flag = 'Y';



begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_court_l3
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	
	cursor curCourt is
	select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)
	from epic.eh_trust_account_trans tat,
		 epic.eh_address ad
	where tat.trust_account_trans_id = p_trans_id
	and ad.entity_id = tat.payee
	and ad.primary_flag = 'Y';
	
begin                          
                                 
	open curCourt;
	fetch curCourt into p_return;
	if curCourt%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curCourt;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_court_telephone

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curCourt is

	select trim(t.area_code || '-' || t.base_number )

	from epic.eh_trust_account_trans tat,

		 epic.eh_telephone_records t

	where tat.trust_account_trans_id = p_trans_id

	and t.entity_id = tat.payee

	and t.primary_flag = 'Y';



begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<No Telephone # on Record>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_date
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is





begin



	p_return := to_char(sysdate, 'MM/DD/YY');

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_dept_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'DEPT:';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_descriptor_cap

	(p_trans_id			in			epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'DESCRIPTOR #:';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_dkt_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'DKT#';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_docket_number

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curPayment is

		select ca.case_number

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_bail_condition_charge bcc,

		     epic.eh_case_charge cc,

		     epic.eh_case ca

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id  = bcc.bail_condition_id

		and bcc.charge_id = cc.charge_id

		and cc.case_id = ca.case_id

		UNION

		select ca.case_number

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_case_charge cc,

			 epic.eh_case ca

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.charge_id = cc.charge_id

		and   cc.case_id = ca.case_id;



	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_return;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_return;

		if curPayment%notfound then

			v_return := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_return <> 'NOT FOUND' then

		p_return := v_return;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_fee_amt

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curName is

	select decode(trim(tat.comments),

				  null, 'PROCESSING FEES:  $0.00',

				  '', 'PROCESSING FEES:   $0.00',

				  UPPER(tat.comments))

	from epic.eh_trust_account_trans tat

	where tat.trust_account_trans_id = p_trans_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	else

		-- go ahead and strip off the 'PROCESSING' so that it looks

		-- just like the Macomb check.

		if instr(p_return, 'PROCESSING') > 0 then

			p_return := trim(substr(p_return,12, 255));

			if instr(p_return, 'FEES:') > 0 then

				p_return := trim(substr(p_return, 1, 5) || '     ' || substr(p_return, 6, 255));

			end if;

		end if;

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_inmate_name

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		select bk.entity_id

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		UNION

		select bk.entity_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;



	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curName is

		select pi.name_family || ', ' || pi.name_first

		from epic.eh_person_identity pi,

		     epic.eh_entity_person ep

		where ep.entity_id = v_entity_id

		and ep.primary_identity_id = ep.primary_identity_id;





begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(epic.ef_get_personororgname(v_entity_id));

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_inmate_number
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is



	cursor curPayment is

		select bk.entity_id

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_booking bk

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.booking_id = bk.booking_id

		UNION

		select bk.entity_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;



	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := epic.ef_offender_id(v_entity_id);

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_on_docket_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'ON DOCKET #';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_owning_agency
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	cursor curPayment is
		select substr(epic.ef_get_personororgname(ca.agency_id), 1,255)
		from epic.eh_court_payment cp,
		     epic.eh_bail_condition bc,
		     epic.eh_bail_condition_charge bcc,
		     epic.eh_charge_agency ca
		where
			cp.court_payment_trans_id = p_trans_id
		and cp.item_id = bc.bail_condition_id
		and bc.bail_condition_id  = bcc.bail_condition_id
		and bcc.charge_id = ca.charge_id
		UNION
		select substr(epic.ef_get_personororgname(ca.agency_id), 1,255)
		from epic.eh_court_payment cp,
			 epic.eh_fine_payment fp,
			 epic.eh_charge ch,
			 epic.eh_charge_agency ca
		where cp.court_payment_trans_id = p_trans_id
		and   cp.item_id = fp.payment_id
		and   fp.sentence_id = ch.sentence_id
		and   ch.charge_id = ca.charge_id;

	cursor curIsInmate is
		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat
		where tat.trust_account_trans_id = p_trans_id
		and tat.trust_account_id = ta.trust_account_id
		and ta.entity_id = ep.entity_id;

	v_entity_id			epic.eh_booking.entity_id%type;
	v_temp				number;
	v_return			varchar2(255);

begin

	v_return := ' ';

	open curIsInmate;
	fetch curIsInmate into v_return;
	if curIsInmate%notfound then

		open curPayment;
		fetch curPayment into v_return;
		if curPayment%notfound then
			v_return := 'NOT FOUND';
		end if;
		close curPayment;
	end if;
	close curIsInmate;

	if v_return <> 'NOT FOUND' then
		p_return := v_return;
	end if;

	return;

end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_payor_l1

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curAddr is

		select trim(ad.street_number || ' ' || ad.street_name)

		from epic.eh_address ad

		where ad.entity_id = v_entity_id

		and ad.primary_flag = 'Y';







begin



	v_return := '';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		open curAddr;

		fetch curAddr into p_return;

		if curAddr%notfound then

			p_return := '<No Address on Record>';

		end if;

		close curAddr;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_payor_l2
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is

	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	cursor curAddr is

		select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)

		from epic.eh_address ad

		where ad.entity_id = v_entity_id

		and ad.primary_flag = 'Y';



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		open curAddr;

		fetch curAddr into p_return;

		if curAddr%notfound then

			p_return := '<No Address On Record>';

		end if;

		close curAddr;

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_receipt_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/




begin



	p_return := 'RECEIPT #';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_remitted_by

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/



	cursor curPayment is

		-- return person or entity ID for bail payment

		select bp.submitting_party

		from epic.eh_court_payment cp,

		     epic.eh_bail_condition bc,

		     epic.eh_bail_payment bp

		where

			cp.court_payment_trans_id = p_trans_id

		and cp.item_id = bc.bail_condition_id

		and bc.bail_condition_id = bp.bail_condition_id

		UNION

		-- return person ID if not inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'N'

		UNION

		-- return entity ID if inmate for fine payment

		select fp.source_id

		from epic.eh_court_payment cp,

			 epic.eh_fine_payment fp,

			 epic.eh_charge ch,

			 epic.eh_booking bk

		where cp.court_payment_trans_id = p_trans_id

		and   cp.item_id = fp.payment_id

		and   fp.inmate_funds = 'Y'

		and   fp.sentence_id = ch.sentence_id

		and   ch.booking_id = bk.booking_id;





	cursor curIsInmate is

		select ep.entity_id from epic.eh_entity_person ep, epic.eh_trust_account ta, epic.eh_trust_account_trans tat

		where tat.trust_account_trans_id = p_trans_id

		and tat.trust_account_id = ta.trust_account_id

		and ta.entity_id = ep.entity_id;



	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



begin



	v_return := ' ';



	open curIsInmate;

	fetch curIsInmate into v_entity_id;

	if curIsInmate%notfound then



		open curPayment;

		fetch curPayment into v_entity_id;

		if curPayment%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curPayment;

	end if;

	close curIsInmate;



	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(epic.ef_get_personororgname(v_entity_id));

	end if;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_remitted_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/





begin



	p_return := 'REMITTED BY:';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_user_name

	(p_trans_id			in			epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)

is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/







begin



	p_return := epic.epp_user_info.get_name('13', 'UC');

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_chk_voucher_reason
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
	
	cursor curName is
	select decode(tat.description,
				  'BAIL PAYMENT', 'BOND POSTED',
				  'FINE PAYMENT', 'FINE PAYMENT',
				  'UNKNOWN')
	from epic.eh_trust_account_trans tat
	where tat.trust_account_trans_id = p_trans_id;
	
begin                          
                                 
	open curName;
	fetch curName into p_return;
	if curName%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curName;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_clear_restitution_attr
	(p_booking_id in epic.eh_booking.booking_id%type)
/* Created for SRF 11792, triggered by mcmb_release_cleanup upon update of the eh_release table.
     Procedure zeroes out any "Restitution Judgement Amount"  attributes in the Sentence tab*/
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
		vsuccess 				varchar2(5);
		v_attrID                    epic.eh_generic_attribute.attribute_id%type;
		v_itemID                   epic.eh_generic_attribute.item_id%type;
		v_attrName               epic.eh_generic_attribute.attribute_name%type;
		v_attrValue               epic.eh_generic_attribute.attribute_value%type;
		v_action_by               epic.eh_generic_attribute.action_by%type;
		v_update                   epic.epic_col_types.char_1%type;
		v_result                     epic.epic_col_types.number_9%type;
		v_msg                       epic.epic_col_types.varchar_255%type; 
CURSOR curAttr IS

select  ga.attribute_id, ga.item_id
 from
			epic.eh_generic_attribute ga,
			epic.eh_charge chg
	where  chg.booking_id = p_booking_id 
	and     ga.item_id = chg.sentence_id
	and ga.attribute_name = 'RESTITUTION JUDGEMENT AMOUNT';

BEGIN
        v_attrID := '';                  
		v_itemID := '';                      
		v_attrName := '';                   
		v_attrValue := '';                  
		v_action_by := '';                       
		v_update := '';                              
		v_result := 0;                          
		v_msg := '';                    
 	    vsuccess := null;
For recAttr in curAttr
Loop
 		v_attrID := recAttr.attribute_id;                  
		v_itemID := recAttr.item_id;                      
		v_attrName := 'RESTITUTION JUDGEMENT AMOUNT';                   
		v_attrValue := '0';                  
		v_action_by := 0;                       
		v_update := 'U';                              
		v_result := 0;                          
		v_msg := ' ';
--epic.EP_LOG_INFO('mcmb_CLEAR_RESTITUTION_ATTR', 'I',-1, 'AttributeID ' || recAttr.attribute_id || ' ' || recAttr.item_id);                    
	epic.EHI_EH_GENERIC_ATTRIBUTE(v_attrID, v_itemID, v_attrName, v_attrValue, v_action_by, v_update, v_result, v_msg);
		
  End Loop; 
  END mcmb_clear_restitution_attr;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_dispodate_sent
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns max action_time if a charge has been sentenced & disposed; otherwise, returns a 'U'
-- Per Sgt. Roberts, the chg.disposition_reasons all include being sentenced  12/09/05 KJH	
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
		K. Heinz					03/30/09, changed name to mcmb_dispodate_sent and moved to MJRS schema			
*/ 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	MAX(chg.action_time) 
  	
    FROM 	epic.eh_charge chg
            
	WHERE	p_booking_id = chg.booking_id and
	        
			chg.charge_state = '6' and
			chg.disposition_reason in
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','TTP','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV');      
     
v_status epic.eh_charge.action_time%type;


BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
RETURN NVL (v_status,null); --changed default value from 'U' to 'Null"    03/30/09 KJH
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION MACOMB.MCMB_ENTITY_STATUS
( p_entity_id IN epic.eh_entity_status.code_custody_status%type)
 RETURN VARCHAR2 AS
Cursor curStat is

Select
      decode(stat.code_custody_status,'1','R',
  									'2','F',
  									'3','P',
  									'4','W',
           							'5','WR',
                  					'6', 'KT',
                       				'7', 'AW',
                           			'9', 'GT',
                              		'10', 'ST',
                                	'11', 'JS',
                                 	'12', 'WW',
                                  	'13', 'T',
                                   	'14', 'SCC',
                                    '15', 'LC',
                                    '16', 'OC')  as Status
               from epic.eh_entity_status stat
               where p_entity_id = stat.entity_id;
v_status      epic.eh_entity_status.code_custody_status%type;               
  BEGIN
	
  	OPEN curStat;
  		FETCH curStat INTO v_status;
  	CLOSE curStat;
RETURN NVL (v_status,'U');
             
END MCMB_ENTITY_STATUS;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_ep_set_booking_fee (
	-- jmcbratnie 12/06/2005
	-- Testing of booking fees
	--     
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	sentity_ID		 in 	 epic.eh_offender_ids.entity_id%type          DEFAULT 'UNKNOWN',
	ssucess             out  epic.eh_offender_ids.offender_id%type             
)
As
	------ V A R I A B L E S ---------------------------
	c_debug		constant boolean := false;

    v_server_action_time       varchar2(20);
    v_trust_account_id         epic.eh_trust_account.trust_account_id%type;
    v_trust_account_trans_id   epic.eh_trust_account_trans.trust_account_trans_id%type;
	p_check_amount			   epic.eh_trust_account_trans.amount%type;
	p_result                   epic.epic_col_types.number_9%type;
	p_result_msg               epic.epic_col_types.varchar_255%type;
	
    
	----------------------------------------------------

begin
	v_server_action_time        := epic.epicdatenow;
	v_trust_account_id          := MCMB_FNT_get_trust_account_id(sentity_ID);

    p_check_amount := 0.00;
    p_result	   := 123;
    p_result_msg   := 'Booking Fee';
    
	begin --county fee
		v_trust_account_trans_id    := epic.EPIC_IDS.new_epic_id();
		-- note ep_trust_account_trans resets the p_result_msg.  

		epic.ep_trust_account_trans (v_trust_account_trans_id,	v_trust_account_id,	'CREDIT', v_server_action_time,
			null, p_result_msg, -10.00, null, null, 'CASH', null, null, 502,  --KJH - Testing a theory changed from 202
			'Auto-generated', null, null, null, null, null, 
			epic.ef_generate_autoid('TRUST ACCOUNTING TRANSACTION NUMBER',v_trust_account_id,'TRUST TRANSACTION'), 
			502, 10.00, 110, -10.00, 'N', -25, 	p_check_amount, 	p_result, p_result_msg );
			
		-- Insert into the audit table.  This was noted in the ep_trust_account_trans function
		insert into epicaudit.eh_trust_account_trans
			select *
			From epic.eh_trust_account_trans
			Where
				trust_account_trans_id = v_trust_account_trans_id;

    exception
		when others then
	   		ssucess :='NO';
	End;
	begin --state fee
		v_trust_account_trans_id    := epic.EPIC_IDS.new_epic_id();
	    p_result_msg   := 'Booking Fee';  		-- note ep_trust_account_trans resets the p_result_msg.  
	    
		epic.ep_trust_account_trans (v_trust_account_trans_id,	v_trust_account_id,	'CREDIT', v_server_action_time,
			null, p_result_msg, -2.00, null, null, 'CASH', null, null, 503,
			'Auto-generated', null, null, null, null, null, 
			epic.ef_generate_autoid('TRUST ACCOUNTING TRANSACTION NUMBER',v_trust_account_id,'TRUST TRANSACTION'), 
			503, 2.00, 110, -2.00, 'N', -25, 	p_check_amount, 	p_result, p_result_msg );

		-- Insert into the audit table.  This was noted in the ep_trust_account_trans function
		insert into epicaudit.eh_trust_account_trans
			select *
			From epic.eh_trust_account_trans
			Where
				trust_account_trans_id = v_trust_account_trans_id;

    exception
		when others then
	   		ssucess :='NO';
	End;

End mcmb_ep_set_booking_fee;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_ep_set_generic_attribute (
	-- jmcbratnie 12/02/2005
	-- Update or insert into generic_attribute
	-- Commit on the calling side!
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/	sOffenderID		 in 	 epic.eh_offender_ids.offender_id%type          DEFAULT 'UNKNOWN',
	sitem_id         in      epic.eh_generic_attribute.item_id%type         DEFAULT 'UNKNOWN',
	sAttribute_name  in      epic.eh_generic_attribute.Attribute_name%type  DEFAULT 'UNKNOWN',
	sattribute_value in      epic.eh_generic_attribute.attribute_value%type DEFAULT 'UNKNOWN',
	saction_by       in      epic.eh_generic_attribute.action_by%type       DEFAULT -1,
	ssucess          in OUT  epic.eh_generic_attribute.attribute_id%type
)
As
	------ V A R I A B L E S ---------------------------
	c_debug		constant boolean := false;

    v_server_action_time       varchar2(20);
    v_attrib_id                epic.eh_generic_attribute.attribute_id%type;
	----------------------------------------------------

begin
	v_server_action_time := epic.epicdatenow;
	v_attrib_id          := mcmb_fnt_get_attrID(sOffenderID, sAttribute_name);
	
	if v_attrib_id is null then
	    Begin
		    v_attrib_id := epic.EPIC_IDS.new_epic_id();
			insert into epic.eh_generic_attribute(
		    	attribute_id, 
				item_id,
				attribute_name,
				attribute_value,
				action_type,
				action_time,
				action_by)
			values (
				v_attrib_id,
				sitem_id, 
				sAttribute_name,
				sattribute_value,
				'I',
				v_server_action_time,
	    	    saction_by);
			ssucess :='YES';
	   Exception
	   	when others then
	   		ssucess :='NO';
	   End;
	else
		Begin
		    update epic.eh_generic_attribute
		      set --attribute_id = vATTRIB_ID, (PK)
			  attribute_name =  sAttribute_name,
			  attribute_value =  sattribute_value,
			  action_type = 'U',
			  action_time = v_server_action_time,
		      action_by = saction_by
		    where 	attribute_name = sAttribute_name and
		    attribute_id = v_attrib_id and 
  		    item_id      = sitem_id;
			ssucess :='YES';

		Exception
			when Others then
				ssucess :='NO';
		End;
    end if;                                               
    
	Begin
	    -- add the updates and inserts to the epicaudit table.
		insert into epicaudit.eh_generic_attribute
			select *
			From epic.eh_generic_attribute
			Where attribute_id = v_attrib_id;
	Exception
	   	when others then
	   		ssucess :='NO';
	End;
    
-- The code block below was kept in this procedure because of the concept of:
-- update and if the update fails the exception is to insert instead.  
-- Time did not allow for me to test this concept future yet!  I did not
-- want to lose the concept and will attempt to add this in on the next one 
-- and then update this procedure with the more efficient code

/*exception
	when no_data_found then
	Begin 
		insert into eh_generic_attribute(
		    attribute_id, 
			item_id,
			attribute_name,
			attribute_value,
			action_type,
			action_time,
			action_by)
		values (
			EPIC_IDS.new_epic_id(),
			(select trust_account_id from eh_trust_account ta, eh_offender_ids i where ta.entity_id = i.entity_id and i.offender_id = sOffenderID),
			sAttribute_name,
			sattribute_value,
			'I',
			v_server_action_time,
	        -24);
		return;
	exception
	  when others then
	    raise;
	End;
	*/
End mcmb_ep_set_generic_attribute;
/

CREATE OR REPLACE
TRIGGER MACOMB.MCMB_et_GVT_in
after insert  on MCMB_MJRS_IN
REFERENCING NEW AS NEW
for each row
--
--	trigger to convert GVT in file into 3 generic attribute rows
--
declare                   
    vsucess 				varchar2(5);    
    ventity_id              varchar2(16);   
    vid                     varchar2(16);
	
Begin       
	vsucess    := Null;                
	vid        := MCMB_FNT_get_entity_id(ltrim(:new.OFFENDER_ID, '0'));
	ventity_id := mcmb_fnt_trust_id(vid);
--	ventity_id := mcmb_fnt_trust_id('0IR6B8O000USJ1IR');
	
	--vitem := (select trust_account_id from eh_trust_account ta, eh_offender_ids i where ta.entity_id = i.entity_id and i.offender_id = :NEW.OffenderID)
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'REIMBURSEMENT BALANCE', nvl(:NEW.Rmbsmt_Bal,0),-25,vsucess);
	End;
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'LEGAL JUDGEMENT FLAG', nvl(:NEW.Legal_Flag,'N'),-26,vsucess);
	End;
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'LEGAL JUDGEMENT AMOUNT', nvl(:NEW.Legal_Amount,0),-27,vsucess);		
	End; 
	--Exception when vsuccess is null
	if vsucess is null then
		raise_application_error(-20001, 'MCMB_ep_set_generic_attribute failed.');
		return;
	end if;
	return;
End MCMB_et_GVT_in;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_505_560_trans_amt
	(p_transid_input	in	   epic.eh_trust_account_trans.trust_account_trans_id%type,
     p_start_date       in     epic.eh_trust_account_trans.trans_date%type,
     p_end_date         in     epic.eh_trust_account_trans.trans_date%type)
     
--Returns any transactions (payments by inmate) against acct 505 Legal Judgement Reimbursement
-- or account 560 Cash Settlement
/*	
	System: 		Unknown
	Purpose:		

	Author:			Maryann Zak
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_Trans		varchar2(128);

	CURSOR cur_Trans IS
		select
			trans.amount
		from
         	epic.eh_trust_account_trans trans,
         	epic.eh_trust_account trust
         where
     trans.trust_account_trans_id = p_transid_input and
      trans.trust_account_id = trust.trust_account_id and
     -- The next line finds transactions between midnight and 23:59 on the input date range, use previous run date
     (epic.ef_epic_date_to_date(trans.trans_date) > (epic.ef_epic_date_to_date(epic.ef_min_date(p_start_date)))
     and epic.ef_epic_date_to_date(trans.trans_date) <= (epic.ef_epic_date_to_date(epic.ef_max_date(p_end_date))))
     and trans.code_source_of_funds in ('505','560') and
     trans.reverse_flag is null;  
           
BEGIN
	OPEN cur_Trans;
		FETCH cur_Trans INTO v_Trans;
	CLOSE cur_Trans;
			
RETURN v_Trans;

END;
 --MAZ (modified Kelly's mcmb_fnt_505_trans_amt)
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_505_trans_amt
	(p_input 	in		epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_last_run in      epic.eh_interface_request.date_submitted%type)

--Returns any transactions (payments by inmate) against acct 505 Legal Judgement Reimbursement
-- or account 560 Cash Settlement that were completed after the input date
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/RETURN VARCHAR2 AS

v_Trans		varchar2(128);

	CURSOR cur_Trans IS
		select
			trans.amount
		from
         	epic.eh_trust_account_trans trans,
         	epic.eh_trust_account trust
         where
     trans.trust_account_trans_id = p_input and
     trans.trust_account_id = trust.trust_account_id and
     -- The next line finds transactions completed after the p_last_run date
     trans.action_time > p_last_run and  --03/30/06 changed this from trans_date as we were missing transactions due to the fact that trans_date always logged 05:00 as the time.
     trans.code_source_of_funds in ('505','560') and
     trans.reverse_flag is null;

BEGIN
	OPEN cur_Trans;
		FETCH cur_Trans INTO v_Trans;
		IF cur_Trans%notfound THEN
			 v_trans := 0;
		END IF;
	CLOSE cur_Trans;

RETURN v_Trans;

END;
 --KJH
 
 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_activealerts_full
	(p_entity_id		in			epic.eh_housing_assignments.entity_id%type)  
	
--Returns the full text of all of an inmate's active alerts
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN epic.epic_col_types.varchar_255%type
IS
	
	CURSOR curAlerts IS
		SELECT 	l.text_full
	
		FROM 	epic.eh_entity_alerts a,
				epic.epic_lookups l
				
		WHERE	a.entity_id = p_entity_id 
				and a.alert_active = 'Y'
				and l.lookup_code = a.alert_type
				and l.lookup_class = 'IOMS ALERT TYPE' 
				
		ORDER BY a.action_time;
	
vAllAlerts  epic.epic_col_types.varchar_255%type;
	
BEGIN
    vAllAlerts := null;
    
	FOR a IN curAlerts
	LOOP
		vAllAlerts := vAllAlerts || a.text_full || ' ';
	END LOOP;

RETURN vAllAlerts;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_activealerts_trunc
	(p_entity_id		in			EPIC.eh_housing_assignments.entity_id%type)
	
/*
Purpose: Returns the three character text of all of an inmate's active alerts

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/


RETURN EPIC.epic_col_types.varchar_255%type
IS
	
	CURSOR curAlerts IS
		SELECT	substr(l.text_full,1,3) as text_full
	
		FROM	EPIC.eh_entity_alerts a,
				EPIC.epic_lookups l
				
		WHERE 	a.entity_id = p_entity_id 
			  	and a.alert_active = 'Y'
			  	and l.lookup_code = a.alert_type
			  	and l.lookup_class = 'IOMS ALERT TYPE'
	
		ORDER BY a.action_time;  
	
vAllAlerts  EPIC.epic_col_types.varchar_255%type;
	
BEGIN
    vAllAlerts := null;
    
	FOR a IN curAlerts
	LOOP
		vAllAlerts := vAllAlerts || a.text_full || ' ';
	END LOOP;

RETURN vAllAlerts;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address
	(p_entity_id	in		epic.eh_address.entity_id%type)
	
--Returns the city of the inmate's home residence
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_address		epic.eh_address.city_town_locale%type;

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	epic.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.action_time desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_city
	(p_entity_id	in		EPIC.eh_address.entity_id%type)  
	
/*
Purpose: Returns the city of an inmate's most current address 
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve	    4/7/06		Verified MACOMB/EPIC schema
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.city_town_locale%type;

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
		
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		           
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_city_dlk
	(p_entity_id	in		epic.eh_address.entity_id%type)  
	

--Returns the city of an inmate's most current address
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_address		epic.eh_address.city_town_locale%type;

	CURSOR cur_Address IS
		SELECT
			a.city_town_locale
		FROM
		 	epic.eh_address a
		 	--eh_address a2
		WHERE    
			a.entity_id =  p_entity_id
			--and a.entity_id = a2.entity_id
			--and a.action_time >= a2.action_time
			
		ORDER BY a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_numstr
	(p_entity_id	in		EPIC.eh_address.entity_id%type)

/*
Purpose: Returns the numbers and street of an inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema 
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/
	
RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.street_number || ' ' || a.street_name
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
					
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		  
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_numstr_dlk
	(p_entity_id	in		epic.eh_address.entity_id%type)
	
--Returns the numbers and street of an inmate's most current address
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_address		varchar2(128);

	CURSOR cur_Address IS
		SELECT
			a.street_number || ' ' || a.street_name
		FROM
		 	epic.eh_address a
		 	--epic.eh_address a2
		WHERE    
			a.entity_id = p_entity_id
			--and a.entity_id = a2.entity_id
			--and a.date_from >= a2.date_from
			
		ORDER BY a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_postal
	(p_entity_id	in		EPIC.eh_address.entity_id%type)   

/*
Purpose: Returns the zip code of the inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema 
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/	

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.postal_code%type;

	CURSOR cur_Address IS
		SELECT
			a.postal_code
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_postal_dlk
	(p_entity_id	in		epic.eh_address.entity_id%type)   
	
--Returns the zip code of the inmate's most current address
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_address		epic.eh_address.postal_code%type;

	CURSOR cur_Address IS
		SELECT
			a.postal_code
		FROM
		 	epic.eh_address a
		 	--eh_address a2
		WHERE    
			a.entity_id =  p_entity_id
			--and a.entity_id = a2.entity_id
			--and a.action_time >= a2.action_time
			
		ORDER BY a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_state
	(p_entity_id	in		EPIC.eh_address.entity_id%type)

/*
Purpose: Returns the state of the inmate's most current address
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				D. Kuykendall	12/28/05	Changes to allow function to return the most recent city data dlk 12/28/05 
				R. Stuve		4/7/06		Verified MACOMB/EPIC schema
				M Zak           4/18/06     otmain/macomb Added a.primary_flag to ORDER BY
*/		

RETURN VARCHAR2 AS

v_address		EPIC.eh_address.state_province_region%type;

	CURSOR cur_Address IS
		SELECT
			a.state_province_region
		FROM
		 	EPIC.eh_address a
		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;

  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_address_state_dlk
	(p_entity_id	in		epic.eh_address.entity_id%type)
	
--Returns the state of the inmate's most current address
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_address		epic.eh_address.state_province_region%type;

	CURSOR cur_Address IS
		SELECT
			a.state_province_region
		FROM
		 	epic.eh_address a
		 	--epic.eh_address a2
		WHERE    
			a.entity_id =  p_entity_id
			--and a.entity_id = a2.entity_id
			--and a.action_time >= a2.action_time
			
		ORDER BY a.date_from desc;
  
BEGIN
	OPEN cur_Address;
		FETCH cur_Address INTO v_Address;
	CLOSE cur_Address;
			
RETURN v_Address;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_alias
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)    

/*
Purpose: Returns all of an inmate's alias names (one line, seperated by a '\')

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN  EPIC.epic_col_types.VARCHAR_2000%type
IS   
	CURSOR curAlias IS
		SELECT
			pi.name_family || ', ' || pi.name_first || ' ' || pi.name_other  as Alias
		FROM
		 	EPIC.eh_person_identity pi	
		WHERE    
			pi.entity_id =  p_entity_id
			AND pi.code_name_type != 'MAS';
		
vAllAlias EPIC.epic_col_types.VARCHAR_2000%type;
  
BEGIN
	vAllAlias := null;
		FOR a IN curAlias
			LOOP vAllAlias := vAllAlias || a.alias || ' \ ';
			END LOOP;
		RETURN vAllAlias;
END;

--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_AliasFlag
	 (p_entity_id 	IN 	EPIC.eh_active_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate has any Alias Names

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 

	 
RETURN VARCHAR2 AS
  CURSOR curAlias IS 
  	SELECT '*'

	FROM 	EPIC.eh_person_identity pi

	WHERE   pi.code_name_type != 'MAS'
			and pi.entity_id = p_entity_id;
     
     
v_Alias varchar2(1);


BEGIN
	-- Look for any alias for this inmate:  
  	OPEN curAlias;
  		FETCH curAlias INTO v_Alias;
  	CLOSE curAlias;
	
-- If we found an alias, 'v_Alias' will be set to '*', if not it will return a null
RETURN NVL (v_Alias, NULL);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_alias_sepline
	(p_entity_id		in		epic.eh_entity_person.entity_id%type)   
	
--Returns an inmate's alias names (each on a seperate line)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	
RETURN  epic.epic_col_types.varchar_2000%type
IS   
	CURSOR curAlias IS
		SELECT
			pi.name_family || ', ' || pi.name_first || ' ' || pi.name_other
		FROM
		 	epic.eh_person_identity pi	
		WHERE    
			pi.entity_id =  p_entity_id
			AND pi.code_name_type != 'MAS';
		
vAlias epic.epic_col_types.varchar_2000%type;
  
BEGIN	
	OPEN curAlias;
		FETCH curAlias into vAlias;
	RETURN vAlias;
	CLOSE curAlias;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_AlienNum
	(p_entity_id	in	EPIC.eh_person_identity.entity_id%type)

/*
Purpose: Returns an inmates alien number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
		
RETURN VARCHAR2
IS  v_Alien			EPIC.eh_offender_ids.fbi_id%type;

	CURSOR curAlien IS
	SELECT	o.fbi_id
	
	FROM	EPIC.eh_offender_ids o
	
	WHERE	o.entity_id = p_entity_id;			


BEGIN	

	OPEN curAlien;
		FETCH curAlien into v_Alien;
	CLOSE curAlien;
		
	RETURN v_Alien;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_alphabin
	(p_entity_id	IN	epic.eh_booking.entity_id%TYPE) 
	
--This was for testing purposes only and is not correct/valid
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN epic.otk_property_bin.bin_number%TYPE
IS

	CURSOR curBin IS
		SELECT DISTINCT b.bin_number
		
 		FROM 	epic.otk_property_bin b,
				epic.eh_property_item i,
				epic.eh_offender_property p
				
		WHERE	p.entity_id = p_entity_id
	  			AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id;
	   
vBin	epic.otk_property_bin.bin_number%TYPE;
	
BEGIN

	OPEN curBin;
	FETCH curBin INTO vBin;
	if curbin%found then
	    close curbin;
	    return vbin;
	end if;    
	CLOSE curBin;
	--not found in either, return 'no unit'
return '-No Bin-';  --11-10-04 dlk added to return No Bin rather than blank in report like -No Cell- or -No Housing-.
--RETURN vBin;
	
END;
	
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_alphabin_current
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE)

/*
Purpose: Returns an inmates most current property bin number

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN EPIC.otk_property_bin.bin_number%TYPE
IS

	CURSOR curBin IS
		SELECT  DISTINCT b.bin_number
		
 		FROM 	EPIC.otk_property_bin b,
				EPIC.eh_property_item i,
				EPIC.eh_offender_property p
				
		WHERE	p.entity_id = p_entity_id
	  			AND i.item_id = p.item_id
	  			AND b.bin_id = i.bin_id
	  			AND i.action_time = ((SELECT DISTINCT max (i.action_time)
 						FROM 	EPIC.otk_property_bin b,
								EPIC.eh_property_item i,
								EPIC.eh_offender_property p
    					WHERE	p.entity_id = p_entity_id
	  					AND i.item_id = p.item_id
	  					AND b.bin_id = i.bin_id));
	   
vBin	EPIC.otk_property_bin.bin_number%TYPE;
	
BEGIN

	OPEN curBin;
	FETCH curBin INTO vBin;
	if curbin%found then
	    close curbin;
	    return vbin;
	end if;    
	CLOSE curBin;
	--not found in either, return 'no unit'
return '-No Bin-';  --11-10-04 dlk added to return No Bin rather than blank in report like -No Cell- or -No Housing-.
--RETURN vBin;
	
END;
	
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_alphacharge
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns an inmate's most serious, most current charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	


RETURN EPIC.epic_statutes.statute_description%type
IS

	CURSOR curCharge IS
		SELECT 	es.statute_description,
 		   		decode(es.code_statute_class,'FEL',1,2) as Idx

		FROM	EPIC.epic_statutes es,
				EPIC.eh_charge ec
	
		WHERE 	ec.booking_id = p_booking_id
			  and ec.charge_state <> 6
			  and es.statute_id = ec.statute_id
		ORDER BY Idx;  
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_description%type;
	
BEGIN
	OPEN curCharge;
	FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
	vchgscrpt := vChargeRec.statute_description;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_apt_nbr
	(p_entity_id	in		epic.eh_address.entity_id%type)
	
/*
Purpose: Returns the flat_no_or_floor_level (apt number) of an inmate's most current address 
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				
*/	

RETURN VARCHAR2 AS

v_apt_nbr		varchar2(128);

	CURSOR cur_apt_nbr IS
		SELECT
			a.flat_no_or_floor_level
		FROM
		 	epic.eh_address a

		WHERE    
			a.entity_id =  p_entity_id
			
		ORDER BY decode(a.primary_flag,'Y', 1,2), a.date_from desc;
		
  
BEGIN
	OPEN cur_apt_nbr;
		FETCH cur_apt_nbr INTO v_apt_nbr;
	CLOSE cur_apt_nbr;
			
RETURN v_apt_nbr;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_area_code
	(p_entity_id	in		epic.eh_address.entity_id%type)  
	

--Returns the area code of an inmate's most current telephone number
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_code		epic.eh_telephone_records.area_code%type;

	CURSOR cur_code IS
		SELECT
			t.area_code
		FROM
		 	epic.eh_telephone_records t,
		 	epic.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_code;
		FETCH cur_code INTO v_code;
	CLOSE cur_code;
			
RETURN v_code;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_area_code_primary
	(p_entity_id	in		epic.eh_address.entity_id%type)  
	

--Returns the area code of an inmate's most current telephone number
--Cloned area_code to include condition 'Primary_flag = 'Y' or ' ' KJH
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_code		epic.eh_telephone_records.area_code%type;

	CURSOR cur_code IS
		SELECT
			t.area_code
		FROM
		 	epic.eh_telephone_records t,
		 	epic.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			and (t.primary_flag = 'Y' or t.primary_flag = ' ')
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_code;
		FETCH cur_code INTO v_code;
	CLOSE cur_code;
			
RETURN v_code;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_arresttype
 (p_charge_id		in		EPIC.eh_charge.charge_id%type)

/*
Purpose: Returns the arrest type for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
 
RETURN VARCHAR2 AS

	CURSOR cur_arrest IS
		SELECT	
			substr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),1,1) || substr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),instr(EPIC.ef_lookup_text('ARREST REASON', c.arrest_reason, 'UC'),' ')+1,1)
		FROM
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id;
	                                      
vArrest  VARCHAR2(2);

BEGIN
    OPEN cur_arrest;
		FETCH cur_arrest INTO vArrest;
	CLOSE cur_arrest;
	
RETURN vArrest;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Bailable
	 (p_charge_id 	IN 	epic.eh_charge.charge_id%TYPE)  
	 
--Returns a Y/N flag based on the bail condition of the charge
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT	b.is_bailable

	FROM	epic.eh_bail_condition b,
			epic.eh_charge c
	
	WHERE	c.booking_id = b.booking_id
			and c.charge_id = p_charge_id;	
     
vBail 	epic.eh_bail_condition.is_bailable%TYPE;

BEGIN
  	OPEN curBail;
  		FETCH curBail INTO vBail;
  	CLOSE curBail;

RETURN vBail; 
	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_BailAmount
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the bail amount

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 01/23/06		Created 
					J. McBratnie 02/08/06       Updated function to remove the ref to the 
					                            eh_charge table it serves no use.
					DLK          03/09/06       ADDED THE EPIC NOTATION 
					R. Stuve	 04/06/06		Verified MACOMB/EPIC schema
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT 	b.cash_only_bail_amount 
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc--,
			--eh_charge c
			
	WHERE	p_charge_id /*c.charge_id*/ = bc.charge_id
			and bc.bail_condition_id = b.bail_condition_id
			and bc.charge_id = p_charge_id;
     
     
vBail	 EPIC.eh_bail_condition.cash_only_bail_amount%TYPE;


BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_BailPaid
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 
	 
--Returns a 'Y' flag if the bail has been paid; a 'N' flag if the bail has not been paid
	 
RETURN VARCHAR2 AS
  CURSOR curBail IS 
  	SELECT 	b.is_satisfied
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
	WHERE	c.charge_id = bc.charge_id
			and bc.bail_condition_id = b.bail_condition_id
			and bc.charge_id = p_charge_id;
     
     
vBail	 EPIC.eh_bail_condition.is_satisfied%TYPE;


BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN vBail;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Bail_10Percent_Amount
	 (p_BAIL_CONDITION_ID 	in 	epic.EH_BAIL_CONDITION_CHARGE.BAIL_CONDITION_ID%TYPE) 
/*	
	System: 		WEB
	Purpose:		Return other attribute "10 percent bond" based on bail_condition_id 

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/10/06       Created function 
					
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBailReduced IS 
  	SELECT 	epic.EF_GET_ATTRIBUTE_VALUE('10 PERCENT BOND',bail_condition_id) 
  	
	FROM 	--epic.eh_bail_condition b,
			epic.eh_bail_condition_charge bc--,
			--epic.eh_charge c
			
	WHERE	p_BAIL_CONDITION_ID /*c.charge_id*/ = bc.BAIL_CONDITION_ID;
			--and bc.bail_condition_id = b.bail_condition_id
			--and bc.charge_id = p_charge_id;
     
     
vBailReducable	 varchar2(16);


BEGIN
  	OPEN curBailReduced;
  	FETCH curBailReduced INTO vBailReducable;
  	CLOSE curBailReduced;

  	RETURN NVL (vBailReducable, 'NO');
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Bail_Total_Amount
	 (p_booking_id 	in 	epic.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total bail amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/08/06       created
					
*/  	 
RETURN VARCHAR2 AS
  CURSOR curBail IS   	
  SELECT 	b.booking_id, sum(b.cash_only_bail_amount)
	FROM 	epic.eh_bail_condition b
   WHERE	p_booking_id = b.BOOKING_ID
group by    booking_id;

vBail	 epic.eh_bail_condition.cash_only_bail_amount%TYPE;
vbook    epic.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN
  	OPEN curBail;
  	FETCH curBail INTO vbook, vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_birthcity 
	(p_entity_id		in		EPIC.eh_person_identity.entity_id%type) 

/*
Purpose: Returns the city of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2
IS

v_city		EPIC.eh_person_identity.code_birthplace_city%type;

	CURSOR cur_city IS
		SELECT
			i.code_birthplace_city
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_city;
		FETCH cur_city INTO v_city; 
			IF (cur_city%notfound or v_city = '_NOSP' or v_city is null) THEN
				v_city := 'UNKNOWN';
			END IF;	
	CLOSE cur_city;
			
RETURN v_city;

END; 
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_birthcountry 
	(p_entity_id				in		EPIC.eh_person_identity.entity_id%type)
	
/*
Purpose: Returns the country of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2
IS

v_country		EPIC.eh_person_identity.birth_country%type;

	CURSOR cur_country IS
		SELECT
			i.birth_country
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_country;
		FETCH cur_country INTO v_country; 
	CLOSE cur_country;
			
RETURN EPIC.ef_lookup_text('COUNTRY', v_country, 'UC');

END; 
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_birthstate 
	(p_entity_id		in		EPIC.eh_person_identity.entity_id%type)
	
/*
Purpose: Returns the state of an inmates birth
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
RETURN VARCHAR2
IS

v_state		EPIC.eh_person_identity.birth_state%type;

	CURSOR cur_state IS
		SELECT
			i.birth_state
		FROM
		 	EPIC.eh_person_identity i	
		WHERE    
			i.entity_id =  p_entity_id
			and i.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_state;
		FETCH cur_state INTO v_state; 
	CLOSE cur_state;
			
RETURN NVL (v_state, 'UNKN');

END; 
--RAS
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_booking_id_frm_sent (
	p_sentence_id           in      epic.EH_sentence.sentence_id%type)
return epic.eh_charge.charge_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	v_id					epic.eh_charge.charge_id%type;
	cursor cur_id is
		select c.booking_id
		from epic.eh_charge c
		where c.sentence_id = p_sentence_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_booking_id_frm_sent ;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_book_date
	(p_entity_id	in		epic.eh_booking.entity_id%type)   
	
/*	
	System: 		Unknown
	Purpose:		
	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 

RETURN VARCHAR2 AS

v_book_id			epic.eh_booking.booking_id%type;

	CURSOR cur_booking IS
		select
			bk.booking_id 
			from epicaudit.eh_booking bk
			where bk.entity_id = p_entity_id
			and bk.sentence_start_date >= epic.ef_min_date('2005061100:00:00-240')
  			and bk.end_date > epic.ef_max_date('2005080300:00:00-240')
  			and bk.end_date < epic.ef_min_date('2005080900:00:00-240');
BEGIN
	OPEN cur_booking;
		FETCH cur_booking INTO v_book_id;
	 	CLOSE cur_booking;	
			
RETURN v_book_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_book_id
	(p_entity_id	in		epic.eh_booking.entity_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_booking_id				epic.eh_booking.booking_id%type;

	CURSOR cur_id IS
		select
			bk.booking_id  
			from epic.eh_booking bk
			where bk.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_id;
		FETCH cur_id INTO v_booking_id;
	 	CLOSE cur_id;	
			
RETURN v_booking_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CaseNumber
	 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the case number of the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curCaseNumber IS 
  	SELECT  c.case_number
  	
	FROM 	EPIC.eh_case c, 
			EPIC.eh_case_charge cc,
			EPIC.eh_charge ch
			
	WHERE	ch.charge_id = cc.charge_id
			and cc.case_id = c.case_id
			and ch.charge_id = p_charge_id;
	     
     
vCaseNumber	 EPIC.eh_case.case_number%TYPE;


BEGIN
  	OPEN curCaseNumber;
  		FETCH curCaseNumber INTO vCaseNumber;
  	CLOSE curCaseNumber;

  	RETURN vCaseNumber;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_chargedesc
 (p_statute_id			in		EPIC.eh_charge.statute_id%type)

/*
Purpose: Returns the statute text for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
 
RETURN EPIC.epic_statutes.statute_description%type
IS

	CURSOR cur_result IS
		SELECT	
			distinct es.statute_description
		FROM
			EPIC.epic_statutes es, 
			EPIC.epic_codes ec
		WHERE
			es.statute_id = p_statute_id
			and ec.code_id = es.code_id;
	                                      
vStatute EPIC.epic_statutes.statute_description%type;

BEGIN
    OPEN cur_result;
		FETCH cur_result INTO vStatute;
	CLOSE cur_result;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_chargeidfrom_Bail (
	p_BAIL_CONDITION_ID			in		epic.EH_BAIL_CONDITION.BAIL_CONDITION_ID%type)
return epic.EH_BAIL_CONDITION_CHARGE.CHARGE_ID%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value from BAIL_CONDITION_ID
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	v_id					epic.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select bcc.charge_id
		from   epic.EH_BAIL_CONDITION_CHARGE bcc
		where  bcc.BAIL_CONDITION_ID = p_BAIL_CONDITION_ID;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_chargeidfrom_caseid (
	p_case_id				in		epic.eh_case_court.case_id%type)
return epic.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value from case_id
--
/*	
	System: 		Unknown
	
	Purpose:		
	
	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	v_id					epic.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select cc.charge_id
		from   epic.EH_CASE_CHARGE cc
		where  cc.case_id = p_case_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ChargeStatusCode
	(p_charge_id		in	epic.eh_charge.charge_id%type,
	 p_StartDate		in	epic.eh_charge.action_time%type) 
	 
--Returns the charge status at the selected time   
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS                                 

	v_max_date		varchar2(20);

	CURSOR curCode IS
		SELECT	ga.attribute_value
		
		FROM 	epicaudit.eh_generic_attribute ga
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				and ga.item_id = p_charge_id
				and ga.action_time <= v_max_date
				and not exists
					(select 1 
					from epicaudit.eh_generic_attribute ga2
					where ga2.item_id = ga.item_id
					and ga2.action_time < v_max_date
					and ga2.action_time > ga.action_time)
UNION ALL

		SELECT 	ga.attribute_value
		
		FROM 	epicaudit.eh_generic_attribute ga
		
		WHERE 	ga.item_id = p_charge_id  
				and ga.action_time <= v_max_date
				and not exists
					(select 1
					 from epicaudit.eh_generic_attribute ga2
					 where ga2.item_id = ga.item_id
					 and ga2.action_time < v_max_date);

				
vCode	epic.eh_generic_attribute.attribute_value%type;

BEGIN                

	v_max_date := epic.ef_max_date(p_StartDate);
	OPEN curCode;
		FETCH curCode INTO vCode;
	CLOSE curCode;
	
RETURN vCode;
	
END;
--RAS
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_charge_end_date(
		p_charge_id				EPIC.eh_charge.charge_id%type
		)
return EPIC.eh_charge.action_time%type

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

is

	cursor cur_charge_date is
		select
			c.action_time
		from
			EPICAUDIT.eh_charge c
		where
			charge_id = p_charge_id
			and charge_state = '6'
		order by
			action_time;
	v_date		EPIC.eh_charge.action_time%type;

begin
	open cur_charge_date;
	fetch cur_charge_date into v_date;
	close cur_charge_date;
	return v_date;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_charge_id_frm_sent (
	p_sentence_id           in      epic.EH_sentence.sentence_id%type)
return epic.eh_charge.charge_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's charge_id value
--
/*	
	System: 		Unknown
	Purpose:		
	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	v_id					epic.eh_charge.charge_id%type;
	cursor cur_id is
		select c.charge_id
		from epic.eh_charge c
		where c.sentence_id = p_sentence_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_charge_id_frm_sent ;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_charge_sent_released
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
--Returns the charge_id if booking_entity_status has been '02 - Sentenced' and '01- Released'	 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS
v_Sent		epic.eh_charge.charge_id%type;
  CURSOR cur_Sent IS 

SELECT 	MAX(chg.charge_id) 
  	 FROM 	epic.eh_charge chg
  	 		
	WHERE	p_booking_id = chg.booking_id and				       
			chg.charge_state = '6' and
			chg.disposition_reason = '001' and
			chg.booking_id in
			(select chg.booking_id
				from epic.eh_booking_entity_status bk JOIN epic.eh_booking_entity_status bk2					 
				on (bk.booking_id = bk2.booking_id),
				epic.eh_charge chg	
				where
				chg.booking_id = bk.booking_id and 
				(bk.code_entity_status = '01' AND bk2.code_entity_status = '02'));
BEGIN
	OPEN cur_Sent;
		FETCH cur_Sent INTO v_Sent;
	 	CLOSE cur_Sent;	
			
RETURN v_Sent;
END;
--KJH				
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_charge_start_date(
		p_charge_id				EPIC.eh_charge.charge_id%type
		)
return EPIC.eh_charge.action_time%type

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

is

	cursor cur_charge_date is
		select
			c.action_time
		from
			EPICAUDIT.eh_charge c
		where
			charge_id = p_charge_id
			and charge_state <> '6'
		order by
			action_time;
	v_date		EPIC.eh_charge.action_time%type;

begin
	open cur_charge_date;
	fetch cur_charge_date into v_date;
	close cur_charge_date;
	return v_date;
end;
--maz 
-- per bob closes way to get date - time stamp for charges use epicaudit (initial record)
-- another way would be to use an attribute
-- another way is use booking start date - no because the charge is added later...(mz)
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CheckInmate
	(p_trans		in		epic.eh_trust_account_trans.trust_account_trans_id%type)
	
--For testing only: returns the inmate's name belonging to the trust account transaction/id (not currently used)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/RETURN epic.epic_col_types.varchar_255%type
IS
	CURSOR curInmate IS
		SELECT
			epic.ef_get_personororgname(ta.entity_id)
		FROM
			epic.eh_trust_account ta,
			epic.eh_trust_account_trans tat
		WHERE
			tat.trust_account_id = ta.trust_account_id
			and tat.trust_account_trans_id = p_trans;
	                                      
	vInmate epic.epic_col_types.varchar_255%type;

BEGIN
    OPEN curInmate;
		FETCH curInmate INTO vInmate;
	CLOSE curInmate;
	
RETURN vInmate;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ChrgCirCt
	 (p_entity_id IN epic.eh_entity_person.entity_id%TYPE)  
	 
--Returns 'Y' if an inmate has at least one charge in circuit court; otherwise, returns a 'U'
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'Y' 
  	
    FROM 	epic.eh_active_booking b,
			epic.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state <> 6
			and b.entity_id = p_entity_id
     		and mcmb_fnt_CourtName (c.charge_id) ='16TH CIRCUIT COURT' ;
     
v_status epic.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is not a '6' (Disposed):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a circuit court charge, 'v_status' will be set to 'Y', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--gAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_citizenship
	(p_entity_id		in		epic.eh_entity_person.entity_id%type)
	
--Returns an inmate's citizenship
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2
IS

v_citizen	epic.eh_citizenship.country_code%type;

	CURSOR cur_citizenship IS
		SELECT
			c.country_code
		FROM
		 	epic.eh_citizenship c	
		WHERE    
			c.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_citizenship;
		FETCH cur_citizenship INTO v_citizen;
	CLOSE cur_citizenship;
			
RETURN epic.ef_lookup_text('COUNTRY', v_citizen, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ClassLevel
	(p_location_id		in	EPIC.eh_housing_assignments.location_id%type,
	 p_StartDate		in	EPIC.eh_housing_assignments.action_time%type,
	 p_level			in	char)

/*
Purpose: Returns the classification level of the selected cell at the selected time.  
		Uses inputs of either 'L' for the low classification or 'H' for the high classification

	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS 
	CURSOR curLoc IS
		SELECT	decode (p_level,'L', loc.classification_low,'H',loc.classification_high)
		
		FROM	EPICAUDIT.epic_locations loc
		
		WHERE  	EPIC.ef_epic_date_to_date(loc.action_time) <= EPIC.ef_epic_date_to_date(p_StartDate)
				and not exists (
					select 	1
					from 	EPICAUDIT.epic_locations loc2
					where 	loc2.location_id = loc.location_id
							and EPIC.ef_epic_date_to_date(loc2.action_time) < EPIC.ef_epic_date_to_date(p_StartDate)
							and EPIC.ef_epic_date_to_date(loc2.action_time) > EPIC.ef_epic_date_to_date(loc.action_time)
								)
				and loc.location_id = p_location_id;
				
vLoc	EPIC.epic_locations.classification_low%type;

BEGIN
	OPEN curLoc;
		FETCH curLoc INTO vLoc;
	CLOSE curLoc;
	
RETURN vLoc;
	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ClassYN
	 (p_booking_id IN EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'YES' flag if the inmate has an active classification

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curClass IS   	
  	SELECT 	'YES'

    FROM 	EPIC.eh_booking b,
			EPIC.eh_security_classification s

	WHERE	b.booking_id = s.booking_id
			and b.booking_id = p_booking_id;	
     
    
v_class	EPIC.eh_security_classification.classification%type;


BEGIN
	-- Look for an active classification for the inmate (per the above criteria/query):  
  	OPEN curClass;
  		FETCH curClass INTO v_class;
  	CLOSE curClass;
	-- If we found an active classification, 'v_class' will be set to 'CLD', if not return a null
  	RETURN NVL (v_class, NULL);
  		
END;

--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CntAgy
	 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE)  

/*
Purpose: Returns the controlling agency for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT 	ca.agency_id 
  	
	FROM 	EPIC.eh_charge_agency ca,
			EPIC.eh_charge c,
			EPIC.eh_booking b
			
	WHERE	ca.charge_id = c.charge_id
			and c.booking_id = b.booking_id
			and b.booking_id = p_booking_id;
     
     vAgy	 EPIC.eh_charge_agency.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN EPIC.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_code_chargestatus
	(	p_charge_id		in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the Charge Status code based on the selected charge (queries against 
		 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				K. Heinz 	12/03/09			Created for TC 59319
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		select ga.attribute_value 
		from 
			epic.eh_generic_attribute ga,
			epic.eh_charge c
where  c.charge_id = p_charge_id
and c.charge_id = ga.item_id
and ga.attribute_name = 'CHARGE STATUS' ;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_code_chargestatus_
	(	p_charge_id		in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the Charge Status code based on the selected charge (queries against 
		 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				K. Heinz 	12/03/09			Created for TC 59319
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		select ga.attribute_value 
		from 
			epic.eh_generic_attribute ga,
			epic.eh_charge c
where  c.charge_id = p_charge_id
and c.charge_id = ga.item_id
and ga.attribute_name = 'CHARGE STATUS' ;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Commitmt_Balance
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE) 
/*
Purpose: Returns the current balance of an inmate's trust account

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				K. Heinz 	09/29/06			Cloned and modified mcmb_fnt_InmateFunds for acct 220-Commit only
*/
RETURN EPIC.eh_chart_of_accounts.total_debits%TYPE

IS
vBalance	EPIC.eh_chart_of_accounts.total_debits%TYPE; 
vCommit		EPIC.eh_chart_of_accounts.total_debits%TYPE;

	CURSOR curCommit IS
 select
     --decode(ca4.total_debits,null,0,ca4.total_debits) - decode(ca4.total_credits, null,0,ca4.total_credits)    
     decode(ca.total_credits, null,0,ca.total_credits)  - decode(ca.total_debits,null,0,ca.total_debits) 
      
 from
     EPIC.eh_trust_account ta,
     EPIC.eh_chart_of_accounts ca
 where
     ta.entity_id = p_entity_id
     and ta.code_status <> 'CLOSED'    ---  questionable
     and ca.trust_account_id (+) = ta.trust_account_id
     and (ca.gl_account_number (+) = '220');
	
BEGIN

	OPEN curCommit;
		FETCH curCommit INTO vCommit;
	CLOSE curCommit;
RETURN NVL ( vCommit, 0);
END;

/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_complexion
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the inmate's complexion
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2 AS

v_comp		EPIC.eh_person_snapshot.code_complexion%type;

	CURSOR cur_comp IS
		SELECT
			s.code_complexion
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_comp;
		FETCH cur_comp INTO v_comp;
		CLOSE cur_comp;
			
RETURN EPIC.ef_lookup_text('COMPLEXION', v_comp, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ControlAgy
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the controlling agency for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT  c.agency_id
  	
	FROM 	EPIC.eh_charge_agency c
			
	WHERE	c.charge_id = p_charge_id;
     
     
vAgy	 EPIC.eh_charge_agency.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN EPIC.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CountHolds
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE) 
	 
--Returns a count of the number of active holds an inmate has (not currently used in any reports)
	 
RETURN VARCHAR2 AS
  CURSOR curCount IS   	
  	SELECT 	count(h.hold_id)

    FROM 	EPIC.eh_booking b,
			EPIC.eh_booking_holds h

	WHERE	b.booking_id = h.booking_id
			and ((EPIC.ef_epic_date_to_date(h.hold_removed_date) is null)
					or (EPIC.ef_epic_date_to_date(h.hold_removed_date) > EPIC.ef_epic_date_to_date(sysdate)))
			and b.entity_id = p_entity_id
			
	GROUP BY	b.booking_id;		
     
     
v_count number(3);


BEGIN
	OPEN curCount;
		FETCH curCount into v_count;
	CLOSE curCount;
	
RETURN v_count;
   	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Count_Female_UnSent
	 (p_house       IN EPIC.eh_housing_assignments.LOCATION_ID%TYPE,
	  p_sex         IN EPIC.eh_entity_person.code_gender%TYPE,
	  p_Status      epic.epic_col_types.varchar_255%type ) 
	 
--Returns the number of female, unsentenced inmates that are in General Housing
	 
RETURN VARCHAR2 AS
  CURSOR curCount IS   	
  	SELECT 	count(distinct(b.entity_id))--do I need distinct here?

    FROM 	epic.eh_active_booking b,
    		epic.eh_entity_person  ep,
    		EPIC.eh_housing_assignments h

	WHERE	b.entity_id = ep.entity_id
	and     h.entity_id = ep.entity_id
	and     decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') = p_house
	and     decode(ep.code_gender, '_NOSP','U', ep.code_gender) = p_sex
	and     MACOMB.mcmb_fnt_sentallchgs(b.entity_id) = p_status
			
	GROUP BY	p_house;		
     
     
v_count number(3);


BEGIN
	OPEN curCount;
		FETCH curCount into v_count;
	CLOSE curCount;
	
RETURN v_count;
   	
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CourtDate
		 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns an inmate's next court date for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	ca.appearance_date
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = p_charge_id;
     
     
vCourtDate	 EPIC.eh_court_appearance.appearance_date%TYPE;


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

  	RETURN vCourtDate;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_CourtName
	 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE)

/*
Purpose: Returns the court name for the next court appearance for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 	 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtName IS 
  	SELECT 	ca.court_name
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = p_charge_id;
     
     
vCourtName	 EPIC.eh_court_appearance.court_name%TYPE;


BEGIN
  	OPEN curCourtName;
  		FETCH curCourtName INTO vCourtName;
  	CLOSE curCourtName;

  	RETURN EPIC.ef_lookup_text('COURT NAME', vCourtName, 'UC');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_current_cell_date
	(p_entity_id	in		epic.eh_housing_assignments.entity_id%type)
	
--Returns the latest inmate's housing date (being used for trustee begin date) gas
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN varchar2 as 

v_Date		epic.eh_housing_assignments.action_time%TYPE;

	CURSOR cur_Date IS
		select
	       ha.action_time
	from epic.eh_housing_assignments  ha
	  where ha.entity_id = p_entity_id;
					 
  
BEGIN
	
	OPEN cur_Date;
		FETCH cur_Date INTO v_Date;
	CLOSE cur_Date;
			
RETURN v_Date;

END;
 --gas
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_audit
	(p_booking_id	in		epic.eh_booking.booking_id%type)
	
--Returns an inmate's custody status (eh_booking_custody_status.code_custody_status)
--for a certain booking in the proper time frame
--then converts it to a MACIS tran code, using the epicaudit tables after
--the inmate has been released.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		SELECT
			 bkstat.code_custody_status
		FROM
			 epicaudit.eh_booking_custody_status bkstat
		WHERE
			p_booking_id = bkstat.booking_id and
			bkstat.date_end is null;
					 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202'
			when '10' then '4202'
			when '4' then '4229'
			when '5' then '4201'
			else ''
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_code
	(p_booking_id	in		EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the latest inmate's custody status code (eh_booking_custody_status.code_custody_status)
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

	CURSOR cur_Code IS
		select
	       code_custody_status
	from EPIC.eh_booking_custody_status
	where
	 EPIC.ef_epic_date_to_date(date_start) in
		(select max(EPIC.ef_epic_date_to_date(date_start))
		from EPIC.eh_booking_custody_status
		where booking_id = p_booking_id);
					 
v_Code		varchar2(128);
  
BEGIN
	
	OPEN cur_Code;
		FETCH cur_Code INTO v_Code;
	CLOSE cur_Code;
			
RETURN v_Code;

END;
 --MAZ
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_codet
	(p_booking_id	in		epic.eh_booking.booking_id%type)
	
-- Updated the table this is looking at. - J. McBratnie 12/15/2005
-- Returns the latest inmate's custody status code (eh_booking_custody_status.code_custody_status)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Maryann Zak
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

	CURSOR cur_Code IS
select code_entity_status /*, 
       epic.ef_lookup_text('OFFENDER STATUS',code_entity_status,'UC') */
from epic.eh_entity_status es , epic.eh_active_booking ab 
where es.entity_id = ab.entity_id and
      ab.booking_id = p_booking_id;



/* COMMENTED OUT BY JOE
		select
	       code_custody_status
	from epic.eh_booking_custody_status
	where
	 date_start in
		(select max(date_start)
		from epic.eh_booking_custody_status
		where booking_id = p_booking_id); 
*/		
      
v_Code		varchar2(128);
  
BEGIN
	
	OPEN cur_Code;
		FETCH cur_Code INTO v_Code;
	CLOSE cur_Code;
			
RETURN v_Code;

END;
 --MAZ
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_desc
	(p_lookup_code	in		EPIC.epic_lookups.lookup_code%type)

/*
Purpose: Receives look up code returns description (custody status code description per given code)
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS 
	CURSOR CurCode IS
    	select	el.text_full
    	
		from 	EPIC.epic_lookups el
		
     	where   lookup_class   ='ADMIN STATUS'
				AND el.lookup_code = p_lookup_code;

vDesc	EPIC.epic_lookups.text_full%type;

BEGIN
	OPEN CurCode;
		FETCH CurCode INTO vDesc;
	CLOSE CurCode;

RETURN NVL (vDesc, 'NO DESC');
	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_gvt
	(p_booking_id	in		epic.eh_booking.booking_id%type)
	Return varchar2
AS
--Returns an inmate's custody status using eh_booking_custody_status.code_custody_status or additional attribute 'CHARGE STATUS'
-- then converts it for translation in the GVT interface.  KJH 
/*	
	System: 		Unknown
	Purpose:		
	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	CURSOR cur_Stat IS
		select DISTINCT 'W'           
		from epic.eh_booking_custody_status stat
		where stat.booking_id = p_booking_id 
		AND stat.code_custody_status in ('4','7');
	
Cursor cur_Charge is 
	SELECT	DISTINCT 'W' 
		
		FROM 	EPIC.eh_generic_attribute g,
		            epic.eh_charge chg 
		WHERE        p_booking_id = chg.booking_id
		AND 			chg.charge_id = g.item_id
		and    attribute_name = 'CHARGE STATUS'
		and 			attribute_value = '21';
								 
v_Stat		varchar2(128);
--v_Charge		varchar2(128);	
--v_Return    varchar2(128);

BEGIN
	Open cur_Charge;
		Fetch cur_Charge into v_stat;
		If cur_Charge%NOTFOUND THEN
		    Close cur_Charge;	
			Open cur_Stat;
			Fetch cur_Stat into v_Stat; 
			If cur_Stat%NOTFOUND Then
					Close cur_Stat;
					RETURN NVL (v_stat,'U');
			Else
				Return v_stat;    
		    End if;
	 	    CLOSE cur_Stat;	
	  Else
	   Return v_stat;
	   Close cur_Charge;	
	End if;
--RETURN v_stat;
END;		
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_custody_status_trans
	(p_entity_id	in		epic.eh_person_identity.entity_id%type)
	
--Returns an inmate's entity status using entity_id(eh_entity_status.code_custody_status)
--then converts it to a MACIS tran code..for inmates already released during conversion period
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/RETURN VARCHAR2 AS

	CURSOR cur_Stat IS
		SELECT
			 bkstat.code_custody_status
		FROM
			epic.eh_entity_status bkstat
			 		 	
		WHERE    
			p_entity_id = bkstat.entity_id (+); 
			 
v_Stat		varchar2(128);
v_tran		varchar2(128);	  
  
BEGIN
	
	OPEN cur_Stat;
		FETCH cur_Stat INTO v_Stat;
		v_tran := 
		CASE v_Stat
			when '1' then '4202'
			--when '10' then '4202' (option eliminated 1/06/06 per Lori Dunlop, Green Trusty's are no longer charged Room & Board)
			when '4' then '4229'
			when '5' then '4201'
			else '4202'
		END;
		
	CLOSE cur_Stat;
			
RETURN v_tran;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Cust_Status
	 (p_charge_id 	in 	epic.eh_charge.charge_id%TYPE) 
	 
--Returns the Case Status FOR THE CHARGE
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			g.attribute_value
		FROM
		 	epic.eh_generic_attribute g,
		 	epic.eh_charge c
		WHERE
			g.attribute_name = 'CHARGE STATUS'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;

          
vAgy	 epic.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  		IF curAgy%notfound THEN
				vAgy :='0';
  		end if;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END; 
--gas 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_cust_status_date
	(p_booking_id	in		epic.eh_booking.booking_id%type)
	
--Returns the latest inmate's custody status date (being used for trustee begin date) (eh_booking_custody_status.start_date)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn 
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN epic.EH_BOOKING_CUSTODY_STATUS.DATE_START%TYPE
 IS

	CURSOR cur_Date IS
		select
	       date_start
	from epic.eh_booking_custody_status
	where
	 date_start in
		(select max(date_start)
		from epic.eh_booking_custody_status
		where booking_id = p_booking_id);
					 
v_Date		epic.EH_BOOKING_CUSTODY_STATUS.DATE_START%TYPE;
  
BEGIN
	
	OPEN cur_Date;
		FETCH cur_Date INTO v_Date;
	CLOSE cur_Date;
			
RETURN v_Date;

END;
 --gas
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_datereleased_gvt
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns an inmate's release date i 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_rel_date				epic.eh_booking.final_release_date%type;

	CURSOR cur_rel_date IS
		select
			bk.end_date  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_rel_date;
		FETCH cur_rel_date INTO v_rel_date;
	 	CLOSE cur_rel_date;	
			
RETURN v_rel_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_datesent_gvt
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns an inmate's sentence date  
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_sent_date				epic.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			bk.sentence_start_date  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DispoDate
		(p_charge_id	in		EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the date the selected charge was disposed
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema  
				R. Stuve	10/17/06		Added c.charge_state to account for charges that have been disposed, re-opened
*/		

RETURN		date
IS

	CURSOR curDate IS
		SELECT 	EPIC.ef_epic_date_to_date(ea.action_time)

		FROM 	EPICAUDIT.eh_charge ea,
				EPIC.eh_charge c

		WHERE  	ea.charge_id = c.charge_id
				and ea.charge_state = '6'   --finds most recent dispo date
				and c.charge_state = '6'  --limits to charges that are currently disposed
				and c.charge_id = p_charge_id

		ORDER BY EPIC.ef_epic_date_to_date(ea.action_time) desc;
	
	
	vDate	EPICAUDIT.eh_charge.action_time%type;
	
	
BEGIN
	OPEN curDate;
		FETCH curDate INTO vDate;
	CLOSE curDate;
	
RETURN vDate;
	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_dispodate_1051
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns max action_time for a charge disposed as 1051 Sentenced Weekender"; otherwise, returns a 'U'
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production 					
*/ 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	MAX(chg.action_time) 
  	
    FROM 	epic.eh_charge chg
            
	WHERE	p_booking_id = chg.booking_id and
	        
			chg.charge_state = '6' and
			chg.disposition_reason = '1051' ;
     
v_status  epic.eh_charge.action_time%TYPE;

BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
RETURN NVL (v_status,null);  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_dispodate_sent
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns max action_time if a charge has been sentenced & disposed; otherwise, returns a 'U'
-- Per Sgt. Roberts, the chg.disposition_reasons all include being sentenced  12/09/05 KJH	
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	MAX(chg.action_time) 
  	
    FROM 	epic.eh_charge chg
            
	WHERE	p_booking_id = chg.booking_id and
	        
			chg.charge_state = '6' and
			chg.disposition_reason in
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','TTP','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV');      
     
v_status epic.eh_charge.action_time%type;


BEGIN
	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
RETURN NVL (v_status,'U');
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_disporeason_sent
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns 'S' if a charge has been disposed with a reason that includes being sentenced 
--09/12/06 KJH Removed the commented lines below from process, don't know why I wrote it that way.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	epic.eh_charge chg --JOIN eh_charge chg2
    		--on (chg.booking_id = chg2.booking_id)
			     		
	WHERE	p_booking_id = chg.booking_id
			--and chg2.booking_id = chg.booking_id
			and chg.charge_state = '6' and 
			chg.disposition_reason in ('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','TTP','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV');     
            --above list of dispo reasons modified 12/09/05 per Sgt. Ken Roberts-- documentation in file kjh
v_status epic.eh_charge.charge_state%type;

BEGIN
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_disposedate_max
	(	p_charge_id		in	epic.eh_charge_change.charge_id%type ) 
	
	
--Returns the max date the selected charge was disposed
/*	
	System: 		Unknown
	Purpose:		

	Author:			Maryann Zak
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/

RETURN		epicaudit.eh_charge_change.change_date%type
IS  
	CURSOR curDate IS
	
	select max(epic.ef_epic_date_to_date(cc.change_date)) 
	from epic.eh_charge_change cc
    where cc.charge_id = p_charge_id and cc.charge_event = '8'
   	group by epic.ef_epic_date_to_date(cc.change_date);    


vDate	epicaudit.eh_charge_change.change_date%type; 

BEGIN
	OPEN curDate;
		FETCH curDate INTO vDate;
	CLOSE curDate;
		

RETURN vDate;
	
END;
--MAZ
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_dispotype
	(p_charge_id				in		epic.eh_entity_person.entity_id%type) 
	
--Returns the reason for charge disposition
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	
RETURN VARCHAR2
IS		v_dispo			epic.eh_charge.disposition_reason%type;

	CURSOR cur_dispo IS
		SELECT	c.disposition_reason	
		
		FROM	epic.eh_charge c
		
		WHERE 	c.charge_id = p_charge_id;
  
BEGIN
	OPEN cur_dispo;
		FETCH cur_dispo INTO v_dispo;
	CLOSE cur_dispo;
			
	RETURN epic.ef_lookup_text('DISPOSITION REASONS', v_dispo, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DistVenue
	 (p_charge_id 	in 	epic.eh_charge.charge_id%TYPE) 
	 
--Returns the DIST VENUE FOR THE CHARGE
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			g.attribute_value
		FROM
		 	epic.eh_generic_attribute g,
		 	epic.eh_charge c
		WHERE
			g.attribute_name = 'DIST VENUE'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;

          
vAgy	 epic.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  		IF curAgy%notfound THEN
				vAgy :='0';
  		end if;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END; 
--gas 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DOB
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns an inmate's Date of Birth

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				M. Zak		11/14/05		Modified in OTMAIN
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_DOB				EPIC.eh_person_identity.date_of_birth%type;

	CURSOR cur_DOB IS
		SELECT
			p.date_of_birth
		FROM
		 	EPIC.eh_person_identity p,
		 	EPIC.eh_entity_person ep  -- 8-19-05 MZak  added to resolve dob problem of multiple 'Master' inmate entries
		WHERE    
			p.entity_id =  p_entity_id
			and p.code_name_type = 'MAS'    --8-19-05 MZak
			and p.entity_id = ep.entity_id  --8-19-05 MZak
			and p.identity_id = ep.primary_identity_id;  --8-19-05 MZak
  
BEGIN
	OPEN cur_DOB;
		FETCH cur_DOB INTO v_DOB;
	 	CLOSE cur_DOB;	
			
RETURN EPIC.ef_epic_date_to_date(v_DOB);
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DOB_gvt_format
	(p_entity_id	in		epic.eh_entity_person.entity_id%type)   
	
--Returns an inmate's Date of Birth in the MM/DD/YYYY format for the GVT file
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_DOB				epic.eh_person_identity.date_of_birth%type;

	CURSOR cur_DOB IS
		SELECT
			p.date_of_birth
		FROM
		 	epic.eh_person_identity p
		WHERE    
			p.entity_id =  p_entity_id
			and p.code_name_type = 'MAS';
  
BEGIN
	OPEN cur_DOB;
		FETCH cur_DOB INTO v_DOB;
	 	CLOSE cur_DOB;	
			
RETURN to_char(epic.ef_epic_date_to_date(v_DOB),'MM/DD/YYYY');
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_double_desc_flag
	(	p_entity_id		in	epic.eh_PERSON_IDENTITY.entity_id%type)
-- This is to locate the double descriptor awaiting release to be merged.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			max(epic.EF_EPIC_DATE_TO_DATE(g.attribute_value))
		FROM
		 	epic.eh_generic_attribute g,
		 	epic.eh_person_identity pi
		WHERE
			(g.attribute_name = 'DOUBLE DESCRIPTOR'  )
			and g.item_id = pi.identity_id
			and pi.entity_id = p_entity_id;

          
vAgy	 epic.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  		IF curAgy%notfound THEN
				vAgy :='';
  		end if;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END;       
--gas 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DrvChg
		(p_entity_id	in		epic.eh_booking.entity_id%type)
		
--Returns the statute description for the Driving Charge (The charge with the most current outdate, then the highest bond amount,
--and then the charge entered into the system first)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN		epic.epic_statutes.statute_description%type
IS

	CURSOR curDrvChg IS
		SELECT	mcmb_fnt_chargedesc(ch.statute_id),
				od.unpaid_out_date as ODate,
				mcmb_fnt_BailAmount(ch.charge_id) as Bond,
				cha.action_time as ActionTime
				
		FROM	epic.eh_booking bk,
				epic.eh_charge ch,
				epic.eh_sentence_out_dates od,
				epicaudit.eh_charge cha
				
		WHERE	bk.entity_id = p_entity_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = od.sentence_id (+)
				and ch.charge_id = cha.charge_id
				and ch.charge_state <> '6'
				and not exists
					(select 1 from epicaudit.eh_charge cha2
					where cha.charge_id = cha2.charge_id
					and cha2.action_time < cha2.action_time)				  
					
		ORDER BY ODate desc, Bond desc, ActionTime asc;
	
	
	vChg	epic.epic_statutes.statute_description%type;
	vDate	epic.eh_sentence_out_dates.unpaid_out_date%type;
	vBond	epic.eh_bail_condition.cash_only_bail_amount%type;
	vTime	epicaudit.eh_charge.action_time%type;
	
	
BEGIN
	OPEN curDrvChg;
		FETCH curDrvChg INTO vChg, vDate, vBond, vTime;
	CLOSE curDrvChg;
	
RETURN vChg;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DrvChgID
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)    

/*
Purpose: Returns the statute number for the Driving Charge (The charge with the most current outdate, 
		 then the highest bond amount, and then the charge entered into the system first)  

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	 		

RETURN		EPIC.eh_charge.charge_id%type
IS

	CURSOR curDrvChg IS
		SELECT	EPIC.ef_epic_date_to_date(od.unpaid_out_date) as ODate,
				MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as Bond,
				cha.action_time as ActionTime,
				ch.charge_id as ChargeID
				
		FROM	EPIC.eh_booking bk,
				EPIC.eh_charge ch,
				EPIC.eh_sentence_out_dates od,
				epicaudit.eh_charge cha
				
		WHERE	bk.entity_id = p_entity_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = od.sentence_id (+)
				and ch.charge_id = cha.charge_id 
				and ch.charge_state <> '6'
				and not exists
					(select 1 from epicaudit.eh_charge cha2
					where cha.charge_id = cha2.charge_id
					and EPIC.ef_epic_date_to_date(cha.action_time) < EPIC.ef_epic_date_to_date(cha2.action_time))			-- changed to chs vs. cha2	  
					
		ORDER BY ODate desc, Bond desc, ActionTime asc;
	
	
	vDate	EPIC.eh_sentence_out_dates.unpaid_out_date%type;
	vBond	EPIC.eh_bail_condition.cash_only_bail_amount%type;
	vTime	epicaudit.eh_charge.action_time%type; 
	vID		EPIC.eh_charge.charge_id%type;
	
	
BEGIN
	OPEN curDrvChg;
		FETCH curDrvChg INTO vDate, vBond, vTime, vID;
	CLOSE curDrvChg;
	
RETURN vID;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_DrvChg_dlk
		(p_entity_id	in		epic.eh_booking.entity_id%type)
		
--Returns the statute description for the Driving Charge (The charge with the most current outdate, then the highest bond amount,
--and then the charge entered into the system first)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN		epic.epic_statutes.statute_description%type
IS

	CURSOR curDrvChg IS
		SELECT	mcmb_fnt_chargedesc(ch.statute_id),
				--od.unpaid_out_date as ODate,
				--mcmb_fnt_BailAmount(ch.charge_id) as Bond,
				cha.action_time as ActionTime
				
		FROM	epic.eh_booking bk,
				epic.eh_charge ch,
				epic.eh_sentence_out_dates od,
				epicaudit.eh_charge cha
				
		WHERE	bk.entity_id = p_entity_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = od.sentence_id (+)
				and ch.charge_id = cha.charge_id
				and ch.charge_state <> '6'
				and not exists
					(select 1 from epicaudit.eh_charge cha2
					where cha.charge_id = cha2.charge_id
					and cha2.action_time < cha2.action_time)				  
					
		ORDER BY ActionTime asc;
	
	
	vChg	epic.epic_statutes.statute_description%type;
	--vDate	eh_sentence_out_dates.unpaid_out_date%type;
	--vBond	eh_bail_condition.cash_only_bail_amount%type;
	vTime	epicaudit.eh_charge.action_time%type;
	
	
BEGIN
	OPEN curDrvChg;
		FETCH curDrvChg INTO vChg, vTime;
	CLOSE curDrvChg;
	
RETURN vChg;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_drvlicense
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns an inmate's driver's license number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2 AS

v_lic		EPIC.eh_operators_license.drivers_license_number%type;

	CURSOR cur_lic IS
		SELECT
			l.drivers_license_number
		FROM
		 	EPIC.eh_operators_license l	
		WHERE    
			l.entity_id =  p_entity_id; 
  
BEGIN
	OPEN cur_lic;
		FETCH cur_lic INTO v_lic;
		CLOSE cur_lic;
			
RETURN v_lic;

END;
--RAS 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_drvlicense_primary
	(p_entity_id		in		epic.eh_entity_person.entity_id%type)
	
--Returns an inmate's driver's license number
-- KJH Cloned drvlicense to add condition 'Primary_dl' 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	
RETURN VARCHAR2 AS

v_lic		epic.eh_operators_license.drivers_license_number%type;

	CURSOR cur_lic IS
		SELECT
			l.drivers_license_number
		FROM
		 	epic.eh_operators_license l	
		WHERE    
			l.entity_id =  p_entity_id; 
  
BEGIN
	OPEN cur_lic;
		FETCH cur_lic INTO v_lic;
		CLOSE cur_lic;
			
RETURN v_lic;

END;
--RAS 
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_ef_location_count (	-- 1997-2003 Motorola
	p_location_id			in		epic.epic_locations.location_id%type,
	p_code_gender			in		epic.eh_entity_gender.code_gender%type)
return epic.epic_col_types.number_9%type
is 
/*	
	System: 		Unknown
	Purpose:		

	Author:			A. ZDYBEL
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
-- THIS FUNCTION IS USED BY THE VACANT BED REPORT MAINFRAME 357 IT IS RENAMED	
-- AND SAVED HERE TO PREVENT MOTOROLA FROM CHANGING OR DELETING IT	
-- A. ZDYBEL 7/30/2004  
--
--	29 Dec 2003, K Crosser
--		Treat levels 2-4 specially for performance
--			If facility, count using EH_MUSTER directly.
--			If above, count by recursions to facilities under that level
--			If below facility, count using housing links
--
-- 	Cousar 5/24/01
-- 		1. Link to eh_entity_gender rather than use ep_entity_person.code_gender. (Why is the data duplicated ?)
--		2. Added the 3rd and 4th union clauses to account for inmates on count with no housing assignment.
-- 		(This situation should never happen under normal circumstances, but...)
-- 		3. Created a unique index on eh_housing_assignments entity_id, location_id and muster_display_flag to prevent table scan.
-- 		4. Created a unique index on eh_muster entity_id and code_gender to prevent table scan.
-- 		5. Rewrote the function to do 'select count where gender = parameter', rather than 'select all on count, then loop through
--		resultset and count all of a particular gender'.
--	26 Jan 2000, K Crosser
--		Return count of specified gender at the specified unit
--		If gender record not found, or 'U'nknown, add to Male count
--		If "p_code_gender" is null, returns total count for unit, regardless of gender
--	12 Sept 2000, D Mitchell
--		Change eh_unit_assignments to eh_housing_Assignments,
--		re-name to ef_man_count_Housing
--	12 Sept 2000, K Crosser
--		Return "count" of all offenders of specified gender at or below the specified
--		location
--	Used by RPT_PopCount_Proc
--
	cs_mod					constant varchar2(255) := 'ef_location_count';
	cbDebug					constant boolean := false;
	v_count					epic.epic_col_types.number_9%type;
	v_level					epic.epic_locations.location_level%type;
	v_parent_facility		epic.eh_muster.facility_id%type;
	v_gender				epic.eh_entity_gender.code_gender%type := null;
	--
	--	cursor to get level of passed in location
	--
	cursor cur_level is
		select location_level
		from epic.epic_locations
		where location_id = p_location_id;
	--
	--	cursor to get all level-4 locations (facilities)
	--		under the passed in location
	--
	cursor cur_child_facilities is
		select elc.child_location_id
		from epic.epic_location_child elc
		where elc.location_id = p_location_id
			and elc.child_location_level = 4;
	--
	--	cursor to get the parent facility of a location
	--
	cursor cur_parent_facility is
		select elc.location_id
		from epic.epic_location_child elc
		where elc.child_location_id = p_location_id
			and elc.location_level = 4;
	--
	--	cursor to count all persons of the specified gender at a facility
	--
	cursor cur_count_gender_facility (p_gender in epic.eh_entity_gender.code_gender%type) is
		select nvl(eg.code_gender, 'x') as theGender
		from
			epic.eh_muster em,
			epic.eh_entity_gender eg
		where
			em.facility_id = p_location_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = em.entity_id;
	--
	--	cursor to count all persons at a facility
	--
	cursor cur_count_all_facility is
		select count(*) as thecount
		from
			epic.eh_muster em
		where
			em.facility_id = p_location_id
			and em.in_muster_flag = 'Y';
	--
	--	cursor to count all persons of a specified gender at a location below a facility
	--
	cursor cur_count_gender_below (p_gender in epic.eh_entity_gender.code_gender%type) is
		--	count people housed at this location
		select nvl(eg.code_gender, 'x') as theGender
		from
			epic.eh_housing_assignments ha,
			epic.eh_muster em,
			epic.eh_entity_gender eg
		where
			em.facility_id = v_parent_facility
			and ha.location_id = p_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = ha.entity_id
		union all
		--	count people housed below this location
		select nvl(eg.code_gender, 'x') as theGender
		from
			epic.eh_housing_assignments ha,
			epic.epic_location_child elc,
			epic.eh_muster em,
			epic.eh_entity_gender eg
		where
			em.facility_id = v_parent_facility
			and elc.location_id = p_location_id
			and ha.location_id = elc.child_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
			and eg.entity_id(+) = ha.entity_id;
	--
	--	cursor to count all persons at a location below a facility
	--
	cursor cur_count_all_below is
		--	count people housed at this location
		select count(*) as thecount
		from
			epic.eh_housing_assignments ha,
			epic.eh_muster em
		where
			em.facility_id = v_parent_facility
			and ha.location_id = p_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y'
		union all
		--	count people housed below this location
		select count(*) as thecount
		from
			epic.eh_housing_assignments ha,
			epic.epic_location_child elc,
			epic.eh_muster em
		where
			em.facility_id = v_parent_facility
			and elc.location_id = p_location_id
			and ha.location_id = elc.child_location_id
			and ha.muster_display_flag = 'Y'
			and em.entity_id = ha.entity_id
			and em.in_muster_flag = 'Y';
	--
	--	function to increment counter if this is the correct gender
	--
	procedure AddIfGender (
		p_result_gender		in	epic.eh_entity_gender.code_gender%type)
	is
	begin
		if v_gender = 'F' then
			--	if F, then must match
			if p_result_gender = v_gender then
				v_count := v_count + 1;
			end if;
		else
			--	if M, then anything other than F
			if p_result_gender <> 'F' then
				v_count := v_count + 1;
			end if;
		end if;
	end;
	--
	procedure logit(
		p_what			in		varchar2)
	is
	begin
		if cbDebug then
			dbms_output.put_line(p_what);
		end if;
	end;
begin
	v_count := 0;
	--
	--	determine level of location passed in
	--
	open cur_level;
	fetch cur_level into v_level;
	if cur_level%notfound then
		close cur_level;
		raise_application_error(-20001, 'Invalid location id [' || p_location_id || '] in ' || cs_mod);
	end if;
	close cur_level;
	--
	--	determine gender code
	--
	if upper(substr(p_code_gender,1,1)) = 'M' then
		v_gender := 'M';
	elsif upper(substr(p_code_gender,1,1)) = 'F' then
		v_gender := 'F';
	else
		v_gender := null;
	end if;
	--
	--
	if v_level = 4 then
		--	facility, use muster table directly
		if v_gender is null then
			open cur_count_all_facility;
			fetch cur_count_all_facility into v_count;
			if cur_count_all_facility%notfound then
				v_count := 0;
			end if;
			close cur_count_all_facility;
			logit(v_count || ' count all facility - ' || p_location_id);
		else
			for cur in cur_count_gender_facility(v_gender)
			loop
				AddIfGender(cur.theGender);
			end loop;
			logit(v_count || ' count gender facility - ' || p_location_id || ' - ' || v_gender);
		end if;
	elsif v_level < 4 then
		--	above facility, recursively call with the facilities to get the counts
		for cur in cur_child_facilities
		loop
			v_count := v_count + epic.ef_location_count(cur.child_location_id, p_code_gender);
		end loop;
		logit(v_count || ' count above facility - ' || p_location_id || ' - ' || p_code_gender);
	else
		--	below facility, use housing assignments
		open cur_parent_facility;
		fetch cur_parent_facility into v_parent_facility;
		if cur_parent_facility%notfound then
			close cur_parent_facility;
			raise_application_error(-20001, 'No parent facility for ' || p_location_id);
		end if;
		close cur_parent_facility;
		if v_gender is null then
			--		note - must loop this cursor, as 2 rows will be returned!
			for cur in cur_count_all_below
			loop
				v_count := v_count + cur.thecount;
			end loop;
			logit(v_count || ' count all below - ' || p_location_id);
		else
			for cur in cur_count_gender_below(v_gender)
			loop
				AddIfGender(cur.theGender);
			end loop;
			logit(v_count || ' count gender below - ' || p_location_id || ' - ' || v_gender);
		end if;
	end if;
	--
	--	done, return count
	--
	return v_count;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_EntityStatus
	(p_entity_id		in		EPIC.eh_entity_status.entity_id%type) 

/*
Purpose: Returns the entity status of an inmate

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2 AS

v_Status	EPIC.eh_entity_status.code_entity_status%type;

	CURSOR cur_Status IS
		SELECT
			s.code_entity_status
		FROM
		 	EPIC.eh_entity_status s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_Status;
		FETCH cur_Status INTO v_Status;
	CLOSE cur_Status;
			
RETURN EPIC.ef_lookup_text('OFFENDER STATUS', v_Status, 'UC');

END; 
--RAS
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_entity_id (
	p_offender_id           in      epic.EH_OFFENDER_IDS.offender_id%type)
return epic.eh_entity_person.entity_id%type
is
--
--	15 Oct 1999, K Crosser
--		Function to return the offender's offender_id value
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select entity_id
		from epic.eh_offender_ids
		where offender_id = p_offender_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_entity_id ;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_entity_id_frm_charge (
	p_charge_id           in      epic.EH_charge.charge_id%type)
return epic.eh_entity_person.entity_id%type
is
--
--	1/29/2006 J McBratnie
--		Function to return the offender's offender_id value
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select b.entity_id
		from epic.eh_charge c,
		     epic.eh_booking b
		where c.charge_id = p_charge_id
		  and c.booking_id = b.booking_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_entity_id_frm_charge ;
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_epic_DateDiff_Years (in_dob in EPIC.EH_PERSON_IDENTITY.DATE_OF_BIRTH%TYPE,
                         in_date	in EPIC.EH_PERSON_IDENTITY.DATE_OF_BIRTH%type		)
-- MAZ originally created with dob in mind, but can be used for any two dates
	return EPIC.epic_col_types.number_4%type
is
	out_age EPIC.epic_col_types.number_4%type;
--
	work_indate	date;
	work_today	date;
	work_months	EPIC.epic_col_types.number_14%type;
--
begin
	if ltrim(in_dob) = ' ' OR in_dob IS NULL then
		out_age := 0;
	else
		work_indate := to_date(substr(EPIC.date_extract(in_dob,' '),1,8),'yyyymmdd');
 		work_today  := to_date(substr(EPIC.date_extract(in_date,' '),1,8),'yyyymmdd');
		work_months := months_between(work_today,work_indate);
		out_age := floor(work_months / 12);
	end if;
 	return out_age;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_epic_DOB
	(p_entity_id	in		epic.eh_entity_person.entity_id%type)   
	
--Returns an inmate's Date of Birth in Epic format
-- created 05/16/2011  KJH modified version of mcmb_fnt_dob which returned Oracle date format

RETURN VARCHAR2 AS

v_DOB				epic.eh_person_identity.date_of_birth%type;

	CURSOR cur_DOB IS
		SELECT
			p.date_of_birth
		FROM
		 	epic.eh_person_identity p,
		 	epic.eh_entity_person ep  -- 8-19-05 MZak  added to resolve dob problem of multiple 'Master' inmate entries
		WHERE    
			p.entity_id =  p_entity_id
			and p.code_name_type = 'MAS'    --8-19-05 MZak
			and p.entity_id = ep.entity_id  --8-19-05 MZak
			and p.identity_id = ep.primary_identity_id;  --8-19-05 MZak
  
BEGIN
	OPEN cur_DOB;
		FETCH cur_DOB INTO v_DOB;
	 	CLOSE cur_DOB;	
			
RETURN v_DOB;
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_eyecolorleft
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns an inmate's left eye color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_leye					EPIC.eh_entity_person.code_eye_color_left%type;

	CURSOR cur_leye IS
		SELECT
			p.code_eye_color_left
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_leye;
		FETCH cur_leye INTO v_leye;
			IF (cur_leye%notfound or v_leye = '_NOSP' or v_leye is null)THEN
				v_leye := 'XXX';
			END IF;	
	 CLOSE cur_leye;	
			
RETURN EPIC.ef_lookup_text('EYE COLOUR', v_leye, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_eyecolorright
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)    
	
/*
Purpose: Returns an inmate's right eye color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS

v_reye					EPIC.eh_entity_person.code_eye_color_right%type;

	CURSOR cur_reye IS
		SELECT
			p.code_eye_color_right
		FROM
		 	EPIC.eh_entity_person p
		WHERE    
			p.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_reye;
		FETCH cur_reye INTO v_reye;
			IF (cur_reye%notfound or v_reye = '_NOSP' or v_reye is null) THEN
				v_reye := 'XXX';
			END IF;	
	 CLOSE cur_reye;	
			
RETURN EPIC.ef_lookup_text('EYE COLOUR', v_reye, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Fbi_No
	 (p_entity_id 	in 	epic.eh_booking.entity_id%TYPE) 
	 
--Returns the FBI NO
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			g.attribute_value
		FROM
		 	epic.eh_generic_attribute g,
		 	epic.eh_booking b
		WHERE
			g.attribute_name = 'FBI TRACKING'
			and g.item_id = b.entity_id
			and b.entity_id = p_entity_id;

          
vAgy	 epic.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  		IF curAgy%notfound THEN
				vAgy :='0';
  		end if;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END; 
--gas 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FeePmtType
	 (p_acct_id 	in 		epic.eh_trans_distribution.trust_account_trans_id%TYPE) 
	 
--Returns a 'C' for County Booking Fees; returns an 'S' for State Booking fees for the seleted transaction
	 
RETURN VARCHAR2 AS
  CURSOR curAcct IS 
  	SELECT 	decode(d.gl_account_number,'502','C','503','S',to_char(d.gl_account_number)) as Fee -- added account number on fail JDM
  	
    FROM 	epic.eh_trans_distribution d
			     		
	WHERE	d.trust_account_trans_id = p_acct_id
	    and gl_account_number in ('502','503');  --Added line JDM
     
     
--v_Acct	eh_charge.charge_state%type;
v_Acct varchar2(3);  -- changed the datatype and size JDM

BEGIN

  	OPEN curAcct;
  		FETCH curAcct INTO v_Acct;
  	CLOSE curAcct;
	
  	RETURN v_Acct;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FeePmtType_jdm
	 (p_acct_id 	in 		epic.eh_trans_distribution.trust_account_trans_id%TYPE) 
	 
--Returns a 'C' for County Booking Fees; returns an 'S' for State Booking fees for the seleted transaction
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curAcct IS 
  	SELECT 	decode(d.gl_account_number,'502','C','503','S',to_char(d.gl_account_number)) as Fee -- added account number on fail JDM
  	
    FROM 	epic.eh_trans_distribution d
			     		
	WHERE	d.trust_account_trans_id = p_acct_id
	    and gl_account_number in ('502','503');  --Added line JDM
     
     
--v_Acct	eh_charge.charge_state%type;
v_Acct varchar2(3);  -- changed the datatype and size JDM

BEGIN

  	OPEN curAcct;
  		FETCH curAcct INTO v_Acct;
  	CLOSE curAcct;
	
  	RETURN v_Acct;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FelMisd
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*	
Purpose:		Returns a 'F' flag if the selected charge is a felony; a 'M' flag if the selected charge is a misdemeanor
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 	 
	 
RETURN  EPIC.epic_col_types.varchar_255%type AS

VFM		EPIC.epic_col_types.varchar_255%type;

  CURSOR curFM IS 
  	SELECT 	decode(es.code_statute_class,'FEL','F','MIS','M')
  	
	FROM 	EPIC.epic_statutes es,
			EPIC.eh_charge c
	
	WHERE	es. statute_id = c.statute_id
			and c.charge_id = p_charge_id;


BEGIN
  	OPEN curFM;
  		FETCH curFM INTO vFM;
  	CLOSE curFM;

RETURN vFM;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FelMisdBk
	 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'F' flag if the selected charge is a felony; a 'M' flag if the selected charge is a misdemeanor

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN EPIC.epic_col_types.varchar_255%type AS
vFM					EPIC.epic_col_types.varchar_255%type;

  CURSOR curFM IS 
  	SELECT 	decode(es.code_statute_class,'FEL','F','MIS','M')
  	
	FROM 	EPIC.epic_statutes es,
			EPIC.eh_charge c,
			EPIC.eh_booking b
	
	WHERE	es. statute_id = c.statute_id
			and c.booking_id = b.booking_id
			and b.booking_id = p_booking_id;


BEGIN
  	OPEN curFM;
  		FETCH curFM INTO vFM;
  	CLOSE curFM;

RETURN vFM;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FelStatClass
	 (p_entity_id IN epic.eh_entity_person.entity_id%TYPE)  
	 
--Returns 'Y' if an inmate has at least one Felony charge ; otherwise, returns a 'U'
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'Y' 
  	
    FROM 	epic.eh_active_booking b,
			epic.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state <> 6
			and b.entity_id = p_entity_id
     		and c.statute_class ='FEL' ;
     
v_status epic.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is not a '6' (Disposed):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a Felony charge, 'v_status' will be set to 'Y', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--gAS
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_file_date (
 epic_date epic.eh_entity_person.action_time%type
)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

return string
is
begin
 return to_number(substr(epic_date,1,8),'YYYYMMDDHH24:MI:SS') + to_number(substr(epic_date,17,20))/1440;
exception
 when others then
  return to_date('18000101','YYYYMMDD');
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FineAmount
	 (p_sentence_id 	in 	EPIC.eh_sentence.sentence_id%TYPE) 

/*
Purpose: Returns the fine amount attached to the selected sentence

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curFine IS 
  	SELECT 	f.fine_amount
  	
	FROM 	EPIC.eh_sentence_fine f
			
	WHERE	f.sentence_id = p_sentence_id;
     
     
vFine	 EPIC.eh_sentence_fine.fine_amount%TYPE;


BEGIN
  	OPEN curFine;
  		FETCH curFine INTO vFine;
  	CLOSE curFine;

RETURN NVL (vFine, 0);
  	 	
END; 
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_FredomRole
	 (p_user_int_id IN epic.epic_user_names.user_int_id%TYPE)  
	 
--Returns 'Y' if an inmate has at least one Freedom role ; otherwise, returns a 'U'
/*	
	System: 		Unknown
	Purpose:		

	Author:			Glenn
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'Y' 
  	
    FROM 	epic.epic_user_roles r
			     		
	WHERE	epic.ef_epic_date_to_date (r.date_end) > sysdate 
			and r.user_int_id = p_user_int_id
			and r.LEVEL3_CODE = '-FREEDOM-'
			;
     
v_status epic.epic_user_roles.level3_code%type;


BEGIN
	 
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a freedom role, 'v_status' will be set to 'Y', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--gAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_gendershort 
	(p_entity_id	in		EPIC.eh_entity_person.entity_id%type)   

/*
Purpose: Returns the first character of an inmate's gender

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		

RETURN VARCHAR2 AS

v_gender					EPIC.eh_entity_gender.code_gender%type;

	CURSOR cur_gender IS
		SELECT
			g.code_gender
		FROM
		 	EPIC.eh_entity_gender g	
		WHERE    
			g.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_gender;
		FETCH cur_gender INTO v_gender;
			IF cur_gender%notfound THEN
				v_gender :='U';
			END IF;	
	 CLOSE cur_gender;	
			
RETURN v_gender;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_get_attrID
	(p_offender_id		in		epic.eh_offender_ids.offender_id%type,
	 p_attribute_name   in      epic.eh_generic_attribute.attribute_name%type)

--Returns the attribute ID from the eh_generic_attribute table.
--Added attribute name into the IN list
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_attrID		epic.eh_generic_attribute.attribute_id%type;

	CURSOR cur_attrID IS
		SELECT
			ga.attribute_id
		FROM
		 	epic.eh_generic_attribute ga,
		 	epic.eh_offender_ids oi,
		 	epic.eh_trust_account ta

		WHERE
			p_offender_id = oi.offender_id and
			ta.entity_id = oi.entity_id and
			ga.item_id = ta.trust_account_id and 
			ga.attribute_name = p_attribute_name;

BEGIN
	OPEN cur_attrID;
		FETCH cur_attrID INTO v_attrID;
		CLOSE cur_attrID;

RETURN v_attrID;

END;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_get_EntityId_frm_Trst (
	p_trust_account_id		in		epic.EH_Chart_of_Accounts.trust_account_id%type
)
return epic.EH_TRUST_ACCOUNT.entity_id%type
is
          --<JDM note the mutating error you were getting was related to the fact that you were 
          --     changing the same data that was queued to be updates hence calling the tristter
          --     a second, third, fourth time.  I updated this to pull back the entity_id as we
          --     talked about.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	cursor curTrust is
		select ENTITY_ID
		from epic.EH_TRUST_ACCOUNT
		where trust_account_id = p_trust_account_id;

v_entity_Id	              epic.EH_TRUST_ACCOUNT.entity_id%type;

begin

	open curTrust;
	fetch curtrust into v_entity_id;
	close curTrust;

	return v_entity_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_get_entity_id (
	p_offender_id		in		epic.EH_OFFENDER_IDS.offender_id%type
)
return epic.EH_OFFENDER_IDS.entity_id%type
is


	cursor curOffenderID is
		select i.entity_id
		from epic.EH_OFFENDER_IDS i
		where i.offender_id = p_offender_id;

		v_entity_id	epic.EH_OFFENDER_IDS.entity_id%type;

begin

	open curOffenderID;
	fetch curOffenderID into v_entity_id;
	close curOffenderID;

	return v_entity_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_fnt_Get_PersonName
      (in_entity_id_s    in	epic.EH_ENTITY.ENTITY_ID%type)
       return	epic.epic_col_types.varchar_255%type
is
--
-- given an entity_id, determines if it belongs to a person or organization
-- and returns the entity's name
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	p_name			epic.epic_col_types.varchar_255%type;
	p_entity_id		epic.eh_entity.entity_id%type;
	p_last			epic.eh_person_identity.name_family%type;
	p_first			epic.eh_person_identity.name_first%type;
	p_middle		epic.eh_person_identity.name_other%type;
	p_suffix		epic.eh_person_identity.name_suffix%type;
cursor cur_person_name is
	 select	name_family, name_first
	 from	epic.eh_person_identity pi, epic.eh_entity_person ep
	 where	ep.entity_id = p_entity_id
	 and	pi.identity_id = ep.primary_identity_id;
	p_person_name	cur_person_name%rowtype;
begin
	p_entity_id := in_entity_id_s;
		open cur_person_name;
		fetch cur_person_name into p_person_name;
		if cur_person_name%notfound then
			close cur_person_name;
			return	null;
		end if;
		p_last := rtrim(p_person_name.name_family);
		if length(p_last) > 0 then
			p_name := p_last || ', ';
		end if;
		p_first 	:= rtrim(p_person_name.name_first);
		p_name := p_name || p_first;
		close cur_person_name;
   return p_name;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_get_trust_account_id (
	p_entity_id           in      epic.eh_offender_ids.entity_id%type)
return epic.eh_entity_person.entity_id%type
is
--
--	12/7/2005 J Mcbratnie
--		Function to return the offender's trust account
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.entity_id%type;
	cursor cur_id is
		select trust_account_id
		from epic.eh_trust_account
		where entity_id =  p_entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end MCMB_FNT_get_trust_account_id ;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_gvt_days
	(p_booking_id	in		epic.eh_booking.booking_id%type)   
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH
-- Select MAX eh_charge.action_time to get latest disposed charge, with proper disposition reason
-- Modification made on 12/12/05 as instructed by Sgt. Roberts and Capt. Roberts kjh
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS
v_days		epic.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT  
			ABS(epic.ef_epic_date_diff(book.start_date,MAX(chg.action_time)))+ 1-- Plus 1 per Lori
		FROM
		 	epic.eh_booking book,
		 	epic.eh_charge chg
		WHERE
			p_booking_id = book.booking_id
			and book.booking_id = chg.booking_id
			and book.booking_state = '3'
			and chg.charge_state = '6'  
			and chg.disposition_reason in  
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'TTP','PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV')
			GROUP by BOOK.START_DATE;      
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_gvt_days_fix
	(p_booking_id	in		epic.eh_booking.booking_id%type)
-- To create the GVt Fix file for missing 001 Dispo's to be charged room and board   
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH
-- Select MAX eh_charge.action_time to get latest disposed charge, with proper disposition reason
-- Modification made on 12/12/05 as instructed by Sgt. Roberts and Capt. Roberts kjh
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS
v_days		epic.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT  
			ABS(epic.ef_epic_date_diff(book.start_date,max(chg.action_time)))+ 1-- Plus 1 per Lori
		FROM
		 	epic.eh_booking book,
		 	epic.eh_charge chg
		WHERE
			p_booking_id = book.booking_id
			and book.booking_id = chg.booking_id
			and book.booking_state = '3'
			and chg.charge_state = '6'  
			and (chg.disposition_reason = '001' and
			chg.disposition_reason not in 
			('6','12','14','005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLY RELEASE', 'SR070805APV', 'SR09215APV'))
			group by book.start_date;      
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_gvt_days_original
	(p_booking_id	in		epic.eh_booking.booking_id%type)   
	
--Returns the number of days for room and board charges, input to GVT
-- Per Lori Dunlop at Jail Reimbursement:  simple ef_epic_date_diff produced a result
-- that was one day short, so I added 1 day to the formula.  KJH
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS
v_days		epic.eh_sentence_duration.days%type;
	CURSOR cur_days IS
		SELECT
			ABS((epic.ef_epic_date_diff(book.start_date,book.end_date))+ 1)-- Plus 1 per Lori
		FROM
		 	epic.eh_booking book
		 	
		WHERE
			book.booking_id =  p_booking_id
			and book.booking_state = '3';
  
BEGIN
	OPEN cur_days;
		FETCH cur_days INTO v_days;
	 	CLOSE cur_days;	
			
RETURN v_days;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_haircolor 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)  
	
/*
Purpose: Returns an inmate's hair color
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	
RETURN VARCHAR2 AS

v_hair		EPIC.eh_person_snapshot.code_hair_color%type;

	CURSOR cur_hair IS
		SELECT
			s.code_hair_color
		FROM
		 	EPIC.eh_person_snapshot s	
		WHERE    
			s.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_hair;
		FETCH cur_hair INTO v_hair;
	CLOSE cur_hair;
			
RETURN EPIC.ef_lookup_text('HAIR COLOUR', v_hair, 'UC');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_height 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 
	
--Returns an inmate's height	
	
RETURN VARCHAR2 AS

v_height 	EPIC.eh_entity_height.height%type;

	CURSOR cur_height IS
		SELECT
			h.height
		FROM
		 	EPIC.eh_entity_height h
		WHERE    
			h.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_height;
		FETCH cur_height INTO v_height;
	CLOSE cur_height;
			
RETURN v_height;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_HoldAgy
	 (p_booking_id 	in 	epic.eh_booking.booking_id%TYPE) 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
  	SELECT 	h.agency_id 
  	
	FROM 	epic.eh_booking_holds h
			
	WHERE	h.booking_id = p_booking_id;
     
     
vAgy	 epic.eh_booking_holds.agency_id%TYPE;


BEGIN
  	OPEN curAgy;
  	FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

  	RETURN epic.ef_get_personororgname(vAgy);
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Holds
	 (p_entity_id 	IN 	EPIC.eh_active_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate has any active holds

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curHold IS 
  	SELECT 	'Y' 
  	
	FROM 	EPIC.eh_booking_holds h,
			EPIC.eh_active_booking ab
			
	WHERE	h.booking_id = ab.booking_id
			and (EPIC.ef_epic_date_to_date(h.hold_removed_date)  is null
				or EPIC.ef_epic_date_to_date(h.hold_removed_date) > sysdate)
			and ab.entity_id = p_entity_id;
     
     
v_hold EPIC.    eh_charge.charge_state%type;


BEGIN
	-- Look for any hold for this inmate that is current:  
  	OPEN curHold;
  		FETCH curHold INTO v_hold;
  	CLOSE curHold;
	
-- If we found a hold, 'v_hold' will be set to 'Y', if not return 'N'
RETURN NVL (v_hold,'N');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_hold_amt
	(	p_HoldID	in	EPIC.eh_booking_holds.hold_id%TYPE)

/*	
	Purpose:		Returns the value of the 'HOLD AMOUNT' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
		    EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD AMOUNT'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_hold_Total_Amount
	 (p_booking_id 	in 	epic.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total hold amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/12/06       created
					
*/  	 
RETURN VARCHAR2
IS  
	CURSOR cur_Hold IS
	SELECT h.booking_id, sum(to_number(g.attribute_value))
	FROM   epic.eh_generic_attribute g,
		   epic.eh_booking_holds h	
	WHERE  g.attribute_name = 'HOLD AMOUNT'
	  and  g.item_id = h.hold_id
	  and  h.booking_id = p_booking_id
 group by  h.booking_id;

vhold	   number(16,2);
vbook      epic.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN	
	OPEN cur_Hold;
		FETCH cur_Hold into vbook, vhold;
	CLOSE cur_Hold;

RETURN vhold;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_hold_warrant
	(p_hold_id	in	EPIC.eh_booking_holds.hold_id%type)
	
/*
Purpose: Returns the hold warrant number for the selected hold
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2
IS  v_holdamt			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_Hold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD WARRANT NUMBER'
			and g.item_id = h.hold_id
			and h.hold_id = p_hold_id;

BEGIN	
	OPEN cur_Hold;
		FETCH cur_Hold into v_holdamt;
	CLOSE cur_Hold;

RETURN v_holdamt;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_inmatefunds
	(p_entity_id	IN	EPIC.eh_booking.entity_id%TYPE) 
	
/*
Purpose: Returns the current balance of an inmate's trust account

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN EPIC.eh_chart_of_accounts.total_debits%TYPE

IS
vBalance	EPIC.eh_chart_of_accounts.total_debits%TYPE; 
vCommit		EPIC.eh_chart_of_accounts.total_debits%TYPE;

	CURSOR curFunds IS
 select
     decode(ca1.total_debits,null,0,ca1.total_debits) - decode(ca1.total_credits,null,0,ca1.total_credits) curbal,
     (decode(ca3.total_debits,null,0,ca3.total_debits) + decode(ca4.total_debits,null,0,ca4.total_debits)) -
     (decode(ca3.total_credits, null,0,ca3.total_credits) + decode(ca4.total_credits, null,0,ca4.total_credits)) curCommit
 from
     EPIC.eh_trust_account ta,
     EPIC.eh_chart_of_accounts ca1,
     EPIC.eh_chart_of_accounts ca3,
     EPIC.eh_chart_of_accounts ca4
 where
     ta.entity_id = p_entity_id
     and ta.code_status <> 'CLOSED'
     and ca1.trust_account_id (+) = ta.trust_account_id
         and (ca1.gl_account_number (+) = '110')
     and ca3.trust_account_id (+) = ta.trust_account_id
         and (ca3.gl_account_number (+) = '210')
     and ca4.trust_account_id (+) = ta.trust_account_id
         and (ca4.gl_account_number (+) = '220');


	
BEGIN

	OPEN curFunds;
		FETCH curFunds INTO vBalance, vCommit;
	CLOSE curFunds;
	
RETURN NVL ((vBalance + vCommit), 0);
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_inmatestatus
	(	p_charge_id		in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the Inmate Status based on the selected charge (queries against the 'Custody Status' 
		 or the 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				AND p_charge_id = g.item_id;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_inmatestatusb
	(	p_booking_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on the selected booking id (queries against the 'Custody Status' 
		 or the 'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
				EPIC.eh_charge c 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
				AND c.charge_id = g.item_id
				and c.booking_id = p_booking_id
	
		ORDER BY c.index_number;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_inmatestatus_sent
	(	p_charge_id		in	epic.eh_charge.charge_id%type)   
	
--For testing purposes (not currently used)
/*	
	System: 		Unknown
	Purpose:		Rachel to delete if not needed

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS 
	CURSOR curStat IS
		SELECT	epic.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	epic.eh_generic_attribute g 
		
		WHERE 	g.attribute_name = 'CHARGE STATUS'
				AND p_charge_id = g.item_id
				AND g.attribute_value = '7';

vStat	epic.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--RAS
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_fnt_inmate_his_alert  (
          vCur OUT epic.epp_generic_ref_cursor.ref_cursor
			)
	is
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/	

	BEGIN

	OPEN vCur FOR
 	  SELECT  
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN,
		' ' as ActiveAlert
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
		epic.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		epic.ef_location_name(ha.location_id,'uc') as Cell,
		epic.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(epic.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(epic.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(epic.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		epic.ef_offender_height(ep.entity_id) as Height,
		epic.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		epic.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
	    ea.alert_type as ActiveAlert

	    FROM   epic.eh_housing_assignments ha,
				epic.eh_active_booking ab,
				epic.eh_booking bk,
				epic.eh_person_identity epi,
				epic.eh_entity_person ep,

				-- added for alerts
				epic.eh_entity_alerts ea

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

				--added for Active Alerts
				AND ep.entity_id = ea.entity_id
				and ea.alert_active = 'Y' ;
                
    END mcmb_fnt_inmate_his_alert;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_InmChrgStat
	(	p_Entity_id		in	EPIC.eh_active_booking.entity_id%type,
	    p_ChargeStatus  in  EPIC.eh_generic_attribute.attribute_value%type) 

/*
Purpose: Returns the 'Y' if Inmate is found with given charge status

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
		
RETURN VARCHAR2 AS
  CURSOR curStat IS 
  	SELECT 	'Y' 
  	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c 
			
	WHERE	 ab.entity_id = p_Entity_id  --'0IHULDPEG0XD3MIG'
		         and ab.booking_id = c.booking_id
		         and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = p_ChargeStatus  --'PRE-ARRAIGNMENT DISTRICT'		
		         and c.charge_state != 6;    --don't show disposed charges
    
v_stat EPIC.eh_charge.charge_state%type;

BEGIN
  	OPEN curStat;
  		FETCH curStat INTO v_stat;
  	CLOSE curStat;
	
-- If we found an active inmate with the given charge status then return Y  else null
RETURN NVL (v_stat, null);

  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_interface_lastrun
	(p_name	in		epic.eh_interface_request.interface_name%type)   
	
--Returns the last date_submitted from the eh_interface_request table using the interface_name input param
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS

v_last_date				epic.eh_interface_request.date_submitted%type;

	CURSOR cur_last_date IS
		select
			max(req.date_submitted)  
			from epic.eh_interface_request req
			where req.interface_name = p_name
            AND req.code_request_status = 'COMPLETED';
BEGIN
	OPEN cur_last_date;
		FETCH cur_last_date INTO v_last_date;
	CLOSE cur_last_date;	
			
RETURN v_last_date;
END;
--KJH
  
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Interview
	 (p_booking_id	IN 	EPIC.eh_active_booking.booking_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if an inmate still needs to have a classification interview;
		 returns a null if the interview has been completed

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curInt IS 
  	SELECT 	'I' 
  	
  	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_security_classification sc,
			EPIC.eh_generic_attribute g
	
	WHERE	ab.booking_id = sc.booking_id
			AND sc.classification <> '00' --not classified
			AND ab.booking_id = g.item_id
			AND g.attribute_name = 'NEEDS CLASSIFICATION INTERVIEW'
			AND g.attribute_value = 'Y'
			and ab.booking_id = p_booking_id;
     
     
v_int 	EPIC.eh_charge.charge_state%type;


BEGIN
	OPEN curInt;
  		FETCH curInt INTO v_int;
  	CLOSE curInt;
	
-- If classification interview value = YES, 'v_int' will be set to 'Y', if not return a null value
RETURN NVL (v_int, '');
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_JudgeName
	 (p_booking_id 	in 	epic.eh_booking.booking_id%TYPE)  
	 
--This was for testing and is not valid
/*	
	System: 		Unknown
	Purpose:		Rachel to delete is not needed

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 	 
RETURN VARCHAR2 AS
  CURSOR curJudge IS 
  	SELECT 	ca.judge_name
  	
	FROM 	epic.eh_court_appearance ca,
			epic.eh_case c
			
	WHERE	ca.owner_id = c.case_id
			and c.booking_id = p_booking_id;
     
     
vJudge	 epic.eh_court_appearance.judge_name%TYPE;


BEGIN
  	OPEN curJudge;
  		FETCH curJudge INTO vJudge;
  	CLOSE curJudge;

RETURN vJudge;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_JudgeName_ChargeID
	 (p_charge_id 	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the Judge's name related to the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 

	 
RETURN VARCHAR2 AS
  CURSOR curJudge IS 
  	SELECT 	ca.judge_name
  	
	FROM 	EPIC.eh_court_appearance ca,
			EPIC.eh_case c,
			EPIC.eh_case_charge cc,
			EPIC.eh_charge ch
			
	WHERE	ca.owner_id = c.case_id
			and c.case_id = cc.case_id
			and cc.charge_id = ch.charge_id
			and ch.charge_id = p_charge_id;
     
     
vJudge	 EPIC.eh_court_appearance.judge_name%TYPE;


BEGIN
  	OPEN curJudge;
  		FETCH curJudge INTO vJudge;
  	CLOSE curJudge;

RETURN vJudge;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_JuvFlag
	 (p_entity_id	 IN EPIC.eh_booking.entity_id%TYPE) 

/*
Purpose: Returns a 'Y' flag if the inmate has the juvenile flag; returns a 'N' flag otherwise 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	 
	 
RETURN VARCHAR2 AS
  CURSOR curJuv IS   	
  	SELECT 	decode(ep.juvenile_flag, null, 'N', ep.juvenile_flag)

    FROM 	EPIC.eh_entity_person ep

	WHERE	ep.entity_id = p_entity_id;	
     
    
v_Juv	EPIC.eh_entity_person.juvenile_flag%type;


BEGIN
	OPEN curJuv;
  		FETCH curJuv INTO v_Juv;
  	CLOSE curJuv;
  	
  	RETURN  v_juv;
  		
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_KeepSep
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)  

/*
Purpose: Returns the name and cell of the Keep Seperate inmates from the selected inmate

	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema      
				MB/MZ       10-1-12         Increases varchar2 (2000 to 2500)
*/		

RETURN		varchar2
IS

	CURSOR curKeepSep IS
	SELECT	EPIC.ef_offender_id(ks.origin_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as IName,
			EPIC.ef_offender_cell(ks.origin_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
	    	and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.origin_entity_id = p_entity_id

UNION ALL
 	SELECT	EPIC.ef_offender_id(ks.separate_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.separate_entity_id) as IName,
			EPIC.ef_offender_cell(ks.separate_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
			and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.separate_entity_id = p_entity_id;
	
--vName EPIC.epic_col_types.VARCHAR_2000%type;     -- REMOVED use varchar2 (2500)
vName varchar2(2500);
BEGIN
	vName := null;
		FOR a IN curKeepSep
			LOOP vName := vName || a.IName || ' (' || a.ICell || ')' || ' / ';
			END LOOP;
		RETURN vName;
END;  
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_KeepSepMB
		(p_entity_id	in		EPIC.eh_booking.entity_id%type)  

/*    
******************** TESTING MB   w PROD DATA
Purpose: Returns the name and cell of the Keep Seperate inmates from the selected inmate

	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		

RETURN		varchar2
IS
  vName varchar2(2500);
	CURSOR curKeepSep IS
	SELECT	EPIC.ef_offender_id(ks.origin_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as IName,
			EPIC.ef_offender_cell(ks.origin_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
	    	and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.origin_entity_id = p_entity_id

UNION ALL
 	SELECT	EPIC.ef_offender_id(ks.separate_entity_id) as INum,
			EPIC.ef_get_personororgname(ks.separate_entity_id) as IName,
			EPIC.ef_offender_cell(ks.separate_entity_id) as ICell

	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
	  		EPIC.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
			and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and not ks.separate_entity_id = p_entity_id;
	
--vName EPIC.epic_col_types.VARCHAR_2000%type;

BEGIN 

	vName := null;
		FOR a IN curKeepSep
			LOOP vName := vName || a.IName || ' (' || a.ICell || ')' || ' / ';
			END LOOP;
		RETURN vName;
END;  
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_legal_jdgmt_flg
	(p_entity_id		in		EPIC.eh_trust_account.entity_id%type)
	
/*
Purpose: Returns the (ATTRIBUTE_NAME) from EH_GENERIC_ATTRIBUTE table when the 'LEGAL JUDGEMENT FLAG' attribute is the True flag = y
		 Adds the legal judgement flag to the Alpha Primary report for Lori's use (01/06/06 dlk)

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/

RETURN VARCHAR2 AS

v_attrName					EPIC.eh_generic_attribute.attribute_name%type;

	CURSOR cur_attrName IS
		SELECT
			ga.attribute_name
			
		FROM
		 	EPIC.eh_generic_attribute ga,
		 	EPIC.eh_trust_account ta
		 	
		WHERE
			p_entity_id = ta.entity_id 
			and ga.item_id = ta.trust_account_id				
		    and (ga.attribute_name = 'LEGAL JUDGEMENT FLAG' 
		    and ga.attribute_value = 'Y');
  
BEGIN
	OPEN cur_attrName;
		FETCH cur_attrName INTO v_attrName;
		CLOSE cur_attrName;
			
RETURN v_attrName;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_MDOC
	 (p_entity_id 	IN 	EPIC.eh_person_identity.entity_id%TYPE)  

/*
Purpose: Returns the MDOC number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curID IS 
  	SELECT	o.state_id
	
	FROM	EPIC.eh_offender_ids o
	
	WHERE	o.entity_id = p_entity_id;	
     
v_ID EPIC.eh_offender_ids.state_id%TYPE;

BEGIN
  	OPEN curID;
  		FETCH curID INTO v_ID;
  	CLOSE curID;

RETURN v_ID; 
	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_MultipleCharges
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE)  

/*	
Purpose:		Returns a 'Y' flag if an inmate has multiple charges

Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/  	 

RETURN VARCHAR2 AS
  CURSOR curCharge IS   	
  	SELECT 	decode(count(c.charge_id), 1, NULL, 'Y')

    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
			and c.charge_state <> '6'
			--includes all charges that aren't disposed (including unitialized charges)
			and b.entity_id = p_entity_id
			
	GROUP BY	b.booking_id;		
     
     
v_count         EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for all active charges for an inmate (per the criteria above):
  	OPEN curCharge;
  		FETCH curCharge INTO v_count;
  	CLOSE curCharge;
	
-- If we found more than one active charge, 'v_count' will be set to 'Y', if not returns a Null
RETURN v_count;
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_NameFirstLast
	 (p_entity_id 	in 	epic.eh_person_identity.identity_id%TYPE)  
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	 
RETURN VARCHAR2 AS
  CURSOR curName IS 
  	SELECT 	pi.name_first || ' ' || pi.name_family
  	
	FROM 	epic.eh_person_identity pi
			
	WHERE	pi.entity_id = p_entity_id;
     
     
vName	 epic.epic_col_types.varchar_255%type;


BEGIN
  	OPEN curName;
  		FETCH curName INTO vName;
  	CLOSE curName;

RETURN vName;
  	 	
END;
--JDM
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_Name_Delimited_gvt
      (in_entity_id_s    in	epic.EH_ENTITY.ENTITY_ID%type)
       return	epic.epic_col_types.varchar_255%type
is
--
-- given an entity_id, returns the entity's name
--  
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	p_name			epic.epic_col_types.varchar_255%type;
	p_entity_id		epic.eh_entity.entity_id%type;
	p_last			epic.eh_person_identity.name_family%type;
	p_first			epic.eh_person_identity.name_first%type;
	p_middle		epic.eh_person_identity.name_other%type;
	
cursor cur_person_name is
	 select	name_family, name_first, name_other
	 from	epic.eh_person_identity pi, epic.eh_entity_person ep
	 where	ep.entity_id = p_entity_id
	 and	pi.identity_id = ep.primary_identity_id;
	 --following line removed 12/9/05 per Sgt.Roberts as data was not getting updated properly, primary_identity more important than master name.
	 --and    pi.code_name_type = 'MAS';
 p_person_name	cur_person_name%rowtype;

begin
	p_entity_id := in_entity_id_s;
	
		open cur_person_name;
		fetch cur_person_name into p_person_name;
		if cur_person_name%notfound then
			close cur_person_name;
			return	null;
		end if;
		p_last := rtrim(p_person_name.name_family);
		if length(p_last) > 0 then
			p_name := p_last || '",';
		end if;
		p_first 	:= rtrim(p_person_name.name_first);
		p_middle	:= rtrim(p_person_name.name_other);
		p_name :=  p_name || '"' || p_first || '","' || p_middle ;
		close cur_person_name;
	        			
   return p_name;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_offenderidfromBK (
	p_booking_id				in		epic.eh_booking.booking_id%type)
return epic.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's offender_id value from Booking_ID
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select i.offender_id
		from   epic.eh_offender_ids i,
		       epic.eh_booking b
		where  b.booking_id = p_booking_id
		  and  b.entity_id = i.entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_offenderidfromCG (
	p_charge_id				in		epic.eh_charge.charge_id%type)
return epic.eh_offender_ids.offender_id%type
is
--
--	1/29/2006, J McBratnie
--		Function to return the offender's offender_id value from Charge_ID
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select i.offender_id
		from   epic.eh_offender_ids i,
		       epic.eh_booking b,
		       epic.eh_charge c
		where  c.charge_id = p_charge_id
		  and  b.booking_id = c.booking_id
		  and  b.entity_id = i.entity_id;
begin
	open cur_id;
	fetch cur_id into v_id;
	if cur_id%notfound then
		v_id := ' ';
	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_OffenderidFromVeh (
	p_entity_id				in		epic.eh_vehicle.entity_id%type)
return epic.eh_offender_ids.offender_id%type
is
--
--	<JDM  1-28-2006
--		Function to return the offender's offender_id value from the vehicle entity_id
--                  NOTE the vehicle entity_id is the booding incident entity_id
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	v_id					epic.eh_offender_ids.offender_id%type;
	cursor cur_id is
		select id.offender_id
		from   epic.EH_ENTITY_ARREST_INCIDENT a,
			   epic.eh_booking b,
			   epic.EH_OFFENDER_IDS id
        where  a.incident_id = p_entity_id
          and  id.entity_id = b.entity_id
          and  b.booking_id = a.booking_id;
          
begin
	open cur_id;
	fetch cur_id into v_id;
--	if cur_id%notfound then
--		v_id := ' ';
--	end if;
	close cur_id;
	return v_id;
end;
/

CREATE OR REPLACE
function MACOMB.MCMB_FNT_Offender_Gender  

--Returns the full text (Male, Female, Unknown) of an inmate's gender
	(p_entity_id				in		EPIC.eh_entity_person.entity_id%type)
return EPIC.epic_col_types.varchar_255%type
is

	v_gender					EPIC.epic_col_types.varchar_255%type;
	cursor cur_gender is
		select
			rtrim(EPIC.ef_lookup_text('SEX', eg.code_gender, ''))
		from EPIC.EH_ENTITY_GENDER eg
		where entity_id = p_entity_id;
begin
	open cur_gender;
	fetch cur_gender into v_gender;
	if cur_gender%notfound then
		v_gender :='UNKNOWN '; 
	end if;
	close cur_gender;
	return v_gender;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_percentbail
	(p_charge_id	in	EPIC.eh_charge.charge_id%type)
	
--Returns a Y/N flag if an inmate's bond qualifies/doesn't qualify for the 10% attribute

RETURN VARCHAR2
IS  v_bail			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_bail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = '10 PERCENT BOND'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_charge_id;
			
		
			
		

BEGIN	
	OPEN cur_bail;
		FETCH cur_bail into v_bail;
	CLOSE cur_bail;

RETURN NVL (v_bail, 'N');

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_perdispo --backup
	(	p_case_id	in	epic.eh_case.case_id%type) 
	
--Written for testing purposes (not currently used)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
		
RETURN VARCHAR2
IS  v_Dispo			epic.eh_generic_attribute.attribute_value%type;

	CURSOR curDispo IS
		SELECT
			g.attribute_value 
			
		FROM
			epic.eh_generic_attribute g,
			epic.eh_court_appearance ca,
			epic.eh_case c
			
		WHERE 
			g.attribute_name = 'PER DISPO'
			and g.item_id = ca.court_appearance_id
			and ca.owner_id = c.case_id
			and c.case_id = p_case_id ;

BEGIN	

	OPEN curDispo;
		FETCH curDispo into v_Dispo;
	CLOSE curDispo;
		
	RETURN v_Dispo;

	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_phone_base_primary
	(p_entity_id	in		epic.eh_address.entity_id%type)  
	

--Returns the base numbers of an inmate's most current telephone number
-- KJH, cloned telelphone_base to add 'Primary' condition
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_phone		epic.eh_telephone_records.base_number%type;

	CURSOR cur_phone IS
		SELECT
			t.base_number
		FROM
		 	epic.eh_telephone_records t,
		 	epic.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			and (t.primary_flag = 'Y' or t.primary_flag = ' ')
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_phone;
		FETCH cur_phone INTO v_phone;
	CLOSE cur_phone;
			
RETURN v_phone;

END;
 --KJH
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_phone_per_address (
	p_entity_id				in		epic.eh_entity_person.entity_id%type,
	p_address_id			in		epic.eh_address.address_id%type)
return epic.epic_col_types.varchar_255%type
is
--
--		17 Feb 2003, K Crosser
--			Return a formatted phone number for a person
--			If address is specified, may be used as well...
--		If the person has a primary phone, return that
--			else if the address has a primary phone, return that
--			else return most recent active phone for person
--			else return most recent active phone for address
--  
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

	v_result						epic.epic_col_types.varchar_255%type := null;
	vNow							epic.eh_telephone_records.date_from%type;
	cursor cur_person_phone is
		select
			primary_flag, code_country, area_code, base_number, extension
		from
			epic.eh_telephone_records etr
		where
			etr.entity_id = p_entity_id
			and (etr.date_to is null or etr.date_to > vNow)
		order by
			decode(primary_flag, 'Y', 1, 2),
			nvl(etr.date_to, '2999') desc;
	--
	v_person_phone_rec				cur_person_phone%rowtype;
	--
	cursor cur_address_phone is
		select
			primary_flag, code_country, area_code, base_number, extension
		from
			epic.eh_address_phone_number eapn,
			epic.eh_telephone_records etr
		where
			eapn.address_id = p_address_id
			and etr.telephone_record_id = eapn.telephone_record_id
			and (etr.date_to is null or etr.date_to > vNow)
		order by
			decode(primary_flag, 'Y', 1, 2),
			nvl(etr.date_to, '2999') desc;
	--
	v_address_phone_rec				cur_address_phone%rowtype;
	--
	function NicePhone (
		p_country			in		epic.eh_telephone_records.code_country%type,
		p_area				in		epic.eh_telephone_records.area_code%type,
		p_base				in		epic.eh_telephone_records.base_number%type,
		p_ext				in		epic.eh_telephone_records.extension%type)
	return varchar2
	is
		vNumber						varchar2(255) := null;
		vUS							boolean := true;
	begin
		begin
			--	ignore country code errors...
			if p_country is not null then
				if to_number(p_country) <> 1 then
					vUS := false;
					vNumber := '+' || to_number(p_country) || ' ';
				end if;
			end if;
		exception
			when others then
				null;
		end;
		if p_area is not null then
			vNumber := vNumber || '(' || p_area || ') ';
		end if;
		if vUS then
			vNumber := vNumber || substr(p_base, 1, 3) || '-' || substr(p_base, 4, 255);
		else
			vNumber := vNumber || p_base;
		end if;
		if p_ext is not null then
			vNumber := vNumber || ' x' || p_ext;
		end if;
		return vNumber;
	end;
begin
	vNow := epic.epicdatenow;
	--	get person's primary (and others)
	open cur_person_phone;
	fetch cur_person_phone into v_person_phone_rec;
	if cur_person_phone%found then
		if v_person_phone_rec.primary_flag = 'Y' then
			v_result := NicePhone(v_person_phone_rec.code_country, v_person_phone_rec.area_code,
				v_person_phone_rec.base_number, v_person_phone_rec.extension);
		end if;
	end if;
	close cur_person_phone;
	--	get address phone (and others)
	if v_result is null then
		open cur_address_phone;
		fetch cur_address_phone into v_address_phone_rec;
		if cur_address_phone%found then
			if v_address_phone_rec.primary_flag = 'Y' then
				v_result := NicePhone(v_address_phone_rec.code_country, v_address_phone_rec.area_code,
					v_address_phone_rec.base_number, v_address_phone_rec.extension);
			end if;
		end if;
		close cur_address_phone;
	end if;
	--	if no primary, use person
	if v_result is null then
		if v_person_phone_rec.base_number is not null then
			v_result := NicePhone(v_person_phone_rec.code_country, v_person_phone_rec.area_code,
				v_person_phone_rec.base_number, v_person_phone_rec.extension);
		elsif v_address_phone_rec.base_number is not null then
			v_result := NicePhone(v_address_phone_rec.code_country, v_address_phone_rec.area_code,
				v_address_phone_rec.base_number, v_address_phone_rec.extension);
		end if;
	end if;
	return v_result;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_PickupAgy
	 (p_charge_id 	in 	 EPIC.eh_charge.charge_id%TYPE) 
	
/*
Purpose: Returns the agency that is picking up the inmate after his/her release from the MCJ

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curAgy IS 
		SELECT
			g.attribute_value
		FROM
		 	EPIC.eh_generic_attribute g,
		    EPIC.eh_charge c
		WHERE
			g.attribute_name = 'HELD FOR'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;

          
vAgy	 EPIC.eh_generic_attribute.attribute_value%TYPE;


BEGIN
  	OPEN curAgy;
  		FETCH curAgy INTO vAgy;
  	CLOSE curAgy;

RETURN vAgy;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_primarycharge
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the statute text of the Primary Charge (the Primary Charge is defined as the first charge entered on
		 an inmate's booking--thus having an index of '1') for the given booking 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN EPIC.epic_statutes.statute_description%type AS

	CURSOR curCharge IS
		SELECT 	s.statute_description
	 		   
		FROM 	EPIC.epic_statutes s,
				EPIC.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	 			and s.statute_id = c.statute_id
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_description%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vchgscrpt := vChargeRec.statute_description;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_primarychargeID
	(p_booking_id	in	epic.eh_booking.booking_id%type)
	
--Returns the Charge_ID where the state is not = '6' 
--an inmate's booking--thus having an index of '1') for the given booking 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN epic.eh_charge.CHARGE_ID%type AS

	CURSOR curCharge IS
		SELECT 	CHARGE_ID
	 		   
		FROM 	epic.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	 			and CHARGE_STATE <> '6'
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vChargeID	epic.eh_charge.CHARGE_ID%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vChargeID := vChargeRec.CHARGE_ID;

RETURN vChargeID;
	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_primarychargenumber
	(p_booking_id	in	EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns the statute number of the Primary Charge (the Primary Charge is defined as the first charge entered on
		 an inmate's booking--thus having an index of '1') for the given booking 

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	

RETURN EPIC.epic_statutes.statute_number%type AS

	CURSOR curCharge IS
		SELECT 	s.statute_number
	 		   
		FROM 	EPIC.epic_statutes s,
				EPIC.eh_charge c
			
		WHERE 	c.booking_id = p_booking_id
	  			and s.statute_id = c.statute_id
	
		ORDER BY c.index_number;
		
vChargeRec	curCharge%rowtype;
vchgscrpt	EPIC.epic_statutes.statute_number%type;
	
BEGIN
	OPEN curCharge;
		FETCH curCharge INTO vChargeRec;
	CLOSE curCharge;
	
vchgscrpt := vChargeRec.statute_number;

RETURN vchgscrpt;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_race
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
--Returns an inmate's race
	
RETURN VARCHAR2 AS
v_race		EPIC.eh_entity_race.code_race%type;

	CURSOR cur_race IS
		SELECT
			r.code_race
		FROM
		 	EPIC.eh_entity_race r	
		WHERE    
			r.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_race;
		FETCH cur_race INTO v_race;
			IF cur_race%notfound THEN
				v_race :='U';
			END IF;	
	 	CLOSE cur_race;	
			
RETURN v_race; 

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_RDCCapacity_Cell
	 (p_location 	IN 	MACOMB.mt_jcs_rdc.cellname%TYPE)  

/*
Purpose: Returns the sum of the RDC (Rated Design Capacity) for the input cell/cell group.  This function pulls data
		from a custom Macomb-written table to hold the RDC numbers

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema  
											Changed target table from EPIC to MACOMB table
*/	
	 
RETURN VARCHAR2 AS
  CURSOR curLocation IS 
  	SELECT 	sum(r.capacity)

	FROM	MACOMB.mcmb_table_rdc r --MACOMB.mt_jcs_rdc r

	WHERE	r.cellname like p_location;
     
     
v_location	number;

BEGIN
  	OPEN curLocation;
  		FETCH curLocation INTO v_location;
  	CLOSE curLocation;
	

RETURN v_location;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_RDCCapacity_Location
	 (p_location 	IN 	MACOMB.mt_jcs_rdc.location%TYPE)  

/*
Purpose: Returns the sum of the RDC (Rated Design Capacity) for the input location.  This function pulls data
		from a custom Macomb-written table to hold the RDC numbers

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema  
											Changed target table from EPIC to MACOMB table
*/	
	 
	 
RETURN VARCHAR2 AS
  CURSOR curLocation IS 
  	SELECT 	sum(r.capacity)

	FROM	MACOMB.mcmb_table_rdc r --MACOMB.mt_jcs_rdc r

	WHERE	r.location like p_location;
     
     
v_location	number;

BEGIN
  	OPEN curLocation;
  		FETCH curLocation INTO v_location;
  	CLOSE curLocation;
	

RETURN v_location;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_releasenotes
	(p_booking_id		in		EPIC.eh_booking.booking_id%type)

/*
Purpose: Returns note text associated with a release (from the release tab in Offendertrak)


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2
IS   
	CURSOR curRNotes IS
		SELECT 	n.note_text_1 || ' ' || n.note_text_2 || ' ' || n.note_text_3 || ' '|| n.note_text_4 ||	' ' || n.note_text_5 as Notes

		FROM	EPIC.epic_notes n,
				EPIC.eh_release r,
				EPIC.epic_note_book nb

		WHERE	n.note_ref = nb.note_id
				and nb.epic_id = r.release_id
				and r.booking_id = p_booking_id;
		
vRNotes         EPIC.epic_col_types.VARCHAR_2000%type;
  
BEGIN
	OPEN curRNotes;
		FETCH curRNotes into vRNotes;
	CLOSE curRNotes;
		
RETURN vRNotes;
END;

--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_releasetype
	(p_booking_id		in		EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the reason for release for the given booking


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2
IS		v_release		EPIC.eh_release.release_type%type;

	CURSOR cur_release IS
		SELECT	r.release_type	
		
		FROM	EPIC.eh_release r,
				EPIC.eh_booking b
		
		WHERE 	b.booking_id = r.booking_id
				and b.booking_id = p_booking_id;
  
BEGIN
	OPEN cur_release;
		FETCH cur_release INTO v_release;
	CLOSE cur_release;
			
	RETURN EPIC.ef_lookup_text('RELEASE TYPE', v_release, 'UC');
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_rel_date
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS

v_rel_date				epic.eh_booking.final_release_date%type;

	CURSOR cur_rel_date IS
		select
			bk.final_release_date  
			from epic.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_rel_date;
		FETCH cur_rel_date INTO v_rel_date;
	 	CLOSE cur_rel_date;	
			
RETURN v_rel_date;
END;
--KJH
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_restrict (
	p_entity_id				in		epic.eh_entity_person.entity_id%type)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
return epic.epic_col_types.varchar_255%type
is

	cursor cur_restrict is
		select
			r.code_restriction_type,
			r.begin_date
		from
			epic.eh_entity_restriction r
		where
			r.entity_id = p_entity_id
			and (epic.ef_epic_date_to_date(r.end_date) > sysdate or r.end_date is null)
		order by r.begin_date desc;
v_cur_restrict 	cur_restrict%rowtype;
begin
	open cur_restrict;
	fetch cur_restrict into v_cur_restrict;
	if cur_restrict%found then
		close cur_restrict;
		return v_cur_restrict.code_restriction_type;
	end if;
	close cur_restrict;
	return '';
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Reversal
	 (p_acct_id 	in	epic.eh_trans_distribution.trust_account_id%TYPE)  
	 
--Testing: this function is not valid/correct, nor used
	 
RETURN VARCHAR2 AS
  CURSOR curRev IS 
  	SELECT 	tat.reverse_flag

	FROM	epic.eh_trust_account_trans tat
	
	WHERE	tat.trust_account_id = p_acct_id;     
     

vRev	epic.eh_trust_account_trans.reverse_flag%type;


BEGIN 
  	OPEN curRev;
  		FETCH curRev INTO vRev;
  	CLOSE curRev;
  	
RETURN vRev;
  	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_ReviewDate
	 (p_entity_id	in 	EPIC.eh_booking.entity_id%TYPE) 

/*
Purpose: Returns the most current/last review date an inmate had during the current active booking
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
	 
RETURN VARCHAR2 AS
  CURSOR curReviewDate IS 
		select
			sc.review_date
		from
			EPIC.eh_security_classification sc,
			EPIC.eh_active_booking ab
		where
			ab.entity_id = p_entity_id
			and sc.booking_id = ab.booking_id
		order by EPIC.ef_epic_date_to_date(sc.review_date) desc;
     
     
vReviewDate	 EPIC.eh_security_classification.review_date%TYPE;


BEGIN
  	OPEN curReviewDate;
  		FETCH curReviewDate INTO vReviewDate;
  	CLOSE curReviewDate;

  	RETURN vReviewDate;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_SentAllChgs
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE) 

/*
Purpose: Returns 'S' if an inmate has been sentenced on all active charges; otherwise, returns 'U'	

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'U' 
  	
    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state != '4' --sentenced
			and c.charge_state != '6' --disposed
			and b.entity_id = p_entity_id;
     
     
v_status     EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is not '4' (Sentenced) or '6' (Disposed):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found an un-sentenced charge, 'v_status' will be set to 'U', if not return 'S'
RETURN NVL (v_status,'S');
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_sentdate_gvt
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns the booking sentence_start_date which is used to calculate room and board charges
-- after the inmate has been released.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS

v_sent_date				epic.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			bk.sentence_start_date 
			from epic.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_SentOneChg
	 (p_entity_id IN EPIC.eh_entity_person.entity_id%TYPE)  

/*	
Purpose:		Returns 'S' if an inmate has been sentenced on at least one charge; otherwise, returns a 'U'
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 	 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'S' 
  	
    FROM 	EPIC.eh_booking b,
			EPIC.eh_charge c
			     		
	WHERE	b.booking_id = c.booking_id
			and c.charge_state = '4'
			and b.entity_id = p_entity_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is '4' (Sentenced):  
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;

-- If we found a sentenced charge, 'v_status' will be set to 'S', if not return 'U'
RETURN NVL (v_status,'U');
  		
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_SenttoPrison
			 (p_booking_id 	in	 EPIC.eh_charge.booking_id%TYPE) 

/*	
Purpose:		Returns 'P' if an inmate has been sentenced to prison; returns 'NP' if an inmate has not been sentenced to prison
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/  			 
	 
RETURN VARCHAR2 AS
  CURSOR curPrison IS 
  	SELECT 	'P' 
  	
    FROM 	EPIC.eh_charge c,
    		EPIC.eh_generic_attribute g
			     		
	WHERE	c.charge_id = g.item_id
			and (EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON AWAITING PAPERS'
					 or EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON PAPERS HERE')
			and c.booking_id = p_booking_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look for any charge for this inmate that is Sentenced to Prison
  	OPEN curPrison;
  	FETCH curPrison INTO v_status;
  	CLOSE curPrison;
	-- If we found a 'Prison' charge, 'v_status' will be set to 'P', if not return 'NP'
  	RETURN NVL (v_status,'NP');
  	
  	
END;

--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_SenttoPrison_Chrg
			 (p_charge_id 	in	 EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns 'P' if an inmate has been sentenced to prison on this charge; 
		 Returns 'NP' if an inmate has not been sentenced to prison on this charge
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/			 
	 
RETURN VARCHAR2 AS
  CURSOR curPrison IS 
  	SELECT 	'P' 
  	
    FROM 	EPIC.eh_charge c,
    		EPIC.eh_generic_attribute g
			     		
	WHERE	c.charge_id = g.item_id
			and (EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON AWAITING PAPERS'
					 or EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') = 'SENTENCED TO PRISON PAPERS HERE')
			and c.charge_id = p_charge_id;
     
     
v_status    EPIC.eh_charge.charge_state%type;


BEGIN
	-- Look to see if this charge for this inmate is Sentenced to Prison
  	OPEN curPrison;
  	FETCH curPrison INTO v_status;
  	CLOSE curPrison;
	-- If we found a 'Prison' charge, 'v_status' will be set to 'P', if not return 'NP'
  	RETURN NVL (v_status,'NP');
  	
  	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_sent_date
	(p_book_id	in		EPIC.eh_booking.booking_id%type)   
	


RETURN VARCHAR2 AS

v_sent_date				EPIC.eh_booking.sentence_start_date%type;

	CURSOR cur_sent_date IS
		select
			bk.sentence_start_date 
			from EPIC.eh_booking bk
			where bk.booking_id = p_book_id;
  
BEGIN
	OPEN cur_sent_date;
		FETCH cur_sent_date INTO v_sent_date;
	 	CLOSE cur_sent_date;	
			
RETURN v_sent_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Sent_Restitution
	
	(p_entity_id		in		    epic.eh_booking.entity_id%type)
		
--Returns the attribute_value for sentence attribute "Restitution Judgement Amount" 
-- Active inmates only
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 	
RETURN VARCHAR2 AS

v_attrValue	    			epic.eh_chart_of_accounts.total_credits%type;

	CURSOR cur_attrValue IS
		SELECT
			ga.attribute_value
		FROM
		 	epic.eh_generic_attribute ga,
		 	epic.eh_booking book,
		 	epic.eh_charge chg,
		 	epic.eh_sentence sent		 	
		 	
		WHERE p_entity_id = book.entity_id 
		and book.booking_id = chg.booking_id
		and chg.sentence_id = sent.sentence_id
		and sent.sentence_id = ga.item_id	 
        and   ga.attribute_name =  'RESTITUTION JUDGEMENT AMOUNT'             
 		and book.booking_id in
 			(Select ab.booking_id
 				from epic.eh_active_booking ab);
                                   
BEGIN
	OPEN cur_attrValue;
		FETCH cur_attrValue INTO v_attrValue;
		CLOSE cur_attrValue;
			
RETURN v_attrValue;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_sent_Total_Amount
	 (p_booking_id 	in 	epic.EH_BAIL_CONDITION.BOOKING_ID%TYPE) 
	 
--Returns the bail amount for the given charge
 /*	
	System: 		Reports
	Purpose:		Return the total sentence amount per booking

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/12/06       created
					
*/  	 
RETURN VARCHAR2
IS  
	CURSOR cur_sent IS   
  	SELECT 	c.booking_id, sum(f.fine_amount)
  	
	FROM 	epic.eh_sentence_fine f,
			epic.eh_charge c
	WHERE	p_booking_id = c.booking_id 
	  and   c.sentence_id = f.sentence_id	
 group by   c.booking_id;

vsent	   epic.eh_sentence_fine.fine_amount%TYPE;
vbook      epic.EH_BAIL_CONDITION.BOOKING_ID%type;

BEGIN	
	OPEN cur_sent;
		FETCH cur_sent into vbook, vsent;
	CLOSE cur_sent;

RETURN vsent;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_socsec
	(p_entity_id	in		EPIC.eh_person_identity.entity_id%type)

/*
Purpose: Returns an inmate's social security number
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/10/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS

v_SocSec		varchar2(128);

	CURSOR cur_SocSec IS
		SELECT
			substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN
		FROM
		 	EPIC.eh_person_identity epi
		WHERE    
			epi.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_SocSec;
		FETCH cur_SocSec INTO v_SocSec;
	CLOSE cur_SocSec;
			
RETURN v_SocSec;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_socsec_numeric
	(p_entity_id	in		epic.eh_person_identity.entity_id%type)
	
--Returns an inmate's social security number without dashes
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS

v_SocSec		varchar2(128);

	CURSOR cur_SocSec IS
		SELECT
			 epi.social_security_number 
		FROM
		 	epic.eh_person_identity epi
		WHERE    
			epi.entity_id = p_entity_id;
  
BEGIN
	OPEN cur_SocSec;
		FETCH cur_SocSec INTO v_SocSec;
	CLOSE cur_SocSec;
			
RETURN v_SocSec;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_startdate_audit
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns the booking_start_date which is used to calculate room and board charges
-- after the inmate has been released.
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
RETURN VARCHAR2 AS

v_start_date				epic.eh_booking.sentence_start_date%type;

	CURSOR cur_start_date IS
		select
			bk.start_date  
			from epicaudit.eh_booking bk
			where bk.booking_id = p_book_id
			and bk.booking_state = '3';
			
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_status_enddate
	(p_book_id	in		epic.eh_booking.booking_id%type)   
	
--Returns an dates of custody status changes for room & board billing purposes
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_end_date				epic.eh_booking.final_release_date%type;

	CURSOR cur_end_date IS
		select
			bkstat.date_end  
			from epic.eh_booking_custody_status bkstat
			where bkstat.booking_id = p_book_id;
  
BEGIN
	OPEN cur_end_date;
		FETCH cur_end_date INTO v_end_date;
	 	CLOSE cur_end_date;	
			
RETURN v_end_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_status_epicaudit
	(p_entity_id		in		epic.eh_entity_person.entity_id%type)

/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	
RETURN VARCHAR2 AS

v_stat		epic.eh_booking.entity_id%type;

	CURSOR cur_stat IS
		SELECT
			stat.code_custody_status
		FROM
			epicaudit.eh_entity_status stat,
		 	epicaudit.eh_booking book	
		WHERE    
			p_entity_id = book.entity_id
			and stat.entity_id = book.entity_id
			and stat.code_custody_status in ('1','4','10')
			and book.sentence_start_date > '2005061104:00:00-240'
			and book.final_release_date < '2005072704:00:00-240'; 
			  
  
BEGIN
	OPEN cur_stat;
		FETCH cur_stat INTO v_stat;
		CLOSE cur_stat;
			
RETURN v_stat;

END;
 --KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_status_from_BookID
	(	p_book_id		in	EPIC.eh_booking.booking_id%type) 

/*   
Purpose: Returns the Inmate Status based on a booking_id (queries against the 
		  'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	       Change Made
				----------	-------------	------------------------------------------
				K. Heinz		09/07/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
	
		SELECT	EPIC.ef_lookup_text('CHARGE STATUS', g.attribute_value, 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
		            EPIC.eh_booking book,
		            epic.eh_charge chg 
		
		WHERE 	attribute_name = 'CHARGE STATUS'
		and         p_book_id = chg.booking_id
				AND chg.charge_id = g.item_id;

vStat	EPIC.eh_generic_attribute.attribute_value%type;

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'NO STATUS');
	
END;
--kjh
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_status_startdate
	(p_booking_id	in		epic.eh_booking.booking_id%type)   
	
--Returns dates of custody status changes for room & board billing purposes
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN VARCHAR2 AS

v_start_date				epic.eh_booking.final_release_date%type;

	CURSOR cur_start_date IS
		select max(date_start)
		from epic.eh_booking_custody_status
		where booking_id = p_booking_id;
  
BEGIN
	OPEN cur_start_date;
		FETCH cur_start_date INTO v_start_date;
	 	CLOSE cur_start_date;	
			
RETURN v_start_date;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_status_WorkRelease
	 (p_booking_id IN epic.eh_charge.booking_id%TYPE)  
	 
--Returns 'yes' if inmate booking has any custody status of  '5' - Work Release 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production					
*/

RETURN VARCHAR2 AS
  CURSOR curSent IS   
        	Select distinct 'yes'         		
        	From epic.eh_booking_custody_status bc
        	Where bc.booking_id = p_booking_id
        	and bc.code_custody_status = '5';
        	
v_Status		varchar2(3);      
BEGIN	
  	OPEN curSent;
  		FETCH curSent INTO v_status;
  	CLOSE curSent;
-- If we found a Work Release status, 'v_status' will be set to 'yes', if not return 'no'
RETURN NVL (v_status,'no');
  		
END;
--KJH

 
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_StatuteCategory
 (p_charge_id		in		EPIC.eh_charge.charge_id%type)
 
/*	
Purpose:		Returns 'PA325' if the given charge is classified as assaultive or resides under the PA325 category
Change Log:		Changed By	 Date Modified	Change Made
				----------	 -------------	------------------------------------------
				R. Stuve	 04/10/06		Verified MACOMB/EPIC schema
*/ 
 
RETURN EPIC.eh_statute_category.category_name%type
AS

	CURSOR curStat IS
		SELECT	
			sc.category_name
        FROM
			EPIC.epic_statutes es,
			EPIC.eh_category_statute ec,
			EPIC.eh_statute_category sc,
			EPIC.eh_charge c
         WHERE
			c.statute_id = es.statute_id
			and es.statute_id = ec.statute_id
			and ec.statute_category_id = sc.statute_category_id
			and sc.category_name = 'PA325'
			and c.charge_id = p_charge_id;
	                                      
	vStatute    EPIC.eh_statute_category.category_name%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_statutenumber
 (p_charge_id		in		EPIC.eh_charge.charge_id%type) 

/*
Purpose: Returns the statute number for the given charge


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/	 
 
RETURN EPIC.epic_statutes.statute_number%type AS

	CURSOR curStat IS
		SELECT
			es.statute_number
		FROM
			EPIC.epic_statutes es,
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id
			and c.statute_id = es.statute_id;
	                                      
	vStatute     EPIC.epic_statutes.statute_number%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_statutetext
 (p_charge_id			in		EPIC.eh_charge.charge_id%type) 
 
/*
Purpose: Returns the statute description/text for the given charge


Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/
 
RETURN EPIC.epic_statutes.statute_description%type AS

	CURSOR curStat IS
		SELECT
			es.statute_description
		FROM
			EPIC.epic_statutes es,
			EPIC.eh_charge c
		WHERE
			c.charge_id = p_charge_id
			and c.statute_id = es.statute_id;
	                                      
	vStatute     EPIC.epic_statutes.statute_description%type;
BEGIN
    OPEN curStat;
		FETCH curStat INTO vStatute;
	CLOSE curStat;
	
RETURN vStatute;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_statute_no_desc
	(p_booking_id	in	epic.eh_booking.booking_id%type)
	
--This function is just for testing purposes: it is not used	
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

RETURN epic.epp_generic_ref_cursor.ref_cursor AS
 
curChargeNoDesc epic.epp_generic_ref_cursor.ref_cursor;
v_test epic.epic_statutes.statute_number%type;
v_test2 epic.epic_statutes.statute_description%type;  

BEGIN
 	OPEN curChargeNoDesc FOR
		SELECT 	es.statute_number as "Charge_Number",  
	       		es.statute_description as "Charge_Desc",
 		   		decode(es.code_statute_class,'FEL',1,2) as Idx 
 		   		
		FROM	epic.epic_statutes es,
				epic.eh_charge ec  
				
		WHERE	ec.booking_id = p_booking_id
	  			and ec.charge_state <> 6
	  			and es.statute_id = ec.statute_id
		ORDER BY Idx;
	
RETURN curChargeNoDesc;
	
END;
--RAS
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_statute_no_desc2
	(p_booking_id	in	epic.eh_booking.booking_id%type)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

return epic.epp_generic_ref_cursor.ref_cursor is 
       curChargeNoDesc epic.epp_generic_ref_cursor.ref_cursor;
       v_test epic.epic_statutes.statute_number%type;
       v_test2 epic.epic_statutes.statute_description%type;  

begin
    v_test := null;
    v_test2 := null;
	open curChargeNoDesc for
	select es.statute_number as "Charge_Number",  
	       es.statute_description as "Charge_Desc",
 		   decode(es.code_statute_class,'FEL',1,2) as Idx
	from 	
			epic.epic_statutes es,
			epic.eh_charge ec
	where ec.booking_id = p_booking_id
	  and ec.charge_state <> 6
	  and es.statute_id = ec.statute_id
	order by Idx;
	

 return curChargeNoDesc;
	
end;
/

CREATE OR REPLACE
function MACOMB.mcmb_fnt_statute_no_desc3
	(p_booking_id	in	epic.eh_booking.booking_id%type)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
return epic.epp_generic_ref_cursor.ref_cursor is 
       curChargeNoDesc epic.epp_generic_ref_cursor.ref_cursor;
       
begin
    
    open curChargeNoDesc for 
    select es.statute_number as "Charge_Number",  
	       es.statute_description as "Charge_Desc",
 		   decode(es.code_statute_class,'FEL',1,2) as Idx
	from 	
			epic.epic_statutes es,
			epic.eh_charge ec
	where ec.booking_id = p_booking_id
	  and ec.charge_state <> 6
	  and es.statute_id = ec.statute_id
	order by Idx;
	

 return curChargeNoDesc;
	
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_telephone_base
	(p_entity_id	in		epic.eh_address.entity_id%type)  
	

--Returns the base numbers of an inmate's most current telephone number
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_phone		epic.eh_telephone_records.base_number%type;

	CURSOR cur_phone IS
		SELECT
			t.base_number
		FROM
		 	epic.eh_telephone_records t,
		 	epic.eh_telephone_records t2
		WHERE    
			t.entity_id =  p_entity_id
			and t.entity_id = t2.entity_id
			and t.action_time >= t2.action_time
			
		ORDER BY t.action_time;
  
BEGIN
	OPEN cur_phone;
		FETCH cur_phone INTO v_phone;
	CLOSE cur_phone;
			
RETURN v_phone;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_temp_book_fix
	(p_entity_id	in		epic.eh_booking.entity_id%type)   
	
--Returns an inmate's release date in the mm/dd/yyyy format for the GVT file
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS

v_book_id				epic.eh_booking.final_release_date%type;

	CURSOR cur_book_id IS
		select
			bk.booking_id 
			from epic.eh_booking bk
			where bk.entity_id = p_entity_id
			and bk.booking_state = '3'
			and bk.end_date > epic.ef_min_date('2005080300:00:00-240');
  
BEGIN
	OPEN cur_book_id;
		FETCH cur_book_id INTO v_book_id;
	 	CLOSE cur_book_id;	
			
RETURN v_book_id;
END;
--KJH
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_test_status
(p_booking_id  IN epic.eh_booking.booking_id%TYPE)
/*	
	System: 		Unknown
	Purpose:		Returns an expiration date for the selected inmate entity_id

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/
RETURN VARCHAR2 AS
cursor cur_Status  is
Select
		--decode(stat.code_custody_status, '1', '4202', '4', '4229', '4201') as statcode,
		stat.date_start
		--stat.date_end
From
		epic.Eh_booking_custody_status stat
where stat.booking_id = p_booking_id
and stat.code_custody_status in  ('1', '4', '5')
and  stat.booking_id in
 			(Select bk.booking_id
  			from epic.eh_charge chg,
  			epic.eh_booking bk
  			where bk.booking_id = p_booking_id
  			and chg.charge_state = '6'
  			and bk.booking_state = '3'
  			and chg.disposition_reason in
  			('005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','TTP','CTS', 'PS325','EARLYRELEASE'))
  			order by date_start desc;
   v_Status	 epic.eh_charge.action_time%type;

BEGIN
	OPEN cur_Status;
		FETCH cur_Status INTO v_Status;
	CLOSE cur_Status;

RETURN v_Status;

END;
 --KJH

/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_TransType
	 (p_trans_id 	in 	EPIC.eh_trust_account_trans.trust_account_trans_id%TYPE) 

/*
Purpose: Returns the transaction type (Withdrawl, Deposit, Liability) for the given transaction

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curTrans IS 
  	SELECT 	m.description 
  	
	FROM 	EPIC.eh_chart_of_accts_master m,
			EPIC.eh_trust_account_trans t
			
	WHERE	t.code_source_of_funds = m.gl_account_number
			and t.trust_account_trans_id = p_trans_id;
     
     
vTrans	    EPIC.eh_chart_of_accts_master.description%TYPE;


BEGIN
  	OPEN curTrans;
  	FETCH curTrans INTO vTrans;
  	CLOSE curTrans;

  	RETURN vTrans;
  	 	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_trust_id 
	(p_entity_id		in		epic.eh_entity_person.entity_id%type) 

--Returns the inmate's trust account id for the given entity id	
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	
RETURN VARCHAR2 AS

v_acctID 	epic.eh_trust_account.trust_account_id%type;

	CURSOR cur_acctID IS
		SELECT
			ta.trust_account_id
		FROM
		 	epic.eh_trust_account ta
		WHERE    
			ta.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_acctID;
		FETCH cur_acctID INTO v_acctID;
	CLOSE cur_acctID;
			
RETURN v_acctID;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Unpaid
	 (p_sentence_id 	in	EPIC.eh_sentence.sentence_id%TYPE) 

/*
Purpose: Returns a 'UP' flag if an inmate has an unpaid sentence (pay-or-stay) for the given sentence id	

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/7/06			Verified MACOMB/EPIC schema
*/			 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	'UP' 

	FROM	EPIC.eh_sentence s,
	        EPIC.eh_sentence_out_dates sod
	
	WHERE	s.sentence_id = sod.sentence_id
			and EPIC.ef_epic_date_to_date(s.sentence_end_date) = EPIC.ef_epic_date_to_date(sod.unpaid_out_date)
			and EPIC.ef_epic_date_to_date(sod.paid_out_date) <> EPIC.ef_epic_date_to_date(sod.unpaid_out_date)
			and s.sentence_id = p_sentence_id;     
     
v_status varchar2(20);


BEGIN
	-- Look for any sentence that is upaid:  
  	OPEN curSent;
  	FETCH curSent INTO v_status;
  	CLOSE curSent;
	-- If we found an unpaid sentence, 'v_status' will be set to 'UP', if not return a null
  	RETURN NVL (v_status, null);
  	
  	
END;

--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_user
	(p_action_by		in		EPIC.epic_user_names.action_by%type)   

/*
Purpose: Returns the user name associated with the action_by number

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN    EPIC.epic_col_types.varchar_2000%type
IS   
	CURSOR curUser IS
		SELECT
			un.user_name_last || ', ' || un.user_name_first || ' ' || un.user_name_middle
		FROM
		 	EPIC.epic_user_names un	
		WHERE    
			un.user_int_id = p_action_by;
		
vUser       EPIC.epic_col_types.varchar_2000%type;
  
BEGIN	
	OPEN curUser;
		FETCH curUser into vUser;
	RETURN vUser;
	CLOSE curUser;
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Vist_app_date
	 (p_entity_id	in 	epic.EH_ENTITY_RELATIONSHIP.ENTITY_RELATED_TO%TYPE) 
	 
--Returns an application date for the selected inmate entity_id
/*	
	System: 		Unknown
	Purpose:		Returns an expiration date for the selected inmate entity_id

	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/	 
RETURN VARCHAR2 AS
  CURSOR curEntity IS 
	select va.application_date
    from epic.EH_VISIT_AUTHORIZATION va
    where va.visitor_id = p_entity_id;
    
vApplDate	 epic.EH_VISIT_AUTHORIZATION.application_date%TYPE;


BEGIN
  	OPEN curEntity;
  		FETCH curentity INTO vApplDate;
  	CLOSE curEntity;

  	RETURN vApplDate;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_Vist_expir_date
	 (p_entity_id	in 	epic.EH_ENTITY_RELATIONSHIP.ENTITY_RELATED_TO%TYPE) 
	 
--Returns an expiration date for the selected inmate entity_id
/*	
	System: 		Unknown
	Purpose:		Returns an expiration date for the selected inmate entity_id

	Author:			J. McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 	 
RETURN VARCHAR2 AS
  CURSOR curEntity IS 
	select va.expiration_date 
	from epic.EH_VISIT_AUTHORIZATION va 
	where va.visitor_id = p_entity_id;
    
vexpirDate	 epic.EH_VISIT_AUTHORIZATION.expiration_date%TYPE;


BEGIN
  	OPEN curEntity;
  		FETCH curentity INTO vexpirDate;
  	CLOSE curEntity;

  	RETURN vexpirDate;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_weekender
	(	p_book_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on a booking_id (queries against the 
		  eh_booking_Custody_Status table for any status of '4229'  during current booking

Change Log:		Changed By	Date Modified	       Change Made
				----------	-------------	------------------------------------------
				K. Heinz		09/18/06			 
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
	
		SELECT	DISTINCT 'W' 
		
		FROM 	EPIC.eh_booking_custody_status
		WHERE        p_book_id = booking_id;
		
vStat		varchar2(128);

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'N');
	
END;
--kjh
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_weekend_status
	(	p_book_id		in	EPIC.eh_booking.booking_id%type) 

/*
Purpose: Returns the Inmate Status based on a booking_id (queries against the 
		  'Charge Status' other attribute in Offendertrak)

Change Log:		Changed By	Date Modified	       Change Made
				----------	-------------	------------------------------------------
				K. Heinz		09/07/06			Verified MACOMB/EPIC schema
*/	

RETURN VARCHAR2 AS 
	CURSOR curStat IS
	
		SELECT	DISTINCT 'Y' --EPIC.ef_lookup_text('CHARGE STATUS', 'SENTENCED WEEKENDER', 'UC') 
		
		FROM 	EPIC.eh_generic_attribute g,
		            --EPIC.eh_booking book,
		            epic.eh_charge chg 
		
		WHERE p_book_id = chg.booking_id      
		 and	        g.attribute_name = 'CHARGE STATUS'
		AND 			chg.charge_id = g.item_id
		and 			g.attribute_value IN ('21' , '28');

vStat		varchar2(128);

BEGIN
	OPEN curStat;
		FETCH curStat INTO vStat;
	CLOSE curStat;
		

RETURN NVL (vStat, 'N');
	
END;
--kjh
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_weight 
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type) 

--Returns an inmate's weight
	
RETURN VARCHAR2
IS
v_weight	EPIC.eh_entity_weight.weight%type;

	CURSOR cur_weight IS
		SELECT
			w.weight
		FROM
		 	EPIC.eh_entity_weight w	
		WHERE    
			w.entity_id =  p_entity_id;
  
BEGIN
	OPEN cur_weight;
		FETCH cur_weight INTO v_weight; 
	CLOSE cur_weight;
			
RETURN v_weight;

END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_fnt_wrlstime 
	(p_entity_id		IN		EPIC.eh_entity_person.entity_id%type)

/*
Purpose: Returns the release time for weekender/work-release inmates

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	4/6/06			Verified MACOMB/EPIC schema
*/	
	
RETURN VARCHAR2
IS
v_time			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR cur_time IS
		SELECT
			g.attribute_value
		FROM
		 	EPIC.eh_generic_attribute g,
		 	EPIC.eh_sentence s,
		 	EPIC.eh_charge c,
		 	EPIC.eh_booking b
		 		
		WHERE    
			g.attribute_name = 'WEEKENDER RELEASE TIME'
			and g.item_id = s.sentence_id
			and s.sentence_id = c.sentence_id 
			and c.charge_state <> 6    -- added 3-1-06 MZ (not needed if in the procedure)
			and c.booking_id = b.booking_id
			and b.entity_id =  p_entity_id
		ORDER by g.action_time desc;    -- added desc 3-1-06;
  
BEGIN
	OPEN cur_time;
		FETCH cur_time INTO v_time;
	CLOSE cur_time;
			
RETURN v_time;

END;
--RAS
/

CREATE OR REPLACE
package MACOMB.mcmb_generic_ref_cursor is
--
--	Feb 1, 2006 , J McBratnie
--		Generic reference cursor definition for functions returning record sets
--

	type ref_cursor is ref cursor;

end mcmb_generic_ref_cursor;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_get_booking_shift
	
	(p_book_date		in		EPIC.eh_booking.start_date%TYPE)
	
--given a booking start date, returns the shift that coincides with the booking (days, afts or mids)
	
RETURN VARCHAR2 AS

v_shift		VARCHAR2(128);

	CURSOR cur_shift IS
	Select
	DECODE(TO_CHAR(substr(EPIC.ef_epic_date_to_date(p_book_date),12,2)),    
  					'00', 'MIDNIGHT',
  					'01', 'MIDNIGHT',
  					'02', 'MIDNIGHT',
  					'03', 'MIDNIGHT',
  					'04', 'MIDNIGHT',
  					'05', 'MIDNIGHT',
  					'06', 'MIDNIGHT',
  					'07', 'MIDNIGHT',
  						'08', 'DAY',
  						'09', 'DAY',
  						'10', 'DAY',
  						'11', 'DAY',
  						'12', 'DAY',
  						'13', 'DAY',
  						'14', 'DAY',
  						'15', 'DAY',
  							'16', 'AFTERNOON',
  							'17', 'AFTERNOON',
  							'18', 'AFTERNOON',
  							'19', 'AFTERNOON',
  							'20', 'AFTERNOON',
  							'21', 'AFTERNOON',
  							'22', 'AFTERNOON',
  							'23', 'AFTERNOON') from dual;
  
BEGIN
	OPEN cur_shift;
		FETCH cur_shift INTO v_shift;
		CLOSE cur_shift;
			
RETURN v_shift;

END;

/

CREATE OR REPLACE
procedure MACOMB.mcmb_get_rmbsmt_trans
	(p_last_run_date in epic.eh_address.action_time%type,
	vEntID IN OUT epic.epp_generic_ref_cursor.ref_cursor)
is	
-- 	 
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
BEGIN

OPEN vEntID FOR

	select trust.entity_id,
		trans.trust_account_id,
		trans.description,
		trans.amount,
		trans.trans_date,
		stat.code_custody_status,
		oi.offender_id


        from
         epic.eh_trust_account_trans trans,
         epic.eh_trust_account trust,
         epic.eh_offender_ids oi,
         epic.eh_entity_status stat,
         epic.eh_entity_person ep,
         epic.eh_person_identity pi

   where
   
     trust.entity_id = oi.entity_id and
     ep.primary_identity_id = pi.identity_id and
     trust.entity_id = stat.entity_id and
     trans.trust_account_id = trust.trust_account_id and
     trans.trans_date > p_last_run_date and
    trans.code_source_of_funds = '505' and
    trans.reverse_flag is null;

END mcmb_get_rmbsmt_trans;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_get_status_dates 
	(p_booking_id	in		epic.eh_booking.booking_id%type,
	 p_dispo_date    in      epic.eh_booking.end_date%type,
	 p_status       out  epic.eh_booking_custody_status.code_custody_status%type,
	 p_nbr_of_days  out  epic.eh_sentence_duration.days%type)
 
IS	
--Returns all custody statuses (eh_booking_custody_status.code_custody_status), and the number of days inmate was set to this status
--for a booking.  Booking must have a status of 'CLOSED' and charge must have a status of 'DISPOSED'
--with a disposition reason that includes a sentence. Lookup_codes approved by Sgt. roberts. 
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	CURSOR cur_Stat Is
		Select 
		stat.code_custody_status,
		Stat.date_start,
		stat.date_end
		From
		epic.Eh_booking_custody_status stat
		where p_booking_id = stat.booking_id
			and  stat.booking_id in
 			(Select bk.booking_id
  			from epic.eh_charge chg,
  			     epic.eh_booking bk
  			where chg.charge_state = '6'
  			and bk.booking_state = '3'
  			and chg.disposition_reason in 
  			('005','007','1012','1014','1021','1022','1027','1031','1032','1035','1037','1038','1051','CTS', 'PS325','EARLYRELEASE'))
  			order by date_start desc; 	
  						 
cv_Stat			varchar2(128);
cv_start_date	varchar2(128);
cv_end_date		varchar2(128);
v_prev_start_date	varchar2(128); 
v_end_date        varchar2(128); 
v_nbr_of_days   epic.eh_sentence_duration.days%type;
  
BEGIN

If cur_Stat %NOTFOUND then
	v_prev_start_date := NULL;
END IF;
	OPEN cur_Stat;
	Loop
		FETCH cur_Stat INTO cv_Stat, cv_start_date, cv_end_date;
	EXIT WHEN cur_Stat%NOTFOUND;
		 
	If cv_stat in ('1', '4', '5') then
		
		If v_prev_start_date  is null then  --If this is the first record, use DispoDate as end date
			v_end_date := p_dispo_date;    
		Else
			v_end_date := v_prev_start_date; --otherwise use the date_start of the previous record
		End If;
		v_nbr_of_days := ABS((epic.ef_epic_date_diff(cv_start_date,v_end_date))+ 1);-- Plus 1 per Lori 
		v_prev_start_date :=  cv_start_date;
		p_nbr_of_days := v_nbr_of_days;
		p_status := cv_stat;
	END IF;	
	CLOSE cur_Stat;
	END LOOP;	
RETURN ;
END;
 --KJH
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_agency
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_hold_id          in              epic.eh_booking_holds.hold_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is

	cursor curAgency is
		select substr(epic.ef_get_personororgname (book.entity_id), 1,255)
		from epic.eh_trust_account_trans tran,
			epic.eh_booking_holds hold,
			epic.eh_booking book,
			epic.eh_generic_attribute ga
where tran.bank_id = ga.attribute_value
and ga.item_id = hold.hold_id
and ga.attribute_value = 'HEINZ57'
and hold.booking_id = book.booking_id;

begin
    
		open curAgency;
		fetch curAgency into p_return;
		if curAgency%notfound then
			p_return := 'NOT FOUND';
		end if;
		close curAgency;
	 
	return;

end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_court_line2

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is



	cursor curCourt is

	select trim(ad.street_number || ' ' || ad.street_name)

	from epic.eh_trust_account_trans tat,

		 epic.eh_address ad

	where tat.trust_account_trans_id = p_trans_id

	and ad.entity_id = tat.payee

	and ad.primary_flag = 'Y';


begin



	open curCourt;

	fetch curCourt into p_return;

	if curCourt%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curCourt;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_court_line3
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
	
	cursor curCourt is
	select trim(ad.city_town_locale || ', ' || ad.state_province_region || ' ' || ad.postal_code)
	from epic.eh_trust_account_trans tat,
		 epic.eh_address ad
	where tat.trust_account_trans_id = p_trans_id
	and ad.entity_id = tat.payee
	and ad.primary_flag = 'Y';
	
	
begin                          
                                 
	open curCourt;
	fetch curCourt into p_return;
	if curCourt%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curCourt;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_court_name

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is



	cursor curName is

	select eo.organization_name

	from epic.eh_trust_account_trans trans,
	
		 epic.eh_entity_organization eo

	where trans.trust_account_trans_id = p_trans_id

	and trans.payee = eo.entity_id;



begin



	open curName;

	fetch curName into p_return;

	if curName%notfound then

		p_return := '<NOT FOUND>';

	end if;

	close curName;



	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_inmate_name

	(p_inmate_nbr		in				epic.eh_offender_ids.offender_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is

	v_entity_id			epic.eh_booking.entity_id%type;

	v_temp				number;

	v_return			varchar2(255);



	cursor curInmate is

		select epic.ef_get_personororgname(pi.entity_id)

		from epic.eh_trust_account_trans tran,

		     epic.eh_trust_account ta,
		     
		     epic.eh_offender_ids oi,

		     epic.eh_person_identity pi

		where  	tran.description = p_inmate_nbr
		and     tran.trust_account_id = ta.trust_account_id
		and 	ta.entity_id = oi.entity_id
		and 	oi.entity_id = pi.entity_id;
                                   
begin
     
		open curInmate;

		fetch curInmate into v_entity_id;

		if curInmate%notfound then

			v_entity_id := 'NOT FOUND';

		end if;

		close curInmate;
      
	if v_entity_id <> 'NOT FOUND' then

		p_return := trim(epic.ef_get_personororgname(v_entity_id));

	end if;

	return;

end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_inmate_number

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is
   
	cursor curNumber is

 select DESCRIPTION
 from epic.eh_trust_account_trans tran
 where tran.trust_account_trans_id = p_trans_id;
         
    
	
begin                          
                                 
	open curNumber;
	fetch curNumber into p_return;
	if curNumber%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curNumber;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_on_docket_cap

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is





begin



	p_return := 'On Warrant #';

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_remitted_by
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
	
	cursor curPayor is
select PAYEE_OR
from epic.EH_TRUST_ACCOUNT_TRANS tran
where tran.trust_account_trans_id = p_trans_id;
--where code_source_of_funds = '475'
begin                          
                                 
	open curPayor;
	fetch curPayor into p_return;
	if curPayor%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curPayor;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_user_name

	(p_trans_id			in			epic.eh_trust_account_trans.trust_account_trans_id%type,

	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is


begin



	p_return := epic.epp_user_info.get_name('13', 'UC');

	return;



end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_voucher_reason
	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
is
		cursor curReason is
	   
    select epic.EF_LOOKUP_TEXT('HOLD REMOVE REASON', '999', 'UC')as remove_reason
	from epic.eh_generic_attribute ga,
		epic.eh_trust_account_trans tran,
		epic.eh_booking_holds hold
	where ga.attribute_name = 'HOLD WARRANT NUMBER'
	AND tran.bank_id = ga.attribute_value
	and ga.item_id = hold.hold_id
	and ga.attribute_value = 'HEINZ57';
  
begin                          
                                 
	open curReason;
	fetch curReason into p_return;
	if curReason%notfound then
		p_return := '<NOT FOUND>';
	end if;
	close curReason;

	return;
	
end;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_hold_chk_warrant_number

	(p_trans_id			in				epic.eh_trust_account_trans.trust_account_trans_id%type,
	 p_return			in out			varchar2)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

is
   	cursor curWarrant is

		select --epic.ef_lookup_text('HOLD WARRANT NUMBER', ga.attribute_value, 'UC')
		trans.invoice_reference
		
		from epic.eh_trust_account_trans trans
		     --epic.eh_trust_account tacct,
		     --epic.eh_generic_attribute ga,
		     --epic.eh_booking book,
		    -- epic.eh_booking_holds hold
           		     
		where
		trans.trust_account_trans_id = p_trans_id;
		--AND trans.trust_account_id =  tacct.trust_account_id
		--and tacct.entity_id = book.entity_id
		--and book.booking_id = hold.booking_id
		--and ga.item_id = hold.booking_id
		--and ga.attribute_name = 'HOLD WARRANT NUMBER';
   begin
             
		open curWarrant;

		fetch curWarrant into p_return;

		if curWarrant%notfound then

			p_return := 'NOT FOUND';

		end if;

		close curWarrant;
    	
	return;



end;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MCMB_HOUSING_NEW 
(vCur 		in out	sys_refcursor)	
--epic.epp_generic_ref_cursor.ref_cursor)
AS

/*
	Purpose:		Top of Housing report: Summary counts of sentenced/unsentenced inmates by 
					gender and housing type (Holding and General) and Inmate status
	Author:			Kelly Heinz  10/06/2011

	Change Log:		Changed By	Date Modified	Change Made
	----------	-------------	------------------------------------------	*/
CURSOR curCount is
Select distinct
  EPIC.ef_offender_id(b.entity_id)as OffenderID,
  mcmb_fnt_gendershort(b.entity_id) as sex, --also pulled from eh_entity_person
	mcmb_fnt_JuvFlag(b.entity_id) as juvenile,
	MACOMB.mcmb_fnt_sentallchgs(b.entity_id) as SentStatus,--'U' or 'S'
  MACOMB.mcmb_entity_status(b.entity_id) as Status, --W, LC, JUV, ETC.
  decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') as House,
  b.entity_id as entity_ID

			FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b

		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6'
				and m.in_muster_flag = 'Y';


--Declare variables 
    TYPE curHouse IS REF CURSOR;
    v_entity_id     epic.eh_offender_ids.entity_id%type;
    v_Sex           varchar2(16);
    v_Juvenile      varchar2(16);
		v_Status        varchar2(16);
		v_House         varchar2(16);
		v_OffenderID    epic.eh_offender_ids.offender_id%type;
		v_SentStatus    varchar2(16); 
    TotGenMun       number;
    TotGenMsent     number;
    TotGenFun       number; 
    TotGenFsent     number;
    TotGenOun       number;
    TotGenOsent     number; 
    TotHoldMun      number;
    TotHoldMsent    number;
    TotHoldFun      number; 
    TotHoldFsent    number;
    TotHoldOun      number;
    TotHoldOsent    number;
    TotalGeneral    number;
    TotalHolding    number;
    TotWeekend      number;
    MaleWeekend number;
    FemWeekend number;
    OtherWeekend number;
    TotLapeer number;
    MaleLapeer number;
    FemLapeer number;
    OtherLapeer number;
    TotJuv number;
    MaleJuv number;
    FemJuv number;
    OtherJuv number;
    TotFed number;
    MaleFed number;
    FemFed number;
    OtherFed number;
    TotOak number;
    MaleOak number;
    FemOak number;
    OtherOak number;
    TotSC number;
    MaleSC number;
    FemSC number;
    OtherSC number;
    TotParole number;
    MaleParole number;
    FemParole number;
    OtherParole number;
    TotWR number;
    MaleWR number;
    FemWR number;
    OtherWR number;
    GrandTotal  number;
    TotNoStat   number;
						
    BEGIN
--Initialize variables
--Totals for General Housing and Holding table
    v_entity_id := ' ';
    v_sex := ' ';
    v_Juvenile := 'N';
    v_status := ' ';
    v_House := ' ';
    v_OffenderID := ' ';
    v_SentStatus := ' ';
    TotGenMun := 0;
    TotGenMsent := 0 ;
    TotGenFun := 0; 
    TotGenFsent := 0;
    TotGenOun := 0;
    TotGenOsent := 0; 
    TotHoldMun := 0;
    TotHoldMsent  := 0;
    TotHoldFun  := 0; 
    TotHoldFsent := 0;
    TotHoldOun := 0;
    TotHoldOsent := 0;
    TotalGeneral := 0;
    TotalHolding := 0;
--For 2nd table containing status counts for male,female and other
    TotWeekend := 0;
    MaleWeekend := 0;
    FemWeekend := 0;
    OtherWeekend := 0;
    TotLapeer := 0;
    MaleLapeer := 0;
    FemLapeer := 0;
    OtherLapeer := 0;
    TotJuv := 0;
    MaleJuv := 0;
    FemJuv := 0;
    OtherJuv := 0;
    TotFed := 0;
    MaleFed := 0;
    FemFed := 0;
    OtherFed := 0;
    TotOak := 0;
    MaleOak := 0;
    FemOak := 0;
    OtherOak := 0;
    TotSC := 0;
    MaleSC := 0;
    FemSC := 0;
    OtherSC := 0;
    TotParole := 0;
    MaleParole := 0;
    FemParole := 0;
    OtherParole := 0;
    TotWR := 0;
    MaleWR := 0;
    FemWR := 0;
    OtherWR := 0;
    GrandTotal := 0;
    TotNoStat := 0;
   
   for recCount in curCount   --"for"statement does the open and fetch without explicitly declaring them
    loop --Determine gender, juvenile and sentenced or unsentenced and housing location
    exit when curCount%notfound;
      v_entity_id := recCount.entity_id;
      v_sex := recCount.sex;
      v_Juvenile := recCount.Juvenile;      
      v_OffenderID := recCount.OffenderID;
      v_sentstatus := recCount.SentStatus; -- sentenced?
      v_status := recCount.status;--returns inmate status from eh_entity_status
      v_House := recCount.House;
--DBMS_OUTPUT.put_line('ID:  ' || v_offenderid);
      If v_juvenile = 'Y' then
        v_status := 'J';
      End if;
      
          CASE  
            When v_sex ='M' then  --Gender is male 
           
            Case v_status
              When 'W' then
                MaleWeekend := MaleWeekend + 1;
              When 'LC' then  
                MaleLapeer := MaleLapeer + 1;
               When 'F' then 
                MaleFed := MaleFed + 1;
              When 'OC' then
                MaleOak := MaleOak + 1;
              When 'SCC' then
                MaleSC := MaleSC + 1;
              When 'P' then
                MaleParole := MaleParole + 1;
--DBMS_OUTPUT.put_line('Parole  ' || MaleParole);
              When 'WR' then
                MaleWR := MaleWR + 1;
              When 'J' then 
                MaleJuv := MaleJuv + 1;
              Else
                TotNoStat := TotNoStat + 1;
            End Case; --v_status, sex = M          
               If v_house = 'H' then
                TotalHolding := TotalHolding + 1; 
--DBMS_OUTPUT.put_line(' MWeekend ' || MaleWeekend);  
                If v_SentStatus = 'U' then
                  TotHoldMun := TotHoldMun + 1;
--DBMS_OUTPUT.put_line('TotHoldMun ' || TotHoldMun);
                else 
                  TotHoldMsent := TotHoldMsent + 1;
--DBMS_OUTPUT.put_line('TotHoldMsent ' || TotHoldMsent);
                End if; --SentStatus
              Else --v_house = 'G'
                TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenMun := TotGenMun + 1;
--DBMS_OUTPUT.put_line('TotGenMun ' || TotGenMun);
                else 
                  TotGenMsent := TotGenMsent + 1;
--DBMS_OUTPUT.put_line('TotGenMsent ' || TotGenMsent);
                End if;  -- SentStatus
              End if;  --house 
 
       When v_sex = 'F' then --Case v_sex is female
          Case v_status
             When 'W' then
                FemWeekend := FemWeekend + 1;
             When 'LC' then  
                FemLapeer := FemLapeer + 1;
             When 'F' then 
                 FemFed := FemFed + 1;
             When 'OC' then
                 FemOak := FemOak + 1;
             When 'SCC' then
                 FemSC := FemSC + 1;
             When 'P' then
                 FemParole := FemParole + 1;
             When 'WR' then
                 FemWR := FemWR + 1;
             When 'J' then 
                 FemJuv := FemJuv + 1;
             Else
                TotNoStat := TotNoStat + 1;
            End Case; --v_status
            If v_house = 'H' then
              TotalHolding := TotalHolding + 1;              
              If v_SentStatus = 'U' then
                TotHoldFun := TotHoldFun + 1;
--DBMS_OUTPUT.put_line('TotHoldFun ' || TotHoldFun);
              else 
                TotHoldFsent := TotHoldFsent + 1;
--DBMS_OUTPUT.put_line('TotHoldFsent ' || TotHoldFsent);
              End if; --SentStatus
            Else --v_house = 'G'
              TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenFun := TotGenFun + 1; 
--DBMS_OUTPUT.put_line('TotGenFun ' || TotGenFun);
                else 
                  TotGenFsent := TotGenFsent + 1;
--DBMS_OUTPUT.put_line('TotGenFsent ' || TotGenFsent);
                End if;  -- SentStatus
            End if;  --house
              
          When v_sex ='U' then --Case sex = "Other OR UNKNOWN"
          Case v_status
             When 'W' then
                OtherWeekend := OtherWeekend + 1;
             When 'LC' then  
                  OtherLapeer := OtherLapeer + 1;
             When 'F' then 
                  OtherFed := OtherFed + 1;
             When 'OC' then
                  OtherOak := OtherOak + 1;
             When 'SCC' then
                  OtherSC := OtherSC + 1;
             When 'P' then
                  OtherParole := OtherParole + 1;
             When 'WR' then
                  OtherWR := OtherWR + 1;
             When 'J' then 
                  OtherJuv := OtherJuv + 1;
             Else
              TotNoStat := TotNoStat + 1;
            End Case; --v_status
            If v_house = 'H' then
              TotalHolding := TotalHolding + 1;              
              If v_SentStatus = 'U' then
                TotHoldOun := TotHoldOun + 1;                
              else 
                TotHoldOsent := TotHoldOsent + 1;
              End if; --SentStatus
            Else --v_house = 'G'
              TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenOun := TotGenOun + 1;                
                else 
                  TotGenOsent := TotGenOsent + 1;
                End if;  -- SentStatus
            End if;  --house
         End Case; --gender   
--DBMS_OUTPUT.put_line('MaleOak ' || MaleOak);
    End Loop; --recCount loop
END MCMB_HOUSING_NEW;
/

CREATE OR REPLACE
PACKAGE MACOMB.MCMB_HOUSING_RPT AS

  procedure process_request	
  (Vcur		OUT	EPIC.epp_generic_ref_cursor.ref_cursor);

END MCMB_HOUSING_RPT;
/

CREATE OR REPLACE
PACKAGE BODY MACOMB.MCMB_HOUSING_RPT as


        
PROCEDURE process_request
(vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
AS

/*
	Purpose:		Top of Housing report: Summary counts of sentenced/unsentenced inmates by 
					gender and housing type (Holding and General) and Inmate status
	Author:			Kelly Heinz  10/06/2011

	Change Log:		Changed By	Date Modified	Change Made
	----------	-------------	------------------------------------------	*/
CURSOR curCount is
Select distinct
  EPIC.ef_offender_id(b.entity_id)as OffenderID,
  mcmb_fnt_gendershort(b.entity_id) as sex, --also pulled from eh_entity_person
	mcmb_fnt_JuvFlag(b.entity_id) as juvenile,
	MACOMB.mcmb_fnt_sentallchgs(b.entity_id) as SentStatus,--'U' or 'S'
  MACOMB.mcmb_entity_status(b.entity_id) as Status, --W, LC, JUV, ETC.
  decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') as House,
  b.entity_id as entity_ID

			FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b

		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6'
				and m.in_muster_flag = 'Y';


--Declare variables                
    v_entity_id     epic.eh_offender_ids.entity_id%type;
    v_Sex           varchar2(16);
    v_Juvenile      varchar2(16);
		v_Status        varchar2(16);
		v_House         varchar2(16);
		v_OffenderID    epic.eh_offender_ids.offender_id%type;
		v_SentStatus    varchar2(16); 
    TotGenMun       number;
    TotGenMsent     number;
    TotGenFun       number; 
    TotGenFsent     number;
    TotGenOun       number;
    TotGenOsent     number; 
    TotHoldMun      number;
    TotHoldMsent    number;
    TotHoldFun      number; 
    TotHoldFsent    number;
    TotHoldOun      number;
    TotHoldOsent    number;
    TotalGeneral    number;
    TotalHolding    number;
    TotWeekend      number;
    MaleWeekend number;
    FemWeekend number;
    OtherWeekend number;
    TotLapeer number;
    MaleLapeer number;
    FemLapeer number;
    OtherLapeer number;
    TotJuv number;
    MaleJuv number;
    FemJuv number;
    OtherJuv number;
    TotFed number;
    MaleFed number;
    FemFed number;
    OtherFed number;
    TotOak number;
    MaleOak number;
    FemOak number;
    OtherOak number;
    TotSC number;
    MaleSC number;
    FemSC number;
    OtherSC number;
    TotParole number;
    MaleParole number;
    FemParole number;
    OtherParole number;
    TotWR number;
    MaleWR number;
    FemWR number;
    OtherWR number;
    GrandTotal  number;
    TotNoStat   number;
						
    BEGIN
--Initialize variables
--Totals for General Housing and Holding table
    v_entity_id := ' ';
    v_sex := ' ';
    v_Juvenile := 'N';
    v_status := ' ';
    v_House := ' ';
    v_OffenderID := ' ';
    v_SentStatus := ' ';
    TotGenMun := 0;
    TotGenMsent := 0 ;
    TotGenFun := 0; 
    TotGenFsent := 0;
    TotGenOun := 0;
    TotGenOsent := 0; 
    TotHoldMun := 0;
    TotHoldMsent  := 0;
    TotHoldFun  := 0; 
    TotHoldFsent := 0;
    TotHoldOun := 0;
    TotHoldOsent := 0;
    TotalGeneral := 0;
    TotalHolding := 0;
--For 2nd table containing status counts for male,female and other
    TotWeekend := 0;
    MaleWeekend := 0;
    FemWeekend := 0;
    OtherWeekend := 0;
    TotLapeer := 0;
    MaleLapeer := 0;
    FemLapeer := 0;
    OtherLapeer := 0;
    TotJuv := 0;
    MaleJuv := 0;
    FemJuv := 0;
    OtherJuv := 0;
    TotFed := 0;
    MaleFed := 0;
    FemFed := 0;
    OtherFed := 0;
    TotOak := 0;
    MaleOak := 0;
    FemOak := 0;
    OtherOak := 0;
    TotSC := 0;
    MaleSC := 0;
    FemSC := 0;
    OtherSC := 0;
    TotParole := 0;
    MaleParole := 0;
    FemParole := 0;
    OtherParole := 0;
    TotWR := 0;
    MaleWR := 0;
    FemWR := 0;
    OtherWR := 0;
    GrandTotal := 0;
    TotNoStat := 0;
   
   for recCount in curCount   --"for"statement does the open and fetch without explicitly declaring them
    loop --Determine gender, juvenile and sentenced or unsentenced and housing location
    exit when curCount%notfound;
      v_entity_id := recCount.entity_id;
      v_sex := recCount.sex;
      v_Juvenile := recCount.Juvenile;      
      v_OffenderID := recCount.OffenderID;
      v_sentstatus := recCount.SentStatus; -- sentenced?
      v_status := recCount.status;--returns inmate status from eh_entity_status
      v_House := recCount.House;
--DBMS_OUTPUT.put_line('ID:  ' || v_offenderid);
      If v_juvenile = 'Y' then
        v_status := 'J';
      End if;
      
          CASE  
            When v_sex ='M' then  --Gender is male 
           
            Case v_status
              When 'W' then
                MaleWeekend := MaleWeekend + 1;
              When 'LC' then  
                MaleLapeer := MaleLapeer + 1;
               When 'F' then 
                MaleFed := MaleFed + 1;
              When 'OC' then
                MaleOak := MaleOak + 1;
              When 'SCC' then
                MaleSC := MaleSC + 1;
              When 'P' then
                MaleParole := MaleParole + 1;
              When 'WR' then
                MaleWR := MaleWR + 1;
              When 'J' then 
                MaleJuv := MaleJuv + 1;
              Else
                DBMS_OUTPUT.put_line('Status not counted');
            End Case; --v_status, sex = M          
               If v_house = 'H' then
                TotalHolding := TotalHolding + 1; 
  --DBMS_OUTPUT.put_line(' MWeekend ' || MaleWeekend);  
                If v_SentStatus = 'U' then
                  TotHoldMun := TotHoldMun + 1;
  --DBMS_OUTPUT.put_line('TotHoldMun ' || TotHoldMun);
                else 
                  TotHoldMsent := TotHoldMsent + 1;
  --DBMS_OUTPUT.put_line('TotHoldMsent ' || TotHoldMsent);
               End if; --SentStatus
              Else --v_house = 'G'
                TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenMun := TotGenMun + 1;                
                else 
                  TotGenMsent := TotGenMsent + 1;
                End if;  -- SentStatus
              End if;  --house
 
 
       When v_sex = 'F' then --Case v_sex is female
          Case v_status
             When 'W' then
                FemWeekend := FemWeekend + 1;
             When 'LC' then  
                FemLapeer := FemLapeer + 1;
             When 'F' then 
                 FemFed := FemFed + 1;
             When 'OC' then
                 FemOak := FemOak + 1;
             When 'SCC' then
                 FemSC := FemSC + 1;
             When 'P' then
                 FemParole := FemParole + 1;
             When 'WR' then
                 FemWR := FemWR + 1;
             When 'J' then 
                 FemJuv := FemJuv + 1;
             Else
                DBMS_OUTPUT.put_line('Status not counted');
            End Case; --v_status
            If v_house = 'H' then
              TotalHolding := TotalHolding + 1;              
              If v_SentStatus = 'U' then
                TotHoldFun := TotHoldFun + 1;                
              else 
                TotHoldFsent := TotHoldFsent + 1;
              End if; --SentStatus
            Else --v_house = 'G'
              TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenFun := TotGenFun + 1;                
                else 
                  TotGenFsent := TotGenFsent + 1;
                End if;  -- SentStatus
            End if;  --house
              
          When v_sex ='U' then --Case sex = "Other OR UNKNOWN"
          Case v_status
             When 'W' then
                OtherWeekend := OtherWeekend + 1;
             When 'LC' then  
                  OtherLapeer := OtherLapeer + 1;
             When 'F' then 
                  OtherFed := OtherFed + 1;
             When 'OC' then
                  OtherOak := OtherOak + 1;
             When 'SCC' then
                  OtherSC := OtherSC + 1;
             When 'P' then
                  OtherParole := OtherParole + 1;
             When 'WR' then
                  OtherWR := OtherWR + 1;
             When 'J' then 
                  OtherJuv := OtherJuv + 1;
             Else
              DBMS_OUTPUT.put_line('Status not counted');
            End Case; --v_status
            If v_house = 'H' then
              TotalHolding := TotalHolding + 1;              
              If v_SentStatus = 'U' then
                TotHoldOun := TotHoldOun + 1;                
              else 
                TotHoldOsent := TotHoldOsent + 1;
              End if; --SentStatus
            Else --v_house = 'G'
              TotalGeneral := TotalGeneral + 1;
                If v_SentStatus = 'U' then
                  TotGenOun := TotGenOun + 1;                
                else 
                  TotGenOsent := TotGenOsent + 1;
                End if;  -- SentStatus
            End if;  --house
         End Case; --gender   

    End Loop; --recCount loop

  END process_request;  

END MCMB_HOUSING_RPT;
/

CREATE OR REPLACE
function MACOMB.mcmb_inmate_owning_agency
	(p_entity_id	in	epic.eh_person_identity.entity_id%type)
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/ 
return varchar2 is p_agency varchar2(50);

    v_booking_number varchar2(30);
    v_booking_id varchar2(30);
    v_charge_id varchar2(30);
    p_agency varchar2(100);
    v_charge_agency varchar2(100);
    v_agency varchar2(100);

begin

-- Get the max booking number
	select max(booking_number) into v_booking_number
	from epic.eh_booking
	where eh_booking.entity_id = p_entity_id; 	            -- p_entity_id  from call
--	where eh_booking.entity_id = '0IHUS574N0X24MIG'; 	            -- p_entity_id  from call

-- Get booking id
	select booking_id into v_booking_id
	from epic.eh_booking      		-- booking_id
	where booking_number = v_booking_number;

-- Get the max charge
	select max(charge_id) into v_charge_id
	from epic.eh_charge
	where booking_id = v_booking_id
	and disposition_reason is null;

-- Get charge agency
	select agency_id into v_charge_agency
	from epic.eh_charge_agency
	where charge_id = v_charge_id;

	select substr(epic.ef_get_personororgname(v_charge_agency), 1,255) into v_agency
	from dual;

RETURN v_agency;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mcmb_last_custody_status(
	p_booking_id 		in epic.eh_booking.booking_ID%type,
	p_status           out epic.eh_booking_custody_status.code_custody_status%type
 	)                           
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/14/07       move to Macomb schema from Production
					
*/  	
 	RETURN VARCHAR2
IS
    
   	cursor curStat is
	select
	       code_custody_status
	from epic.eh_booking_custody_status
	where
	 date_start in
		(select max(date_start)
		from epic.eh_booking_custody_status
		where booking_id = p_booking_id);
		
v_status_code   epic.eh_booking_custody_status.code_custody_status%type;

BEGIN
    open curStat;
	fetch curStat into v_status_code;
	if curStat%found then
		--if v_status_id is not null then
			p_status := v_status_code;
		--end if;
	end if;
	close curStat;

	return v_status_code;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_macomb_WEB_visitation
		(	curRest			OUT		mcmb_generic_ref_cursor.ref_cursor,
		    p_entity_id     in      EPIC.EH_OFFENDER_IDS.entity_id%type)

IS
 
 /*	
	WEB: 		    GIU grid
	Purpose:		Lists basic visitation information regarding inmate location and other key 
					data.

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 02/01/06		Created   
					J. McBratnie 02/15/06		Added restrictionuntil field
					
*/
    v_data	varchar2(255);
	
 BEGIN
 
	OPEN curRest FOR
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MACOMB.MCMB_VIEW_INMATE I,
    		MACOMB.WEB_VISITATION_CELL VC,
		    MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND I.CELL = VC.CELL
		  AND I.GENDER = VC.GENDER
		  AND VC.INMATETYPE <> 'J'
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID
		UNION
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MACOMB.MCMB_VIEW_INMATE I,
		     MACOMB.WEB_VISITATION_CELL VC,
		     MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND vc.CELL is null
		  AND I.GENDER = VC.GENDER
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.INMATETYPE IN ('O','K','G')
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID
		UNION
		SELECT  decode(V.ENTRANCE,'W', 'WEST ENTRANCE','MAIN LOBBY') as entrance,
				decode(V.DAYOFWEEK,'SUN','SUNDAY','MON','MONDAY','TUE','TUESDAY','WED','WEDNESDAY','THUR','THURSDAY','TBD') as DayofWeek,
				V.STARTTIME,
				V.ENDTIME,
				V.VISITINGAREA,
				V.VISITATION_TYPE,
				V.REPORT,
				i.RESTRICTIONUNTIL
		FROM MACOMB.MCMB_VIEW_INMATE I,
		     MACOMB.WEB_VISITATION_CELL VC,
		     MACOMB.WEB_VISITATION V
		WHERE ENTITY_ID = p_entity_id
		  AND vc.CELL is null
		  AND I.GENDER = VC.GENDER
		  AND I.JUVENILE_FLAG = VC.JUVENILE
		  AND I.INMATECLASS = VC.INMATETYPE
		  AND VC.INMATETYPE = 'J'
		  AND VC.WEB_VISITATION_ID = V.WEB_VISITATION_ID;
		  
	END;
/

CREATE OR REPLACE
TRIGGER MACOMB.MCMB_MJRS_Import
after insert  on MCMB_MJRS_IN
REFERENCING NEW AS NEW
for each row
--
--	trigger to convert GVT in file into 3 generic attribute rows
--
declare                   
    vsucess 				varchar2(5);    
    ventity_id              varchar2(16);   
    vid                     varchar2(16);
	
Begin       
	vsucess    := Null;                
	vid        := MCMB_FNT_get_entity_id(ltrim(:new.OFFENDER_ID, '0'));
	ventity_id := mcmb_fnt_trust_id(vid);
--	ventity_id := mcmb_fnt_trust_id('0IR6B8O000USJ1IR');
	
	--vitem := (select trust_account_id from eh_trust_account ta, eh_offender_ids i where ta.entity_id = i.entity_id and i.offender_id = :NEW.OffenderID)
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'REIMBURSEMENT BALANCE', nvl(:NEW.Rmbsmt_Bal,0),-25,vsucess);
	End;
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'LEGAL JUDGEMENT FLAG', nvl(:NEW.Legal_Flag,'N'),-26,vsucess);
	End;
	Begin
		mcmb_ep_set_generic_attribute(ltrim(:NEW.offender_id,'0'), ventity_id,
		                              'LEGAL JUDGEMENT AMOUNT', nvl(:NEW.Legal_Amount,0),-27,vsucess);		
	End; 
	--Exception when vsuccess is null
	if vsucess is null then
		raise_application_error(-20001, 'MCMB_ep_set_generic_attribute failed.');
		return;
	end if;
	return;
End MCMB_MJRS_Import;
/

CREATE OR REPLACE
package MACOMB.mcmb_MJRS_interface
is	   

/*	System: 		Offendertrak / MJRS
	Purpose:		create file for export   to MJRS
	Author:			Kelly Heinz    Feb, 2009 */	
	
					
procedure process_request; /*(
		p_request_id			in			epic.eh_interface_request.request_id%type,
		p_new_status			in out 		epic.eh_interface_request.code_request_status%type
		); */
	

end mcmb_MJRS_interface;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AlphaBooking
		(	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.
	Crystal: 		.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility: primary/alias names,
					charges, and other formatting changes used for court slip/booking processing

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/05		Created 
					R. Stuve	06/13/05		Compiled on OTMAIN
					
*/

 BEGIN
 
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Booking)' as RptTitle,
				'' as InmateNum,
				'' as NameFlag,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Bin,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
				'' as Charge

		FROM	dual

		UNION ALL

		--the below query pulls back the actual report data
(
SELECT		2 as Flag,
			'Alpha List (Booking)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			'' as NameFlag,
			epi.name_family || ', ' || epi.name_first || ' ' || epi.name_other as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--ef_epic_date_to_date(epi.date_of_birth)as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
    		MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type != 'MAS'

UNION

	SELECT 	2 as Flag,
			'Alpha List (Booking)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_AliasFlag(ab.entity_id) as NameFlag,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--ef_epic_date_to_date(epi.date_of_birth) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
    		MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type = 'MAS'
)

ORDER BY Flag, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AlphaPri
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ01 (Primary)
	Crystal: 		alphapri.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility. Lists the primary name only

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	  10/14/04		Created 
					R. Stuve	  12/10/04		Added header information via union query
					DLK			  12/13/04		Added Report to tree - test	ss 
					R. Stuve	  01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	  04/28/05		Added temporary_location_flag in where clause to prevent
	                							duplicate inmate entries when housed temporarily  
					R. Stuve	  06/11/05		Used ef_offender_cell function instead of linking through
												eh_housing_assignments
					R. Stuve	  06/11/05		Recompiled on OTMAIN 
					D. KUYKENDALL 01/06/06		Added mcmb_fnt_attrib_name to return the 'LEGAL JUDGEMENT 
					                            FLAG' and if true add Y to the returning data set 
					                            For Lori's use (Trust Accounting)
	
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				--'' as InmateType,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
		        '' AS LegalJgmtFlag
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
				MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
				--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"
                --mcmb_fnt_attrib_name(ep.entity_id) as flag2, --for test of attrib_name function
                decode(MACOMB.mcmb_fnt_legal_jdgmt_flg(ep.entity_id),'LEGAL JUDGEMENT FLAG', 'L', Null) as LegalJgmtFlag
                
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep



		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY FLAG, InmateName;

	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AlphaPriAli
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ02 (Primary and Alias)
	Crystal: 		alphapriali.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility. Lists the primary and alias names

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created 
					R. Stuve	12/10/04		Added header information via union query 
					DLK			12/15/04		Added to report tree test	
					R. Stuve	12/16/04		Added Alias field--same line
					R. Stuve	12/20/04		Broke out alias: each record has sep. line
					DLK			12/27/04		Added report total line removed 'active' from hdr
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
	                R. Stuve	04/28/05		Added temporary_location_flag in where clause to prevent
	                							duplicate inmate entries when housed temporarily
	                R. Stuve	06/11/05		Pulled Alias name directly instead of using function (mcmb_fnt_alias_sepline) 
	                R. Stuve	06/11/05		Compiled on OTMAIN
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary and Alias Names)' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts

		FROM	dual

		UNION ALL

		--the below query pulls back the actual report data
(
SELECT		2 as Flag,
			'Alpha List (Primary and Alias Names)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			epi.name_family || ', ' || epi.name_first || ' ' || epi.name_other as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(epi.date_of_birth)as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    		--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type != 'MAS'

UNION

	SELECT 	2 as Flag,
			'Alpha List (Primary and Alias Names)' as RptTitle,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(epi.identity_id, ep.primary_identity_id, 'P', 'A') as ImateType,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    		--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep

	WHERE 	ep.entity_id = ab.entity_id
			and epi.entity_id = ab.entity_id
			and epi.code_name_type = 'MAS'
)

ORDER BY Flag, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AlphaPri_CRE
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRE Alpha List Primary Name (Email only - special version of mcmb_rpt_AlphaPri - no funds column - w/ dob
                     							 also Security w/ primary charge)
	Crystal: 		alphapri_CRE_EML.rpt
	Purpose:		Email Daily to Sgt Roberts and Chris.wallace@dhs.gov (pdf) Immigration and Customs Enforcement 
	                per Sgt Roberts, Lt Moore/ Jail Admin
	                Current Inmates -  Basic information
	                
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M Zak          5-8-06       Created mcmb_rpt_AlphaPri_CRE based on  mcmb_rpt_AlphaPri
					M ZAk          5-12-06      Removed Security, added Primary Charge, removed Legal Judgement too
*/
    
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as PrimaryCharge,
				--'' as SecurityClass,
				--0 as Funds,
				'' as ActiveAlerts
		        --'' AS LegalJgmtFlag
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
				MACOMB.mcmb_fnt_primarycharge(ab.booking_id),
				--EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
				--MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
                --decode(MACOMB.mcmb_fnt_legal_jdgmt_flg(ep.entity_id),'LEGAL JUDGEMENT FLAG', 'L', Null) as LegalJgmtFlag
                
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep



		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY FLAG, InmateName;

	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AlphaPri_VETS
	 (	curRest			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ06 (Primary)
	Crystal: 		Active_Alpha_Vets.rpt
	Purpose:		Lists basic information regarding inmates housed in the facility. Lists the primary name only

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					MAB           8/28/12       Created new PROCEDURE mcmb_rpt_AplhaPri_VETS as a VETS only version of alpha rpt
	
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				--'' as InmateType,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
		        '' AS LegalJgmtFlag
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Alpha List (Primary Names Only)' as RptTitle,
				EPIC.ef_offender_id(ep.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				EPIC.ef_epic_date_to_date(epi.date_of_birth) as DOB,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
				MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
				--mcmb_fnt_alphacharge(bk.booking_id) as "Charge"
                --mcmb_fnt_attrib_name(ep.entity_id) as flag2, --for test of attrib_name function
                decode(MACOMB.mcmb_fnt_legal_jdgmt_flg(ep.entity_id),'LEGAL JUDGEMENT FLAG', 'L', Null) as LegalJgmtFlag
                
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_person_identity epi,
				EPIC.eh_entity_person ep



		WHERE 	ep.entity_id = ab.entity_id  
		        and mcmb_fnt_activealerts_trunc (ab.entity_id) like '%VET%'
		        and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY FLAG, InmateName;

	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AntReimRel
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,
		p_EndDate		in			EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX40
	Crystal: 		ReimbAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/15/05		Created 
	                M.Zak       07/18/05        Linked to otmain 
	                M.Zak       10/4/05         Modified added release = null (eh_release)  
	                M.Zak       8-3-06          Added overlap column (True/False) mf_sent_overlap function 
	                M.Zak       11/30/07(online) Added columns for Corporate Counsel  (see chgs 10-29-07)   
	                M Zak       11-10-08        Changed SentDays and Overlap to use charge date vs. sentence start date for calculated days per CaptBaker/Glenn/Lt Moore
	                M Zak       11-10-08        Added ChargeStart to display column on report 
	*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,    -- reimb calculated days
				'' as Overlap,
				'' as CourtName,	--10/29/07			
				'' as CaseNum,	    --10/29/07			
				0 as SentYears,     --10/29/07new
				0 as SentMths,      --10/29/07
				0 as SentDys,       --10/29/07  -- sentence days from eh_sentence_duration 
				0 as PSentYears,    --10/29/07
				0 as PSentMonths,   --10/29/07
				0 as PSentDays,     --10/29/07 
				'' as bookingid,    -- 10/29/07 used for subreport  mcmb_rpt_AntReimRel_ovlp
				'' as chargeid,     -- 10/29/07 used for subreport  mcmb_rpt_AntReimRel_ovlp
				'' as ChargeStatuteNo,   -- 10/29/07
				'' as ChargeStatuteDesc, -- 10/29/07
    			'' as AppearanceDt, 	     --10/29/07
    		    v_date_null as ChargeStart        --11-10-08
    						
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| MACOMB.mcmb_fnt_address_city(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_state(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				--round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,   
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))) as SentDays,   -- 11-10-08 now uses charge date not sentence start date
				--MACOMB.mf_sent_overlap_mz(b.booking_id,c.charge_id, s.sentence_start_date,s.sentence_end_date) as Overlap, 
				MACOMB.mf_sent_overlap_mz(b.booking_id,c.charge_id, (MACOMB.mcmb_fnt_charge_start_date(c.charge_id)),s.sentence_end_date) as Overlap,   --now using charge start date
				--EPIC.el.sub_4 as CourtName,   -- this is the court selected by Jail Office  
				MACOMB.mcmb_fnt_CourtName(c.charge_id) as CourtName,
        		MACOMB.mcmb_fnt_CaseNumber (c.charge_id) as CaseNum,
        		sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDys,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
				b.booking_id as bookingid,        -- for overlap subreport
				c.charge_id as chargeid,          -- for overlap subreport
			    MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeStatuteNo,
		     	MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeStatuteDesc,
                decode(to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id))), '12/25/2025 00:00:00', 'TBN', '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as AppearanceDt,
                EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as ChargeStart     --11-10-08
 

			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s,
                EPIC.eh_release r,
               	EPIC.eh_sentence_duration sd,        -- 10/29/07
				EPIC.eh_sentence_out_dates so,       -- 10/29/07
	            EPIC.epic_lookups el                 -- 10/29/07
            
		WHERE	b.booking_id = c.booking_id
		        and b.booking_id = r.booking_id (+)
				and c.sentence_id = s.sentence_id
				and s.sentence_id = so.sentence_id (+)        
				and s.duration_id = sd.sentence_duration_id (+)  
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date   -- inmates not release except for weekenders (sent end date = release date)
                --and (MACOMB.mf_date_between(s.sentence_end_date,v_min_date,v_max_date))= 'TRUE'
                and r.actual_release is null 
                and (EPIC.el.lookup_class = 'JUDGE NAME'
			    and EPIC.el.lookup_code = macomb.mcmb_fnt_JudgeName_chargeid(c.charge_id))

  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AntReimRel_ovlp
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_BookingId		in			EPIC.eh_booking.booking_id%type,
		p_ChargeId      in          EPIC.eh_charge.charge_ID%type)

	 	
IS

/*	Form Usage: 	
	Crystal: 		Sub report used in ReimbAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement.  If the ReimbAntRelease.rpt overlap indicate is true then
					this subreport will be called and display charges sentenced per booking.
					

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
	                M.Zak       11/30/07(online) Added columns for Corporate Counsel  (see chgs 10-29-07) 
	                M Zak       11-10-08        Changed SentDays and Overlap to use charge date vs. sentence start date for calculated days per CaptBaker/Glenn/Lt Moore
	                M Zak       11-10-08        Added ChargeStart to display column on report 
	*/
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays, -- reimb calculated days
				'' as Overlap,   
				'' as CourtName,				
				'' as CaseNum,				
				0 as SentYears,
				0 as SentMths,
				0 as SentDys,  -- sentence days from eh_sentence_duration 
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				'' as ChargeStatuteNo, 
				'' as ChargeStatuteDesc, 
    			'' as AppearanceDt, 	     --10/29/07
    		    v_date_null as ChargeStart        --11-10-08

								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				--round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))) as SentDays,   -- 11-10-08 now uses charge date not sentence start date
				--MACOMB.mf_sent_overlap_mz(b.booking_id,c.charge_id, s.sentence_start_date,s.sentence_end_date) as Overlap, 
				MACOMB.mf_sent_overlap_mz(b.booking_id,c.charge_id, (MACOMB.mcmb_fnt_charge_start_date(c.charge_id)),s.sentence_end_date) as Overlap,   --now using charge start date
			 	MACOMB.mcmb_fnt_CourtName(c.charge_id) as CourtName,
				--EPIC.el.sub_4 as CourtName,   -- this is the court selected by Jail Office
        		MACOMB.mcmb_fnt_CaseNumber (C.charge_id) as CaseNum,
        		sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDys,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMonths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
			    MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeStatuteNo,
		     	MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeStatuteDesc,
                decode(to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id))), '12/25/2025 00:00:00', 'TBN', '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as AppearanceDt,
                EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as ChargeStart     --11-10-08
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s,
                EPIC.eh_release r,
               	EPIC.eh_sentence_duration sd,        
				EPIC.eh_sentence_out_dates so,      
	            EPIC.epic_lookups el                 
            
		WHERE	b.booking_id = p_BookingId	  -- per booking- overlap charge exist so bring back all sentenced charges. 
		        and b.booking_id = c.booking_id   
		        and c.charge_id <> p_ChargeId
				and b.booking_id = r.booking_id (+)
				and c.sentence_id = s.sentence_id
				and s.sentence_id = so.sentence_id (+)         
				and s.duration_id = sd.sentence_duration_id (+)
                and r.actual_release is null 
                and (EPIC.el.lookup_class = 'JUDGE NAME'
			    and EPIC.el.lookup_code = macomb.mcmb_fnt_JudgeName_chargeid(c.charge_id))

  		ORDER BY Flag, SentenceEnd;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AntWkEdReimRl_CRE_EML
 	(	vCur 			out		    EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	Crystal Enterprise
	Crystal: 		ReimbWkEndAntRelease_CRE_EML.rpt
	Purpose:		Used by the Reimbursement Office to list Week Ender inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement  (report is ran for the previous saturday to pickup weekender
					bookings )

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
				    M.Zak       10/3/05          Created
				    M.ZAk       5-17-06          Modified to run on CRE - predefined prev Fiday to cur Monday for Date Range
				    							 --  Emailed to Lori every Monday 
				    M Zak       6-2-06           Added  MACOMB.mf_date_between function to where clause also fixed SENTENCE to SENTENCED
				    M.Zak       11/30/07(online) Added columns for Corporate Counsel  (see chgs 10-29-07)
				    
*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_min_date(EPIC.epicdate(sysdate - 3)); --Friday (min time) 
		v_max_date	:= EPIC.ef_max_date(EPIC.epicdate(sysdate)); -- Monday (max time )
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 3)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate)), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
                v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,
				'' as WeekEnderDesc,
				'' as CourtName,	--11/29/07			
				'' as CaseNum,	    --11/29/07			
				0 as SentYears,     --11/29/07new
				0 as SentMths,      --11/29/07
				0 as SentDys,       --11/29/07  -- sentence days from eh_sentence_duration 
				0 as PSentYears,    --11/29/07
				0 as PSentMonths,   --11/29/07
				0 as PSentDays,     --11/29/07 
				'' as ChargeStatuteNo,   -- 11/29/07
				'' as ChargeStatuteDesc, -- 11/29/07
    			'' as AppearanceDt 	     --11/29/07
								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| MACOMB.mcmb_fnt_address_city(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_state(b.entity_id) ||', '||MACOMB.mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				c.arrest_number as WeekEnderDesc,  -- Incident/Warrant # on Booking Mgt Dialog
				MACOMB.mcmb_fnt_CourtName(c.charge_id) as CourtName,                            -- 11-29-07 added fields added below upto AppearanceDt
        		MACOMB.mcmb_fnt_CaseNumber (c.charge_id) as CaseNum,
        		sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDys,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
			    MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeStatuteNo,
		     	MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeStatuteDesc,
                decode(to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id))), '12/25/2025 00:00:00', 'TBN', '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as AppearanceDt
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,        -- 11/29/07
				EPIC.eh_sentence_out_dates so,       -- 11/29/07
	            EPIC.epic_lookups el                 -- 11/29/07
            
		WHERE	b.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id  
				and s.sentence_id = so.sentence_id (+)          -- 11-29-07
				and s.duration_id = sd.sentence_duration_id (+)   --11-29-07
				--and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date
				--and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date   --  weekenders (sent end date = release date)
				and (MACOMB.mf_date_between(s.sentence_end_date, v_min_date,v_max_date))= 'TRUE'
                and (MACOMB.mcmb_fnt_custody_status_code(b.booking_id) in ('4','7') or MACOMB.mcmb_fnt_inmatestatus(c.charge_id)= 'SENTENCED WEEKENDER')
                and (EPIC.el.lookup_class = 'JUDGE NAME'
				    and EPIC.el.lookup_code = macomb.mcmb_fnt_JudgeName_chargeid(c.charge_id)) 
   
  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
--MAZ
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AntWkEndReimRel
 	(	vCur 			out		    EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_booking.start_date%type,
		p_EndDate		in			EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX41
	Crystal: 		ReimbWkEndAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list Week Ender inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement  (report is ran for the previous saturday to pickup weekender
					bookings )

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
				    M.Zak       10/3/05          Created 
				    M.Zak       11/30/07(online) Added columns for Corporate Counsel  (see chgs 10-29-07)
				    
*/
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays,
				'' as WeekEnderDesc,
				'' as CourtName,	--10/29/07			
				'' as CaseNum,	    --10/29/07			
				0 as SentYears,     --10/29/07new
				0 as SentMths,      --10/29/07
				0 as SentDys,       --10/29/07  -- sentence days from eh_sentence_duration 
				0 as PSentYears,    --10/29/07
				0 as PSentMonths,   --10/29/07
				0 as PSentDays,     --10/29/07 
				'' as ChargeStatuteNo,   -- 10/29/07
				'' as ChargeStatuteDesc, -- 10/29/07
    			'' as AppearanceDt 	     --10/29/07
 				--'' as bookingid,    -- 10/29/07 used for subreport  mcmb_rpt_AntReimRel_ovlp
				--'' as chargeid,     -- 10/29/07 used for subreport  mcmb_rpt_AntReimRel_ovlp								
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Weekender Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_address_numstr(b.entity_id) ||', '|| mcmb_fnt_address_city(b.entity_id) ||', '||mcmb_fnt_address_state(b.entity_id) ||', '||mcmb_fnt_address_postal(b.entity_id) as Address,
				MACOMB.mcmb_fnt_socsec(b.entity_id) as SSN,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(EPIC.ef_epic_date_to_date(s.sentence_end_date) - EPIC.ef_epic_date_to_date(s.sentence_start_date)) as SentDays,
				c.arrest_number as WeekEnderDesc,  -- Incident/Warrant # on Booking Mgt Dialog 
				MACOMB.mcmb_fnt_CourtName(c.charge_id) as CourtName,                            -- 10-29-07 added fields added below upto AppearanceDt
        		MACOMB.mcmb_fnt_CaseNumber (c.charge_id) as CaseNum,
        		sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDys,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
				--b.booking_id as bookingid,        -- for overlap in ReimbAntRelease.rpt subreport
				--c.charge_id as chargeid,          -- for overlap in ReimbAntRelease.rptsubreport
			    MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeStatuteNo,
		     	MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeStatuteDesc,
                decode(to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id))), '12/25/2025 00:00:00', 'TBN', '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as AppearanceDt
			
		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_sentence s,
			   	EPIC.eh_sentence_duration sd,        -- 10/29/07
				EPIC.eh_sentence_out_dates so,       -- 10/29/07
	            EPIC.epic_lookups el                 -- 10/29/07
            
		WHERE	b.booking_id = c.booking_id
		     
				and c.sentence_id = s.sentence_id 
				and s.sentence_id = so.sentence_id (+)          -- 10-29-07
				and s.duration_id = sd.sentence_duration_id (+)   --10-29-07
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) <= v_max_date   --  weekenders (sent end date = release date)
				--and (MACOMB.mf_date_between(s.sentence_end_date, v_min_date,v_max_date))= 'TRUE'
                and (MACOMB.mcmb_fnt_custody_status_code(b.booking_id) in ('4','7') or MACOMB.mcmb_fnt_inmatestatus(c.charge_id)= 'SENTENCE WEEKENDER')
                and (EPIC.el.lookup_class = 'JUDGE NAME'
				    and EPIC.el.lookup_code = macomb.mcmb_fnt_JudgeName_chargeid(c.charge_id)) 

  		ORDER BY Flag, InmateName, SentenceEnd;

END;  
--MAZ
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_AwaitingPickup
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ55
	Crystal: 		awaitingpickup.rpt
	Purpose:		Used by the Jail Office to track which inmates are ready to be picked
					up by another department when his/her served time at MCJ is complete

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/28/04		Created 
					DLK			010705			ADDED TO THE TREE TEST 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/18/05		Changed HoldAgy function to PickupAgy function to
												pull correct pickup department 
					R. Stuve	04/28/05		Added decode to truncase hospital name in cell column
					R. Stuve	05/24/05		Compiled on OTMAIN
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Awaiting Pickup by Another Department)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0 as Funds,
				'' as HoldAgy,
				'' as Charge
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Awaiting Pickup by Another Department)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			decode(EPIC.ef_offender_cell(ab.entity_id),
					'MC GENERAL', 'MCGH',
					'ST JOSEPHS WEST', 'SJWH',
					'STJOHNS SOUTH MACOMB', 'SJSM',
					'BI COUNTY', 'BICO',
					'ROYAL OAK BEAUMONT', 'ROBH',
					'TROY BEAUMONT', 'TRBH',
					'DETROIT RECEIVING', 'DRHO',
					'OTHER MEDICAL HOSPITAL', 'HOSX',
					'PSYCHIATRIC HOSPITAL', 'PSYC', EPIC.ef_offender_cell(ab.entity_id)) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_PickupAgy(c.charge_id) as Agy,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge
	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs
	
	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'AWAITING PICK UP BY ANOTHER DEPARTMENT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Bonds7Days
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_booking.start_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY03
	Crystal: 		bonds7days.rpt
	Purpose:		Used by Community Corrections to determine good candidates for petition 
					to judge(s) for early release/lowering bonds to avoid jail overcrowding
					and housing expenditures 

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/29/04		Created
					dlk			01/07/05		ADDED TO TREE TO TEST
					DLK			01/07/05		added the v_date TO SELECT 2 HEADER LINES to get the date to repeat on each page
					R. Stuve	01/31/05	    Changed 'Union' to 'Union All' and added active_booking link 
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/09/05		Changed Judge Name function to run off charge id (not booking id) 
					R. Stuve	06/22/05		Changed bonds to return from 1 to 1000 (to avoid returning $0 bonds)
					R. Stuve	06/23/05		Added statement in where clause to not return sentenced charges w/o fines 
					R. Stuve	07/05/05		Changed fees to return from 1 to 1000
*/

v_date_null 	date;
v_min_date		EPIC.eh_booking.start_date%type;
v_date_from		EPIC.eh_booking.start_date%type;
			
BEGIN  
	
v_date_null := null;
v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Over 7 Days Report' as RptTitle, 
				v_date_from as RptStart,
				'' as Judge,
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				0 as Bond,
				0 as Fine,
				v_date_null as BookingDate,
				'' as DocketNum,
				v_date_null as CourtDate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Over 7 Days Report' as RptTitle,
			v_date_from as RptStart,
		 	MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,
			EPIC.ef_offender_id(bk.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as Charge,
			to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id))as Bond,
			0 as Fine,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as DocketNum,
			EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(ch.charge_id)) as CourtDate

	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s
	
	WHERE 	ab.booking_id = bk.booking_id
			and ab.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and to_number(MACOMB.mcmb_fnt_bailamount(ch.charge_id)) between 1 and 1000
			and ch.charge_state != '6'
			and ch.charge_state != '4'
			and EPIC.ef_epic_date_to_date(bk.start_date) <= v_min_date

UNION ALL

	SELECT	2 as Flag,
		 	'Over 7 Days Report' as RptTitle,
			v_date_from as RptStart,
       		MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,
			EPIC.ef_offender_id(bk.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(ch.statute_id) as Charge,
			0 as Bond,
			to_number(MACOMB.mcmb_fnt_fineamount(s.sentence_id)) as Fine,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as DocketNum,
			EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(ch.charge_id)) as CourtDate
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s
	
	WHERE 	ab.booking_id = bk.booking_id
			and ab.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and ch.charge_state = '4'
			and to_number(MACOMB.mcmb_fnt_fineamount(s.sentence_id)) between 1 and 1000
			and EPIC.ef_epic_date_to_date(bk.start_date) <= v_min_date

	ORDER BY Flag, Judge, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CaseStatus
(vCaseStatus in            epic.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out    epic.epp_generic_ref_cursor.ref_cursor)
IS
/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		CASE STATUS REPORTS COMBINED
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter
			 		Mzak        7-27-05           Addes fields to try and combine SenttoPrison(new) with Pre Arnm Cir Ct
			 		Mzak        12-21-05          Added fields needed for other Case Status reports
			 		Mzak        1-3-06            Testing query against 8 existing reports
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

  
   	 v_date_null date;
   	 sql_stmt varchar(4000);

BEGIN  

	v_date_null := null; 
	  sql_stmt := '	SELECT	2 as Flag,
	        ''Case Status (Pre Arraignment Circuit Court)'' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,  
			epic.ef_offender_cell(ab.entity_id) as Cell,
			decode(epic.ef_offender_cell(ab.entity_id),
					'' MC GENERAL'',''MCGH'',
					''ST JOSEPHS WEST'', ''SJWH'',
					''STJOHNS SOUTH MACOMB'', ''SJSM'',
					''BI COUNTY'', ''BICO'',
					''ROYAL OAK BEAUMONT'', ''ROBH'',
					''TROY BEAUMONT'', ''TRBH'',
					''DETROIT RECEIVING'', ''DRHO'',
					''OTHER MEDICAL HOSPITAL'', ''HOSX'',
					'' PSYCHIATRIC HOSPITAL'',''PSYC'', epic.ef_offender_cell(ab.entity_id)) as AWPupCell,
			mcmb_fnt_chargedesc(c.statute_id) as Charge,
			mcmb_fnt_CaseNumber(c.charge_id) as DocketNum,
			--cs.case_number as DocketNum,   -- replaced 1-3-06
			--decode(ca.judge_name,null,'' NO JUDGE ENTERED'',ca.judge_name) as Judge,  -- replaced 1-3-06
			decode(mcmb_fnt_JudgeName_ChargeID(c.charge_id),null,'' NO JUDGE ENTERED'',mcmb_fnt_JudgeName_ChargeID(c.charge_id)) as Judge,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
  			mcmb_fnt_inmatefunds(ab.entity_id) as Funds,   		--MZ Pre Ar Dist Ct  
  			decode(trim(mcmb_fnt_inmatestatus(c.charge_id)),''PRE-ARRAIGNMENT DISTRICT'',mcmb_fnt_ControlAgy(c.charge_id),null) as ControlAgy, 
			--mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,     	--MZ Pre Ar Dist Ct   -- Fed Pris(old) - now US Border,ICE,Marshall
			to_number(mcmb_fnt_BailAmount(c.charge_id)) as Bond,   --MZ Pre Ar Dist Ct
			decode(trim(mcmb_fnt_inmatestatus(c.charge_id)),''PRE-ARRAIGNMENT DISTRICT'',mcmb_fnt_Holds(ab.entity_id),null) as Holds, 
			--mcmb_fnt_Holds(ab.entity_id) as Holds,                 --MZ Pre Ar Dist Ct
			c.arrest_number as WarrantNum,                        --MZ Pre Ar Dist Ct
			mcmb_fnt_arresttype(c.charge_id) as ArrestReason,	  --MZ Pre Ar Dist Ct
			decode(trim(mcmb_fnt_inmatestatus(c.charge_id)),''AWAITING PICK UP BY ANOTHER DEPARTMENT'',trim(mcmb_fnt_PickupAgy(c.charge_id)),null) as PupAgency, 
			--trim(mcmb_fnt_PickupAgy(c.charge_id)) as PupAgency,   --MZ Await p/up by another Dept  -- sub rpt to existing
		    epic.ef_epic_date_to_date(b.start_date) as BookingDate,     -- Fed Pris(old) - now US Border,ICE,Marshall
			to_char(substr(b.start_date,12,5)) as BookingTime,     -- Fed Pris(old) - now US Border,ICE,Marshall
            mcmb_fnt_DOB(b.entity_id) as DOB,                        -- Fed Pris(old) - now US Border,ICE,Marshall
            mcmb_fnt_mdoc(ab.entity_id) as MDOC,                     --Parole Violators
            mcmb_fnt_AlienNum(b.entity_id) as FederalID,              --Fed Pris(old) - now US Border,ICE,Marshall
            mcmb_fnt_wrlstime(ab.entity_id) as WRTime,                --Weekenders 12-28-05
			epic.ef_epic_date_to_date(b.sentence_end_date) as RlsDate,      --Weekenders 12-28-05
			mcmb_fnt_ControlAgy(c.charge_id)as USControlAgy         -- added 1-03-06 needed for US reports Agency (not sorted by ControlAgy)
            
	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			--epic.eh_case_charge a,        -- removed 1-3-06
			--epic.eh_court_appearance ca,  --removed 1-3-06
			--epic.eh_case cs,              --removed 1-3-06
			epic.eh_booking b,
			epic.eh_entity_status e  -- ADDED LINE 12-28-05

	WHERE	b.booking_id = ab.booking_id
	        and ab.booking_id = c.booking_id
			--and c.charge_id = a.charge_id
			--and a.case_id = ca.owner_id (+)
			--and cs.case_id (+) = a.case_id 
		    --and ((mcmb_fnt_inmatestatus(c.charge_id) = ''SENTENCED WEEKENDER'' or e.code_custody_status = ''4''))
		    and (mcmb_fnt_inmatestatus(c.charge_id) = :1 or (mcmb_fnt_inmatestatus(c.charge_id) = ''SENTENCED WEEKENDER'' or e.code_custody_status = ''4'')) 
			and c.charge_state != 6
			and b.entity_id = e.entity_id (+) ';    -- ADDED LINE 12-28-05 
			
 
If vCaseStatus =  'PRE-ARRAIGNMENT DISTRICT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, ControlAgy, Judge, Holds, InmateName ';
elsif vCaseStatus =  'POST-ARRAIGNMENT DISTRICT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, Judge, InmateName '; 	
elsif vCaseStatus =  'AWAITING PICK UP BY ANOTHER DEPARTMENT' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, PupAgency, InmateName ';
elsif vCaseStatus =  'SENTENCED WEEKENDER' then sql_stmt :=  sql_stmt || 'ORDER BY Flag, RlsDate, WRTime, InmateName ';  -- ADDED LINE 12-28-05 
else sql_stmt :=  sql_stmt || 'ORDER BY Flag,InmateName ';
end if;
	
			

 OPEN vCur FOR sql_stmt using vCaseStatus;	
 EXECUTE IMMEDIATE sql_stmt using vCaseStatus; 
  
 END; 
 
 
  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CaseStatus_sort
	(vCaseStatus in            epic.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.
	Crystal: 		****.rpt
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter
			 		Mzak        7-27-05           Addes fields to try and combine SenttoPrison(new) with Pre Arnm Cir Ct
			 		Mzak        12-21-05          Added fields needed for other Case Status reports
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
v_exec_tx VARCHAR2(2000); 


   	 v_date_null date;
BEGIN 
	v_date_null := null;

 v_exec_tx := 'SELECT	2 as Flag,
			char(39)Case Status (Pre Arraignment Circuit Court)cahr(39) as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,  
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
		    mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
  			mcmb_fnt_inmatefunds(ab.entity_id) as Funds,   		--MZ Pre Ar Dist Ct
			mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,     	--MZ Pre Ar Dist Ct   -- Fed Pris(old) - now US Border,ICE,Marshall
			to_number(mcmb_fnt_BailAmount(c.charge_id)) as Bond,   --MZ Pre Ar Dist Ct
			mcmb_fnt_Holds(ab.entity_id) as Holds,                 --MZ Pre Ar Dist Ct
			c.arrest_number as WarrantNum,                        --MZ Pre Ar Dist Ct
			mcmb_fnt_arresttype(c.charge_id) as ArrestReason,	  --MZ Pre Ar Dist Ct
			--mcmb_fnt_PickupAgy(c.charge_id) as PupAgency          --MZ Await p/up by another Dept  -- sub rpt to existing
		    epic.ef_epic_date_to_date(b.start_date) as BookingDate,     -- Fed Pris(old) - now US Border,ICE,Marshall
			to_char(substr(b.start_date,12,5)) as BookingTime,     -- Fed Pris(old) - now US Border,ICE,Marshall
            mcmb_fnt_DOB(b.entity_id) as DOB,                        -- Fed Pris(old) - now US Border,ICE,Marshall
            mcmb_fnt_mdoc(ab.entity_id) as MDOC                     --Parole Violators
            
	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs,
			epic.eh_booking b

	WHERE	b.booking_id = ab.booking_id
	        and ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = vCaseStatus 
			and c.charge_state != 6   ';    -- removed ;  
			
	--char(39)PRE-ARRAIGNMENT CIRCUIT COURTchar(39)		
			
--  v_exec_tx := 'begin p_auto_'||ci.doc_state_id||'('||cdi.doc_id||'); end;';
			

     --ORDER BY Flag, InmateName; --v_sort_order;

  
  begin
    if vCaseStatus =  'PRE-ARRAIGNMENT DISTRICT' then
      v_exec_tx :=  v_exec_tx || 'ORDER BY Flag, ControlAgy, Judge, InmateName; ';
	else
	v_exec_tx :=  v_exec_tx || 'ORDER BY Flag, InmateName; ';
 	end if;
 	 EXECUTE IMMEDIATE (v_exec_tx);
end;
  
  
  


  
 END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CCBooking
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor)  
	 	
IS

/*	Form Usage: 	CRSTL.XX20
	Crystal: 		CirCrtBooking.rpt
	Purpose:		Used by the Circuit Court Administrator to list all inmates physically at MCJ
					with unsentenced charges pending in the Circuit Court. Run monthly to submit to 
					the State of Michigan for Speedy Trial report

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/14/05		Created 
	                M. Zak      07/18/05        Linked to otmain 
*/
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Circuit Court Booking' as RptTitle,
				'' as InmateName,
				'' as CaseNumber,
				'' as JudgeName,
				v_date_null as BookingDate
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Circuit Court Booking' as RptTitle,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNumber,
				EPIC.ef_lookup_text('JUDGE NAME',MACOMB.mcmb_fnt_JudgeName_chargeid(c.charge_id),'UC') as JudgeName,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate

		FROM	EPIC.eh_booking b,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge c,
				EPIC.eh_muster m
		
		WHERE	ab.booking_id = b.booking_id
				and b.booking_id = c.booking_id
				and b.entity_id = m.entity_id
				and m.in_muster_flag = 'Y'
				and c.charge_state <> '4' --not sentenced
				and c.charge_state <> '6' --not disposed
				and (
			 			MACOMB.mcmb_fnt_CourtName(c.charge_id) = '16TH CIRCUIT COURT' or
			  			MACOMB.mcmb_fnt_CourtName(c.charge_id) = 'MACOMB COUNTY FRIEND OF THE COURT'
			  		)


ORDER BY Flag, JudgeName, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CCUtilization
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			epic.eh_charge.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX53
	Crystal: 		JailUtilCrctCt.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/04/05		Created  
					M. Zak      04/26/05        Crystal Report completed
					R. Stuve	05/03/05		Added FOC in where clause
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/15/05		Commented Charge field to increase query speed (this field is not needed)
												but inserted 'dummy' field to prevent Crystal re-work
                   	M.Zak       09-26-05        Modified   Added 31, 32, 33 'US - BORDER PATROL','US - MARSHALL SERVICE'
					                            'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                             Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)   							
					J. McBratnie 07/15/07       move to Macomb schema from Production
												
*/

        v_min_date		epic.eh_trans_distribution.trans_date%type;  
		v_date_from		epic.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(p_StartDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by Circuit Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by Circuit Court' as RptTitle,
			v_date_from as RptStart,
			epic.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,  
			'DUMMY' as Charge,
			epic.ef_lookup_text('JUDGE NAME', mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',  -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	epic.eh_booking b,
	        epic.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and c.offense_date <= v_min_date
	  		and (b.end_date is null
	  				or b.end_date > v_min_date)
	  		and (
	  			mcmb_fnt_CourtName(c.charge_id) = '16TH CIRCUIT COURT' or
	  			mcmb_fnt_CourtName(c.charge_id) = 'MACOMB COUNTY FRIEND OF THE COURT'
	  			)

ORDER BY Flag, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CellList
	(vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
/*	
Form Usage: 	CRSTL.ZZ14
Crystal: 		celllist.rpt
Purpose:		Lists basic demographics for all inmates housed in MCJ.  Sorted by floor/cell location.

Author:			Rachel Stuve

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	12/06/04		Created 
				R. Stuve	12/13/04		Added header information via union query
				DLK			12/13/04		Added to the report tree - test	
                R.Stuve		12/13/04		Changed ActiveAlert function from 'full' to 'trunc'
                R.Stuve		12/28/04		Changed DOB from string type to date type
                R.Stuve		01/19/05		Added Charge to query
                DLK			01/19/05		Added Report Title to 2nd Union so title would generate to all pages
                R. Stuve	01/31/05		Changed 'Union' to 'Union All'
                R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting 
                R. Stuve	05/24/05		Compiled on OTMAIN  
                R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function to remove table links to optomize performance
                R. Stuve	07/03/07		Verified EPIC/MACOMB. Moved to MACOMB only
                M. Zak      01/14/08        Correct Sort Order for High Obser Holding Cells - 
                                            Per Glenn - Administration would like these new cells to appear after MH17 and before MH18 since that is where these cells are physically located
*/

v_date_null DATE;
	
BEGIN

v_date_null := NULL;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Cell List' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Charge,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT  2 as Flag,
        	'Cell List' as RptTitle,
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName, 
			MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(CASE
        		WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'  
				WHEN substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-14-08 MZ (per Glenn incorrect sort order)
				ELSE substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				END) as Sort,
        	  	--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			TO_DATE(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    
    FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
	
	ORDER BY Flag, Floor, Sort, Cell;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_CellListTrustees
	(vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ15
	Crystal: 		CellListTrusteesOnly.rpt
	Purpose:		Lists basic demographics for all trustees housed in MCJ.  Sorted by floor/cell location.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/22/05		Created  
					DLK			05/01/05		Begin devl Crstl - for test upload to tree for staff test
					R. Stuve	05/13/05		Deleted Bin field & added Category field
					R. Stuve	05/24/05		Compiled on OTMAIN
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function to remove table links to optomize performance
					DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	04/06/06		Commented DOB as not used on report
					R. Stuve	12/27/06		Added custody status 65 (Pre-Kitchen Trustee) to WHERE clause (per SRF 11943)
					R. Stuve	07/02/07		Verified EPIC/MACOMB: moved only to MACOMB
                    M. Zak      01/15/08        Correct Sort Order for High Obser Holding Cells - 
                                                Per Glenn - Administration would like these new cells to appear after MH17 and before MH18 since that is where these cells are physically located

*/

v_date_null DATE;
	
BEGIN

v_date_null := NULL;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Cell List (Trustees Only)' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Charge,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				--v_date_null as DOB,
				'' as SecurityClass,
				0 as Funds,
				'' as ActiveAlerts,
				'' as Category
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT
        	2 as Flag,
        	'Cell List (Trustees Only)' as RptTitle,
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName, 
			MACOMB.mcmb_fnt_alphacharge(ab.booking_id) as Charge,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(CASE	
        		WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) LIKE 'MENT HLTH, HIGH%' THEN 'Z'
				WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) LIKE 'MENT HLTH, LOW%' THEN 'Y'  
				WHEN substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-15-08 MZ (per Glenn incorrect sort order)
				ELSE substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				END) as Sort,
    		--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			--MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin, --not needed on this report 05/13/05 RAS
			--TO_DATE(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts,
				--the below line displays the Trustee status (Kitchen, Garage, Special)
			DECODE(e.code_custody_status,'6','K',
										 '9','G',
										 '10','S',
										  '65','P') as Category 
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab,
			EPIC.eh_entity_status e
			
	WHERE 	ha.entity_id (+) = ab.entity_id
			AND e.entity_id = ab.entity_id
			AND e.code_custody_status in ('6','9','10','65')
		
	
	ORDER BY Flag, Floor, Sort, Cell;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Charge999
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor)  
	 	
IS

/*	Form Usage: 	CRSTL.ZZ56
	Crystal: 		charge999.rpt
	Purpose:		Used by the Jail Office to list which inmates have been booked with 
					a 'generic' charge (999.xxx)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/26/05		Created 
					dlk			01/26/05		devl begins
	                R. Stuve	01/31/05		Changed 'Union' to 'Union All'
	                dlk			02/02/05		added to tree for test
	                R. Stuve	05/28/05		Compiled on OTMAIN
	                DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA
*/
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'CHARGE(S) 999 CODE' as RptTitle,
				'' as InmateName,
				'' as InmateNum,
				v_date_null as BookingDate,
				'' as ChargeNum,
				'' as ChargeDesc
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'CHARGE(S) 999 CODE' as RptTitle,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
        		MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeDesc

		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.epic_statutes s

		WHERE	b.booking_id = c.booking_id
				and c.statute_id = s.statute_id
				and c.charge_state <> '6'
				and s.statute_number like '999%'

ORDER BY Flag, InmateName, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ChargedBookFees
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.trans_date%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.trans_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY55
	Crystal: 		chrgdbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were charged during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					dlk			01/28/05		report devl to test 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					dlk			02/02/05		added to tree for test (inp)
								02/07/05		finalized req Crystal on tree 
					R. Stuve	02/28/05		Added Reversal field to indicate transaction reversals
					R. Stuve	05/28/05		Compiled on OTMAIN
	                DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA NOTATIONS
	
*/
        v_min_date		EPIC.eh_trans_distribution.trans_date%type;  
		v_max_date		EPIC.eh_trans_distribution.trans_date%type;  
     	v_date_from		EPIC.eh_trans_distribution.trans_date%type;
 		v_date_to		EPIC.eh_trans_distribution.trans_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Charged Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency,
				'' as Reversal
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Charged Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				decode(tat.code_source_of_funds,'502','C','503','S') as Agency,
				tat.reverse_flag as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat


		WHERE	t.trust_account_id = tat.trust_account_id
				and (code_source_of_funds = '502'
					or code_source_of_funds = '503')
				and EPIC.ef_epic_date_to_date(tat.trans_date) >= v_min_date
				and EPIC.ef_epic_date_to_date(tat.trans_date) < v_max_date

ORDER BY Flag, Agency, InmateNum, TDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Class5P
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRSTL.XX07
	Crystal: 		class5p.rpt
	Purpose:		Used by Classification: An inmate appears on this report once he/she
					is sentenced on all charges and his/her classification is 'Medium Present'.
					This report is used to help determine inmate location moves

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/17/05		Created
					DLK			02/23/05		Added to report tree test
					R. Stuve	05/06/05		Modified where clause to discount disposed charges
					R. Stuve	05/28/05		Compiled on OTMAIN
					DLK         03/16/06        ADDED MACOMB AND EPIC SCHEMA INFO
					
*/
		v_date_null	date;									
			
BEGIN  
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Sentenced 5p on All Charges' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				v_date_null as ReleaseDate					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data														
	SELECT	distinct 2 as Flag,
			'Sentenced 5p on All Charges' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
	       	EPIC.ef_offender_cell(ab.entity_id) as Cell,
	       	EPIC.ef_epic_date_to_date(bk.final_release_date) as ReleaseDate 
	       		--date the inmate physically gets out of jail
	
	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_booking bk,
			EPIC.eh_charge c

	WHERE	ab.booking_id = bk.booking_id
			and ab.booking_id = c.booking_id
			and c.charge_state != '6'
			and EPIC.ef_get_Security_Class(ab.entity_id) = '04'
			and MACOMB.mcmb_fnt_SentAllChgs(ab.entity_id) = 'S'
			and MACOMB.mcmb_fnt_SenttoPrison(ab.booking_id) <> 'P'
				--exclude anyone who has been sentenced to prison

ORDER BY Flag, InmateName;

END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.****
	Crystal: 		*****.rpt
	Purpose:		THIS PROCEDURE IS NO LONGER USED.  THE PROCEDURES USED FOR THIS REPORT ARE
					MCMB_RPT_DAILYINCAR1 AND MCMB_RPT_DAILYINCAR2

	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production

				
*/
	
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type;
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= epic.ef_min_date(p_StartDate); 
		v_max_date	:= epic.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  := substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				v_date_null as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			epic.ef_offender_id(b.entity_id) as InmateID,
 			epic.ef_get_personororgname(b.entity_id) as InmateName,
 			mcmb_fnt_alias(b.entity_id) as Alias,
  			epic.ef_offender_cell(b.entity_id) as Cell,
    		epic.ef_epic_date_to_date(pi.date_of_birth) as DOB,
  			mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			epic.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(epic.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			ep.juvenile_flag as Juvenile,
  			mcmb_fnt_gendershort(b.entity_id) as Gender,
  			mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd,
  			decode(to_char(substr((epic.ef_epic_date_to_date(b.start_date)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

	FROM  	epic.eh_booking  b,
  			epic.eh_person_identity pi,
  			epic.eh_entity_person ep

	WHERE  	pi.entity_id = b.entity_id
			and pi.entity_id = ep.entity_id
  			AND DECODE(pi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and b.start_date >= v_min_date
			and b.start_date < v_max_date

			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar1
 (	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_main.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				'' as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,           
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		--EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(b.entity_id)) as DOB,  --MAZ 9-18-07 removed epic date to date
    		MACOMB.mcmb_fnt_DOB(b.entity_id) as DOB,     
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd
  			
	FROM  	EPIC.eh_booking  b

	WHERE  	EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar1_CRE_EML
 (	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 

	 	
IS

/*	           
	Form Usage:		Crystal Enterprise    
	Crystal:        DailyInc_Main_CRE_EML.RPT
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					MAZ	        5-17-06         Modified report to run previous day on CRE
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  
		
		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_null := null;  
				
		--set value for variables used in query		
		

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				'' as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,           
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		--EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(b.entity_id)) as DOB,  -- removed epic   
    		MACOMB.mcmb_fnt_DOB(b.entity_id) as DOB,
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,5)) as BookingTime,
			b.booking_number as BookingNum,
  			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd
  			
	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar1_Vet
 (	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_main.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION    
					MAB         03/02/12        Renamed to mcmb_rpt_DailyIncar1_Vet to extract Veterans
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Dly Incarceration for Vets' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				'' as Alias,
				'' as Cell,
				'' as DOB,
				'' as StatuteDesc,
				'' as StatuteNum,
				'' as Status,
				v_date_null as BookingDate,           
				'' as BookingTime,
				'' as BookingNum,
				'' as Juvenile,
				'' as Gender,
				'' as CntAgy,
				'' as FelMisd			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			'Daily Incarceration for Vets' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateID,
 			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
 			MACOMB.mcmb_fnt_alias(b.entity_id) as Alias,
  			EPIC.ef_offender_cell(b.entity_id) as Cell,
    		--EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_DOB(b.entity_id)) as DOB,  --MAZ 9-18-07 removed epic date to date
    		MACOMB.mcmb_fnt_DOB(b.entity_id) as DOB,     
  			MACOMB.mcmb_fnt_primarycharge(b.booking_id) as StatuteDesc,
  			MACOMB.mcmb_fnt_primarychargenumber(b.booking_id) as StatuteNum,
			MACOMB.mcmb_fnt_inmatestatusb(b.booking_id) as Status,
			EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
			substr(EPIC.ef_epic_date_to_date(b.start_date),12,5) as BookingTime,      --remove tochar?????
			b.booking_number as BookingNum,
  			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  			MACOMB.mcmb_fnt_CntAgy(b.booking_id) as CntAgy,
  			MACOMB.mcmb_fnt_FelMisdBk(b.booking_id) as FelMisd
  			
	FROM  	EPIC.eh_booking  b

	WHERE   mcmb_fnt_activealerts_trunc (b.entity_id) like '%VET%'  
          and  EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
          and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

	
			
ORDER BY Flag, BookingDate, BookingTime;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar2
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
	    p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_sub.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar2_CRE_EML
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 
	 	
IS

/*	           
	Form Usage:		Crystal Enterprise    
	Crystal:        DailyInc_sub_CRE_EML.RPT
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA
					MAZ	        5-17-06         Modified report to run previous day on CRE
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
      		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar2_vet
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
	    p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	           
	Form Usage: 	CRSTL.YY30
	Crystal: 		dailyincar_sub.rpt
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA 
					MZ          3/22/12         added vet to where clause
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   
	        mcmb_fnt_activealerts_trunc (b.entity_id) like '%VET%'  
	        and EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr(EPIC.ef_epic_date_to_date(b.start_date),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyIncar_SQLSched
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 
	 	
IS

/*	           
	Form Usage:		SQL Reporting    
	Crystal:        
	Purpose:		Returns number of male inmates booked during the midnight shift.  
					

	Author:			Kelly Heinz

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			mcmb_get_booking_shift(b.start_date) as Shift,
  			count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
      		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
      		and MACOMB.mcmb_fnt_gendershort(b.entity_id) = 'M'
      		and MACOMB.mcmb_fnt_JuvFlag(b.entity_id) = 'N'
      		and mcmb_get_booking_shift(b.start_date) = 'M'

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), mcmb_get_booking_shift(b.start_date);

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyRelease
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_charge.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY21
	Crystal: 		dailyrelease.rpt
	Purpose:		Used by the Jail Office to list which inmates have already been physically 
					released on the selected date (Actual Release Date = <input date>)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/18/05		Created 
					M. Zak		04/21/05		Linked Crystal Report to Tree
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/16/05		Added the Classified field   
					R. Stuve	06/24/05		Added Join to charge table to include releases with no associated charges 
					DLK         03/17/06        ADDED EPIC AND MACOMB SCHEMA NOTATION
	
*/
        v_min_date		EPIC.eh_charge.action_time%type;   
     	v_date_from		EPIC.eh_charge.action_time%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Daily Release(s)' as RptTitle,
				v_date_from as RptStart,
		        v_date_null as BookingDate,
				'' as BookingTime,
				'' as InmateNum,
				'' as Classified,
				'' as InmateName,
				'' as Cell,
				'' as Gender,
				v_date_null as ReleaseDate,
				'' as ReleaseTime,
				'' as ReleaseNotes,
				'' as ReleaseType,
				'' as StatuteNumber,
				'' as StatuteText
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Daily Release(s)' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				substr(EPIC.ef_epic_date_to_date(b.start_date),12,5) as BookingTime,
				EPIC.ef_offender_id(b.entity_id) as InmateNum,
				MACOMB.mcmb_fnt_ClassYN(b.booking_id) as Classified,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_offender_cell(b.entity_id) as Cell,
				MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
					--above line only for testing: doesn't need to be displayed
				substr(EPIC.ef_epic_date_to_date(r.actual_release),12,5) as ReleaseTime,
				MACOMB.mcmb_fnt_ReleaseNotes(r.booking_id) as ReleaseNotes,
					--from the Release Screen: text associated with the Release Notes button
		        MACOMB.mcmb_fnt_releasetype(b.booking_id) as ReleaseType,
       		 	MACOMB.mcmb_fnt_statutenumber(c.charge_id) as StatuteNumber,
        		MACOMB.mcmb_fnt_statutetext(c.charge_id) as StatuteText


		FROM	EPIC.eh_booking b,
				EPIC.eh_charge c,
				EPIC.eh_release r
		
		WHERE	c.booking_id (+) = b.booking_id
				and b.booking_id = r.booking_id
				and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(r.actual_release)) = v_min_date


ORDER BY Flag, ReleaseDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DailyRelease2
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type)
		
IS

/*	           
	Form Usage: 	CRSTL.YY21
	Crystal: 		dailyrelease_sub.rpt
	Purpose:		Used by the Jail Office to list which inmates have already been physically 
					released on the selected date (Actual Release Date = <input date>)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak 	    10-5-05		    Created
                    M.Zak       10-18-05        Corrected Summary - was pulling back counts per charges not bodies    
                    DLK         03/17/06        ADDED THE MACOMB AND EPIC SCHEMA NOTATION
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count
  
  		FROM	EPIC.eh_booking b,
				-- 10-18-05 MAZ removed eh_charge c,
				EPIC.eh_release r
		
		    	-- 10-18-05 MAZ removed c.booking_id (+) = b.booking_id
		WHERE   b.booking_id = r.booking_id
				and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(r.actual_release)) =  v_min_date
    
group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.MCMB_RPT_DAILY_SCHED_SUB 
(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor) 
	 	
IS

/*	5/23/2011 KJH - Currently converting to SQL Reporting, this is cloned from dailyincar2_cre_eml           
	Form Usage:		SQL Reporting    
	
	Purpose:		Returns inmates booked during the selected time period.  Also returns the
					number booked per each shift.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/21/05		Created, tested, and uploaded on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA
					MAZ	        5-17-06         Modified report to run previous day on CRE
 
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		--v_date_null		varchar2(24);
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate - 1))); --ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(sysdate - 1))); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(sysdate - 1)), EPIC.ef_date_format),1,100);
		--v_date_null := ' ';
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'' as Gender,
				'' as Juvenile,
				'' as Shift,
				0 as Count			
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  			decode (substr(to_char(EPIC.ef_epic_date_to_date(b.start_date), 'MM/DD/YYYY HH24:MI'),12,2),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift,
  				count(*) as Count

	FROM  	EPIC.eh_booking  b

	WHERE   EPIC.ef_epic_date_to_date(b.start_date) >= 	v_min_date
      		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date

group by MACOMB.mcmb_fnt_gendershort(b.entity_id), MACOMB.mcmb_fnt_JuvFlag(b.entity_id), decode (substr(to_char(EPIC.ef_epic_date_to_date(b.start_date), 'MM/DD/YYYY HH24:MI'),12,2),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A');
END MCMB_RPT_DAILY_SCHED_SUB;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DCUtilization
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			epic.eh_charge.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX54
	Crystal: 		JailUtilDistCt.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/04/05		Created  
					M. Zak      04/26/05        Crystal Report completed 
					R. Stuve	05/03/05		Added FOC in where clause 
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/15/05		Commented Charge field to increase query speed (this field is not needed)
												but inserted 'dummy' field to prevent Crystal re-work
                   	M.Zak       09-26-05        Modified   Added 31, 32, 33 'US - BORDER PATROL','US - MARSHALL SERVICE'
					                            'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                             Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)   							
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

        v_min_date		epic.eh_trans_distribution.trans_date%type;  
		v_date_from		epic.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(p_StartDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by District Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by District Court' as RptTitle,
			v_date_from as RptStart,
			epic.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,
			'DUMMY' as Charge,
			epic.ef_lookup_text('JUDGE NAME', mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',   -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	epic.eh_booking b,
	        epic.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and c.offense_date <= v_min_date
	  		and (b.end_date is null
	  				or b.end_date > v_min_date)
	  		and mcmb_fnt_CourtName(c.charge_id) not like '%CIRCUIT%'
  			and mcmb_fnt_CourtName(c.charge_id) != 'MI DEPT OF CORR'
  			and mcmb_fnt_CourtName(c.charge_id) != 'MACOMB COUNTY FRIEND OF THE COURT'

ORDER BY Flag, Court, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DCUtilization_CRE
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor)

IS


/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		JailUtilDistCt_CRE.rpt
	Purpose:		Used Community Corrections to determine the jail bed usage by judge.
					Based off of 'Driving Charge' which is the charge with the outdate farthest
					from the input date, followed by the largest bond, followed by the charge entered 
					into the system first

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-12-05        Created - Report ran through CRE (JailUtilCrctCt_CRE.rpt)
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/

        v_min_date		epic.eh_trans_distribution.trans_date%type;  
		v_date_from		epic.eh_trans_distribution.trans_date%type;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(epic.epicdate(sysdate)); --sysdate vs prompt date
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(epic.epicdate(sysdate)), epic.ef_date_format),1,100);

		
	OPEN vCur FOR
        --the below query pulls back the header information	
		SELECT	1 as Flag,
				'Jail Utilization by District Court' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as Charge,
				'' as Judge,
				'' as Court,
				'' as Status
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
	SELECT	2 as Flag,
			'Jail Utilization by District Court' as RptTitle,
			v_date_from as RptStart,
			epic.ef_offender_id(b.entity_id) as InmateNum,
			--mcmb_fnt_DrvChg(b.entity_id) as Charge,
			'DUMMY' as Charge,
			epic.ef_lookup_text('JUDGE NAME', mcmb_fnt_JudgeName_ChargeID(c.charge_id), 'UC') as Judge,
	 		mcmb_fnt_CourtName(c.charge_id) as Court,
			decode(mcmb_fnt_ChargeStatusCode(c.charge_id, v_min_date), '01','Pre',
									'02','Post',
									'03','Bound',
									'04','Pre',
									'05','Post',
									'06','AS',
									'07','S',
									'08','SP',
									'09','SP',
									'10','O',
									'11','O',
									'12','O',
									'13','O',
									'14','O',
									'15','O',
									'16','O',
									'17','O',   -- 9-26-05 is FEDERAL PRISONER  (this code is to be end dated and replaced by 31,32
									'18','O',
									'19','O',
									'20','O',
									'21','S',
									'22','O',
									'28','S',
									'29','O',
									'30','O',  -- 9-16-05 is IMMIGRATION/NATURALIZATION SERVICE (this code is to be end dated and replaced by 33
									'31','O',  -- added 9-26-05 for (31)US - BORDER PATROL vs. FEDERAL PRISONER
									'32','O',  -- added 9-26-05 for (32)US - MARSHALL SERVICE vs. FEDERAL PRISONER
									'33','O',  -- added 9-26-05 for (33)US - IMMIGRATION & CUSTOM ENFORCEMENT vs IMMIGRATION/NATURALIZATION SERVICE
									'34','O',
									'35','O',
									'40','S',
									'61','O',
									--'95','O',
										--Escaped
									--'96','O',
										--Temporary Release
									--'97','O',
										--Released
									'98','O',
									'99','O',
									'NOT ENTERED') as Status

	FROM  	epic.eh_booking b,
	        epic.eh_charge c
	
	WHERE	b.booking_id = c.booking_id
			and mcmb_fnt_DrvChgID(b.entity_id) = c.charge_id
			--two lines below: inmates w/active bookings at selected date, even if they have been subsequently close
	  		and c.offense_date <= v_min_date
	  		and (b.end_date is null
	  				or b.end_date > v_min_date)
	  		and mcmb_fnt_CourtName(c.charge_id) not like '%CIRCUIT%'
  			and mcmb_fnt_CourtName(c.charge_id) != 'MI DEPT OF CORR'
  			and mcmb_fnt_CourtName(c.charge_id) != 'MACOMB COUNTY FRIEND OF THE COURT'

ORDER BY Flag, Court, Judge, Status;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_DoubleBin
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ83
	Crystal: 		DoubleBin.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have MORE then 1 property bin or
					inmates that have been released and still have a property bin listed

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created   
					DLK			05/31/05		Crystal rpt created/uploaded to test 
					R. Stuve	06/06/05		Compiled on OTMAIN   
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Double/Released Property Bins' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Ibin,
				'' as Icell,
				'' as CurrentBin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Exception: Double/Released Property Bins' as RptTitle,
				EPIC.ef_offender_id(op.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(op.entity_id) as InmateName,
			  	pb.bin_number as Ibin,
			  	EPIC.ef_Offender_Cell(op.entity_id) as Icell,
			  	MACOMB.mcmb_fnt_alphabin_current(op.entity_id) as CurrentBin

		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op

		WHERE	pb.bin_id = pi.bin_id
 				and op.item_id = pi.item_id
 				and (MACOMB.mcmb_fnt_alphabin_current(op.entity_id) <> pb.bin_number or EPIC.ef_Offender_Cell(op.entity_id) = '-No Cell-')

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ExceedMaxPop
 (vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY22
	Crystal: 		ExceedMaxPop.rpt
	Purpose:		Used by the Administration/Judges to list all inmates with at least one sentenced
					charge for purposes of sentence reduction to reduce jail overcrowding

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/05		Created  
					R. Stuve	05/28/05		Compiled on OTMAIN 
					R. Stuve	07/08/05		Added lookup on Judge field to return entire name
					M. Zak      09/02/05        Added Pay/or Stay sentence information - removed weeks (not needed per Glenn)   
					DLK         03/17/06
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exceed Max Population' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as FM,
				'' as PA325,
				'' as ChargeNum,
				'' as ChargeText,
				'' as Judge,
				'' as CaseNum,
				0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentStart,
				v_date_null as SentEnd, 
				0 as Bail,
		        '' as FineAmt,
		        '' as BailPaid,
		        '' as PercentBail,
		        '' as Status,  
		        v_date_null as PdOutDate, 
		        v_date_null as UnPdOutDate
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
				'Exceed Max Population' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
				MACOMB.mcmb_fnt_FelMisd(c.charge_id) as FM,
				MACOMB.mcmb_fnt_StatuteCategory(c.charge_id) as PA325,
				MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
				MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeText,
				EPIC.ef_lookup_text('JUDGE NAME', MACOMB.mcmb_fnt_JudgeName_chargeid(c.charge_id),'UC') as Judge,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNum,
    		    sd.years as SentYears,
	    	   	sd.months as SentMonths,
		     	--sd.weeks as SentWeeks,  -- not needed per Glenn
		    	sd.days as SentDays,				-- MAZ added below PSentYears, Mnths, Days 9-2-05
		    	(select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id      
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        --(select sd.weeks from eh_sentence_fine sf,eh_sentence_duration sd
		        --  		where s.sentence_id = sf.sentence_id
			    --     		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			    			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentStart,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentEnd,
				to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bail,
		        MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,           -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_BailPaid(c.charge_id) as BailPaid,              -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_percentbail(c.charge_id) as PercentBail,        -- MAZ added 9-2-05
		        MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as Status,            -- MAZ added 9-2-05
		        EPIC.ef_epic_date_to_date(so.paid_out_date) as PdOutDate,     -- MAZ added 9-2-05
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as UnPdOutDate  -- MAZ added 9-2-05
				
		FROM    EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_charge c,
				EPIC.eh_active_booking ab,
				EPIC.eh_sentence_out_dates so -- MAZ added 9-2-05
		
		WHERE  	ab.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  -- MAZ added 9-2-05
				and s.duration_id = sd.sentence_duration_id (+)
				and c.charge_state <> '6'
				and MACOMB.mcmb_fnt_SentOneChg(ab.entity_id) = 'S'

ORDER BY Flag, Judge, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FaceSheetBook
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		InmateFaceSheetBk_sub.rpt (Sub Report: Part 2 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created 
					R. Stuve	07/12/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field 
					M.Zak       8/10/05         Added Paid Outdate, Unpaid Outdate
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	03/23/06		Modified per commments
					R. Stuve	11/31/06		Added Next Court Date (per SRF 12791)
					R. Stuve	06/04/07		Changed mf_NextCourtDate to mf_NextCourtDate_Charge to accurately display court date
												associated with charge (per TC#45148)
					
					
*/
    v_date_null	date;
				
BEGIN 

v_date_null := null;

	OPEN vCur FOR
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No, 
		 	MACOMB.mf_NextCourtDate_Charge(ch.charge_id) as NextCourtDate,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	sd.years as SentYears,
		   	sd.months as SentMths,
		   	sd.weeks as SentWeeks,
		   	sd.days as SentDays,
		   	(select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    MACOMB.mf_SntEdcRl(s.sentence_id) as SntEdcRls,	--RAS: added 3/23/06
		    MACOMB.mf_SntFine(s.sentence_id) as SntFine,  --RAS: added 3/23/06
		    MACOMB.mf_SntMiscInfo(s.sentence_id) as SntMiscInfo,  --RAS: added 3/23/06
		    MACOMB.mf_WknRlsTm(s.sentence_id) as SntWorkRlsTime,   --RAS: added 3/23/06
		    MACOMB.mf_SntWrkSk(s.sentence_id) as SntWorkSeek,    --RAS: added 3/23/06		    
		    MACOMB.mf_SntWrkRlsG (s.sentence_id) as WorkRlsGrnt,    --RAS: added 3/23/06
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    MACOMB.mf_bailcrtdsp(ch.charge_id) as BailCourtDispo,  --RAS: added 3/23/06  
		    MACOMB.mf_BailMayBeRls(ch.charge_id) as BailMayRls,	   --RAS: added 3/23/06
		    MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status, 
		    bk.entity_id as EntityId, 
		    EPIC.ef_epic_date_to_date(so.paid_out_date) as PdOutDate,   -- MAZ testing
		    EPIC.ef_epic_date_to_date(so.unpaid_out_date) as UnPdOutDate  -- MAZ testing
            
	
	FROM   	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd, 
			EPIC.eh_sentence_out_dates so, -- MAZ testing
			EPIC.eh_release r
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.sentence_id = so.sentence_id (+)  -- MAZ testing
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and ch.charge_state <> '6'
			and bk.entity_id = p_InmateID
		
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FaceSheetDemo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		***.rpt (Main Report: Part 1 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created  
					R. Stuve	07/05/05		Changed where clause to link on primary_identity_id
												instead of entity_id to avoid duplicate record returns 
					R. Stuve	07/11/05		Added Funds field for inmate's current available funds        
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION  
					R. Stuve	03/24/06		Modified Keep Separate logic (per comments)
					
*/
    v_date_null	date;
				
BEGIN 

v_date_null := null;

	OPEN vCur FOR
			SELECT 	EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_inmatefunds(ep.entity_id) as Funds,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.primary_identity_id = epi.identity_id
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			0  as Funds,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			null as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id 
			and (ks.end_date is null or EPIC.ef_epic_date_to_date(ks.end_date) > EPIC.ef_epic_date_to_date(sysdate))  --RAS: added 3/24/06 to filter only active keep seperates
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			0  as Funds,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			null as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and (ks.end_date is null or EPIC.ef_epic_date_to_date(ks.end_date) > EPIC.ef_epic_date_to_date(sysdate))  --RAS: added 3/24/06 to filter only active keep seperates
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FaceSheetHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ71
	Crystal: 		***.rpt (Sub Report: Part 3 of 3)
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/22/05		Created  
					DLK         03/17/06        ADDED MACOMB AND EPIC SCHEMA NOTATION 
					R. Stuve	03/23/06		Misc edits per SRF 11966
					
*/
				
BEGIN 

	OPEN vCur FOR
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--bh.code_charge_severity as Severity, --not needed 3/23/06 per K.Roberts
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber, 
			MACOMB.mf_HoldCourt(bh.hold_id) as HoldCourt,   --added 3/23
			MACOMB.mf_HoldInfo(bh.hold_id) as HoldInfo		--added 3/23

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk

	WHERE	bk.booking_id = bh.booking_id
			and (bh.hold_removed_date is null
					or EPIC.ef_epic_date_to_date(bh.hold_removed_date) < EPIC.ef_epic_date_to_date(sysdate))
			and bk.entity_id = p_InmateID;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FedPris
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ49
	Crystal: 		FederalPrisoners.rpt
	Purpose:		Used by the Jail Office to report statistics to the state/fed regarding the
					number of Federal inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/28/05		Created    
					R. Stuve	05/13/05		Added DOB and FederalID placeholder for future
												federal requirements 
					R. Stuve	05/24/05		Compiled on OTMAIN
					R. Stuve	06/09/05		Changed Controlling Agency to pull from charge id (not booking id) 
					M Zak       09-20-05        Remove Status check with Booking Id, Add - 3 Fed charge status;
					                            'US - BORDER PATROL','IMMIGRATION/NATURALIZATION SERVICE','US - MARSHALL SERVICE'
					                            (Eventually FEDERAL PRISONER will be end dated - per Sgt Roberts)
                   	M.Zak       09-26-05        Modified   Added 'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                                       Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE, FEDERAL PRISONER)   
					M.Zak       03-06-06        Removed Booking Date and Time per Sgt Roberts
												Removed eh_Booking table 
												Change AGY to bring back GA attribute value 
				    DLK         03/17/06        ADDED THE MACOMB AND EPIC SCHEMA NOTATION                                    			
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Case Status (Federal Prisoners)' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Agy,
				'' as Cell,
				'' as Bin,
				'' as DOB,
				'' as FederalID,
		        v_date_null as OffDate  -- offense date
		        
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Case Status (Federal Prisoners)' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
--				mcmb_fnt_ControlAgy(c.charge_id) as Agy,
                MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as Agy,   -- Per Sgt Roberts bring attrib value vs Agy
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				MACOMB.mcmb_fnt_DOB(ab.entity_id) as DOB,  
				MACOMB.mcmb_fnt_AlienNum(ab.entity_id) as FederalID,  
				EPIC.ef_epic_date_to_date(c.offense_date) as offdate  --offense date  -- used instead of booking per Sgt Roberts 3-1-06
				
		
		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c
		
		WHERE	ab.booking_id = c.booking_id
				and c.charge_state != 6
				and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) in ('FEDERAL PRISONER','IMMIGRATION/NATURALIZATION SERVICE','US - BORDER PATROL','US - MARSHALL SERVICE','US - IMMIGRATION & CUSTOM ENFORCEMENT')
		        		
		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FedPrisoners_fin
 (	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY73
	Crystal: 		FedPrisoners_Fin.rpt
	Purpose:		Used by Finance to list FEDERAL PRISONERS total days (total days * daily rate)
	                within a specfied month period  (* This report was desgined to track  
	                federal inmates that do not use the charges; US - BORDER PATROL (added code 8-24-05), 
	                US - MARSHALL SERVICE(added code 8-24-05), and IMMIGRATION/NATURALIZATION SERVICE. 
	                
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-31-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay)  
					DLK         03/17/06        ADDED THE MACOMB AND EPIC NOTATION 
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC. eh_booking.start_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - Federal Prisoners' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate,
				'' as ControlAgy
				--'' as Charge
				
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 
SELECT	2 as Flag,
			'Finance - Federal Prisoners' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate,
       		MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy  -- added 9-14-05 
            --MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge   -- added 9-14-05 not sure if needed mzak
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'FEDERAL PRISONER'  
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheet
	(	vCur		out		epic.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		epic.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ11 (production)/ ZZ30 (test)
	Crystal: 		floorsheet.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query
					R.Stuve		12/14/04		Added Floor prompt ($LocID$) via v_floor variable
					dlk			01/19/05		Added to report tree to test added rpt title and floor info
												to union 2 
					R. Stuve  	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting 
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance
                    M. Zak      01/14/08        Correct Sort Order for High Obser Holding Cells - 
                                                Per Glenn - Administration would like these new cells to appear after MH17 and before MH18 since that is where these cells are physically located
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := epic.ef_location_path_name(p_Floor, 'UC', 5);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	epic.ef_offender_id(ab.entity_id) as Inmate#,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'   
			 	when substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-14-08 MZ (per Glenn incorrect sort order)
				else substr(epic.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			epic.ef_location_name(ha.location_id,'uc') as Cell,
			macomb.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			to_date(macomb.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			macomb.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			macomb.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			epic.eh_housing_assignments ha,
			epic.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheettest
	(	vCur		out		epic.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		epic.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ11
	Crystal: 		***.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query
					R.Stuve		12/14/04		Added Floor prompt ($LocID$) via v_floor variable
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := epic.ef_location_path_name(p_Floor, 'UC', 5);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet' as RptTitle,
    		v_floor as RptFloor,    		
        	epic.ef_offender_id(ep.entity_id) as Inmate#,
			epic.ef_get_personororgname(bk.entity_id) as InmateName,
        	substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			epic.ef_location_name(ha.location_id,'uc') as Cell,
			mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
			epic.ef_epic_date_to_date(epi.date_of_birth) as DOB,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(bk.entity_id), 'UC') as SecurityClass,
			mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
			mcmb_fnt_activealerts_full(bk.entity_id) as ActiveAlerts
    FROM
			epic.eh_housing_assignments ha,
			epic.eh_active_booking ab,
			epic.eh_booking bk,
			epic.eh_person_identity epi,
			epic.eh_entity_person ep
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		AND ep.entity_id = ab.entity_id
			AND  bk.booking_id = ab.booking_id
			AND epi.entity_id = ab.entity_id
			AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			AND substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheet_class
	(	vCur		out		epic.epp_generic_ref_cursor.ref_cursor,
		p_Floor		in		epic.eh_housing_assignments.location_id%type)

IS

/*	Form Usage: 	CRSTL.ZZ16
	Crystal: 		floorsheetclass.rpt
	Purpose:		Used by Classification to list all inmates in the MCJ. Some additional fields
					from the 'regular' floor sheet that pertain only to Classification

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/10/05		Created 
					R. Stuve	05/10/05		Crystal report created and linked to tree
					R. Stuve	05/24/05		Compiled on OTMAIN 
					R. Stuve	07/13/05		Added case statement to 'Sort' to correct MH sorting, changed to DOB function
												to remove table links to optomize performance    
				    M. Zak      01/15/08        Correct Sort Order for High Obser Holding Cells - 
                                                Per Glenn - Administration would like these new cells to appear after MH17 and before MH18 since that is where these cells are physically located

												
	
*/  

		v_floor		varchar2(64);	   

BEGIN

		v_floor := epic.ef_location_path_name(p_Floor, 'UC', 5);

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet (Classification)' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as Interview,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet (Classification)' as RptTitle,
    		v_floor as RptFloor,    		
        	epic.ef_offender_id(ab.entity_id) as Inmate#,
        	macomb.mcmb_fnt_Interview(ab.booking_id) as Interview,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'   
			    when substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-14-08 MZ (per Glenn incorrect sort order)
				else substr(epic.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort, 
				--don't need to display on report: for sorting purposes only
			epic.ef_location_name(ha.location_id,'uc') as Cell,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			macomb.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			macomb.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    
    FROM	epic.eh_housing_assignments ha,
			epic.eh_active_booking ab

	WHERE 	ha.entity_id (+) = ab.entity_id
			AND substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheet_CRE_stn2
	(	vCur		out		epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		floorsheet_CRE_stn2.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-11-05        Created - Report ran through CRE (floorsheet_CRE.rpt)
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := 'STATION 2'; 
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	epic.ef_offender_id(ab.entity_id) as Inmate#,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(epic.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			epic.ef_location_name(ha.location_id,'uc') as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			to_date(mcmb_fnt_DOB(ab.entity_id)) as DOB,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			epic.eh_housing_assignments ha,
			epic.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheet_CRE_stn3
	(	vCur		out		epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		floorsheet_CRE_stn3.rpt
	Purpose:		To list all inmates housed on the specified floor

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-11-05        Created - Report ran through CRE (floorsheet_CRE.rpt)
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/  

		v_floor		varchar2(64);
		v_date_null	date;	   

BEGIN

		v_floor := 'STATION 3'; 
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'FLOOR SHEET' as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
				v_date_null as DOB,
				'' as SecurityClass,
				0 	as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'FLOOR SHEET' as RptTitle,
    		v_floor as RptFloor,    		
        	epic.ef_offender_id(ab.entity_id) as Inmate#,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
			(case	when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
				else substr(epic.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end) as Sort,
				--the above line doesn't need to be displayed on report: in query for sorting purposes only
			epic.ef_location_name(ha.location_id,'uc') as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			to_date(mcmb_fnt_DOB(ab.entity_id)) as DOB,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			epic.eh_housing_assignments ha,
			epic.eh_active_booking ab
			
	WHERE 	ha.entity_id (+) = ab.entity_id
    		and substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_floor_sheet_trustees
	(	vCur		OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_Floor		IN		EPIC.eh_housing_assignments.location_id%TYPE)

IS

/*	Form Usage: 	CRSTL.ZZ13
	Crystal: 		floortrustee.rpt
	Purpose:		Used by Inmate Funds to list all inmates with Trustee status only housed on the specified floor(s)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/14/04		Created 
					dlk			01/11/05		Added to tree added title and floor info for header   
					DLK			01/18/05		Cont. dev. in CRYSTAL  to test 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/24/05		Added 'Sort' field to correct cell sorting  
					R. Stuve	04/23/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
					R. Stuve	04/06/06		Commented DOB as not needed on report
					R. Stuve	12/15/06		Added custody status 65 (Pre-Kitchen Trustee) to WHERE clause (per SRF 11943)
					R. Stuve	07/02/07		Verified EPIC/MACOMB: moved only to MACOMB
                    M. Zak      01/15/08        Correct Sort Order for High Obser Holding Cells - 
                                                Per Glenn - Administration would like these new cells to appear after MH17 and before MH18 since that is where these cells are physically located

			
*/  

v_floor		VARCHAR2(64);
v_date_null	DATE;	   

BEGIN
v_floor := EPIC.ef_location_path_name(p_Floor, 'UC', 5);    
v_date_null := NULL;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Floor Sheet Trustees'  as RptTitle,
				v_floor as RptFloor,
				'' as Inmate#,
				'' as InmateName,
				'' as Floor,
				'' as Sort,
				'' as Cell,
				'' as Bin,
			 --	v_date_null as DOB,
				'' as SecurityClass,
				0  as Funds,
				'' as ActiveAlerts
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
    SELECT  2 as Flag, 
    		'Floor Sheet Trustees' as RptTitle,
    		v_floor as RptFloor,    		
        	EPIC.ef_offender_id(ab.entity_id) as Inmate#,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
        	substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor,
        	(CASE	
        		WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) LIKE 'MENT HLTH, HIGH%' THEN 'Z'
				WHEN EPIC.ef_location_path_name(ha.location_id,'UC',6) LIKE 'MENT HLTH, LOW%' THEN 'Y' 
				WHEN substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-14-08 MZ (per Glenn incorrect sort order)
				ELSE substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
				END) as Sort, 
    		--the above line doesn't need to be displayed on report: in query for sorting purposes only
			EPIC.ef_location_name(ha.location_id,'uc') as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			--to_date(MACOMB.mcmb_fnt_DOB(ab.entity_id)) as DOB,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) as ActiveAlerts
    FROM
			EPIC.eh_housing_assignments ha,
			EPIC.eh_active_booking ab,
			EPIC.eh_entity_status e
			
	WHERE 	ha.entity_id (+) = ab.entity_id 
    		AND e.entity_id = ab.entity_id
			AND substr(EPIC.ef_location_path_name(ha.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(ha.location_id,'UC',5),',',1)-1) = v_floor
			AND e.code_custody_status IN ('6','9','10', '65')
	
	ORDER BY Flag, Floor, Sort, Cell;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ForeignBorn
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY33
	Crystal: 		foreignborn.rpt
	Purpose:		Used by the Administration (for grant/funding purposes) to return all 
					inmates booked during the time period with a birth country other than
					USA (regardless of current citizenship)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/21/04		Created  
					dlk			12/27/04		added to tree test 
					dlk         01/07/05		Added the v_date to get the date to repeat in the select 2 lines on each page
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION
					
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Foreign Born Inmates' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InnmateNum,
				'' as BirthCountry,
				'' as Cell
			
		FROM	dual
		
	UNION ALL		
		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Foreign Born Inmates' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
     		EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_birthcountry(b.entity_id) as BirthCountry,
			EPIC.ef_offender_cell (b.entity_id) as Cell

FROM 	EPIC.eh_booking b,
		EPIC.eh_housing_assignments ha,
		EPIC.eh_person_identity p

WHERE	ha.entity_id (+) = b.entity_id
		and p.entity_id = b.entity_id
		and EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
		and EPIC.ef_epic_date_to_date(b.start_date) < v_max_date
		and p.birth_country != 'US'
		and p.code_name_type =  'MAS'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ForeignBorn_CRE
	(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		foreignborn_CRE.rpt
	Purpose:		Used by the Administration (for grant/funding purposes) to return all 
					inmates booked during the time period with a birth country other than
					USA (regardless of current citizenship)


	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-12-05        Created - Report ran through CRE (JailUtilCrctCt_CRE.rpt)
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/
					
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type;
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= epic.ef_min_date(epic.epicdate(sysdate - 1)); --ef_min_date(p_StartDate); 
		v_max_date	:= epic.ef_max_date(epic.epicdate(sysdate - 1)); -- ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(epic.epicdate(sysdate - 1)), epic.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(epic.ef_epic_date_to_date(epic.epicdate(sysdate - 1)), epic.ef_date_format),1,100);
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Foreign Born Inmates' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InnmateNum,
				'' as BirthCountry,
				'' as Cell
			
		FROM	dual
		
	UNION ALL		
		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Foreign Born Inmates' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
     		epic.ef_get_personororgname(b.entity_id) as InmateName,
			epic.ef_offender_id(b.entity_id) as InmateNum,
			mcmb_fnt_birthcountry(b.entity_id) as BirthCountry,
			epic.ef_offender_cell (b.entity_id) as Cell

FROM 	epic.eh_booking b,
		epic.eh_housing_assignments ha,
		epic.eh_person_identity p

WHERE	ha.entity_id (+) = b.entity_id
		and p.entity_id = b.entity_id
		and b.start_date >= v_min_date
		and b.start_date < v_max_date
		and p.birth_country != 'US'
		and p.code_name_type =  'MAS'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ForenExOrd
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		ForenExOrd.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Forensic Exam Ordered)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Forensic Exam Ordered)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'FORENSIC EXAM ORDERED'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_FundsDailyAct
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		EPIC.eh_trust_account_trans.trans_date%type)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY20
	Crystal: 		fundsdailyact.rpt
	Purpose:		Used by the Inmate Funds/Accounting to list all inmate financial
					transactions completed for the selected date/date range. 
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/19/05		Created  
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'    
					DLK			02/23/05		beg devl
					DLK			03/03/05		Added subreport fundsdailyactsub.rpt 
					DLK			03/07/05		Calls sub-report fundsdailyactsub.rpt
												To generate summary on second page.
					R. Stuve	04/23/05		Compiled on OTMAIN 
					R. Stuve	07/15/05		Added 'Action By' field 
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATION  
					MAZ          1-29-09        Added EPIC.ef_min_date to where clause

*/
 		v_min_date		EPIC.eh_trust_account_trans.trans_date%type; 
 		v_date_from	  	EPIC.eh_trust_account_trans.trans_date%type; 
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Daily Funds Transactions' as RptTitle, 
				  v_date_from as RptStart,
				'' as TransTime,
				'' as TransDesc,
				'' as TransNum,
				0 as Amount,
				'' as InmateName,
				'' as InmateNum,
				v_date_null as TransDate,
				'' as Reversal,
				'' as TType,
				'' as ActionBy
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Daily Funds Transactions' as RptTitle,
				v_date_from as RptStart,
				substr(EPIC.ef_epic_date_to_date(tat.action_time),12,8) as TransTime,
				concat(concat(to_char(tat.code_source_of_funds), ' - '),MACOMB.mcmb_fnt_TransType(tat.trust_account_trans_id)) as TransDesc,
				tat.transaction_number as TransNum,
				tat.amount as Amount,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TransDate,
				tat.reverse_flag as Reversal,
				decode(substr(to_char(tat.code_source_of_funds),1,1),
					'2','Liability',
					'4','Deposit',
					'5','Withdrawal',
					'8','Withdrawal') as TType,
				MACOMB.mcmb_fnt_user(tat.action_by) as ActionBy

		FROM	EPIC.eh_trust_account_trans tat,
				EPIC.eh_trust_account t

		WHERE	tat.trust_account_id = t.trust_account_id
				and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(tat.trans_date)) = v_min_date

ORDER BY Flag, TType, TransDesc, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_futurerelease
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_sentence.final_release_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.ZZ34
	Crystal: 		futurereleases.rpt
	Purpose:		Used by the Jail Office to list all inmates eligible for release during
					the specified time period. If an inmate is a 'Weekender', shows the time
					of release.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/10/05		Added to tree and report title/dates in second query
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/18/05		Changed some items in where clause to include pay-or-stay
												functionality; added UnpaidFlag, only input = StartDate
					R. Stuve	03/28/05		Per Bob M, changed final_release_date to sentence_end_date
					dlk			04/10/05		uploaded to tree  for additional testing
					R. Stuve	04/23/05		Compiled on OTMAIN   
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
					JDM         10/28/06        Corrected for daylights savings time.
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/
        v_min_date		EPIC.eh_sentence.final_release_date%type;  
     	v_date_from		EPIC.eh_sentence.final_release_date%type;
 		v_date_null		date; 
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));    
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Future Release(s)' as RptTitle,
				v_date_from as RptStart,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0  as Funds,
				v_date_null as ChargeDisp,
				'' as IType,
				'' as WRTime,
				'' as UnpaidFlag
		
		FROM	dual
		
	UNION ALL			              
		
		--the below query pulls back the actual report data
		SELECT  2 as Flag,
				'Future Release(s)' as RptTitle, 
			    v_date_from as RptStart, 
				EPIC.ef_offender_id(bk.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
				EPIC.ef_offender_cell(bk.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
				MACOMB.mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
				EPIC.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
					--date the single charge can be disposed (expected end-date on Sentences tab)
				decode(e.code_custody_status, 4, 'W') as IType,
					--above specifies Weekenders: don't need to display on report
				MACOMB.mcmb_fnt_wrlstime(bk.entity_id) as WRTime,
					--the above is the 'non-standard' release time for Weekender Release (if specified)
				MACOMB.mcmb_fnt_Unpaid(s.sentence_id) as UnpaidFlag
					--don't need to display on report
		
		
		FROM	EPIC.eh_booking bk,
				EPIC.eh_sentence s,
				EPIC.eh_charge c,
				EPIC.eh_entity_status e,
				EPIC.eh_sentence_out_dates sod
		
		WHERE	bk.entity_id = e.entity_id
				AND s.sentence_id = c.sentence_id
				AND c.booking_id = bk.booking_id
				AND s.sentence_id = sod.sentence_id
				AND c.charge_state <> 6
				AND (EPIC.ef_epic_date_to_date(EPIC.ef_min_date(s.sentence_end_date)) = v_min_date or EPIC.ef_epic_date_to_date(EPIC.ef_min_date(sod.paid_out_date)) = v_min_date)

	ORDER BY Flag, IType desc, UnpaidFlag desc, InmateName;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_futurerelease_org
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			epic.eh_sentence.final_release_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.ZZ34
	Crystal: 		futurereleases.rpt
	Purpose:		Used by the Jail Office to list all inmates eligible for release during
					the specified time period. If an inmate is a 'Weekender', shows the time
					of release.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/10/05		Added to tree and report title/dates in second query
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/18/05		Changed some items in where clause to include pay-or-stay
												functionality; added UnpaidFlag, only input = StartDate
					R. Stuve	03/28/05		Per Bob M, changed final_release_date to sentence_end_date
					dlk			04/10/05		uploaded to tree  for additional testing
					R. Stuve	04/23/05		Compiled on OTMAIN
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
        v_min_date		epic.eh_sentence.final_release_date%type;  
     	v_date_from		epic.eh_sentence.final_release_date%type;
 		v_date_null		date; 
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(p_StartDate);    
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_null := null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Future Release(s)' as RptTitle,
				v_date_from as RptStart,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Bin,
				0  as Funds,
				v_date_null as ChargeDisp,
				'' as IType,
				'' as WRTime,
				'' as UnpaidFlag
		
		FROM	dual
		
	UNION ALL			              
		
		--the below query pulls back the actual report data
		SELECT  2 as Flag,
				'Future Release(s)' as RptTitle, 
			    v_date_from as RptStart, 
				epic.ef_offender_id(bk.entity_id) as Inmate#,
				epic.ef_get_personororgname(bk.entity_id) as InmateName,
				epic.ef_offender_cell(bk.entity_id) as Cell,
				mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
				mcmb_fnt_inmatefunds(bk.entity_id) as Funds,
				epic.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
					--date the single charge can be disposed (expected end-date on Sentences tab)
				decode(e.code_custody_status, 4, 'W') as IType,
					--above specifies Weekenders: don't need to display on report
				mcmb_fnt_wrlstime(bk.entity_id) as WRTime,
					--the above is the 'non-standard' release time for Weekender Release (if specified)
				mcmb_fnt_Unpaid(s.sentence_id) as UnpaidFlag
					--don't need to display on report
		
		
		FROM	epic.eh_booking bk,
				epic.eh_sentence s,
				epic.eh_charge c,
				epic.eh_entity_status e,
				epic.eh_sentence_out_dates sod
		
		WHERE	bk.entity_id = e.entity_id
				AND s.sentence_id = c.sentence_id
				AND c.booking_id = bk.booking_id
				AND s.sentence_id = sod.sentence_id
				AND c.charge_state <> 6
				AND (epic.ef_min_date(s.sentence_end_date) = v_min_date or epic.ef_min_date(sod.paid_out_date) = v_min_date)

	ORDER BY Flag, IType desc, UnpaidFlag desc, InmateName;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_GreaterthanYear
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY34
	Crystal: 		greaterthanayear.rpt
	Purpose:		Used by the Medical staff to determine which inmates have been incarcerated
					for more than one year so that law-mandated reviews may be conducted
					
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/17/05		Created   
					DLK			02/23/05		Added to the Report Tree for test
					R. Stuve	05/28/05		Compiled on OTMAIN
					dlk         03/17/06        ADDED MACOMB AND EPIC NOTIONS
	
*/
	
v_date_null		date;
			
BEGIN 

v_date_null := null; 
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Inmates In Jail OVER 1 Year' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				v_date_null as BookingDate,
				v_date_null as Outdate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 	distinct 2 as Flag,
			'Inmates in Jail OVER 1 Year' as RptTitle, 
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
			EPIC.ef_epic_date_to_date(bk.final_release_date) as Outdate
				--the day the inmate physically gets out of jail

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_booking bk,
			EPIC.eh_charge ch
	
	WHERE	ab.entity_id = bk.entity_id
			and ab.booking_id = ch.booking_id
			and ch.charge_state != '6'
			and EPIC.ef_epic_date_to_date(bk.end_date) is null
			and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) <= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(add_months(sysdate,-12))))

ORDER BY Flag, BookingDate, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistAllBook
 (	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListBk_sub.rpt (Sub Report: Part 2 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Charge Disposal Date
					R. Stuve	06/02/05		Added charged index number as a sorting field  
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field   
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS	
					R. Stuve	10/02/06		Reformatted DispoDate to correct; added DispoReason; added 12 GA fields
					R. Stuve    04/04/07		Removed to_date function from DispoDate	to correct discrepancy between MACOMB and EPIC					
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
		    EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate,
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    MACOMB.mf_GA_Charge(ch.charge_id, 'HELD FOR') as HeldFor,
			MACOMB.mf_GA_Charge(ch.charge_id, 'BONDING AGENCY') as BondingAgency,
			MACOMB.mf_GA_Charge(ch.charge_id, 'PACC CODE') as PACCCode,
			MACOMB.mf_GA_Charge(ch.charge_id, 'DIST VENUE') as DistVenue,
			MACOMB.mf_GA_Charge(ch.charge_id, 'CONVICTION SET ASIDE NON PUBLIC') as Conviction,
			MACOMB.mf_GA_Bail(ch.charge_id, 'COURT DISPOSITION') as CourtDispo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'EDUCATIONAL RELEASE') as EducRls,
			MACOMB.mf_GA_Sent(s.sentence_id, 'MISC SENTENCE INFO') as MiscSentInfo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'RESTITUTION JUDGEMENT AMOUNT') as RestJudAmt,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WEEKENDER RELEASE TIME') as WeekenderRlsTime,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK RELEASE GRANTED') as WorkRlsGranted,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK SEEK') as WorkSeek

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID

	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistAllDemo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompList_Main.rpt (Main Report: Part 1 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created  
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records 
					R. Stuve	06/07/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS 
					R. Stuve	10/02/06		Reformatted Reviewed Date to correct
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate,
			ep.entity_id as EntityId

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
			'' as EntityId
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
		    '' as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistAllHolds
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListHd_sub.rpt (Sub Report: Part 4 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN  
					DLK         03/17/06        ADDED MACOMB AND EPIC NOTATIONS
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--EPIC.ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistAllHolds_dlk
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.XX56
	Crystal: 		PyschHolds_sub_dlk.rpt (Sub Report: PsychWHolds)
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs with Hold Data
						
	Author:			Diana Kuykendall

	Change Log:		Changed By	    Date Modified	Change Made
					----------	    -------------	------------------------------------------
					D. Kuykendall	12/02/05		Created 
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  epic.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			epic.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			epic.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	epic.eh_booking_holds bh,
			epic.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and bh.hold_removed_date is null
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistAllNotes
	(	vCur 			OUT 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		IN		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ36
	Crystal: 		HistCompListNt_sub.rpt(Sub Report: Part 3 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created  
					R. Stuve	06/07/05		Compiled on OTMAIN  
					R. Stuve	07/13/05		Added joins on IN/DP notes section (commented in code)
												so to display incidents/restrictions without notes 
					M. Zak      08-11-05        Added PB 'Property Bin' Note Section 
					M. Zak      08-15-05        Chgd Note Date and Time from pb to pi
					                            Changed PB Note to pull Data in Note Title only (1 line vs 2 in CR Report)
					                            vs. Note Title & Note Desc
					M. Zak		08-16-05		Added Release Date/Time to PB Note Section
					R. Stuve	04/09/07		Broke out NoteText so can display more than 4000 characters (limit of varchar2 field) 
					                            
*/

v_date_null DATE;
			
BEGIN

v_date_null := NULL; 

	OPEN vCur FOR
		--the below pulls all historical notes for the inmate
			--DEMOGRAPHICS NOTES
	SELECT	distinct 'DN' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_address a,
			EPIC.eh_booking bk
	
	WHERE	bk.entity_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID

----------
UNION ALL
----------
			--FOOD REFUSAL NOTES
	SELECT 	'FR' as NoteType,
			EPIC.ef_epic_date_to_date(sd.delivery_date_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(sd.delivery_date_time),12,5) as NoteTime,
	        sd.code_service_type as NoteTitle,
	        sd.code_item || ': ' || sd.comments as NoteText1_2,
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_service_delivery sd
	
	WHERE	bk.booking_id = sd.booking_id
			AND sd.refused = 'Y'
			AND sd.code_service_type = 'FOOD REFUSED'
			AND bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--CHARGE NOTES
	SELECT  'CH' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_charge c,
			EPIC.eh_booking bk
	
	WHERE  	bk.booking_id = c.booking_id
			AND c.charge_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--SENTENCING NOTES
	SELECT  'SE' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_sentence s,
			EPIC.eh_charge c,
			EPIC.eh_booking bk

	WHERE   bk.booking_id = c.booking_id
			AND c.sentence_id = s.sentence_id
			AND s.sentence_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID

-------
UNION ALL
------
			--CLASSIFICATION NOTES
	SELECT	'SC' as NoteType,
		    EPIC.ef_epic_date_to_date(sc.action_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(sc.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
		    '' as NoteText3, 
		    '' as NoteText4, 
		    '' as NoteText5,
		    EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
	        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
	       	sc.override_reason as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.eh_booking bk,
			EPICAUDIT.eh_security_classification sc
	
	WHERE   bk.booking_id = sc.booking_id
			AND bk.entity_id = p_InmateID
			
--------
UNION ALL
--------
			--INCIDENT NOTES
	SELECT 'IN' as NoteType,
			EPIC.ef_epic_date_to_date(i.incident_date) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(i.incident_date),12,5) as NoteTime,
		    i.incident_number || ': ' || EPIC.ef_lookup_text('INCIDENT TYPE', i.code_incident_type, 'UC') as NoteTitle,
			'LOCATION: ' ||EPIC.ef_location_name(i.location_id, 'UC') || chr(13) || (select 'MECHANICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where i.mechanical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) || chr(13)|| (select 'CHEMICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where  i.chemical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) as NoteText1_2,
			'' as NoteText3,
			'' as NoteText4, 
			'' as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        io.entity_id as EntityId
	        
	
	FROM	EPIC.eh_incident_offender io,
			EPIC.eh_incident i,
			EPIC.eh_incident_description id
	
	WHERE 	io.incident_id = i.incident_id
			AND i.incident_id = id.incident_id  (+)      --added join on 7/13 RAS
			AND io.entity_id = p_InmateID

------
UNION ALL
------
			--RESTRICTION NOTES
	SELECT	'DP' as NoteType,
		    EPIC.ef_epic_date_to_date(er.action_time) as NoteDate,
		    substr(epic.ef_epic_date_to_date(er.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        er.incident_id as DPIncidentId,
	        EPIC.ef_epic_date_to_date(er.begin_date) as DPResBegDate,
	        EPIC.ef_epic_date_to_date(er.end_date) as DPResEndDate,
	        EPIC.ef_lookup_TEXT('RESTRICTION TYPE',er.code_restriction_type,'UC') || ': ' ||EPIC.ef_lookup_TEXT('RESTRICTION REASON',er.code_restriction_reason,'UC') as DPResReason,
	        er.comments as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        er.entity_id as EntityId
	        
	
	FROM	epic.eh_entity_restriction er,
			epic.epic_notes n,
			epic.epic_note_book nb
	
	WHERE   er.entity_restriction_id = nb.epic_id (+)          --added join on 7/13 RAS
			AND nb.note_id = n.note_ref (+)                    --added join on 7/13 RAS
			AND er.entity_id = p_InmateID

--------
UNION ALL
--------
			--LOG NOTES
	SELECT	'LG' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        el.log_type as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05    
	        el.epic_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_entity_log el
	
	WHERE  	el.note_id = n.note_ref
			AND el.epic_id = p_InmateID

-------
UNION ALL
-------
			--HOUSING ALLOCATION/MOVES NOTES
	SELECT  'CL' as NoteType,
			EPIC.ef_epic_date_to_date(ha.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ha.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLStartDate,
			EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLEndDate,
	       	EPIC.ef_location_name(ha.location_id,'UC')as CLCellName,
	       	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'L') as CellClassLo,
		  	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'H') as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        ha.entity_id as EntityId
	
	FROM 	EPICAUDIT.eh_housing_assignments ha,
			EPIC.epic_locations loc
	
	WHERE 	loc.location_id = ha.location_id
			AND ha.action_type = 'U'
			AND ha.entity_id = p_InmateID

-----
UNION ALL
------
			--HOLD NOTES
	SELECT	'HO' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05   
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bh.booking_id
			AND bh.hold_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BOOKING NOTES FROM OTHER ATTRIBUTES
	SELECT	'IB' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),12,5) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
            v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPICAUDIT.eh_generic_attribute ga
	
	WHERE	bk.booking_id = ga.item_id
			AND bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--BOOKING NOTES FROM NOTEBOOK
	SELECT 	'IB' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time)as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
		    v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
		    EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE 	bk.booking_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BAIL CONDITION NOTES FROM OTHER ATTRIBUTES
	SELECT	'BC' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),11,6) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPICAUDIT.eh_generic_attribute ga
	
	WHERE	bk.booking_id = bc.booking_id
			AND bc.bail_condition_id = ga.item_id
			AND bk.entity_id = p_InmateID

-------
UNION ALL
--------
			--BAIL CONDITION NOTES FROM NOTEBOOK
	SELECT 	'BC' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
			n.note_name as NoteTitle,
			n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	       	bk.booking_number as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bc.booking_id
			AND bc.bail_condition_id = nb.epic_id
			AND nb.note_id = n.note_ref
			AND bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--KEEP SEPARATE NOTES
	SELECT 	distinct 'KS' as NoteType,
			EPIC.ef_epic_date_to_date(ks.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ks.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    ks.comments as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        EPIC.ef_offender_id(ks.origin_entity_id) as OriginKSNo,
		    EPIC.ef_get_personororgname(ks.origin_entity_id) as OriginKSName,
		    EPIC.ef_offender_id(ks.separate_entity_id) as SeparateKSNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_booking bk

	WHERE	(bk.entity_id = ks.separate_entity_id
				OR
			bk.entity_id = ks.origin_entity_id)
			AND bk.entity_id = p_InmateID 
-------
UNION ALL
--------			
			--RELEASE NOTES
	SELECT 	'BR' as NoteType,
			EPIC.ef_epic_date_to_date(r.actual_release) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(r.actual_release),11,6) as NoteTime,
			epic.ef_lookup_text('RELEASE TYPE', r.release_type, 'UC') as NoteTitle,
			'' as NoteText1_2,
			'' as NoteText3,
			'' as NoteText4,
			'' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	       	v_date_null as CLStartDate,
	      	v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	       	v_date_null as NoteBkStart,
	       	v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	       	v_date_null as DPResBegDate,
	       	v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
            
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_release r

	WHERE	bk.booking_id = r.booking_id
			AND bk.entity_id = p_InmateID  
 -------
UNION ALL
--------				
						
	SELECT	distinct 'PB' as NoteType,  -- M.Zak 8-11-05 added section
   	        EPIC.ef_epic_date_to_date(pi.ACTION_TIME)AS NoteDate,                    -- M.Zak 8-15-05 chgd pb. to pi.
   	        substr(EPIC.ef_epic_date_to_date(pi.action_time),12,5) as NoteTime,      -- M.Zak 8-15-05 chgd pb. to pi.
   	        'PROPERTY BIN    '|| '           BIN #: '||pb.bin_number as NoteTitle,
   	        '' as NoteText1_2,   -- 8-15-05   to save space - created note with just note title (1 line)
   	        '' as NoteText3,
   	        '' as NoteText4,
   	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,     
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        EPIC.ef_epic_date_to_date (psoi.action_time ) as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        op.entity_id as EntityId
	        

	  FROM  EPICAUDIT.otk_property_bin pb,
            EPICAUDIT.eh_property_item pi,
            EPICAUDIT.eh_offender_property op,
            EPICAUDIT.eh_property_sent_out_item psoi,   -- added M.Zak 8-16-05
            EPIC.epic_lookups el

      WHERE	pb.bin_id = pi.bin_id
   			AND pi.item_id = op.item_id
   			AND op.item_id = psoi.item_id(+)   -- added M.Zak 8-16-05 
   			AND el.lookup_class = 'PROPERTY TYPE'
   			AND pi.item_name = el.lookup_code
   			AND op.entity_id = p_InmateID			

ORDER BY NoteDate DESC;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistBin
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.
	Crystal: 		***.rpt 
	Purpose:		Used by Jail Investigation, Classification to list inmate's property bins
	
						
	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		8-1-05			Created			
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls property bins for the inmate
SELECT  op.entity_id as EntityId,
        -- ef_offender_id(op.entity_id) as Inumber,
		epic.ef_get_personororgname(op.entity_id) as Iname,
       	pb.bin_number as Ibin,
       	el.text_full as Item,
       	epic.ef_epic_date_to_date(pi.ACTION_TIME)AS PIdate

FROM 	EPICAUDIT.otk_property_bin pb,
	 	EPICAUDIT.eh_property_item pi,
	 	EPICAUDIT.eh_offender_property op,
		epic.EPIC_LOOKUPS el


	WHERE  	pb.bin_id = pi.bin_id
 			AND op.item_id = pi.item_id
	 		AND el.lookup_class = 'PROPERTY TYPE'
 			AND pi.item_name = el.lookup_code
    	    AND op.entity_id = p_InmateID  --SELECTED INMATE    ef_offender_id(op.entity_id) = '144976' 
    	    
ORDER BY PIdate;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistCurrentBook
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Sub Report: Part 2 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Disposal Date 
					R. Stuve	06/02/05		Added charged index number as a sorting field 
					R. Stuve	06/07/05		Compiled on OTMAIN
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls current bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No, 
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf,epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf,epic.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate, 
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber
	
	FROM   	epic.eh_booking bk,
			epic.eh_active_booking ab,
			epic.eh_charge ch,
			epic.eh_sentence s,
			epic.eh_sentence_duration sd,
			epic.eh_release r
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and ch.charge_state <> '6'
			and bk.entity_id = p_InmateID
		
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistCurrentDemo
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Main Report: Part 1 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records  
					R. Stuve	06/07/05		Compiled on OTMAIN
*/                  

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			epic.ef_get_personororgname(ep.entity_id) as InmateName,
			macomb.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			epic.ef_offender_cell(ep.entity_id)as Cell,
			epic.ef_offender_id(ep.entity_id) as InmateNum,
			macomb.mcmb_fnt_alias(ep.entity_id) as Alias,
			macomb.mcmb_fnt_DOB(ep.entity_id) as DOB,
			macomb.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			macomb.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			macomb.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			macomb.mcmb_fnt_race(ep.entity_id) as Race,
			macomb.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			epic.ef_offender_height(ep.entity_id) as Height,
			epic.ef_offender_weight(ep.entity_id) as Weight,
			macomb.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			macomb.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			macomb.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			macomb.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			epic.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    macomb.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    macomb.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			macomb.mcmb_fnt_address_city(ep.entity_id) as City,
			macomb.mcmb_fnt_address_state(ep.entity_id) as State,
			macomb.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			epic.ef_lookup_text ('SECURITY CLASSIFICATION', epic.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			macomb.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	epic.eh_person_identity epi,
			epic.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id 
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			epic.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			epic.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			epic.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	epic.eh_keep_separate ks,
			epic.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			epic.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    epic.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    epic.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	epic.eh_keep_separate ks,
			epic.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistCurrentHolds
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		***.rpt (Sub Report: Part 4 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls active holds for the inmate
	SELECT  epic.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			epic.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			macomb.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			epic.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			macomb.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber
	
	FROM	epic.eh_booking_holds bh,
			epic.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bh.hold_removed_date is null
			and bk.entity_id = p_InmateID
			
	ORDER BY HoldStart;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistCurrentNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ37
	Crystal: 		HistCurChgNtNt_sub.rpt(Sub Report: Part 3 of 4)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	07/13/05		Added joins on IN/DP notes section (commented in code)
												so to display incidents/restrictions without notes
					M.Zak       08/08/05        Copied otmain procedure to ottest & compiled
												Added code; --- and ha.action_type = 'U'  --- test 8-8-05 MAZ
												to CL note type	--HOUSING ALLOCATION/MOVES NOTES where section	
     				M. Zak		10-26-05		Added Release Date/Time to PB Note Section 		
     				DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION	
     				R. Stuve	04/10/07		Broke out NoteText to allow enough spacing for all text (4000 character limit for varchar2)		
*/                                              

v_date_null date;
			
BEGIN

v_date_null := null; 

	OPEN vCur FOR
		--the below pulls all current notes for the inmate
			--DEMOGRAPHICS NOTES
	SELECT 	'DN' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2  as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        b.entity_id as EntityId
	
	FROM 	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_booking b,
			EPIC.eh_active_booking ab
	
	WHERE	ab.booking_id = b.booking_id
			and b.entity_id = nb.epic_id
			and nb.note_id = n.note_ref
			and ab.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(b.start_date)

---------
UNION ALL
---------

			--FOOD REFUSAL NOTES
	SELECT 	'FR' as NoteType,
			EPIC.ef_epic_date_to_date(sd.delivery_date_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sd.delivery_date_time),12,5) as NoteTime,
	        sd.code_service_type as NoteTitle,
	        sd.code_item || ': ' || sd.comments as NoteText1_2,
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_service_delivery sd
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = sd.booking_id
			and sd.refused = 'Y'
			and sd.code_service_type = 'FOOD REFUSED'
			and EPIC.ef_epic_date_to_date(sd.delivery_date_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
		
---------
UNION ALL
---------

			--CHARGE NOTES
	SELECT  'CH' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_charge c,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE  	ab.booking_id = bk.booking_id
			and bk.booking_id = c.booking_id
			and c.charge_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--SENTENCING NOTES 
	SELECT  'SE' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_sentence s,
			EPIC.eh_charge c,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id
			and s.sentence_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
---------
UNION ALL
---------

			--CLASSIFICATION NOTES
	SELECT	'SC' as NoteType,
		    EPIC.ef_epic_date_to_date(sc.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sc.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
	        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
	       	sc.override_reason as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId        
	
	FROM	EPIC.eh_booking bk,
			epicaudit.eh_security_classification sc,
			EPIC.eh_active_booking ab
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = sc.booking_id
			and EPIC.ef_epic_date_to_date(sc.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--INCIDENT NOTES 
	SELECT 'IN' as NoteType,
	        EPIC.ef_epic_date_to_date(i.incident_date) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(i.incident_date),12,5) as NoteTime,
		    i.incident_number || ': ' || EPIC.ef_lookup_text('INCIDENT TYPE', i.code_incident_type, 'UC') as NoteTitle,
			'LOCATION: ' ||EPIC.ef_location_name(i.location_id, 'UC')||chr(13)|| (select 'MECHANICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where i.mechanical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id)||chr(13)||(select 'CHEMICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where  i.chemical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) as NoteText1_2,
			'' as NoteText3,
			'' as NoteText4,
			'' as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_incident_offender io,
			EPIC.eh_incident i,
			EPIC.eh_incident_description id,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk

	WHERE 	ab.booking_id = bk.booking_id
			and bk.entity_id = io.entity_id
			and io.incident_id = i.incident_id
			and i.incident_id = id.incident_id (+)   --added join on 7/13 RAS
			and EPIC.ef_epic_date_to_date(id.report_date) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and io.entity_id = p_InmateID

---------
UNION ALL
---------

			--RESTRICTION NOTES
	SELECT	'DP' as NoteType,
		    EPIC.ef_epic_date_to_date(er.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(er.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
		    er.incident_id as DPIncidentId,
	        EPIC.ef_epic_date_to_date(er.begin_date) as DPResBegDate,
	        EPIC.ef_epic_date_to_date(er.end_date) as DPResEndDate,
	        EPIC.ef_lookup_TEXT('RESTRICTION TYPE',er.code_restriction_type,'UC') || ': ' ||EPIC.ef_lookup_TEXT('RESTRICTION REASON',er.code_restriction_reason,'UC') as DPResReason,
	        er.comments as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId        
	
	FROM	EPIC.eh_entity_restriction er,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk
	
	WHERE   ab.booking_id = bk.booking_id
	        and bk.entity_id = er.entity_id
			and er.entity_restriction_id = nb.epic_id (+)      --added join on 7/13 RAS
			and nb.note_id = n.note_ref (+)                    --added join on 7/13 RAS
			and EPIC.ef_epic_date_to_date(er.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and er.entity_id = p_InmateID

---------
UNION ALL
---------

			--LOG NOTES
	SELECT	'LG' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        el.log_type as NoteTitle,
	        n.note_text_1  || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	FROM	EPIC.epic_notes n,
			EPIC.epic_entity_log el,
			EPIC.eh_active_booking ab,
			EPIC.eh_booking bk
	
	WHERE  	ab.booking_id = bk.booking_id
			and bk.entity_id = el.epic_id
			and el.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) > = EPIC.ef_epic_date_to_date(bk.start_date)
			and el.epic_id = p_InmateID

---------
UNION ALL
---------

			--HOUSING ALLOCATION/MOVES NOTES
	SELECT  'CL' as NoteType,
			EPIC.ef_epic_date_to_date(ha.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ha.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLStartDate,
			EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLEndDate,
	       	EPIC.ef_location_name(ha.location_id,'UC')as CLCellName,
	       	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'L') as CellClassLo,
		  	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'H') as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM 	epicaudit.eh_housing_assignments ha,
			EPIC.epic_locations loc,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.entity_id = ha.entity_id
			and loc.location_id = ha.location_id 
			and ha.action_type = 'U'  -- test 8-8-05 MAZ
			and EPIC.ef_epic_date_to_date(ha.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and ha.entity_id = p_InmateID

---------
UNION ALL
---------

			--HOLD NOTES
	SELECT	'HO' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = bh.booking_id
			and bh.hold_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BOOKING NOTES FROM OTHER ATTRIBUTES
	SELECT	'IB' as NoteType,
	        EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),12,5) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			epicaudit.eh_generic_attribute ga
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = ga.item_id
			and EPIC.ef_epic_date_to_date(ga.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
---------
UNION ALL
---------

			--BOOKING NOTES FROM NOTEBOOK
	SELECT 	'IB' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time)as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
		    EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_active_booking ab
	
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BAIL CONDITION NOTES FROM OTHER ATTRIBUTES
	SELECT	'BC' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),11,6) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_bail_condition bc,
			epicaudit.eh_generic_attribute ga
	
	WHERE	ab.booking_id = bk.booking_id
			and bk.booking_id = bc.booking_id
			and bc.bail_condition_id = ga.item_id
			and EPIC.ef_epic_date_to_date(ga.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------

			--BAIL CONDITION NOTES FROM NOTEBOOK 
	SELECT 	'BC' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
			n.note_name as NoteTitle,
			n.note_text_1 || n.note_text_2 as NoteText1_2,
			n.note_text_3 as NoteText3,
			n.note_text_4 as NoteText4,
			n.note_text_5 as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_bail_condition bc,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   ab.booking_id = bk.booking_id
			and bk.booking_id = bc.booking_id
			and bc.bail_condition_id = nb.epic_id
			and nb.note_id = n.note_ref
			and EPIC.ef_epic_date_to_date(n.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID

---------
UNION ALL
---------
	
			--KEEP SEPARATE NOTES
	SELECT 	'KS' as NoteType,
			EPIC.ef_epic_date_to_date(ks.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ks.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    ks.comments as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        EPIC.ef_offender_id(ks.origin_entity_id) as OriginKSNo,
		    EPIC.ef_get_personororgname(ks.origin_entity_id) as OriginKSName,
		    EPIC.ef_offender_id(ks.separate_entity_id) as SeparateKSNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
		    
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab
	
	WHERE	ab.booking_id = bk.booking_id
			and(bk.entity_id = ks.separate_entity_id
				or
			bk.entity_id = ks.origin_entity_id)
			and EPIC.ef_epic_date_to_date(ks.action_time) >= EPIC.ef_epic_date_to_date(bk.start_date)
			and bk.entity_id = p_InmateID
 -------
UNION ALL
--------				
						
	SELECT	distinct 'PB' as NoteType,  -- M.Zak 8-11-05 added section
   	        EPIC.ef_epic_date_to_date(pi.action_time) as NoteDate,                    -- M.Zak 8-15-05 chgd pb. to pi.
   	        substr(EPIC.ef_epic_date_to_date(pi.action_time),12,5) as NoteTime,      -- M.Zak 8-15-05 chgd pb. to pi.
   	        'PROPERTY BIN    '|| '           BIN #: '||pb.bin_number as NoteTitle,
   	        '' as NoteText1_2,   -- 8-15-05   to save space - created note with just note title (1 line)
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,     
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        EPIC.ef_epic_date_to_date (psoi.action_time) as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        op.entity_id as EntityId
	        

	  FROM  EPICAUDIT.otk_property_bin pb,
            EPICAUDIT.eh_property_item pi,
            EPICAUDIT.eh_offender_property op,
            EPICAUDIT.eh_property_sent_out_item psoi,   -- added M.Zak 8-16-05
            EPIC.EPIC_LOOKUPS el,
			EPIC.eh_booking bk,
			EPIC.eh_active_booking ab

      WHERE	ab.booking_id = bk.booking_id
   			AND bk.entity_id = op.entity_id	
   			AND op.entity_id = p_InmateID
            AND EPIC.ef_epic_date_to_date(pi.ACTION_TIME) >= EPIC.ef_epic_date_to_date(bk.start_date) -- current
            AND pb.bin_id = pi.bin_id
   			AND pi.item_id = op.item_id
   			AND op.item_id = psoi.item_id(+)   -- added M.Zak 8-16-05 
   			AND el.lookup_class = 'PROPERTY TYPE'
   			AND pi.item_name = el.lookup_code 
   			
   			
   			
ORDER BY NoteDate desc;   
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistNoBook
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChgBk_sub.rpt (Sub Report: Part 2 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Added Charge Disposal Date
					R. Stuve	06/02/05		Added charged index number as a sorting field
					R. Stuve	06/07/05		Compiled on OTMAIN 
					R. Stuve	06/24/05		Added (charge)Status field
					R. Stuve	07/19/05		Add P-fields for pay-or-stay sentence lengths; 
												also added FineAmt field
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No, 
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf,epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf,epic.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate, 
		    macomb.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    macomb.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    macomb.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    macomb.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID
			
	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistNoDemo
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChg_Main.rpt (Main Report: Part 1 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created 
					R. Stuve	05/27/05		Changed alias function to pull multiple names
												on one line; replaced address table with functions
												to prevent multiple address records
					R. Stuve	06/07/05		Compiled on OTMAIN    
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION 
					R. Stuve	10/02/06		Reformatted Reviewed Date to correct  
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		   	MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
			
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_HistNoHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ35
	Crystal: 		HistChgHd_sub.rpt (Sub Report: Part 3 of 3)
	Purpose:		Used by Jail Investigation, Classification to list inmate's history
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/17/05		Created
					R. Stuve	06/02/05		Removed Hold Removed Date and displayed active holds only
					R. Stuve	06/07/05		Compiled on OTMAIN   
					DLK         03/20/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemovedDate,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber
			
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID 
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
			
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Housing1
	(curHouse		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
/*	Form Usage: 	CRSTL.YY40
	Crystal: 		housing1.rpt
	Purpose:		Top of Housing report: Summary counts of sentenced/unsentenced inmates by 
					gender and housing type (Holding and General). Bottom of report listed
					as Housing2 includes further detail of inmate type.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/14/05		Add to query2 so title template will display 
					dlk			01/26/05		Add to report tree to test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	04/23/05		Compiled in OTMAIN
	    			DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/
 
BEGIN 
	OPEN curHouse FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Housing' as RptTitle,
				'' as Sex,
				'' as Juvenile,
				'' as Status,
				'' as House,
				'' as ID,
				'' as OverallStatus
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data
		SELECT	DISTINCT  2 as Flag,
				'Housing' as RptTitle,
				decode(p.code_gender, '_NOSP','U', code_gender) as Sex,
				p.juvenile_flag as Juvenile,
				decode(e.code_custody_status,'1','R',
  									'2','F',
  									'3','P',
  									'4','W',
           							'5','WR',
                  					'6', 'KT',
                       				'7', 'AW',
                           			'9', 'GT',
                              		'10', 'ST',
                                	'11', 'JS',
                                 	'12', 'WW',
                                  	'13', 'T',
                                   	'14', 'SCC',
                                    '15', 'LC',
                                    '16', 'OC')  as Status,
           		decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') as House,
           		EPIC.ef_offender_id(b.entity_id) as ID,
           		--decode(c.charge_state, '4', 'S', 'U') as ChgStatus,
           		MACOMB.mcmb_fnt_sentallchgs(b.entity_id) as OverallStatus

		FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b

		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6'
				and m.in_muster_flag = 'Y'
					--above denotes 'on count' status

		ORDER BY Flag, ID;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_housing2
	(curHouse2		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY40
	Crystal: 		housing2.sub.rpt
	Purpose:		Bottom of Housing report: Details inmate demographics for types of Federal,
					Parole, Weekender, and WorkRelease.  Top of report listed as Housing1 and
					includes summary count of sentenced/unsentenced inmates by gender and
					housing type.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	10/14/04		Created
					R. Stuve	12/13/04		Added header information via union query
					R. Stuve	01/24/05		Added in_muster_flag to 'where' clause 
					DLK			01/26/05		Added as part of housing1 to report tree to test
					R. Stuve	04/23/05		Compiled in OTMAIN
                    DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/

 BEGIN

	OPEN curHouse2 FOR
		SELECT 	DISTINCT EPIC.ef_offender_id(b.entity_id) as ID,
				decode(p.code_gender, '_NOSP','U', code_gender) as Sex,
				EPIC.ef_location_name(h.location_id, 'UC') as Cell,
        		EPIC.ef_get_personororgname(b.entity_id) as Name,
        		p.juvenile_flag as Juvenile,
				decode(e.code_custody_status, '2','F',
  											'3','P',
  											'4','W',
           									'5','WR') as Status


		FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b


		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6' 
				and m.in_muster_flag = 'Y'
					--the above denotes 'on count' status
				and (e.code_custody_status in ('2','3','4','5') or p.juvenile_flag = 'Y')

		ORDER BY Status, ID;

END;

--RAS
/

CREATE OR REPLACE
PROCEDURE MACOMB.MCMB_RPT_HOUSING_1 
	(curHouse		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)
IS 
/*
	Purpose:		Top of Housing report: Summary counts of sentenced/unsentenced inmates by 
					gender and housing type (Holding and General). 
	Author:			Kelly Heinz (cloned from mcmb_rpt_Housing1)

	Change Log:		Changed By	Date Modified	Change Made
	----------	-------------	------------------------------------------		
*/
 
BEGIN 
	OPEN curHouse FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Housing' as RptTitle,
				'' as Sex,
				'' as Juvenile,
				'' as Status,
				'' as House,
				'' as ID,
				'' as OverallStatus /*, 
        0 as TotGenMun,
        0 as TotGenMsent,
        0 as TotGenFun, 
        0 as TotGenFsent,
        0 as TotGenOun,
        0 as TotGenOsent, 
        0 as TotHoldMun,
        0 as TotHoldMsent,
        0 as TotHoldFun, 
        0 as TotHoldFsent,
        0 as TotHoldOun,
        0 as TotHoldOsent  --add functions for each of these totals KJH */
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data
		SELECT	DISTINCT  2 as Flag,
				'Housing' as RptTitle,
				mcmb_fnt_gendershort(p.entity_id) as Sex,
				p.juvenile_flag as Juvenile,
				decode(e.code_custody_status,'1','R',
  									'2','F',
  									'3','P',
  									'4','W',
           							'5','WR',
                  					'6', 'KT',
                       				'7', 'AW',
                           			'9', 'GT',
                              		'10', 'ST',
                                	'11', 'JS',
                                 	'12', 'WW',
                                  	'13', 'T',
                                   	'14', 'SCC',
                                    '15', 'LC',
                                    '16', 'OC')  as Status,
           		decode(TO_CHAR(substr(EPIC.ef_location_path_name(h.location_id, 'UC', 5),1,7)), 'BOOKING', 'H', 'G') as House,
           		EPIC.ef_offender_id(b.entity_id) as ID,
           		--decode(c.charge_state, '4', 'S', 'U') as ChgStatus,
           		MACOMB.mcmb_fnt_sentallchgs(b.entity_id) as OverallStatus

		FROM 	EPIC.eh_entity_person p,
				EPIC.eh_entity_status e,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m,
				EPIC.eh_charge c,
				EPIC.eh_booking b

		WHERE	p.entity_id = e.entity_id
				and m.entity_id = p.entity_id
				and p.entity_id = h.entity_id
				and p.entity_id = b.entity_id
				and b.booking_id = c.booking_id
				and c.charge_state <> '6'
				and m.in_muster_flag = 'Y'
					--above denotes 'on count' status

		ORDER BY Flag, ID;
    
END MCMB_RPT_HOUSING_1;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_IncomSentence
 (	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
 
/*	Form Usage: 	CRSTL.YY37
	Crystal: 		incomesentenc.rpt
	Purpose:		To list all inmates with unfilled sentence data and/or charges with a status of 
					'sentenced', but not matching charge state

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/05/05		Created 
					R. Stuve	05/13/05		Added second query to pull back unmatched charges
					R. Stuve	05/24/05		Compiled on OTMAIN
					DLK         03/21/06        ADDED MACOMB AND EPIC NOTATION
*/
 		
		v_date_null		date;               
		--must be same datatype as declarations above so WHERE clause doesn't fail
 			
BEGIN
         
		v_date_null	:= 	null;            
		--set value for variables used in query

	OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Incomplete Sentences' as RptTitle,
				' ' as Inmate#,
				' ' as InmateName,
				' ' as CaseNumber,
				' ' as Charge,
				v_date_null as SentenceStart,
				'' as Title
		
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data
		(SELECT 2 as Flag,
				'Incomplete Sentences' as RptTitle,
				EPIC.ef_offender_id(b.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
				MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Charge,
				EPIC.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				'Incomplete Sentences' as Title
		
		FROM    EPIC.eh_booking b,
				EPIC.eh_sentence s,
				EPIC.eh_charge ch
		
		WHERE	b.booking_id = ch.booking_id
				and s.sentence_id = ch.sentence_id
				and EPIC.ef_epic_date_to_date(s.sentence_end_date) is null
				and ch.charge_state != '6'
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) not like '%PRISON%'

		UNION ALL
				--Charge status of sentenced, but does not have matching charge state
		SELECT 	2 as Flag,
				'Incomplete Sentences' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
				MACOMB.mcmb_fnt_statutetext(ch.charge_id) as Charge,
				v_date_null as SentenceStart,
				'Unmatched Charge Status' as Title
		
		FROM    EPIC.eh_active_booking ab,
				EPIC.eh_charge ch
				
		WHERE	ab.booking_id = ch.booking_id 
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) like '%SENTENCED%'
				and MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) not like '%PRISON%'
				and ch.charge_state != '4'
				and ch.charge_state != '6')

ORDER BY Flag, Title, InmateName;

END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_IncorrSent
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ81
	Crystal: 		IncorrSent.rpt
	Purpose:		Used by the Administration/Booking to find incorrectly entered sentence information
					where staff checked boxes we do not use

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created    
					DLK			05/31/05		Begin Crystal devlp to test 
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/21/06        ADDED MACOMB AND EPIC NOTATION
*/

BEGIN  

  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Incorrect Sentence Info' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as IndSFlg,
				'' as WkEFlg,
				'' as NGTimeFlg,
				'' as MinDFlg,
				'' as LfSnt,
				'' as SntHrs,
				'' as SntWks
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: Incorrect Sentence Info' as RptTitle,
			 	 EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				 EPIC.ef_get_personname_by_bookid(ch.booking_id) as InmateName,
                DECODE(se.indeterminate_flag, 'Y','YES','N', '  ') as IndSFlg,
				DECODE(se.weekender_sentence, 'Y','YES','N', '  ') as WkEFlg,
				DECODE(se.apply_good_time_credit, 'Y','  ','N', 'YES') as NGTimeFlg,
	            DECODE(se.minimum_duration_id,  Null,'  ','YES') as MinDFlg ,
				DECODE(sd.life_sentence,  'N','  ','Y', 'YES') AS	LfSnt ,
				DECODE(sd.hours,  Null,'  ','YES') as SntHrs,
				DECODE(sd.weeks,  Null,'  ','YES') as SntWks

		FROM 	 EPIC.eh_sentence se,
				 EPIC.eh_charge ch,
				 EPIC.eh_active_booking ab,
				 EPIC.eh_sentence_duration sd

		WHERE 	ch.charge_state <> 6
				and ch.sentence_id = se.sentence_id
				and ab.booking_id = ch.booking_id
            	and sd.sentence_duration_id =  se.duration_id
       	 		and (se.indeterminate_flag = 'Y' or se.weekender_sentence = 'Y' or se.apply_good_time_credit = 'N' or sd.life_sentence ='Y' or se.minimum_duration_id is not NULL or sd.weeks is not null or sd.hours is not null)

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InitClass
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor,
	p_StartDate		in			EPIC.eh_booking.start_date%type)

IS

/*	Form Usage: 	CRSTL.ZZ82
	Crystal: 		InitClass.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have more not
					had the Initial Classification form filled out

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created  
					DLK			05/31/05		Crystal devl started for test 
					DLK			06/01/05		Loaded to Report Tree for test
					R. Stuve	06/06/05		Compiled on OTMAIN 
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATIONS
*/

		v_min_date		EPIC.eh_sentence.final_release_date%type;  
     	v_date_from		EPIC.eh_sentence.final_release_date%type;
 		v_date_null		date; 

BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));    
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_null := null;

	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as BookingDate
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
       			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate

		FROM  EPIC.eh_booking bk

		WHERE  EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) = v_min_date

			MINUS

		SELECT 	UNIQUE 2 as Flag,
				'Exception: No Initial Classification' as RptTitle,
				v_date_from as RptStart,
				EPIC.ef_offender_id(efi.entity_id) as InmateNum,
  				EPIC.ef_get_personororgname(efi.entity_id) as InmateName,
      			EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate

		FROM	EPIC.epic_form_instance  efi,
	 			EPIC.eh_booking bk

  		WHERE		efi.entity_id = bk.entity_id
   					and EPIC.ef_epic_date_to_date(EPIC.ef_min_date(bk.start_date)) = v_min_date
   					and EPIC.ef_epic_date_to_date(bk.start_date) <= EPIC.ef_epic_date_to_date(efi.action_time)
   					and efi.form_id = '0EDDMC0100EPI175'

		ORDER BY Flag, BookingDate;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmateCstdyStBookng
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_BookingID		in		epic.eh_booking.booking_id%type)
IS
/*	Form Usage: 	CRSTL.XX42
	Crystal: 		InmateCustodyStat_sub.rpt (Sub Report for: Daily Inmate Status Changes)
	Purpose:		Used by Reimbursement - Lori 
                    Pulls back OT Custody Status grid table per booking id
						
	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak	    9-23-05		Created 
 					J. McBratnie 07/15/07       move to Macomb schema from Production
*/					
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN 

		v_date_null := null;
		--set value for variables used in query
					
 	OPEN vCur FOR
		
	   SELECT	1 as Flag,
				'' as InmateNbr,
				'' as InmateName,
				v_date_null as CS_start_date,
				'' as Custody_Status,			
				v_date_null as CS_end_date
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
	SELECT  2 as Flag,
    	epic.ef_offender_id(bk.entity_id) as InmateNbr,
		mcmb_fnt_Name_Delimited_gvt(bk.entity_id) as InmateName,
		epic.ef_epic_date_to_date(bcs.date_start) as CS_start_date,
		mcmb_fnt_custody_status_desc(bcs.code_custody_status) as Custody_Status,
		epic.ef_epic_date_to_date(bcs.date_end) as CS_end_date

	FROM
    	epic.eh_booking bk,
    	epic.eh_booking_custody_status bcs
	WHERE
  		bk.booking_id = p_BookingID   --'0II4RIO000USJ0UB'
  		and bk.booking_id = bcs.booking_id

	ORDER BY cs_start_date; 
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmateFunds
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY11/CRSTL.YY12 (broken down into +- transactions: Used by Finance)
	Crystal: 		inmatefunds.rpt/inmatefunds_bal_main.rpt
	Purpose:		Used by Aramark/Commissary to list the last transaction for each inmate
					and his/her current available balance (may need to be edited upon Go-Live
					to include non-active inmates)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve/	01/25/05		Created  
                    A. Zdbel
                    dlk			01/26/05		Devl and On tree for Test
                    R. Stuve	01/31/05		Changed 'Union' to 'Union All'
                    R. Stuve	04/23/05		Compiled on OTMAIN 
                    R. Stuve	06/20/05		Added Sort column to sort per Aramark/Commissary's request  
                    DLK			03/21/06		ADDED MACOMB AND EPIC NOTATION
*/                 

v_date_null		date;
			
BEGIN  

v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Inmate Funds' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				0 as CurBal,
				v_date_null as LastTransDate,
				'' as LastTransTime,
				'' as TransType,
				0 as TransAmt,
				0 as Sort
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Inmate Funds' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_cell(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as CurBal,
				EPIC.ef_epic_date_to_date(tat.action_time) as LastTransDate,
				substr(EPIC.ef_epic_date_to_date(tat.action_time),9,8) as LastTransTime,
				tat.description as TransType,
				tat.amount as TransAmt,
		(case	when EPIC.ef_offender_cell(ab.entity_id) like 'DC%' then 1
				when EPIC.ef_offender_cell(ab.entity_id) like 'HC%' then 1
				when EPIC.ef_offender_cell(ab.entity_id) like 'ME%' then 2
				when EPIC.ef_offender_cell(ab.entity_id) like '2A%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2B%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2C%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '3A%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '3B%' then 3
			 	when EPIC.ef_offender_cell(ab.entity_id) like '3C%' then 3
				when EPIC.ef_offender_cell(ab.entity_id) like '2D%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '2E%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '2F%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3D%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3E%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '3F%' then 4
				when EPIC.ef_offender_cell(ab.entity_id) like '4A%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4B%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4C%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5A%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5B%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '5C%' then 5
				when EPIC.ef_offender_cell(ab.entity_id) like '4D%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '4E%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '4F%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5D%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5E%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '5F%' then 6
				when EPIC.ef_offender_cell(ab.entity_id) like '6A%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6B%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6C%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7A%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7B%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '7C%' then 7
				when EPIC.ef_offender_cell(ab.entity_id) like '6D%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '6E%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '6F%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7D%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7E%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '7F%' then 8
				when EPIC.ef_offender_cell(ab.entity_id) like '8A%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8B%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8C%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9A%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9B%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '9C%' then 9
				when EPIC.ef_offender_cell(ab.entity_id) like '8D%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '8E%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '8F%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9D%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9E%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '9F%' then 10
				when EPIC.ef_offender_cell(ab.entity_id) like '10A%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10B%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10C%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11A%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11B%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '11C%' then 11
				when EPIC.ef_offender_cell(ab.entity_id) like '10D%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '10E%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '10F%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11D%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11E%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like '11F%' then 12
				when EPIC.ef_offender_cell(ab.entity_id) like 'R%' then 13
				when EPIC.ef_offender_cell(ab.entity_id) like '1A%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1B%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1C%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like '1D%' then 14
				when EPIC.ef_offender_cell(ab.entity_id) like 'D%' then 15
				when EPIC.ef_offender_cell(ab.entity_id) like 'MH%' then 16
				when EPIC.ef_offender_cell(ab.entity_id) like 'MS%' then 17
				when EPIC.ef_offender_cell(ab.entity_id) like 'X%' then 18
				when EPIC.ef_offender_cell(ab.entity_id) like 'D1%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D2%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D3%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D4%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D5%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'D6%' then 19
				when EPIC.ef_offender_cell(ab.entity_id) like 'WRIT%' then 20
				else 21 end) as Sort


		FROM   	EPIC.eh_active_booking ab,
				EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	ab.entity_id = t.entity_id
				and t.trust_account_id = tat.trust_account_id
				and tat.transaction_number =
					(SELECT MAX(tat2.transaction_number)
   					FROM EPIC.eh_trust_account_trans tat2
   					WHERE tat2.trust_account_id = t.trust_account_id)

ORDER BY Flag, Sort, Cell, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJdgCount_CRE
	(vCur        out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJdgCounts_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.  This reports displays Judge Name, Court, #Bed count(Inmates in Jail)
                    --A sentence that has a FINE amount thus giving us everyone sent to a fine
                    --then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned 
                    --list will only have inmates with the charge that they are here on that only requires a fine to get out of jail 
                    -- any minimual jail time has been taken care of.


	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      11-21-05       Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80)
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Count of Inmates By Court/Judge' as RptTitle,
				'' as Judge,
                '' as CourtType,
                '' as CourtName,
                '' as Court,
                '' as InmateNum
                    		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Count of Inmates By Court/Judge' as RptTitle,
      			epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,
      			el.sub_1 as CourtType,
      			el.sub_4 as CourtName,
                mcmb_fnt_CourtName(ch.charge_id) as Court,    
                epic.ef_offender_id(ab.entity_id) as InmateNum
             

		FROM   	epic.eh_booking bk,
				epic.eh_active_booking ab,
				epic.eh_charge ch,
				epic.eh_sentence s,
				epic.eh_sentence_duration sd,
				epic.eh_sentence_out_dates so,
				epic.eh_release r,
				epic.epic_lookups el

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6' 
				and (el.lookup_class = 'JUDGE NAME' 
				and el.lookup_code = mcmb_fnt_JudgeName_chargeid(ch.charge_id) and el.sub_2 <> '-AX')
         
order by Flag, CourtType, CourtName, Judge;

END;

/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJdgPorS_CRE
	(vJudgeName  in         epic.eh_generic_attribute.attribute_name%type, 
	 vCur        out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJudgePorS_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.  
                    A sentence that has a FINE amount thus giving us everyone sent to a fine
                    then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned 
                    list will only have inmates with the charge that they are here on that only requires a fine to get out of jail 
                    --any minimual jail time has been taken care of.


	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      11-21-05       Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80)
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge - Pay or Stay' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
		        '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge - Pay or Stay' as RptTitle,
		      	epic.ef_offender_id(ab.entity_id) as InmateNum,
		        epic.ef_get_personororgname(ab.entity_id) as InmateName,
		        epic.ef_offender_SecClass(ab.entity_id) as Classification,
      			epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                epic.ef_epic_date_to_date(bk.start_date) as BookingDt,
                epic.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --epic.ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,  -- removed 11-1-05
		        epic.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                epic.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        epic.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
		        mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz 11/2/05 Meeting w/Judge Viviano       

		FROM   	epic.eh_booking bk,
				epic.eh_active_booking ab,
				epic.eh_charge ch,
				epic.eh_sentence s,
				epic.eh_sentence_duration sd,
				epic.eh_sentence_out_dates so, 
				epic.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id     
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'  
				and ((vJudgeName != 'ALL' and (epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = ' ' || vJudgeName
				                              or epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName))
				or vJudgeName = 'ALL')   -- added 11-23-05 for ALL selection
				and mcmb_fnt_FineAmount(ch.sentence_id) > 0      -- added 11-21-05
                and  to_date(substr(sysdate,1,10)) >= to_date (substr(epic.ef_epic_date_to_date(so.paid_out_date),1,10)) -- added 11-21-05
                --- above last 2 lines of code - per Glenn looks only for a sentence that has a FINE amount thus giving us everyone sent to a fine
                --- then it returns only the ones who 1st part of the sentence is the date ran or less then so the returned list will only have
                --- inmates with the charge that they are here on that only requires a fine to get out of jail - any minimual jail time has been taken care of
	            
order by Flag, JUDGE, InmateName;

END;

/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJudge
 (vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY80
	Crystal: 		InmatesByJudge.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info

	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      09/16/05        Created         
					M. Zak      11-4-05         Added sentence to prisoner inmates(11/2/05 Meeting w/Judge Viviano)   
					DLK			03/21/06		ADDED MACOMB AND EPIC NOTATIONS
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
   	            '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
                MACOMB.mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz chgd 11-4-05 (11/2/05 Meeting w/Judge Viviano)                

		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so, 
				EPIC.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'
	            --and mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'   -- MAZ removed 11-04-05 display sent to prisoner inmate charges (11/2/05 Meeting w/Judge Viviano)
	            
order by Flag, JUDGE, InmateName;

END;


/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJudge_BO_Crt
    (vCourtName  in         EPIC.eh_generic_attribute.attribute_name%type, 
   	 vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)
IS

/*	Form Usage: 	
	Crystal: 		InmatesByJudge_BO_Crt.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info. 
					Report is the same as  InmatesByJudge_CRE.rpt except we now want to send ea court (by subject) a listing by email
					to sheriff gw acct and then have it forwarded to the judges (less pages to read -- replace 'ALL' concept)

	Author:			Mary Ann Zak 
	          	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					M. Zak        09/18/07        Created for CE/BO - orig rpt InmatesByJudge_CRE 
					M.Zak         1-28-08         Per Judge Switalski combine courts (41-A = Shelby and Sterling Heights; 42 = Romeo and New Baltimore)

*/                  

	v_date_null date; 
	v_CourtNm varchar(200);

BEGIN 

	v_date_null := null; 
 	v_CourtNm :=  concat(vCourtName,'%');   -- 1-28-08 MAZ
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Court/Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,  
 	            '' as CourtType,             
				'' as CourtName, 
				'' as Court,    
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
		        '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Court/Judge' as RptTitle,
		      	EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		        EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
		        EPIC.ef_offender_SecClass(ab.entity_id) as Classification,
      			EPIC.ef_lookup_text('JUDGE NAME',MACOMB.mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,  
      			EPIC.el.sub_1 as CourtType, 
      			EPIC.el.sub_4 as CourtName,     
       			MACOMB.mcmb_fnt_CourtName(ch.charge_id) as Court,	
      			MACOMB.mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                MACOMB.mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                EPIC.ef_epic_date_to_date(bk.start_date) as BookingDt,
                EPIC.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(MACOMB.mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from EPIC.eh_sentence_fine sf,EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  
                EPIC.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,
		        EPIC.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,
                MACOMB.mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(MACOMB.mcmb_fnt_BailAmount(ch.charge_id)) as Bail,
		        to_number(MACOMB.mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
		        MACOMB.mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    


		FROM   	EPIC.eh_booking bk,
				EPIC.eh_active_booking ab,
				EPIC.eh_charge ch,
				EPIC.eh_sentence s,
				EPIC.eh_sentence_duration sd,
				EPIC.eh_sentence_out_dates so,
				EPIC.eh_release r,
                EPIC.epic_lookups el

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'
				and (el.lookup_class = 'JUDGE NAME'
				     -- and el.sub_4 = vCourtName  --'FAMILY'  -- removed 1-28-08 replaced with line below 
				   	 and el.sub_4  like v_CourtNm --  1-28-08 MAZ
				     and el.lookup_code = macomb.mcmb_fnt_JudgeName_chargeid(ch.charge_id)
				     and el.sub_2 <> '-AX')
			
order by Flag, CourtName, JUDGE, InmateName;   
end;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJudge_CRE
	(vJudgeName  in         epic.eh_generic_attribute.attribute_name%type, 
	 vCur        out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	
	Crystal: 		InmatesByJudge_CRE.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info.

	Author:			Mary Ann Zak 
	                Received Query from Glenn.
	
	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					M. Zak        11/02/05        Created for CRE - orig rpt InmatesByJudge (Offendertrak YY80)   
					M. Zak        12/01/05        added ALL  
					D. Kuykendall 01/12/06		  added logic to return Court Name for calulation of totals
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                  

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,               
				'' as CourtName, --011206 dlk
				'' as Court,     --011206 dlk
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt,
		        '' as SenttoPrisonChrg
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	epic.ef_offender_id(ab.entity_id) as InmateNum,
		        epic.ef_get_personororgname(ab.entity_id) as InmateName,
		        epic.ef_offender_SecClass(ab.entity_id) as Classification,
      			epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge, 
      			el.sub_4 as CourtName,     --011206 dlk
      			mcmb_fnt_CourtName(ch.charge_id) as Court,	--011206 dlk			
      			mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                epic.ef_epic_date_to_date(bk.start_date) as BookingDt,
                epic.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from epic.eh_sentence_fine sf,epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,  -- removed 11-1-05
		        epic.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                epic.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        epic.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt,
		        mcmb_fnt_SenttoPrison_Chrg(ch.charge_id) as SenttoPrisonChrg    -- maz 11/2/05 Meeting w/Judge Viviano       

		FROM   	epic.eh_booking bk,
				epic.eh_active_booking ab,
				epic.eh_charge ch,
				epic.eh_sentence s,
				epic.eh_sentence_duration sd,
				epic.eh_sentence_out_dates so, 
				epic.eh_release r,
                epic.epic_lookups el
                
		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id     
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'  
				--and epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName  
				-- **** commented out above line - CR could not handle ' ' as parameter so had to force it with concatenation 	 
				and ((vJudgeName != 'ALL' and (epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = ' ' || vJudgeName
				                           or epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') = vJudgeName))
				or vJudgeName = 'ALL')   -- added 12-01-05 for ALL selection
				  			
	            --and mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'  -- 11/2/05 Meeting w/Judge Viviano show all charges w/ indicator of Sent to Prison
	            and (el.lookup_class = 'JUDGE NAME' and el.lookup_code = mcmb_fnt_JudgeName_chargeid(ch.charge_id) and el.sub_2 <> '-AX')   --011206  dlk
	            
order by Flag, CourtName, JUDGE, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_InmatesByJudge_ORG
	(vCur 	out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY80
	Crystal: 		InmatesByJudge.rpt
	Purpose:		Used to provide information to the courts to help ease the over-crowding issues
					all inmates chrgs and all sent info

	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak      09/16/05        Created
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

	v_date_null date;

BEGIN 

	v_date_null := null; 
	
OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Inmates By Judge' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Classification,
				'' as Judge,
				'' as CaseNum,
				'' as StatCls,
				'' as Charge,
				v_date_null as BookingDt,
			    v_date_null as ChrgDt,                                  
				'' as PA325,
                '' as Sentence,
	           	0 as SentYears,
				0 as SentMths,
				0 as SentDays,
				0 as PSentYears,
				0 as PSentMonths,
				0 as PSentDays,
				v_date_null as SentenceEndDate,
	            v_date_null as EarOutDate, 
		        v_date_null as MaxOutDate,
		        '' as Holds,
		        0 as Bail,
		        0 as FineAmt
		        
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
	        	'Inmates By Judge' as RptTitle,
		      	epic.ef_offender_id(ab.entity_id) as InmateNum,
		        epic.ef_get_personororgname(ab.entity_id) as InmateName,
		        epic.ef_offender_SecClass(ab.entity_id) as Classification,
      			epic.ef_lookup_text('JUDGE NAME',mcmb_fnt_JudgeName_chargeid(ch.charge_id),'UC') as Judge,				
      			mcmb_fnt_CaseNumber (Ch.charge_id) as CaseNum,
		        ch.statute_class as StatCls,
                mcmb_fnt_chargedesc (ch.statute_id) as Charge,
                epic.ef_epic_date_to_date(bk.start_date) as BookingDt,
                epic.ef_epic_date_to_date(ch.offense_date) as ChrgDt,
                decode(mcmb_fnt_StatuteCategory(ch.charge_id), 'PA325','Y',' ')as pa325,
                decode(ch.charge_state, '4', 'Yes','No') as Sentence,
                sd.years as SentYears,
		   	    sd.months as SentMths,
		        sd.days as SentDays,
		   	    (select sd.years from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	    (select sd.months from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		        (select sd.days from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		        --ef_epic_date_to_date(bk.final_RELEASE_DATE) as SentenceEndDate,
		        epic.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,  -- maz 11-1-05 4:30pm
                epic.ef_epic_date_to_date(so.paid_out_date) as EarOutDate,   
		        epic.ef_epic_date_to_date(so.unpaid_out_date) as MaxOutDate,  
                mcmb_fnt_Holds (ab.entity_id) as Holds,
                to_number(mcmb_fnt_BailAmount(ch.charge_id)) as Bail,     
		        to_number(mcmb_fnt_FineAmount(s.sentence_id)) as FineAmt          

		FROM   	epic.eh_booking bk,
				epic.eh_active_booking ab,
				epic.eh_charge ch,
				epic.eh_sentence s,
				epic.eh_sentence_duration sd,
				epic.eh_sentence_out_dates so, 
				epic.eh_release r

		WHERE 	ab.booking_id = bk.booking_id
				and bk.booking_id = ch.booking_id
				and ch.sentence_id = s.sentence_id (+)
				and s.sentence_id = so.sentence_id (+)  
				and s.duration_id = sd.sentence_duration_id (+)
				and bk.booking_id = r.booking_id (+)
				and ch.charge_state <> '6'
	            and mcmb_fnt_SenttoPrison(bk.booking_id) <> 'P'
	            
order by Flag, JUDGE;

END;

/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JailPopByCity
		(	curRest			OUT		epic.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.YY75
	Crystal: 		jailpopbycity.rpt
	Purpose:		Lists Jail Inmates by City in Alpha order

	Author:			Diana Kuykendall

	Change Log:		Changed By	   Date Modified	Change Made
					----------	   -------------	------------------------------------------
					D.Kuykendall   12/01/06		    Created 
					D. Kuykendall  12/28/05			uploaded to OTMain for test on content and design by client	
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
    
	v_date_null		date;

 BEGIN
        
 	v_date_null := null;
 	
	OPEN curRest FOR
         SELECT	1 as Flag,
				'Jail Population by City' as RptTitle,				
				' ' as InmateNumber,
		        ' ' as InmateName,
		        ' ' as Address,
		        ' ' as City,
		        ' ' as State,
		        ' ' as Zip

		
		FROM	dual
		
		UNION ALL		
		
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Jail Population by City' as RptTitle,
				epic.ef_offender_id(ep.entity_id) as InmateNumber,
		        epic.ef_get_personororgname(ep.entity_id) as InmateName,
		        --mcmb_fnt_address_numstr_dlk(ep.entity_id) as Address,
		  		mcmb_fnt_address_numstr(ep.entity_id) as Address,
		        --mcmb_fnt_address_city_dlk(ep.entity_id) as City,
		        mcmb_fnt_address_city(ep.entity_id) as City,
		        --mcmb_fnt_address_state_dlk(ep.entity_id) as State,
		        mcmb_fnt_address_state(ep.entity_id) as State,
		        --mcmb_fnt_address_postal_dlk(ep.entity_id) as Zip
                mcmb_fnt_address_postal(ep.entity_id) as Zip

		FROM	epic.eh_active_booking ab,
				epic.eh_person_identity epi,
				epic.eh_entity_person ep
		
		WHERE 	ep.entity_id = ab.entity_id
				and epi.entity_id = ab.entity_id
				and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'

		ORDER BY City, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JailReimb
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_trans_distribution.action_time%type,  
	 	p_EndDate       in         	EPIC.eh_trans_distribution.action_time%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX51
	Crystal: 		jailreimb.rpt
	Purpose:		Used by Reimbursement to list medical expenses/payments for inmates
					during the specified time.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	02/01/05		Created  
					DLK			021105			added to tree to test  
					R. Stuve	05/28/05		Compiled on OTMAIN 
					R. Stuve	06/21/05		Removed link to booking table to prevent duplicate records   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
					
*/
        v_min_date		EPIC.eh_trans_distribution.action_time%type;  
		v_max_date		EPIC.eh_trans_distribution.action_time%type;  
     	v_date_from		EPIC.eh_trans_distribution.action_time%type;
 		v_date_to		EPIC.eh_trans_distribution.action_time%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Activity from Jail Reimbursement' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Description,
				0 as Amount,
				v_date_null as TDate,
				'' as Reversal
				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data 
(
	(
--Medical Fees Charged (510 Expense Account)
	SELECT	2 as Flag,
			'Activity from Jail Reimbursement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(t.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(t.entity_id) as InmateName,
			tat.description as Description,
			tat.amount as Amount,
			EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
			tat.reverse_flag as Reversal

	FROM	EPIC.eh_trust_account t,
			EPIC.eh_trust_account_trans tat

	WHERE	t.trust_account_id = tat.trust_account_id
			and tat.code_source_of_funds = '510'
			and EPIC.ef_epic_date_to_date(tat.trans_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(tat.trans_date) <= v_max_date
	)

UNION ALL

	(
--Medical Fees Paid (110 Cash Account)
	SELECT	2 as Flag,
			'Activity from Jail Reimbursement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(t.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(t.entity_id) as InmateName,
			concat('PAYMENT: ',d.description) as Description,
			(d.amount) * -1 as Amount,
			EPIC.ef_epic_date_to_date(d.action_time) as TDate,
			'' as Reversal

	FROM	EPIC.eh_trust_account t,
			EPIC.eh_trans_distribution d


	WHERE	t.trust_account_id = d.trust_account_id
			and d.gl_account_number = '110'
      and exists ( select 1 from EPIC.eh_trans_distribution d2
                   where d2.trust_account_trans_id = d.trust_account_trans_id  
                   and d2.gl_account_number = '510')
			and EPIC.ef_epic_date_to_date(d.action_time) >= v_min_date
			and EPIC.ef_epic_date_to_date(d.action_time) <= v_max_date
	)
union all
	(
                SELECT  2 as Flag,
                    'Activity from Jail Reimbursement' as RptTitle,
                    v_date_from as RptStart,
                    v_date_to as RptEnd,
                    EPIC.ef_offender_id(t.entity_id) as InmateNum,
                    EPIC.ef_get_personororgname(t.entity_id) as InmateName,
                    concat('PAYMENT: ',d.description) as Description,
                    d.amount as Amount,
                    EPIC.ef_epic_date_to_date(d.action_time) as TDate,
                    '' as Reversal
                FROM   EPIC.eh_trust_account t, EPIC.eh_trans_distribution d, epic.otk_payable_pay p
                WHERE t.trust_account_id = d.trust_account_id
                    and p.facility_id = t.facility_id
                    and p.expense_account = '510'
                    and p.payable_account = d.gl_account_number
                    and not exists ( select 1 from EPIC.eh_trans_distribution d2
                                 where d2.trust_account_trans_id = d.trust_account_trans_id  
                                 and d2.gl_account_number = '510')
                    and EPIC.ef_epic_date_to_date(d.action_time) >= v_min_date
                    and EPIC.ef_epic_date_to_date(d.action_time) <= v_max_date
	)
)

ORDER BY Flag, TDate, InmateNum;

END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSBooking
(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN   
					dlk         03/22/06        added macomb and epic notation
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,1,1) as Sort1,
		substr(Cell,3,2) as Sort2
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
  		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
   		and temporary_location_flag = 'N'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
)
GROUP BY Cell
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--inserts a blank cell for layout purposes
SELECT	'BLANK' as Cell,
		0 as CellCnt,
		0 as GrandTotal,
		'E' as Sort1,
		'BLANK' as Sort2
FROM	dual
-----
UNION ALL
------
--this portion pulls the Grand Total for Holding Cells for the area (from the above query)
SELECT  'HCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'A' as Sort1,
		'22' as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
  		and temporary_location_flag = 'N'
 	)
)
-------
UNION ALL
---------
--this portion pulls the Grand Total for Detox Cells for the area (from the above query)
SELECT  'DCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'D' as Sort1,
		'03' as Sort2
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
   			and EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort1 desc, Sort2;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSBotSummary
	(vCur 	out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run.  This code is for the final summary at the bottom of the JCS report.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/02/05		Created 
					R. Stuve	06/06/05		Compiled on OTMAIN
	    
*/

BEGIN
	 OPEN vCur FOR	
	SELECT	'PAROLEE' as InmateType,
		count(ha.entity_id) as Count,
		1 as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '3'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEDERAL' as InmateType,
		count(ha.entity_id) as Count,
		2 as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '2'
		and ha.temporary_location_flag = 'N'
---------
UNION ALL
---------

SELECT	'OTHER' as InmateType,
		count(ha.entity_id) as Count,
		3 as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status in ('14','15','16')
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'TOTAL CONTRACT INMATES' as InmateType,
		0 as Count,
		4 as Sort

FROM	dual

---------
UNION ALL
---------

SELECT	'WORK RELEASE' as InmateType,
		count(ha.entity_id) as Count,
		5 as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '5'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		6 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'JUVENILES' as InmateType,
		count(ha.entity_id) as Count,
		7 as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_person p

WHERE	ha.entity_id = p.entity_id
		and p.juvenile_flag = 'Y'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'MEDICAL HOSP' as InmateType,
		count(ha.entity_id) as Count,
		8 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) like 'HOSPITALS%'
		and epic.ef_location_path_name(location_id,'UC',6) not like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'PSYCH HOSP' as InmateType,
		count(ha.entity_id) as Count,
		9 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'WRIT' as InmateType,
		count(ha.entity_id) as Count,
		10 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) = 'WRIT'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		11 as Sort

FROM 	dual

---------
UNION ALL
---------
SELECT	'BLANK' as InmateType,
		0 as Count,
		12 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'MALE' as InmateType,
		count(ha.entity_id) as Count,
		13 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'M'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEMALE' as InmateType,
		count(ha.entity_id) as Count,
		14 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'F'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'UNKNOWN-HIDE' as InmateType,
		count(ha.entity_id) as Count,
		15 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'U'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'TOTAL INMATES' as InmateType,
		0 as Count,
		16 as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'UNKNOWN' as InmateType,
		count(ha.entity_id) as Count,
		17 as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'U'
		and ha.temporary_location_flag = 'N'

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSDBlock
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN 
					dlk         03/22/06        added macomb and epic notation
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,2,2) as Sort,
		decode(Cell,'D1PC','01','D2PC','02','D3PC','03','D4PC','04','D5PC','05','D6PC','06') as Sort2
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(ha.entity_id) as Cnt,
		EPIC.ef_location_name(ha.location_id, 'UC') as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE	(EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%LOW D%'
			or EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%UPPER D%') 
		and ha.temporary_location_flag = 'N'	
GROUP BY  EPIC.ef_location_name(ha.location_id, 'UC')
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		EPIC.ef_location_path_name(el.location_id,'UC',7) as Cell
FROM	EPIC.epic_locations el
WHERE	(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%LOW D%'
		 	or EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%UPPER D%')
		and EPIC.ef_location_path_name(EPIC.el.location_id,'UC',7) is not null
GROUP BY EPIC.ef_location_path_name(EPIC.el.location_id,'UC',7)
----------------------------------------------
)
GROUP BY Cell

-----
UNION ALL
------
--this portion pulls the Grand Total for Low D cells (D1PC-D6PC)
SELECT 	'LowDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'7P' as Sort,
		'07' as Sort2
FROM
(
SELECT	sum(Cnt)as CellCnt
FROM
	(SELECT count(ha.entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'LOW D,%'
			and ha.temporary_location_flag = 'N'
	)
)

-------
UNION ALL
---------
--this portion pulls the Grand Total for Upper D cells (D07-D12)
SELECT  'UpperDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'13' as Sort,
		'' as Sort2
FROM
(
SELECT	sum(Cnt)as CellCnt
FROM
	(SELECT count(ha.entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'UPPER D,%'
			and ha.temporary_location_flag = 'N'
	)
)
ORDER BY Sort2, Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSMS
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,3,2) as Sort
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(ha.entity_id) as Cnt,
  		substr(EPIC.ef_location_path_name(ha.location_id, 'UC',6),1,4) as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%MAX%'
		and ha.temporary_location_flag = 'N'
GROUP BY  	substr(EPIC.ef_location_path_name(ha.location_id, 'UC', 6),1,4) 
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		substr(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',6),1,4) as Cell
FROM 	EPIC.epic_locations el
WHERE	EPIC.ef_location_path_name(EPIC.el.location_id,'UC',5) like '%MAX%'
		and housing_flag = 'Y'
GROUP BY  substr(EPIC.ef_location_path_name(EPIC.el.location_id,'UC',6),1,4)
----------------------------------------------
)
GROUP BY Cell

-----
UNION ALL
------
--this portion pulls the Grand Total for cell groups MS01-MS06 (from the above query)
SELECT 	'MS01-06Total' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'066' as Sort
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',6),1,4) in ('MS01','MS02','MS03','MS04','MS05','MS06')
			and temporary_location_flag = 'N'
	)
)

-------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups MS07-MS12 (from the above query)
SELECT  'MS07-MS12Total' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'13' as Sort
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',6),1,4) in ('MS07','MS08','MS09','MS10','MS11','MS12') 
			and temporary_location_flag = 'N'
	)
)
ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSStation23
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN    
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
		SUM(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,1,1) as Sort

FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
  		substr(EPIC.ef_location_name(location_id, 'UC'),1,2) as Cell
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%STATION%' 
		and temporary_location_flag = 'N'
GROUP BY  substr(EPIC.ef_location_name(location_id, 'UC'),1,2)
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		substr(EPIC.ef_location_name(location_id, 'UC'),1,2) as Cell
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%STATION%'
		and EPIC.ef_location_path_name(location_id, 'UC',7) is not null
GROUP BY  substr(EPIC.ef_location_name(location_id, 'UC'),1,2)
----------------------------------------------
)
GROUP BY Cell


-----
UNION ALL
------
--this portion pulls the Grand Total for cell groups 1A-1D (from the above query)
SELECT  '1A-1DTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'1' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like 'STATION 2,%'
			and temporary_location_flag = 'N'
	)

)

-------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups RA-RD (from the above query)
SELECT  'RA-RDTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'R' as Sort
FROM
(
SELECT	SUM(Cnt)as CellCnt
FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like 'STATION 3,%'
			and temporary_location_flag = 'N'
	)
)
ORDER BY Sort, GrandTotal;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSSummary
	(vCur 	out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/02/05		Created   
					R. Stuve	06/06/05		Compiled on OTMAIN 
					R. Stuve	07/21/07		Added High Observation cells per SRF 13525
					M Zak       01-10-09        Changed Verbiage "GENERAL USE BEDSPACE" to "GENERAL POPULATION BEDSPACE"
	    
*/

LocTitle    varchar2(30);
BEGIN
	 OPEN vCur FOR	
		  SELECT	LocTitle,
		to_number(RDC) as RDC,
		to_number(Count) as Count,
		(RDC - Count) as Var,
		Sort
FROM
(
SELECT	'TOWER 2/3' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Tower 2/3%') as RDC,
		count(ha.entity_id) as Count,
		1 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 3%'

--------
UNION ALL
--------

SELECT	'TOWER 4/5' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Tower 4/5%') as RDC,
		count(ha.entity_id) as Count,
		2 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 5%'


--------
UNION ALL
--------

SELECT	'TOWER 6/7' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Tower 6/7%') as RDC,
		count(ha.entity_id) as Count,
		3 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 7%'

--------
UNION ALL
--------

SELECT	'TOWER 8/9' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Tower 8/9%') as RDC,
		count(ha.entity_id) as Count,
		4 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 9%'

--------
UNION ALL
--------

SELECT	'TOWER 10/11' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Tower 10/11%') as RDC,
		count(ha.entity_id) as Count,
		5 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'TWR11%'

--------
UNION ALL
--------

SELECT	'MAX SECURITY 1' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Max Security 1%') as RDC,
		count(ha.entity_id) as Count,
		6 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 1%'


--------
UNION ALL
--------

SELECT	'MAX SECURITY 2' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Max Security 2%') as RDC,
		count(ha.entity_id) as Count,
		7 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 2%'

--------
UNION ALL
--------

SELECT	'STATION 2 1A-1D' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Minimum Security 1A-1D%') as RDC,
		count(ha.entity_id) as Count,
		8 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 2%'


--------
UNION ALL
--------

SELECT	'STATION 3 2A-2D' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Minimum Security 2A-2D%') as RDC,
		count(ha.entity_id) as Count,
		9 as Sort

FROM epic.eh_housing_assignments ha

WHERE epic.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 3%'

--------
UNION ALL
--------

SELECT	'D01-D06' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('D-Block: D01-D06%') as RDC,
		count(ha.entity_id) as Count,
		10 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MED CONTRL, LOW D%'

--------
UNION ALL
--------

SELECT	'D07-D12' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('D-Block: D07-D12%') as RDC,
		count(ha.entity_id) as Count,
		11 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MH CONTRL, UPPER D%'

--------
UNION ALL
--------

SELECT	'MH1-17' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('MH1-17%') as RDC,
		count(ha.entity_id) as Count,
		12 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, LOW%'


--------
UNION ALL
--------

SELECT	'MH18-24' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('MH18-24%') as RDC,
		count(ha.entity_id) as Count,
		13 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, HIGH%'


--------
UNION ALL
--------

SELECT	'BOOKING A-C' as LocTitle,
		to_char(to_number(macomb.mcmb_fnt_RDCCapacity_Location('Booking A%')) + to_number(mcmb_fnt_RDCCapacity_Location('Booking B%')) + to_number(macomb.mcmb_fnt_RDCCapacity_Location('Booking C%'))) as RDC,
		count(ha.entity_id) as Count,
		14 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) in ('BOOKING, A','BOOKING, B','BOOKING, C')

--------
UNION ALL
--------

SELECT	'ANNEX-A' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Annex A%') as RDC,
		count(ha.entity_id) as Count,
		15 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, A'

--------
UNION ALL
--------

SELECT	'ANNEX-B' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Annex B%') as RDC,
		count(ha.entity_id) as Count,
		16 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, B'

--------
UNION ALL
--------

SELECT	'BREAK' as LocTitle,
		'0' as RDC,
		0 as Count,
		17 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'RATED DESIGN CAPACITY' as LocTitle,
		'0' as RDC,
		0 as Count,
		18 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'BOOKING HOLDING CELLS' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Booking Holding Cells%') as RDC,
		count(ha.entity_id) as Count,
		19 as Sort

FROM epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(ha.location_id,'UC',6) like 'HOLDING%'

--------
UNION ALL
--------

SELECT	'MEDICAL UNIT' as LocTitle,
		macomb.mcmb_fnt_RDCCapacity_Location('Medical Unit%') as RDC,
		count(ha.entity_id) as Count,
		20 as Sort

FROM epic.eh_housing_assignments ha

WHERE substr(epic.ef_location_path_name(location_id,'UC',5),1,instr(epic.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'MED CONTRL, MEDICAL'

/*RAS: Added High Observation on July 21, 2007 per SRF 13525 */
--------
UNION ALL
--------

SELECT	'HIGH OBS HOLDING' as LocTitle,
		MACOMB.mcmb_fnt_RDCCapacity_Location('High Obs Holding%') as RDC,
		count(ha.entity_id) as Count,
		21 as Sort

FROM EPIC.eh_housing_assignments ha

WHERE substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'MH CONTRL, HI OBS HOLDING'

--------
UNION ALL
--------

SELECT	'TOTAL BEDS' as LocTitle,
		'0' as RDC,
		0 as Count,
		22 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'GENERAL POPULATION BEDSPACE' as LocTitle,
		'0' as RDC,
		0 as Count,
		23 as Sort

FROM	dual

--------
UNION ALL
--------

SELECT	'BREAK' as LocTitle,
		'0' as RDC,
		0 as Count,
		24 as Sort

FROM	dual
)

GROUP BY LocTitle, RDC, Count, Sort

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower
	(vCur 	out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					J. McBratnie 07/15/07       move to Macomb schema from Production
	    
*/

BEGIN
  OPEN vCur FOR	
--2/3: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		2 as Sort2
FROM
(
----------------------------------------------
--2/3: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.eh_housing_assignments
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--2/3: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.epic_locations
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups A-C
SELECT 	'2/3: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		2 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('2A','3A','2B','3B','2C','3C')
	)
)

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups D-F
SELECT 	'2/3: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		2 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('2D','3D','2E','3E','2F','3F')
	)
)

------
UNION ALL
------
--4/5: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		4 as Sort2
FROM
(
----------------------------------------------
--4/5: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.eh_housing_assignments
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--4/5: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.epic_locations
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups A-C
SELECT 	'4/5: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		4 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('4A','5A','4B','5B','4C','5C')
	)
)

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups D-F
SELECT 	'4/5: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		4 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('4D','5D','4E','5E','4F','5F')
	)
)

--------
UNION ALL
--------

--6/7: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		6 as Sort2
FROM
(
----------------------------------------------
--6/7: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.eh_housing_assignments
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--6/7: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.epic_locations
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups A-C
SELECT 	'6/7: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		6 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('6A','7A','6B','7B','6C','7C')
	)
)

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups D-F
SELECT 	'6/7: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		6 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('6D','7D','6E','7E','6F','7F')
	)
)

--------
UNION ALL
--------
--8/9: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		8 as Sort2
FROM
(
----------------------------------------------
--8/9: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.eh_housing_assignments
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--8/9: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.epic_locations
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups A-C
SELECT 	'8/9: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		8 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('8A','9A','8B','9B','8C','9C')
	)
)

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups D-F
SELECT 	'8/9: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		8 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,2) in ('8D','9D','8E','9E','8F','9F')
	)
)

-------
UNION ALL
-------
--10/11: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort,
		10 as Sort2
FROM
(
----------------------------------------------
--10/11: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(epic.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
      	substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.eh_housing_assignments
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--10/11: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(epic.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
        substr(epic.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	epic.epic_locations
WHERE	epic.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and epic.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(epic.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(epic.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups A-C
SELECT 	'10/11: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort,
		10 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,3) in ('10A','11A','10B','11B','10C','11C')
	)
)

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups D-F
SELECT 	'10/11: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort,
		10 as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	epic.eh_housing_assignments
	WHERE	substr(epic.ef_location_path_name(location_id,'UC',8),1,3) in ('10D','11D','10E','11E','10F','11F')
	)
)

ORDER BY Sort2, Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower1011
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created 
					R. Stuve	06/06/05		Compiled on OTMAIN  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--10/11: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--10/11: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--10/11: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups A-C
SELECT 	'10/11: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10A','11A','10B','11B','10C','11C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--10/11: this portion pulls the Grand Total for cell groups D-F
SELECT 	'10/11: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) in ('10D','11D','10E','11E','10F','11F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower23
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--2/3: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--2/3: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--2/3: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups A-C
SELECT 	'2/3: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2A','3A','2B','3B','2C','3C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--2/3: this portion pulls the Grand Total for cell groups D-F
SELECT 	'2/3: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('2D','3D','2E','3E','2F','3F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower45
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN  
					DLK			03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--4/5: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--4/5: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--4/5: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups A-C
SELECT 	'4/5: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4A','5A','4B','5B','4C','5C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--4/5: this portion pulls the Grand Total for cell groups D-F
SELECT 	'4/5: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('4D','5D','4E','5E','4F','5F')   
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower67
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created  
					R. Stuve	06/06/05		Compiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
	    
*/

BEGIN
  OPEN vCur FOR	
--6/7: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--6/7: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--6/7: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups A-C
SELECT 	'6/7: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6A','7A','6B','7B','6C','7C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--6/7: this portion pulls the Grand Total for cell groups D-F
SELECT 	'6/7: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('6D','7D','6E','7E','6F','7F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_JCSTower89
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ12
	Crystal: 		*****.rpt
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/26/05		Created
					R. Stuve	06/06/05		Compiled on OTMAIN
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
	    
*/

BEGIN
  OPEN vCur FOR	
--8/9: this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)) as Capacity,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		Sort
FROM
(
----------------------------------------------
--8/9: the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
      	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.eh_housing_assignments
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null
		and temporary_location_flag = 'N'
GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
UNION ALL
----------------------------------------------
--8/9: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
	 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
		and EPIC.ef_location_path_name(location_id,'UC',8) is not null

GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
----------------------------------------------
)
GROUP BY Cell, Sort

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups A-C
SELECT 	'8/9: A-CTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'CC' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8A','9A','8B','9B','8C','9C')
			and temporary_location_flag = 'N'
	)
)

-----
UNION ALL
------
--8/9: this portion pulls the Grand Total for cell groups D-F
SELECT 	'8/9: D-FTotal' as Cell,
		0 as Capacity,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'FF' as Sort
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) in ('8D','9D','8E','9E','8F','9F')
			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MCMB_RPT_JCS_BOOKING_NEW 
(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	
	Purpose:		For the Booking portion of the Jail Count Summary report.  Created for conversion to SQL by
              changing mcmb_rpt_jcsbooking.

	Author:			K. Heinz	    
*/

BEGIN
  OPEN vCur FOR	
--this portion pulls the combined inmate count for every cell: occupied or not
SELECT	Cell,
		sum(Cnt)as CellCnt,
		0 as GrandTotal,
		substr(Cell,1,1) as Sort1,
		substr(Cell,3,2) as Sort2
FROM
(
----------------------------------------------
--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(entity_id) as Cnt,
  		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.eh_housing_assignments ha
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
   		and temporary_location_flag = 'N'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		EPIC.ef_location_name(location_id, 'UC') as Cell
FROM	EPIC.epic_locations
WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			or EPIC.ef_location_name(location_id, 'UC') like 'GYM'
GROUP BY  EPIC.ef_location_name(location_id, 'UC')
----------------------------------------------
)
GROUP BY Cell
-----
UNION ALL
------

------
--this portion pulls the Grand Total for Holding Cells for the area (from the above query)
SELECT  'HCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'A' as Sort1,
		'22' as Sort2
FROM
(SELECT	sum(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
  		and EPIC.ef_location_name(location_id, 'UC') like 'HC%'
  		and temporary_location_flag = 'N'
 	)
)
-------
UNION ALL
---------
--this portion pulls the Grand Total for Detox Cells for the area (from the above query)
SELECT  'DCTotal' as Cell,
		0 as CellCnt,
		sum(CellCnt) as GrandTotal,
		'D' as Sort1,
		'03' as Sort2
FROM
(SELECT	SUM(Cnt)as CellCnt
	FROM
	(SELECT count(entity_id) as Cnt
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%BOOKING%'
   			and EPIC.ef_location_name(location_id, 'UC') like 'DC%'
   			and temporary_location_flag = 'N'
	)
)

ORDER BY Sort1 desc, Sort2;
END MCMB_RPT_JCS_BOOKING_NEW;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MCMB_RPT_JCS_FINAL 
(vCur 	out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	mcmb_rpt_jcsbotsummary edited to create this code for converting Crystal reports to SQL 
	Purpose:		Used by Administration to create a snapshot of the current inmate population at the time the report
					is run.  This code is for the final summary at the bottom of the JCS report.

	Author:			Kelly Heinz Feb., 2012   
*/

BEGIN
	 OPEN vCur FOR	
	SELECT	'PAROLEE' as InmateType,
		count(ha.entity_id) as Count,
		'A1' as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '3'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEDERAL' as InmateType,
		count(ha.entity_id) as Count,
		'A2' as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '2'
		and ha.temporary_location_flag = 'N'
---------
UNION ALL
---------

SELECT	'OTHER' as InmateType,
		count(ha.entity_id) as Count,
		'A3' as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status in ('14','15','16')
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------
SELECT	'TOTAL CONTRACT INMATES' as InmateType,
		0 as Count,
		'A4' as Sort

FROM	dual

---------
UNION ALL
---------

SELECT	'WORK RELEASE' as InmateType,
		count(ha.entity_id) as Count,
		'A5' as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_status e

WHERE	ha.entity_id = e.entity_id
		and e.code_custody_status = '5'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'JUVENILES' as InmateType,
		count(ha.entity_id) as Count,
		'B1' as Sort

FROM	epic.eh_housing_assignments ha,
		epic.eh_entity_person p

WHERE	ha.entity_id = p.entity_id
		and p.juvenile_flag = 'Y'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'MEDICAL HOSP' as InmateType,
		count(ha.entity_id) as Count,
		'B2' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) like 'HOSPITALS%'
		and epic.ef_location_path_name(location_id,'UC',6) not like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'PSYCH HOSP' as InmateType,
		count(ha.entity_id) as Count,
		'B3' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) like '%PSYCHIATRIC%'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'WRIT' as InmateType,
		count(ha.entity_id) as Count,
		'B4' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) = 'WRIT'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'MALE' as InmateType,
		count(ha.entity_id) as Count,
		'B5' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'M'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'FEMALE' as InmateType,
		count(ha.entity_id) as Count,
		'B6' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'F'
		and ha.temporary_location_flag = 'N'

---------
UNION ALL
---------

SELECT	'TOTAL INMATES' as InmateType,
		0 as Count,
		'B8' as Sort

FROM 	dual

---------
UNION ALL
---------

SELECT	'UNKNOWN' as InmateType,
		count(ha.entity_id) as Count,
		'B7' as Sort

FROM	epic.eh_housing_assignments ha

WHERE	epic.ef_location_path_name(location_id,'UC',6) != 'WRIT'
		and macomb.mcmb_fnt_gendershort(ha.entity_id) = 'U'
		and ha.temporary_location_flag = 'N'

ORDER BY Sort;
END MCMB_RPT_JCS_FINAL;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_KtchTrusSnrty
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.XX10
	Crystal: 		KtchTrusSnrty.rpt
	Purpose:		Used by Jail Admin(Lt Moore)  -- Classification tree node
	                CKT =  Current Kitchen Trustee's in order by date they became a KT housed in RA or RB
                    PKT =  next possible trustee housed in 1B unit
                    
	Author:			Mary Ann Zak (CR/PROCEDURE) / Glenn Sopfe (SELECT STATEMENT)

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak  		12-19-05        Created  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
						    
*/

BEGIN 

  OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as CellLoc,
				'' as HouseDate,
				'' as KTStatus
	   
		FROM	dual
		
----------
UNION ALL
----------
		--the below query pulls back the actual report data	
		SELECT 2 as Flag,
	           'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
               EPIC.ef_offender_id (ab.entity_id) as InmateNum,
               EPIC.ef_get_personororgname (ab.entity_id) as InmateName,
               EPIC.ef_Offender_Housing (ab.entity_id) as CellLoc,
               substr(EPIC.ef_epic_date_to_date(ha.action_time),1,10) as HouseDate,
               'CKT' as KTStatus  -- CKT = for CR grouping Current Kitchen Trustees  -- maz added

        FROM   EPIC.eh_active_booking ab,
	           EPIC.eh_housing_assignments ha

        WHERE  ha.entity_id = ab.entity_id
		       AND (substr(EPIC.ef_Offender_Housing (ab.entity_id),1,2)= 'RA' or  substr(EPIC.ef_Offender_Housing (ab.entity_id),1,2)= 'RB')

 ----------
UNION ALL
----------

		-- for report as to next possible trustee housed in 1B unit
		SELECT 3 as Flag,
	           'Kitchen & Pre-Kitchen Trustee Cell Seniority' as RptTitle,
	           EPIC.ef_offender_id (ab.entity_id) as InmateNum,
       		   EPIC.ef_get_personororgname (ab.entity_id) as InmateName,
               EPIC.ef_Offender_Housing (ab.entity_id) as CellLoc,
               substr(EPIC.ef_epic_date_to_date(ha.action_time),1,10) as HouseDate,
               'PKT' as KTStatus  -- PKT = for CR grouping Possible Kitchen Trustees  -- maz added

		FROM   EPIC.eh_active_booking ab,
	           EPIC.eh_housing_assignments ha

        WHERE  substr(EPIC.ef_Offender_Housing(ab.entity_id),1,2)='1B'
	           AND ha.entity_id = ab.entity_id

ORDER BY KTStatus, HouseDate, InmateName;

END;




/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_LC_Minors
	(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		epic.eh_booking.start_date%type,
		p_EndDate		in		epic.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX58
	Crystal: 		LC_Minors.rpt
	Purpose:		To list inmates that reside in jail age 15 - 17 for a given booking date range.
					requested by Jon Weatherup

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak	    11/17/05		Created
					M.Zak       12-2-05         OT Main
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
	
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type;
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= epic.ef_min_date(p_StartDate); 
		v_max_date	:= epic.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  := substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Lanse Creuse Minors Residing in Jail' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				v_date_null as BookingDate,
				v_date_null as ActualReleaseDate
					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Lanse Creuse Minors Residing in Jail' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) as AgeatBooking,
            	epic.ef_offender_id(ep.entity_id) as InmateNum,
	        	epic.ef_get_personororgname(ep.entity_id) as InmateName,
   		    	mcmb_fnt_DOB(ep.entity_id) as DOB,
	        	epic.ef_epic_date_to_date(bk.start_date) as BookingDate,
	        	epic.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate
		    		    	

		FROM   	epic.eh_booking bk,
				epic.eh_release r,
		    	epic.eh_entity_person ep

		WHERE 	bk.booking_id = r.booking_id (+)  
				and bk.entity_id = ep.entity_id   
				and (epic.ef_epic_date_to_date(bk.start_date) >= epic.ef_epic_date_to_date(v_min_date) and  epic.ef_epic_date_to_date(bk.start_date) <= epic.ef_epic_date_to_date(v_max_date))
                and ((mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date)) >= 5
				and (mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) <= 17 ))		
		
				
ORDER BY  Inmatename, bookingdate asc;    

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_LC_Minors_30
	(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		epic.eh_booking.start_date%type,
		p_EndDate		in		epic.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX59
	Crystal: 		LC_Minors_30.rpt
	Purpose:		To list inmates that reside in jail age 15 - 17 for a given booking date range resided in jail for more
	                than 30 days. Total number of residents, aged 5-17 inclusive, who during the period of (ex.9/2/05 thru 11/29/05 )
	                resided in jail for 30+ consecutive days (at least one of these days must been in October)).
                    requested by Jon Weatherup

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M. Zak	    12/02/05		Created
					M.Zak       12-2-05         OT Main
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
	
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type; 
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= epic.ef_min_date(p_StartDate); 
		v_max_date	:= epic.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  := substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Lanse Creuse Minors Residing in Jail 30+ days' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				v_date_null as BookingDate,
				v_date_null as ActualReleaseDate
					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Lanse Creuse Minors Residing in Jail 30+ Days' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) as AgeatBooking,
            	epic.ef_offender_id(ep.entity_id) as InmateNum,
	        	epic.ef_get_personororgname(ep.entity_id) as InmateName,
   		    	mcmb_fnt_DOB(ep.entity_id) as DOB,
	        	epic.ef_epic_date_to_date(bk.start_date) as BookingDate,
	         	epic.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate
		    		    	

		FROM   	epic.eh_booking bk,
				epic.eh_release r,
		    	epic.eh_entity_person ep

		WHERE 	bk.booking_id = r.booking_id (+)  
				and bk.entity_id = ep.entity_id 
				and (epic.ef_epic_date_to_date(bk.start_date) >= epic.ef_epic_date_to_date(v_min_date) and  epic.ef_epic_date_to_date(bk.start_date) <= epic.ef_epic_date_to_date(v_max_date)-30)
				and (epic.ef_epic_date_to_date(r.actual_release) is null or (epic.ef_epic_date_to_date(r.actual_release) >= epic.ef_epic_date_to_date(v_min_date)+30) 
				--and epic.ef_epic_date_to_date(r.actual_release) <= epic.ef_epic_date_to_date(v_max_date))
			 	and to_date(substr(epic.ef_epic_date_to_date(r.actual_release),1,10)) - to_date(substr(epic.ef_epic_date_to_date(bk.start_date),1,10))+ 1 >= 30)
                and ((mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date)) >= 5
				and (mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) <= 17 ))

ORDER BY  Inmatename, bookingdate asc;   


END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_LgyVoidBkFees
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY58
	Crystal: 		lgyvoidbkfees.rpt
	Purpose:		Used by Accounting to track voided booking fees from converted legacy data

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/15/05		Created 
					DLK			06/16/05		Development in Crystal begins  
					DLK			06/20/05		Upload to Report Tree (OTMain) for test   
					dlk         03/22/06        added macomb and epic notations 
					
*/


BEGIN 
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Legacy: Voided Booking Fees' as RptTitle,
				'' as InmateNum,
				0 as Amt,
				'' as LastName,
				'' as FirstName				
		
		FROM	dual
		
	UNION ALL
	
		--the below query pulls back the actual report data	
		SELECT  2 as Flag,
				'Legacy: Voided Booking Fees' as RptTitle,
		 		 EPIC.ef_offender_id(pi.entity_id) as InmateNum,
				td.amount as Amt,
				pi.name_family as LastName,
				pi.name_first as FirstName

		FROM	 EPIC.eh_trans_distribution td,
				 EPIC.eh_trust_account ta,
				 EPIC.eh_person_identity pi
	
		WHERE	td.gl_account_number = '499' AND
				(td.description = 'VBKC' or td.description = 'VBKS') and
				td.trust_account_id = ta.trust_account_id and
				ta.entity_id = pi.entity_id and
				pi.code_name_type = 'MAS'
				       
		ORDER BY Flag, LastName;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MoJuv_Summary_CRE
	(	p_StartDate 		in		epic.eh_booking.start_date%type,
	    p_EndDate           in      epic.eh_booking.start_date%type,
	    vCur        		out     epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRYSTAL ENTERPRISE
	Crystal: 		MoJuvsum_CRE.rpt
	Purpose:		To list Juvenile inmates for a given monthly booking date range.
					requested by Michelle Sanborn  (with a Booking Date greater than 06/01/2005) 

	Author:			Mary Ann (CRE) / Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					d. Kuykendall	12/27/05		added additional substr to remove the time from the DOB
					M. Zak          1-4-06          Created CRE version of mcmb_rpt_MO_Juvenile_Summary
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
	
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type;
 		v_date_null		date; 
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
 		
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  
       
		v_min_date	:= epic.ef_epic_date_to_date(epic.ef_min_date(p_StartDate)); 
		v_max_date	:= epic.ef_epic_date_to_date(epic.ef_max_date(p_EndDate));
		v_date_null := null;
   		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  := substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		
	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	
			
	select distinct  2 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				epic.ef_offender_id(ep.entity_id) as InmateNum,
	        	to_char(substr(mcmb_fnt_DOB(ep.entity_id),1,10)) as DOB,
                mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
				mcmb_fnt_race(ep.entity_id) as Race,
				mcmb_fnt_statutetext(ch.charge_id) as Most_Serious_Offense, --returns the description of the charge
				epic.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				mcmb_fnt_sent_date(bk.booking_id) as Adjudicated, --if sentenced then this is not a juvenile?
				epic.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				epic.ef_epic_date_to_date(r.actual_release) as Release_DateTime
				

From 			epic.eh_booking bk,
				epic.eh_active_booking ab,
				epic.eh_release r,
		    	epic.eh_entity_person ep,
		    	epic.eh_charge ch,
		    	epic.epic_statutes es


Where			bk.booking_id = r.booking_id (+)
				and bk.entity_id = ep.entity_id
				and bk.booking_id = ch.booking_id
				and es.statute_id = ch.statute_id
				and (epic.ef_epic_date_to_date(bk.start_date) >  v_min_date and  epic.ef_epic_date_to_date(bk.start_date) <=  v_max_date)
				and mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) < 17
				and ((mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date)) >= 5
				and (mcmb_fnt_epic_DateDiff_Years(epic.epicdate(mcmb_fnt_DOB(ep.entity_id)),bk.start_date) < 17 ))

order by InmateNum;
    

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MoJuv_Summary_SCH
	(	vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS

/*	Form Usage: 	CRYSTAL ENTERPRISE - SCHEDULE (Automatic email - monthly)
	Crystal: 		MoJuvsum_CRE_SCH.rpt
	Purpose:		To list Juvenile inmates for prior month of sysdate.
					requested by Sgt Roberts - scheduled report to run once a month and email to state 
					set up to email to Sgt Roberts to review and then he can forward email   

	Author:			Mary Ann (SCH)  / Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					d. Kuykendall	12/27/05		added additional substr to remove the time from the DOB
					M. Zak          1-6-06          Created CRE schedule version of mcmb_rpt_MO_Juvenile_Summary 
					M. Zak          4-5-06          Copied modified select logic from mcmb_rpt_MO_Juvenile_Summary
*/
	
		vStartDate      EPIC.eh_booking.start_date%type; 
		vEndDate        EPIC.eh_booking.start_date%type;    
    	v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_null		date; 
 		
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_date_null := null;
        vStartDate := EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2))))); --  -2 go back to previous month used to pull data back
        vEndDate := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))));      -- used to pull data back
        v_date_from := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2)))), EPIC.ef_date_format),1,100); -- display only in report
		v_date_to := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))), EPIC.ef_date_format),1,100); -- display only in report
		
		             
		             
		             
		             
	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				--0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			    --'' as MostSerious	
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	

select distinct  2 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	EPIC.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				decode(MACOMB.mcmb_fnt_sent_date(bk.booking_id), NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				MACOMB.mf_actualrelease(bk.booking_id) as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 


From 			EPIC.eh_booking bk

			
Where			(EPIC.ef_epic_date_to_date(bk.start_date) >= vStartDate and  EPIC.ef_epic_date_to_date(bk.start_date) <= vEndDate)
      			and  MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(bk.entity_id)),bk.start_date) < 17			
				
				
				
order by InmateNum;    

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MoJuv_Summary_SCH_SQL
	(	vCur        out        EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
  --Note:  This is the code currently being edited for SQL conversion KJH 5/12/2011  OTTEST compiled on otmain 5/12/2011 for data
/*	Form Usage: 	SQL Reporting Conversion(Automatic email - monthly)
	Crystal: 		MoJuvsum_CRE_SCH.rpt
	Purpose:		To list Juvenile inmates for prior month of sysdate.
					requested by Sgt Roberts - scheduled report to run once a month and email to state 
					set up to email to Sgt Roberts to review and then he can forward email   

	Author:			Mary Ann (SCH)  / Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					d. Kuykendall	12/27/05		added additional substr to remove the time from the DOB
					M. Zak          1-6-06          Created CRE schedule version of mcmb_rpt_MO_Juvenile_Summary 
					M. Zak          4-5-06          Copied modified select logic from mcmb_rpt_MO_Juvenile_Summary
					K. Heinz		05/02/11		Making changes on OTTSET for conversion to SQL Reporting.
*/
	
		vStartDate      EPIC.eh_booking.start_date%type; 
		vEndDate        EPIC.eh_booking.start_date%type;    
    v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_null		varchar2(24); 
 		
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_date_null := ' ';
		vStartDate := EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2))))); --  -2 go back to previous month used to pull data back
    vEndDate := EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))));      -- used to pull data back
    v_date_from := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-2)))), EPIC.ef_date_format),1,100); -- display only in report
		v_date_to := substr(to_char(EPIC.ef_epic_date_to_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1))), EPIC.ef_date_format),1,100); -- display only in report
		
		             
		             
		             
		             
	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				--0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,  
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
				--'' as MostSerious	
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	

select distinct  2 as Flag,
				'Monthly Juvenile Summary - County Locked Facility' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	mcmb_fnt_DOB_gvt_format(bk.entity_id) as DOB, --to_char(mcmb_fnt_DOB(bk.entity_id),'MM/DD/YYYY') as DOB,   --      --to_char(substr(mcmb_fnt_DOB(bk.entity_id),1,10)) as DOB, 
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY HH24:MI') as Locked_BookDateTime,
				decode(MACOMB.mcmb_fnt_sent_date(bk.booking_id), NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY HH24:MI') as Waived_BookDateTime,
				to_char(MACOMB.mf_actualrelease(bk.booking_id), 'MM/DD/YYYY HH24:MI') as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 
                
From 			EPIC.eh_booking bk

			
Where	   /*(EPIC.ef_epic_date_to_date(bk.start_date) >= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate((add_months((last_day(sysdate)+1),-10))))) and  EPIC.ef_epic_date_to_date(bk.start_date) <= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(EPIC.epicdate(add_months(Last_Day(sysdate),-1)))))
      			and  MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(bk.entity_id)),bk.start_date) < 17 */

				(epic.ef_epic_date_to_date(bk.start_date) >= vStartDate and  epic.ef_epic_date_to_date(bk.start_date) <= vEndDate)
      			and  macomb.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(mcmb_fnt_epic_DOB(bk.entity_id),bk.start_date) < 17
                                                                                                                            			
				
				
order by InmateNum;    

END;  

-- 05/02/2011 Currently returning inmate list that includes DOB in the 40's (BIDs) trying to find out why WHERE clause isn't working in SQL/*
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MonthlyIncar
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.YY35
	Crystal: 		monthlyincarcerated.rpt
	Purpose:		Returns a summary count of inmates booked during the selected month--  
					Number per day and per shift

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created
					R. Stuve	05/11/05		Changed DisplayDate to calculate from Oracle date to resolve
												incorrect parsing due to GMT time calculation
					R. Stuve	05/28/05		Compiled on OTMAIN
					R. Stuve	06/22/05		Commented DisplayDate and added mcmb_fnt_JuvFlag: recompiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  :=  substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Incarceration' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				v_date_null as BookingDate,
				--'' as DisplayDate,
				'' as Juvenile,
				'' as Gender,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Monthly Incarceration' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateID,
				EPIC.ef_epic_date_to_date(b.start_date) as BookingDate,
				--to_char(substr(ef_epic_date_to_date(b.start_date),4,2)) as DisplayDate,
					--we will be using the BookingDate to display on the report to display the full date
  				MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
  				MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
  				decode(to_char(substr((EPIC.ef_epic_date_to_date(b.start_date)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

	FROM  	EPIC.eh_booking  b

	WHERE  	EPIC.ef_epic_date_to_date(b.start_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(b.start_date) <= v_max_date

ORDER BY Flag, BookingDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MonthlyRelease
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.YY23
	Crystal: 		MonthlyRelease.rpt
	Purpose:		Used by the Jail Office to summarize the Daily Release report: lists inmates who have already been
					physically released during the selected dates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created
					R. Stuve	05/11/05		Changed DisplayDate to calculate from Oracle date to resolve
												incorrect parsing due to GMT time calculation
					R. Stuve	05/28/05		Compiled on OTMAIN                                                      
					R. Stuve	06/22/05		Commented DisplayDate and added mcmb_fnt_JuvFlag: recompiled on OTMAIN  
					dlk         03/22/06        added macomb and epic notation
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to   := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Release' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				v_date_null as ReleaseDate,
				--'' as DisplayDate,
				'' as Juvenile,
				'' as Gender,
				'' as Shift				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
				'Monthly Release' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(b.entity_id) as InmateID,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
				--to_char(substr(ef_epic_date_to_date(r.actual_release),4,2)) as DisplayDate,
					--we will be using the ReleaseDate to display on the report to display the full date
		  		MACOMB.mcmb_fnt_JuvFlag(b.entity_id) as Juvenile,
		  		MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
		  		decode(to_char(substr((EPIC.ef_epic_date_to_date(r.actual_release)),12,2)),
  					'00', 'M',
  					'01', 'M',
  					'02', 'M',
  					'03', 'M',
  					'04', 'M',
  					'05', 'M',
  					'06', 'M',
  					'07', 'M',
  						'08', 'D',
  						'09', 'D',
  						'10', 'D',
  						'11', 'D',
  						'12', 'D',
  						'13', 'D',
  						'14', 'D',
  						'15', 'D',
  							'16', 'A',
  							'17', 'A',
  							'18', 'A',
  							'19', 'A',
  							'20', 'A',
  							'21', 'A',
  							'22', 'A',
  							'23', 'A') as Shift

			FROM  	EPIC.eh_booking  b,
		  			EPIC.eh_release r

			WHERE  	b.booking_id = r.booking_id
					and EPIC.ef_epic_date_to_date(r.actual_release) >= v_min_date 
					and EPIC.ef_epic_date_to_date(r.actual_release) <= v_max_date

ORDER BY Flag, ReleaseDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MO_Juvenile_Summary
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX57
	Crystal: 		MO_Juvenile_Summary.rpt
	Purpose:		To list Juvenile inmates for a given monthly booking date range.
					requested by Michelle Sanborn  (with a Booking Date greater than 06/01/2005) 

	Author:			Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					M Zak            3-17-06        Modified from/where stmt
					M Zak            4-4-06         removed tables from where clause and used functions
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				--0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			    --'' as MostSerious	
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	
			
	select distinct  2 as Flag,
				'Monthly Juvenile Summary' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	MACOMB.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				decode(MACOMB.mcmb_fnt_sent_date(bk.booking_id), NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				MACOMB.mf_actualrelease(bk.booking_id) as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 


From 			EPIC.eh_booking bk

Where			(EPIC.ef_epic_date_to_date(bk.start_date) >= EPIC.ef_epic_date_to_date(v_min_date) and  EPIC.ef_epic_date_to_date(bk.start_date) <= EPIC.ef_epic_date_to_date(v_max_date))
      			and  MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(bk.entity_id)),bk.start_date) < 17

order by InmateNum;
    

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MO_Juv_Summary
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Altered from mcmc_rpt_MO_Juvenile_Summary for conversion to SQL reporting - April,  2011     KJH
	Purpose:		To list Juvenile inmates for a given monthly booking date range.
					requested by Michelle Sanborn  (with a Booking Date greater than 06/01/2005) 

	Author:			Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/08/05		Created
					M Zak            3-17-06        Modified from/where stmt
					M Zak            4-4-06         removed tables from where clause and used functions
*/
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_min_date(p_StartDate); 
		v_max_date	:= EPIC.ef_max_date(p_EndDate);
		v_date_from	:= substr(EPIC.ef_epic_date_to_date(p_StartDate),1,10);
		v_date_to  := substr(EPIC.ef_epic_date_to_date(p_EndDate), 1,10);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Monthly Juvenile Summary' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				--0 as AgeAtBooking,
				'' as InmateNum,
				'' as InmateName,	
				'' as DOB,
				'' as Gender,
				'' as Race,
				'' as Most_Serious_Offense,
				v_date_null as Locked_BookDateTime,
				'' as Adjudicated,
				v_date_null as Waived_BookDateTime,
				v_date_null as Release_DateTime
			    --'' as MostSerious	
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data	
			
	select distinct  2 as Flag,
				'Monthly Juvenile Summary' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(bk.entity_id) as InmateNum,
	        	EPIC.ef_get_personororgname(bk.entity_id) as InmateName,
	        	to_char(substr(MACOMB.mcmb_fnt_DOB(bk.entity_id), 1, 10)),      --MACOMB.mcmb_fnt_DOB(bk.entity_id) as DOB,
	        	MACOMB.mcmb_fnt_Offender_Gender(bk.entity_id) as Gender,
				MACOMB.mcmb_fnt_race(bk.entity_id) as Race,
				MACOMB.mcmb_fnt_primarycharge(bk.booking_id)as Most_Serious_Offense, -- MAZ 4-4-06 returns the description of the primary charge
				EPIC.ef_epic_date_to_date(bk.start_date) as Locked_BookDateTime,
				decode(MACOMB.mcmb_fnt_sent_date(bk.booking_id), NULL, 'N', 'Y') as Adjudicated, --if sentenced then this is not a juvenile
				--if above has a date then the criteria is Y Should always be no N, EH_STAFF_ASSIGNMENT
				EPIC.ef_epic_date_to_date(bk.start_date) as Waived_BookDateTime,
				MACOMB.mf_actualrelease(bk.booking_id) as Release_DateTime  -- MAZ 4-4-06 already in oracle date format 


From 			EPIC.eh_booking bk

Where			(EPIC.ef_epic_date_to_date(bk.start_date) >= EPIC.ef_epic_date_to_date(v_min_date) and  EPIC.ef_epic_date_to_date(bk.start_date) <= EPIC.ef_epic_date_to_date(v_max_date))
      			and  MACOMB.mcmb_fnt_DOB(bk.entity_id) is not null
				and MACOMB.mcmb_fnt_epic_DateDiff_Years(EPIC.epicdate(MACOMB.mcmb_fnt_DOB(bk.entity_id)),bk.start_date) < 17

order by InmateNum;
    

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MultiCtrAgy
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ80
	Crystal: 		MultiCtrAgy.rpt
	Purpose:		Used by the Administration/Booking to find inmates that have more than
					one controlling agency per charge

	Author:			Glenn Sopfe/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/31/05		Created   
					DLK			05/31/05		Crystal report created/uploaded for test 
					R. Stuve	06/06/05		Compiled on OTMAIN 
					dlk         03/22/06        added macomb and epic notation
*/

	v_date_null date;

BEGIN 

	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Exception: Multiple Control Agencies' as RptTitle,
				'' as InmateNum,
				'' as InmateName
				
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Exception: Multiple Control Agencies' as RptTitle,
				EPIC.ef_offender_id(EPIC.ef_get_entity_from_book(cc.booking_id)) as InmateNum,
				EPIC.ef_get_personororgname(EPIC.ef_get_entity_from_book(cc.booking_id)) as InmateName

		FROM 	EPIC.eh_charge_agency ca,
				EPIC.eh_charge_agency ca2,
				EPIC.eh_charge cc
		
		WHERE	ca.charge_id = ca2.charge_id
				and ca.agency_id <> ca2.agency_id
				and cc.charge_id = ca2.charge_id

		ORDER BY Flag, InmateName;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_MusterNotCount
(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ40
	Crystal: 		musternotcount.rpt
	Purpose:		Used by the Jail Office to track inmates added to muster, but not
					to count (most often a data-entry error)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/25/05		Created  
					DLK			03/25/05		Added to report tree for test  
					R. Stuve	05/24/05		Compiled on OTMAIN   
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
*/                 
			
BEGIN  

	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Inmates on Muster but Not on Count' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Count
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Inmates on Muster but Not on Count' as RptTitle,
				EPIC.ef_offender_id(m.entity_id) as InmateNum,
      			EPIC.ef_get_personororgname(m.entity_id) as InmateName,
      			EPIC.ef_offender_housing(m.entity_id) as Cell,
      			m.in_muster_flag as Count

		FROM    EPIC.eh_muster m

		WHERE	m.in_muster_flag = 'N'

ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
Procedure MACOMB.mcmb_rpt_NeedsClassify
--saved as a backup copy only
	(RPT_Not_Classified	IN OUT	epic.epp_generic_ref_cursor.ref_cursor,
	P_Form_usage		IN		epic.epic_form.Form_usage%type,
	P_UserID			In		epic.epic_user_names.user_int_id%type,
	p_Location			IN		epic.EPIC_LOCATIONS.LOCATION_ID%type,
	p_end_date			in		epic.eh_security_classification.next_review_date%type
)

--	12/16/04	Bob Meeks
--	Take the rpt_not_classified_proc and modify it for Macomb County.  Saving it as a new
--  report procedure and will use the same Crystal Report (ICL1_2_3_4.rpt), but will have its own form usage
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

AS
	lookup_code			constant varchar2(10) := 'CRSTL.';
	Form_usage			constant varchar2(10) := P_Form_usage;
	v_security_object	constant epic.epic_user_objects.object_code%type := lookup_code || P_Form_usage;

	Report_Title		epic.epic_col_types.varchar_255%type;
	Report_Version		epic.epic_col_types.varchar_255%type;
	InsititionName		epic.epic_col_types.varchar_255%type;
	EnterpriseName		epic.epic_col_types.varchar_255%type;
	PageBreak			epic.epic_col_types.varchar_255%type;
	f_Enterprise		epic.epic_col_types.varchar_255%type;
	f_Location			epic.epic_col_types.varchar_255%type;
	f_LocationID		epic.epic_col_types.varchar_255%type;
	f_Off_Ident_Col		epic.epic_col_types.varchar_255%type;

	p_result			number(9,0);
	p_result_msg		varchar2(255);
	v_review			epic.epic_configuration.config_value%type;
	n_review			integer;
--	v_review_date		epic.epic_col_types.varchar_255%type;
	v_next_review_date	epic.eh_security_classification.next_review_date%type;
	f_review_date		epic.epic_col_types.varchar_255%type;
	f_today_date		epic.epic_col_types.varchar_255%type;
	f_location_type		varchar2(255);

	v_modified_charges	epic.epic_configuration.config_value%type;
	v_new_charges     	epic.epic_configuration.config_value%type;
	v_new_holds			epic.epic_configuration.config_value%type;
	v_new_incidents		epic.epic_configuration.config_value%type;

BEGIN

	Report_Title	:=	substr(epic.ef_lookup_text ('REPORT TREE', lookup_code || Form_usage, 'IC'),1,255);
	Report_Version	:=	substr(epic.ef_ReportVersion (Form_usage),1,255);
	InsititionName	:=	substr(epic.ef_get_Licensee('ABOUT', 'LICENSEE'),1, 255);
	EnterpriseName	:=	substr(epic.ef_get_Enterprise, 1, 255);
	f_Off_Ident_Col	:=	substr(initcap(epic.ef_config_offender_id),1,200) || ':';

--	epic.ep_log_info(Report_Title, 'R', -1, Report_Title ||' Report_Version: ' || Report_Version);

	v_next_review_date := p_end_date;
--	f_review_date		:=	substr(to_char(epic.ef_epic_date_to_date(v_review_date), epic.ef_date_format),1,100) ;
--	f_today_date		:=	substr(to_char(epic.ef_epic_date_to_date(epicdatenow), epic.ef_date_format),1,100);
	f_today_date		:=	substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format),1,100) ;
	f_review_date		:=	substr(to_char(epic.ef_epic_date_to_date(epic.epicdatenow), epic.ef_date_format),1,100);


	-- determine which conditions should cause someone to appear on the
	-- report.  All of these default to N, which means the base report is the same
	-- as before.
--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE MODIFIED CHARGES', v_modified_charges, 'N', p_result, p_result_msg);
--	if v_modified_charges is null then
		v_modified_charges := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW CHARGES', v_new_charges, 'N', p_result, p_result_msg);
--	if v_new_charges is null then
		v_new_charges := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW HOLDS', v_new_holds, 'N', p_result, p_result_msg);
--	if v_new_holds is null then
		v_new_holds := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW INCIDENTS', v_new_incidents, 'N', p_result, p_result_msg);
--	if v_new_incidents is null then
		v_new_incidents := 'Y';
--	end if;


	if Form_usage = 'ICX1' THEN		-- Enterprise Report
		f_LocationID	:=	epic.ef_get_EnterpriseID;
		f_location_type := 'ENTERPRISE';
	else
		f_LocationID	:=	p_Location;
	end if;

	if Form_usage = 'ICX2' then
		f_location_type := 'REGION';
	end if;
	if Form_usage = 'ICX3' then
		f_location_type := 'FACILITY';
	end if;
	if Form_usage = 'ICX4' then
		f_location_type := 'UNIT';
	end if;

	PageBreak	:=	epic.ef_Report_PageBreak(f_LocationID);
	f_Location	:=	substr(epic.ef_location_name(f_LocationID, ''),1,200);

	OPEN RPT_Not_Classified FOR
		SELECT
			1					as flag,	-- Page Header Section of Report
			Report_Title		as	Report_Title,
			Report_Version		as	Report_Version,
			InsititionName 		as	Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(f_LocationID),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			0					as	ChildLevel,
			' '					as 	ChildLocation,
			' '					as 	ChildType,
			' '					as 	Offender_Name,
			' '					as 	Offender_Ident,
			f_review_date		as 	Review_date1,
			f_today_date		as 	Review_date2,
			v_review			as	Review_Period,
			' '					as  dob,
			' '					as  secclass,
			' '					as  sortdate
		FROM DUAL
		UNION
		--
		--	the section below finds all persons on muster with active bookings
		--		who have NO classifications for the booking
		--
/*		SELECT  distinct
			2	as flag,
			'NO CLASSIFICATION'	as	Report_Title,
			' '	as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col			as	Offender_Ident_Col,
			f_Location				as 	Location_Name,
			substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
			PageBreak				as	PageBreak,
			nvl(epic.ef_location_level(ef_sub_location(em.Entity_ID, elc.location_id)), 99)
									as	ChildLevel,
			substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
									as ChildLocation,
			substr(epic.ef_location_type_name(ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
									as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
									as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
									as 	Offender_Ident,
			' '						as 	Review_date1,
			' '						as 	Review_date2,
			' '						as  Review_Period
		from
			epic.EH_ACTIVE_BOOKING ab,
			epic.eh_muster em,
			epic.eh_Housing_assignments ua,
			epic.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID			--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.Entity_ID = ab.Entity_ID
			and	not exists (select 1
				from	epic.EH_SECURITY_CLASSIFICATION sc
				where	ab.BOOKING_ID = sc.BOOKING_ID)
		Union
*/
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at a subordinate location of the location parameter
		--
		SELECT  distinct
			3	as flag,
			'SCHEDULED'	as	Report_Title,
			' '	as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
								as	ChildLevel,
			substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
								as ChildLocation,
			substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
								as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(epic.ef_epic_date_to_date(sc.review_date), epic.ef_date_format),1,100)
								as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate
		from
			epic.eh_muster em,
			epic.EH_Housing_ASSIGNMENTS ua,
			epic.EH_ACTIVE_BOOKING ab,
			epic.EH_SECURITY_CLASSIFICATION sc,
			epic.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from epic.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
		Union
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at the location parameter
		--
		SELECT  distinct
			3					as flag,
			'SCHEDULED'					as	Report_Title,
			' '					as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			99					as	ChildLevel,
			' ' 				as ChildLocation,
			'HOUSED AT ' || f_location_type || ' LEVEL'					as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(epic.ef_epic_date_to_date(sc.review_date), epic.ef_date_format),1,100)
								as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate

		from
			epic.eh_muster em,
			epic.EH_Housing_ASSIGNMENTS ua,
			epic.EH_ACTIVE_BOOKING ab,
			epic.EH_SECURITY_CLASSIFICATION sc
		where
				em.Entity_ID = ua.Entity_ID
			and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from epic.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
   --******************************************************************
   --
   --                        Inmates at, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and   sc.booking_id = ab.booking_id
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_booking_holds hld,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_booking_holds hld,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_booking_holds hld,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_booking_holds hld,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_incident inc,
		epic.eh_incident_offender inco,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_incident inc,
		epic.eh_incident_offender inco,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
	  order by 1, 19, 12;


exception
	when others THEN
		epic.ep_log_info(Report_Title, 'E', -1,
			sqlerrm || ' - ' || Report_Title || ' (' || Form_usage || ')');
		RETURN;
end ;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_NoJudgeEntered
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY76, CRSTL.YY77
	Crystal: 		NoJudgeEnteredBk.rpt, NoJudgeEnteredAdm.rpt
	Purpose:		Used by the Jail Office to determine ALL inmates where no Judge Name has been entered and ZZZ for Unknown Judge Name
 					to assist with key missing information. Booking report does not list staff name; Admin report does list staff name

	Author:			Original Query recieved from Glenn Sophe (via MAZ 12/28/05)
					D. Kuykendall 
					
	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/28/05        Modified Procedure Header names created Crystal report
					DLK             03/22/06        ADDED MACOMB AND EPIC NOTATION
					R. Stuve		4/6/06			Modified Staff field (combined to one field), inserted Charge function to 
													eliminate connection to epic_statutes table
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				'' as InmateNum,
				'' as IName,
				'' as CaseNo,
				'' as Charge,
				'' as Judge,
				'' as DateModified,
				'' as Staff
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				EPIC.ef_offender_id(ab.entity_id) as InmateNum,
		      	EPIC.ef_get_personororgname(ab.entity_id) as IName,
		     	MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as CaseNo,
		      	MACOMB.mcmb_fnt_statutetext(c.charge_id) as Charge,
		       	MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) as Judge,
		      	substr(EPIC.ef_epic_date_to_date(c.action_time),1,10) as DateModified,
		      	EPIC.ef_get_username1stlast(c.action_by) as Staff

		FROM 	EPIC.eh_active_booking ab,
				EPIC.eh_charge c

		WHERE 	ab.booking_id = c.booking_id
				and c.charge_state <> 6
				and (MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) is null 
					or MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) = 'ZZZ')

ORDER BY Judge;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_NoJudgeEntered_backup
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY76
	Crystal: 		nojudgeentered.rpt 
	Purpose:		Used by the Jail Office to determine ALL inmates where no Judge Name has been entered and ZZZ for Unknown Judge Name
 					to assist with key missing information. It appears that the Judge criteria comes from the Case tab rather than the Court Tab.

	Author:			Original Query recieved from Glenn Sophe (via MAZ 12/28/05)
					D. Kuykendall 
	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/28/05        Modified Procedure Header names created Crystal report
					DLK             03/22/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Exception: No Judge Entered' as RptTitle, 
				'' as InmateNum,
				'' as IName,
				'' as CaseNo,
				'' as Charge,
				'' as Judge,
				'' as DateModified,
				'' as OffLstNm,
				'' as OffFstNm
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 2 as Flag,
		'Exception: No Judge Entered' as RptTitle, 
		EPIC.ef_offender_id(ab.entity_id) as INMATENUM,
      	EPIC.ef_get_personororgname(ab.entity_id) as INAME,
     	MACOMB.mcmb_fnt_CaseNumber (C.charge_id) as CASENO,
      	es.statute_description as CHARGE,
       	MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) as JUDGE,
       	substr(EPIC.ef_epic_date_to_date(C.action_time),1,10) as DATEMODIFIED, --011306 dlk added max function 
      	--MAX(C.action_time) as datemodified,
      	un.user_name_last as OFFLSTNM,
      	Un.user_NAME_FIRST as OFFLSTNM

from 	EPIC.eh_active_booking ab,
		EPIC.eh_charge c,
		EPIC.epic_statutes es,
		EPIC.epic_user_names un

where 	c.booking_id = ab.booking_id
		and c.statute_id = es.statute_id
		and c.action_by = un.user_int_id
		and c.charge_state <> 6
		and (MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) is null or MACOMB.mcmb_fnt_JudgeName_ChargeID (c.charge_id) ='ZZZ' )
        --and c.action_by = 19
        
order by Judge;
end;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_NoStatus
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ52
	Crystal: 		nostatus.rpt 
	Purpose:		Used by the Jail Office to determine which inmate files need to be
					updated/processed

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/23/04		Created
					dlk			01/10/05		Added to the tree for test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/14/05		Changed mcmb_fnt_inmatestatusb to 
												mcmb_fnt_inmatestatus(charge_id) and changed
												to SELECT DISTINCT to limit one record/inmate
					R. Stuve	05/05/05		Changed logic to include incomplete bookings and bookings
												with no associated charges; included GroupOrder field to
												assist in proper display on Crystal report    
					R. Stuve	05/24/05		Compiled on OTMAIN  
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATIONS
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Case Status (No Status)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as DOB,
				'' as Gender,
				'' as GroupOrder
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT  DISTINCT
			2 as Flag,
			'Case Status (No Status)' as RptTitle, 
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_cell(b.entity_id) as Cell,
			EPIC.ef_offender_DOB(b.entity_id)as DOB,
			MACOMB.mcmb_fnt_gendershort(b.entity_id) as Gender,
			'No Status' as GroupOrder
	
	FROM 	EPIC.eh_charge c,
			EPIC.eh_active_booking  b
	
	WHERE 	b.booking_id = c.booking_id (+)
			and c.charge_state != '6'
			and (
				MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'NO STATUS'
				or
				MACOMB.mcmb_fnt_EntityStatus(b.entity_id) = 'NO STATUS'
				)
-----------
UNION ALL
-----------

SELECT	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b1.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b1.entity_id) as InmateName,
		EPIC.ef_offender_cell(b1.entity_id) as Cell,
		EPIC.ef_offender_DOB(b1.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b1.entity_id) as Gender,
		'Unaccepted Booking' as GroupOrder

FROM	EPIC.eh_active_booking b1,
		EPIC.eh_booking bkg

WHERE	bkg.booking_id = b1.booking_id
		and EPIC.ef_epic_date_to_date(bkg.accept_date) is null

-----------
UNION ALL
-----------
(
--select all inmates with any booking
SELECT	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b2.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b2.entity_id) as InmateName,
		EPIC.ef_offender_cell(b2.entity_id) as Cell,
		EPIC.ef_offender_DOB(b2.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b2.entity_id) as Gender,
		'No Charges' as GroupOrder

FROM	EPIC.eh_active_booking b2

minus
--subtract inmates with bookings that have associated charges
SELECT 	2 as Flag,
		'Case Status (No Status)' as RptTitle, 
		EPIC.ef_offender_id(b3.entity_id) as InmateNum,
		EPIC.ef_get_personororgname(b3.entity_id) as InmateName,
		EPIC.ef_offender_cell(b3.entity_id) as Cell,
		EPIC.ef_offender_DOB(b3.entity_id)as DOB,
		MACOMB.mcmb_fnt_gendershort(b3.entity_id) as Gender,
		'No Charges' as GroupOrder

FROM 	EPIC.eh_active_booking b3,
		EPIC.eh_charge c

WHERE	b3.booking_id = c.booking_id
)

ORDER BY Flag, GroupOrder, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_OnDeck
	 (	vCur 			out      	EPIC.epp_generic_ref_cursor.ref_cursor)
		
IS

 /*	Form Usage: 	CRSTL.XX01 (Female); CRSTL.XX02 (Male)
	Crystal: 		OnDeckFemale.rpt (Female): OnDeckMale.rpt (Male)
	Purpose:		Used by Classification to indicate which classified inmates (by classification
					type and booking date) are next to be moved.  Two reports by gender: Female cells
					begin with 6B/7B--18 cells alltogether (6B01, 6B02, 6B03, 6B04, 6B05, 6B06, 6B07,
					6B08, 6B09, 7B01, 7B02, 7B03, 7B04 7B05, 7B06, 7B07, 7B08, 7B09); Male cells begin 
					with D (but not 12 or 7 or DC01 or DC02)--10 cells alltogether (D1PC, D2PC, D3PC, 
					D4PC, D5PC, D6PC, D08, D09, D10, D11)


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/03/05		Created    
					DLK			03/28/05		Begin development Crystal - Added to the Report Tree
					R.Stuve		05/28/05		Compiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION  
					MAZ         03/26/08        Crystal Report only - removed D4pc and added D07 per srf 14289
						
*/
 
v_date_null	date;   
 
BEGIN
        
v_date_null := null;     
        
	OPEN vCur FOR
          --the below query pulls back the header information	
		SELECT 	1 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				v_date_null as BookingDate,
				'' as SecurityClass,
				'' as ActiveAlerts,
				'' as SortOrder,
				'' as KeepSep
			
		FROM 	dual

UNION ALL

		SELECT	2 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) AS InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) AS InmateName,
				EPIC.ef_offender_cell(ab.entity_id) AS Cell,
				EPIC.ef_epic_date_to_date(b.start_date) AS BookingDate,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') AS SecurityClass,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) AS ActiveAlerts,
				decode (sc.classification, 	'01', '1',
									'02', '1',
									'03', '1',
									'04', '2',
									'05', '2',
									'06', '3',
									'07', '4',
									'08', '5') as SortOrder,
				MACOMB.mcmb_fnt_KeepSep(ab.entity_id) as KeepSep

		FROM 	EPIC.eh_active_booking ab,
				EPIC.eh_booking b,
				EPIC.eh_security_classification sc,
				EPIC.eh_generic_attribute g
		
		WHERE 	b.booking_id = ab.booking_id
				AND ab.booking_id = sc.booking_id
				AND sc.classification <> '00'
				AND ab.booking_id = g.item_id
				AND g.attribute_name = 'NEEDS CLASSIFICATION INTERVIEW'
				AND g.attribute_value = 'N'
				AND NOT EXISTS (SELECT classification_id
						FROM EPIC.eh_security_classification sc2
						WHERE sc.booking_id = sc2.booking_id
						AND EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))

ORDER BY Flag, SortOrder, BookingDate, InmateNum;      

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_OnDeckMB
	 (	vCur 			out      	EPIC.epp_generic_ref_cursor.ref_cursor)
		
IS

 /*	
 
 TESTING ************************************** MB  with PROD DATA....
 
 Form Usage: 	CRSTL.XX01 (Female); CRSTL.XX02 (Male)
	Crystal: 		OnDeckFemale.rpt (Female): OnDeckMale.rpt (Male)
	Purpose:		Used by Classification to indicate which classified inmates (by classification
					type and booking date) are next to be moved.  Two reports by gender: Female cells
					begin with 6B/7B--18 cells alltogether (6B01, 6B02, 6B03, 6B04, 6B05, 6B06, 6B07,
					6B08, 6B09, 7B01, 7B02, 7B03, 7B04 7B05, 7B06, 7B07, 7B08, 7B09); Male cells begin 
					with D (but not 12 or 7 or DC01 or DC02)--10 cells alltogether (D1PC, D2PC, D3PC, 
					D4PC, D5PC, D6PC, D08, D09, D10, D11)


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/03/05		Created    
					DLK			03/28/05		Begin development Crystal - Added to the Report Tree
					R.Stuve		05/28/05		Compiled on OTMAIN 
					DLK         03/22/06        ADDED MACOMB AND EPIC NOTATION  
					MAZ         03/26/08        Crystal Report only - removed D4pc and added D07 per srf 14289
						
*/
 
v_date_null	date;   
 
BEGIN
        
v_date_null := null;     
        
	OPEN vCur FOR
          --the below query pulls back the header information	
		SELECT 	1 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				v_date_null as BookingDate,
				'' as SecurityClass,
				'' as ActiveAlerts,
				'' as SortOrder,
				'' as KeepSep
			
		FROM 	dual

UNION ALL

		SELECT	2 as Flag,
				'Inmates on Deck for Moves' as RptTitle,
				EPIC.ef_offender_id(ab.entity_id) AS InmateNum,
				EPIC.ef_get_personororgname(ab.entity_id) AS InmateName,
				EPIC.ef_offender_cell(ab.entity_id) AS Cell,
				EPIC.ef_epic_date_to_date(b.start_date) AS BookingDate,
				EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ab.entity_id), 'UC') AS SecurityClass,
				MACOMB.mcmb_fnt_activealerts_trunc(ab.entity_id) AS ActiveAlerts,
				decode (sc.classification, 	'01', '1',
									'02', '1',
									'03', '1',
									'04', '2',
									'05', '2',
									'06', '3',
									'07', '4',
									'08', '5') as SortOrder,
				MACOMB.mcmb_fnt_KeepSepMB(ab.entity_id) as KeepSep

		FROM 	EPIC.eh_active_booking ab,
				EPIC.eh_booking b,
				EPIC.eh_security_classification sc,
				EPIC.eh_generic_attribute g
		
		WHERE 	b.booking_id = ab.booking_id
				AND ab.booking_id = sc.booking_id
				AND sc.classification <> '00'
				AND ab.booking_id = g.item_id
				AND g.attribute_name = 'NEEDS CLASSIFICATION INTERVIEW'
				AND g.attribute_value = 'N'
				AND NOT EXISTS (SELECT classification_id
						FROM EPIC.eh_security_classification sc2
						WHERE sc.booking_id = sc2.booking_id
						AND EPIC.ef_epic_date_to_date(sc2.review_date) > EPIC.ef_epic_date_to_date(sc.review_date))

ORDER BY Flag, SortOrder, BookingDate, InmateNum;      

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_OnDeck_backup
	  (	vCur 			out      	epic.epp_generic_ref_cursor.ref_cursor,
		p_Cell			in			epic.eh_person_identity.other_identity_number%type)
		
IS

 /*	Form Usage: 	CRSTL.XX01 (Female); CRSTL.XX02 (Male)
	Crystal: 		***.rpt (Female): ***.rpt (Male)
	Purpose:		Used by Classification to indicate which classified inmates (by classification
					type and booking date) are next to be moved.  Two reports by gender:Female
					(6B01, 6B02, 6B03, 6B04, 6B05, 6B06, 6B07, 6B08, 6B09, 7B01, 7B02, 7B03, 7B04
					7B05, 7B06, 7B07, 7B08, 7B09); Male (D1PC, D2PC, D3PC, D4PC, D5PC, D6PC, D08, 
					D09, D10, D11)


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/14/04		Added header information via union query 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	02/28/05		Added KeepSep for Keep Separate information
					J. McBratnie 07/15/07       move to Macomb schema from Production
						
*/
 
p_cellt varchar2(255) := concat(concat(chr(39),replace(p_cell,',' , concat( concat(chr(39),',') ,chr(39) ))),chr(39));
v_date_null date;

queryin  varchar2(2000) := 'SELECT 1 as Flag,''Inmates on Deck for Moves'' as RptTitle,''' || p_Cell || ''' as CellRange,'''' as Inmate#,'''' as InmateName,'''' as Cell,''v_date_null'' as BookingDate,'''' as SecurityClass,'''' as ActiveAlerts,'''' as SortOrder, '''' as KeepSep FROM dual UNION ALL SELECT 2 as Flag,''Inmates on Deck for Moves'' as RptTitle,'''' as CellRange,epic.ef_offender_id(ab.entity_id) AS Inmate#,epic.ef_get_personororgname(ab.entity_id) AS InmateName,epic.ef_offender_cell(ab.entity_id) AS Cell,epic.ef_epic_date_to_date(b.start_date) AS BookingDate,epic.ef_lookup_text (''SECURITY CLASSIFICATION'', epic.ef_get_Security_Class(ab.entity_id), ''UC'') AS SecurityClass,mcmb_fnt_activealerts_trunc(ab.entity_id) AS ActiveAlerts,decode(sc.classification,''01'',''1'',''02'',''1'',''03'',''1'',''04'',''2'',''05'',''2'',''06'',''3'',''07'',''4'',''08'',''5'') as SortOrder, mcmb_fnt_KeepSep(ab.entity_id) as KeepSep FROM epic.eh_housing_assignments ha, epic.eh_active_booking ab,epic.eh_booking b,epic.eh_security_classification sc,epic.eh_generic_attribute g WHERE b.booking_id = ab.booking_id AND ab.booking_id = sc.booking_id AND sc.classification <> ''00''AND ab.booking_id = g.item_id AND g.attribute_name = ''NEEDS CLASSIFICATION INTERVIEW'' AND g.attribute_value = ''N'' AND NOT EXISTS (SELECT classification_id FROM eh_security_classification sc2 WHERE sc.booking_id = sc2.booking_id AND sc2.review_date > sc.review_date) AND epic.ef_location_name(ha.location_id,''UC'') IN (';

queryout   varchar2(2000) := concat(concat(queryin, p_cellt), ') ORDER BY Flag,SortOrder, BookingDate, Inmate#');

BEGIN           
	v_date_null := null;    
	OPEN vCur FOR	queryout;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_OutstandBndChk
	(	vCur		OUT		epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.YY51
	Crystal: 		****.rpt
	Purpose:		Used by the Finance department for auditing puroses: Lists all outstanding checks 
					written from the MCJ facility account

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	5/02/05			Created  
					R. Stuve	5/03/05			Changed CheckNumber to number format  
					DLK			05/03/05		Begin devl. for test   
					R. Stuve	05/28/05		Compiled on OTMAIN
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/

v_date_null	date;
	
BEGIN

v_date_null := null;

	OPEN vCur FOR
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Outstanding Bond Checks' as RptTitle,
				0 as CheckNum,
				0 as Amount,
				v_date_null as TransDate,
				'' as Court
		
		FROM	dual
		
	UNION ALL			
		
		--the below query pulls back the actual report data	
    SELECT	2 as Flag,
        	'Outstanding Bond Checks' as RptTitle,
        	to_number(tat.check_number) as CheckNum,
			tat.amount as Amount,
			epic.ef_epic_date_to_date(tat.trans_date) as TransDate,
			tat.payee_or as Court

	FROM	epic.eh_trust_account_trans tat,
			epic.eh_check_register cr

	WHERE	cr.trust_account_trans_id = tat.trust_account_trans_id
			and tat.trust_account_id = '0I8RANB000USJ0BR'
				--facility account
			and not exists
				(select 1 from epic.eh_trust_trans_cleared ttc
				where ttc.trust_account_trans_id = tat.trust_account_trans_id)
				--makes sure check is not cleared
			and cr.void_flag is null
				--makes sure check is not void
	
	ORDER BY Flag, TransDate, CheckNum;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_paidBookFees
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_trans_distribution.action_time%type,
	 	p_EndDate       in         	EPIC.eh_trans_distribution.action_time%type)

IS

/*	Form Usage: 	CRSTL.YY56  
	Crystal: 		paidbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were paid during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					DLK			01/28/05		begin devl 
					DLK			02/08/05		add to tree test 
					R. Stuve	02/28/05		Added Reversal field to indicate transaction reversals
					DLK			03/01/05		Added reversal to he Crystal Report
					R. Stuve	05/28/05		Compiled on OTMAIN   
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
					J. McBratnie05/22/09        Proformance updates to query 
					J. McBratnie01/24/12        Update for structure changes in the new release
	
*/

    v_min_date		EPIC.eh_trans_distribution.action_time%type;
	v_max_date		EPIC.eh_trans_distribution.action_time%type;
    v_date_from		EPIC.epic_col_types.varchar_255%type;
 	v_date_to		EPIC.epic_col_types.varchar_255%type;
	v_date_null		date;
 	--must be same datatype as declarations above so WHERE clause doesn't fail

BEGIN

	v_min_date	:= EPIC.ef_min_date(p_StartDate);
	v_max_date	:= EPIC.ef_max_date(p_EndDate);
	v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
	v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
	v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information
		SELECT	1 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as TDate,
				0 as Amount,
				'' as Agency,
				'' as Reversal
		FROM	dual

		--the below query pulls back the actual report data
		UNION ALL

/*		SELECT	2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(tat.trans_date), EPIC.ef_date_format),1,100) as TDate,
				tat.amount as Amount,
				'C' as Agency,
				decode(tat.reverse_flag,'Y','Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	t.trust_account_id = tat.trust_account_id
				and tat.code_source_of_funds = '502'
				and tat.trans_date >= v_min_date
				and tat.trans_date < v_max_date

		UNION ALL
*/
		SELECT	2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(d.action_time), EPIC.ef_date_format),1,100) as TDate,
				(d.amount) * -1 as Amount,
				'C' as Agency,
				decode(sign(d.amount),1,'Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trans_distribution d

		WHERE	t.trust_account_id = d.trust_account_id
				and d.gl_account_number = '110'
	            and exists ( select 1 from EPIC.eh_trans_distribution d2
	                         where d2.trust_account_trans_id = d.trust_account_trans_id
	                         	   and d2.gl_account_number = '502')
				and d.action_time >= v_min_date
				and d.action_time < v_max_date

		UNION ALL

        SELECT  2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(d.action_time), EPIC.ef_date_format),1,100) as TDate,
				d.amount as Amount,
				'C' as Agency,
				decode(sign(d.amount),-1,'Y') as Reversal

        FROM	EPIC.eh_trust_account t,
        		EPIC.eh_trans_distribution d

        WHERE	t.trust_account_id = d.trust_account_id
        		and d.gl_account_number = '202'
           		and not exists ( select 1 from EPIC.eh_trans_distribution d2
                	             where d2.trust_account_trans_id = d.trust_account_trans_id
                     		           and d2.gl_account_number = '502')
           		and d.action_time >= v_min_date
           		and d.action_time < v_max_date

		UNION ALL
/*
		SELECT	2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(tat.trans_date), EPIC.ef_date_format),1,100) as TDate,
				tat.amount as Amount,
				'S' as Agency,
				decode(tat.reverse_flag,'Y','Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	t.trust_account_id = tat.trust_account_id
				and tat.code_source_of_funds = '503'
				and tat.trans_date >= v_min_date
				and tat.trans_date < v_max_date

		UNION ALL
*/
		SELECT	2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(d.action_time), EPIC.ef_date_format),1,100) as TDate,
				(d.amount) * -1 as Amount,
				'S' as Agency,
				decode(sign(d.amount),1,'Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trans_distribution d

		WHERE	t.trust_account_id = d.trust_account_id
				and d.gl_account_number = '110'
	            and exists ( select 1 from EPIC.eh_trans_distribution d2
	                         where d2.trust_account_trans_id = d.trust_account_trans_id
	                         	   and d2.gl_account_number = '503')
				and d.action_time >= v_min_date
				and d.action_time < v_max_date

		UNION ALL

        SELECT  2 as Flag,
				'Paid Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				substr(to_char(EPIC.ef_epic_date_to_date(d.action_time), EPIC.ef_date_format),1,100) as TDate,
				d.amount as Amount,
				'S' as Agency,
				decode(sign(d.amount),-1,'Y') as Reversal

        FROM	EPIC.eh_trust_account t,
        		EPIC.eh_trans_distribution d

        WHERE	t.trust_account_id = d.trust_account_id
        		and d.gl_account_number = '203'
           		and not exists ( select 1 from EPIC.eh_trans_distribution d2
                	             where d2.trust_account_trans_id = d.trust_account_trans_id
                     		           and d2.gl_account_number = '503')
           		and d.action_time >= v_min_date
           		and d.action_time < v_max_date

		ORDER BY Flag, TDate, InmateNum;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_paidBookFees2
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			EPIC.eh_trans_distribution.action_time%type,
	 	p_EndDate       in         	EPIC.eh_trans_distribution.action_time%type)

IS

    v_min_date		EPIC.eh_trans_distribution.action_time%type;
	v_max_date		EPIC.eh_trans_distribution.action_time%type;
    v_date_from		EPIC.epic_col_types.varchar_255%type;
 	v_date_to		EPIC.epic_col_types.varchar_255%type;
	v_date_null		date;
 	--must be same datatype as declarations above so WHERE clause doesn't fail

BEGIN

	v_min_date	:= EPIC.ef_min_date(p_StartDate);
	v_max_date	:= EPIC.ef_max_date(p_EndDate);
	v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
	v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
	v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information
		SELECT	1 as Flag,
				'Charged Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency,
				'' as Reversal
		FROM	dual

		--the below query pulls back the actual report data
		UNION ALL

		SELECT	2 as Flag,
				'expense account 502' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				'C' as Agency,
				tat.reverse_flag as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	t.trust_account_id = tat.trust_account_id
				and tat.code_source_of_funds = '502'
				and tat.trans_date >= v_min_date
				and tat.trans_date < v_max_date

		UNION ALL

		SELECT	3 as Flag,
				'initial payment to account 502' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(d.action_time) as TDate,
				(d.amount) * -1 as Amount,
				'C' as Agency,
				decode(sign(d.amount),1,'Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trans_distribution d

		WHERE	t.trust_account_id = d.trust_account_id
				and d.gl_account_number = '110'
	            and exists ( select 1 from EPIC.eh_trans_distribution d2
	                         where d2.trust_account_trans_id = d.trust_account_trans_id
	                         	   and d2.gl_account_number = '502')
				and d.action_time >= v_min_date
				and d.action_time < v_max_date

		UNION ALL

        SELECT  4 as Flag,
				'payments to liability account 202' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(d.action_time) as TDate,
				d.amount as Amount,
				'C' as Agency,
				decode(sign(d.amount),-1,'Y') as Reversal

        FROM	EPIC.eh_trust_account t,
        		EPIC.eh_trans_distribution d

        WHERE	t.trust_account_id = d.trust_account_id
        		and d.gl_account_number = '202'
           		and not exists ( select 1 from EPIC.eh_trans_distribution d2
                	             where d2.trust_account_trans_id = d.trust_account_trans_id
                     		           and d2.gl_account_number = '502')
           		and d.action_time >= v_min_date
           		and d.action_time < v_max_date

		UNION ALL

		SELECT	5 as Flag,
				'expense account 503' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				'S' as Agency,
				tat.reverse_flag as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trust_account_trans tat

		WHERE	t.trust_account_id = tat.trust_account_id
				and tat.code_source_of_funds = '503'
				and tat.trans_date >= v_min_date
				and tat.trans_date < v_max_date

		UNION ALL

		SELECT	6 as Flag,
				'initial payment to account 503' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(d.action_time) as TDate,
				(d.amount) * -1 as Amount,
				'S' as Agency,
				decode(sign(d.amount),1,'Y') as Reversal

		FROM	EPIC.eh_trust_account t,
				EPIC.eh_trans_distribution d

		WHERE	t.trust_account_id = d.trust_account_id
				and d.gl_account_number = '110'
	            and exists ( select 1 from EPIC.eh_trans_distribution d2
	                         where d2.trust_account_trans_id = d.trust_account_trans_id
	                         	   and d2.gl_account_number = '503')
				and d.action_time >= v_min_date
				and d.action_time < v_max_date

		UNION ALL

        SELECT  7 as Flag,
				'payments to liability account 203' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				EPIC.ef_offender_id(t.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(t.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(d.action_time) as TDate,
				d.amount as Amount,
				'S' as Agency,
				decode(sign(d.amount),-1,'Y') as Reversal

        FROM	EPIC.eh_trust_account t,
        		EPIC.eh_trans_distribution d

        WHERE	t.trust_account_id = d.trust_account_id
        		and d.gl_account_number = '203'
           		and not exists ( select 1 from EPIC.eh_trans_distribution d2
                	             where d2.trust_account_trans_id = d.trust_account_trans_id
                     		           and d2.gl_account_number = '503')
           		and d.action_time >= v_min_date
           		and d.action_time < v_max_date

		ORDER BY Flag, TDate, InmateNum;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ParoleViolator
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ54
	Crystal: 		paroleviolator.rpt
	Purpose:		Sent by the Jail Office to the Parole office daily for their use
					to track inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created
					dlk			01/06/05		created for test added to the tree
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'  
					R. Stuve	05/30/05		Compiled in OTMAIN 
					M.Zak       03-06-06        Removed Booking Date and Time per Sgt Roberts
												Removed eh_Booking table 
												Use offense date = Charge Booked date on Charge Tab
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Parole Violators)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as MDOC,
				--v_date_null as BookingDate,
				--'' as BookingTime,
				'' as Cell,
				'' as Bin,
				 v_date_null as OffDate  -- offense date
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Parole Violators)' as RptTitle,
				epic.ef_offender_id(ab.entity_id) as InmateNum,
				epic.ef_get_personororgname(ab.entity_id) as InmateName,
		 		mcmb_fnt_mdoc(ab.entity_id) as MDOC,
				epic.ef_offender_cell(ab.entity_id) as Cell,
				mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				epic.ef_epic_date_to_date(c.offense_date) as offdate  --offense date  -- used instead of booking per Sgt Roberts 3-6-06
			
		FROM	epic.eh_active_booking ab,
	 			epic.eh_charge c
		  	

		WHERE	ab.booking_id = c.booking_id
				and c.charge_state != 6
         		and mcmb_fnt_inmatestatus(c.charge_id) = 'PAROLE VIOLATOR'

		ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ParoleViolators_Fin
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			epic.eh_booking.start_date%type,  
	 	p_EndDate       in          epic.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY70
	Crystal: 		ParoleViolators_Fin.rpt
	Purpose:		Used by Finance to list Parole Violators total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-24-05		Created   (orig use custody status (Glen Sopfe)
					M.Zak		08-30-05        Modified   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					M.Zak & K.Heinz  12/04/09   Modified to only search 2 years back  from start date 
					K.Heinz         12/16/09                     This version compiled on OTMAIN  and saved in OTMAIN Production folder  - previous version backed up to ...Offendertrak Reporting\Procedures\Archive\MACOMB OTMAIN Procedures    
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
        v_min_date		epic.eh_booking.start_date%type;  
		v_max_date		epic.eh_booking.start_date%type;  
     	v_date_from		epic.eh_booking.start_date%type;
 		v_date_to		epic.eh_booking.start_date%type;
		v_date_null		date;		
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(p_StartDate);   --minimum time  for Start date entered (00:00)
		v_max_date	:= epic.ef_max_date(p_EndDate); --p_EndDate; use < and > when comparing in where clause
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100); 
		v_date_null	:= null; 
		--  Next line added for TC 59319
        v_2yr := to_char(to_date(epic.ef_epic_date_to_date(p_StartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ;
     
      
	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - Parole Violators' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
			  	v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

--Parole Violators with in selected date range 
SELECT	2 as Flag,
			'Finance - Parole Violators' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			epic.ef_get_personororgname(b.entity_id) as InmateName,
			epic.ef_offender_id(b.entity_id) as InmateNum,
		 	mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate        		                                                                   		
  
	FROM	epic.eh_booking b,
	        epic.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and mcmb_fnt_inmatestatus(c.charge_id) = 'PAROLE VIOLATOR'      
			and mcmb_fnt_code_chargestatus(c.charge_id) = '18'   --this line replaces line above for TC 59319   12/3/09 KJH                
            and b.start_date > v_2yr  --MAZ change for TC 59319
            
            and (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) > epic.ef_epic_date_to_date(v_min_date) and epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id))< epic.ef_epic_date_to_date(v_max_date)
                  OR epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(v_min_date) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) < epic.ef_epic_date_to_date(v_max_date)
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) < epic.ef_epic_date_to_date(v_min_date) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(v_max_date))
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) <  epic.ef_epic_date_to_date(v_max_date) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id))is null))            


 ORDER BY  Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_PostArraignDist
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ53
	Crystal: 		postarraigndist.rpt
	Purpose:		Used by the Jail Office to track the length between court dates for
					inmates

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created    
					dlk			12/28/04		Created Crystal rpt
					dlk			12/29/04		added to tree test
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Post-Arraignment District Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Charge
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Post-Arraignment District Court)' as RptTitle,
				epic.ef_offender_id(ab.entity_id) as InmateNum,
				epic.ef_get_personororgname(ab.entity_id) as InmateName,
				cs.case_number as DocketNum,
				ca.judge_name as Judge,
				epic.ef_offender_cell(ab.entity_id) as Cell,
				mcmb_fnt_chargedesc(c.statute_id) as Charge

		FROM	epic.eh_active_booking ab,
				epic.eh_charge c,
				epic.eh_case_charge a,
				epic.eh_court_appearance ca,
				epic.eh_case cs

		WHERE	ab.booking_id = c.booking_id
				and c.charge_id = a.charge_id
				and a.case_id = ca.owner_id (+)
				and cs.case_id (+) = a.case_id
				and mcmb_fnt_inmatestatus(c.charge_id) = 'POST-ARRAIGNMENT DISTRICT'
				and c.charge_state != 6

		ORDER BY Flag, InmateName, Judge;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_PreArraignCirc
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ50
	Crystal: 		prearraigncirc.rpt
	Purpose:		Used by the Jail Office: sent to all Circuit Courts and Probation Dept
					to be used to call for inmates due for court on the specified date

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/22/04		Created  
					dlk			12/29/04		added to the tree test 
					R. Stuve	01/25/05		Added Charge
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN     
					M.Zak       03/03/06        Added 'POST-ARRAIGNMENT DISTRICT' for indicator "D" = also in District(Crystal Report)
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Pre Arraignment Circuit Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				'' as DistFlag
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Pre Arraignment Circuit Court)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmchrgstat(ab.entity_id,'PRE-ARRAIGNMENT DISTRICT' ) as DistFlag

	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id 
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) ='PRE-ARRAIGNMENT CIRCUIT COURT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_PreArraignDist
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ51
	Crystal: 		prearraigndist.rpt
	Purpose:		Used by the Jail Office: sent to all District Courts to be used to 
					call for inmates due for court on the specified date

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	12/23/04		Created 
					dlk			12/29/04		added to the tree test 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	04/23/05		Compiled on OTMAIN
					R. Stuve	06/16/05		Added Warrant# and Arrest Reason   
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Pre Arraignment District Court)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				0 as Funds,
				'' as ControlAgy,
				0 as Bond,
				'' as Holds,
				'' as Charge,
				'' as WarrantNum,
				'' as ArrestReason
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Pre Arraignment District Court)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,
			ca.judge_name as Judge,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
			MACOMB.mcmb_fnt_inmatefunds(ab.entity_id) as Funds,
			MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,
			to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bond,
			MACOMB.mcmb_fnt_Holds(ab.entity_id) as Holds,
			MACOMB.mcmb_fnt_chargedesc(c.statute_id) as Charge,
			c.arrest_number as WarrantNum,
			MACOMB.mcmb_fnt_arresttype(c.charge_id) as ArrestReason
	
	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_case_charge a,
			EPIC.eh_court_appearance ca,
			EPIC.eh_case cs
	
	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'PRE-ARRAIGNMENT DISTRICT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ProbViol_CC
	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.YY36
	Crystal: 		probviolcc.rpt
	Purpose:		Used by Community Corrections to determine which inmates have been
					incarcerated for Probation Violation

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/05/05		Created 
					R. Stuve	04/22/05		Linked to Report Tree 
					R. Stuve	05/28/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION 
					R. Stuve	04/10/06		Changed address function to address_city function
*/
	v_date_null date;
			
BEGIN 

	v_date_null := null; 
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT 	1 as Flag,
				'Incarcerated for Probation Violation' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Race,
				'' as Gender,
				'' as ChargeNum,
				'' as ChargeName,
				'' as CourtDate,
				'' as ChargeState,
				0 as Bond,
				v_date_null as ChargeDisp,
				0 as SentencedMonths,
				0 as SentencedDays,
				'' as City,
				'' as Judge
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT 	2 as Flag,
			'Incarcerated for Probation Violation' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
	        MACOMB.mcmb_fnt_race(ab.entity_id) as Race,
	        MACOMB.mcmb_fnt_gendershort(ab.entity_id) as Gender,
	        MACOMB.mcmb_fnt_statutenumber(c.charge_id) as ChargeNum,
	        MACOMB.mcmb_fnt_statutetext(c.charge_id) as ChargeName,
	  		decode(MACOMB.mcmb_fnt_CourtDate(c.charge_id),null,'TBA',to_char(EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_CourtDate(c.charge_id)), 'MM/DD/YYYY')) as CourtDate,
	        	--above line inserts 'TBA' when no court date is scheduled
	        	--due to the mix of dates and strings per above, dates in this field are formatted as a string
	        MACOMB.mcmb_fnt_inmatestatus(c.charge_id) as ChargeState,
	        	--above line returns charge state (Sentenced, Pre-Arraignment, etc)
	        to_number(MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as Bond, 
	        	--above line returns bond amount (if entered).  If not entered, returns '0'
	       	EPIC.ef_epic_date_to_date(s.sentence_end_date) as ChargeDisp,
				--date the single charge can be disposed (expected end-date on Sentences tab)
	        sd.months as SentencedMonths,
	        	--number of sentenced months
	        sd.days as SentencedDays,
	        	--number of sentenced days
	  		MACOMB.mcmb_fnt_address_city(ab.entity_id) as City, 
	  			--inmate's resident city
	       	MACOMB.mcmb_fnt_JudgeName_ChargeID(c.charge_id) as Judge
	        	--judge's initials: for grouping--doesn't need to be displayed on report in column
	
	FROM 	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd
	
	WHERE 	ab.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
		   	and c.arrest_reason = 'PV'
		   	and c.charge_state != '6'

ORDER BY Flag, Judge, InmateName;
     	
END;
/

CREATE OR REPLACE
procedure MACOMB.Mcmb_Rpt_PropBins(
          vCur 	OUT           epic.epp_generic_ref_cursor.ref_cursor

)
is
-- Report Name: Property Bins - Filled (JAIL/314) 
-- Create Date: 07/2004
-- Created by : JGORSKI	
/*	
	System: 		Unknown
	Purpose:		

	Author:			JGORSKI
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

begin

	      open vCur for
	     
select  epic.ef_offender_id(ep.entity_id) as "Inmate #",
		epic.EF_GET_PERSONORORGNAME(ep.entity_id) as "Name",
		epic.ef_location_name(ha.location_id,'uc') as "Cell",
		mcmb_fnt_alphabin_current(ep.entity_id) as "Bin"

from    epic.eh_housing_assignments ha,
		epic.eh_entity_person ep

where   ha.entity_id (+) = ep.entity_id
and 	mcmb_fnt_alphabin(ep.entity_id) is not Null

order by 4;

end;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Psych
		(curPsych		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
   
 /*	Form Usage: 	CRSTL.XX52
	Crystal: 		pysch.rpt
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	11/16/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			12/15/04		Added to the tree - test 
					R. Stuve	12/28/04		Converted dates from string type to date type
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					R. Stuve	05/28/05		Compiled on OTMAIN	
					R. Stuve	06/12/05		Changed WHERE clause to like 'PSYCH%' from = 'PSYCH RX' to 
												encompass different transaction for trustees 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATION
	
*/
   
 v_date_null date;
 
 BEGIN
    
 v_date_null := null;
 
	OPEN curPsych FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Charge,
				v_date_null as BookingDate,
				v_date_null as LatestOutDate,
				'' as Holds,
				'' as MultiChrgs
		
		FROM	dual
		
	UNION ALL			    
		--the below query pulls back the actual report data
		SELECT	DISTINCT 2 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,		
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_housing(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphacharge (ab.booking_id) as Charge,
				EPIC.ef_epic_date_to_date(ab.action_time) as BookingDate,
  				EPIC.ef_epic_date_to_date(EPIC.ef_earliest_release_date(ab.booking_id)) as LatestOutDate,
    			MACOMB.mcmb_fnt_holds (ab.entity_id) as Holds,
    			MACOMB.mcmb_fnt_MultipleCharges(ab.entity_id) as MultiChrgs

		FROM	EPIC.eh_active_booking ab,
	  			EPIC.eh_trust_account t,
	  			EPIC.eh_trust_account_trans ta

		WHERE	ab.entity_id = t.entity_id
	  			and t.trust_account_id = ta.trust_account_id
	  			and ta.description like 'PSYCH%'
	  			and EPIC.ef_epic_date_to_date(ta.action_time) >= EPIC.ef_epic_date_to_date(ab.action_time)

		ORDER BY Flag, Cell, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Psych_wHolds
		(curPsych		OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
   
 /*	Form Usage: 	CRSTL.XX55
	Crystal: 		PyschWHolds_Main.rpt   (part 1 of 2) 
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs with Hold Data. Sorted by Flag(N, Y), Cell #, and then InamteName.

	Author:			Diana Kuykendall

	Change Log:		Changed By		Date Modified	Change Made
					----------		-------------	------------------------------------------
					D. Kuykendall	12/05/05		Created
					D. Kuykendall	12/07/05		loaded for testing
									12/09/05		determined that Latest Outdate was not correct. Function  (ef_earleist_release_
									12/09/05        date) replaced with mcmb_fnt_rel_date.  
					DLK             03/23/06        ADDED MACOMB AND EPIC NOTATION	
					R. Stuve		04/10/06		BookingDate incorrect: replaced with bk.start_date; returned final_release_date
													directly rather than use function (which returned same date)			
									                					
*/
   
 v_date_null date;
 
 BEGIN
    
 v_date_null := null;
 
	OPEN curPsych FOR
 		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as Charge,
				v_date_null as BookingDate,
				--'' as LatestOutDate,
				v_date_null as LatestOutDate,
				'' as Holds,
				'' as MultiChrgs,
				'' as EntityID
		
		FROM	dual
		
	UNION ALL			    
		--the below query pulls back the actual report data
		SELECT	DISTINCT 2 as Flag,
				'Community Corrections Psych Possible Deferment' as RptTitle,		
				EPIC.ef_offender_id(ab.entity_id) as Inmate#,
				EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
				EPIC.ef_offender_housing(ab.entity_id) as Cell,
				MACOMB.mcmb_fnt_alphacharge(bk.booking_id) as Charge,
				EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
  				--ef_epic_date_to_date(ef_earliest_release_date(ab.booking_id)) as LatestOutDate,  --Returns incorrect date
  				EPIC.ef_epic_date_to_date(bk.final_release_date) as LatestOutDate, --dlk   
    			MACOMB.mcmb_fnt_holds (ab.entity_id) as Holds,
    			MACOMB.mcmb_fnt_MultipleCharges(ab.entity_id) as MultiChrgs,
    			ab.entity_id as EntityId

		FROM	EPIC.eh_active_booking ab,
	  			EPIC.eh_trust_account t,
	  			EPIC.eh_trust_account_trans ta,
	  			EPIC.eh_charge ch,     --dlk   to allow new function to process
	  			EPIC.eh_booking bk     --dlk   to allow new function to process

		WHERE	ab.entity_id = t.entity_id
	  			and t.trust_account_id = ta.trust_account_id
	  			and ta.description like 'PSYCH%'
	  			and EPIC.ef_epic_date_to_date(ta.action_time) >= EPIC.ef_epic_date_to_date(ab.action_time) 
	  			and ab.entity_id = bk.entity_id
	  			and bk.booking_id = ch.booking_id

		ORDER BY Flag, Cell, InmateName;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_PV_Fin_sch
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor) 
		
IS  
/*	 	
	Purpose:		Used by Finance to list Parole Violators total days (total days * daily rate)
	                within a specfied month period  - this version is for the scheduler on Crystal Enterprise, it will  be set to run on the first Monday
	                of each month, and use the run date to determine the start and end dates of previous month.
					
	Author:			K. Heinz
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------  			
					K.Heinz 12/07/09 ParoleViolators_fin copied to create this scheduling version   
*/  
		vStartDate      epic.eh_booking.start_date%type; 
		vEndDate        epic.eh_booking.start_date%type; 
        v_min_date		epic.eh_booking.start_date%type;  
		v_max_date		epic.eh_booking.start_date%type;  
     	v_date_from		epic.eh_booking.start_date%type;
 		v_date_to		    epic.eh_booking.start_date%type;
		v_date_null		date;		
		v_2yr            varchar2(8);
 					
BEGIN --variables vStartDate and vEndDate added for SRF 16306 - KJH
        --vStartDate := epic.ef_epic_date_to_date(epic.ef_min_date(epic.epicdate((add_months((last_day(sysdate)+1),-2))))); 
        --vEndDate := epic.ef_epic_date_to_date(epic.ef_max_date(epic.epicdate(add_months(Last_Day(sysdate),-1))));       
        vStartDate := epic.ef_min_date(epic.epicdate((add_months((last_day(sysdate)+1),-2)))); --  to determine first day of previous month
        vEndDate := epic.ef_max_date(epic.epicdate(add_months(Last_Day(sysdate),-1))); --midnight of first day of current month        
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(vStartDate), epic.ef_date_format),1,100); 	
		v_date_to := substr(to_char((epic.ef_epic_date_to_date(vEndDate) -1), epic.ef_date_format),1,100);		 
		v_date_null	:= null;                                                                                                                  
		--  Next line added for TC 59319
        v_2yr := to_char(to_date(epic.ef_epic_date_to_date(vStartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ;      
      
	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - Parole Violators' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,  
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
			  	v_date_null as DayOutDate
				            				
		FROM	dual
		
	UNION ALL			              	
		--the below query pulls back the actual report data
SELECT	2 as Flag,
			'Finance - Parole Violators' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			epic.ef_get_personororgname(b.entity_id) as InmateName,
			epic.ef_offender_id(b.entity_id) as InmateNum,
		 	mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate       		                                                                   		
  
	FROM	epic.eh_booking b,
	        epic.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and mcmb_fnt_inmatestatus(c.charge_id) = 'PAROLE VIOLATOR'                  
            and b.start_date > v_2yr
			and mcmb_fnt_code_chargestatus(c.charge_id) = '18'   --this line replaces mcmb_fnt_inmatestatus for TC 59319   12/3/09 KJH             
            and (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id))< epic.ef_epic_date_to_date(vEndDate)
                  OR epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) < epic.ef_epic_date_to_date(vEndDate)
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) < epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vEndDate))
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) <  epic.ef_epic_date_to_date(vEndDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY  Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_PyschHolds_sub
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.XX56
	Crystal: 		PyschHolds_sub.rpt (Sub Report: of PsychWHolds) PART 2 OF 2
	Purpose:		To locate current inmates who are receiving psych meds for referral to 
					possible Mental Health deferral programs with Hold Data
						
	Author:			Diana Kuykendall

	Change Log:		Changed By	    Date Modified	Change Made
					----------	    -------------	------------------------------------------
					D. Kuykendall	12/02/05		Created  
					DLK             03/23/06        ADDED MACOMB AND EPIC NOTATION
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and EPIC.ef_epic_date_to_date(bh.hold_removed_date) is null
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
procedure MACOMB.mcmb_rpt_reimburse_booking
 	(p_cursor		in out		EPIC.epp_generic_ref_cursor.ref_cursor)
is


--	This report is custom to Macomb County.  It is to be run hoursly (URP)
--  and will show any inmates who have been booked over the past x hours
--  who show an outstanding balance in the reimbursement attribute fields.

--DLK      03/23/06         ADDED MACOMB AND EPIC NOTATION               


	v_result		number(9,0);
	v_result_msg	varchar2(255);       
	v_hours			number(9,0);
	v_start_date	varchar2(20);


begin                                   

	-- get the configurable period.  This indicates how far back the
	-- report should look for new bookings.
	EPIC.ep_get_configuration_value('REIMBURSEMENT', 'REPORT PERIOD HOURS', v_hours, '6', v_result, v_result_msg);
	
	-- calculate the start date
	v_start_date := EPIC.ef_epic_add_hours(EPIC.epicdatenow(), - v_hours);
	
	-- execute the query.  Since this is a custom report, assume that the title, etc. are
	-- hardcoded in the Crystal report file.	


	Open p_cursor for
		select 	EPIC.ef_epic_date_to_date(bk.start_date) as start_date,
				substr(EPIC.ef_get_personororgname(bk.entity_id),1,255) as name,
				substr(EPIC.ef_offender_id(bk.entity_id),1,255) as inmate_id,
				ga.attribute_name as attr_name,
				ga.attribute_value as attr_value
		from
			EPIC.eh_booking bk,
			EPIC.eh_generic_attribute ga,
			EPIC.eh_trust_account ta
		where 
			EPIC.ef_epic_date_to_date(bk.start_date) > EPIC.ef_epic_date_to_date(v_start_date)
			and bk.entity_id = ta.entity_id
			and ta.trust_account_id = ga.item_id
			and ga.attribute_name like '%REIMBURSEMENT%'
			and ga.attribute_value is not null
			and ga.attribute_value > '0'
			and not exists
			(select 1 from EPIC.eh_trust_account ta2
			where ta.entity_id = ta2.entity_id
			and EPIC.ef_epic_date_to_date(ta2.date_created) > EPIC.ef_epic_date_to_date(ta.date_created))	
		order by 1;
		
	return;
	
end;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ReimRel
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in			epic.eh_booking.start_date%type,
		p_EndDate		in			epic.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.XX40
	Crystal: 		ReimbAntRelease.rpt
	Purpose:		Used by the Reimbursement Office to list inmates with sentence end dates within the
					selected date range to determine who may be eligible to be included in a class action 
					lawsuit for reimbursement

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/15/05		Created 
	                M.Zak       07/18/05        Linked to otmain
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
		v_min_date		epic.eh_booking.start_date%type; 
		v_max_date		epic.eh_booking.start_date%type;
 		v_date_from	  	epic.eh_booking.start_date%type; 
 		v_date_to		epic.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= epic.ef_min_date(p_StartDate); 
		v_max_date	:= epic.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  := substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				'' as Address,
				'' as SSN,
				v_date_null as SentenceStart,
				v_date_null as SentenceEnd,
				0 as SentDays
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Reimbursement Anticipated Releases' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				epic.ef_offender_id(b.entity_id) as InmateNum,
				epic.ef_get_personororgname(b.entity_id) as InmateName,
				mcmb_fnt_address_numstr(b.entity_id) ||', '|| mcmb_fnt_address_city(b.entity_id) ||', '||mcmb_fnt_address_state(b.entity_id) ||', '||mcmb_fnt_address_postal(b.entity_id) as Address,
				mcmb_fnt_socsec(b.entity_id) as SSN,
				epic.ef_epic_date_to_date(s.sentence_start_date) as SentenceStart,
				epic.ef_epic_date_to_date(s.sentence_end_date) as SentenceEnd,
				round(epic.ef_epic_date_to_date(s.sentence_end_date) - epic.ef_epic_date_to_date(s.sentence_start_date)) as SentDays

		FROM	epic.eh_booking b,
				epic.eh_charge c,
				epic.eh_sentence s
		
		WHERE	b.booking_id = c.booking_id
				and c.sentence_id = s.sentence_id
				and s.sentence_end_date >= v_min_date
				and s.sentence_end_date <= v_max_date
		
		ORDER BY Flag, InmateName, SentenceEnd;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_RelTrustees
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_booking.start_date%type,
		p_EndDate		in		EPIC.eh_booking.start_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX43
	Crystal: 		RelTrustees.rpt
	Purpose:		Used by the Reimbursement billings to lists inmates who have already been
					physically released during the selected dates and have had a custody status (trustees)
					of Kitchen Trustee (white)(code=6), , or Trustee (Orange)(code= 9)

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak       10-13-05        Created procedure and report
         			M.Zak       10-19-05        Special Trustee (green)(code= 10) removed per Sgt Roberts
                                                Added pre-Kitchen Trustee (code = 65) 
                    dlk         03/23/06        added macomb and epic notation                            
*/				
	
		v_min_date		EPIC.eh_booking.start_date%type; 
		v_max_date		EPIC.eh_booking.start_date%type;
 		v_date_from	  	EPIC.eh_booking.start_date%type; 
 		v_date_to		EPIC.eh_booking.start_date%type;
 		v_date_null		date;
		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN  

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  := substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100);
		v_date_null := null;
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Released Trustees - Historical' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateID,
				'' as InmateName,
				v_date_null as ReleaseDate,
				'' as Custody_Status,
				v_date_null as CS_start_date,
				v_date_null as CS_end_date				
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data		
		SELECT	2 as Flag,
	         	'Released Trustees - Historical' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
                EPIC.ef_offender_id(b.entity_id) as InmateID,
                EPIC.ef_get_personororgname(b.entity_id) as InmateName,
				EPIC.ef_epic_date_to_date(r.actual_release) as ReleaseDate,
			 	MACOMB.mcmb_fnt_custody_status_desc(bcs.code_custody_status) as Custody_Status,
			 	EPIC.ef_epic_date_to_date(bcs.date_start) as CS_start_date,
			 	EPIC.ef_epic_date_to_date(bcs.date_end) as CS_end_date
            			
			FROM  	EPIC.eh_booking  b,
		  			EPIC.eh_release r,
		  			EPIC.eh_booking_custody_status bcs

			WHERE  	b.booking_id = r.booking_id
			        and b.booking_id = bcs.booking_id
			        and bcs.code_custody_status in ('6','65','9')  -- replaced 10 with 65 10-19-05
			        and EPIC.ef_epic_date_to_date(r.actual_release) >= v_min_date 
			        and EPIC.ef_epic_date_to_date(r.actual_release) <= v_max_date
			        
			ORDER BY Flag, ReleaseDate, InmateID; 
			
END;			
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_residentfunds   (
          vCur OUT epic.epp_generic_ref_cursor.ref_cursor
)
is

/*	Form Usage: 	CRSTL.YY17
	Crystal: 		0DCCRYY170EPI001.rpt
	Purpose:		Used by the Reimbursement Office to list new inmates with previous reimbursement debt

	Author:			Motorola

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/23/05		Compiled on OTMAIN
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/	

BEGIN

OPEN vCur FOR
   SELECT
		' '	as	Offender_Ident,
		' '	as	Offender_Name,    
		' ' as Cell_Location,
		0   as 	current_balance,
		' '  as Last_Trans_Date,
		' ' as Last_Trans_Time,
		' ' as Last_Trans_Type,
		0   as Last_Trans_Amt
   FROM	DUAL
   UNION
        SELECT  Distinct
		epic.ef_offender_ident(book.Entity_ID)
				as 	Offender_Ident,   
		epic.ef_get_personororgname(book.Entity_ID)
			  	as 	Offender_Name,
		epic.ef_location_name (ua.location_id, 'UC') as Cell_Location, 
		nvl(ca.total_debits - ca.total_credits, 0) as current_balance,
		TO_CHAR(substr(epic.ef_epic_date_to_date(tat.action_time),1,10)) as Last_Trans_Date,
		substr (tat.action_time,9,5) as Last_Trans_Time,  
		tat.description as Last_Trans_Type,
		tat.amount as Last_Trans_Amt
		
		
	from
		   	epic.eh_active_booking book,
			epic.eh_chart_of_accounts ca,
			epic.eh_trust_account ta,
			epic.eh_Housing_assignments ua,
			epic.eh_trust_account_trans tat  
	where	book.entity_id = ta.entity_id
	  and	ca.trust_account_id = ta.trust_account_id
	  and   tat.trust_account_id = ca.trust_account_id  
      and	ca.gl_account_number = '110'
      and	book.Entity_ID = ua.Entity_ID
	  and   tat.transaction_number = (select max(transaction_number)
                 from epic.eh_trust_account_trans where
                 trust_account_id = ta.trust_account_id)
      order by cell_location
	;   


END mcmb_rpt_residentfunds;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_restriction
	(	curRest				OUT		EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
 /*	Form Usage: 	CRSTL.ZZ31 (Lockdown), CRSTL.ZZ32 (Commissary), CRSTL.ZZ33 (Visitors)
	Crystal: 		restlock.rpt (Lockdown), restcomm.rpt (Commissary), restvisits.rpt (Visitors)
	Purpose:		Lists name, number, and cell of inmates under the specified restriction

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/22/04		Added to the tree test  
					DLK			12/27/04		ADDED CHANGES TO FORMAT DATE FIELD
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	02/17/05		Added ef_min_date to sysdate in where clause 
					R. Stuve	04/23/05		Compiled on OTMAIN
	
*/   

v_date_null date;
 
 BEGIN
	
v_date_null := null;   
	
	OPEN curRest FOR 
			--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Restriction Report' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Floor,
				v_date_null as EndDate,
				'' as RestrictionCode			
		
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
		SELECT 	2 as Flag,
				'Restriction Report' as RptTitle,
				EPIC.ef_offender_id (r.entity_id) as InmateNum,
				EPIC.ef_get_personororgname (r.entity_id) as InmateName,
				EPIC.ef_location_name (h.location_id, 'UC') as Cell,
				substr(EPIC.ef_location_path_name(h.location_id,'UC',5),1,instr(EPIC.ef_location_path_name(h.location_id,'US',5),',',1)-1) as Floor,
				EPIC.ef_epic_date_to_date(end_date) as EndDate,
                r.code_restriction_type as RestrictionCode

		FROM 	EPIC.eh_entity_restriction r,
				EPIC.eh_housing_assignments h,
				EPIC.eh_muster m

		WHERE	h.entity_id (+) = r.entity_id
		AND		r.entity_id = m.entity_id
		AND		EPIC.ef_epic_date_to_date(r.end_date) >= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(EPIC.epicdate(sysdate)))
		AND		m.in_muster_flag = 'Y'

		ORDER BY Flag, EndDate, Cell;
	
END;   
--RAS
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_restrictiontest
	(	curRest				OUT		epic.epp_generic_ref_cursor.ref_cursor)
	 	--p_rest_type	in		epic.eh_entity_restriction.code_restriction_type%type)

IS
 
 /*	Form Usage: 	CRSTL.ZZ20 (Lockdown), CRSTL.ZZ21 (Commissary), CRSTL.ZZ22 (Visitors)
	Crystal: 		****.rpt (Lockdown), ***.rpt (Commissary), ***.rpt (Visitors)
	Purpose:		Lists name, number, and cell of inmates under the specified restriction

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/27/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/21/04		Added to the tree  test
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/   

v_date_null date;
 
 BEGIN
	
v_date_null := null;   
	
	OPEN curRest FOR 
			--the below query pulls back the header information
/*	   SELECT	1 as Flag,
				'Restriction Report' as RptTitle,
				--p_rest_type as RestType,
				' ' as Inmate#,
				' ' as InmateName,
				' ' as Cell,
				v_date_null as EndDate			
		
		FROM	dual
		
	UNION			
*/
		--the below query pulls back the actual report data	
		SELECT 	--2 as Flag,
				--' ' as RptTitle,
				--' ' as RestType,
				epic.ef_offender_id (r.entity_id) as Inmate#,
				epic.ef_get_personororgname (r.entity_id) as InmateName,
				epic.ef_location_name (h.location_id, 'UC') as Cell,
				epic.ef_epic_date_to_date(end_date) as EndDate,
                r.code_restriction_type as RestrictionCode
                
		FROM 	epic.eh_entity_restriction r,
				epic.eh_housing_assignments h,
				epic.eh_muster m

		WHERE	h.entity_id (+) = r.entity_id
		AND		r.entity_id = m.entity_id
		--AND		r.code_restriction_type = p_rest_type
		AND		epic.ef_epic_date_to_date (end_date) >= sysdate
		AND		m.in_muster_flag = 'Y'

		ORDER BY EndDate, Cell;
	
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ReviewDate
	( 	vCur 			out     epic.epp_generic_ref_cursor.ref_cursor,
		p_StartDate		in		epic.eh_security_classification.next_review_date%type)
IS
   
 /*	Form Usage: 	CRSTL.XX04
	Crystal: 		***.rpt
	Purpose:		Used by Classification to list the inmates due for a review on/before 
					the selected date

	Author:			John Gorski

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					J.Gorski	07/27/04		Created 
					R. Stuve	12/14/04		Added header information via union query,
												inmate type, DOB, NextReviewDate
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'	
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

	v_date_from		epic.eh_security_classification.next_review_date%type;
	v_null_date		date; 

BEGIN
         
	v_date_from	:= epic.ef_min_date(p_StartDate);
	v_null_date := null;

	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Classification Periodic Review' as RptTitle, 
				v_date_from as RptStart,
				'' as InmateNum,
				'' as InmateName,
				'' as InmateType,
				'' as Cell,
				'' as Class,
				v_null_date as DOB,
				v_null_date as NextReviewDate
			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Classification Periodic Review' as RptTitle,
			v_date_from as RptStart,
     		epic.ef_offender_id(ha.entity_id) as InmateNum,
      		epic.ef_get_personororgname(mu.entity_id) as InmateName,
      		decode(es.code_custody_status,
      			'1', 'R',
      			'2', 'F',
      			'3', 'P',
      			'4', 'W',
      			'5', 'WR',
      			'6', 'T',
      			'7', 'AW',
      			'9', 'T',
      			'10', 'T',
      			'12', 'WW',
      			'13', 'IT', 'B') as InmateType,
      		epic.ef_location_name(ha.location_id,'uc') as Cell,
 			epic.ef_offender_SecClass(mu.entity_id) as Class,
      		epic.ef_epic_date_to_date(epi.date_of_birth) as DOB,
      		epic.ef_epic_date_to_date(sc.next_review_date) as NextReviewDate

	FROM 	epic.eh_muster mu,
 			epic.eh_housing_assignments ha,
    		epic.eh_active_booking bk,
			epic.eh_security_classification sc,
			epic.eh_person_identity epi,
			epic.eh_entity_person ep,
			epic.eh_entity_status es

	WHERE	 mu.entity_id = ha.entity_id
			AND  ha.entity_id = bk.entity_id
			AND  bk.entity_id = ep.entity_id
			AND  es.entity_id = ep.entity_id
			AND epi.entity_id = ha.entity_id
			AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			AND sc.booking_id = bk.booking_id
			AND sc.next_review_date IS NOT NULL
			AND sc.next_review_date <= v_date_from
			AND NOT EXISTS
				(SELECT 1
				FROM epic.eh_security_classification sc2
				WHERE sc.booking_id = sc2.booking_id
				AND sc2.review_date > sc.review_date)

		ORDER BY Flag, NextReviewDate, InmateName;

      	
END;
/

CREATE OR REPLACE
Procedure MACOMB.mcmb_rpt_ReviewDateBackup
	(RPT_Not_Classified	IN OUT	epic.epp_generic_ref_cursor.ref_cursor,
	P_Form_usage		IN		epic.epic_form.Form_usage%type,
	P_UserID			In		epic.epic_user_names.user_int_id%type,
	p_Location			IN		epic.EPIC_LOCATIONS.LOCATION_ID%type,
	p_end_date			in		epic.eh_security_classification.next_review_date%type
)

--	12/16/04	Bob Meeks
--	Take the rpt_not_classified_proc and modify it for Macomb County.  Saving it as a new
--  report procedure and will use the same Crystal Report (ICL1_2_3_4.rpt), but will have its own form usage  

--	REPORT CREATED BY MOTOROLA: THIS IS A BACKUP COPY SAVED BY MACOMB
--	02/18/05 RAS                     
/*	
	System: 		Unknown
	Purpose:		

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/


AS
	lookup_code			constant varchar2(10) := 'CRSTL.';
	Form_usage			constant varchar2(10) := P_Form_usage;
	v_security_object	constant epic.epic_user_objects.object_code%type := lookup_code || P_Form_usage;

	Report_Title		epic.epic_col_types.varchar_255%type;
	Report_Version		epic.epic_col_types.varchar_255%type;
	InsititionName		epic.epic_col_types.varchar_255%type;
	EnterpriseName		epic.epic_col_types.varchar_255%type;
	PageBreak			epic.epic_col_types.varchar_255%type;
	f_Enterprise		epic.epic_col_types.varchar_255%type;
	f_Location			epic.epic_col_types.varchar_255%type;
	f_LocationID		epic.epic_col_types.varchar_255%type;
	f_Off_Ident_Col		epic.epic_col_types.varchar_255%type;

	p_result			number(9,0);
	p_result_msg		varchar2(255);
	v_review			epic.epic_configuration.config_value%type;
	n_review			integer;
--	v_review_date		epic.epic_col_types.varchar_255%type;
	v_next_review_date	epic.eh_security_classification.next_review_date%type;
	f_review_date		epic.epic_col_types.varchar_255%type;
	f_today_date		epic.epic_col_types.varchar_255%type;
	f_location_type		varchar2(255);

	v_modified_charges	epic.epic_configuration.config_value%type;
	v_new_charges     	epic.epic_configuration.config_value%type;
	v_new_holds			epic.epic_configuration.config_value%type;
	v_new_incidents		epic.epic_configuration.config_value%type;

BEGIN

	Report_Title	:=	substr(epic.ef_lookup_text ('REPORT TREE', lookup_code || Form_usage, 'IC'),1,255);
	Report_Version	:=	substr(epic.ef_ReportVersion (Form_usage),1,255);
	InsititionName	:=	substr(epic.ef_get_Licensee('ABOUT', 'LICENSEE'),1, 255);
	EnterpriseName	:=	substr(epic.ef_get_Enterprise, 1, 255);
	f_Off_Ident_Col	:=	substr(initcap(epic.ef_config_offender_id),1,200) || ':';

--	epic.ep_log_info(Report_Title, 'R', -1, Report_Title ||' Report_Version: ' || Report_Version);

	v_next_review_date := p_end_date;
--	f_review_date		:=	substr(to_char(epic.ef_epic_date_to_date(v_review_date), ef_date_format),1,100) ;
--	f_today_date		:=	substr(to_char(epic.ef_epic_date_to_date(epicdatenow), ef_date_format),1,100);
	f_today_date		:=	substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format),1,100) ;
	f_review_date		:=	substr(to_char(epic.ef_epic_date_to_date(epic.epicdatenow), epic.ef_date_format),1,100);


	-- determine which conditions should cause someone to appear on the
	-- report.  All of these default to N, which means the base report is the same
	-- as before.
--	ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE MODIFIED CHARGES', v_modified_charges, 'N', p_result, p_result_msg);
--	if v_modified_charges is null then
		v_modified_charges := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW CHARGES', v_new_charges, 'N', p_result, p_result_msg);
--	if v_new_charges is null then
		v_new_charges := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW HOLDS', v_new_holds, 'N', p_result, p_result_msg);
--	if v_new_holds is null then
		v_new_holds := 'Y';
--	end if;

--	epic.ep_get_configuration_value('CLASSIFICATION REPORT', 'INCLUDE NEW INCIDENTS', v_new_incidents, 'N', p_result, p_result_msg);
--	if v_new_incidents is null then
		v_new_incidents := 'Y';
--	end if;


	if Form_usage = 'ICX1' THEN		-- Enterprise Report
		f_LocationID	:=	epic.ef_get_EnterpriseID;
		f_location_type := 'ENTERPRISE';
	else
		f_LocationID	:=	p_Location;
	end if;

	if Form_usage = 'ICX2' then
		f_location_type := 'REGION';
	end if;
	if Form_usage = 'ICX3' then
		f_location_type := 'FACILITY';
	end if;
	if Form_usage = 'ICX4' then
		f_location_type := 'UNIT';
	end if;

	PageBreak	:=	epic.ef_Report_PageBreak(f_LocationID);
	f_Location	:=	substr(epic.ef_location_name(f_LocationID, ''),1,200);

	OPEN RPT_Not_Classified FOR
		SELECT
			1					as flag,	-- Page Header Section of Report
			Report_Title		as	Report_Title,
			Report_Version		as	Report_Version,
			InsititionName 		as	Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(f_LocationID),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			0					as	ChildLevel,
			' '					as 	ChildLocation,
			' '					as 	ChildType,
			' '					as 	Offender_Name,
			' '					as 	Offender_Ident,
			f_review_date		as 	Review_date1,
			f_today_date		as 	Review_date2,
			v_review			as	Review_Period,
			' '					as  dob,
			' '					as  secclass,
			' '					as  sortdate
		FROM DUAL
		UNION
		--
		--	the section below finds all persons on muster with active bookings
		--		who have NO classifications for the booking
		--
/*		SELECT  distinct
			2	as flag,
			'NO CLASSIFICATION'	as	Report_Title,
			' '	as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col			as	Offender_Ident_Col,
			f_Location				as 	Location_Name,
			substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
			PageBreak				as	PageBreak,
			nvl(peic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
									as	ChildLevel,
			substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
									as ChildLocation,
			substr(epic.ef_location_type_name(ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
									as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
									as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
									as 	Offender_Ident,
			' '						as 	Review_date1,
			' '						as 	Review_date2,
			' '						as  Review_Period
		from
			epic.EH_ACTIVE_BOOKING ab,
			epic.eh_muster em,
			epic.eh_Housing_assignments ua,
			epic.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID			--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.Entity_ID = ab.Entity_ID
			and	not exists (select 1
				from	epic.EH_SECURITY_CLASSIFICATION sc
				where	ab.BOOKING_ID = sc.BOOKING_ID)
		Union
*/
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at a subordinate location of the location parameter
		--
		SELECT  distinct
			3	as flag,
			'SCHEDULED'	as	Report_Title,
			' '	as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
								as	ChildLevel,
			substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
								as ChildLocation,
			substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
								as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(epic.ef_epic_date_to_date(sc.review_date), epic.ef_date_format),1,100)
								as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate
		from
			epic.eh_muster em,
			epic.EH_Housing_ASSIGNMENTS ua,
			epic.EH_ACTIVE_BOOKING ab,
			epic.EH_SECURITY_CLASSIFICATION sc,
			epic.epic_location_child elc
		where
				em.Entity_ID = ua.Entity_ID
			and	elc.child_location_id = ua.LOCATION_ID
			and	elc.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from epic.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
		Union
		--
		--	the section below finds all persons whose latest classification
		--	has a next review date within the specified period and who are housed
		--	at the location parameter
		--
		SELECT  distinct
			3					as flag,
			'SCHEDULED'					as	Report_Title,
			' '					as	Report_Version,
			substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
			f_Off_Ident_Col		as	Offender_Ident_Col,
			f_Location			as 	Location_Name,
			substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
			PageBreak			as	PageBreak,
			99					as	ChildLevel,
			' ' 				as ChildLocation,
			'HOUSED AT ' || f_location_type || ' LEVEL'					as ChildType,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
								as 	Offender_Name,
			substr(decode(
				epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
								as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
			substr(to_char(epic.ef_epic_date_to_date(v_next_review_date), epic.ef_date_format), 1,100) as 	Review_date2,
			substr(to_char(epic.ef_epic_date_to_date(sc.review_date), epic.ef_date_format),1,100)
								as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			sc.next_review_date as sortdate

		from
			epic.eh_muster em,
			epic.EH_Housing_ASSIGNMENTS ua,
			epic.EH_ACTIVE_BOOKING ab,
			epic.EH_SECURITY_CLASSIFICATION sc
		where
				em.Entity_ID = ua.Entity_ID
			and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
			and	em.entity_id = ab.entity_id
			and	ab.BOOKING_ID = sc.BOOKING_ID
			and	sc.review_date < v_next_review_date
			and not exists (select 1 from epic.eh_security_classification sc2
				where sc2.booking_id = sc.booking_id
				and sc2.action_time > sc.action_time)
			and (sc.next_review_date is not null and sc.next_review_date < v_next_review_date)
--				or (sc.next_review_date is null
--					and otkpp_review_date.next_review_date(sc.review_date, sc.classification, em.facility_id, n_review) < v_next_review_date))
   --******************************************************************
   --
   --                        Inmates at, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and not exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_new_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, modified charges
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'MODIFIED CHARGE(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_charge ch,
		epic.eh_security_classification sc,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	ch.booking_id = ab.booking_id
	  and   ch.action_time > sc.review_date
	  and   sc.booking_id = ab.booking_id
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and exists
	  		(select 1 from epicaudit.eh_charge ach
	  		 where ach.charge_id = ch.charge_id
	  		 and ach.action_time < sc.review_date)
	  and 'Y' = v_modified_charges		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_booking_holds hld,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_booking_holds hld,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.start_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_booking_holds hld,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and	sc.booking_id = ab.booking_id
	  and	hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, end dated holds
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'REMOVED HOLD(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_booking_holds hld,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	hld.booking_id = ab.booking_id
	  and   sc.booking_id = ab.booking_id
	  and   hld.hold_removed_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_holds		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates at, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(ua.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, ua.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, ua.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, ua.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, ab.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(ab.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_incident inc,
		epic.eh_incident_offender inco,
		epic.eh_security_classification sc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and	ua.location_id = f_LocationID	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
   --******************************************************************
   --
   --                        Inmates under, new incidents
   --
   --******************************************************************
   	union
   	Select distinct
		5	as flag,
		'NEW INCIDENT(S)'	as	Report_Title,
		' '	as	Report_Version,
		substr(epic.ef_location_path_name(ua.location_id, 'UC',5),1,255)	as  Institution,
		f_Off_Ident_Col		as	Offender_Ident_Col,
		f_Location				as 	Location_Name,
		substr(epic.ef_location_type_name(elc.location_id),1,200) as Location_Type,
		PageBreak			as	PageBreak,
		nvl(epic.ef_location_level(epic.ef_sub_location(em.Entity_ID, elc.location_id)), 99)
							as	ChildLevel,
		substr(epic.ef_sub_location_name(em.Entity_ID, elc.location_id), 1, 255)
				as ChildLocation,
		substr(epic.ef_location_type_name(epic.ef_sub_location(em.Entity_ID, elc.location_id)),1,200)
				as ChildType,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_get_personororgname(em.Entity_ID)), 1, 255)
				as 	Offender_Name,
		substr(decode(
			epic.ef_can_read(P_UserID, v_security_object, em.Entity_ID), 'N', epic.ef_suppressed_text(0),
				epic.ef_offender_ident(em.Entity_ID)), 1, 255)
				as 	Offender_Ident,
			substr(to_char(epic.ef_epic_date_to_date(sc.next_review_date), epic.ef_date_format), 1,100) as 	Review_date1,
		' '					as 	Review_date2,
		' '	as  Review_Period,
			substr(epic.ef_offender_dob(em.entity_id),1,255) as dob,
			substr(epic.ef_offender_secclass(em.entity_id), 1, 255) as SecClass,
			'1' as sortdate

	from
		epic.EH_ACTIVE_BOOKING ab,
		epic.eh_muster em,
		epic.eh_Housing_assignments ua,
		epic.eh_security_classification sc,
		epic.eh_incident inc,
		epic.eh_incident_offender inco,
		epic.epic_location_child elc
	where
	  		ab.Entity_ID = ua.Entity_ID
	  and	ab.entity_id = em.entity_id
	  and   elc.location_id = f_locationID
	  and	ua.location_id = elc.child_location_id	--'0FNTFZR010USJ095'	--Region: NORTH COUNTY
	  										--'0FNTG0V000USJ095'	--Facility: San Quentin
	  										--'0FNTG1M000USJ095'	--Unit: Block A
	  and 	inco.entity_id = ab.entity_id
	  and   inco.incident_id = inc.incident_id
	  and   sc.booking_id = ab.booking_id
	  and   inc.incident_date > sc.review_date
	  and not exists
	  		(select 1 from epic.eh_security_classification sc2
	  		 where sc2.booking_id = ab.booking_id
	  		 and	sc2.review_date > sc.review_date)
	  and 'Y' = v_new_incidents		-- this will effectively turn off this union (return no rows) unless
	  								-- the config item has been turned on.
	  order by 1, 19, 12;


exception
	when others THEN
		epic.ep_log_info(Report_Title, 'E', -1,
			sqlerrm || ' - ' || Report_Title || ' (' || Form_usage || ')');
		RETURN;
end ;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_ReviewRoster
 	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		EPIC.eh_security_classification.review_date%type,
		p_EndDate		in		EPIC.eh_security_classification.review_date%type)
	 	
IS

/*	Form Usage: 	CRSTL.XX06
	Crystal: 		reviewroster.rpt
	Purpose:		Used by Classification: Which inmate(s) had a review on the selected
					date and, as a result, his/her classification changed

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/15/05		Created
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'
					DLK			02/11/05		Added to report tree to test 
					R. Stuve	02/15/05		Added classification line to WHERE clause AND
												added SortingDate as a means to sort records
					R. Stuve	05/10/05		Added Interview flag
					R. Stuve	05/28/05		Compiled on OTMAIN     
					dlk         03/23/06         added macomb and epic notation
*/

		v_min_date		EPIC.eh_security_classification.review_date%type; 
		v_max_date		EPIC.eh_security_classification.review_date%type;
 		v_date_from	  	EPIC.eh_security_classification.review_date%type; 
 		v_date_to		EPIC.eh_security_classification.review_date%type;
		--must be same datatype as declarations above so WHERE clause doesn't fail									
			
BEGIN  
		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate)); 
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		--set value for variables used in query

	OPEN vCur FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Classification Review Roster' as RptTitle, 
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as Interview,
				'' as InmateName,
				'' as Cell,
				'' as NewClass,
				'' as Alerts,
				'' as PrevClass,
				'' as SortingDate					
		
		FROM	dual
		
UNION ALL			
		--the below query pulls back the actual report data														
	SELECT	2 as Flag,
			'Classification Review Roster' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_Interview(b.booking_id) as Interview,
				--flag to determine if inmate has had an interview completed or not
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
	 		EPIC.ef_offender_housing(b.entity_id) as Cell,
			EPIC.ef_lookup_text('SECURITY CLASSIFICATION',sc1.classification,'UC')as NewClass,
			MACOMB.mcmb_fnt_activealerts_trunc(b.entity_id) as Alerts,
			EPIC.ef_lookup_text('SECURITY CLASSIFICATION',sc2.classification,'UC') as PrevClass,
			sc1.review_date as SortingDate  --RAS: added 2/15 (not a date-type in database)

	FROM 	EPIC.eh_active_booking b,
			EPIC.eh_security_classification sc1,
			EPIC.eh_security_classification sc2

	WHERE	b.booking_id = sc1.booking_id
			and EPIC.ef_epic_date_to_date(sc1.review_date) >= v_min_date
			and EPIC.ef_epic_date_to_date(sc1.review_date) < v_max_date
			and sc1.booking_id = sc2.booking_id
			and EPIC.ef_epic_date_to_date(sc2.review_date) < EPIC.ef_epic_date_to_date(sc1.review_date)
			and sc1.classification <> sc2.classification --RAS: added 2/15
			and not exists
			(
			 select 1
			 from	EPIC.eh_security_classification sc3
		 	 where 	sc3.booking_id = sc2.booking_id
					and EPIC.ef_epic_date_to_date(sc3.review_date) < EPIC.ef_epic_date_to_date(sc1.review_date)
					and EPIC.ef_epic_date_to_date(sc3.review_date) > EPIC.ef_epic_date_to_date(sc2.review_date)
			)
			
ORDER BY Flag, InmateName, SortingDate desc;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Sentenced
	(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in		epic.eh_sentence.sentence_start_date%type,
		p_EndDate		in		epic.eh_sentence.sentence_start_date%type)
	 	
IS
 
/*	Form Usage: 	CRSTL.YY31
	Crystal: 		sentenced.rpt
	Purpose:		To list all inmates sentenced within the time period specified.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	09/21/04		Created 
					R. Stuve	12/13/04		Added header information via union query 
					dlk			01/11/05		Added to tree to test and title/date fields to query2	
					R. Stuve	01/31/05        Changed 'Union' to 'Union All'  
					R. Stuve	05/05/05		Changed where logic to exclude records with no sentence end date
												and/or disposed charges.  Also inserted functions to pull data
												instead of pulling directly from tables
					R. Stuve	06/16/05		Compiled on OTMAIN		
	                dlk 		02/08/06		Added Work Release Granted and Work seek Flag (Y/N)
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/
 		
		v_min_date		epic.eh_sentence.final_release_date%type;
 		v_max_date		epic.eh_sentence.final_release_date%type; 
 		v_date_from	  	epic.eh_sentence.final_release_date%type;
		v_date_to	   	epic.eh_sentence.final_release_date%type;
		v_date_null     date;                    
		--must be same datatype as declarations above so WHERE clause doesn't fail
 			
BEGIN
        
		v_min_date	:= 	epic.ef_min_date(p_StartDate);
		v_max_date	:= 	epic.ef_max_date(p_EndDate); 
		v_date_from	:=	substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to	:=	substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100);
		v_date_null :=  null;               
		--set value for variables used in query

	OPEN vCur FOR	
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Sentenced Report' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				' ' as Inmate#,
				' ' as InmateName,
				' ' as CaseNumber,
				' ' as Judge,
				0 as Months,
				0 as Days,
				v_date_null as Outdate,
				' ' as Charge,
				' ' as WK_WS --DLK
		
		FROM	dual
		
	UNION			
		--the below query pulls back the actual report data
		SELECT 	2 as Flag,
				'Sentenced Report' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				epic.ef_offender_id(b.entity_id) as Inmate#,
      			epic.ef_get_personororgname(b.entity_id) as InmateName,
      			mcmb_fnt_CaseNumber(ch.charge_id) as CaseNumber,
	      		mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge,
				nvl((select sd.months from epic.eh_sentence_duration sd
		    		where sd.sentence_duration_id = s.duration_id),
		    				(select sd.months from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id))  as Months,
			 	nvl((select sd.days from epic.eh_sentence_duration sd
		    		where sd.sentence_duration_id = s.duration_id),
		      				(select sd.days from epic.eh_sentence_fine sf, epic.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id))  as Days,
       			--to_char(substr(epic.ef_epic_date_to_date(s.sentence_end_date),1,10)) as Outdate,
       			epic.ef_epic_date_to_date(s.sentence_end_date) as Outdate,
       			mcmb_fnt_statutetext(ch.charge_id) as Charge,
                ga.attribute_value AS WK_WS --added per request SGT Roberts 02/08/06 --DLK
       			--ga.attribute_name as GAName  same as above added JIC future request --DLK
		
		FROM    epic.eh_booking b,
				epic.eh_sentence s,
				epic.eh_sentence_duration d,
				epic.eh_charge ch,
				epic.eh_generic_attribute ga

		WHERE	b.booking_id = ch.booking_id
		        and S.SENTENCE_ID = GA.ITEM_ID -- dlk
				and s.sentence_id = ch.sentence_id
				and d.sentence_duration_id (+) = s.duration_id
				and ch.charge_state != '6'
				and s.sentence_end_date is not null
				and s.sentence_start_date >= v_min_date
				and s.sentence_start_date < v_max_date

		ORDER BY Flag, Judge, InmateName;

END;     
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_SenttoPrison
	(vCaseStatus in            epic.eh_generic_attribute.attribute_name%type, 
	 vCur 	        out        epic.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.
	Crystal: 		****.rpt
	Purpose:		

	Author:			

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
			 		Jmcbrat		7/26/2005         Added in parameter
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/

	-- v_date_null date;

BEGIN 

--	v_date_null := null;
	
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Sentenced to Prison Awaiting Papers' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Charge
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	 2 as Flag,
				'Sentenced to Prison Awaiting Papers' as RptTitle,
				epic.ef_offender_id(ab.entity_id) as InmateNum,
				epic.ef_get_personororgname(ab.entity_id) as InmateName,
				epic.ef_offender_cell(ab.entity_id) as Cell,
				mcmb_fnt_chargedesc(c.statute_id) as Charge

		FROM	epic.eh_active_booking ab,
				epic.eh_charge c
		
		WHERE  	ab.booking_id = c.booking_id
				and mcmb_fnt_inmatestatus(c.charge_id) = vCaseStatus
				and c.charge_state != '6'
				
		ORDER BY Flag, InmateNum;            

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_SntToPrsn
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnAWPap.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
SELECT	distinct 'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,--'AW' as RecType,
			--'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON AWAITING PAPERS'
			and c.charge_state != 6
			
UNION ALL			                                        

		--the below query pulls back the actual report data	
	SELECT distinct 'Case Status (Sentenced to Prison Papers Here)' as RptTitle,--'PH'as RecType,
			--'Case Status (Sentenced to Prison Papers Here)' as RptTitle,
			epic. ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON PAPERS HERE'
			and c.charge_state != 6

	ORDER BY RptTitle, InmateName;   -- was RecType
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_SntToPrsn_AWPap
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnAWPap.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Sentenced to Prison Awaiting Papers)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON AWAITING PAPERS'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_SntToPrsn_PapH
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		SntToPrsnPapHere.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Sentenced to Prison Papers Here)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Sentenced to Prison Papers Here)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED TO PRISON PAPERS HERE'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_test   (
          vCur OUT epic.epp_generic_ref_cursor.ref_cursor
)
is

BEGIN

OPEN vCur FOR

       -- This is for the notes data.  The following will pull
        -- notes located in the eh_generic attribute table where
        -- another link to the epic_lookup table is needed to
        -- display the full text of the note (because a drop down
        -- list box was used to populate the comment in the OT screen

        --first SQL gives only the record that needs the lookup table text (where
          -- attribute_value is a number and needs the lookup table to disp the text    
        --the second SQL gives the note that does not need the lookup text 
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/

       SELECT DISTINCT
		epic.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		mcmb_fnt_alphabin(bk.entity_id) as Bin,
		epic.ef_location_name(ha.location_id,'uc') as Cell,
		epic.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(epic.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(epic.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(epic.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		epic.ef_offender_height(ep.entity_id) as Height,
		epic.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		epic.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as Description,
	    epi.entity_id as Entity_ID,
	    bk.booking_id as Booking_ID,
	    --added
	    ec.charge_id as Charge_ID,
	    ga.attribute_name as AttributeName,
	    ga.attribute_value as AttributeValue,
	    lu.text_full as FullText

	    FROM
		   epic.eh_housing_assignments ha,
				epic.eh_active_booking ab,
				epic.eh_booking bk,
				epic.eh_person_identity epi,
				epic.eh_entity_person ep,
				--added
				epic.eh_charge ec,
				epic.eh_generic_attribute ga,
				epic.epic_lookups lu

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND bk.booking_id = ec.booking_id
				AND ec.charge_id = ga.item_id
				--added to get the text for the attribute_value
				AND ga.attribute_name = lu.lookup_class
				AND ga.attribute_value = lu.sub_1



	 	UNION
        SELECT DISTINCT
		epic.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		mcmb_fnt_alphabin(bk.entity_id) as Bin,
		epic.ef_location_name(ha.location_id,'uc') as Cell,
		epic.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(epic.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(epic.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(epic.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		epic.ef_offender_height(ep.entity_id) as Height,
		epic.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		epic.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN,
		' ' as Hold_Type,
		' ' as Dept_Held_For,
		' ' as Severity,
		' ' as Hold_Start,
		' ' as Description,
	    epi.entity_id as Entity_ID,
	    bk.booking_id as Booking_ID,
	    --added
	    ec.charge_id as Charge_ID,
	    ga.attribute_name as AttributeName,
	    ga.attribute_value as AttributeValue,
	    ' ' as FullText

	    FROM
		   epic.eh_housing_assignments ha,
				epic.eh_active_booking ab,
				epic.eh_booking bk,
				epic.eh_person_identity epi,
				epic.eh_entity_person ep,
				--added
				epic.eh_charge ec,
				epic.eh_generic_attribute ga,
				epic.epic_lookups lu

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
				-- added
				AND bk.booking_id = ec.booking_id
				AND ec.charge_id = ga.item_id
				-- added to get the text for the attribute_value
				--AND ga.attribute_name <> lu.lookup_class
				--AND ga.attribute_value <> lu.sub_1
               AND ga.attribute_name not in (select distinct lookup_class
				              from epic.epic_lookups);
				              
		end;

/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_test1  (
          vCur OUT epic.epp_generic_ref_cursor.ref_cursor
			)
	is
 /*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
	

	BEGIN

	OPEN vCur FOR
 	  SELECT  
 	    ' ' as Name,
		' ' as Bin,
		' ' as Cell,
		' ' as Inmate_No,
		' ' as Alias,
		' ' as DOB,
		' ' as BirthState,
		' ' as Driver_License,
		' ' as Race,
		' ' as Gender,
		' ' as Height,
		' ' as Weight,
		' ' as Hair,
		' ' as L_Eye,
		' ' as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		' ' as Phone,
	    ' ' as SSN
	  
	 FROM DUAL 
	 UNION 
	  
 	  --inmate 020119 has no DL but Complexion record
      --0HYZMP9000XDPMIG
      --0HZE88K000USJ02O has holds on for his record        300171
	  SELECT DISTINCT
		epic.EF_GET_PERSONORORGNAME(bk.entity_id) as Name,
		mcmb_fnt_alphabin_current(bk.entity_id) as Bin,
		epic.ef_location_name(ha.location_id,'uc') as Cell,
		epic.ef_offender_id(ep.entity_id) as Inmate_No,
		' ' as Alias,
		TO_CHAR(substr(epic.ef_epic_date_to_date(epi.date_of_birth),1,10)) as DOB,
		rtrim(epic.ef_lookup_text('STATES', epi.BIRTH_STATE, '')) as BirthState,
		' ' as Driver_License,
		' ' as Race,
		rtrim(epic.ef_lookup_text('SEX', ep.code_gender, '')) as Gender,
		epic.ef_offender_height(ep.entity_id) as Height,
		epic.ef_offender_weight(ep.entity_id) as Weight,
		' ' as Hair,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_left, '')) as L_Eye,
		rtrim(epic.ef_lookup_text('EYE COLOUR', ep.code_eye_color_right, '')) as R_Eye,
		' ' as Complexion,
		' ' as Address,
		' ' as City,
		' ' as State,
		' ' as Zip,
		epic.ef_offender_phone(ep.entity_id) as Phone,
	    substr(epi.social_security_number, 1, 3) || '-' ||
		  substr(epi.social_security_number, 4, 2) || '-'
		  || substr(epi.social_security_number, 6, 4) as SSN
	    FROM
		   epic.eh_housing_assignments ha,
				epic.eh_active_booking ab,
				epic.eh_booking bk,
				epic.eh_person_identity epi,
				epic.eh_entity_person ep

		WHERE 	ha.entity_id (+) = ab.entity_id
				AND ep.entity_id (+) = ab.entity_id
				AND  bk.booking_id = ab.booking_id
				AND epi.entity_id = ab.entity_id
				AND ep.entity_id = '0I1NSEC000USJ05N' --'0HZE88K000USJ02O'
				AND DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
         
            ;
                
    END mcmb_rpt_test1;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_UnclArr
		(curUcAr		OUT	EPIC.epp_generic_ref_cursor.ref_cursor)

IS
 
/*	Form Usage: 	CRSTL.XX04
	Crystal: 		unclarr.rpt
	Purpose:		Used by Classification to locate inmates that have been arraigned 
					on at least one charge and have not yet been classified.

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	08/20/04		Created 
					R. Stuve	12/13/04		Added header information via union query	
					DLK			12/20/04		Added to report tree test
					R. Stuve	12/20/04		Changed BookingDate to date/time; removed other
												date/sorting fields.
					R. Stuve	01/31/05		Changed 'Union' to 'Union All'   
					R. Stuve	05/28/05		Compiled on OTMAIN  
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
     				S. Dunn     06/10/08        SRF #14507: Add Charge Status
*/
 v_date_null date;
 
 BEGIN
                  
 v_date_null := null;
 
	OPEN curUcAr FOR
		--the below query pulls back the header information
	   SELECT	1 as Flag,
				'Unclassified/Arraigned' as RptTitle,
				'' as Inmate#,
				'' as InmateName,
				'' as Cell,
				'' as InmateType,
                                '' as ChrgStatus,
				v_date_null as BookingDate,
				'' as BookingTime			
		
		FROM	dual
		
		UNION ALL			
		--the below query pulls back the actual report data	
			SELECT 	distinct 2 as Flag,
					'Unclassified/Arraigned' as RptTitle,			
					EPIC.ef_offender_id(ab.entity_id) as Inmate#,
  					EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
  					EPIC.ef_location_name(ha.location_id,'UC') as Cell,
  					decode(es.code_custody_status,	
  										'1','R',
  										--Regular
  										'2','F',
  										--Federal
  								 		'3','P',
  								 		--Parole
  										'4','W',
  										--Weekender
           								'5','WR',
           								--WorkRelease
                  						'6', 'KT',
                  						--Kitchen Trustee
                       					'7', 'AW', 
                       					--Alternative Weekend
                           				'9', 'GT',
                           				--Garage Trustee
                              			'10', 'ST',
                              			--Special Trustee
                                		'11', 'JS', 
                                		--Jail Sanction
                                 		'12', 'WW',
                                 		--Writ Witness
                                  		'13', 'T',
                                  		--In Transit
                                   		'14', 'SCC',
                                   		--St. Clair County
                                    	'15', 'LC',
                                    	--Lapeer County
                                    	'16', 'OC')  as InmateType,
                                    	--Oakland County 
                                EPIC.EF_LOOKUP_TEXT ('CHARGE STATUS',MACOMB.mcmb_fnt_Cust_Status(c.charge_id),'UC') as ChrgStatus,
  				EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
  				substr(EPIC.ef_epic_date_to_Date(bk.start_date),12,5) as BookingTime

		FROM 	EPIC.eh_entity_status es,
  				EPIC.eh_housing_assignments ha,
       		 	EPIC.eh_active_booking ab,
        		EPIC.eh_booking bk,
        		EPIC.eh_generic_attribute g,
        		EPIC.eh_charge c,
        		EPIC.eh_security_classification s

		WHERE 	ha.entity_id (+) = ab.entity_id
 				and ab.booking_id = bk.booking_id
  				and es.entity_id = bk.entity_id
  				and g.item_id = c.charge_id
  				and c.booking_id = bk.booking_id
  				and s.booking_id (+) = bk.booking_id
  				and g.attribute_name = 'CHARGE STATUS'
  				and g.attribute_value not in ('01', '04')
  				and s.classification is null

		ORDER BY Flag, BookingDate, BookingTime;
	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_usbp_fin_sch
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor		
	 	)  
	 	
IS

/*	Form Usage: 	 
	Crystal: 		UsBorderPatrol_Fin_sch.rpt
	Purpose:		Used by Finance to list US Boarder Patrol total days (total days * daily rate)
	                   within a specfied month period   - Scheduled to run the first Monday of every month, for the 
	                   previous months data
					
	Author:			K. Heinz, Altered mcmc_rpt_usbrdptrl_fin to create this scheduling version for SRF 16306
	
	Change Log:		Changed By	Date Modified	       Change Made
					----------	-------------	------------------------------------------
					        K. Heinz   January 27, 2010   Copied mcmc_rpt_usbrdptrl_fin to create this scheduling version for SRF 16306                               
					
*/
       --v_min_date		EPIC.eh_booking.start_date%type;  
		--v_max_date		EPIC.eh_booking.start_date%type;
		vStartDate		EPIC.eh_booking.start_date%type;
		vEndDate        EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null     date;
		v_2yr            varchar2(8);
		
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		--v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		--v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));		
		--v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		--v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		vStartDate := epic.ef_min_date(epic.epicdate((add_months((last_day(sysdate)+1),-2)))); --  to determine first day of previous month
        vEndDate := epic.ef_max_date(epic.epicdate(add_months(Last_Day(sysdate),-1))); --midnight of first day of current month        
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(vStartDate), epic.ef_date_format),1,100); 	
		v_date_to := substr(to_char((epic.ef_epic_date_to_date(vEndDate) -1), epic.ef_date_format),1,100);	
		v_date_null	:= null; 
		v_2yr := to_char(to_date(epic.ef_epic_date_to_date(vStartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ;        
        

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Border Patrol' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual 		
	UNION ALL			              	
		--the below query pulls back the actual report data 

SELECT	2 as Flag,
			'Finance - U.S. Border Patrol' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

           
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - BORDER PATROL'  
            and b.start_date > v_2yr			
            and mcmb_fnt_code_chargestatus(c.charge_id) = '31'   --this replaces mcmb_fnt_inmatestatus for TC 59319   12/3/09 KJH 
            and (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id))< epic.ef_epic_date_to_date(vEndDate)
                  OR epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) < epic.ef_epic_date_to_date(vEndDate)
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) < epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vEndDate))
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) <  epic.ef_epic_date_to_date(vEndDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id))is null)) 
          
 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_usbrdptrl_fin
 	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY71
	Crystal: 		UsBorderPatrol_Fin.rpt
	Purpose:		Used by Finance to list US Boarder Patrol total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS                                       
					KJH			03/12/2010      Added Alien number function for SRF 16598
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null     date;
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null; 
		--  Next line added for TC 59319
        v_2yr := to_char(to_date(epic.ef_epic_date_to_date(p_StartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Border Patrol' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate,
				'' as AlienNum --added 3/12/2010 for SRF 16598  KJH
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

-- US - BORDER PATROL with in selected date range 
SELECT	2 as Flag,
			'Finance - U.S. Border Patrol' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate,
       		MACOMB.mcmb_fnt_aliennum(b.entity_id) as AlienNum

           
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - BORDER PATROL'  
            and b.start_date > v_2yr			
            and mcmb_fnt_code_chargestatus(c.charge_id) = '31'   --this replaces mcmb_fnt_inmatestatus for TC 59319   12/3/09 KJH
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_UsedPropBins
	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ60
	Crystal: 		****.rpt
	Purpose:		Used by the Jail Office, Booking to list all used property bins

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/27/05		Created 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
*/

BEGIN
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Used Property Bins' as RptTitle,
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as Bin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		SELECT 	distinct 2 as Flag,
				'Used Property Bins' as RptTitle,
				EPIC.ef_offender_id(op.entity_id) as InmateNum,
				EPIC.ef_get_personororgname(op.entity_id) as InmateName,
				EPIC.ef_offender_cell(op.entity_id) as Cell,
				pb.bin_number as Bin

		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op
		
		WHERE	pb.bin_id = pi.bin_id
				and op.item_id = pi.item_id

		ORDER BY Flag, Bin;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_usimmigratn_fin
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY72
	Crystal: 		UsImmigratn_Fin.rpt
	Purpose:		Used by Finance to list US Immigration total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					M.Zak       09-26-05        Modified   Added 'US - IMMIGRATION & CUSTOM ENFORCEMENT' code 33
					                                       Glenn to end dated (IMMIGRATION/NATURALIZATION SERVICE)  
					dlk         03/23/06        added macomb and epic notations   
					M Zak       1/13/09         added Alien #                                                           				
					K Heinz     03/05/2010 for SRF 16306, added 2 year limitation to selection criteria to shorten the run time.
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date; 
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;
        v_2yr := to_char(to_date(epic.ef_epic_date_to_date(p_StartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ; 
        
	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate,
				'' as AlienNum
				            				
		FROM	dual
		
	UNION ALL           	

SELECT	2 as Flag,
			'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate,
       		MACOMB.mcmb_fnt_aliennum(b.entity_id) as AlienNum       		
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
			and b.start_date > v_2yr
			and mcmb_fnt_code_chargestatus(c.charge_id) in ('30', '33')
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            
          
           --KJH Code above exchanged for code below for SRF 16306*********************
 
           /*and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) in ('IMMIGRATION/NATURALIZATION SERVICE','US - IMMIGRATION & CUSTOM ENFORCEMENT')
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null)) */           

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_USINS_fin_sch
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor 
		)  
	 	
IS

/*	Form Usage: 	
	Crystal: 		USINS_Fin_sCH.rpt
	Purpose:		Used by Finance to list US Immigration total days (total days * daily rate)
	                within a specfied month period - this version for scheduling auto runs
					
	Author:			K. Heinz
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					K. Heinz		01/28/2010		Altered mcmb_rpt_usimmigratn_fin.sql to create this version				                                                           				
			
*/     
	
        vStartDate		EPIC.eh_booking.start_date%type;
		vEndDate        EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date; 
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		vStartDate := epic.ef_min_date(epic.epicdate((add_months((last_day(sysdate)+1),-2)))); --  to determine first day of previous month
        vEndDate := epic.ef_max_date(epic.epicdate(add_months(Last_Day(sysdate),-1))); --midnight of first day of current month 
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(vStartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(vEndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null; 
		v_2yr := to_char(to_date(epic.ef_epic_date_to_date(vStartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ; 

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data

SELECT	2 as Flag,
			'Finance - U.S. Immigration & Custom Enforcement' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

       		
  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
			and  b.start_date > v_2yr
            and mcmb_fnt_code_chargestatus(c.charge_id) in ('30', '33')
             and (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id))< epic.ef_epic_date_to_date(vEndDate)
                  OR epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) < epic.ef_epic_date_to_date(vEndDate)
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) < epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vEndDate))
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) <  epic.ef_epic_date_to_date(vEndDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id))is null)) 

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_usmarshall_fin
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			EPIC.eh_booking.start_date%type,  
	 	p_EndDate       in          EPIC.eh_booking.start_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY73
	Crystal: 		UsMarshallSrv_Fin.rpt
	Purpose:		Used by Finance to list US - MARSHALL SERVICE total days (total days * daily rate)
	                within a specfied month period 
					
	Author:			Mary Ann Zak
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		08-30-05		Created   Use offense date and dispose date for in and out dates (vbl Sgt Roberts)
					M.Zak       09-13-05        Modified   Using epicaudit_eh_charge action time for start and end time for charges
					                                       (per Bob Meeks - waiting on Sgt Roberts okay) 
					M.Zak       8-17-06         added macomb and epic schemas
					
*/
        v_min_date		EPIC.eh_booking.start_date%type;  
		v_max_date		EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date;
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		v_date_from	:= substr(to_char(EPIC.ef_epic_date_to_date(p_StartDate), EPIC.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(EPIC.ef_epic_date_to_date(p_EndDate), EPIC.ef_date_format),1,100); 
		v_date_null	:= null;
		v_2yr := to_char(to_date(epic.ef_epic_date_to_date(p_StartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD') ;


	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Marshall Service' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual

		
	UNION ALL			              	
		--the below query pulls back the actual report data 

-- US - MARSHALL SERVICE with in selected date range 
SELECT	2 as Flag,
			'Finance - U.S. Marshall Service' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - MARSHALL SERVICE'  
            and b.start_date > v_2yr			
            and mcmb_fnt_code_chargestatus(c.charge_id) = '32'   --this replaces mcmb_fnt_inmatestatus for TC 59319   12/3/09 KJH
            and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null))            

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_usm_fin_sch
	(	vCur 			out			EPIC.epp_generic_ref_cursor.ref_cursor 
		)  
	 	
IS

	/*Crystal: 		USM_Fin_Sch.rpt
	Purpose:		Used by Finance to list US - MARSHALL SERVICE total days (total days * daily rate)
	                    within a specfied month period.  This version will be auto-run on the first Monday of
					    every month, for the previous month time period.
	Author:			K. Heinz
	
	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					K. Heinzk		1/29/2010		Altered mcmb_rpt_UsMarshallSrv_Fin.sql to create this code
					
*/
        --v_min_date		EPIC.eh_booking.start_date%type;  
		--v_max_date		EPIC.eh_booking.start_date%type; 
		vStartDate		EPIC.eh_booking.start_date%type;
		vEndDate        EPIC.eh_booking.start_date%type;  
     	v_date_from		EPIC.eh_booking.start_date%type;
 		v_date_to		EPIC.eh_booking.start_date%type;
		v_date_null		date;
		v_2yr            varchar2(8);
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		--v_min_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_min_date(p_StartDate));
		--v_max_date	:= EPIC.ef_epic_date_to_date(EPIC.ef_max_date(p_EndDate));
		vStartDate := epic.ef_min_date(epic.epicdate((add_months((last_day(sysdate)+1),-2)))); --  to determine first day of previous month
        vEndDate := epic.ef_max_date(epic.epicdate(add_months(Last_Day(sysdate),-1))); --midnight of first day of current month        
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(vStartDate), epic.ef_date_format),1,100); 	
		v_date_to := substr(to_char((epic.ef_epic_date_to_date(vEndDate) -1), epic.ef_date_format),1,100);	
		v_date_null	:= null; 
		v_2yr := to_char(to_date(epic.ef_epic_date_to_date(vStartDate) - INTERVAL '2-0' YEAR TO MONTH),'YYYYMMDD'); 


	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Finance - U.S. Marshall Service' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateName,
				'' as InmateNum,
				'' as MDOC,
				v_date_null as DayInDate,  
				v_date_null as DayOutDate
				            				
		FROM	dual		
	UNION ALL			              	
	
SELECT	2 as Flag,
			'Finance - U.S. Marshall Service' as RptTitle,
			v_date_from as RptStart,
			v_date_to as RptEnd,
			EPIC.ef_get_personororgname(b.entity_id) as InmateName,
			EPIC.ef_offender_id(b.entity_id) as InmateNum,
		 	MACOMB.mcmb_fnt_mdoc(b.entity_id) as MDOC,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) as DayInDate,
       		EPIC.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) as DayEndDate

  
	FROM	EPIC.eh_booking b,
	        EPIC.eh_charge c

	WHERE	b.booking_id = c.booking_id
            --and MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'US - MARSHALL SERVICE'  
            and b.start_date > v_2yr			
            and mcmb_fnt_code_chargestatus(c.charge_id) = '32'   --this replaces mcmb_fnt_inmatestatus for TC 59319   12/3/09 KJH 
            and (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id))< epic.ef_epic_date_to_date(vEndDate)
                  OR epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) < epic.ef_epic_date_to_date(vEndDate)
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) < epic.ef_epic_date_to_date(vStartDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id)) > epic.ef_epic_date_to_date(vEndDate))
                  OR (epic.ef_epic_date_to_date(mcmb_fnt_charge_start_date(c.charge_id)) <  epic.ef_epic_date_to_date(vEndDate) and epic.ef_epic_date_to_date(mcmb_fnt_charge_end_date(c.charge_id))is null))
            /*and (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id))< v_max_date
                  OR EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) < v_max_date
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) < v_min_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id)) > v_max_date)
                  OR (EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_start_date(c.charge_id)) <  v_max_date and EPIC.ef_epic_date_to_date(MACOMB.mcmb_fnt_charge_end_date(c.charge_id))is null)) */           

 ORDER BY Flag, InmateName;
  
END; 
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_VacantBeds
	(	vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor)


IS

/*	Form Usage: 	CRSTL.XX05
	Crystal: 		vacantbed.rpt
	Purpose:		Used to determine available/empty beds within the facility

	Author:			Rachel Stuve/Arlene Zdybel

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	07/28/04		Created   
					A. Zdybel
					R. Stuve	11/23/04		Added header information via union query	
					DLK			12/20/04		Added to the report tree - test 
					R. Stuve	12/20/04		Added Floor field 
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					R. Stuve	05/28/05		Compiled on OTMAIN 
					DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
	
*/

BEGIN

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Vacant Beds' as RptTitle,
				'' as Path,
				'' as Floor,
				'' as Cell,
				0 as Vacancies
		
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data
	     SELECT 2 as Flag,
	     		'Vacant Beds' as RptTitle,
	     		EPIC.ef_location_path_name(location_id,'UC',5) as Path,
	     	    substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1)-1) as Floor,
				location_name as Cell,
				capacity_minimum - (EPIC.ef_location_count(location_id, 'F') + EPIC.ef_location_count(location_id, 'M')) as Vacancies

		FROM 	EPIC.epic_locations

		WHERE	housing_flag = 'Y'
				and location_description in ('CELL', 'DORMITORY')
				and capacity_minimum - (EPIC.ef_location_count(location_id, 'F') + EPIC.ef_location_count(location_id, 'M')) > 0

		ORDER BY Flag, Path;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_VacPropBins
 	(vCur 	out        EPIC.epp_generic_ref_cursor.ref_cursor)

IS

/*	Form Usage: 	CRSTL.ZZ61
	Crystal: 		VacPropBins.rpt
	Purpose:		Used by the Jail Office, Booking to list all empty/available property bins

	Author:			John Gorski/Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/13/05		Created (modified code from John G.)
	                M. Zak      04/21/05        Added to Report tree (completed)   
	                R. Stuve	05/24/05		Compiled on OTMAIN  
	                DLK         03/23/06        ADDED MACOMB AND EPIC NOTATIONS
*/

BEGIN
  OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Vacant Property Bins' as RptTitle,
				'' as Bin
		
		FROM	dual
		
	UNION ALL
		--the below query pulls back the actual report data	
		   --all property bins	
		(SELECT 2 as Flag,
				'Vacant Property Bins' as RptTitle,
				pb.bin_number as Bin

		FROM	EPIC.otk_property_bin pb

			MINUS
           --used property bins
		SELECT	2 as Flag,
				'Vacant Property Bins' as RptTitle,
				pb.bin_number as Bin
		
		FROM	EPIC.otk_property_bin pb,
				EPIC.eh_property_item pi,
				EPIC.eh_offender_property op
		
		WHERE	pb.bin_id = pi.bin_id
				and op.item_id = pi.item_id);

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_VoidBookFees
	(	vCur 			out			epic.epp_generic_ref_cursor.ref_cursor, 
		p_StartDate		in			epic.eh_trans_distribution.trans_date%type,  
	 	p_EndDate       in         	epic.eh_trans_distribution.trans_date%type)  
	 	
IS

/*	Form Usage: 	CRSTL.YY57
	Crystal: 		voidbookfees.rpt
	Purpose:		Used by accounting/auditor to list all Booking Fees (County and State)
					that were void during the time period specified

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	01/24/05		Created 
					R. Stuve	01/28/05		Time filters were backwards: change <,> signs
					R. Stuve	01/31/05		Changed 'Union' to 'Union All' 
					DLK			02/25/05		Added to report tree to test
					R. Stuve	05/28/05		Compiled on OTMAIN
					J. McBratnie 07/15/07       move to Macomb schema from Production
	
*/
        v_min_date		epic.eh_trans_distribution.trans_date%type;  
		v_max_date		epic.eh_trans_distribution.trans_date%type;  
     	v_date_from		epic.eh_trans_distribution.trans_date%type;
 		v_date_to		epic.eh_trans_distribution.trans_date%type;
		v_date_null		date;
 		--must be same datatype as declarations above so WHERE clause doesn't fail
			
BEGIN

		v_min_date	:= epic.ef_min_date(p_StartDate);
		v_max_date	:= epic.ef_max_date(p_EndDate);
		v_date_from	:= substr(to_char(epic.ef_epic_date_to_date(p_StartDate), epic.ef_date_format),1,100);
		v_date_to  	:= substr(to_char(epic.ef_epic_date_to_date(p_EndDate), epic.ef_date_format),1,100); 
		v_date_null	:= null;

	OPEN vCur FOR
		--the below query pulls back the header information	
		SELECT	1 as Flag,
				'Void Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				'' as InmateNum,
				'' as InmateName,
				v_date_null as TDate,
				0 as Amount,
				'' as Agency
				
		FROM	dual
		
	UNION ALL		              	
		--the below query pulls back the actual report data
		SELECT	2 as Flag,
				'Void Booking Fees' as RptTitle,
				v_date_from as RptStart,
				v_date_to as RptEnd,
				epic.ef_offender_id(t.entity_id) as InmateNum,
				epic.ef_get_personororgname(t.entity_id) as InmateName,
				epic.ef_epic_date_to_date(tat.trans_date) as TDate,
				tat.amount as Amount,
				decode(tat.code_source_of_funds,'502','C','503','S') as Agency


		FROM	epic.eh_trust_account t,
				epic.eh_trust_account_trans tat


		WHERE	t.trust_account_id = tat.trust_account_id
				and (code_source_of_funds = '502'
					or code_source_of_funds = '503')
				and tat.reverse_flag = 'Y'
				and tat.trans_date >= v_min_date
				and tat.trans_date <= v_max_date

ORDER BY Flag, Agency, InmateNum, TDate;

END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Weekender
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ63
	Crystal: 		weekenders.rpt
	Purpose:		Used by the Jail Office to determine when those inmates with weekender
					sentences are due to be released

	Author:			Rachel Stuve

	Change Log:		Changed By  	Date Modified	Change Made
					------------	-------------	------------------------------------------
					R. Stuve		12/29/04		Created  
					dlk				01/10/05		Added to the tree. Changed RlsDate format
					R. Stuve		01/31/05		Changed 'Union' to 'Union All'
					R. Stuve		04/23/05		Compiled in OTMAIN
					J. McBratnie	05/09/11		Corrected the release_date 
*/

v_date_null date;
			
BEGIN  
		
v_date_null := null;
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Weekenders)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin,
				'' as WRTime,
				v_date_null as RlsDate
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
				'Case Status (Weekenders)' as RptTitle,
				epic.ef_offender_id(ab.entity_id) as InmateNum,
				epic.ef_get_personororgname(ab.entity_id) as InmateName,
				macomb.mcmb_fnt_chargedesc(c.statute_id) as Charge,
				cs.case_number as DocketNum,
				ca.judge_name as Judge,
				epic.ef_offender_cell(ab.entity_id) as Cell,
				macomb.mcmb_fnt_alphabin_current(ab.entity_id) as Bin,
				macomb.mcmb_fnt_wrlstime(ab.entity_id) as WRTime,
				epic.ef_epic_date_to_date(b.final_release_date) as RlsDate   -- sentence_end_date

		FROM	epic.eh_active_booking ab,
				epic.eh_booking b,
				epic.eh_charge c,
				epic.eh_case_charge a,
				epic.eh_court_appearance ca,
				epic.eh_case cs,
				epic.eh_entity_status e

		WHERE	b.booking_id = ab.booking_id
				and ab.booking_id = c.booking_id
				and c.charge_id = a.charge_id
				and a.case_id = ca.owner_id (+)
				and cs.case_id (+) = a.case_id
				and (macomb.mcmb_fnt_inmatestatus(c.charge_id) = 'SENTENCED WEEKENDER' or e.code_custody_status = '4')
				and c.charge_state != 6
				and b.entity_id = e.entity_id (+)

		ORDER BY Flag, RlsDate, WRTime, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_Writ
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		Writ.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'HERE ON WRIT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_WritHldPrb
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		WritHldPrb.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ - Hold for Prob Intrvw)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ - Hold for Prob Intrvw)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'HERE ON WRIT HOLD FOR PROBATION INTERVIEW'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mcmb_rpt_WritRdytoRtn
	(	vCur 		out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ??
	Crystal: 		WritRdytoRtn.rpt
	Purpose:		????

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M.Zak		  10-14-05       Created procedure and report
					J. McBratnie 07/15/07       move to Macomb schema from Production
*/                
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Here on Writ - Ready to Return)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				--'' as Charge,
				'' as DocketNum,
				'' as Judge,
				'' as Cell,
				'' as Bin
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
	SELECT	2 as Flag,
			'Case Status (Here on Writ - Ready to Return)' as RptTitle,
			epic.ef_offender_id(ab.entity_id) as InmateNum,
			epic.ef_get_personororgname(ab.entity_id) as InmateName,
			--mcmb_fnt_chargedesc(c.statute_id) as Charge,
			cs.case_number as DocketNum,  -- case
			ca.judge_name as Judge,
			epic.ef_offender_cell(ab.entity_id) as Cell,
			mcmb_fnt_alphabin_current(ab.entity_id) as Bin

	FROM	epic.eh_active_booking ab,
			epic.eh_charge c,
			epic.eh_case_charge a,
			epic.eh_court_appearance ca,
			epic.eh_case cs

	WHERE	ab.booking_id = c.booking_id
			and c.charge_id = a.charge_id
			and a.case_id = ca.owner_id (+)
			and cs.case_id (+) = a.case_id
			and mcmb_fnt_inmatestatus(c.charge_id) = 'READY TO RETURN WRIT'
			and c.charge_state != 6

	ORDER BY Flag, InmateName;
     	
END;
/

CREATE OR REPLACE
procedure MACOMB.MCMB_Set_Epic_Form_Form_Fill (
    p_form_usage		in		epic.epic_form.form_usage%type,
    p_return               out  epic.eh_autoid.template%type)
    
is
--
--
	cs_mod						constant varchar2(255) := 'MCMB_Set_Epic_Form_Form_Fill';
	v_newformid                 epic.epic_form.form_id%type := null;
	v_formid                    epic.epic_form.form_id%type := null;
	v_return					epic.eh_autoid.template%type := null;
	v_complete					epic.eh_autoid.template%type := 'COMPLETE';
	v_fail						epic.eh_autoid.template%type := 'FAILED';
	--
cursor curFormID is 
	--What are you going to effect
	select concat(substr(f.form_id,1,13),ltrim(to_char(to_number(substr(f.form_id,14))+1,'099'))) new_form_id,f.form_id
	from epic.epic_form f
	where
		form_type <> 'RPTWR' and  LENGTH(rtrim(form_id)) >= 16 and
		substr(f.form_id,length(f.form_id)-2,1) in ('0','1','2','3','4','5','6','7','8','9') and
		substr(f.form_id,length(f.form_id)-1,1) in ('0','1','2','3','4','5','6','7','8','9') and
		substr(f.form_id,length(f.form_id),1) in ('0','1','2','3','4','5','6','7','8','9') and
		substr(form_id,instr(form_id,form_usage,1),4) = p_form_usage and
		substr(form_id,14) in (select form_seq from (select substr(form_id,instr(form_id,form_usage,1),4), max(to_number(substr(form_id,14))) as form_seq
													from epic.epic_form
													where substr(form_id,instr(form_id,form_usage,1),4) = p_form_usage
													group by substr(form_id,instr(form_id,form_usage,1),4)));
			
begin

	open curFormID;
		fetch curFormID into v_newformid, v_formid;
	close curFormID;
    
	if v_newformid is null or v_formid is null then
		v_return := 'FAILED cur returned null';
		p_return := v_return;    
	else
		begin
			insert into epic.epic_form
				(FORM_ID, FORM_TYPE, FORM_NAME, FORM_USAGE, ALLOW_NEW_FLAG, ALLOW_DRAFTS_FLAG, PRINT_ONLY_FLAG, ACTION_TYPE, ACTION_TIME, ACTION_BY, FORM_DESCRIPTION, DRAFT_VISIBLE_TO_CREATOR_ONLY, REFRESH_DATA)
				select v_newformid, f.FORM_TYPE, f.FORM_NAME, f.FORM_USAGE, f.ALLOW_NEW_FLAG, f.ALLOW_DRAFTS_FLAG, f.PRINT_ONLY_FLAG, f.ACTION_TYPE, epic.epicdatenow(),-255, f.FORM_DESCRIPTION, f.DRAFT_VISIBLE_TO_CREATOR_ONLY, f.REFRESH_DATA
				from epic.epic_form f
				where
				  	f.form_type <> 'RPTWR' and  LENGTH(rtrim(f.form_id)) >= 16 and                            
				  	f.form_id = v_formid ;

		exception
			when others	then	
				v_return := 'epic_form failed ';
				v_return := concat(v_return,v_newformid);
				v_return := concat(v_return,v_formid); --v_fail;
				p_return := v_return;    
		end;
		begin
			insert into epic.epic_form_fill
				(PROPERTY_NAME, FORM_ID, SEQUENCE_NUMBER, SOURCE_TYPE, COMPRESSED_FLAG, ACTION_TYPE, ACTION_TIME, ACTION_BY, SOURCE_METHOD)
				select PROPERTY_NAME, v_newformid,SEQUENCE_NUMBER, SOURCE_TYPE, COMPRESSED_FLAG, ACTION_TYPE, epic.epicdatenow(), -255, SOURCE_METHOD
				from epic.epic_form_fill
				where 	substr(form_id,5,4) = p_form_usage and		
						form_id = v_formid;
		exception
			when others	then	
				v_return := 'epic_form_fill failed'; -- v_fail;
				p_return := v_return;    
		end;
		v_return := v_complete;

    end if; 
	p_return := v_return;    
end;
/

CREATE OR REPLACE
VIEW MACOMB.MCMB_VIEW_ALIAS ( ENTITY_ID, ALIAS_ID, LASTNAME, FIRSTNAME, MIDDLENAME, SUFFIXNAME, DOB, CODE_NAME_TYPE, LINK_PK ) AS
select 	id.OFFENDER_ID AS entity_id,
		pi.identity_id AS alias_id,
		pi.name_family AS lastname,
		pi.name_first  AS firstname,
		pi.name_other  AS middlename,
		pi.name_suffix AS suffixname,
 	    NVL(NVL(to_char(EPIC.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
 	    		to_char(EPIC.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
 	                   'UNKNOWN') AS DOB,
 	    pi.CODE_NAME_TYPE AS CODE_NAME_TYPE,
 	    decode(pi.CODE_NAME_TYPE, 'MAS',id.OFFENDER_ID, 'ALIAS') AS LINK_PK
FROM    EPIC.eh_person_identity pi,
		EPIC.eh_offender_ids id
WHERE	id.ENTITY_ID = pi.entity_id
  AND	pi.CODE_NAME_TYPE in ('MAS','ALI')
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where id.entity_id = ab.entity_id)
/

CREATE OR REPLACE
VIEW MACOMB.MCMB_VIEW_CHARGE ( ENTITY_ID, CHARGE_ID, STATUTE_ID, PACC, CHARGE_DESC, CHARGE_CLASS, SENTENCE_ID, CHARGE_ID_NUMBER, AGENCY_ID, COMPLAINT_DEPT, COURT_ID, CASE_NO, COURT_NAME, COURT_DATE, COURT_DIVISION, COURT_JUDGE, START_DATE, FINAL_RELEASE_DATE, AMOUNT, AMOUNT_TYPE, TRANS_TYPE, SORTORDER, WEB_CHARGE_PK, REDUCEAMOUNT, PAIDOUTDATE, UNPAIDOUTDATE ) AS
SELECT 	id.OFFENDER_ID				AS entity_id,
		c.charge_id 				AS charge_id,
        c.statute_id 				AS statute_id,
        es.statute_number 			AS pacc,
        es.statute_description 		AS charge_desc,
    	EPIC.ef_lookup_text('STATUTE CLASS', es.code_statute_class, 'UC') AS charge_class,
        s.sentence_id 				AS sentence_id,
       	charge_id_number 			AS charge_id_number,
       	ca.agency_id 				AS agency_id,
       	eo.organization_name 		AS complaint_dept,
       	cct.court_id 				AS court_id,
       	cs.case_number 				AS case_no,
       	EPIC.mcmb_fnt_courtname(c.charge_id) AS court_name,
       	decode(
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY'),'12/25/2025','Call Court',
       	to_char(EPIC.ef_epic_date_to_date(EPIC.ef_next_court_date(b.entity_id)),'MM/DD/YYYY')) AS court_date,

       	EPIC.ef_next_court_division(b.entity_id) AS court_division,
       	EPIC.ef_lookup_text('JUDGE NAME',EPIC.ef_next_court_judge(b.entity_id),'UC') AS court_judge,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.start_date(b.booking_id))         		AS Start_Date,
		EPIC.ef_epic_date_to_date(EPIC.epp_booking_dates.final_release_date(b.booking_id))     	AS final_releASe_date ,
		decode(c.sentence_id,NULL,
							to_number(bc.cash_only_bail_amount), --unsentenced
							decode(s.sentence_start_date,'0000000000:00:00+000',
							       to_number(bc.cash_only_bail_amount),
							       to_number(EPIC.mcmb_fnt_fineamount(c.sentence_id))  --unsentenced
							       ) )  AS amount,
		decode(c.sentence_id,NULL, 'BAIL', decode(s.sentence_start_date,'0000000000:00:00+000','BAIL','FINE')) AS amount_type,
		decode(c.sentence_id,NULL, 'U', decode(s.sentence_start_date,'0000000000:00:00+000','U','S')) AS Trans_type,
		decode(c.sentence_id,NULL, 2, decode(s.sentence_start_date,'0000000000:00:00+000',2,1)) AS sortorder,
		EPIC.ef_offender_id(b.entity_id)||' - '||c.charge_id  AS web_charge_pk,
		decode(EPIC.ef_get_attribute_value('10 PERCENT BOND',bc.BAIL_CONDITION_ID),'YES',
															'Y',
															'N') AS reduceamount,
		so.paid_out_date AS paidoutdate,
		so.unpaid_out_date AS unpaidoutdate
		--decode(c.charge_state,6,'Y','N') DISPOSED 
		--		EPIC.mcmb_fnt_disposedate_max(c.charge_id) AS Date_Disposed
FROM 	EPIC.eh_charge c,
		EPIC.eh_booking b,
		EPIC.eh_active_booking ab,
		EPIC.eh_charge_agency ca ,
     	EPIC.eh_case cs,
     	EPIC.eh_case_charge cc,
     	EPIC.eh_case_court cct,
     	EPIC.eh_entity_organization eo,
     	EPIC.eh_sentence s,
     	EPIC.eh_sentence_out_dates so,
     	EPIC.epic_statutes es,
     	EPIC.eh_bail_condition bc,
     	EPIC.eh_bail_condition_charge bcc,
		EPIC.eh_offender_ids id
WHERE b.booking_id = c.booking_id
  AND c.charge_id = ca.charge_id
  AND s.sentence_id (+) = c.sentence_id
  AND cs.booking_id = b.booking_id
  AND cc.charge_id = c.charge_id
  AND cc.case_id = cs.case_id
  AND cct.case_id = cs.case_id
  AND eo.entity_id = ca.agency_id
  AND es.STATUTE_ID = c.statute_id
  AND so.sentence_id (+)  = c.sentence_id
  AND bc.booking_id = b.booking_id
  AND bcc.charge_id = c.charge_id
  AND bc.bail_condition_id = bcc.bail_condition_id
  AND b.booking_id = ab.booking_id
  AND id.ENTITY_ID = ab.entity_id
  AND EPIC.ef_is_active_booking(b.entity_id)='TRUE'
  AND c.charge_state <> 6
union
-- HOLD records
SELECT EPIC.ef_offender_id(b.entity_id) AS entity_id,
       h.hold_id AS charge_id,
	   NULL      AS statute_id,
       NULL      AS pacc,
       NULL      AS charge_desc,
       EPIC.ef_lookup_text('STATUTE CLASS', code_charge_severity, 'UC') AS charge_clASs,
       NULL                 AS sentence_id,
       EPIC.ef_lookup_text('HOLD TYPE',code_hold_type,'UC') AS charge_id_number,
       h.agency_id          AS agency_id,
       eo.organization_name AS complaint_dept,
       NULL                 AS court_id,
       -- case number (other attrib - hold warant number)
       EPIC.ef_get_attribute_value('HOLD WARRANT NUMBER',h.hold_id) AS case_no,
       -- court name  (other attrib - hold court)
       EPIC.ef_get_attribute_value('HOLD COURT',h.hold_id) AS court_name,
       NULL AS court_date,
       NULL AS court_division,
       NULL AS court_judge,
       NULL AS start_date,
       NULL AS final_release_date,
       -- bond/fines  (other attrib - hold amount)
       to_number(EPIC.ef_get_attribute_value('HOLD AMOUNT',h.hold_id)) AS amount,
       'BOND' AS amount_type,
	   'H'    AS Trans_type,
       3      AS sortorder,
        EPIC.mcmb_fnt_offenderidfrombk(b.booking_id)||' - '||h.hold_id,
   	    decode(sign(instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10%')+
  					instr(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id),'10 %')+
   					instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'10 PERCENT'))-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO 10')*100)-
   					(instr(upper(EPIC.ef_get_attribute_value('HOLD INFO',h.hold_id)),'NO10')*100),
				  					1,'Y','N') AS reduceamount,
		NULL AS paidoutdate,
		NULL AS unpaidoutdate
		--NULL as DISPOSED
		-- null as date_disposed
FROM EPIC.eh_booking_holds h,
     EPIC.eh_active_booking b,
     EPIC.eh_entity_organization eo
WHERE b.booking_id = h.booking_id
  AND eo.entity_id = h.agency_id
  AND h.hold_removed_date is null
/

CREATE OR REPLACE
VIEW MACOMB.MCMB_VIEW_INMATE ( ENTITY_ID, LASTNAME, FIRSTNAME, LEVEL4, LEVEL5, LEVEL6, LEVEL7, LEVEL8, DOB, PAID_RELEASE, PROJECTED_RELEASE, JUVENILE_FLAG, SENT_TOTAL, HOLD_TOTAL, BAIL_TOTAL, MUGPATH, VEHICLE_ID, TOW_COMPANY, OTHERNAME, INMATECLASS, GENDER, CELL, RESTRICTIONUNTIL ) AS
select      id.offender_id AS entity_id,
			pi.NAME_FAMILY as lastname,
		    pi.NAME_FIRST  as firstname,
			substr(epic.ef_location_path_name(ha.location_id ,'uc',4),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',4),',')-1) as Level4,
	   		substr(epic.ef_location_path_name(ha.location_id ,'uc',5),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',5),',')-1) as Level5,
	  		substr(epic.ef_location_path_name(ha.location_id ,'uc',6),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',6),',')-1) as Level6,
       		substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1) as level7,
       		substr(epic.ef_location_path_name(ha.location_id ,'uc',8),
                instr(epic.ef_location_path_name(ha.location_id ,'uc',8),
        		/*level7 */ substr(epic.ef_location_path_name(ha.location_id ,'uc',7),1,instr(epic.ef_location_path_name(ha.location_id ,'uc',7),',')-1)
                    ,2)+1) as level8,
				NVL(NVL(to_char(epic.ef_epic_date_to_date(pi.DATE_OF_BIRTH),'MM/DD/YYYY'),
						to_char(epic.ef_epic_date_to_date(pi.BIRTH_DATE_APPROX),'MM/DD/YYYY')),
					'UNKNOWN_DOB') as DOB,
			epic.ef_epic_date_to_date(epic.epp_booking_dates.earliest_release_date(ab2.booking_id)) as paid_release,
    	   	epic.ef_epic_date_to_date(epic.epp_booking_dates.final_release_date(ab2.booking_id))    as Projected_release,--,
			decode(ep.JUVENILE_FLAG,'Y','Y','N') as juvenile_flag,
    	   	EPIC.mcmb_fnt_sent_Total_Amount(ab2.booking_id) as sent_total,
    	   	EPIC.mcmb_fnt_hold_Total_Amount(ab2.booking_id) as hold_total,
    	   	EPIC.mcmb_fnt_Bail_Total_Amount(ab2.booking_id) as bail_total,
			mf_PhotoShow(ab2.booking_id,mf_mug_with_Path(mf_photo_id(ab2.entity_id)), 'ftp://PHOTOFILE/PRODUCTION/NODATE/noimage2.jpg' ) as mugpath,
   			vehicle_id as vehicle_id,
			eo.ORGANIZATION_NAME as tow_company,
			pi.NAME_OTHER  as othername,
	   		decode(epic.ef_offender_CustStat(ab2.entity_id),
                  	'REGULAR INMATE','R',
					'WORK RELEASE','W',
                  	'KITCHEN TRUSTEE (White)','K',
                  	'GARAGE TRUSTEE (Orange)','O',
                  	'SPECIAL TRUSTEE (Green)','G',
                  	'R') as inmateclass,
   			decode(ep.CODE_GENDER,'_NOSP','U',ep.CODE_GENDER) as gender,
		   		 substr(epic.ef_location_name(ha.location_id ,'uc'),1,10) as cell,
            macomb.mf_visiting_restrictions(ab2.entity_id) as restrictionuntil
from   	epic.eh_active_booking ab2,
		epic.EH_OFFENDER_IDS id,
		epic.EH_PERSON_IDENTITY pi,
		epic.eh_entity_person ep,
		epic.eh_housing_assignments ha,
		epic.EH_ENTITY_ORGANIZATION  eo,
		epic.EH_VEHICLE v,
		epic.Epicvolume ev,
		epic.Epicimage ei,
		epic.Eh_entity_default_photo ph
where  id.entity_id = ab2.entity_id
  and ab2.entity_id = pi.entity_id
  and  pi.code_name_type = 'MAS'
  and  pi.identity_id = ep.primary_identity_id
  and  ab2.entity_id = ep.entity_id
  and  ab2.entity_id = ha.entity_id
  and  ab2.entity_id = v.entity_id(+)
  and  ab2.entity_id = ph.entity_id(+)
  and  ei.imageref(+) = ph.photo_id
  and  ev.volumeid(+) = ei.volumeid
  and  v.tow_company_id = eo.entity_id(+)
/

CREATE OR REPLACE
VIEW MACOMB.MCMB_VIEW_VISTITOR ( ENTITY_ID, VISITOR_ID, APPLICATION_DATE, EXPIRATION_DATE, LASTNAME, FIRSTNAME, STATUS, TYPESEQ, VISTITOR_PK ) AS
SELECT 	id.offender_id AS entity_id,
		er.ENTITY_RELATED_TO AS VISITOR_ID,
		DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_app_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS application_date,
       	DECODE(er.RELATIONSHIP_TYPE,'21',NVL(to_char(EPIC.ef_epic_date_to_date(EPIC.mcmb_fnt_Vist_expir_date(er.ENTITY_RELATED_TO)),'MM/DD/YYYY'),'unknown'),null) AS expiration_date,
       	pi.name_family AS lastname,
       	pi.name_first  AS firstname,
       	DECODE(er.RELATIONSHIP_TYPE,'21','A','N') AS status,
       	DECODE(er.RELATIONSHIP_TYPE,'21','1','2') AS typeseq,
   	   	id.offender_id ||'-'||er.ENTITY_RELATED_TO AS vistitor_pk
FROM   	EPIC.eh_offender_ids id,
		EPIC.eh_person_identity pi,
       	EPIC.eh_entity_relationship er
WHERE  er.ENTITY_RELATED_TO = pi.entity_id

  AND  id.entity_id = er.entity_id
  AND  er.related_as_role = 'VISTR'
  AND  pi.code_name_type = 'MAS'
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where er.entity_id = ab.entity_id)
  
UNION
-- Banned
SELECT 	'' AS entity_id, 
		va.visitor_id AS vistitor_id, 
		va.date_FROM AS application_date, 
		va.date_to AS expiration_date, 
		vpi.name_family AS lastname, 
		vpi.name_first  AS firstname, 
		'B' AS status, 
		'3' AS typeseq,
		''||'-'||va.VISITOR_ID
FROM 	EPIC.eh_banned_visitor va, 
		EPIC.eh_person_identity vpi
--       	EPIC.eh_active_booking ab
WHERE 	va.visitor_id = vpi.entity_id
--  AND	ab.entity_id = vpi.entity_id
  AND EXISTS (select 1 from EPIC.eh_active_booking ab where vpi.entity_id = ab.entity_id)
/

CREATE OR REPLACE
function MACOMB.mf_actualrelease(p_booking_id	in		EPIC.eh_release.booking_id%type)

--  function returns actual release date per booking id
return date 
is
	v_actual_release varchar2(20);
begin
	    select
		 	 actual_release
		into v_actual_release	
		from
			EPIC.eh_release
		where
			booking_id = p_booking_id
		order by
			actual_release;
	return EPIC.ef_epic_date_to_date(v_actual_release);
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_aliasPersonAction_time
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
--Returns the inmates alias MAX action_time value.  
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return the MAX action date_time as it relates to an imate number

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN date AS

vDate DATE;  

BEGIN
SELECT MAX(action_time ) as action_time
INTO vDate
FROM (
		SELECT epic.ef_epic_date_to_date(action_time) as action_time
		FROM   EPIC.eh_person_identity pi
		WHERE  pi.CODE_NAME_TYPE in ('MAS','ALI')
		  AND  pi.entity_id  = p_entity_id
	  );


RETURN vDate;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_BailCrtDsp
	(p_ChargeID		IN		EPIC.eh_charge.charge_id%type)
	
/*	
	Purpose:		Returns the value of the 'Court Disposition' other attribute of the selected bail condition
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  

vBail		EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR curBail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = 'COURT DISPOSITION'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_ChargeID;
			
BEGIN	
	OPEN curBail;
		FETCH curBail into vBail;
	CLOSE curBail;

RETURN vBail;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_BailMayBeRls
	(p_ChargeID		IN		EPIC.eh_charge.charge_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MAY BE RELSD IF FINE PD' other attribute of the selected bail condition
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  

vBail		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curBail IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_charge c
			
		WHERE 
			g.attribute_name = 'MAY BE RELSD IF FINE PD'
			and g.item_id = b.bail_condition_id 
			and b.bail_condition_id = bc.bail_condition_id
			and bc.charge_id = c.charge_id
			and c.charge_id = p_ChargeID;
			
BEGIN	
	OPEN curBail;
		FETCH curBail into vBail;
	CLOSE curBail;

RETURN vBail;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_bailtotal_unsent
	 (p_booking_id 	in 	EPIC.eh_bail_condition.booking_id%TYPE) 
	 

 /*	
	Purpose:		Returns the total bail amount per booking for all unsentenced charges

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 09/26/06		Created
*/  	 
RETURN VARCHAR2 AS

CURSOR curBail IS   	
	SELECT 	sum(b.cash_only_bail_amount)
	
	FROM 	EPIC.eh_charge c,
			EPIC.eh_bail_condition_charge bcc,
			EPIC.eh_bail_condition b
	
   	WHERE	c.charge_id = bcc.charge_id
   			and bcc.bail_condition_id = b.bail_condition_id
   			and c.charge_state != '4' --sentenced
			and c.charge_state != '6' --disposed	
   			and p_booking_id = c.booking_id
   	
	GROUP BY c.booking_id;

vBail	 EPIC.eh_bail_condition.cash_only_bail_amount%TYPE;

BEGIN
  	OPEN curBail;
  		FETCH curBail INTO vBail;
  	CLOSE curBail;

  	RETURN NVL (vBail, 0);
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_bond_address
	(p_inmate_id	in		EPIC.EH_OFFENDER_IDS.offender_id%type)

/*
Purpose: Returns the numbers and street of an inmate's most current address for Bond app
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				J McBratnie 8/16/2011		Created
*/
	
RETURN VARCHAR2 AS

v_address		varchar2(128);

BEGIN   
	BEGIN
				select  a.street_number || ' ' || a.street_name --*
				 into   v_address 
				 from   epic.EH_OFFENDER_IDS id,
				 		epic.EH_PERSON_IDENTITY pi,
				 		epic.eh_entity_person ep,
						epic.eh_active_booking ab2,
						EPIC.eh_address a
				 where  a.entity_id =  pi.entity_id
				   and  id.entity_id = pi.entity_id
				   and  id.entity_id = ep.entity_id
				   AND  mf_jil_master_alias(id.entity_id, pi.IDENTITY_ID) in (1,2)
		   		   and  pi.identity_id = ep.primary_identity_id
				   and  ab2.entity_id = id.entity_id
				   and a.primary_flag = 'Y'
				   and  id.offender_id = p_inmate_id 
				   and rownum = 1;
	exception when NO_DATA_FOUND then
			RETURN 'Not Address';			   			
	END;			
RETURN v_Address;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_bond_city_state_zip
	(p_inmate_id	in		EPIC.EH_OFFENDER_IDS.offender_id%type)

/*
Purpose: Returns the numbers and street of an inmate's most current address for Bond app
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				J McBratnie 8/16/2011		Created
*/
	
RETURN VARCHAR2 AS

v_csz		varchar2(128);

BEGIN 
	BEGIN
				select  a.CITY_TOWN_LOCALE || ', ' || a.STATE_PROVINCE_REGION || '  '|| a.POSTAL_CODE--*  
				 into   v_csz
				 from   epic.EH_OFFENDER_IDS id,
				 		epic.EH_PERSON_IDENTITY pi,
				 		epic.eh_entity_person ep,
						epic.eh_active_booking ab2,
						EPIC.eh_address a
				 where  a.entity_id =  pi.entity_id
				   and  id.entity_id = pi.entity_id
				   and  id.entity_id = ep.entity_id
				   AND  mf_jil_master_alias(id.entity_id, pi.IDENTITY_ID) in (1,2)
		   		   and  pi.identity_id = ep.primary_identity_id
				   and  ab2.entity_id = id.entity_id
				   and a.primary_flag = 'Y'
				   and  id.offender_id = p_inmate_id
				   and rownum = 1;
	exception when NO_DATA_FOUND then
			RETURN 'Not Address';			   			
	END;			
RETURN v_csz;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_bond_name
	(p_inmate_id	in		EPIC.EH_OFFENDER_IDS.offender_id%type)

/*
Purpose: Returns the numbers and street of an inmate's most current name for Bond app
	        
Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				J McBratnie 8/16/2011		Created
*/
	
RETURN VARCHAR2 AS

v_name		varchar2(128);

BEGIN
	BEGIN
				select  trim(Name_family) ||', '|| trim(pi.Name_first) || ', ' ||substr(pi.name_other,1,1)
				 INTO   v_name
				 from   epic.EH_OFFENDER_IDS id,
				 		epic.EH_PERSON_IDENTITY pi,
				 		epic.eh_entity_person ep,
						epic.eh_active_booking ab2
				 where  id.entity_id = pi.entity_id
				   and  id.entity_id = ep.entity_id
				   AND  mf_jil_master_alias(id.entity_id, pi.IDENTITY_ID) in (1,2)
		   		   and  pi.identity_id = ep.primary_identity_id
				   and  ab2.entity_id = id.entity_id
				   and  id.offender_id = p_inmate_id; 
	exception when NO_DATA_FOUND then
			RETURN 'Not Active';			   			
	END;
RETURN v_name;

END;
 --RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.MF_Bookid_Most_Recent
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
--Returns an inmate's booking id for the most recent released booking
RETURN VARCHAR2 AS

v_booking_id				EPIC.eh_booking.booking_id%type;

	CURSOR cur_id IS
		select
			bk.booking_id  
		FROM EPIC.eh_booking bk,
		  	 EPIC.eh_release r
        WHERE
        	bk.entity_id = p_entity_id   --0IHULAOXG0XD3MIG
			and bk.booking_id = r.booking_id
			and EPIC.ef_epic_date_to_date(bk.start_date) is not null
        	and EPIC.ef_epic_date_to_date(r.actual_release) is not null
		ORDER BY start_date DESC;
  
BEGIN
	OPEN cur_id;
		FETCH cur_id INTO v_booking_id;
	 	CLOSE cur_id;	
			
--RETURN v_booking_id;
RETURN NVL (v_booking_id, NULL);

END;                            

/

CREATE OR REPLACE
FUNCTION MACOMB.mf_chargeAction_time
	(p_booking_id		in		EPIC.eh_booking.booking_id%type)
	
--Returns the charge max action_time value.  
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return the max action date_time as it relates to an imate number

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN date AS

vDate DATE;  

BEGIN
SELECT MAX(action_time ) as action_time
INTO vDate
FROM (
	-- Charges ---------------------------------------------------------------------------------------------------------------
		SELECT epic.ef_epic_date_to_date(action_time) as action_time FROM EPIC.eh_charge c   WHERE c.booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(action_time) as action_time FROM EPIC.eh_booking b  WHERE b.booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(action_time) as action_time FROM EPIC.eh_case       WHERE booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(ca.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_charge_agency ca
		WHERE  c.charge_id = ca.charge_id
		  AND  c.booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(cc.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_case_charge cc
		WHERE  c.charge_id = cc.charge_id
		  AND  c.booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(cct.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_case_charge cc, EPIC.eh_case cs, EPIC.eh_case_court cct
		WHERE  c.charge_id = cc.charge_id
		  AND  cc.case_id = cs.case_id
		  AND  cs.case_id = cct.case_id
		  AND  c.booking_id = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(s.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_sentence s
		WHERE  c.sentence_id = s.sentence_id (+)
		  AND  c.booking_id  = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(so.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_sentence_out_dates so
		WHERE  c.sentence_id = so.sentence_id (+)
		  AND  c.booking_id  = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(bc.action_time) as action_time FROM   EPIC.eh_bail_condition bc WHERE  bc.booking_id  = p_booking_id
	UNION
		SELECT epic.ef_epic_date_to_date(bcc.action_time) as action_time
		FROM   EPIC.eh_charge c, EPIC.eh_bail_condition_charge bcc
		WHERE  c.charge_id = bcc.charge_id
		  AND  c.booking_id  = p_booking_id
	-- HOLDS ------------------------------------------------------------------------------------------------------------------------
	UNION 
		SELECT epic.ef_epic_date_to_date(h.action_time) as action_time FROM EPIC.eh_booking_holds h WHERE  booking_id  = p_booking_id
	  );

RETURN vDate;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_custody_status_end_date
	(p_booking_id	in		epic.eh_booking.booking_id%type,
	 p_cur_custody_status_id in epic.eh_booking_custody_status.custody_status_id%type)
	
--Returns the latest inmate's custody status code (eh_booking_custody_status.code_custody_status)

RETURN VARCHAR2 AS

	CURSOR cur_Code IS
	select date_start, custody_status_id
	from epic.eh_booking_custody_status
	where booking_id = p_booking_id  
	order by date_start;
--      and date_start in
--		    (select max(date_start)
--		     from epic.eh_booking_custody_status
--		     where booking_id = p_booking_id);
					 
    v_Code		varchar2(128);
    v_custody_status_id varchar2(128);
    v_gotit     varchar2(16);
  
BEGIN
   v_gotit := 'NO';

   FOR cust_stat in cur_Code
   LOOP  
   		dbms_output.put_line(v_gotit||' '|| cust_stat.custody_status_id ||' with ' ||p_cur_custody_status_id || ' ' ||cust_stat.date_start);
       if v_gotit = 'NO' THEN
	       if cust_stat.custody_status_id = p_cur_custody_status_id then  
    	   	   v_gotit := 'YES';  
--    	   	   v_code := cust_stat.date_start;
      	   END IF;
       ELSE
       		v_code := cust_stat.date_start;
       		dbms_output.put_line('v_code '||v_code ||' '||cust_stat.date_start);
       		exit;
       END IF;	
   END LOOP;  

RETURN v_code;

END;
 --JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_DateDiffMinutes
	(p_Date1		in		DATE,
	 p_Date2        in      DATE)
	
--Returns the date diff in mimnutes.  
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return the number of minutes from two ORACLE dates

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN number AS

vMinutes number;  

BEGIN
SELECT 1440*(p_Date1-p_Date2) as 
INTO vMinutes
FROM DUAL;


RETURN vMinutes;

END;
--JDM
/

CREATE OR REPLACE
function MACOMB.mf_date_between(
		p_date_check			EPIC.eh_charge.action_time%type,
		p_min_date				EPIC.eh_charge.action_time%type,
		p_max_date				EPIC.eh_charge.action_time%type
		)
return varchar2

/*
Purpose: Returns 'TRUE' if p_date_check is between p_min_date and p_max_Date  
                 'FALSE'  if NOT p_date_check is between p_min_date and p_max_Date
                 'INVALID' if p_max_date <= p_min_date
	        
Change Log:		Changed By		Date Modified	Change Made
				----------		-------------	------------------------------------------
				J. Mcbratnie	5/18/06			Created function
*/	

is


begin      
	IF epic.ef_epic_date_to_date(p_max_date) <= epic.ef_epic_date_to_date(p_min_date) then
		RETURN 'INVALID';
	END IF;
	IF epic.ef_epic_date_to_date(p_date_check) >= epic.ef_epic_date_to_date(p_min_date) and 
	   epic.ef_epic_date_to_date(p_date_check) <= epic.ef_epic_date_to_date(p_max_date) THEN 
	   	RETURN 'TRUE';
	ELSE
		RETURN 'FALSE';
	END IF;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.MF_EC_Area
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Area Code
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_Area		varchar2(128);

	CURSOR cur_Area IS
		SELECT
			tr.area_code
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
 
BEGIN
	OPEN cur_Area;
		FETCH cur_Area INTO v_Area;
	CLOSE cur_Area;
			
RETURN v_Area;

END;
-- MAZ
/

CREATE OR REPLACE
FUNCTION MACOMB.MF_EC_PhNumber
	(p_entity_id	in		EPIC.eh_telephone_records.entity_id%type)
 
--Returns the inmate's most current (primary, not end dated) Contact Phone Number
-- Demographics - Contacts tab


RETURN VARCHAR2 AS

v_Number		varchar2(128);

	CURSOR cur_Number IS
		SELECT
			tr.Base_number
		FROM                            
		    epic.EPIC_LOOKUPS el,                            
			epic.eh_entity_relationship er,
		 	epic.eh_telephone_records tr
		WHERE    
		    er.entity_id = p_entity_id
		    and er.entity_related_to = tr.entity_id
		    and tr.date_to is null 
		    and el.lookup_code = er.relationship_type
		    and el.lookup_class = 'PERSONAL RELATIONSHIP'                    
       	ORDER by decode(primary_flag, 'Y', 1, 2) asc ,tr.date_from desc, el.display_order asc;
  
BEGIN
	OPEN cur_Number;
		FETCH cur_Number INTO v_Number;
	CLOSE cur_Number;
			
RETURN v_Number;

END;
-- MAZ

/

CREATE OR REPLACE
FUNCTION MACOMB.mf_ExpngdCharge
	(p_charge_id	in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Determines if the charge class has been set to Seal/Expunge. Used for the Inmate History Public Report
	        
Change Log:		Changed By	  Date Modified	Change Made
				----------	  -------------	------------------------------------------
				R. Stuve	  01/03/07		Created 
				J. McBratnie  01/10/07      Moved to production
*/

RETURN VARCHAR2 AS
  CURSOR curExp IS 
		SELECT  'Y'	
		FROM  EPIC.eh_charge c
		WHERE c.charge_id = p_charge_id
			  and c.statute_class = 'EXP';
          
vExp	varchar2(1);

BEGIN
	OPEN curExp;
  		FETCH curExp INTO vExp;
  	CLOSE curExp;

RETURN NVL(vExp,'N');
  	 	
END;       
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_final_release_date 
	(p_booking_id	IN		EPIC.eh_booking.booking_id%TYPE)
	
/*
Purpose: Returns the Final Release Date from the Release Dates tab in Offendertrak. Uses an EPIC package

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	09/25/06		Created
*/	

RETURN 	EPIC.epic_col_types.varchar_255%TYPE

IS

BEGIN
	RETURN EPIC.epp_booking_dates.final_release_date(p_booking_id);
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_GA_Bail
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
	 
/*	
	Purpose:		Returns the value of the input generic attribute attached to bail condition

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value
  	
	FROM 	EPIC.eh_bail_condition b,
			EPIC.eh_bail_condition_charge bc,
			EPIC.eh_generic_attribute ga
			
	WHERE	b.bail_condition_id = bc.bail_condition_id 
			and bc.bail_condition_id = ga.item_id
			and bc.charge_id = p_charge_id
			and ga.attribute_name = p_ga_type;
     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.MF_GA_Charge
	 (p_charge_id 	IN 	EPIC.eh_charge.charge_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
/*	
	Purpose:		Returns the value of the input generic attribute attached to charge

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value 
  	
	FROM 	EPIC.eh_generic_attribute ga,
			EPIC.eh_charge c
			
	WHERE	c.charge_id = p_charge_id
			and c.charge_id = ga.item_id
			and ga.attribute_name = p_ga_type;     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

  	RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_GA_Sent
	 (p_sentence_id IN 	EPIC.eh_sentence.sentence_id%TYPE,
	  p_ga_type		IN	EPIC.eh_generic_attribute.attribute_name%TYPE) 
	 
/*	
	Purpose:		Returns the value of the input generic attribute attached to sentence

	Author:			Rachel Stuve
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	10/02/06       Created 

*/  	 
RETURN VARCHAR2 AS
  CURSOR curGA IS 
  	SELECT 	ga.attribute_value
  	
	FROM 	EPIC.eh_sentence s,
			EPIC.eh_generic_attribute ga
			
	WHERE	s.sentence_id = p_sentence_id
			and s.sentence_id = ga.item_id
			and ga.attribute_name = p_ga_type;
     
     
vGA	 varchar2(255);


BEGIN
  	OPEN curGA;
  	FETCH curGA INTO vGA;
  	CLOSE curGA;

RETURN vGA;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_HoldCourt
	(	p_HoldID	in	EPIC.eh_booking_holds.hold_id%type)

/*	
	Purpose:		Returns the value of the 'HOLD COURT' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	

RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%type;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD COURT'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_HoldInfo
	(p_HoldID	in	EPIC.eh_booking_holds.hold_id%TYPE)
	                          
/*	
	Purpose:		Returns the value of the 'Hold Info' other attribute of the selected hold
	
	Called By:		MACOMB.mcmb_rpt_facesheetholds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/	
	
RETURN VARCHAR2
IS  vHold			EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curHold IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_booking_holds h	
			
		WHERE 
			g.attribute_name = 'HOLD INFO'
			and g.item_id = h.hold_id
			and h.hold_id = p_HoldID;

BEGIN	
	OPEN curHold;
		FETCH curHold into vHold;
	CLOSE curHold;

RETURN vHold;

END;
/

CREATE OR REPLACE
function MACOMB.mf_jil_master_alias (in_entity_id in epic.EH_PERSON_IDENTITY.ENTITY_ID%TYPE,
					   in_identity_id in epic.EH_PERSON_IDENTITY.IDENTITY_ID%TYPE)
--
/*	
	System: 		Unknown
	Purpose:		

	Author:			UNKNOWN
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 07/15/07       move to Macomb schema from Production
					
*/
 	return number is out_number number(1);
--
	got_primary_id   char(16);
--
begin
	out_number := 0;
	select  PRIMARY_IDENTITY_ID
	into    got_primary_id
	from    epic.EH_ENTITY_PERSON
	where   ENTITY_ID = in_entity_id;
--
	if got_primary_id = in_identity_id then
		out_number := 1; -- master
	else
		out_number := 2; -- alias
	end if;
--
	return out_number;
exception
	when no_data_found then
		return out_number;
	when too_many_rows then
		return out_number;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_masterPersonAction_time
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type,
	 p_booking_id       in      EPIC.eh_booking.booking_id%type)
	
--Returns the inmates greatest action_time value.  
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return the last action date_time as it relates to an imate number

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN date AS

vDate DATE;  

BEGIN
SELECT MAX(action_time ) 
INTO vDate
FROM (
-- need entity_id to complte this group of fields ----------------------------------------------------------------------------------------------------
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.EH_OFFENDER_IDS id          WHERE id.entity_id = p_entity_id     
	UNION
		SELECT epic.ef_epic_date_to_date(ep.action_time)     as action_time FROM epic.EH_PERSON_IDENTITY pi,  epic.eh_entity_person ep
		WHERE  pi.entity_id = p_entity_id
		  AND  pi.identity_id = ep.primary_identity_id
		  AND  pi.code_name_type = 'MAS'    
	UNION
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.eh_entity_person ep         WHERE ep.entity_id = p_entity_id     
	UNION
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.eh_housing_assignments ha   WHERE ha.entity_id = p_entity_id     
	UNION
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.EH_VEHICLE v                WHERE v.entity_id = p_entity_id      
	UNION
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.Eh_entity_default_photo ph  WHERE ph.entity_id = p_entity_id     
	UNION
-- need booking it to complete this group of fields --------------------------------------------------------------------------------------------------
		SELECT epic.ef_epic_date_to_date(action_time)        as action_time FROM epic.eh_active_booking ab2       WHERE ab2.booking_id  = p_booking_id 
	UNION
		SELECT MAX(epic.ef_epic_date_to_date(f.action_time)) as action_time FROM epic.eh_charge c, epic.eh_sentence_fine f
		WHERE  c.booking_id  = p_booking_id
		  AND  c.sentence_id = f.sentence_id 
	UNION
		SELECT MAX(epic.ef_epic_date_to_date(g.action_time)) as action_time FROM EPIC.eh_generic_attribute g, EPIC.eh_booking_holds h
		WHERE  g.attribute_name = 'HOLD AMOUNT'
		  AND  g.item_id = h.hold_id
		  AND  h.booking_id = p_booking_id   
	UNION
		SELECT MAX(epic.ef_epic_date_to_date(action_time))   as action_time FROM epic.eh_bail_condition b         WHERE b.booking_id = p_booking_id);


RETURN vDate;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_mug_with_Path
	(p_photo_id		in		EPIC.eh_entity_photo.Photo_ID%type)   
	
--Returns all of an inmate's alias names (one line, seperated by a '\')
	
RETURN  EPIC.epic_col_types.VARCHAR_2000%type
IS   

    CURSOR curPhotoPath IS
	    SELECT 'ftp://' || ev.volumeserver ||'/'|| ev.volumepath || '/' || ei.imageref as mugpath
    	FROM	epic.Epicvolume ev,
				epic.Epicimage ei,
				epic.Eh_entity_default_photo ph,
				epic.eh_entity_photo ep
		WHERE
				ei.imageref = ph.photo_id(+)
	  	  AND   ev.volumeid = ei.volumeid
		  AND   ei.imageref = p_photo_id
		  AND   ep.photo_id = ei.imageref;

noPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;
vPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;

BEGIN  
	vPhotoLink := null;
	noPhotoLink := 'ftp://PHOTOFILE/PRODUCTION/NODATE/noimage.jpg';

	OPEN curPhotoPath;
	FETCH curPhotoPath INTO vPhotoLink;
	CLOSE curPhotoPath;                
	
	IF vPhotoLink IS NULL THEN
		vPhotoLink := noPhotoLink;
	END IF;
	
	RETURN vPhotoLink;
END;	

--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_new_sentence
	(p_entity_id	in		EPIC.eh_booking.entity_id%type)   
	
 /*	
	System: 		Macomb JIL
	Purpose:		Returns Y if inmate an active inmate.
	                
	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 10/01/08		Created 
					
					
*/       


RETURN VARCHAR2 AS

vActive VARCHAR2(1);
  
BEGIN          
	vActive := 'N';
    BEGIN
		select 'Y' into vActive 
		from epic.eh_active_booking ab,
		     epic.eh_charge c,
		     epic.eh_Sentence s
		where ab.booking_id = c.booking_id
		  and ab.entity_id = p_entity_id
		  and c.sentence_id = s.sentence_id
		  and epic.ef_epic_date_to_date(s.DATE_ENTERED) between sysdate-1 -- last batch date from mjrs tables
		                                                    and sysdate;
    EXCEPTION
    	when NO_DATA_FOUND then
			vActive := 'N';
    	when OTHERS then
			vActive := 'N';
	END;    		
			
RETURN vActive;
END;
--JDM

/

CREATE OR REPLACE
FUNCTION MACOMB.mf_NextCourtDate
		 (p_booking_id	in 	EPIC.eh_booking.booking_id%TYPE) 

/*
Purpose: Returns an inmate's next (soonest) court date for the selected booking

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	9/26/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	decode(EPIC.ef_epic_date_to_date(ca.appearance_date), '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YYYY'))
            --dates listed as 'TBN' in Offendertrak interface are stored in database as '2200010100:00:00+000'
  	
	FROM 	EPIC.eh_booking b,
			EPIC.eh_case c,
			EPIC.eh_court_appearance ca
			
	WHERE	b.booking_id = c.booking_id
			and c.case_id = ca.owner_id
			and b.booking_id = p_booking_id
			and EPIC.ef_epic_date_to_date(ca.appearance_date) >= sysdate
	
	ORDER BY ca.appearance_date;
     
     
vCourtDate	varchar2(20);


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

RETURN 	vCourtDate;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_NextCourtDate_Charge
		 (p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns an inmate's next (soonest) court date for the selected charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	11/21/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curCourtDate IS 
  	SELECT 	decode(EPIC.ef_epic_date_to_date(ca.appearance_date), '01/01/2200 00:00:00', 'TBN', to_char(EPIC.ef_epic_date_to_date(ca.appearance_date), 'MM/DD/YYYY'))
            --dates listed as 'TBN' in Offendertrak interface are stored in database as '2200010100:00:00+000'
  	
	FROM 	EPIC.eh_charge ch,
			EPIC.eh_case_charge cc,
			EPIC.eh_case c,
			EPIC.eh_court_appearance ca
			
	WHERE	ch.charge_id = cc.charge_id
			and cc.case_id = c.case_id
			and c.case_id = ca.owner_id
			and ch.charge_id = p_charge_id
			and EPIC.ef_epic_date_to_date(ca.appearance_date) >= sysdate
	
	ORDER BY ca.appearance_date;
     
     
vCourtDate	varchar2(20);


BEGIN
  	OPEN curCourtDate;
  		FETCH curCourtDate INTO vCourtDate;
  	CLOSE curCourtDate;

RETURN 	vCourtDate;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_NonPblcCharge
	(p_charge_id	in	EPIC.eh_charge.charge_id%type) 

/*
Purpose: Determines if the charge generic attribute has been set to Conviction Set Aside Non Public. Used for the Inmate History Public Report
	        
Change Log:		Changed By	  Date Modified	Change Made
				----------	  -------------	------------------------------------------
				R. Stuve	  01/03/07		Created
				J. McBratnie  01/10/07      Moved to production
*/

RETURN VARCHAR2 AS
  CURSOR curNonP IS 
		SELECT 'Y'
		FROM EPIC.eh_generic_attribute g,
		     EPIC.eh_charge c
		WHERE g.attribute_name = 'CONVICTION SET ASIDE NON PUBLIC'
			and g.attribute_value = 'Y'
			and g.item_id = c.charge_id
			and c.charge_id = p_charge_id;
        
vNonP	 varchar2(1);

BEGIN
  	OPEN curNonP;
  		FETCH curNonP INTO vNonP;
  	CLOSE curNonP;

RETURN NVL(vNonP,'N');
  	 	
END; 
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_PhotoShow
	(	p_booking_id	IN	EPIC.eh_active_booking.booking_id%TYPE,
	    p_image_path    IN  VARCHAR2,
	    p_noimage_path  IN  VARCHAR2 )


RETURN VARCHAR2 AS 
	CURSOR cur IS
		SELECT 'OK TO SHOW'
		FROM 	epic.eh_active_booking ab,
              	epic.eh_charge charge,
              	epic.eh_generic_attribute ga
		WHERE 	ab.booking_id = charge.booking_id
		  AND 	charge.charge_id = ga.item_id
		  AND   ga.attribute_name = 'CHARGE STATUS'		  
		  AND 	ga.attribute_value NOT IN ('01','04','14','16','1','4')
		  AND 	ab.booking_id = p_booking_id
		  -- active charges only
		  AND 	charge_state <> '6';


vDisplay	 VARCHAR2(10);
vOutputimage VARCHAR2(255);
BEGIN
	OPEN cur;
		FETCH cur INTO vDisplay;
	CLOSE cur;
	IF vDisplay = 'OK TO SHOW' THEN
		vOutputimage := p_image_path;
	ELSE
		vOutputimage := p_noimage_path;
	END IF;					

RETURN vOutputimage;
	
END;
--RAS
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_photo_id
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)   
	
--Returns all of an inmate's alias names (one line, seperated by a '\')
	
RETURN  EPIC.eh_entity_photo.photo_id%type
IS   
noPhotoLink EPIC.epic_col_types.VARCHAR_2000%type;

	CURSOR curDefault IS
		SELECT photo_id
		FROM epic.Eh_entity_default_photo ep
		WHERE p_entity_id = ep.entity_id;

	CURSOR curAllPhotos IS
		SELECT photo_id
		FROM epic.eh_entity_photo ep
		WHERE p_entity_id = ep.entity_id
		  AND epic.ef_epic_date_to_date(date_taken) = (	SELECT MAX(epic.ef_epic_date_to_date(date_taken))
														FROM epic.eh_entity_photo ep
														WHERE p_entity_id = ep.entity_id);

vPhotoID   epic.eh_entity_photo.photo_id%type;
														
BEGIN
	OPEN curDefault;
	FETCH curDefault INTO vPhotoID;
	IF curDefault%NOTFOUND THEN
		OPEN curAllPhotos;	
		FETCH curAllPhotos INTO vPhotoID;
		CLOSE curAllPhotos;
	END IF;
	CLOSE curDefault;     
	RETURN vPhotoID;														
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SentEndDate
	(p_charge_id	in 	EPIC.eh_charge.charge_id%TYPE) 

/*
Purpose: Returns the sentence end date (if available) for the specified charge

Change Log:		Changed By	Date Modified	Change Made
				----------	-------------	------------------------------------------
				R. Stuve	9/26/06			Created
*/		 
	 
RETURN VARCHAR2 AS
  CURSOR curSent IS 
  	SELECT 	s.sentence_end_date
  	
	FROM 	EPIC.eh_sentence s,
			EPIC.eh_charge c
			
	WHERE	s.sentence_id = c.sentence_id
			and c.charge_id = p_charge_id;
     
vSent	EPIC.eh_sentence.sentence_end_date%TYPE;


BEGIN
  	OPEN curSent;
  		FETCH curSent INTO vSent;
  	CLOSE curSent;

  	RETURN vSent;
  	 	
END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_sent_overlap
	(p_booking_id		in		EPIC.eh_booking.booking_id%type,
	 p_charge_id        in      EPIC.eh_charge.charge_id%type,
	 p_StartDate		in		EPIC.eh_booking.start_date%type,
	 p_EndDate			in		EPIC.eh_booking.start_date%type)

return varchar2
	
--Returns 'TRUE' if per booking, charge id, sentence start and end, a sentence exist with a start-end dates that overlap else 'FALSE'
--used for Lori's anticipated reimb rpt- indicator that days need to be adjusted
is

	v_Overlap			varchar2(10);
	v_Chrg_Overlap		varchar2(16);
	
	CURSOR cur_Overlap IS
		select ch1.charge_id as charge_id    --start date overlaps
  		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id  --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_StartDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_StartDate)

		UNION
		select ch1.charge_id as charge_id    -- end date overlaps
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_EndDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_EndDate)--;
			
        UNION
	
		select ch1.charge_id as charge_id     -- start and end date w/in given range (overlap)
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
 		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) >= EPIC.ef_epic_date_to_date(p_StartDate)  
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) <= EPIC.ef_epic_date_to_date(p_EndDate);

						
begin
v_Overlap := 'FALSE';  -- init overlap as false
   
	open cur_Overlap;
	fetch cur_Overlap into v_Chrg_Overlap;  
		if cur_Overlap%found then              -- if any records are found then overlap is TRUE
			v_Overlap := 'TRUE';
		end if;
	close cur_Overlap;
	return v_Overlap;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_sent_overlap_MZ
-- testing inmate # 313495 overlap true - should be false same date range for both charges  
-- ************* this is a temp test function only******************** 
	(p_booking_id		in		EPIC.eh_booking.booking_id%type,
	 p_charge_id        in      EPIC.eh_charge.charge_id%type,
	 p_StartDate		in		EPIC.eh_booking.start_date%type,
	 p_EndDate			in		EPIC.eh_booking.start_date%type)

return varchar2
	
--Returns 'TRUE' if per booking, charge id, sentence start and end, a sentence exist with a start-end dates that overlap else 'FALSE'
--used for Lori's anticipated reimb rpt- indicator that days need to be adjusted
is

	v_Overlap			varchar2(10);
	v_Chrg_Overlap		varchar2(16);
	
	CURSOR cur_Overlap IS
		select ch1.charge_id as charge_id    --start date overlaps
  		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id  --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_StartDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_StartDate)
			and (EPIC.ef_epic_date_to_date(p_StartDate) <>  EPIC.ef_epic_date_to_date(s1.sentence_start_date)    -- MZ testing -- sent dates should not be = for differ charges
			     and EPIC.ef_epic_date_to_date(p_EndDate) <> EPIC.ef_epic_date_to_date(s1.sentence_end_date))

		UNION
		select ch1.charge_id as charge_id    -- end date overlaps
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) <= EPIC.ef_epic_date_to_date(p_EndDate)
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) >= EPIC.ef_epic_date_to_date(p_EndDate)
			and (EPIC.ef_epic_date_to_date(p_StartDate) <>  EPIC.ef_epic_date_to_date(s1.sentence_start_date)    -- MZ testing -- sent dates should not be = for differ charges
			     and EPIC.ef_epic_date_to_date(p_EndDate) <> EPIC.ef_epic_date_to_date(s1.sentence_end_date))
			
        UNION
	
		select ch1.charge_id as charge_id     -- start and end date w/in given range (overlap)
		from
			EPIC.eh_sentence s1,
			EPIC.eh_charge ch1,
			EPIC.eh_booking bk
 		where ch1.booking_id = p_booking_id --bk.booking_id
			and ch1.sentence_id = s1.sentence_id
			and ch1.charge_id <> p_charge_id --ch2.charge_id
			and EPIC.ef_epic_date_to_date(s1.sentence_start_date) >= EPIC.ef_epic_date_to_date(p_StartDate)  
			and EPIC.ef_epic_date_to_date(s1.sentence_end_date) <= EPIC.ef_epic_date_to_date(p_EndDate)
			and (EPIC.ef_epic_date_to_date(p_StartDate) <>  EPIC.ef_epic_date_to_date(s1.sentence_start_date)    -- MZ testing -- sent dates should not be = for differ charges
			     and EPIC.ef_epic_date_to_date(p_EndDate) <> EPIC.ef_epic_date_to_date(s1.sentence_end_date));

						
begin
v_Overlap := 'FALSE';  -- init overlap as false
   
	open cur_Overlap;
	fetch cur_Overlap into v_Chrg_Overlap;  
		if cur_Overlap%found then              -- if any records are found then overlap is TRUE
			v_Overlap := 'TRUE';
		end if;
	close cur_Overlap;
	return v_Overlap;
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SntEdcRl
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'EDUCATIONAL RELEASE' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'EDUCATIONAL RELEASE'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SntFine
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MAY BE RLSD IF FINE PD' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'MAY BE RLSD IF FINE PD'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SntMiscInfo
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'MISC SENTENCE INFO' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'MISC SENTENCE INFO'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SntWrkRlsG
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WORK RELEASE GRANTED' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WORK RELEASE GRANTED'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_SntWrkSk
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WORK SEEK' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WORK SEEK'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_trust_acct_status

	(p_TRUST_id		in		epic.eh_TRUST_ACCOUNT.trust_account_id%type) 

--Returns status of the trust account (open or closed) written for SRF 12903
/*	
	System: 		Unknown
	Purpose:		

	Author:			Kelly Heinz
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------ 						
*/	
RETURN VARCHAR2 AS

v_status 	epic.eh_trust_account.code_status%type;

	CURSOR cur_status IS
		SELECT
			ta.code_status
		FROM
		 	epic.eh_trust_account ta
		WHERE    
			ta.trust_account_id =  p_trust_id;
  
BEGIN
	OPEN cur_status;
		FETCH cur_status INTO v_status;
	CLOSE cur_status;
			
RETURN v_status;

END;
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_update_check
	(p_minutes				in		number,
	 p_updateDuration       in      number)
	
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return 'Y' if it is ok to update the data.  

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN CHAR AS

vUpdate CHAR;  

BEGIN
select decode(round(p_minutes,0)/p_upDateduration,1,'Y','N')
INTO vUpdate
FROM DUAL;


RETURN vUpdate;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_visiting_restrictions
	 (p_entity_id	in 	epic.eh_active_booking.entity_id%TYPE) 
	 
--Returns the case number of the selected charge
	 
RETURN VARCHAR2 AS
  CURSOR currestrictions IS 
	select 	max(epic.ef_epic_date_to_date(r.end_date)) as resdate
	from  	epic.EH_ENTITY_RESTRICTION r
	where epic.ef_epic_date_to_date(r.end_date) > sysdate
	  and r.entity_id = p_entity_id	;
	     
     
vrestiction_date	 epic.EH_ENTITY_RESTRICTION.end_date%TYPE;


BEGIN
  	OPEN curRestrictions;
  		FETCH curRestrictions INTO vrestiction_date;
  	CLOSE curRestrictions;

  	RETURN vrestiction_date;
  	 	
END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_visitorPersonAction_time
	(p_entity_id		in		EPIC.eh_entity_person.entity_id%type)
	
--Returns the visitors greatest action_time value.  
 /*	
	System: 		Jail inmate Locator
	Purpose:		Return the max action date_time as it relates to an imate number

	Author:			Joe McBratnie
	
	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					J. McBratnie 04/09/06       created
					
*/  	 
	
	
RETURN date AS

vDate DATE;  

BEGIN
SELECT MAX(action_time ) as action_time
INTO vDate
FROM (
		-- banned visitors ----------------------------------------------------
		SELECT epic.ef_epic_date_to_date(va.action_time) as action_time
		FROM 	EPIC.eh_banned_visitor va, EPIC.eh_person_identity vpi
		WHERE 	va.visitor_id = vpi.entity_id
		  AND	vpi.entity_id = p_entity_id
	UNION
		-- Visitors -----------------------------------------------------------
		SELECT MAX(epic.ef_epic_date_to_date(pi.action_time)) as action_time
		FROM   EPIC.eh_person_identity pi,
    		   EPIC.eh_entity_relationship er
		WHERE  er.ENTITY_RELATED_TO = pi.entity_id
		  AND  er.related_as_role = 'VISTR'
		  AND  pi.code_name_type = 'MAS'
		  AND  er.entity_id = p_entity_id
	  );

RETURN vDate;

END;
--JDM
/

CREATE OR REPLACE
FUNCTION MACOMB.mf_WknRlsTm
	(p_SentID	in	EPIC.eh_sentence.sentence_id%TYPE)
	
/*	
	Purpose:		Returns the value of the 'WEEKENDER RELEASE TIME' other attribute for the selected sentence
	
	Called By:		MACOMB.mcmb_rpt_facesheetbook
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	03/23/06		Created  
					
*/			

RETURN VARCHAR2
IS  

vSent		EPIC.eh_generic_attribute.attribute_value%TYPE;

	CURSOR curSent IS
		SELECT
			g.attribute_value 
			
		FROM
			EPIC.eh_generic_attribute g,
			EPIC.eh_sentence s	
			
		WHERE 
			g.attribute_name = 'WEEKENDER RELEASE TIME'
			and g.item_id = s.sentence_id
			and s.sentence_id = p_SentID;

BEGIN	
	OPEN curSent;
		FETCH curSent into vSent;
	CLOSE curSent;

RETURN vSent;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_BkDspCard
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_EntityID		in		EPIC.eh_entity_person.entity_id%type,
		p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
IS
/*	
	Form Usage: 	CRSTL.XX60
	Crystal: 		BkDispCard.rpt
	Purpose:		To notify booking to prepare an inmate for release, along with the information
					needed to process the release

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    03/15/06		Created
*/
BEGIN

	OPEN vCur FOR
    	SELECT	EPIC.ef_offender_id(b.entity_id) as InmateNum,
				MACOMB.mcmb_fnt_alphabin_current(b.entity_id) as PropertyNum,
				EPIC.ef_offender_cell(b.entity_id) as RoomNum,
				EPIC.ef_offender_1st_last_name(b.entity_id) as InmateName,
				MACOMB.mcmb_fnt_primarycharge(b.booking_id) as Offense,
				EPIC.ef_get_username1stlast(p_UserID) as ReleasedBy,     --<input prompt based on current user> 
				--Orders of (Free text)
				--ReasonReleased (Free text)
				--ReleasedTo (Free text)
				--Received by (Signature)
				to_char(sysdate, 'MM/DD/YYYY') as DateOut,
				--Time Out (Free text)
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY') as DateIn,
				to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'HH12:MI AM') as TimeIn,
				--Remarks (Free text)
				MACOMB.mcmb_fnt_inmatefunds(b.entity_id) as Money

		FROM	EPIC.eh_active_booking b,
				EPIC.eh_booking bk

		WHERE	b.booking_id = bk.booking_id
				and b.entity_id = p_EntityID;  --<input prompt based on current inmate>   

END;   
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_cmhExtract
	(vCur 	out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	Scheduled report on Crystal Report Server
	Crystal: 		CMHExtract.rpt
	Purpose:		Used by Community Mental Health (CMH) to import Offendertrak/inmate data into their system
					
	Author:			Rachel Stuve

	Change Log:		Changed By	 Date Modified	Change Made
					----------	 -------------	------------------------------------------
					R. Stuve	 05/01/06		Created
					R. Stuve	 05/03/06		Compiled OTMAIN 	
					J. McBratnie 05/04/06       Compiled in OTMAIN
*/			
BEGIN 
	OPEN vCur FOR 
	    SELECT	rpad(NVL(EPIC.ef_offender_id(ab.entity_id),' '),7,' ') || (select substr(rpad(NVL(ep.name_family,' '),20,' '),1,20) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || (select substr(rpad(NVL(ep.name_first,' '),15,' '),1,15) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 )
	    ||(select substr(rpad(NVL(ep.name_other,' '),15,' '),1,15) from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || (select NVL(to_char(EPIC.ef_epic_date_to_date(ep.date_of_birth), 'YYYYMMDD'),'        ') from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 )
	    ||(select NVL(ep.social_security_number,'         ') from EPIC.eh_person_identity ep where ab.entity_id = ep.entity_id and rownum = 1 ) || substr(NVL(EPIC.ef_get_security_class(ab.entity_id),'  '),1,2) || (select NVL(to_char(EPIC.ef_epic_date_to_date(b.start_date), 'YYYYMMDD'),'        ') from EPIC.eh_booking b where b.booking_id = ab.booking_id)
	    || substr(rpad(NVL(MACOMB.mcmb_fnt_inmatestatus(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)),' '),30,' '),1,30) || substr(rpad(NVL(MACOMB.mcmb_fnt_statutetext(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)), ' '),40,' '),1,40) || substr(rpad(lpad(NVL(MACOMB.mcmb_fnt_CountHolds(ab.entity_id),'00'),2,'0')||'HOLDS',7,' '),1,7) || substr(rpad(NVL(MACOMB.mcmb_fnt_statutenumber(MACOMB.mcmb_fnt_drvchgid(ab.entity_id)),' '),15,' '),1,15) as Field

		FROM	EPIC.eh_active_booking ab

		ORDER BY 1;     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_Detainer
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_EntityID		in		EPIC.eh_entity_person.entity_id%type,
		p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
IS
/*	
	Form Usage: 	CRSTL.XX62
	Crystal: 		Detainer.rpt
	Purpose:		To notify another agency (who is borrowing the inmate from MCSO on a WRIT) that 
					the inmate is needed back and the agency should not release him/her

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    09/25/06		Created
*/
BEGIN

	OPEN vCur FOR
		SELECT	INITCAP(EPIC.ef_get_personororgname(ab.entity_id)) as Prisoner,      --link to current inmate
				INITCAP(MACOMB.mcmb_fnt_alias(ab.entity_id)) as AKAs,
				to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_final_release_date(ab.booking_id)), 'MM/DD/YYYY') as OverallOutDate,
					--the above needs to be final release date from the release date tab
				'$' || MACOMB.mf_bailtotal_unsent(ab.booking_id) as OverallBond,
		        MACOMB.mf_NextCourtDate(ab.booking_id) as OverallCourtDate,
				MACOMB.mcmb_fnt_statutetext(c.charge_id) as Charge,
				MACOMB.mcmb_fnt_CaseNumber(c.charge_id) as Case#,
		        NVL(to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_SentEndDate(c.charge_id)),'MM/DD/YYYY'),'$' || MACOMB.mcmb_fnt_BailAmount(c.charge_id)) as OutdateBond,
		        	--be sure to verify this against pay-or-stay 
		        INITCAP(EPIC.ef_get_username1stlast(p_UserID)) as MCSDOfficer,     --<input prompt based on current user>  
		        --WRIT Officer (blank field on Crystal report)
				--Badge # (blank field on Crystal report)
				--WRIT date (blank field on Crystal report)
				--Dept & Section (blank field on Crystal report)
				EPIC.ef_offender_id(ab.entity_id) as Descriptor#
				--Phone# (blank field on Crystal report)
				--Other Remarks (blank field on Crystal report)	

		FROM	EPIC.eh_active_booking ab,
				EPIC.eh_charge c

		WHERE	ab.booking_id = c.booking_id
				and c.charge_state <> '6'
				and ab.entity_id = p_EntityID  --<input prompt based on current inmate> 
				
		ORDER BY c.index_number;
		 

END;   
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_DispFaceShtBk
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_booking.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ72
	Crystal: 		DispInmateFaceSheetBK_sub.rpt (Sub Report: Part 2 of 3). Main report: DisposedFaceSheet_Main.rpt
	Purpose:		Used by the Jail Office to list information on one screen for the selected inmate
					in regards to disposed charges only. This report also uses the same procedures for
					demographics & holds as the original Inmate Profile Sheet (mcmb_rpt_facesheetdemo;
					mcmb_rpt_faceshetholds)
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	09/28/06		Created 
					R. Stuve	11/21/06		Added Next Court Date (per SRF 12791)
					R. Stuve	04/04/07		Removed to_date function from DispoDate to correct discrepancy				
					
*/
 				
BEGIN 
	OPEN vCur FOR
	SELECT	to_char(EPIC.ef_epic_date_to_date(bk.start_date), 'MM/DD/YYYY') as BookingDate,
			substr(EPIC.ef_epic_date_to_date(bk.start_date),12,5) as BookingTime,
			bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
			MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
			MACOMB.mf_NextCourtDate_Charge(ch.charge_id) as NextCourtDate, 
			MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
			to_char(EPIC.ef_epic_date_to_date(ch.offense_date), 'MM/DD/YYYY') as OffenseDate,
			MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
			MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
			MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
			to_char(EPIC.ef_epic_date_to_date(MACOMB.mf_SentEndDate(ch.charge_id)), 'MM/DD/YYYY') as SentenceEndDate,
			EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
			MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
			bk.entity_id as EntityID

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_active_booking ab,
			EPIC.eh_charge ch
		
	WHERE 	ab.booking_id = bk.booking_id
			and bk.booking_id = ch.booking_id
			and ch.charge_state = '6'
			and bk.entity_id = p_InmateID
	
	ORDER BY DispoDate desc, OffenseDate desc, ch.index_number desc;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistClassBook
	(	vCur 			out 	epic.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		epic.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ41
	Crystal: 		HistClassBk_sub.rpt (Sub Report: Part 2 of 4)
	Purpose:		Used by Classification to list inmate's history; different sort than original History Report (non-disposed first);
					Also does not display 'Confidential' holds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/17/07		Created 
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    MACOMB.mcmb_fnt_DispoDate(ch.charge_id) as DispoDate,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate,
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    ch.charge_state as ChargeState

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID

	ORDER BY BookingDate desc, ch.charge_state, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistClassDemo
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ41
	Crystal: 		HistClass_main.rpt (Main Report: Part 1 of 4)
	Purpose:		Used by Classification to list inmate's history; different sort than original History Report (non-disposed first);
					Also does not display 'Confidential' holds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/17/07		Created 
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			MACOMB.mcmb_fnt_alphabin_current(ep.entity_id) as Bin,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_drvlicense(ep.entity_id) as Driver_License,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    substr(epi.social_security_number,1,3)||'-'||substr(epi.social_security_number,4,2)||'-'||substr(epi.social_security_number,6,4) as SSN,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip,
			EPIC.ef_lookup_text ('SECURITY CLASSIFICATION', EPIC.ef_get_Security_Class(ep.entity_id), 'UC') as SecurityClass,
			MACOMB.mcmb_fnt_ReviewDate(ep.entity_id) as ReviewDate,
			'' as KeepSepNo,
			'' as KeepSepName,
			'' as SepReason,
			v_date_null as KSEndDate,
			ep.entity_id as EntityId

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID

UNION ALL

	--KEEP SEPARATES (Not originating person)
	SELECT	'' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.origin_entity_id) as KeepSepNo,
			EPIC.ef_get_personororgname(ks.origin_entity_id) as KeepSepName,
			ks.separation_reason as SepReason,
			EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
			'' as EntityId
	
	FROM 	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.separate_entity_id
			and ep.entity_id = p_InmateID
	
UNION ALL
	
	--KEEP SEPARATES (Originating person)
	SELECT  '' as InmateName,
			'' as Bin,
			'' as Cell,
			'' as InmateNum,
			'' as Alias,
			'' as DOB,
			'' as BirthCity,
			'' as BirthState,
			'' as Driver_License,
			'' as Race,
			'' as Gender,
			'' as Height,
			'' as Weight,
			'' as Hair,
			'' as L_Eye,
			'' as R_Eye,
			'' as Complexion,
			'' as Phone,
			'' as SSN,
			'' as ActiveAlerts,
			'' as Address,
			'' as City,
			'' as State,
			'' as Zip,
			'' as SecurityClass,
			'' as ReviewDate,
			EPIC.ef_offender_id(ks.separate_entity_id) as KeepSepNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as KeepSepName,
		    ks.separation_reason as SepReason,
		    EPIC.ef_epic_date_to_date(ks.end_date) as KSEndDate,
		    '' as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = ks.origin_entity_id
			and ep.entity_id = p_InmateID; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistClassHolds
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS

/*	Form Usage: 	CRSTL.ZZ41
	Crystal: 		HistClassHd_sub.rpt (Main Report: Part 4 of 4)
	Purpose:		Used by Classification to list inmate's history; different sort than original History Report (non-disposed first);
					Also does not display holds with type of 'Confidential' or holds with charge severity of 'Non Public'
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/17/07		Created  
					R. Stuve	04/26/07		Changed Code_charge_severity clause to consider null values for correct comparison
*/
			
BEGIN

	OPEN vCur FOR
		--the below pulls all historical holds for the inmate with the exception of holds that are 'Confidential'
	SELECT  EPIC.ef_get_personororgname(bh.agency_id) as Dept_Held_For,
			EPIC.ef_epic_date_to_date(bh.start_date) as HoldStart,
			--ef_epic_date_to_date(bh.hold_removed_date) as HoldRemoved,
			bh.code_charge_severity as Severity,
			MACOMB.mcmb_fnt_hold_amt(bh.hold_id) as HoldAmount,
			EPIC.ef_lookup_text('HOLD TYPE',bh.code_hold_type,'UC') as HoldType,
			MACOMB.mcmb_fnt_hold_warrant(bh.hold_id) as WarrantNumber,
			bk.entity_id as EntityId

	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk
	
	WHERE	bk.booking_id = bh.booking_id
			and bk.entity_id = p_InmateID
			and (bh.hold_removed_date is null or bh.hold_removed_date > EPIC.epicdate(sysdate))
			and (bh.expiration_date is null or bh.expiration_date > EPIC.epicdate(sysdate))
			and bh.code_hold_type != '99'
			and nvl(bh.code_charge_severity,'null') <> 'EXP'
	
	ORDER BY HoldStart desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistClassNotes
	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ41
	Crystal: 		HistClassNt_sub.rpt (Sub Report: Part 3 of 4)
	Purpose:		Used by Classification to list inmate's history; different sort than original History Report (non-disposed first);
					Also does not display 'Confidential' holds
						
	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/17/07		Created 
*/


v_date_null date;
			
BEGIN

v_date_null := null; 

	OPEN vCur FOR
		--the below pulls all historical notes for the inmate
			--DEMOGRAPHICS NOTES
	SELECT	distinct 'DN' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_address a,
			EPIC.eh_booking bk
	
	WHERE	bk.entity_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

----------
UNION ALL
----------
			--FOOD REFUSAL NOTES
	SELECT 	'FR' as NoteType,
			EPIC.ef_epic_date_to_date(sd.delivery_date_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sd.delivery_date_time),12,5) as NoteTime,
	        sd.code_service_type as NoteTitle,
	        sd.code_item || ': ' || sd.comments as NoteText1_2,
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_service_delivery sd
	
	WHERE	bk.booking_id = sd.booking_id
			and sd.refused = 'Y'
			and sd.code_service_type = 'FOOD REFUSED'
			and bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--CHARGE NOTES
	SELECT  'CH' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_charge c,
			EPIC.eh_booking bk
	
	WHERE  	bk.booking_id = c.booking_id
			and c.charge_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--SENTENCING NOTES
	SELECT  'SE' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1  || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_note_book nb,
			EPIC.eh_sentence s,
			EPIC.eh_charge c,
			EPIC.eh_booking bk

	WHERE   bk.booking_id = c.booking_id
			and c.sentence_id = s.sentence_id
			and s.sentence_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

-------
UNION ALL
------
			--CLASSIFICATION NOTES
	SELECT	'SC' as NoteType,
		    EPIC.ef_epic_date_to_date(sc.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(sc.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
		    '' as NoteText3, 
		    '' as NoteText4, 
		    '' as NoteText5,
		    EPIC.ef_lookup_TEXT('SECURITY CLASSIFICATION', sc.classification, 'UC') as SCClass,
	        EPIC.ef_lookup_TEXT('CLASSIFICATION REASON', sc.code_reason, 'UC') as SCClassRes,
	       	sc.override_reason as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	        
	
	FROM	EPIC.eh_booking bk,
			EPICAUDIT.eh_security_classification sc
	
	WHERE   bk.booking_id = sc.booking_id
			and bk.entity_id = p_InmateID
			
--------
UNION ALL
--------
			--INCIDENT NOTES
	SELECT 'IN' as NoteType,
			EPIC.ef_epic_date_to_date(i.incident_date) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(i.incident_date),12,5) as NoteTime,
		    i.incident_number || ': ' || EPIC.ef_lookup_text('INCIDENT TYPE', i.code_incident_type, 'UC') as NoteTitle,
			'LOCATION: ' ||EPIC.ef_location_name(i.location_id, 'UC') || chr(13) || (select 'MECHANICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where i.mechanical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) || chr(13)|| (select 'CHEMICAL RESTRAINTS USED' from EPIC.eh_incident i, EPIC.eh_incident_offender io where  i.chemical_restraints_flag = 'Y' and io.entity_id = p_InmateID and io.incident_id = i.incident_id) as NoteText1_2,
			'' as NoteText3,
			'' as NoteText4, 
			'' as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        io.entity_id as EntityId
	        
	
	FROM	EPIC.eh_incident_offender io,
			EPIC.eh_incident i,
			EPIC.eh_incident_description id
	
	WHERE 	io.incident_id = i.incident_id
			and i.incident_id = id.incident_id  (+)      --added join on 7/13 RAS
			and io.entity_id = p_InmateID

------
UNION ALL
------
			--RESTRICTION NOTES
	SELECT	'DP' as NoteType,
		    EPIC.ef_epic_date_to_date(er.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(er.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        er.incident_id as DPIncidentId,
	        EPIC.ef_epic_date_to_date(er.begin_date) as DPResBegDate,
	        EPIC.ef_epic_date_to_date(er.end_date) as DPResEndDate,
	        EPIC.ef_lookup_TEXT('RESTRICTION TYPE',er.code_restriction_type,'UC') || ': ' ||EPIC.ef_lookup_TEXT('RESTRICTION REASON',er.code_restriction_reason,'UC') as DPResReason,
	        er.comments as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        er.entity_id as EntityId
	        
	
	FROM	EPIC.eh_entity_restriction er,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   er.entity_restriction_id = nb.epic_id (+)          --added join on 7/13 RAS
			and nb.note_id = n.note_ref (+)                    --added join on 7/13 RAS
			and er.entity_id = p_InmateID

--------
UNION ALL
--------
			--LOG NOTES
	SELECT	'LG' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        el.log_type as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05    
	        el.epic_id as EntityId
	
	FROM	EPIC.epic_notes n,
			EPIC.epic_entity_log el
	
	WHERE  	el.note_id = n.note_ref
			and el.epic_id = p_InmateID

-------
UNION ALL
-------
			--HOUSING ALLOCATION/MOVES NOTES
	SELECT  'CL' as NoteType,
			EPIC.ef_epic_date_to_date(ha.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ha.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    '' as NoteText1_2,
	        '' as NoteText3,
	        '' as NoteText4,
	        '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        EPIC.ef_epic_date_to_date(EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLStartDate,
			EPIC.ef_epic_date_to_date(EPIC.ef_end_housing_episode(ha.entity_id, ha.location_id, ha.action_time)) as CLEndDate,
	       	EPIC.ef_location_name(ha.location_id,'UC')as CLCellName,
	       	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'L') as CellClassLo,
		  	MACOMB.mcmb_fnt_ClassLevel(ha.location_id, EPIC.ef_start_housing_episode(ha.entity_id, ha.location_id, ha.action_time),'H') as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        ha.entity_id as EntityId
	
	FROM 	EPICAUDIT.eh_housing_assignments ha,
			EPIC.epic_locations loc
	
	WHERE 	loc.location_id = ha.location_id
			and ha.action_type = 'U'
			and ha.entity_id = p_InmateID

-----
UNION ALL
------
			--HOLD NOTES
	SELECT	'HO' as NoteType,
		    EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
	        n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05   
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking_holds bh,
			EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bh.booking_id
			and bh.hold_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BOOKING NOTES FROM OTHER ATTRIBUTES
	SELECT	'IB' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),12,5) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
            v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPICAUDIT.eh_generic_attribute ga
	
	WHERE	bk.booking_id = ga.item_id
			and bk.entity_id = p_InmateID

-------
UNION ALL
-------
			--BOOKING NOTES FROM NOTEBOOK
	SELECT 	'IB' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time)as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(n.action_time),12,5) as NoteTime,
		    n.note_name as NoteTitle,
	        n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
		    v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
		    EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE 	bk.booking_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID
	
-------
UNION ALL
-------
			--BAIL CONDITION NOTES FROM OTHER ATTRIBUTES
	SELECT	'BC' as NoteType,
		    EPIC.ef_epic_date_to_date(ga.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ga.action_time),11,6) as NoteTime,
		    ga.attribute_name as NoteTitle,
		    ga.attribute_value as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        bk.booking_number as NoteBkNo,
	        EPIC.ef_epic_date_to_date(bk.start_date) as NoteBkStart,
		    EPIC.ef_epic_date_to_date(bk.end_date) as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPICAUDIT.eh_generic_attribute ga
	
	WHERE	bk.booking_id = bc.booking_id
			and bc.bail_condition_id = ga.item_id
			and bk.entity_id = p_InmateID

-------
UNION ALL
--------
			--BAIL CONDITION NOTES FROM NOTEBOOK
	SELECT 	'BC' as NoteType,
			EPIC.ef_epic_date_to_date(n.action_time) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(n.action_time),11,6) as NoteTime,
			n.note_name as NoteTitle,
			n.note_text_1 || n.note_text_2 as NoteText1_2,
	        n.note_text_3 as NoteText3,
	        n.note_text_4 as NoteText4,
	        n.note_text_5 as NoteText5,
			'' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	       	bk.booking_number as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_booking bk,
			EPIC.eh_bail_condition bc,
			EPIC.epic_notes n,
			EPIC.epic_note_book nb
	
	WHERE   bk.booking_id = bc.booking_id
			and bc.bail_condition_id = nb.epic_id
			and nb.note_id = n.note_ref
			and bk.entity_id = p_InmateID

--------
UNION ALL
--------
			--KEEP SEPARATE NOTES
	SELECT 	distinct 'KS' as NoteType,
			EPIC.ef_epic_date_to_date(ks.action_time) as NoteDate,
		    substr(EPIC.ef_epic_date_to_date(ks.action_time),12,5) as NoteTime,
		    '' as NoteTitle,
		    ks.comments as NoteText1_2,
		    '' as NoteText3,
		    '' as NoteText4,
		    '' as NoteText5,
		    '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        EPIC.ef_offender_id(ks.origin_entity_id) as OriginKSNo,
		    EPIC.ef_get_personororgname(ks.origin_entity_id) as OriginKSName,
		    EPIC.ef_offender_id(ks.separate_entity_id) as SeparateKSNo,
		    EPIC.ef_get_personororgname(ks.separate_entity_id) as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        bk.entity_id as EntityId
	
	FROM	EPIC.eh_keep_separate ks,
			EPIC.eh_booking bk

	WHERE	(bk.entity_id = ks.separate_entity_id
				or
			bk.entity_id = ks.origin_entity_id)
			and bk.entity_id = p_InmateID 
-------
UNION ALL
--------			
			--RELEASE NOTES
	SELECT 	'BR' as NoteType,
			EPIC.ef_epic_date_to_date(r.actual_release) as NoteDate,
			substr(EPIC.ef_epic_date_to_date(r.actual_release),11,6) as NoteTime,
			EPIC.ef_lookup_text('RELEASE TYPE', r.release_type, 'UC') as NoteTitle,
			'' as NoteText1_2,
			'' as NoteText3,
			'' as NoteText4,
			'' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	       	v_date_null as CLStartDate,
	      	v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	       	v_date_null as NoteBkStart,
	       	v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	       	v_date_null as DPResBegDate,
	       	v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment,
	        v_date_null as PBReleaseDtTm,  -- added M.Zak 8-16-05
            bk.entity_id as EntityId
            
	FROM 	EPIC.eh_booking bk,
			EPIC.eh_release r

	WHERE	bk.booking_id = r.booking_id
			and bk.entity_id = p_InmateID  
 -------
UNION ALL
--------				
						
	SELECT	distinct 'PB' as NoteType,  -- M.Zak 8-11-05 added section
   	        EPIC.ef_epic_date_to_date(pi.ACTION_TIME)AS NoteDate,                    -- M.Zak 8-15-05 chgd pb. to pi.
   	        substr(EPIC.ef_epic_date_to_date(pi.action_time),12,5) as NoteTime,      -- M.Zak 8-15-05 chgd pb. to pi.
   	        'PROPERTY BIN    '|| '           BIN #: '||pb.bin_number as NoteTitle,
   	        '' as NoteText1_2,   -- 8-15-05   to save space - created note with just note title (1 line)
   	        '' as NoteText3,
   	        '' as NoteText4,
   	        '' as NoteText5,
	        '' as SCClass,
	        '' as SCClassRes,
	        '' as SCClassOverReas,
	        v_date_null as CLStartDate,     
	        v_date_null as CLEndDate,
	        '' as CLCellName,
	        '' as CelLClassLo,
	        '' as CellClassHi,
	        '' as OriginKSNo,
	        '' as OriginKSName,
	        '' as SeparateKSNo,
	        '' as SeparateKSName,
	        '' as NoteBkNo,
	        v_date_null as NoteBkStart,
	        v_date_null as NoteBkEnd,
	        '' as DPIncidentID,
	        v_date_null as DPResBegDate,
	        v_date_null as DPResEndDate,
	        '' as DPResReason,
	        '' as DPResComment, 
	        EPIC.ef_epic_date_to_date (psoi.action_time ) as PBReleaseDtTm,  -- added M.Zak 8-16-05
	        op.entity_id as EntityId
	        

	  FROM  EPICAUDIT.otk_property_bin pb,
            EPICAUDIT.eh_property_item pi,
            EPICAUDIT.eh_offender_property op,
            EPICAUDIT.eh_property_sent_out_item psoi,   -- added M.Zak 8-16-05
            EPIC.epic_lookups el

      WHERE	pb.bin_id = pi.bin_id
   			AND pi.item_id = op.item_id
   			AND op.item_id = psoi.item_id(+)   -- added M.Zak 8-16-05 
   			AND el.lookup_class = 'PROPERTY TYPE'
   			AND pi.item_name = el.lookup_code
   			AND op.entity_id = p_InmateID			

ORDER BY NoteDate desc;
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistPublic_Book
 (	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ38
	Crystal: 		HistPublicListBk_sub.rpt (Sub Report: Part 2 of 2)
	Purpose:		Used by General Office when there is a public request for an inmate's history. Does not 
					show expunged or non-public charges.
						
	Author:			Rachel Stuve

	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					R. Stuve	  01/03/07	    Created 
					J. McBratnie  01/10/07      Moved to production					
*/
			
BEGIN 

	OPEN vCur FOR
		--the below pulls all bookings and charges for the inmate
	SELECT	EPIC.ef_epic_date_to_date(bk.start_date) as BookingDate,
		    substr(EPIC.ef_epic_date_to_date(bk.start_date),11,6) as BookingTime,
		    bk.booking_number as BookingNumber,
			MACOMB.mcmb_fnt_JudgeName_ChargeID(ch.charge_id) as Judge_Name,
		 	MACOMB.mcmb_fnt_CaseNumber(ch.charge_id) as Case_No,
		 	MACOMB.mcmb_fnt_ControlAgy(ch.charge_id) as ArrestingDept,
		 	EPIC.ef_epic_date_to_date(ch.offense_date) as OffenseDate,
		    MACOMB.mcmb_fnt_statutenumber(ch.charge_id) as ChargeStatuteNo,
		   	MACOMB.mcmb_fnt_statutetext(ch.charge_id) as ChargeStatuteDesc,
		   	MACOMB.mcmb_fnt_inmatestatus(ch.charge_id) as Status,
		   	sd.years as SentYears,
		    sd.months as SentMths,
		    sd.weeks as SentWeeks,
		    sd.days as SentDays,
		    (select sd.years from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentYears,
		   	(select sd.months from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		                    where s.sentence_id = sf.sentence_id
			       			and sf.duration_id = sd.sentence_duration_id) as PSentMths,
		    (select sd.weeks from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		        			where s.sentence_id = sf.sentence_id
			          		and sf.duration_id = sd.sentence_duration_id) as PSentWeeks,
		    (select sd.days from EPIC.eh_sentence_fine sf, EPIC.eh_sentence_duration sd
		     				where s.sentence_id = sf.sentence_id
			     			and sf.duration_id = sd.sentence_duration_id) as PSentDays,
		    to_char(MACOMB.mcmb_fnt_DispoDate(ch.charge_id), 'MM/DD/YYYY') as DispoDate,
		    EPIC.ef_lookup_text('DISPOSITION REASONS',ch.disposition_reason,'UC') as DispoReason,
		    EPIC.ef_epic_date_to_date(s.sentence_end_date) as SentenceEndDate,
		    EPIC.ef_epic_date_to_date(r.actual_release) as ActualReleaseDate,
		    MACOMB.mcmb_fnt_BailAmount(ch.charge_id) as BailAmtCash,
		    MACOMB.mcmb_fnt_FineAmount(s.sentence_id) as FineAmt,
		    MACOMB.mcmb_fnt_BailPaid(ch.charge_id) as BailPaid,
		    MACOMB.mcmb_fnt_percentbail(ch.charge_id) as PercentBail,
		    bk.entity_id as EntityId,
		    ch.index_number as IndexNumber,
		    MACOMB.mf_GA_Charge(ch.charge_id, 'HELD FOR') as HeldFor,
			MACOMB.mf_GA_Charge(ch.charge_id, 'BONDING AGENCY') as BondingAgency,
			MACOMB.mf_GA_Charge(ch.charge_id, 'PACC CODE') as PACCCode,
			MACOMB.mf_GA_Charge(ch.charge_id, 'DIST VENUE') as DistVenue,
			MACOMB.mf_GA_Charge(ch.charge_id, 'CONVICTION SET ASIDE NON PUBLIC') as Conviction,
			MACOMB.mf_GA_Bail(ch.charge_id, 'COURT DISPOSITION') as CourtDispo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'EDUCATIONAL RELEASE') as EducRls,
			MACOMB.mf_GA_Sent(s.sentence_id, 'MISC SENTENCE INFO') as MiscSentInfo,
			MACOMB.mf_GA_Sent(s.sentence_id, 'RESTITUTION JUDGEMENT AMOUNT') as RestJudAmt,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WEEKENDER RELEASE TIME') as WeekenderRlsTime,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK RELEASE GRANTED') as WorkRlsGranted,
			MACOMB.mf_GA_Sent(s.sentence_id, 'WORK SEEK') as WorkSeek

	FROM   	EPIC.eh_booking bk,
			EPIC.eh_charge ch,
			EPIC.eh_sentence s,
			EPIC.eh_sentence_duration sd,
			EPIC.eh_release r
	
	WHERE 	bk.booking_id = ch.booking_id
			and ch.sentence_id = s.sentence_id (+)
			and s.duration_id = sd.sentence_duration_id (+)
			and bk.booking_id = r.booking_id (+)
			and bk.entity_id = p_InmateID 
			and not(MACOMB.mf_nonpblccharge(ch.charge_id) = 'Y' or MACOMB.mf_expngdcharge(ch.charge_id) = 'Y')

	ORDER BY BookingDate desc, OffenseDate desc, ch.index_number desc; 
			
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_HistPublic_Demo
 	(	vCur 			out 	EPIC.epp_generic_ref_cursor.ref_cursor,
		p_InmateID		in		EPIC.eh_entity_person.entity_id%type)
IS
/*	Form Usage: 	CRSTL.ZZ38
	Crystal: 		HistPublicList_Main.rpt (Main Report: Part 1 of 2)
	Purpose:		Used by General Office when there is a public request for an inmate's history. Does not 
					show expunged or non-public charges.
						
	Author:			Rachel Stuve

	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					R. Stuve	  01/03/07		Created 
				    J. McBratnie  01/10/07      Moved to production 
*/

v_date_null date;
			
BEGIN 

v_date_null := null;

	OPEN vCur FOR
		--the below pulls back basic demographic information for the top of the report
		SELECT 	
			EPIC.ef_get_personororgname(ep.entity_id) as InmateName,
			EPIC.ef_offender_cell(ep.entity_id)as Cell,
			EPIC.ef_offender_id(ep.entity_id) as InmateNum,
			MACOMB.mcmb_fnt_alias(ep.entity_id) as Alias,
			MACOMB.mcmb_fnt_DOB(ep.entity_id) as DOB,
			MACOMB.mcmb_fnt_birthcity (ep.entity_id) as BirthCity,
			MACOMB.mcmb_fnt_birthstate(ep.entity_id) as BirthState,
			MACOMB.mcmb_fnt_race(ep.entity_id) as Race,
			MACOMB.mcmb_fnt_Offender_Gender(ep.entity_id) as Gender,
			EPIC.ef_offender_height(ep.entity_id) as Height,
			EPIC.ef_offender_weight(ep.entity_id) as Weight,
			MACOMB.mcmb_fnt_haircolor(ep.entity_id) as Hair,
			MACOMB.mcmb_fnt_eyecolorleft(ep.entity_id) as L_Eye,
			MACOMB.mcmb_fnt_eyecolorright(ep.entity_id) as R_Eye,
			MACOMB.mcmb_fnt_complexion(ep.entity_id) as Complexion,
			EPIC.ef_offender_phone(ep.entity_id) as Phone,
		    MACOMB.mcmb_fnt_activealerts_trunc(ep.entity_id) as ActiveAlerts,
		    MACOMB.mcmb_fnt_address_numstr(ep.entity_id) as Address,
			MACOMB.mcmb_fnt_address_city(ep.entity_id) as City,
			MACOMB.mcmb_fnt_address_state(ep.entity_id) as State,
			MACOMB.mcmb_fnt_address_postal(ep.entity_id) as Zip

	FROM	EPIC.eh_person_identity epi,
			EPIC.eh_entity_person ep
	
	WHERE 	ep.entity_id = epi.entity_id
			and DECODE(epi.identity_id, ep.primary_identity_id, 'P', 'A') = 'P'
			and ep.entity_id = p_InmateID;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_NmAsscData
	(vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	v_FirstName		IN		varchar2,
	v_LastName		IN		varchar2)
	 	
IS
   
 /*	Form Usage:		linked to Crystal Enterprise server
 	Crystal: 		NmAsscData.rpt 
	Purpose:		Used by the Jail Administration to list all of the potential matches of external people
					and the inmates he/she is associated with

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/06		Created   
					R. Stuve	01/23/07		Commented out one name match and employer organization queries (per Sgt. Roberts)
					R. Stuve	01/25/07		Added RelatedRole field 
					R. Stuve	02/07/07		Commented out reversal of names to increase report speed
*/

p_FirstName	varchar2(100);
p_LastName	varchar2(100);
v_location	EPIC.epic_locations.location_id%type;
	
BEGIN

p_FirstName := '%' || UPPER(v_FirstName) || '%';
p_LastName := '%' || UPPER(v_LastName) || '%'; 

--get the location_id for 'MCJ' 
BEGIN	
	SELECT	location_id
	INTO	v_location
	FROM	EPIC.epic_locations
	WHERE 	location_name = 'MCJ';
END;	
  		
OPEN vCur FOR 
	--Visitors and Contacts--Two Name Match
	SELECT distinct	EPIC.ef_offender_id(er.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(er.entity_id) as InmateName,
			EPIC.ef_get_personororgname(er.entity_related_to) as ContactName,
			CASE er.relationship_type WHEN '_NOSP' THEN 'VISITOR'
				ELSE EPIC.ef_lookup_text('PERSONAL RELATIONSHIP',er.relationship_type,'UC') END as RelationshipType,
			DECODE (er.related_as_role, 'CNCT','CONTACT','CNTCT','CONTACT','VISTR','VISITOR','CONTACT') as RelatedRole,
			'Two Name Match' as Match
	
	FROM	EPIC.eh_entity_relationship er
	
	WHERE	er.entity_id <> v_location --facility visitors are handled elsewhere
			and (
				--first and last name match inputs (first = first; last = last)
				(substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_LastName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),',')+1) like p_FirstName)
	    	/*	--first and last name match inputs (first = last; last = first): for times where first & last may have been reversed
	    		or (substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_FirstName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),',')+1) like p_LastName)*/)
/*			
	--------------
	UNION ALL
	--------------
	--Visitors and Contacts--One Name Match
	SELECT distinct	EPIC.ef_offender_id(er.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(er.entity_id) as InmateName,
			EPIC.ef_get_personororgname(er.entity_related_to) as ContactName,
			CASE er.relationship_type WHEN '_NOSP' THEN 'VISITOR'
				ELSE EPIC.ef_lookup_text('PERSONAL RELATIONSHIP',er.relationship_type,'UC') END as RelationshipType,
			'One Name Match' as Match
	
	FROM	EPIC.eh_entity_relationship er
	
	WHERE	er.entity_id <> v_location --facility visitors are handled elsewhere
			and (
				--last name matches where first name is null
				(substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) like p_LastName
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),' ')+1) is null)
	    		--first name matches where last name is null
	    		or (substr(EPIC.ef_get_personororgname(er.entity_related_to),1,instr(EPIC.ef_get_personororgname(er.entity_related_to),',')-1) is null
			 		and substr(EPIC.ef_get_personororgname(er.entity_related_to),instr(EPIC.ef_get_personororgname(er.entity_related_to),' ')+1) like p_FirstName))
*/			
	--------------
	UNION ALL
	--------------
	--Employer Contacts--Two Name Match
	SELECT distinct EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.contact_person_id) as ContactName,
			'EMPLOYER CONTACT' as RelationshipType,
			null as RelatedRole,
			'Two Name Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	--first and last name match inputs (first = first; last = last)
			(substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_LastName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')+1) like p_FirstName)
			/*--first and last name match inputs (first = last; last = first): for times where first & last may have been reversed
	    	or (substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_FirstName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')+1) like p_LastName)*/
/*	
	--------------
	UNION ALL
	--------------
	--Employer Contacts--One Name Match
	SELECT	EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.contact_person_id) as ContactName,
			'EMPLOYER CONTACT' as RelationshipType,
			'One Name Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	--last name matches where first name is null
			(substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) like p_LastName
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),' ')+1) is null)
	    	--first name matches where last name is null
	    	or (substr(EPIC.ef_get_personororgname(ei.contact_person_id),1,instr(EPIC.ef_get_personororgname(ei.contact_person_id),',')-1) is null
			 	and substr(EPIC.ef_get_personororgname(ei.contact_person_id),instr(EPIC.ef_get_personororgname(ei.contact_person_id),' ')+1) like p_FirstName)
	
	--------------
	UNION ALL
	--------------
	--Employer Organizations--Employer Match (on both names)
	SELECT distinct EPIC.ef_offender_id(ei.entity_id) as InmateNumber,
			EPIC.ef_get_personororgname(ei.entity_id) as InmateName,
			EPIC.ef_get_personororgname(ei.organization_id) as ContactName,
			'EMPLOYER' as RelationshipType,
			'Employer Match' as Match
	
	FROM	EPIC.eh_entity_employment_info ei
	
	WHERE	EPIC.ef_get_personororgname(organization_id) like p_LastName
			and EPIC.ef_get_personororgname(organization_id) like p_FirstName
	
*/	
	ORDER BY Match, ContactName, InmateName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_NmAsscData2
	(vCur 			OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	v_FirstName		IN		varchar2,
	v_LastName		IN		varchar2)

IS

 /*	Form Usage:		linked to Crystal Enterprise server
 	Crystal: 		NmAsscData2.rpt (sub report)
	Purpose:		Used by the Jail Administration to list all of the potential matches of external people
					and the inmates he/she is associated with

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	06/13/06		Created
					R. Stuve	01/23/07		Modified WHERE clause to include 'and' instead of 'or' for FN/LN parameters
					R. Stuve	02/07/07		Removed from the Crystal report: may be added at a later time.
	
*/

p_FirstName	varchar2(100);
p_LastName	varchar2(100);
v_location	EPIC.epic_locations.location_id%type;

BEGIN

p_FirstName := '%' || UPPER(v_FirstName) || '%';
p_LastName := '%' || UPPER(v_LastName) || '%'; 

--get the location_id for 'MCJ' 
BEGIN	
	SELECT	location_id
	INTO	v_location
	FROM	EPIC.epic_locations
	WHERE 	location_name = 'MCJ';
END;

OPEN vCur FOR
	--Facility Visitors
	SELECT 	distinct EPIC.ef_get_personororgname(pi.entity_id),
			'FACILITY VISITORS' as Match

	FROM	EPIC.eh_entity_person ep,
			EPIC.eh_person_identity pi,
			EPIC.eh_entity_relationship er

	WHERE   er.entity_id = v_location 
			and er.related_as_role = 'VISTR'
            and ep.entity_id = er.entity_related_to
            and pi.identity_id = ep.primary_identity_id
            and EPIC.ef_get_personororgname(pi.entity_id) like p_LastName
            and EPIC.ef_get_personororgname(pi.entity_id) like p_FirstName

 	---------------
 	UNION ALL
 	---------------
 	--Official Visitors
 	SELECT 	distinct EPIC.ef_get_personororgname(pi.entity_id),
 			'OFFICIAL VISITORS' as Match

	FROM	EPIC.eh_entity_person ep,
			EPIC.eh_person_identity pi,
			EPIC.eh_entity_relationship er

	WHERE	er.related_as_role = 'OFFVISTR'
            and ep.entity_id = er.entity_related_to
            and pi.identity_id = ep.primary_identity_id
 	        and EPIC.ef_get_personororgname(pi.entity_id) like p_LastName
            and EPIC.ef_get_personororgname(pi.entity_id) like p_FirstName;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mpr_PreArraignCell
 	(	vCur 		out		EPIC.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	CRSTL.ZZ48
	Crystal: 		prearraigncell.rpt
	Purpose:		List of Pre-Arraigned Inmates By Cell

	Author:			Mary Ann Zak

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					M Zak   	04/16/08        Created 
					M Zak       5-6-08          Modified per Sgt Roberts fields requested and format
*/
			
BEGIN  
		
	OPEN vCur FOR 
	    --the below query pulls back the header information
	   SELECT	1 as Flag,
				'Case Status (Pre Arraignment by Cell)' as RptTitle, 
				'' as InmateNum,
				'' as InmateName,
				'' as Cell,
				'' as ControlAgy,
 				'' as Sort,
 				'' as Floor

			
		FROM	dual
		
	UNION ALL		
		--the below query pulls back the actual report data	
SELECT	2 as Flag,
			'Case Status (Pre Arraignment by Cell)' as RptTitle,
			EPIC.ef_offender_id(ab.entity_id) as InmateNum,
			EPIC.ef_get_personororgname(ab.entity_id) as InmateName,
			EPIC.ef_offender_cell(ab.entity_id) as Cell,
			MACOMB.mcmb_fnt_ControlAgy(c.charge_id)as ControlAgy,
			(case	when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, HIGH%' then 'Z'
				when epic.ef_location_path_name(ha.location_id,'UC',6) like 'MENT HLTH, LOW%' then 'Y'
			 	when substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,2) = 'HO' then 'Y1'  -- added 1-14-08 MZ (per Glenn incorrect sort order)
				else substr(epic.ef_location_path_name(ha.location_id,'UC',7),1,1)
				end)  as Sort,
			substr(epic.ef_location_path_name(ha.location_id,'UC',5),1,instr(epic.ef_location_path_name(ha.location_id,'US',5),',',1)-1) as Floor



	FROM	EPIC.eh_active_booking ab,
			EPIC.eh_charge c,
			epic.eh_housing_assignments ha

	WHERE	ab.booking_id = c.booking_id
	        and ab.entity_id  =  ha.entity_id (+)
         	and c.charge_state != 6
			and ((MACOMB.mcmb_fnt_inmatestatus(c.charge_id) = 'PRE-ARRAIGNMENT DISTRICT')  or (MACOMB.mcmb_fnt_inmatestatus(c.charge_id) ='PRE-ARRAIGNMENT CIRCUIT COURT'))
	ORDER BY Flag, Floor, Sort, Cell;
     	
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MPR_ProofOfIncar
	(	vCur 			out		EPIC.epp_generic_ref_cursor.ref_cursor,  
	    p_Entity_ID		in		EPIC.eh_booking.booking_id%type,
	    p_UserID		in		EPIC.epic_user_names.user_int_id%type
	)
		
	 	
IS

/*	Form Usage: 	CRSTL.XX61
	Crystal: 		ProofOfIncar.rpt
	Purpose:		Letter written up, on release from booking officer
	                Inmate Proof of Incarecartion


	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	    02/17/05	Created
					M.Zak           03/09/06    Modified  
					R. Stuve		03/22/06 	Modified: formatted CurUsrSign so that name would display as FirstInitial.LastName
*/
	
		
			
BEGIN  

OPEN vCur FOR
		--the below query pulls back the actual report data		
SELECT	EPIC.ef_offender_1st_last_name(p_Entity_ID) as CurInmate, 
		EPIC.ef_epic_date_to_date(bk.start_date) as BkStDtTm,
		EPIC.ef_epic_date_to_date(r.actual_release) as BkEndDtTm,
		--EPIC.EF_Get_UserName1stLast(p_UserID) as CurUsrSign,   previous formatting: changed per above (RAS 3/22/06)
		substr(EPIC.ef_Get_UserName1stLast(p_UserID),1,1) || '. ' || substr(EPIC.ef_get_username1stlast(p_UserID),instr(EPIC.ef_get_username1stlast(p_UserID),' ',1)+1) as CurUsrSign,
		EPIC.ef_user_title_by_int_id(p_UserID) as CurUsrSignTitle

FROM	EPIC.eh_booking bk,
		EPIC.eh_release r

WHERE	bk.entity_id = p_Entity_ID
		and bk.booking_id = r.booking_id
		and bk.booking_id = MACOMB.MF_Bookid_Most_Recent(p_Entity_ID);  --maz added function MF_Bookid_Most_Recent
		
END;  
--RAS
/

CREATE OR REPLACE
package MACOMB.mp_Actfas_interface
is		
	--	 process commissary file from the Actfas system  KJH 02/2008
procedure mp_Inmate_Released
     (p_order_id      in    epic.eh_offender_ids.offender_id%type,
    p_offender_id in    epic.eh_offender_ids.offender_id%type);
    
 procedure mp_ACCT_CLOSED
     (p_order_id      in    epic.eh_offender_ids.offender_id%type,
      p_offender_id in    epic.eh_offender_ids.offender_id%type); 
      	
	FUNCTION mf_find_dup_orders
	 (p_trust_id IN epic.eh_trust_account.trust_account_id%TYPE,
	  p_order_id in epic.eh_trust_account_trans.description%TYPE)
	  RETURN VARCHAR2;
		
	procedure post_nsf (
		p_order_id            in        epic.eh_trust_account_trans.code_trans_type%type,
		p_amt 					in 		epic.eh_trust_account_trans.amount%type);
    
procedure report_dup ( 
	p_order_id      in    epic.eh_offender_ids.offender_id%type,
  p_offender_id in    epic.eh_offender_ids.offender_id%type);
		
	Procedure post_commissary_trans (
	p_entity_id		 in    epic.eh_offender_ids.entity_id%type,          
	p_amt			 in 	epic.eh_trust_account_trans.amount%type,
	p_order_id      in    epic.eh_trust_account_trans.code_trans_type%type,
	p_trans_type  in     epic.eh_trust_account_trans.code_trans_type%type);  
	
	procedure process_request;
	
end mp_Actfas_interface;
/

CREATE OR REPLACE
package body MACOMB.mp_Actfas_interface                 --February, 2008 for SRF 12903 	
is
--  Checks the inmate funds balance to verify that account has sufficient money for the transaction,
-- If   balance is sufficient, post_commissary_trans is fired off.
-- if not, the transaction is rejected, post_nsf is initiated and the acct info is written to a report for Inmate Funds and/or Commissary

procedure mp_Inmate_Released ( 
	p_order_id      in    epic.eh_offender_ids.offender_id%type,
    p_offender_id in    epic.eh_offender_ids.offender_id%type)
  is	   
Begin 
--dbms_output.put_line('line 48 report_dup ' || p_order_id || ' ' || p_offender_id);
UPDATE mt_commissary_in
		set trans_status = 'RELSD'		
		Where order_id = p_order_id
    and offender_id = p_offender_id;
  Commit;  
end;

procedure mp_acct_closed ( 
	p_order_id      in    epic.eh_offender_ids.offender_id%type,
    p_offender_id in    epic.eh_offender_ids.offender_id%type)
  is	   
Begin 
UPDATE mt_commissary_in
		set trans_status = 'CLOSED'		
		Where order_id = p_order_id
    and offender_id = p_offender_id;
  Commit;  
end;

FUNCTION mf_find_dup_orders
	 (p_trust_id IN epic.eh_trust_account.trust_account_id%TYPE,
	  p_order_id in epic.eh_trust_account_trans.description% TYPE)
--Returns 'DUP'  if the trust account input already has a transaction description with a matching order_ID, Otherwise return 'OK'. 	 

RETURN VARCHAR2 AS
  CURSOR curTran IS          
  		select
 			'DUP'
 		from
 			epic.eh_trust_account_trans tat
 		where tat.trust_account_id = p_trust_id
 		and RTRIM(LTRIM(tat.description, 'COMMISSARY '),' REFUND') = rtrim(ltrim(p_order_id));  		
	v_Tran 		epic.eh_trust_account_trans.description% TYPE;
BEGIN
  	OPEN curTran;
  		FETCH curTran INTO v_Tran;
  	CLOSE curTran;
RETURN NVL (v_Tran,'OK');    		
END;  --mf_find_dup_orders

procedure post_nsf ( 
	p_order_id      in    epic.eh_trust_account_trans.code_trans_type%type,
	p_amt			 in 	epic.eh_trust_account_trans.amount%type	)
is	   
Begin 
dbms_output.put_line('line 34 post_nsf ' || p_order_id);
UPDATE mt_commissary_in
		set trans_status = 'NSF',
		trans_amount = p_amt
		Where order_id = p_order_id;
		Commit;  
end;

procedure report_dup ( 
	p_order_id      in    epic.eh_offender_ids.offender_id%type,
  p_offender_id in    epic.eh_offender_ids.offender_id%type)
  is	   
Begin 
dbms_output.put_line('line 48 report_dup ' || p_order_id || ' ' || p_offender_id);
UPDATE mt_commissary_in
		set trans_status = 'DUP'		
		Where order_id = p_order_id
    and offender_id = p_offender_id
    and trans_status IS NULL;
		Commit;  
end;	

procedure post_commissary_trans(   				
	p_entity_id		 in    epic.eh_offender_ids.entity_id%type,          
	p_amt			 in 	epic.eh_trust_account_trans.amount%type,
	p_order_id      in    epic.eh_trust_account_trans.code_trans_type%type,  --don't need this in here
	p_trans_type  in     epic.eh_trust_account_trans.code_trans_type%type)
	--s_success             out  epic.eh_offender_ids.offender_id%type)
is
------ Declare V ariables-------------------------- 
	s_success             epic.eh_offender_ids.offender_id%type;
	c_debug		constant boolean := false;
  	v_server_action_time       varchar2(20);   
  	v_trans_type        		varchar2(16);
  	v_code_source_of_funds  epic.eh_trust_account_trans.code_source_of_funds%type;
	v_trust_acct_trans_id       epic.eh_trust_account_trans.trust_account_trans_id%type;
	v_trust_id                       epic.eh_trust_account_trans.trust_account_id%type; 
	v_order_id                      epic.eh_trust_account_trans.trust_account_id%type;
	v_amt 							epic.eh_trust_account_trans.amount%type; 
	v_debit_amt                   epic.eh_trust_account_trans.amount%type; 
	v_credit_amt                  epic.eh_trust_account_trans.amount%type;
  	v_tran_desc                 epic.eh_trust_account_trans.description%type;
	p_check_amount			     epic.eh_trust_account_trans.amount%type;   
	p_result                 	epic.epic_col_types.number_9%type;
	p_result_msg               epic.epic_col_types.varchar_255%type;  
	
	Begin 
--Initialize variables----------------
	s_success    := Null;            
	v_trust_ID := macomb.mcmb_fnt_trust_id(p_entity_ID); 
	v_trust_acct_trans_id := epic.epic_ids.new_epic_id(); 
	v_trans_type := p_trans_type;
	v_server_action_time        := epic.epicdatenow;  
	p_check_amount := 0.00;
    p_result	   := 123;
    p_result_msg   := 'Commissary Trans';  
    v_tran_desc := ' ';

--If the trans_type comes in as 'C' for Credit, this transaction is a deposit , but posts as trans_type 'DEBIT' and needs a positive amount for trust acct transaction posting
	If p_trans_type = 'C' then    --(deposit/refund)
    v_trans_type := 'DEBIT';
		v_code_source_of_funds := '425';
		v_amt := ABS(p_amt);               
		v_debit_amt := p_amt;
		v_credit_amt := v_amt;
    v_tran_desc := ('COMMISSARY ' || p_order_id || ' ' || ' REFUND');
dbms_output.put_line('line 85 v_trans_type = DEBIT' ||  ' amt ' || v_amt); 		
	 --If the trans_type comes in as 'D' for debit, this transaction is a purchase, but posts as trans_type 'CREDIT' and needs a negative amount for trust acct transaction posting	
	else      --(purchase)
     v_trans_type := 'CREDIT';
	    v_code_source_of_funds := '520'; 
	    v_amt := p_amt * (-1);
	    v_debit_amt := ABS(p_amt);            
	    v_credit_amt := v_amt; 
      v_tran_desc := ('COMMISSARY ' || p_order_id);
dbms_output.put_line('line 93 trans_type = CREDIT' ||  ' amt ' || v_amt);
	end if; 
		epic.ep_trust_account_trans(v_trust_acct_trans_id,	v_trust_id,	v_trans_type, v_server_action_time,
			null, v_tran_desc, v_amt, null, null, 'CASH', null, null, v_code_source_of_funds, 
			'Auto-generated', null, null, null, null, null, 
			epic.ef_generate_autoid('TRUST ACCOUNTING TRANSACTION NUMBER',v_trust_id,'TRUST TRANSACTION'), 
			v_code_source_of_funds, v_debit_amt, 110, v_credit_amt, 'N', -25, 	p_check_amount, 	p_result, p_result_msg );
      
      UPDATE mt_commissary_in
        set trans_status = 'POSTED'        --This code added 9/23/09 because duplicates were updating BOTH records to 'DUP'
        Where order_id = p_order_id;     --See procedure report_dup within this package  KJH
      Commit;  
						
		-- Insert into the audit table.  This was noted in the ep_trust_account_trans function
		insert into epicaudit.eh_trust_account_trans
			select *
			From epic.eh_trust_account_trans
			Where
				trust_account_trans_id = v_trust_acct_trans_id;
     exception
		when others then
	   		s_success :='NO';
End ;	             

procedure process_request 
is

cursor curOrder is
select 
	order_id,
	offender_id,
	trans_amount, 
	trans_date, 
	trans_type	
 from macomb.mt_commissary_in
 order by order_id;  
     
--Declare variables
v_entity_id     epic.eh_trust_account.entity_id%type;
v_acct_bal     	epic.eh_trust_account_trans.amount%type; 
v_trans_amt    epic.eh_trust_account_trans.amount%type; 
v_trust_id        epic.eh_trust_account. trust_account_id%type;
v_trans_status  epic.eh_trust_account_trans.description%TYPE;
v_entity_status  epic.eh_booking_entity_status.code_entity_status%TYPE;
Begin

	for recOrder in curOrder
	loop

	v_entity_id := macomb.MCMB_FNT_get_entity_id(ltrim(recOrder.OFFENDER_ID, '0'));
	v_trust_id :=  macomb.mcmb_fnt_trust_id(v_entity_id);
	v_acct_bal := macomb.mcmb_fnt_inmatefunds(v_entity_id);
	v_trans_amt := recOrder.trans_amount; 
    v_trans_status := macomb.mp_actfas_interface.mf_find_dup_orders(v_trust_id, recOrder.order_id);-- DUP or OK
    v_entity_status := mcmb_fnt_entitystatus(v_entity_id);
--need to check for acct status of 'OPEN'  
IF v_entity_status <> 'RELEASED' then
	IF mf_trust_acct_status(v_trust_id) = 'OPEN' then
  		If v_trans_status = 'DUP' then 
        	mp_Actfas_interface.report_dup(recOrder.Order_id, recOrder.offender_id);    
		ElsIf  (recOrder.trans_type = 'D' and  v_acct_bal < recOrder.trans_amount ) then 
	 		mp_Actfas_interface.post_nsf(recOrder.order_id, v_trans_amt);
--dbms_output.put_line('line 164 NSF order ' || recOrder.order_id || ' Inmate ' || recOrder.offender_id);
		Else
	      mp_Actfas_interface.post_commissary_trans(v_entity_id, v_trans_amt, recOrder.order_id, recOrder.trans_type);
--dbms_output.put_line('Trans posted ' || recOrder.offender_id);
		End if; --'trans_status' = DUP
  	Else
    	mp_Actfas_Interface.mp_acct_closed(recOrder.Order_id, recOrder.offender_id);
	End if;	--acct_status = 'OPEN'
Else	
	mp_Actfas_Interface.mp_Inmate_Released(recOrder.Order_id, recOrder.offender_id);
End IF; --'Released'
	
End loop;
 Commit;
End;

End mp_actfas_interface;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_auto_LanseCreuse
	 (	v_response			OUT		varchar2)

IS
 
 /*	Purpose:		Generate LanseCreuse file.

	Author:			Joe McBratnie

	Change Log:		Changed By	  Date Modified	Change Made
					----------	  -------------	------------------------------------------
					J. McBratnie  9/18/06		Created 
*/
    
	v_request_id		varchar2(16);
	v_result            number(2,0);
	v_result_msg        varchar2(255);

BEGIN
        
	v_request_id := epic.epic_ids.new_epic_id();   
	
    EPIC.EHI_EH_INTERFACE_REQUEST (v_request_id, 'L ANSE CRUESE EDUCATION SYSTEM' ,  0, epic.epic_ids.new_epic_id(), -5 , -5, 
                                   epic.epicdatenow(), null,  'I', v_result, v_result_msg)   ;
    
    epic.epp_l_anse_cruese_edu.process_request(v_request_id, v_response);
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MP_GVT_Request
	 	
IS

 v_result number;
 v_result_msg varchar2(255);
 v_new_status varchar2(255);
 v_request_id varchar2(255);

--Assign the ID
begin
	v_request_id := EPIC.epic_ids.new_epic_id();

	--Insert the tracking record
 	EPIC.EHI_EH_INTERFACE_REQUEST ( v_request_id,'GVT EXPORT',null,null,-201,-25,	EPIC.epicdatenow(), null,'I',v_result,v_result_msg	);

	--Run the process
  	epic.mcmb_gvt_interface.process_request(v_request_id, v_new_status);
	commit; 
	--Update the request_status  Added 01/05/07
 	EPIC.EHI_EH_INTERFACE_REQUEST ( v_request_id,'GVT EXPORT','COMPLETED',null,-201,-25,	EPIC.epicdatenow(), null,'U',v_result,v_result_msg);

end;

/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_booking
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		date)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as Cell,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'H'
				and sort3 in ('01','02','03','04','05','06','07') 
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	cell || '=' as Cell,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'H'
				and sort3 in ('08','09','10','11','12','13','14') 
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	cell || '=' as Cell,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'H'
				and sort3 in ('15','16','17','18','19','20','21') 
				and datetm = p_time
						
		----------
		UNION ALL
		----------
		SELECT	'HC TOTAL',
				null,
				to_char(sum(count)),
				p_time as DateTime
		
		FROM	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'H'
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	cell || '=' as Cell,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'G'
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	'BLANK',
				null,
				null,
				null
		FROM	dual
		
		----------
		UNION ALL
		----------
		SELECT	cell || '=' as Cell,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'D'
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'DC TOTAL',
				null,
				to_char(sum(count)),
				p_time
		
		FROM	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Booking'
				and sort2 = 'D'
				and datetm = p_time;


END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_botsummary
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell as Cell,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime

		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Bot Summary'
				and sort2 in ('A','B','C','D','E')
				and datetm = p_time

		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	cell as Cell,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Bot Summary'
				and sort2 in ('F','G','H','I')
				and datetm = p_time
						
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	'BLANK',
				null,
				null
		FROM 	dual
		
		---------
		UNION ALL
		---------
		SELECT	cell as Cell,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time as DateTime
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Bot Summary'
				and sort2 in ('J','K','L','M')
				and datetm = p_time;


END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_dblock
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'D Block'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_Insert
	(p_date		IN		date)
			
IS                
/*	 		
	Purpose:		Procedure to insert data into the MACOMB.mt_jcs_monthly table by calling
					the 'insert' stored procedures

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve    04/19/06		Created
*/
  
BEGIN mp_jcs_ins_booking(p_date);
	  mp_jcs_ins_DBlock(p_date);
	  mp_jcs_ins_MS(p_date); 
	  mp_jcs_ins_station23(p_date);
	  mp_jcs_ins_tower23(p_date); 
	  mp_jcs_ins_tower45(p_date);
	  mp_jcs_ins_tower67(p_date);
	  mp_jcs_ins_tower89(p_date);
	  mp_jcs_ins_tower1011(p_date);
	  mp_jcs_ins_summary(p_date);
	  mp_jcs_ins_botsummary(p_date);
END;  
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_booking
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			0,
			sum(Cnt),
			p_date,
			'Booking',
			substr(Cell,1,1),
			substr(Cell,3,2)
	FROM
	(
	----------------------------------------------
	--the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
	  		EPIC.ef_location_name(ha.location_id,'UC') as Cell
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%BOOKING%'
	  		and (EPIC.ef_location_name(ha.location_id,'UC') like 'HC%'
	   			or EPIC.ef_location_name(ha.location_id,'UC') like 'DC%'
	   			or EPIC.ef_location_name(ha.location_id,'UC') like 'GYM')
	   		and ha.temporary_location_flag = 'N'
   			------------------EPICAUDIT----------------------
	   		and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
			----------------------EPICAUDIT--------------------
	GROUP BY  location_id
	------------
	UNION ALL
	------------
	--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
			EPIC.ef_location_name(l.location_id,'UC') as Cell
	
	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(l.location_id,'UC',5) like '%BOOKING%'
	  		and (EPIC.ef_location_name(l.location_id,'UC') like 'HC%'
	   			or EPIC.ef_location_name(l.location_id,'UC') like 'DC%'
	   			or EPIC.ef_location_name(l.location_id,'UC') like 'GYM')
   			--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	GROUP BY  location_id
	----------------------------------------------
	)
	GROUP BY Cell
	)
	ORDER BY 5,6 desc,7;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  
/*
BEGIN
	MACOMB.mp_jcs_insert(p_cur, 'MACOMB.mt_jcs_monthly');
END;
*/
COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_botsummary 
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	SELECT	'PAROLEE',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'A',
			null
	
	FROM	EPICAUDIT.eh_entity_status e,
			EPICAUDIT.eh_housing_assignments h

	WHERE 	e.code_custody_status = '3'
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
			and e.entity_id = h.entity_id
		 	and h.action_type = 'U'
		 	and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(h.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_status e2
			 	where EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) <= p_date
				and e.entity_id = e2.entity_id)
	
	---------
	UNION ALL
	---------
	
	SELECT	'FEDERAL',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'B',
			null
	
	FROM	EPICAUDIT.eh_entity_status e,
			EPICAUDIT.eh_housing_assignments h

	WHERE 	e.code_custody_status = '2'
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
			and e.entity_id = h.entity_id
		 	and h.action_type = 'U'
		 	and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(h.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_status e2
			 	where EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) <= p_date
				and e.entity_id = e2.entity_id)
		---------
	UNION ALL
	---------
	
	SELECT	'OTHER',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'C',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments h,
			EPICAUDIT.eh_entity_status e
	
	WHERE	h.entity_id = e.entity_id
			and e.code_custody_status in ('14','15','16')
			and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and h.action_type = 'U'
     		and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(h.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date
			 	)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_status e2
			 	where EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) <= p_date
				and e.entity_id = e2.entity_id)
	
	---------
	UNION ALL
	---------
	SELECT	'TOTAL CONTRACT INMATES',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'D',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments h,
			EPICAUDIT.eh_entity_status e
	
	WHERE	h.entity_id = e.entity_id
			and e.code_custody_status in ('2','3','14','15','16')
			and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and h.action_type = 'U'
	  		and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(h.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date
			 	)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_status e2
			 	where EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) <= p_date
				and e.entity_id = e2.entity_id)
		
	---------
	UNION ALL
	---------
	
	SELECT	'WORK RELEASE',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'E',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments h,
			EPICAUDIT.eh_entity_status e
	
	WHERE	h.entity_id = e.entity_id
			and e.code_custody_status = '5'
			and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(e.action_time) <= p_date
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and h.action_type = 'U'
	  		and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(h.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date
			 	)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_status e2
			 	where EPIC.ef_epic_date_to_date(e2.action_time) > EPIC.ef_epic_date_to_date(e.action_time)
				and EPIC.ef_epic_date_to_date(e2.action_time) <= p_date
				and e.entity_id = e2.entity_id)
		
	
	---------
	UNION ALL
	---------
	
	SELECT	'JUVENILES',
			0,
			count(distinct h.entity_id),
			p_date,
			'Bot Summary',
			'F',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments h,
			EPICAUDIT.eh_entity_person p
	
	WHERE	h.entity_id = p.entity_id
			and p.juvenile_flag = 'Y'
			and h.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(p.action_time) <= p_date
			and EPIC.ef_epic_date_to_date(h.action_time) <= p_date
	        and h.action_type = 'U'
	  		and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments h2
                where h.entity_id = h2.entity_id
				and h2.location_id = h.location_id
		 		and h2.action_type = 'D'
		 	 	and EPIC.ef_epic_date_to_date(h2.action_time) >= EPIC.ef_epic_date_to_date(p.action_time)
			 	and EPIC.ef_epic_date_to_date(h2.action_time) <= p_date
			 	)
			 and not exists
			 	(select 1
			 	from EPICAUDIT.eh_entity_person p2
			 	where EPIC.ef_epic_date_to_date(p2.action_time) > EPIC.ef_epic_date_to_date(p.action_time)
				and EPIC.ef_epic_date_to_date(p2.action_time) <= p_date
				and p.entity_id = p2.entity_id)
	
	---------
	UNION ALL
	---------
	
	SELECT	'MEDICAL HOSP',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'G',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like 'HOSPITALS%'
			and EPIC.ef_location_path_name(location_id,'UC',6) not like '%PSYCHIATRIC%'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
		
	---------
	UNION ALL
	---------
	
	SELECT	'PSYCH HOSP',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'H',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha

	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like '%PSYCHIATRIC%'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	---------
	UNION ALL
	---------
	
	SELECT	'WRIT',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'I',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) = 'WRIT'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	---------
	UNION ALL
	---------
	
	SELECT	'MALE',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'J',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha

	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'M'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	---------
	UNION ALL
	---------
	
	SELECT	'FEMALE',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'K',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha

	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'F'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	---------
	UNION ALL
	---------
	
	SELECT	'UNKNOWN',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'L',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha

	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'U'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	---------
	UNION ALL
	---------
	
	SELECT	'TOTAL INMATES',
			0,
			count(distinct ha.entity_id),
			p_date,
			'Bot Summary',
			'M',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha

	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) != 'WRIT'
			--and MACOMB.mcmb_fnt_gendershort(ha.entity_id) in ('M','F','U')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	)
	ORDER BY 5,6;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_DBlock  
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)),
			nvl(SUM(Cnt),0),
			p_date,
			'D Block',
			decode(Cell,'D1PC','01','D2PC','02','D3PC','03','D4PC','04','D5PC','05','D6PC','06'),
			substr(Cell,2,2)
	
	FROM
	(
	----------------------------------------------
	--the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			EPIC.ef_location_name(ha.location_id, 'UC') as Cell
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	(EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%LOW D%'
				or EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%UPPER D%')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)

	
	GROUP BY  EPIC.ef_location_name(ha.location_id, 'UC')
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
			EPIC.ef_location_path_name(l.location_id,'UC',7) as Cell
	
	FROM	EPICAUDIT.epic_locations l
	
	WHERE	(EPIC.ef_location_path_name(l.location_id,'UC',5) like '%LOW D%'
			 	or EPIC.ef_location_path_name(l.location_id,'UC',5) like '%UPPER D%')
			and EPIC.ef_location_path_name(l.location_id,'UC',7) is not null
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------

	GROUP BY EPIC.ef_location_path_name(l.location_id,'UC',7)
	----------------------------------------------
	)
	GROUP BY Cell
	
	----------
	UNION ALL
	----------
	--this portion pulls the Grand Total for Low D cells (D1PC-D6PC)
	SELECT 	'LowDTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D01-D06')),
			nvl(sum(count(distinct ha.entity_id)),0),
			p_date,
			'D Block',
			'07',
			'07'
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'LOW D,%'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--this portion pulls the Grand Total for Upper D cells (D07-D12)
	SELECT  'UpperDTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D07-D12')),
			nvl(sum(count(distinct ha.entity_id)),0),
			p_date,
			'D Block',
			'',
			'13'
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'UPPER D,%'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
		)
		ORDER BY 5,6,7;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  
COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_history
	(p_date		IN		date)
IS
 
/*	Purpose:		To return JSC data from the EPIC tables and insert into the MACOMB.mt_jcs_history table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	04/19/06		Created 
*/
BEGIN 
BEGIN
	INSERT INTO MACOMB.mt_jcs_history 
	SELECT  'HC04',
			0,
			count(entity_id),
			p_date,
			'A'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_name(location_id, 'UC') = 'HC04'
			and temporary_location_flag = 'N'

	-----------
	UNION ALL
	-----------
	SELECT	'BOOK HC TOTAL',
			0,
			sum(count(entity_id)),
			p_date,
			'B'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_name(location_id, 'UC') like 'HC%'
			and temporary_location_flag = 'N'
	GROUP BY entity_id

	-----------
	UNION ALL
	-----------
	SELECT	'GYM',
			0,
			count(entity_id),
			p_date,
			'C'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_name(location_id, 'UC') = 'GYM'
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'BOOK DC TOTAL',
			0,
			sum(count(entity_id)),
			p_date,
			'D'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_name(location_id, 'UC') like 'DC%'
			and temporary_location_flag = 'N'
	GROUP BY entity_id

	-----------
	UNION ALL
	-----------
	SELECT 	'LOW D TOTAL',
			 to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D01-D06')),
			 sum(count(entity_id)),
			 p_date,
			 'E'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like 'LOW D,%'
			and temporary_location_flag = 'N'
	GROUP BY entity_id
	
	-----------
	UNION ALL
	-----------
	SELECT  'UPPER D TOTAL',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D07-D12')),
			sum(count(entity_id)),
			p_date,
			'F'
	FROM	EPIC.eh_housing_assignments
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like 'UPPER D,%'
			and temporary_location_flag = 'N'
	GROUP BY entity_id
	
	-----------
	UNION ALL
	-----------
	SELECT	'MH1-17',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('MH1-17%')),
			count(entity_id),
			p_date,
			'G'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, LOW%'
			and temporary_location_flag = 'N'

	-----------
	UNION ALL
	-----------
	SELECT	'MH18-24',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('MH18-24%')),
			count(entity_id),
			p_date,
			'H'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, HIGH%'
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'BOOKING A-C',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking A%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking B%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking C%')),
			count(entity_id),
			p_date,
			'I'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) in ('BOOKING, A','BOOKING, B','BOOKING, C')
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'ANNEX-A',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Annex A%')),
			count(entity_id),
			p_date,
			'J'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, A'
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'ANNEX-B',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Annex B%')),
			count(entity_id),
			p_date,
			'K'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, B'
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'MEDICAL UNIT',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Medical Unit%')),
			count(entity_id),
			p_date,
			'L'
	FROM 	EPIC.eh_housing_assignments
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'MED CONTRL, MEDICAL'
			and temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'PAROLEE',
			0,
			count(ha.entity_id),
			p_date,
			'M'
	FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_entity_status e
	WHERE	ha.entity_id = e.entity_id
			and e.code_custody_status = '3'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'FEDERAL',
			0,
			count(ha.entity_id),
			p_date,
			'N'
	FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_entity_status e
	WHERE	ha.entity_id = e.entity_id
			and e.code_custody_status = '2'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'TOTAL CONTRACT',
			0,
			count(ha.entity_id),
			p_date,
			'O'
	FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_entity_status e
	WHERE	ha.entity_id = e.entity_id
			and e.code_custody_status in ('2','3','14','15','16')
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'WORK RELEASE',
			0,
			count(ha.entity_id),
			p_date,
			'P'
	FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_entity_status e
	WHERE	ha.entity_id = e.entity_id
			and e.code_custody_status = '5'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'JUVENILES',
			0,
			count(ha.entity_id),
			p_date,
			'Q'
	FROM	EPIC.eh_housing_assignments ha,
			EPIC.eh_entity_person p
	WHERE	ha.entity_id = p.entity_id
			and p.juvenile_flag = 'Y'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'MEDICAL HOSP',
			0,
			count(ha.entity_id),
			p_date,
			'R'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like 'HOSPITALS%'
			and EPIC.ef_location_path_name(location_id,'UC',6) not like '%PSYCHIATRIC%'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'PSYCH HOSP',
			0,
			count(ha.entity_id),
			p_date,
			'S'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) like '%PSYCHIATRIC%'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'WRIT',
			0,
			count(ha.entity_id),
			p_date,
			'T'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) = 'WRIT'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'MALE',
			0,
			count(ha.entity_id),
			p_date,
			'U'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'M'
			and ha.temporary_location_flag = 'N'
	
	-----------
	UNION ALL
	-----------
	SELECT	'FEMALE',
			0,
			count(ha.entity_id),
			p_date,
			'V'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) = 'F'
			and ha.temporary_location_flag = 'N'

	-----------
	UNION ALL
	-----------
	SELECT	'TOTAL INMATES',
			0,
			count(ha.entity_id),
			p_date,
			'W'
	FROM	EPIC.eh_housing_assignments ha
	WHERE	EPIC.ef_location_path_name(location_id,'UC',6) != 'WRIT'
			and MACOMB.mcmb_fnt_gendershort(ha.entity_id) in ('M','F','U')
			and ha.temporary_location_flag = 'N'
	
	ORDER BY 5;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_MS
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)) as Capacity,
			SUM(Cnt)as CellCnt,
			p_date,
			'MS',
			substr(Cell,3,2),
			null
	FROM
	(
	----------------------------------------------
	--the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(ha.entity_id) as Cnt,
	  		substr(EPIC.ef_location_path_name(ha.location_id, 'UC',6),1,4) as Cell
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%MAX%'
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and action_type = 'U'
	     	and not exists
			(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY  	substr(EPIC.ef_location_path_name(ha.location_id, 'UC', 6),1,4)
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
			substr(EPIC.ef_location_path_name(l.location_id,'UC',6),1,4) as Cell
	
	FROM 	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(l.location_id,'UC',5) like '%MAX%'
			and EPIC.ef_location_path_name(l.location_id,'UC',7) is not null
			and housing_flag = 'Y' 
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	
	GROUP BY  substr(EPIC.ef_location_path_name(l.location_id,'UC',6),1,4)
	----------------------------------------------
	)
	GROUP BY Cell
	
	---------
	UNION ALL
	---------
	--this portion pulls the Grand Total for cell groups MS01-MS06 (from the above query)
	SELECT 	'MS01-06Total',
			to_number(mcmb_fnt_RDCCapacity_Location('Max Security 1')),
			sum(count(ha.entity_id)),
			p_date,
			'MS',
			'061',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',6),1,4) in ('MS01','MS02','MS03','MS04','MS05','MS06')
			and temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and action_type = 'U'
			and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
			 	and ha.entity_id = ha2.entity_id
			 	and action_type = 'D'
			 	and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
			 	and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)

	GROUP BY entity_id
	---------
	UNION ALL
	---------
	--this portion pulls the Grand Total for cell groups MS07-MS12 (from the above query)
	SELECT  'MS07-MS12Total',
			 to_number(mcmb_fnt_RDCCapacity_Location('Max Security 2')),
			sum(count(ha.entity_id)),
			p_date,
			'MS',
			'13',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',6),1,4) in ('MS07','MS08','MS09','MS10','MS11','MS12')
			and temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and action_type = 'U'
			and not exists
				(select 1
			 	from EPICAUDIT.eh_housing_assignments ha2
			 	where ha.location_id = ha2.location_id
			 	and ha.entity_id = ha2.entity_id
			 	and action_type = 'D'
			 	and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
			 	and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY entity_id
		)
	ORDER BY 5,6;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_station23
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	 SELECT	Cell,
		to_number(MACOMB.mcmb_fnt_rdccapacity_cell(Cell)),
		SUM(Cnt),
		p_date,
		'Station 2/3',
		substr(Cell,1,1),
		null

	FROM
	(
	----------------------------------------------
	--the below query pulls the count of housed inmates for cells with a count >= 1
SELECT 	count(distinct ha.entity_id) as Cnt,
  		substr(EPIC.ef_location_name(ha.location_id, 'UC'),1,2) as Cell

FROM	EPICAUDIT.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%STATION%'
		and temporary_location_flag = 'N'
		and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
       	and ha.action_type = 'U'
		and not exists
				(select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)

GROUP BY  ha.location_id, ha.entity_id
----------------------------------------------
UNION ALL
----------------------------------------------
--the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
SELECT 	0 as Cnt,
		substr(EPIC.ef_location_name(location_id, 'UC'),1,2) as Cell

FROM	EPICAUDIT.epic_locations l

WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%STATION%'
		and EPIC.ef_location_path_name(location_id, 'UC',7) is not null
				--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
GROUP BY  substr(EPIC.ef_location_name(location_id, 'UC'),1,2)
----------------------------------------------
)
GROUP BY Cell

---------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups 1A-1D (from the above query)
SELECT  '1A-1DTotal',
		to_number(mcmb_fnt_RDCCapacity_Location('Minimum Security 1A-1D')),
		sum(count(distinct ha.entity_id)),
		p_date,
		'Station 2/3',
		'2',
		null

FROM	EPICAUDIT.eh_housing_assignments  ha
 
WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 2,%'
		and temporary_location_flag = 'N'
		and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
       	and ha.action_type = 'U'
		and not exists
			(select 1
			from EPICAUDIT.eh_housing_assignments ha2
		 	where ha.location_id = ha2.location_id
		 	and ha.entity_id = ha2.entity_id
			and ha2.action_type = 'D'
		 	and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
		 	and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)

GROUP BY entity_id

-------
UNION ALL
---------
--this portion pulls the Grand Total for cell groups RA-RD (from the above query)
SELECT  'RA-RDTotal',
		to_number(mcmb_fnt_RDCCapacity_Location('Minimum Security 2A-2D')),
		sum(count(distinct ha.entity_id)),
		p_date,
		'Station 2/3',
		'S',
		null

FROM	EPICAUDIT.eh_housing_assignments ha

WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 3,%'
		and ha.temporary_location_flag = 'N'
		and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
       	and ha.action_type = 'U'
		and not exists
			(select 1
			from EPICAUDIT.eh_housing_assignments ha2
			where ha.location_id = ha2.location_id
			and ha.entity_id = ha2.entity_id
			and ha2.action_type = 'D'
			and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
			and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)

GROUP BY entity_id
	)
	ORDER BY 5,6;
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_summary
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	SELECT	'TOWER 2/3',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 2/3%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'A',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 3%'
		  	and ha.temporary_location_flag = 'N'
		  	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'TOWER 4/5',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 4/5%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'B',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 5%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'TOWER 6/7',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 6/7%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'C',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 7%'
	      	and ha.temporary_location_flag = 'N'
		    and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'TOWER 8/9',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 8/9%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'D',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR 9%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'TOWER 10/11',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 10/11%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'E',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'TWR11%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'MAX SECURITY 1',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Max Security 1%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'F',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 1%'
	       	and ha.temporary_location_flag = 'N'
	       	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'MAX SECURITY 2',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Max Security 2%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'G',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'MAX 2%'
		  	and ha.temporary_location_flag = 'N'
		  	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'STATION 2 1A-1D',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Minimum Security 1A-1D%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'H',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 2%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'STATION 3 2A-2D',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Minimum Security 2A-2D%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'I',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	EPIC.ef_location_path_name(ha.location_id,'UC',5) like 'STATION 3%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'D01-D06',
			MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D01-D06%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'J',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MED CONTRL, LOW D%'
	      	and ha.temporary_location_flag = 'N' 
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'D07-D12',
			MACOMB.mcmb_fnt_RDCCapacity_Location('D-Block: D07-D12%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'K',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) like 'MH CONTRL, UPPER D%'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'MH1-17',
			MACOMB.mcmb_fnt_RDCCapacity_Location('MH1-17%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'L',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, LOW%'
	      	and ha.temporary_location_flag = 'N' 
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'MH18-24',
			MACOMB.mcmb_fnt_RDCCapacity_Location('MH18-24%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'M',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,3)-1) like 'MH CONTRL, MENT HLTH, HIGH%'
	      	and ha.temporary_location_flag = 'N' 
	     	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--------
	UNION ALL
	--------
	
	SELECT	'BOOKING A-C',
			to_char(to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking A%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking B%')) + to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Booking C%'))),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'N',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) in ('BOOKING, A','BOOKING, B','BOOKING, C')
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'ANNEX-A',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Annex A%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'O',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, A'
	      	and ha.temporary_location_flag = 'N' 
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'ANNEX-B',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Annex B%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'P',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'ANNEX, B'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	--RATED DESIGN CAPACITY: CALCULATED BY CRYSTAL
	
	--------
	UNION ALL
	--------
	
	SELECT	'BOOKING HOLDING CELLS',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Booking Holding Cells%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'Q',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',6) like 'HOLDING%'
	        and ha.temporary_location_flag = 'N'
	        and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
		    and ha.action_type = 'U'
			and not exists
				   (select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	--------
	UNION ALL
	--------
	
	SELECT	'MEDICAL UNIT',
			MACOMB.mcmb_fnt_RDCCapacity_Location('Medical Unit%'),
			count(distinct ha.entity_id),
			p_date,
			'Summary',
			'R',
			null
	
	FROM 	EPICAUDIT.eh_housing_assignments ha
	
	WHERE 	substr(EPIC.ef_location_path_name(location_id,'UC',5),1,instr(EPIC.ef_location_path_name(location_id,'UC',5),',',1,2)-1) = 'MED CONTRL, MEDICAL'
	      	and ha.temporary_location_flag = 'N'
	      	and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	      	and ha.action_type = 'U'
		  	and not exists
			   (select 1
				from EPICAUDIT.eh_housing_assignments ha2
				where ha.location_id = ha2.location_id
				and ha.entity_id = ha2.entity_id
				and ha2.action_type = 'D'
				and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
				and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	      
	--TOTAL BEDS: CALCULATED BY CRYSTAL QUERY 
		
	--GENERAL USE BEDSPACE: CALCULATED BY CRYSTAL QUERY	
	)
	ORDER BY 5,6;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_tower1011
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO macomb.mt_jcs_monthly
	(
	--10/11: this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)),
			sum(Cnt),
			p_date,
			'Tower 10/11',
			Sort,
			null
	FROM
	(
	----------------------------------------------
	--10/11: the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,3) as Cell,
	      	substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1) as Sort

	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%TWR11%'
			and EPIC.ef_location_path_name(ha.location_id,'UC',8) is not null
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY location_id
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--10/11: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
	 		substr(EPIC.ef_location_path_name(location_id,'UC',8),1,3) as Cell,
        	substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort

	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR11%'
			and EPIC.ef_location_path_name(location_id,'UC',8) is not null
	
						--------------EPICAUDIT LOC----------------------
		   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
		   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
		   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
		   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
		   		and not exists
					(select 1
					from EPICAUDIT.epic_locations l2
					where l.location_id = l2.location_id
					and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
					and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
			    ----------------EPICAUDIT LOC--------------------
	GROUP BY  location_id
	----------------------------------------------
	)
	GROUP BY Cell, Sort
	
	---------
	UNION ALL
	---------
	--10/11: this portion pulls the Grand Total for cell groups A-C
	SELECT 	'10/11: A-CTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 10/11 East')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 10/11',
			'CC',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,3) in ('10A','11A','10B','11B','10C','11C')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--10/11: this portion pulls the Grand Total for cell groups D-F
	SELECT 	'10/11: D-FTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 10/11 West')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 10/11',
			'FF',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,3) in ('10D','11D','10E','11E','10F','11F')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
       )
	ORDER BY 5,6;
	
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  
COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_tower23 
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
 		--2/3: this portion pulls the combined inmate count for every cell: occupied or not
		SELECT	Cell,
				to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)),
				sum(Cnt),
				p_date,
				'Tower 2/3',
				Sort,
				null
		FROM
		(
		--2/3: the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) as Cell,
	      	substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%TWR 3%'
			and EPIC.ef_location_path_name(ha.location_id,'UC',8) is not null
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	
	GROUP BY 	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--2/3: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
		 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
	        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort

	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 3%'
			and EPIC.ef_location_path_name(location_id,'UC',8) is not null
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	
	GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
	 		
	----------------------------------------------
	)
	GROUP BY Cell, Sort
	
	----------
	UNION ALL
	---------
	--2/3: this portion pulls the Grand Total for cell groups A-C
	SELECT 	'2/3: A-CTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 2/3 East')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 2/3',
			'CC',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('2A','3A','2B','3B','2C','3C')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--2/3: this portion pulls the Grand Total for cell groups D-F
	SELECT 	'2/3: D-FTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 2/3 West')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 2/3',
			'FF',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('2D','3D','2E','3E','2F','3F')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	
	GROUP BY ha.entity_id
	)	
		ORDER BY 5,6;
   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_tower45
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--4/5: this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)),
			sum(Cnt),
			p_date,
			'Tower 4/5',
			Sort,
			null
	FROM
	(
	----------------------------------------------
	--4/5: the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) as Cell,
	      	substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%TWR 5%'
			and EPIC.ef_location_path_name(ha.location_id,'UC',8) is not null
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY 	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--4/5: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
		 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
	        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 5%'
			and EPIC.ef_location_path_name(location_id,'UC',8) is not null
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	
	GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
	----------------------------------------------
	)
	GROUP BY Cell, Sort
	
	---------
	UNION ALL
	---------
	--4/5: this portion pulls the Grand Total for cell groups A-C
	SELECT 	'4/5: A-CTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 4/5 East')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 4/5',
			'CC',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('4A','5A','4B','5B','4C','5C')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--4/5: this portion pulls the Grand Total for cell groups D-F
	SELECT 	'4/5: D-FTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 4/5 West')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 4/5',
			'FF',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('4D','5D','4E','5E','4F','5F')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	)
	
	ORDER BY 5,6;

   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_tower67 
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--6/7: this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)),
			sum(Cnt),
			p_date,
			'Tower 6/7',
			Sort,
			null
	FROM
	(
	----------------------------------------------
	--6/7: the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) as Cell,
	      	substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%TWR 7%'
			and EPIC.ef_location_path_name(ha.location_id,'UC',8) is not null
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY 	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--6/7: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
		 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
	        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 7%'
			and EPIC.ef_location_path_name(location_id,'UC',8) is not null
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	
	GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
	----------------------------------------------
	)
	GROUP BY Cell, Sort
	
	---------
	UNION ALL
	---------
	--6/7: this portion pulls the Grand Total for cell groups A-C
	SELECT 	'6/7: A-CTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 6/7 East')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 6/7',
			'CC',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('6A','7A','6B','7B','6C','7C')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--6/7: this portion pulls the Grand Total for cell groups D-F
	SELECT 	'6/7: D-FTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 6/7 West')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 6/7',
			'FF',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('6D','7D','6E','7E','6F','7F')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id

	)
	ORDER BY 5,6;
   	EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  

COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ins_tower89
	(p_date		IN		date)

IS
 
/*	Purpose:		To return JSC data from the EPICAUDIT tables and insert into the MACOMB.mt_jcs_monthly table

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created 
*/
BEGIN 
BEGIN 
	INSERT INTO MACOMB.mt_jcs_monthly
	(
	--8/9: this portion pulls the combined inmate count for every cell: occupied or not
	SELECT	Cell,
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Cell(Cell)),
			sum(Cnt),
			p_date,
			'Tower 8/9',
			Sort,
			null
	FROM
	(
	----------------------------------------------
	--8/9: the below query pulls the count of housed inmates for cells with a count >= 1
	SELECT 	count(distinct ha.entity_id) as Cnt,
			substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) as Cell,
	      	substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	EPIC.ef_location_path_name(ha.location_id,'UC',5) like '%TWR 9%'
			and EPIC.ef_location_path_name(ha.location_id,'UC',8) is not null
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY 	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(ha.location_id,'UC',7),1,1)
	----------------------------------------------
	UNION ALL
	----------------------------------------------
	--8/9: the below query is an 'error-trapping' query to pull cells with zero inmate count, if applicable
	SELECT 	0 as Cnt,
		 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2) as Cell,
	        substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1) as Sort
	
	FROM	EPICAUDIT.epic_locations l
	
	WHERE	EPIC.ef_location_path_name(location_id,'UC',5) like '%TWR 9%'
			and EPIC.ef_location_path_name(location_id,'UC',8) is not null
					--------------EPICAUDIT LOC----------------------
	   		and (EPIC.ef_epic_date_to_date(l.eff_to_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_to_date) >= p_date)
	   		and (EPIC.ef_epic_date_to_date(l.eff_from_date) is null
	   			or EPIC.ef_epic_date_to_date(l.eff_from_date) <= p_date)
	   		and not exists
				(select 1
				from EPICAUDIT.epic_locations l2
				where l.location_id = l2.location_id
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) <= EPIC.ef_epic_date_to_date(l.eff_to_date)
				and EPIC.ef_epic_date_to_date(l2.eff_to_date) >= p_date)
		    ----------------EPICAUDIT LOC--------------------
	
	GROUP BY 	substr(EPIC.ef_location_path_name(location_id,'UC',8),1,2),
	 			substr(EPIC.ef_location_path_name(location_id,'UC',7),1,1)
	----------------------------------------------
	)
	GROUP BY Cell, Sort
	
	---------
	UNION ALL
	---------
	--8/9: this portion pulls the Grand Total for cell groups A-C
	SELECT 	'8/9: A-CTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 8/9 East')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 8/9',
			'CC',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('8A','9A','8B','9B','8C','9C')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id
	
	---------
	UNION ALL
	---------
	--8/9: this portion pulls the Grand Total for cell groups D-F
	SELECT 	'8/9: D-FTotal',
			to_number(MACOMB.mcmb_fnt_RDCCapacity_Location('Tower 8/9 West')),
			sum(count(distinct ha.entity_id)),
			p_date,
			'Tower 8/9',
			'FF',
			null
	
	FROM	EPICAUDIT.eh_housing_assignments ha
	
	WHERE	substr(EPIC.ef_location_path_name(ha.location_id,'UC',8),1,2) in ('8D','9D','8E','9E','8F','9F')
			and ha.temporary_location_flag = 'N'
			and EPIC.ef_epic_date_to_date(ha.action_time) <= p_date
	       	and ha.action_type = 'U'
			and not exists
					(select 1
					from EPICAUDIT.eh_housing_assignments ha2
					where ha.location_id = ha2.location_id
					and ha.entity_id = ha2.entity_id
					and ha2.action_type = 'D'
					and EPIC.ef_epic_date_to_date(ha2.action_time) >= EPIC.ef_epic_date_to_date(ha.action_time)
					and EPIC.ef_epic_date_to_date(ha2.action_time) <= p_date)
	
	GROUP BY ha.entity_id

	)
	ORDER BY 5,6;

   EXCEPTION 
		WHEN DUP_VAL_ON_INDEX THEN
		RAISE_APPLICATION_ERROR(-20416, 'Record already exists');  	
	END;  
COMMIT;
END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_ms
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		date)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'MS'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_station23
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Station 2/3'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_summary
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell as Cell,
				(case when RDC < 10 then '0' || RDC else to_char(RDC) end) as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				(rdc - count) as Var,
				p_time

		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Summary'
				and sort2 not in ('Q','R')
				and datetm = p_time

		----------
		UNION ALL
		----------
		SELECT	'BREAK',
				null,
				null,
				null,
				null
		FROM 	dual

		----------
		UNION ALL
		----------
		SELECT	'RATED DESIGN CAPACITY',
				to_char(sum(rdc)),
				to_char(sum(count)),
				(sum(rdc) - sum(count)),
				p_time
		
		FROM	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Summary'
				and sort2 not in ('Q','R')
				and datetm = p_time
				
		----------
		UNION ALL
		----------
		SELECT	cell as Cell,
				(case when RDC < 10 then '0' || RDC else to_char(RDC) end) as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				(rdc - count) as Var,
				p_time
		
		FROM 	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Summary'
				and sort2 in ('Q','R')
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'TOTAL BEDS',
				to_char(sum(rdc)),
				to_char(sum(count)),
				(sum(rdc) - sum(count)),
				p_time
		
		FROM	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Summary'
				and sort2 != 'Q'
				and datetm = p_time

		----------
		UNION ALL
		----------
		SELECT	'GENERAL USE BEDSPACE',
				to_char(sum(rdc)),
				to_char(sum(count)),
				(sum(rdc) - sum(count)),
				p_time
		
		FROM	MACOMB.mt_jcs_monthly
		
		WHERE	sort1 = 'Summary'
				and sort2 not in ('L','M','Q','R')
				and datetm = p_time
		
		----------
		UNION ALL
		----------
		SELECT	'BREAK',
				null,
				null,
				null,
				null
		FROM 	dual;


END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_tower1011
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Tower 10/11'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_tower23
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Tower 2/3'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_tower45
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Tower 4/5'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_tower67
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Tower 6/7'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_jcs_tower89
	(jcs_cur	OUT		EPIC.epp_generic_ref_cursor.ref_cursor,
	 p_time		IN		MACOMB.mt_jcs_monthly.datetm%type)
		
IS
/*	Form Usage: 	linked on Crystal Enterprise Server
	Crystal: 		Subreport of jcs_seldt.rpt
	Purpose:		Used by Administration to create a snapshot of the jail population on the selected of
					date/time. Returns information from the historical data stored in the 
					MACOMB.mt_jcs_monthly table (rolling 30 days)

	Author:			Rachel Stuve

	Change Log:		Changed By	Date Modified	Change Made
					----------	-------------	------------------------------------------
					R. Stuve	05/04/06		Created					
*/

BEGIN
  OPEN jcs_cur FOR	
		SELECT	cell || '=' as CellNm,
				'(' || (case when RDC < 10 then '0' || RDC else to_char(RDC) end) || ')' as Capacity,
				(case when count <10 then '0' || count else to_char(count) end) as Count,
				p_time

		FROM 	MACOMB.mt_jcs_monthly

		WHERE	sort1 = 'Tower 8/9'
				and datetm = p_time

		ORDER BY sort1, sort2, sort3;

END;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MP_RPT_COMMISSARY_NSF
(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	
	Crystal: 		
	Purpose:		Used by Aramark/Commissary and Inmate Funds to list rejected purchase transactions
					(sub report of mcmb_rpt_fundsdailyact)
                         SRF 12903, August, 2009
	Author:			Kelly Heinz

	Change Log:		Changed By	Date Modified	Change Made
    ----------	        -------------	------------------------------------------
					*/
			
BEGIN 
		
	OPEN vCur FOR 
	    --the query below pulls back the header information
	   SELECT	1 as Flag,
				'Rejected Commissary Transactions' as RptTitle, 
				'' as InmateID,
				'' as Name,
				'' as Cell,
				'' as OrderID,
				0 as TransAmt,
        		'' as TransStatus,
				0 as CurBal
				
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
		'Rejected Commissary Transactions' as RptTitle,
		offender_id as InmateID, 
		MCMB_fnt_Get_PersonName(macomb.mcmb_fnt_entity_id(ci.offender_id)) as Name,
		EPIC.ef_Offender_Cell(macomb.mcmb_fnt_entity_id(ci.offender_id)) as Cell,
        order_id as OrderID,
        trans_amount as TransAmt,
        trans_status as TransStatus,
        macomb.mcmb_fnt_inmatefunds(macomb.mcmb_fnt_entity_id(ci.offender_id)) as CurBal
		FROM	
				macomb.mt_commissary_in 	ci
		WHERE	
   ci.trans_status in ('DUP', 'NSF', 'RELSD', 'CLOSED')		

ORDER BY Flag, OrderID;
END MP_RPT_COMMISSARY_NSF;
/

CREATE OR REPLACE
PROCEDURE MACOMB.MP_RPT_COMMISSARY_NSF_2 
(	vCur 			out		epic.epp_generic_ref_cursor.ref_cursor)
	 	
IS
   
 /*	Form Usage: 	
	Crystal: 		
	Purpose:		Used by Aramark/Commissary and Inmate Funds to list rejected purchase transactions
					(sub report of mcmb_rpt_fundsdailyact)
                         SRF 12903, August, 2009
	Author:			Kelly Heinz

	Change Log:		Changed By	Date Modified	Change Made
    ----------	        -------------	------------------------------------------
					*/
			
BEGIN 
		
	OPEN vCur FOR 
	    --the query below pulls back the header information
	   SELECT	1 as Flag,
				'Rejected Commissary Transactions' as RptTitle, 
				'' as InmateID,
				'' as Name,
				'' as Cell,
				'' as OrderID,
				0 as TransAmt,
        		'' as TransStatus,
				0 as CurBal
				
			
		FROM	dual
		
	UNION ALL			
		--the below query pulls back the actual report data	
		SELECT	2 as Flag,
		'Rejected Commissary Transactions' as RptTitle,
		offender_id as InmateID, 
		MCMB_fnt_Get_PersonName(macomb.mcmb_fnt_entity_id(ci.offender_id)) as Name,
		EPIC.ef_Offender_Cell(macomb.mcmb_fnt_entity_id(ci.offender_id)) as Cell,
        order_id as OrderID,
        trans_amount as TransAmt,
        trans_status as TransStatus,
        macomb.mcmb_fnt_inmatefunds(macomb.mcmb_fnt_entity_id(ci.offender_id)) as CurBal
		FROM	
				macomb.mt_commissary_in 	ci
		WHERE	
   ci.trans_status in ('DUP', 'NSF', 'RELSD', 'CLOSED')		

ORDER BY Flag, OrderID;
END MP_RPT_COMMISSARY_NSF_2;
/

CREATE OR REPLACE
PROCEDURE MACOMB.mp_write_file
	 (	p_directory      IN     varchar2,
	    p_type           IN     varchar2,  
	 	p_ext            IN     varchar2,
  		p_refcur  	     IN     epic.epp_generic_ref_cursor.ref_cursor, 
		p_ObjectID		 IN	OUT varchar2)

/*	Form Usage: 	None
	Crystal: 		none
	Purpose:		Used to create a file based on a ref_cursor object.  The outout file 
	                name is p_path '\' p_type '_' p_objectid '.' p_ext )
	                p_directory = Name of the created directory
	                p_type     = 'IVR_Inamte'
	                p_objectID = unique varchar2(16) like epic id '0JH3SX8Q40USJZ1P'
	                p_ext      = 'txt'
	                
	                your file would be c:\tst\IVR_Inmate_0JH3SX8Q40USJZ1P.txt
	                
	                p_refcur is defined as each line as if it is in your output file. Hence, 
	                it should have one field LINEOUT
	                
	                "Joe","McBratnie"
	                "John","Smith"
	                
	                Or for xml        
	                <UserName>
	                	<FirstName>Joe</FirstName>
	                	<LastName>McBratnie</LastName>
	                </UserName>

	Author:			Joe McBratnie

	Change Log:		Changed By  	Date Modified	Change Made
					------------	-------------	------------------------------------------
				    J.McBratnie     04/26/07          Created
				    
*/ 
	
IS	
f utl_file.file_type;

TYPE array_t IS TABLE OF VARCHAR2(4000)
INDEX BY BINARY_INTEGER;

rec_array array_t;
   
begin       
	IF p_ObjectID IS NULL THEN
	 	p_ObjectID := EPIC.epic_ids.new_epic_id();
    END IF;
    f := utl_file.fopen(p_directory, p_type ||'_'|| p_objectid ||'.'|| p_ext,'W'); 

    FETCH p_refcur BULK COLLECT INTO rec_array;

    FOR i IN rec_array.FIRST .. rec_array.LAST
    LOOP
    	utl_file.put_line(f,rec_array(i));
    END LOOP;

    utl_file.fclose(f);
    
end;
/

CREATE OR REPLACE
FUNCTION MACOMB.SH_fnt_Active_KeepSep
		(p_entity_id	in		epic.eh_booking.entity_id%type)  
		
--Returns the name and cell of the Keep Seperate inmates from the selected inmate
-- copied MACOMB.mcnb_fnt_KeepSep but this also eliminates the end dated Keep Seperates       11-13-07  
-- 10-4-12 MZ incr varchar2 to 2500
RETURN		varchar2
IS

	CURSOR curKeepSep IS
	SELECT	epic.ef_offender_id(ks.origin_entity_id) as INum,
			epic.ef_get_personororgname(ks.origin_entity_id) as IName,
			epic.ef_offender_cell(ks.origin_entity_id) as ICell

	FROM	epic.eh_booking bk,
			epic.eh_active_booking ab,
	  		epic.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
	    	and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and ks.end_date is null         -- added by gas to filter out end dated keep seperates so only current will appear
	    	and not ks.origin_entity_id = p_entity_id

UNION ALL
 	SELECT	epic.ef_offender_id(ks.separate_entity_id) as INum,
			epic.ef_get_personororgname(ks.separate_entity_id) as IName,
			epic.ef_offender_cell(ks.separate_entity_id) as ICell

	FROM	epic.eh_booking bk,
			epic.eh_active_booking ab,
	  		epic.eh_keep_separate ks

	WHERE	bk.booking_id = ab.booking_id
			and (bk.entity_id = ks.origin_entity_id or bk.entity_id = ks.separate_entity_id)
	    	and bk.entity_id = p_entity_id
	    	and ks.end_date is null         -- added by gas to filter out end dated keep seperates so only current will appear
	    	and not ks.separate_entity_id = p_entity_id;

	

vName varchar2(2500);	
--vName epic.epic_col_types.VARCHAR_2000%type;   -- REMOVED use varchar2 (2500)

BEGIN
	vName := null;
		FOR a IN curKeepSep
			LOOP vName := vName || a.IName || ' (' || a.ICell || ')' || ' / ';
			END LOOP;
		RETURN vName;
END;  
--GAS
/

